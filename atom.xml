<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://hanlyjiang.github.io</id>
    <title> HanlyJiang </title>
    <updated>2022-05-26T14:49:49.988Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://hanlyjiang.github.io"/>
    <link rel="self" href="https://hanlyjiang.github.io/atom.xml"/>
    <subtitle>ä¸æ–­ç§¯ç´¯äºä¼˜åŒ–ç»éªŒ</subtitle>
    <logo>https://hanlyjiang.github.io/images/avatar.png</logo>
    <icon>https://hanlyjiang.github.io/favicon.ico</icon>
    <rights>All rights reserved 2022,  HanlyJiang </rights>
    <entry>
        <title type="html"><![CDATA[Android Jacocoè¦†ç›–ç‡ç»Ÿè®¡é…ç½®]]></title>
        <id>https://hanlyjiang.github.io/post/android-jacoco-gradle-config/</id>
        <link href="https://hanlyjiang.github.io/post/android-jacoco-gradle-config/">
        </link>
        <updated>2022-03-19T14:29:12.000Z</updated>
        <summary type="html"><![CDATA[<p>Android Jacoco è¦†ç›–ç‡ç»Ÿè®¡Gradleé…ç½®ï¼ŒåŒ…æ‹¬ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œä»ªå™¨å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æ‰§è¡Œæ•°æ®å¹¶åœ¨AndroidStudioçš„ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹æ¯ä¸€è¡Œçš„è¦†ç›–ç‡æƒ…å†µã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>Android Jacoco è¦†ç›–ç‡ç»Ÿè®¡Gradleé…ç½®ï¼ŒåŒ…æ‹¬ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œä»ªå™¨å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æ‰§è¡Œæ•°æ®å¹¶åœ¨AndroidStudioçš„ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹æ¯ä¸€è¡Œçš„è¦†ç›–ç‡æƒ…å†µã€‚</p>
<!-- more -->
<h2 id="å¦‚ä½•è®©æµ‹è¯•ä»»åŠ¡ç”Ÿæˆ-jacoco-è¦†ç›–ç‡ç»Ÿè®¡æ•°æ®">å¦‚ä½•è®©æµ‹è¯•ä»»åŠ¡ç”Ÿæˆ Jacoco è¦†ç›–ç‡ç»Ÿè®¡æ•°æ®ï¼Ÿ</h2>
<p>è¿™é‡Œæˆ‘ä»¬ä»…ä»…ä»Gradleä»»åŠ¡æ¥è¯´ï¼Œä¸è€ƒè™‘ AndroidStudio/IDEAã€‚</p>
<h3 id="æœ¬åœ°å•å…ƒæµ‹è¯•test">æœ¬åœ°å•å…ƒæµ‹è¯•ï¼ˆTestï¼‰</h3>
<p>å¯¹äºæœ¬åœ°å•å…ƒæµ‹è¯•æ¥è¯´ï¼ŒåŸå…ˆæœ‰ä¸€ä¸ª <code>testDebugUnitTest</code> çš„æµ‹è¯•ä»»åŠ¡ï¼Œå¦‚æœä¸åšé…ç½®ï¼Œè¯¥ä»»åŠ¡åªä¼šç”Ÿæˆæµ‹è¯•é€šè¿‡æƒ…å†µçš„æŠ¥å‘Šã€‚åªè¦åº”ç”¨ jacoco æ’ä»¶ï¼Œç„¶åè¿è¡Œ <code>testDebugUnitTest</code> ä»»åŠ¡æ—¶ï¼Œå°±ä¼šåŒæ—¶ç”Ÿæˆjacocoè¦†ç›–ç‡ç»Ÿè®¡<strong>æ‰§è¡Œæ•°æ®æ–‡ä»¶</strong>ã€‚</p>
<pre><code class="language-kotlin">// build.gradle 
apply(plugin = &quot;jacoco&quot;)
</code></pre>
<p>ä¹‹æ‰€ä»¥èƒ½è¿™æ ·æ˜¯å› ä¸º jacoco æ’ä»¶ä¼šç»™æ‰€æœ‰ Test ç±»å‹çš„ä»»åŠ¡æ·»åŠ  jacoco çš„é…ç½®ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¾“å‡ºå…¶æ‰§è¡Œæ•°æ®æ–‡ä»¶è·¯å¾„ï¼š</p>
<pre><code class="language-kotlin">afterEvaluate {
    tasks.getByName(&quot;testDebugUnitTest&quot;).apply {
        doLast {
            (this.extensions.getByName(&quot;jacoco&quot;) as JacocoTaskExtension).apply {
                logger.lifecycle(&quot;testDebugUnitTest dest: ${this.destinationFile?.absolutePath}&quot;)
            }
        }
    }
}
</code></pre>
<p>æ‰§è¡Œæƒ…å†µå¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">testDebugUnitTest dest: /Users/hanlyjiang/Wksp/project/AndroidTestSample/app/build/outputs/unit_test_code_coverage/debugUnitTest/testDebugUnitTest.exec
</code></pre>
<h3 id="ä»ªå™¨å•å…ƒæµ‹è¯•androidtest">ä»ªå™¨å•å…ƒæµ‹è¯•ï¼ˆAndroidTestï¼‰</h3>
<p>ä»ªå™¨å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ•°æ®çš„ç»Ÿè®¡éœ€è¦æ‰“å¼€<code>testCoverageEnabled</code>å¼€å…³ï¼Œç„¶åä¼šæœ‰ä¸€ä¸ª<code>createDebugCoverageReport</code> çš„ä»»åŠ¡ç”Ÿæˆï¼ŒåŒæ—¶ä¹Ÿä¼šç”Ÿæˆhtmlçš„æŠ¥å‘Šã€‚</p>
<pre><code class="language-groovy">// groovy
android {
    buildTypes {
        debug {
            testCoverageEnabled = true
        }
    }
}

// kotlin
android {
    buildTypes {
        getByName(&quot;debug&quot;).apply {
            isTestCoverageEnabled = true
        }
    }
}
</code></pre>
<p>è¿æ¥è®¾å¤‡æ‰§è¡Œè¯¥ä»»åŠ¡å³å¯ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œæ•°æ®æ–‡ä»¶åŠå¯¹åº”çš„è¦†ç›–ç‡æŠ¥å‘Šã€‚</p>
<p>é€šè¿‡åœ¨build.gradleä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å¯ä»¥åœ¨æ‰§è¡Œæ—¶è¾“å‡ºå…¶æ‰§è¡Œæ•°æ®æ–‡ä»¶åœ¨æœ¬æœºçš„ä½ç½®ï¼š</p>
<pre><code class="language-kotlin">    tasks.withType(com.android.build.gradle.internal.coverage.JacocoReportTask::class.java) {
        logger.lifecycle(&quot;-&gt; JacocoReportTask task : $name&quot;)
        doFirst {
            logger.lifecycle(&quot;-&gt; JacocoReportTask task : $name , ${jacocoConnectedTestsCoverageDir.get()})}&quot;)
        }
    }
</code></pre>
<p>ç„¶åæ‰§è¡Œ<code>createDebugCoverageReport</code>, è¾“å‡ºå¦‚ä¸‹ ï¼š</p>
<pre><code class="language-shell">&gt; Task :app:createDebugAndroidTestCoverageReport
-&gt; JacocoReportTask task : createDebugAndroidTestCoverageReport , /Users/hanlyjiang/Wksp/project/AndroidTestSample/app/build/outputs/code_coverage/debugAndroidTest/connected)}

&gt; Task :app:createDebugCoverageReport
</code></pre>
<h3 id="å°ç»“">å°ç»“</h3>
<p>é€šè¿‡ä»¥ä¸Šä¿¡æ¯æˆ‘ä»¬å¯çŸ¥ï¼š</p>
<ol>
<li>åº”ç”¨ jacoco æ’ä»¶ä¹‹åï¼Œæœ¬åœ°å•å…ƒæµ‹è¯•ä»»åŠ¡ï¼ˆ<code>testDebugUnitTest</code>ï¼‰å°±ä¼šç”Ÿæˆ jacoco è¦†ç›–ç‡executionæ•°æ®æ–‡ä»¶ï¼Œä½†æ˜¯ä¸ä¼šç”ŸæˆhtmlæŠ¥å‘Šï¼›</li>
<li>å¼€å¯ isTestCoverageEnabled å¼€å…³ï¼Œä¼šç”Ÿæˆ <code>createDebugCoverageReport</code> ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä¼šæ‰§è¡Œä»ªå™¨å•å…ƒæµ‹è¯•ï¼ŒåŒæ—¶ç”Ÿæˆexecutionæ•°æ®æ–‡ä»¶ï¼Œå¹¶ç”ŸæˆhtmlæŠ¥å‘Šã€‚</li>
</ol>
<h2 id="ç”Ÿæˆ-html-æŠ¥å‘Š">ç”Ÿæˆ HTML æŠ¥å‘Š</h2>
<p>ç”±äºandroidTest å·²ç»ç”Ÿæˆäº†htmlæŠ¥å‘Šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è¦ä¸ºæˆ‘ä»¬çš„æœ¬åœ°å•å…ƒæµ‹è¯•ç”ŸæˆHTMLæŠ¥å‘Šã€‚</p>
<p>è¦ç”ŸæˆhtmlæŠ¥å‘Šï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»å‹ä¸º JacocoReport çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬åœ¨gradle ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œç”¨äºç”Ÿæˆ <code>jacocoTestDebugUnitTestReport</code> ä»»åŠ¡</p>
<pre><code class="language-kotlin">apply(plugin = &quot;jacoco&quot;)

android {
    buildTypes {
        getByName(&quot;debug&quot;).apply {
            isTestCoverageEnabled = true
        }
    }
}
afterEvaluate {
	// ç”±äºæˆ‘ä»¬éœ€è¦è·å–å¯¹åº”çš„æºç åŠclassç›®å½•ï¼Œæ‰€ä»¥ä½¿ç”¨ android.applicationVariants forEach æ¥è·å–å˜ä½“
	android.applicationVariants.forEach { variant -&gt;
        if (variant.buildType.isTestCoverageEnabled) {
            val variantCapName = variant.name.capitalize();
            tasks.register(
                &quot;jacocoTest${variantCapName}UnitTestReport&quot;,
                JacocoReport::class.java
            ) {
                group = &quot;jacoco&quot;
              	// ä¾èµ–æµ‹è¯•ä»»åŠ¡
	              dependsOn(&quot;test${variantCapName}UnitTest&quot;)
                
              	// æ ¹æ®æ‰§è¡Œæ•°æ®ç”ŸæˆæŠ¥å‘Šï¼Œç›´æ¥ä¼ è¾“taskå³å¯
                executionData(tasks.getByName(&quot;test${variantCapName}UnitTest&quot;))
              	// æŠ¥å‘Šä¸­ä¼šåŒ…å«æºç ï¼Œå¯ä»¥æŸ¥çœ‹æºç çš„å¯¹åº”çš„è¦†ç›–æƒ…å†µ
                sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories })
                // æ²¡æœ‰ class æ•°æ®æŠ¥å‘Šä¼šæ˜¯ç©ºçš„
                classDirectories.from(variant.javaCompileProvider.get().destinationDirectory)
              
              	doLast {
                    logger.lifecycle(reports.html.outputLocation.asFile.get().absolutePath)
                }
            }
        }
	}
}
</code></pre>
<p>æ·»åŠ ä¹‹å sync gradleï¼Œå³å¯ç”Ÿæˆä¸€ä¸ª <code>jacocoTestDebugUnitTestReport</code> çš„ä»»åŠ¡ï¼Œæ‰§è¡Œå®ƒå³å¯ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šï¼Œç”Ÿæˆçš„æµ‹è¯•æŠ¥å‘Šä½äºï¼š <code>build/reports/jacoco/jacocoTestDebugUnitTestReport</code>ä¸­ã€‚</p>
<p>ä¸‹å›¾å°±æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„æŠ¥å‘Šï¼Œå¯ä»¥çœ‹åˆ°StringUtilså·²ç»èƒ½å¤Ÿç»Ÿè®¡è¦†ç›–ç‡äº†ã€‚è€ŒMainActivityè¿˜æ²¡æœ‰æ•°æ®ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202203192203816.png" alt="image-20220319220339791" style="zoom:50%;" />
<h2 id="ç”Ÿæˆåˆå¹¶htmlæŠ¥å‘Š">ç”Ÿæˆåˆå¹¶HTMLæŠ¥å‘Š</h2>
<p>æˆ‘ä»¬å·²ç»å¯ä»¥ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•çš„è¦†ç›–ç‡æŠ¥å‘Šï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ç”ŸæˆandroidTest + test çš„åˆå¹¶æŠ¥å‘Šã€‚</p>
<p>ä¹‹å‰æˆ‘ä»¬å·²ç»çŸ¥é“ï¼š</p>
<ul>
<li>createDebugCoverageReport ä»»åŠ¡å³å¯ç”Ÿæˆ execution æ–‡ä»¶å¹¶ä¸”ç”ŸæˆhtmlæŠ¥å‘Š</li>
<li>æˆ‘ä»¬å·²ç»æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡å¯ä»¥ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•çš„æŠ¥å‘Šã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬è¦åšçš„æ˜¯å°†å®ƒä»¬åˆå¹¶ï¼Œä½†æ˜¯æˆ‘ä»¬çš„åˆå¹¶å¹¶ä¸æ˜¯é’ˆå¯¹htmlæŠ¥å‘Šï¼Œè€Œæ˜¯é’ˆå¯¹executionæ•°æ®ã€‚</p>
<p>è®©æˆ‘ä»¬æ·»åŠ å¦‚ä¸‹é…ç½®æ¥ç”Ÿæˆä¸€ä¸ªåˆå¹¶æŠ¥å‘Šçš„gradleä»»åŠ¡ï¼š</p>
<pre><code class="language-kotlin">apply(plugin = &quot;jacoco&quot;)

android {
    buildTypes {
        getByName(&quot;debug&quot;).apply {
            isTestCoverageEnabled = true
        }
    }
}

afterEvaluate {
    android.applicationVariants.forEach { variant -&gt;
        if (variant.buildType.isTestCoverageEnabled) {
            val variantCapName = variant.name.capitalize();
            tasks.register(&quot;mergedJacoco${variantCapName}TestReport&quot;, JacocoReport::class.java) {
                group = &quot;jacoco&quot;
                executionData(
                    tasks.getByName(&quot;test${variantCapName}UnitTest&quot;),
                )
                val androidCoverageTask =
                    tasks.getByName(&quot;create${variantCapName}AndroidTestCoverageReport&quot;)
                if (androidCoverageTask is com.android.build.gradle.internal.coverage.JacocoReportTask) {
                    executionData(androidCoverageTask.jacocoConnectedTestsCoverageDir.asFileTree)
                }
                sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories })
                classDirectories.from(variant.javaCompileProvider.get().destinationDirectory)
                dependsOn(
                    &quot;test${variantCapName}UnitTest&quot;,
                    &quot;create${variantCapName}AndroidTestCoverageReport&quot;
                )
              	doLast {
                    logger.lifecycle(reports.html.outputLocation.asFile.get().absolutePath)
                }
            }
        }
    }
}
</code></pre>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿æœ‰äº†ä¸€ä¸ª <code>mergedJacocoDebugTestReport</code> çš„ä»»åŠ¡ï¼Œæ‰§è¡Œåå³å¯åœ¨<code>build/reports/jacoco/mergedJacocoDebugTestReport/html</code> ç›®å½•ä¸­æ‰¾åˆ°æˆ‘ä»¬çš„ report ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202203192204139.png" alt="image-20220319220451116" style="zoom:50%;" />
<p>ç°åœ¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„MainActivityï¼ˆAndroidTestï¼‰åŠStringUtilsï¼ˆtestï¼‰å¯ä»¥åœ¨ä¸€ä»½æŠ¥å‘Šä¸­æ˜¾ç¤ºè¦†ç›–ç‡æ•°æ®äº†ã€‚</p>
<h2 id="ç”Ÿæˆåˆå¹¶-execution-æ•°æ®æ–‡ä»¶">ç”Ÿæˆåˆå¹¶ Execution æ•°æ®æ–‡ä»¶</h2>
<p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ç”Ÿæˆäº†HTMLç‰ˆæœ¬çš„åˆå¹¶æŠ¥å‘Šï¼Œå¹¶ä¸”å¯ä»¥åœ¨å…¶ä¸­çœ‹åˆ°æºç æ²¡ä¸€è¡Œè¦†ç›–çš„æƒ…å†µã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202203192206236.png" alt="image-20220319220605201" style="zoom:50%;" />
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨AndroidStudioçš„ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºè¦†ç›–ç‡çš„æƒ…å†µï¼Œå‘ä¸‹é¢è¿™æ ·ğŸ‘‡ï¼š</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202203192215319.png" alt="image-20220319221553776" style="zoom:50%;" />
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AndroidStudioçš„<code>Menu-Run-Show Covarage Data</code>åŠ è½½ execution æ–‡ä»¶ï¼Œç„¶ååœ¨AndroidStudioä¸­æ˜¾ç¤ºè¦†ç›–ç‡æ•°æ®ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202203192208217.png" alt="image-20220319220850184" style="zoom:50%;" />
<p>æ‰§è¡Œçš„æ•°æ®æ–‡ä»¶ä½äºç±»ä¼¼å¦‚ä¸‹ç›®å½• ï¼š</p>
<ul>
<li>build/outputs/unit_test_code_coverage/debugUnitTest/testDebugUnitTest.exec</li>
<li>build/outputs/code_coverage/debugAndroidTest/connected/Pixel_5_API_Tiramisu(AVD) - 12/coverage.ec</li>
</ul>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>debugAndroidTest ç›®å½•ä¸­çš„ <code>.ec</code> æ–‡ä»¶æ— æ³•è¢«AndroidStudioè¯†åˆ«ã€‚</li>
<li>è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯åˆ†å¼€çš„ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶åªåŒ…å«ä¸€ç§æµ‹è¯•çš„è¦†ç›–æ•°æ®ã€‚</li>
</ol>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåˆå¹¶ä»»åŠ¡ï¼š</p>
<pre><code class="language-kotlin">
afterEvaluate {
    tasks.getByName(&quot;testDebugUnitTest&quot;).apply {
        (this.extensions.getByName(&quot;jacoco&quot;) as JacocoTaskExtension).apply {
            logger.lifecycle(&quot;testDebugUnitTest dest: ${this.destinationFile?.absolutePath}&quot;)
        }
    }
    tasks.withType(org.gradle.api.tasks.testing.Test::class.java) {
        logger.lifecycle(&quot;-&gt; test task : $name&quot;)
    }
    tasks.withType(JacocoReport::class.java) {
        logger.lifecycle(&quot;-&gt; JacocoReport task : $name&quot;)
    }
    tasks.withType(com.android.build.gradle.internal.coverage.JacocoReportTask::class.java) {
        logger.lifecycle(&quot;-&gt; JacocoReportTask task : $name&quot;)
        doFirst {
            logger.lifecycle(&quot;-&gt; JacocoReportTask task : $name , ${jacocoConnectedTestsCoverageDir.get()})}&quot;)
        }
    }
    android.applicationVariants.forEach { variant -&gt;
        if (variant.buildType.isTestCoverageEnabled) {
            val variantCapName = variant.name.capitalize();
            tasks.register(
                &quot;jacocoTest${variantCapName}UnitTestReport&quot;,
                JacocoReport::class.java
            ) {
                group = &quot;jacoco&quot;
                executionData(tasks.getByName(&quot;test${variantCapName}UnitTest&quot;))
                sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories })
                classDirectories.from(variant.javaCompileProvider.get().destinationDirectory)
                dependsOn(&quot;test${variantCapName}UnitTest&quot;)
                doLast {
                    logger.lifecycle(&quot;Jacoco Report: &quot; + reports.html.outputLocation.asFile.get().absolutePath)
                }
            }

            tasks.register(&quot;mergedJacoco${variantCapName}TestReport&quot;, JacocoReport::class.java) {
                group = &quot;jacoco&quot;
                executionData(
                    tasks.getByName(&quot;test${variantCapName}UnitTest&quot;),
                )
                val androidCoverageTask =
                    tasks.getByName(&quot;create${variantCapName}AndroidTestCoverageReport&quot;)
                if (androidCoverageTask is com.android.build.gradle.internal.coverage.JacocoReportTask) {
                    executionData(androidCoverageTask.jacocoConnectedTestsCoverageDir.asFileTree)
                }
                sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories })
                classDirectories.from(variant.javaCompileProvider.get().destinationDirectory)
                dependsOn(
                    &quot;test${variantCapName}UnitTest&quot;,
                    &quot;create${variantCapName}AndroidTestCoverageReport&quot;
                )
                doLast {
                    logger.lifecycle(&quot;Jacoco Report: &quot; + reports.html.outputLocation.asFile.get().absolutePath)
                }
            }

            tasks.register(&quot;mergeJacoco${variantCapName}Execution&quot;, JacocoMerge::class.java) {
                group = &quot;jacoco&quot;
                executionData(
                    tasks.getByName(&quot;test${variantCapName}UnitTest&quot;),
                )
                val androidCoverageTask =
                    tasks.getByName(&quot;create${variantCapName}AndroidTestCoverageReport&quot;)
                if (androidCoverageTask is com.android.build.gradle.internal.coverage.JacocoReportTask) {
                    executionData(androidCoverageTask.jacocoConnectedTestsCoverageDir.asFileTree)
                }
                doLast {
                    logger.lifecycle(&quot;Jacoco Execution: &quot; + destinationFile.absolutePath)
                }
            }

        }
    }
}
</code></pre>
<p>æ‰§è¡Œä¹‹åä½äºï¼š<code>build/jacoco/mergeJacocoDebugExecution.exec</code>, é€šè¿‡AndroidStudio åŠ è½½ä¹‹åï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼Œä¸¤ç§æµ‹è¯•çš„ç»“æœå·²ç»åˆå¹¶æ˜¾ç¤ºäº†ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202203192219808.png" alt="image-20220319221952765" style="zoom:50%;" />
<h2 id="å®Œæ•´é…ç½®æ–‡ä»¶">å®Œæ•´é…ç½®æ–‡ä»¶</h2>
<p>è¯·å‚è€ƒï¼š <a href="https://github.com/hanlyjiang/AndroidTestSample/blob/main/app/build.gradle.kts">AndroidTestSample/build.gradle.kts at main Â· hanlyjiang/AndroidTestSample (github.com)</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ AAR Java8 æ¥å£ NoSuchMethodError é”™è¯¯è§£å†³è®°å½•]]></title>
        <id>https://hanlyjiang.github.io/post/aar-java8-jie-kou-nosuchmethoderror-cuo-wu-jie-jue-ji-lu/</id>
        <link href="https://hanlyjiang.github.io/post/aar-java8-jie-kou-nosuchmethoderror-cuo-wu-jie-jue-ji-lu/">
        </link>
        <updated>2022-03-13T15:18:16.000Z</updated>
        <summary type="html"><![CDATA[<p>é‡åˆ°ä¸€ä¸ªåˆçœ‹æ—¶éå¸¸è¯¡å¼‚çš„é—®é¢˜ï¼Œç°å·²è§£å†³ï¼Œç‰¹è®°å½•ä¸€ä¸‹è§£å†³è¿‡ç¨‹ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>é‡åˆ°ä¸€ä¸ªåˆçœ‹æ—¶éå¸¸è¯¡å¼‚çš„é—®é¢˜ï¼Œç°å·²è§£å†³ï¼Œç‰¹è®°å½•ä¸€ä¸‹è§£å†³è¿‡ç¨‹ã€‚</p>
<!-- more -->
<h2 id="ï¸-æ˜¯ä»€ä¹ˆé—®é¢˜">ğŸ™‹â€â™€ï¸ æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2>
<h3 id="é”™è¯¯æ—¥å¿—">é”™è¯¯æ—¥å¿—</h3>
<p>APPè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¿½ç„¶æŠ¥äº†ä¸€ä¸ªè«åå…¶å¦™çš„é”™è¯¯ï¼š <code>NoSuchMethodError</code>, æŠ¥é”™çš„åœ°æ–¹æ˜¯ rxjava3 çš„ <code>Disposable.disposed()</code></p>
<pre><code class="language-shell">E/AndroidRuntime: FATAL EXCEPTION: main
    Process: com.github.hanlyjiang.sample, PID: 7357
    java.lang.NoSuchMethodError: No static method disposed()Lio/reactivex/rxjava3/disposables/Disposable; in class Lio/reactivex/rxjava3/disposables/Disposable; or its super classes (declaration of 'io.reactivex.rxjava3.disposables.Disposable' appears in /data/app/~~veR3ZUFYzXjZ48FDcAW0Nw==/com.github.hanlyjiang.sample-bhuZG0wVNdVKs_mfxOh5gg==/base.apk)
        at com.github.hanlyjiang.lib_mod.ViewTest.disposable(ViewTest.java:8)
        at com.github.hanlyjiang.sample.MainActivity.lambda$onCreate$0(MainActivity.java:15)
        at com.github.hanlyjiang.sample.MainActivity$$ExternalSyntheticLambda0.onClick(Unknown Source:0)
        at android.view.View.performClick(View.java:7456)
        at com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1119)
        at android.view.View.performClickInternal(View.java:7433)
        at android.view.View.access$3700(View.java:836)
        at android.view.View$PerformClick.run(View.java:28832)
        at android.os.Handler.handleCallback(Handler.java:938)
        at android.os.Handler.dispatchMessage(Handler.java:99)
        at android.os.Looper.loopOnce(Looper.java:201)
        at android.os.Looper.loop(Looper.java:288)
        at android.app.ActivityThread.main(ActivityThread.java:7902)
        at java.lang.reflect.Method.invoke(Native Method)
        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548)
        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:933)
</code></pre>
<blockquote>
<p><strong>â° Tip</strong></p>
<p>å®é™…ä¸Šè¿˜æœ‰é‡åˆ°è¿‡ä¸€ä¸ª <code>AbstractMethodError</code> çš„é”™è¯¯</p>
</blockquote>
<h3 id="å‡ºç°åœºæ™¯">å‡ºç°åœºæ™¯</h3>
<ul>
<li>AAR å¼•å…¥åˆ°APPæ¨¡å—</li>
<li>æ‰“åŒ…APKï¼ˆä¸é€šè¿‡AndroidStudioç›´æ¥è¿è¡Œï¼‰</li>
<li>å®‰è£…å¹¶è¿è¡Œ</li>
</ul>
<h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2>
<p>å¯¹äºéœ€è¦è§£å†³é—®é¢˜çš„ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒå°è¯•ä¸‹é¢ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="è§£æ³•1">è§£æ³•1</h3>
<p><code>gradle.properties</code> æ–‡ä»¶ä¸­æ·»åŠ å±æ€§ï¼š</p>
<pre><code class="language-properties">android.enableDexingArtifactTransform.desugaring=false
</code></pre>
<h3 id="è§£æ³•2">è§£æ³•2</h3>
<p>ä¿®æ”¹ aar çš„ä¾èµ–æ–¹å¼ï¼Œå°†name+extçš„æ–¹å¼ä¿®æ”¹ä¸º files</p>
<pre><code class="language-groovy">	implementation(name: 'libmod-release', ext: 'aar')
</code></pre>
<p>ä¿®æ”¹ä¹‹å</p>
<pre><code class="language-groovy">	implementation(files('libs/libmod-release.aar'))
</code></pre>
<h2 id="æ¡ˆä¾‹è§‚å¯Ÿ">æ¡ˆä¾‹è§‚å¯Ÿ</h2>
<p>æ ¹æ®é”™è¯¯ä¿¡æ¯ï¼Œæ‰¾åˆ°æˆ‘ä»¬çš„ä»£ç ï¼Œå¾—åˆ°å¦‚ä¸‹è°ƒç”¨å…³ç³»ï¼š</p>
<pre><code class="language-java">ViewTest.disposable -&gt; Disposable.disposed()
</code></pre>
<p>ä¸ºäº†æ–¹ä¾¿åˆ†æåŠæ¼”ç¤ºï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªæµ‹è¯•å·¥ç¨‹ä½äºï¼š <a href="https://github.com/colorless-hanly/NoSuchMethodError">colorless-hanly/NoSuchMethodError: NoSuchMethodError (github.com)</a>ï¼Œè¿è¡Œæ­¤å·¥ç¨‹èƒ½å¤ç°è¯¥é—®é¢˜ã€‚</p>
<h3 id="classå­—èŠ‚ç æ²¡æœ‰é—®é¢˜">classå­—èŠ‚ç æ²¡æœ‰é—®é¢˜</h3>
<p>æˆ‘ä»¬çš„AARæä¾›ç»™APPæ¨¡å—æ—¶ï¼Œæ˜¯ä»¥ class ç±»æ–‡ä»¶æä¾›çš„ï¼Œé€šè¿‡åç¼–è¯‘æŸ¥çœ‹å…¶å†…å®¹ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çœ‹çœ‹æœ€åè¿è¡Œçš„APKå¯¹åº”çš„DEXï¼Œå¹¶é€šè¿‡AndroidStudio æŸ¥çœ‹å…¶å¯¹åº”çš„å­—èŠ‚ç ã€‚</p>
<h3 id="viewtestdisposable"><code>ViewTest.disposable</code></h3>
<p>é¦–å…ˆæˆ‘ä»¬æ ¹æ®æŠ¥é”™ä¿¡æ¯æ‰¾åˆ°å‡ºé”™çš„<code>ViewTest.disposable</code>ç±»ï¼Œå¹¶æŸ¥çœ‹å…¶å­—èŠ‚ç </p>
<p><strong>Java ä»£ç ï¼š</strong></p>
<pre><code class="language-java">public class ViewTest {

    public static Disposable disposable() {
        return Disposable.disposed();
    }
}
</code></pre>
<p><strong>å­—èŠ‚ç ï¼š</strong></p>
<pre><code class="language-java">.class public Lcom/github/hanlyjiang/lib_mod/ViewTest;
.super Ljava/lang/Object;
.source &quot;ViewTest.java&quot;


# direct methods
.method public constructor &lt;init&gt;()V
    .registers 1

    .line 5
    invoke-direct {p0}, Ljava/lang/Object;-&gt;&lt;init&gt;()V

    return-void
.end method

.method public static disposable()Lio/reactivex/rxjava3/disposables/Disposable;
    .registers 1

    .line 8
    invoke-static {}, Lio/reactivex/rxjava3/disposables/Disposable;-&gt;disposed()Lio/reactivex/rxjava3/disposables/Disposable;

    move-result-object v0

    return-object v0
.end method
</code></pre>
<p>çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚</p>
<h3 id="disposabledisposed"><code>Disposable.disposed()</code></h3>
<p>æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ Disposable æ¥å£çš„å­—èŠ‚ç ï¼Œå‘ç°å±…ç„¶<strong>æ²¡æœ‰æˆ‘ä»¬è°ƒç”¨çš„ disposed æ–¹æ³•</strong>ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://s2.loli.net/2022/05/26/m2OoeUC3WaEuySc.png" alt="202203132238351" loading="lazy"></figure>
<p>ä½†æ˜¯ï¼Œå¾ˆå¿«å°±åœ¨æœ‰ä¸€ä¸ªå«åš <code>Disposable$-CC</code> çš„ç±»ä¸­æ‰¾åˆ°äº†æˆ‘ä»¬çš„ <code>disposed</code> æ–¹æ³•ï¼ŒåŒæ—¶å…¶ä¸­è¿˜åŒ…æ‹¬äº† <code>Disposable</code> æ¥å£ä¸­çš„æ‰€æœ‰é™æ€æ–¹æ³•</p>
<figure data-type="image" tabindex="2"><img src="https://s2.loli.net/2022/05/26/ljBCpFPid92AczY.png" alt="202203132240481" loading="lazy"></figure>
<p>è¿™é‡Œæˆ‘ä»¬ç²˜è´´ä¸‹ Disposable æ¥å£çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸¤ä¸ªæ¥å£æ–¹æ³•å®šä¹‰ï¼Œè¿˜æœ‰è‹¥å¹²staticæ–¹æ³•çš„å®šä¹‰åŠå®ç°ã€‚è€Œæˆ‘ä»¬çš„é™æ€æ–¹æ³•å…¨éƒ¨ä½äºå­—èŠ‚ç ä¸­ <code>Disposable$-CC</code> è¿™ä¸ªç±»ä¸­ï¼Œè€Œä¸¤ä¸ªæ¥å£æ–¹æ³•è¿˜ä¿ç•™åœ¨ <code>Disposable</code> ç±»ä¸­ã€‚</p>
<pre><code class="language-java">public interface Disposable {

    void dispose();
    boolean isDisposed();

    static Disposable fromRunnable(@NonNull Runnable run) {
        Objects.requireNonNull(run, &quot;run is null&quot;);
        return new RunnableDisposable(run);
    }
    static Disposable fromAction(@NonNull Action action) {
        Objects.requireNonNull(action, &quot;action is null&quot;);
        return new ActionDisposable(action);
    }
    static Disposable fromFuture(@NonNull Future&lt;?&gt; future) {
        Objects.requireNonNull(future, &quot;future is null&quot;);
        return fromFuture(future, true);
    }
    static Disposable fromFuture(@NonNull Future&lt;?&gt; future, boolean allowInterrupt) {
        Objects.requireNonNull(future, &quot;future is null&quot;);
        return new FutureDisposable(future, allowInterrupt);
    }
    static Disposable fromSubscription(@NonNull Subscription subscription) {
        Objects.requireNonNull(subscription, &quot;subscription is null&quot;);
        return new SubscriptionDisposable(subscription);
    }
    static Disposable fromAutoCloseable(@NonNull AutoCloseable autoCloseable) {
        Objects.requireNonNull(autoCloseable, &quot;autoCloseable is null&quot;);
        return new AutoCloseableDisposable(autoCloseable);
    }
    static AutoCloseable toAutoCloseable(@NonNull Disposable disposable) {
        Objects.requireNonNull(disposable, &quot;disposable is null&quot;);
        return disposable::dispose;
    }
    static Disposable empty() {
        return fromRunnable(Functions.EMPTY_RUNNABLE);
    }
    static Disposable disposed() {
        return EmptyDisposable.INSTANCE;
    }
}
</code></pre>
<h3 id="æ­£ç¡®çš„viewtestdisposableå­—èŠ‚ç ">æ­£ç¡®çš„<code>ViewTest.disposable</code>å­—èŠ‚ç </h3>
<p>å‰é¢æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬å­—èŠ‚ç ä¸­è°ƒç”¨çš„æ–¹æ³•æ˜¯ <code>Disposable;-&gt;disposed()</code>ï¼Œè€Œå®é™…ä¸Šè¯¥æ–¹æ³•ä½äº <code>Disposable$-CC;-&gt;disposed()</code>,ç°åœ¨æˆ‘ä»¬çœ‹ä¸‹æ­£å¸¸çš„å¯ä»¥è¿è¡Œé€šè¿‡çš„apkä¸­dexå¯¹åº”çš„å­—èŠ‚ç ã€‚</p>
<ul>
<li>ç»è¿‡å¯¹æ¯”ï¼Œå‘ç°Disposable è¿˜æ˜¯è¢«æ‹†åˆ†ä¸ºäº† Disposable å’Œ Disposable$-CC</li>
<li>è€Œ ViewTest.disposable å¯¹åº”çš„å­—èŠ‚ç å´æœ‰åŒºåˆ«ï¼Œæ­£å¸¸å¯ä»¥è°ƒç”¨é€šè¿‡çš„å­—èŠ‚ç å’Œå¼‚å¸¸çš„å¯¹æ¯”å¦‚ä¸‹ï¼š</li>
</ul>
<pre><code class="language-java">// æ­£ç¡®çš„
invoke-static {}, Lio/reactivex/rxjava3/disposables/Disposable$-CC;-&gt;disposed()Lio/reactivex/rxjava3/disposables/Disposable;

// é”™è¯¯çš„
invoke-static {}, Lio/reactivex/rxjava3/disposables/Disposable;-&gt;disposed()Lio/reactivex/rxjava3/disposables/Disposable;
</code></pre>
<p>å¯ä»¥å‘ç°ï¼Œèƒ½æ­£å¸¸è¿è¡Œçš„æ–¹æ³•è°ƒç”¨ç¡®å®æŒ‡å‘äº† <code>Disposable$-CC;-&gt;disposed()</code>ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼š</p>
<ul>
<li>Disposable ä¼šè¢«æ‹†åˆ†ä¸º <code>Disposable</code> å’Œ <code>Disposable$-CC</code>
<ul>
<li><code>Disposable</code> åŒ…å«äº†æ¥å£æ–¹æ³•çš„å£°æ˜</li>
<li><code>Disposable$-CC</code> ä¸­åˆ™åŒ…å«äº†é™æ€æ–¹æ³•çš„å£°æ˜åŠå®ç°</li>
</ul>
</li>
<li>å¯¹äºè°ƒç”¨åˆ° Disposable çš„é™æ€æ–¹æ³•çš„éƒ¨åˆ†ï¼Œæœ€ç»ˆç¼–è¯‘å®Œæˆåï¼Œä¼šæ›¿æ¢ä¸ºæŒ‡å‘<code>Disposable$-CC</code></li>
</ul>
<p>è€Œæˆ‘ä»¬å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ²¡æœ‰æ­£ç¡®æŒ‡å‘çš„ï¼Œæ‰€ä»¥ç¡®å®ä¼šå‡ºç°æ‰¾ä¸åˆ°å¯¹åº”çš„æ–¹æ³•çš„æƒ…å†µã€‚</p>
<h2 id="åŸå› åˆ†æ">åŸå› åˆ†æ</h2>
<h3 id="class-dex-java8-è¯­è¨€ç‰¹æ€§æ”¯æŒ">class -&gt; dex &amp; Java8 è¯­è¨€ç‰¹æ€§æ”¯æŒ</h3>
<p>ä»¥ä¸‹ä¸ºAndroid å®˜æ–¹æ–‡æ¡£ä¸Šçš„ç›¸å…³æè¿°ï¼š</p>
<blockquote>
<ul>
<li><strong><a href="https://developer.android.google.cn/studio/write/java8-support">ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½å’Œ API</a></strong></li>
</ul>
<p>Android Gradle æ’ä»¶å¯¹ä½¿ç”¨æŸäº› Java 8 è¯­è¨€åŠŸèƒ½ä»¥åŠåˆ©ç”¨è¿™äº›åŠŸèƒ½çš„ç¬¬ä¸‰æ–¹åº“æä¾›å†…ç½®æ”¯æŒã€‚å¦‚å›¾ æ‰€ç¤ºï¼Œé»˜è®¤å·¥å…·é“¾å®ç°æ–°è¯­è¨€åŠŸèƒ½çš„æ–¹æ³•æ˜¯åœ¨<strong>ä½¿ç”¨ D8/R8 å°†ç±»æ–‡ä»¶ç¼–è¯‘æˆ dex ä»£ç çš„è¿‡ç¨‹ä¸­æ‰§è¡Œå­—èŠ‚ç è½¬æ¢ï¼Œè¿™ç§è½¬æ¢ç§°ä¸º <code>desugar</code></strong>ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://s2.loli.net/2022/05/26/PLiSGTwhZADqjFm.png" alt="202203132254856" loading="lazy"></figure>
</blockquote>
<blockquote>
<ul>
<li><strong><a href="https://developer.android.google.cn/studio/write/java8-support#library-desugaring">Java 8 åŠæ›´é«˜ç‰ˆæœ¬ API è„±ç³–æ”¯æŒï¼ˆAndroid Gradle æ’ä»¶ 4.0.0 åŠæ›´é«˜ç‰ˆæœ¬ï¼‰</a></strong></li>
</ul>
<p>å¦‚æœæ‚¨ä½¿ç”¨ Android Gradle æ’ä»¶ 4.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬æ„å»ºåº”ç”¨ï¼Œæ’ä»¶æ‰©å±•äº†å¯¹ä½¿ç”¨å¤šç§ Java 8 è¯­è¨€ API çš„æ”¯æŒï¼Œè€Œæ— éœ€ä¸ºåº”ç”¨è®¾ç½®æœ€ä½ API çº§åˆ«ã€‚</p>
<p>ä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°å¯¹è¾ƒä½å¹³å°ç‰ˆæœ¬çš„è¿™ç§é¢å¤–æ”¯æŒï¼Œæ˜¯å› ä¸ºè„±ç³–å¼•æ“ç»è¿‡æ’ä»¶ 4.0.0 åŠæ›´é«˜ç‰ˆæœ¬æ‰©å±•åï¼Œä¹Ÿèƒ½ä½¿ Java è¯­è¨€ API è„±ç³–ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥åœ¨æ”¯æŒè¾ƒä½ Android ç‰ˆæœ¬çš„åº”ç”¨ä¸­æ·»åŠ è¿‡å»ä»…åœ¨æœ€æ–° Android ç‰ˆæœ¬ä¸­å¯ç”¨çš„æ ‡å‡†è¯­è¨€ APIï¼ˆå¦‚ <code>java.util.streams</code>ï¼‰ã€‚</p>
<p>ä½¿ç”¨ Android Gradle æ’ä»¶ 4.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬æ„å»ºåº”ç”¨æ—¶ï¼Œæ”¯æŒä¸‹é¢ä¸€ç»„ APIï¼š</p>
<ul>
<li>é¡ºåºæµ (<code>java.util.stream</code>)</li>
<li><code>java.time</code> çš„å­é›†</li>
<li><code>java.util.function</code></li>
<li><code>java.util.{Map,Collection,Comparator}</code> çš„æœ€è¿‘æ–°å¢å†…å®¹</li>
<li>å¯é€‰å†…å®¹ï¼ˆ<code>java.util.Optional</code>ã€<code>java.util.OptionalInt</code> å’Œ <code>java.util.OptionalDouble</code>ï¼‰ä»¥åŠå¯¹ä¸Šè¿° API å¾ˆæœ‰ç”¨çš„ä¸€äº›å…¶ä»–æ–°ç±»</li>
<li><code>java.util.concurrent.atomic</code> çš„ä¸€äº›æ–°å¢å†…å®¹ï¼ˆ<code>AtomicInteger</code>ã€<code>AtomicLong</code> å’Œ <code>AtomicReference</code> çš„æ–°æ–¹æ³•ï¼‰</li>
<li><code>ConcurrentHashMap</code>ï¼ˆåŒ…å« Android 5.0 çš„é—®é¢˜ä¿®å¤ï¼‰</li>
</ul>
<p>å¦‚éœ€æŸ¥çœ‹å—æ”¯æŒçš„ API çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…<a href="https://developer.android.google.cn/studio/write/java8-support-table">é€šè¿‡è„±ç³–è·å¾— Java 8 åŠæ›´é«˜ç‰ˆæœ¬ API</a>ã€‚</p>
<p>ä¸ºäº†æ”¯æŒè¿™äº›è¯­è¨€ APIï¼Œæ’ä»¶ç¼–è¯‘äº†ä¸€ä¸ªå•ç‹¬çš„ DEX æ–‡ä»¶ï¼ˆå…¶ä¸­åŒ…å«ç¼ºå¤± API çš„å®ç°ï¼‰ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ‚¨çš„åº”ç”¨ä¸­ã€‚è„±ç³–è¿‡ç¨‹ä¼šé‡æ–°ç¼–å†™åº”ç”¨çš„ä»£ç ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶æ”¹ç”¨æ­¤åº“ã€‚</p>
</blockquote>
<blockquote>
<ul>
<li><strong><a href="https://developer.android.google.cn/studio/command-line/d8">ç¼–è¯‘ä½¿ç”¨äº† Java 8 è¯­è¨€åŠŸèƒ½çš„å­—èŠ‚ç </a></strong></li>
</ul>
<p><code>d8</code> é€šè¿‡ä¸€ä¸ªå«åšâ€œè„±ç³–â€çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œä½¿æ‚¨èƒ½å¤Ÿåœ¨ä»£ç ä¸­<a href="https://developer.android.google.cn/studio/write/java8-support">ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½</a>ï¼Œæ­¤è¿‡ç¨‹ä¼šå°†è¿™äº›å®ç”¨çš„è¯­è¨€åŠŸèƒ½è½¬æ¢ä¸ºå¯ä»¥åœ¨ Android å¹³å°ä¸Šè¿è¡Œçš„å­—èŠ‚ç ã€‚</p>
<p>Android Studio å’Œ Android Gradle æ’ä»¶åŒ…å«äº† <code>d8</code> ä¸ºæ‚¨å¯ç”¨è„±ç³–æ‰€éœ€çš„ç±»è·¯å¾„èµ„æºã€‚</p>
<p>Android Studio å’Œ Android Gradle æ’ä»¶åŒ…å«äº† <code>d8</code> ä¸ºæ‚¨å¯ç”¨è„±ç³–æ‰€éœ€çš„ç±»è·¯å¾„èµ„æºã€‚ä¸è¿‡ï¼Œä»å‘½ä»¤è¡Œä½¿ç”¨ <code>d8</code> æ—¶ï¼Œæ‚¨éœ€è¦æ‰‹åŠ¨æ·»åŠ è¿™äº›èµ„æºã€‚</p>
<p>å…¶ä¸­ä¸€ä¸ªèµ„æºå°±æ˜¯ç›®æ ‡ Android SDK ä¸­çš„ <code>android.jar</code>ã€‚æ­¤èµ„æºåŒ…å«ä¸€ç»„ Android å¹³å° APIï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>--lib</code> æ ‡è®°æ¥æŒ‡å®šè¯¥èµ„æºçš„è·¯å¾„ã€‚</p>
<p>å¦ä¸€ä¸ªèµ„æºæ˜¯æ‚¨é¡¹ç›®çš„éƒ¨åˆ†å·²ç¼–è¯‘çš„ Java å­—èŠ‚ç ï¼Œæ‚¨ç›®å‰ä¸æ‰“ç®—å°†è¿™éƒ¨åˆ†å­—èŠ‚ç ç¼–è¯‘ä¸º DEX å­—èŠ‚ç ï¼Œä½†åœ¨å°†å…¶ä»–ç±»ç¼–è¯‘ä¸º DEX å­—èŠ‚ç æ—¶éœ€è¦ç”¨åˆ°è¿™äº›å­—èŠ‚ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»£ç ä½¿ç”¨<a href="https://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html">é»˜è®¤å’Œé™æ€æ¥å£æ–¹æ³•</a>ï¼ˆä¸€ç§ Java 8 è¯­è¨€åŠŸèƒ½ï¼‰ï¼Œåˆ™æ‚¨éœ€è¦ä½¿ç”¨æ­¤æ ‡è®°æ¥æŒ‡å®šæ‚¨é¡¹ç›®çš„æ‰€æœ‰ Java å­—èŠ‚ç çš„è·¯å¾„ï¼Œå³ä½¿æ‚¨ä¸æ‰“ç®—å°†æ‰€æœ‰ Java å­—èŠ‚ç éƒ½ç¼–è¯‘ä¸º DEX å­—èŠ‚ç ä¹Ÿæ˜¯å¦‚æ­¤ã€‚<strong>è¿™æ˜¯å› ä¸º <code>d8</code> éœ€è¦æ ¹æ®è¿™äº›ä¿¡æ¯æ¥ç†è§£æ‚¨é¡¹ç›®çš„ä»£ç å¹¶è§£æå¯¹æ¥å£æ–¹æ³•çš„è°ƒç”¨</strong>ã€‚</p>
</blockquote>
<p>é€šè¿‡ä»¥ä¸Šæè¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š</p>
<ul>
<li>Android é€šè¿‡ D8 å°† class è½¬æ¢ä¸ºå¯åœ¨Androidå¹³å°ä¸Šæ‰§è¡Œçš„dexï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º <strong>desugar ï¼ˆè„±ç³–ï¼‰</strong>ã€‚</li>
<li>è„±ç³–è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡æ–°ç¼–å†™åº”ç”¨çš„ä»£ç ã€‚</li>
<li>è„±ç³–æ—¶éœ€è¦æŒ‡å®šè„±ç³–æ‰€éœ€è¦çš„ç±»è·¯å¾„èµ„æºã€‚</li>
</ul>
<h3 id="å¯¹åº”æˆ‘ä»¬çš„é—®é¢˜">å¯¹åº”æˆ‘ä»¬çš„é—®é¢˜</h3>
<blockquote>
<p>å¾…è¡¥å……</p>
<p>é€šè¿‡ d8 æ‰‹åŠ¨å¯¹classè¿›è¡Œdexè½¬æ¢ï¼Œç„¶åè§‚å¯Ÿè½¬æ¢å·®å¼‚ã€‚</p>
</blockquote>
<pre><code class="language-shell">d8 MainActivity.class --intermediate --file-per-class --output ~/build/intermediate/dex
--lib android_sdk/platforms/api-level/android.jar
--classpath ~/build/javac/debug
</code></pre>
<p>å°†ç±»æ–‡ä»¶ç¼–è¯‘æˆ dex ä»£ç çš„è¿‡ç¨‹ä¸­æ‰§è¡Œå­—èŠ‚ç è½¬æ¢ï¼Œè¿™ç§è½¬æ¢ç§°ä¸º <code>desugar</code>ã€‚AGP ä½¿ç”¨ D8 å®Œæˆdesugar ï¼Œä¸ºäº†èƒ½æ­£ç¡®çš„å¤„ç†classï¼Œéœ€è¦æ ¹æ®POMä¾èµ–ä¿¡æ¯æ¥å¯»æ‰¾å¯¹åº”çš„ä¾èµ–ï¼Œç„¶åå°†æ‰€æœ‰ä¾èµ–é¡¹ç›®éƒ½åŠ å…¥åˆ° desurge classpathï¼Œç„¶åæ‰èƒ½æ­£ç¡®å¤„ç†ã€‚è€Œ aar å¼•å…¥æ—¶ä¸å…·å¤‡è¿™äº›POMä¾èµ–ä¿¡æ¯ï¼Œæ‰€ä»¥æ— æ³•è¿˜åŸã€‚</p>
<h2 id="è¿›ä¸€æ­¥äº†è§£">è¿›ä¸€æ­¥äº†è§£</h2>
<ul>
<li><a href="https://developer.android.google.cn/studio/command-line/d8">d8  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></li>
<li><a href="https://developer.android.google.cn/studio/write/java8-support">ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½å’Œ API  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></li>
<li><a href="https://developer.android.google.cn/studio/write/java8-support#library-desugaring">ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½å’Œ API  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></li>
<li><a href="https://developer.android.google.cn/studio/releases/gradle-plugin">Android Gradle æ’ä»¶ç‰ˆæœ¬è¯´æ˜  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Dagger åœ¨Androidåº“(SDK)æ¨¡å—ä¸­çš„ä½¿ç”¨å®è·µ]]></title>
        <id>https://hanlyjiang.github.io/post/dagger-zai-android-ku-sdkmo-kuai-zhong-de-shi-yong-shi-jian/</id>
        <link href="https://hanlyjiang.github.io/post/dagger-zai-android-ku-sdkmo-kuai-zhong-de-shi-yong-shi-jian/">
        </link>
        <updated>2022-03-06T07:11:54.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æè¿°å¦‚ä½•ä½¿ç”¨Daggerè§£å†³å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜æ˜¯ï¼š</p>
<ol>
<li>å¦‚ä½•åœ¨åº“ï¼ˆSDKï¼‰æ¨¡å—ä¸­ä½¿ç”¨Daggerä¾èµ–æ³¨å…¥ï¼Ÿ</li>
<li>MVPä¸­çš„Daggerä¾èµ–æ³¨å…¥å¦‚ä½•å®ç°æ— æ„Ÿæ³¨å…¥ï¼Ÿ</li>
</ol>
<p>æœ¬æ–‡ä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨Daggerï¼Œåªä¸“æ³¨äºæè¿°å¦‚ä¸Šä¸¤ä¸ªé—®é¢˜çš„è§£å†³çš„å‰å› åæœåŠè§£å†³æ–¹æ¡ˆã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦æè¿°å¦‚ä½•ä½¿ç”¨Daggerè§£å†³å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜æ˜¯ï¼š</p>
<ol>
<li>å¦‚ä½•åœ¨åº“ï¼ˆSDKï¼‰æ¨¡å—ä¸­ä½¿ç”¨Daggerä¾èµ–æ³¨å…¥ï¼Ÿ</li>
<li>MVPä¸­çš„Daggerä¾èµ–æ³¨å…¥å¦‚ä½•å®ç°æ— æ„Ÿæ³¨å…¥ï¼Ÿ</li>
</ol>
<p>æœ¬æ–‡ä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨Daggerï¼Œåªä¸“æ³¨äºæè¿°å¦‚ä¸Šä¸¤ä¸ªé—®é¢˜çš„è§£å†³çš„å‰å› åæœåŠè§£å†³æ–¹æ¡ˆã€‚</p>
<!-- more -->
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>æ¥æ‰‹å¼€å‘ä¸€ä¸ªSDKï¼Œå¤§è‡´æƒ…å†µå¦‚ä¸‹ï¼š</p>
<ul>
<li>è¯¥SDKå†…éƒ¨æœ‰è‹¥å¹²ç•Œé¢ï¼ŒåŒ…æ‹¬Activityï¼ŒFragmentç­‰</li>
<li>ä½¿ç”¨MVPæ¶æ„</li>
</ul>
<p>é€æ¸å‘ç°å†…éƒ¨ä¾èµ–æ··ä¹±ï¼Œåœ¨å¾—ç©ºåï¼Œé‚å¯¹å…¶ä¾èµ–éƒ¨åˆ†è¿›è¡Œé‡æ„æ”¹é€ ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨ä¾èµ–æ³¨å…¥è¿›è¡Œæ”¹é€ ">ä¸ºä»€ä¹ˆä½¿ç”¨ä¾èµ–æ³¨å…¥è¿›è¡Œæ”¹é€ ï¼Ÿ</h3>
<p>ä¸»è¦æ˜¯ä¾èµ–æ··ä¹±ï¼Œå•ä¾‹çš„æ»¥ç”¨å¯¼è‡´ä¾èµ–å…³ç³»ä¸æ˜æ˜¾ï¼Œæ— æ³•ç®¡ç†ï¼Œæ— æ³•æµ‹è¯•</p>
<p>æŸäº›å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨å¾ˆå¤šç±»ä¸­éƒ½éœ€è¦ä½¿ç”¨ï¼Œå¦‚ Retrofit çš„è¯·æ±‚å¯¹è±¡ï¼Œä»£è¡¨ä¿¡æ¯çš„æ ‡è¯†å­—æ®µç­‰ï¼Œæ­¤æ—¶ä¸ºäº†é¿å…é€šè¿‡æ„é€ å‡½æ•°æˆ–è€…setteræ–¹æ³•æ¥ä¼ é€’ï¼Œå°±ç›´æ¥èµ·äº†ä¸ªå•ä¾‹ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–ç±»ä¼¼çš„æƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´å•ä¾‹æœ‰10å¤šä¸ªï¼Œè°ƒç”¨å•ä¾‹ getInstance çš„åœ°æ–¹æ›´æ˜¯æ•°ä¸èƒœæ•°ã€‚</p>
<p>å¯¼è‡´æˆ‘ä»¬è¦å¯¹å¯¹åº”çš„ä»£ç è¿›è¡Œå•å…ƒæµ‹è¯•åšmockæ“ä½œå¼‚å¸¸å›°éš¾ï¼Œ</p>
<ol>
<li>å› ä¸ºä¾èµ–å…³ç³»å¤ªä¸æ˜æ˜¾ï¼Œå‡ ä¹å¾—ä¸€è¡Œè¡Œæ‰¾æ‰èƒ½æ‰¾åˆ°ç±»æˆ–æ–¹æ³•åˆ°åº•ä¾èµ–äº†å“ªäº›å¯¹è±¡</li>
<li>åŒæ—¶mockçš„è¿‡ç¨‹ä¹Ÿå˜å¾—éº»çƒ¦ï¼Œç”±äºæ²¡æœ‰ä½œä¸ºç±»æˆå‘˜ï¼Œæ‰€ä»¥æ— æ³•ç®€å•é€šè¿‡mockæ›¿æ¢å¯¹åº”æˆå‘˜ï¼›</li>
</ol>
<h3 id="ä¾èµ–æ³¨å…¥æ”¹é€ çš„é—®é¢˜ç‚¹">ä¾èµ–æ³¨å…¥æ”¹é€ çš„é—®é¢˜ç‚¹</h3>
<p>ä¸»è¦æœ‰å¦‚ä¸‹é—®é¢˜ï¼š</p>
<p style="color:red;">1.Â æ²¡æœ‰Applicationã€‚è¯¥æ¨¡å—ä¸ºSDKï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥ä¿®æ”¹Applicationå¯¹è±¡ï¼ŒApplicationä¸ºé›†æˆæ–¹è‡ªè¡Œç¼–å†™ã€‚</p>
<p style="color:red;">2. MVPçš„ç»‘å®šã€‚MVPç»‘å®šä¸­æ¨¡æ¿ä»£ç è¾ƒå¤šï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å°½å¯èƒ½çš„å®ç°æ— æ„Ÿçš„æ³¨å…¥ã€‚</p>
<p>ä¹‹æ‰€ä»¥æç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºGoogle é’ˆå¯¹Androidï¼Œåœ¨Daggerçš„åŸºç¡€ä¸Šé’ˆå¯¹æ€§çš„æ„å»ºäº†ä¸€ä¸ªHilt çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œèƒ½å¤Ÿå‡å°‘Androidä¸­ç›´æ¥ä½¿ç”¨Daggerçš„æ¨¡æ¿ä»£ç ã€‚ä½†æ˜¯Hiltçš„ä½¿ä¸­æœ‰è¦æ±‚ï¼š</p>
<blockquote>
<p><strong>æ‰€æœ‰ä½¿ç”¨ Hilt çš„åº”ç”¨éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªå¸¦æœ‰ <code>@HiltAndroidApp</code> æ³¨é‡Šçš„ <code>Application</code> ç±»ã€‚</strong></p>
<p>å‚è€ƒï¼š <a href="https://developer.android.google.cn/training/dependency-injection/hilt-android">ä½¿ç”¨ Hilt å®ç°ä¾èµ–é¡¹æ³¨å…¥  | Android å¼€å‘è€…  | Android Developers (google.cn)</a></p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯å¿…é¡»èƒ½æ§åˆ¶ä½Applicationï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬ä½œä¸ºä¸€ä¸ªSDKçš„æä¾›æ–¹ï¼š</p>
<ol>
<li>æ˜¯æ²¡æœ‰æœºä¼šä¿®æ”¹Applicationçš„ä»£ç çš„</li>
<li>è€Œä¸”ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½è¦æ±‚ä½¿ç”¨æ–¹å»åšè¿™ç§é™åˆ¶ï¼›åŒæ—¶ï¼Œå¦‚æœä½¿ç”¨æ–¹æœ‰ä½¿ç”¨ Hilt å‘¢ï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦ä¼šå¯¹å…¶äº§ç”Ÿå½±å“ï¼Ÿ</li>
</ol>
<p><strong>æ•…ï¼Œæˆ‘ä»¬åªèƒ½ç›´æ¥ä½¿ç”¨Daggerã€‚</strong></p>
<p>è€Œå¦å¤–ä¸€ä¸ªé—®é¢˜åœ¨äºMVPçš„æ¶æ„é™åˆ¶ï¼ŒP å±‚éœ€è¦æŒæœ‰Vå±‚çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯Pä¾èµ–Vï¼Œè€ŒVé€šå¸¸æ˜¯Activityæˆ–è€…Fragmentï¼Œè€ŒActivityåŠFragmentçš„åˆ›å»ºè¿‡ç¨‹ç”±Androidç³»ç»Ÿæ§åˆ¶ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨Daggeræ—¶æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›æ¨¡æ¿ä»£ç ï¼ˆä¸‹æ–¹ä¼šè¯´æ˜ï¼‰ï¼Œå°† ActivityåŠFragmentå¯¹è±¡æ³¨å…¥åˆ° Dagger çš„ä¾èµ–å›¾è°±ä¸­ã€‚</p>
<h2 id="æ²¡æœ‰-application-çš„é—®é¢˜è§£å†³">æ²¡æœ‰ Application çš„é—®é¢˜è§£å†³</h2>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦è§£å†³çš„æ˜¯æ²¡æœ‰Applicationçš„é—®é¢˜ï¼Œé‚£ä¹ˆæ²¡æœ‰Applicationä¼šç»™æˆ‘ä»¬å¸¦æ¥å“ªäº›é—®é¢˜å‘¢ï¼Ÿ</p>
<ol>
<li>æ— æ³•ä½¿ç”¨ Hilt</li>
<li>æ— æ³•ç›´æ¥ä½¿ç”¨ dagger-android</li>
</ol>
<p>è¿™ä¸¤ä¸ªé—®é¢˜å®é™…ä¸Šæ˜¯ç±»ä¼¼çš„ï¼ŒHiltåŠDagger-Androidéƒ½æ˜¯ç”¨äºè§£å†³ Android ç»„ä»¶ï¼ˆActivityï¼ŒFragmentï¼ŒServiceï¼ŒBroadcastReceiver ç­‰ï¼‰çš„ä¾èµ–æ³¨å…¥çš„ã€‚ä½†æ˜¯ä»–ä»¬éƒ½è¦æ±‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ Applicationã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä¸€å®šè¦application">ä¸ºä»€ä¹ˆä¸€å®šè¦Applicationï¼Ÿ</h3>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ dagger-android çš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œå‚è€ƒ [Google çš„ç¤ºä¾‹](<a href="https://github.com/android/architecture-components-samples/tree/master/GithubBrowserSample">architecture-components-samples/GithubBrowserSample at master Â· android/architecture-components-samples</a>) è¿›è¡Œè¯´æ˜ã€‚</p>
<h4 id="dagger-android-çš„ä½¿ç”¨">Dagger-Android çš„ä½¿ç”¨</h4>
<p>è¿™é‡Œæˆ‘ä»¬çœç•¥ gradle ä¾èµ–çš„å¼•å…¥éƒ¨åˆ†ï¼Œç›´æ¥è§£é‡Šä»£ç ã€‚</p>
<h5 id="1-application-è¿›è¡Œæ”¹é€ ">1. Application è¿›è¡Œæ”¹é€ </h5>
<p>å¦‚ä¸‹ä»£ç æ‰€è¿°ï¼Œä¸»è¦æœ‰å¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<ol>
<li>ä»¤ Application å®ç° <code>HasActivityInjector</code> æ¥å£ï¼›</li>
<li>Application ä¸­æ³¨å…¥ä¸€ä¸ªç±»å‹ä¸º <code>DispatchingAndroidInjector&lt;Activity&gt;</code> çš„æˆå‘˜ï¼ŒåŒæ—¶é€šè¿‡HasActivityInjectoræ¥å£å®šä¹‰çš„é‡è½½æ–¹æ³• <code>activityInjector()</code> è¿”å›è¯¥æˆå‘˜ã€‚</li>
<li>åœ¨ <code>Application.onCreate</code> ä¸­è°ƒç”¨ <code>AppInjector.init(this)</code> æ‰§è¡Œæ³¨å…¥æ“ä½œã€‚</li>
</ol>
<p>è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæ¯•äº†ï¼Œä¹‹åå°±å¯ä»¥ä½¿ç”¨Dagger æ— æ„Ÿæ³¨å…¥Activityæˆ–è€…Fragmentäº†ã€‚</p>
<pre><code class="language-kotlin">class GithubApp : Application(), HasActivityInjector {
    @Inject
    lateinit var dispatchingAndroidInjector: DispatchingAndroidInjector&lt;Activity&gt;

    override fun onCreate() {
        super.onCreate()
        if (BuildConfig.DEBUG) {
            Timber.plant(Timber.DebugTree())
        }
        AppInjector.init(this)
    }

    override fun activityInjector() = dispatchingAndroidInjector
}
</code></pre>
<p>AppInjector.init çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯ï¼š</p>
<ul>
<li>åœ¨ Activity Create çš„æ—¶å€™è°ƒç”¨ <code>AndroidInjection.inject(activity)</code> åŠ</li>
<li>åœ¨ Fragment Create çš„æ—¶å€™è°ƒç”¨ <code>AndroidSupportInjection.inject(f)</code></li>
</ul>
<pre><code class="language-kotlin">object AppInjector {
    fun init(githubApp: GithubApp) {
        DaggerAppComponent.builder().application(githubApp)
            .build().inject(githubApp)
        githubApp
            .registerActivityLifecycleCallbacks(object : Application.ActivityLifecycleCallbacks {
                override fun onActivityCreated(activity: Activity, savedInstanceState: Bundle?) {
                    handleActivity(activity)
                }
            })
    }

    private fun handleActivity(activity: Activity) {
        if (activity is HasSupportFragmentInjector) {
            AndroidInjection.inject(activity)
        }
        if (activity is FragmentActivity) {
            activity.supportFragmentManager
                .registerFragmentLifecycleCallbacks(
                    object : FragmentManager.FragmentLifecycleCallbacks() {
                        override fun onFragmentCreated(fm: FragmentManager,f: Fragment,savedInstanceState: Bundle?
                        ) {
                            if (f is Injectable) {
                                AndroidSupportInjection.inject(f)
                            }
                        }
                    }, true
                )
        }
    }
}
</code></pre>
<blockquote>
<p><code>AndroidInjection.inject</code> åŠ <code>AndroidSupportInjection.inject</code>ä¸º dagger-android æä¾›çš„æ¥å£ï¼Œæˆ‘ä»¬åç»­è¿›è¡Œåˆ†æã€‚</p>
</blockquote>
<h5 id="2-ä½¿ç”¨">2. ä½¿ç”¨</h5>
<p>å†å®Œæˆä¸Šè¿°å‡†å¤‡å·¥ä½œä¹‹åï¼Œè¦æƒ³è®©Activityæˆ–è€…Fragmentèƒ½å¤Ÿè‡ªåŠ¨æ³¨å…¥ï¼Œåªéœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼ˆæˆ‘ä»¬åŒæ ·è¿˜æ˜¯å‚è€ƒ<a href="https://github.com/android/architecture-components-samples/blob/master/GithubBrowserSample/app/src/main/java/com/android/example/github/di/MainActivityModule.kt">Googleç¤ºä¾‹ä»£ç </a>ï¼‰</p>
<ol>
<li>åœ¨ Module ä¸­ä½¿ç”¨<code>@ContributesAndroidInjector</code> æ ‡è®°ä¸€ä¸ªè¿”å›å¯¹åº”Activityï¼ˆå¦‚MainActivityï¼‰çš„æ–¹æ³•</li>
</ol>
<pre><code class="language-kotlin">// https://github.com/android/architecture-components-samples/blob/master/GithubBrowserSample/app/src/main/java/com/android/example/github/di/MainActivityModule.kt
@Module
abstract class MainActivityModule {
    @ContributesAndroidInjector(modules = [FragmentBuildersModule::class])
    abstract fun contributeMainActivity(): MainActivity
}
</code></pre>
<ol start="2">
<li>å½“ç„¶è¿˜éœ€è¦å°†è¿™ä¸ªModuleåŒ…å«åˆ° AppComponentä¸­ï¼ˆåŒæ—¶ AppComponentä¸­éœ€è¦åŒ…å« <code>AndroidInjectionModule</code>è¿™ä¸ª dagger-android æä¾›çš„moduleï¼‰</li>
</ol>
<pre><code class="language-kotlin">// https://github.com/android/architecture-components-samples/blob/master/GithubBrowserSample/app/src/main/java/com/android/example/github/di/AppComponent.kt
@Singleton
@Component(
    modules = [
        AndroidInjectionModule::class,
        MainActivityModule::class]
)
interface AppComponent {
    // åˆ é™¤å…¶ä»–éƒ¨åˆ†
}
</code></pre>
<h5 id="3-æ€»ç»“">3. æ€»ç»“</h5>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨dagger-androidæ—¶ï¼Œåœ¨å®Œæˆäº†å‡†å¤‡åŠ¨ä½œä¹‹åï¼Œ<strong>åç»­åªéœ€è¦æ·»åŠ ä¸€ä¸ª <code>@ContributesAndroidInjector</code> æ³¨è§£çš„æ–¹æ³•ï¼Œå°±å¯ä»¥è®©ä½ çš„Activityæ”¯æŒè‡ªåŠ¨ä¾èµ–æ³¨å…¥ã€‚</strong></p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦-application">ä¸ºä»€ä¹ˆéœ€è¦ Application</h3>
<p>ä¸Šé¢ä»‹ç»äº† dagger-android çš„ä½¿ç”¨æ–¹å¼ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†å±•ç¤ºåœ¨ä½¿ç”¨Dagger-Androidä¹‹åï¼Œæˆ‘ä»¬<strong>å¯ä»¥æ— éœ€å¯¹Activityè¿›è¡Œä¿®æ”¹ï¼Œå°±å¯ä»¥è‡ªåŠ¨å‘å…¶ä¸­æ³¨å…¥ä¾èµ–</strong>ã€‚ è¿™é‡Œçš„ä¿®æ”¹å®é™…ä¸ŠæŒ‡çš„æ˜¯æ‰‹åŠ¨åœ¨æ¯ä¸ªActivity çš„ onCreate æ–¹æ³•è°ƒç”¨Daggerç»„ä»¶çš„æ³¨å…¥æ–¹æ³•ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬çš„é—®é¢˜å¹¶æ²¡æœ‰å¾—åˆ°å›ç­”ï¼Œå³ï¼š</p>
<p><b><span style="color:red;">ä¸ºä»€ä¹ˆéœ€è¦Applicationï¼Ÿ</span></b></p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ <code>AndroidInjection.inject(activity)</code> çš„å®ç°ï¼š(AndroidInjection ä¸ºdagger-android åº“æä¾›çš„è¾…åŠ©å·¥å…·ç±»)</p>
<pre><code class="language-kotlin">public static void inject(Activity activity) {
    checkNotNull(activity, &quot;activity&quot;);
    Application application = activity.getApplication();
    if (!(application instanceof HasActivityInjector)) {
      throw new RuntimeException(
          String.format(
              &quot;%s does not implement %s&quot;,
              application.getClass().getCanonicalName(),
              HasActivityInjector.class.getCanonicalName()));
    }

    AndroidInjector&lt;Activity&gt; activityInjector =
        ((HasActivityInjector) application).activityInjector();
    checkNotNull(activityInjector, &quot;%s.activityInjector() returned null&quot;, application.getClass());

    activityInjector.inject(activity);
  }
</code></pre>
<p>ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†å¦‚ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li><strong>ç”±Activityè·å–Application</strong>ï¼›</li>
<li>åˆ¤æ–­ Application æ˜¯å¦å®ç°äº† HasActivityInjector</li>
<li>ä» Application è·å– <code>AndroidInjector&lt;Activity&gt;</code>ï¼Œç„¶åä½¿ç”¨æ­¤å¯¹è±¡æ‰§è¡Œå¯¹ç›®æ ‡Activityçš„æ³¨å…¥ã€‚</li>
</ol>
<p>å¦å¤–ï¼ŒAndroidInjection ç±»è¿˜æœ‰å¯¹ Serviceï¼ŒFragmentç­‰çš„æ³¨å…¥è¾…åŠ©æ–¹æ³•ï¼Œè¿‡ç¨‹ä¸­ä¹Ÿéƒ½ç±»ä¼¼å¯¹Activityçš„æ³¨å…¥ï¼Œä¼šè·å– Application å¯¹è±¡ï¼Œç„¶åä»Applicationå¯¹è±¡ä¸­è·å–AndroidInejctorï¼Œå†ç”¨æ­¤å¯¹è±¡è¿›è¡Œç›®æ ‡ç»„ä»¶çš„ä¾èµ–æ³¨å…¥ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ä¸ºä»€ä¹ˆä¸€å®šè¦Applicationäº†ï¼š</p>
<ol>
<li><strong>å®é™…ä¸Šï¼Œæ˜¯éœ€è¦å…¶ä¸­çš„ AndroidInjector ï¼›</strong></li>
<li><strong>åœ¨å„ç§Androidç»„ä»¶ä¸­ï¼ˆActivityï¼ŒServiceï¼Œç­‰ï¼‰æˆ‘ä»¬éƒ½èƒ½ç›´æ¥é€šè¿‡å…¶è·å–åˆ°Applicationå¯¹è±¡ï¼Œè¿™æ ·å°±èƒ½æ‰¾åˆ°å­˜åœ¨äºApplicationä¸­çš„ AndroidInjectorï¼Œç„¶åæ‰§è¡Œæ³¨å…¥æ“ä½œã€‚</strong></li>
</ol>
<h3 id="æ‰©å±•-androidinjector-å“ªé‡Œæ¥çš„">æ‰©å±• - AndroidInjector å“ªé‡Œæ¥çš„ï¼Ÿ</h3>
<p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†ä¸ºä»€ä¹ˆ dagger-android ä¸€å®šéœ€è¦Applicationï¼Œæ˜¯ä¸ºäº†è·å–å…¶ä¸­çš„AndroidInjector ç”¨æ¥æ‰§è¡Œç›®æ ‡Androidç»„ä»¶çš„æ³¨å…¥æ“ä½œã€‚</p>
<p>é‚£ä¹ˆï¼Œ<strong>è¿™ä¸ª AndroidInjector æ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ</strong></p>
<p>ç”±å‰é¢çš„GithubAppä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ª AndroidInject å°±æ˜¯Applicationä¸­ä½¿ç”¨äº† <code>@Inject</code> æ ‡è®°çš„ç±»å‹ä¸º<code> DispatchingAndroidInjector&lt;Activity&gt;</code> çš„å¯¹è±¡</p>
<pre><code class="language-kotlin">// AndroidInjection.inject(activity)
AndroidInjector&lt;Activity&gt; activityInjector =
        ((HasActivityInjector) application).activityInjector();    

// GithubApp
@Inject
lateinit var dispatchingAndroidInjector: DispatchingAndroidInjector&lt;Activity&gt;
override fun activityInjector() = dispatchingAndroidInjector
</code></pre>
<p>æˆ‘ä»¬å»Dagger çš„ç”Ÿæˆä»£ç ä¸­( <code>DaggerAppComponent</code> )ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç±»å‹ <code>DispatchingAndroidInjector&lt;Activity&gt;</code></p>
<pre><code class="language-java">// DaggerAppComponent.java  
	private DispatchingAndroidInjector&lt;Activity&gt; getDispatchingAndroidInjectorOfActivity() {
    return DispatchingAndroidInjector_Factory.newDispatchingAndroidInjector(
        getMapOfClassOfAndProviderOfFactoryOf());
  }

  private GithubApp injectGithubApp(GithubApp instance) {
    GithubApp_MembersInjector.injectDispatchingAndroidInjector(
        instance, getDispatchingAndroidInjectorOfActivity());
    return instance;
  }
 
	@Override
  public void inject(GithubApp githubApp) {
    injectGithubApp(githubApp);
  }

// GithubApp_MembersInjector.java
  @Override
  public void injectMembers(GithubApp instance) {
    injectDispatchingAndroidInjector(instance, dispatchingAndroidInjectorProvider.get());
  }

  public static void injectDispatchingAndroidInjector(
      GithubApp instance, DispatchingAndroidInjector&lt;Activity&gt; dispatchingAndroidInjector) {
    instance.dispatchingAndroidInjector = dispatchingAndroidInjector;
  }
</code></pre>
<p>å¯ä»¥çœ‹åˆ° DaggerAppComponentä¸­åœ¨æ³¨å…¥<code>inject(GithubApp)</code>æ—¶ï¼Œä¼šå°†<code>DispatchingAndroidInjector&lt;Activity&gt;</code> ç±»å‹çš„ä¾èµ–æ³¨å…¥åˆ° GithubApp ä¸­ã€‚</p>
<blockquote>
<p><strong>æ›´å¤šç»†èŠ‚ï¼š</strong></p>
<ol>
<li>
<p>dagger-android-processor  å¤„ç†å…¶ä¼šæ ¹æ® <code>@ContributesAndroidInjector</code> è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªModuleçš„ä»£ç ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">@Module(subcomponents = MainActivityModule_ContributeMainActivity.MainActivitySubcomponent.class)
public abstract class MainActivityModule_ContributeMainActivity {
  private MainActivityModule_ContributeMainActivity() {}

  @Binds
  @IntoMap
  @ActivityKey(MainActivity.class)
  abstract AndroidInjector.Factory&lt;? extends Activity&gt; bindAndroidInjectorFactory(
      MainActivitySubcomponent.Builder builder);

  @Subcomponent(modules = FragmentBuildersModule.class)
  public interface MainActivitySubcomponent extends AndroidInjector&lt;MainActivity&gt; {
    @Subcomponent.Builder
    abstract class Builder extends AndroidInjector.Builder&lt;MainActivity&gt; {}
  }
}
</code></pre>
<ul>
<li>æ­¤æ¨¡å—ä¸­å®šä¹‰äº† <code>bindAndroidInjectorFactory</code> æ–¹æ³•ï¼Œä½¿ç”¨ <code>@Binds @IntoMap</code>ç”Ÿæˆ  <code>Map&lt;Class&lt;? extends T&gt;, Provider&lt;AndroidInjector.Factory&lt;? extends T&gt;&gt;&gt;</code> ç±»å‹çš„Map</li>
<li>åœ¨è¿™é‡Œæ³¨å…¥åˆ°Mapä¸­çš„å†…å®¹å°±æ˜¯ <code>(MainActivity.class, MainActivitySubcomponent.Builder builder)</code>, å…¶ä¸­ <code>MainActivitySubcomponent.Builder</code>  ç”¨äºæ„å»º <code>MainActivitySubcomponent</code></li>
<li><code>MainActivitySubcomponent</code> ç»§æ‰¿äº† <code>AndroidInjector&lt;MainActivity&gt;</code> ç±»ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€ä¸ª <code>inject(MainActivity instance)</code>çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æœ€ä¸­å®ç°å¯¹ MainActivity ä¾èµ–æ³¨å…¥çš„å®ç°å…¥å£ï¼›</li>
</ul>
</li>
<li>
<p>åŒæ—¶ <code>dagger-android</code> ä¸­çš„<code>DispatchingAndroidInjector</code> ç±»ä¸­ï¼Œä¼šå£°æ˜å¯¹ ç±»å‹<code>Map&lt;Class&lt;? extends T&gt;, Provider&lt;AndroidInjector.Factory&lt;? extends T&gt;&gt;&gt;</code> çš„ä¾èµ–ï¼Œæ‰€ä»¥ä¸Šé¢çš„<code>(MainActivity.class, MainActivitySubcomponent.Builder builder)</code>ä¼šè‡ªåŠ¨è¢«æ³¨å…¥åˆ° <code>DispatchingAndroidInjector</code> å¯¹è±¡ä¸­</p>
<pre><code class="language-java"> public final class DispatchingAndroidInjector&lt;T&gt; implements AndroidInjector&lt;T&gt; {
     private final Map&lt;Class&lt;? extends T&gt;, Provider&lt;AndroidInjector.Factory&lt;? extends T&gt;&gt;&gt;
      injectorFactories;
   
     @Inject
      DispatchingAndroidInjector(
        Map&lt;Class&lt;? extends T&gt;, Provider&lt;AndroidInjector.Factory&lt;? extends T&gt;&gt;&gt; injectorFactories) {
        this.injectorFactories = injectorFactories;
      }
 }
</code></pre>
</li>
<li>
<p>è€Œè¿™ä¸ª <code>DispatchingAndroidInjector&lt;Activity&gt;</code> åœ¨ GithubAppä¸­è¢«å£°æ˜ä¸ºä¾èµ–ï¼Œæ‰€ä»¥ä¹Ÿä¼šè¢«è‡ªåŠ¨æ³¨å…¥ï¼Œä»è€Œæˆ‘ä»¬èƒ½åœ¨GithubAppä¸­é€šè¿‡ AndroidInjection è·å–åˆ° <code>DispatchingAndroidInjector&lt;Activity&gt;</code>, ç„¶åè°ƒç”¨å…¶ <code>MainActivitySubcomponent</code> ï¼Œç„¶åè°ƒç”¨å…¶ inject æ–¹æ³•å®Œæˆæ³¨å…¥</p>
<pre><code class="language-java">public final class DispatchingAndroidInjector&lt;T&gt; implements AndroidInjector&lt;T&gt; { 
	public boolean maybeInject(T instance) {
    Provider&lt;AndroidInjector.Factory&lt;? extends T&gt;&gt; factoryProvider =
      // instance ç±»å‹ä¸º MainActivityï¼Œæ‰€ä»¥å¯ä»¥è·å–åˆ° Provider&lt;MainActivitySubcomponent.Builder&gt;
        injectorFactories.get(instance.getClass());
		// è¿™é‡Œå°±é€šè¿‡ MainActivitySubcomponent.Builder è·å–åˆ° factory = MainActivitySubcomponent.Builder
    AndroidInjector.Factory&lt;T&gt; factory = (AndroidInjector.Factory&lt;T&gt;) factoryProvider.get();
    try {
      AndroidInjector&lt;T&gt; injector =
          checkNotNull(
              factory.create(instance), &quot;%s.create(I) should not return null.&quot;, factory.getClass());
			// ä¸Šé¢è°ƒç”¨  factory.create(instance) å°±æ˜¯è°ƒç”¨ MainActivitySubcomponent.Builder.create æ–¹æ³•åˆ›å»º MainActivitySubcomponent
      // è¿™é‡Œçš„ inejctor å°±æ˜¯ MainActivitySubcomponent
      // ç„¶åé€šè¿‡ MainActivitySubcomponent çš„ inejct(MainActivity) æ–¹æ³•æ¥å®ç°å¯¹ MainActivity çš„æ³¨å…¥
      injector.inject(instance);
      return true;
    } catch (ClassCastException e) {
      throw new InvalidInjectorBindingException(
          String.format(
              &quot;%s does not implement AndroidInjector.Factory&lt;%s&gt;&quot;,
              factory.getClass().getCanonicalName(), instance.getClass().getCanonicalName()),
          e);
    }
  }
}
</code></pre>
</li>
</ol>
</blockquote>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹å‰é¢çš„å†…å®¹æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p><strong>dagger-android ä¸ºäº†å®ç°å¯¹äºActivityç­‰Androidç»„ä»¶çš„æ— æ„Ÿæ³¨å…¥ï¼Œå°†Activityç­‰æ³¨å…¥çš„å®ç°Componentæ”¾åœ¨äº†Applicationçš„æˆå‘˜å˜é‡ä¸­</strong></p>
<h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h3>
<p>ä¹‹æ‰€ä»¥é€‰æ‹©Applicationå¯¹è±¡ï¼Œæ˜¯å› ä¸ºå…¶ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒæŒä¹…ï¼Œå’Œåº”ç”¨ä¸€è‡´ã€‚è€Œä¸ºäº†å¯¹Activityå®ç°æ— æ„Ÿæ³¨å…¥ï¼Œä½¿ç”¨åˆ°çš„åªæ˜¯è¢«æ³¨å…¥åˆ°Applicationä¸­çš„ DispatchingAndroidInjector å¯¹è±¡ã€‚</p>
<p>æ•…æˆ‘ä»¬å¯ä»¥å°†Applicationæ›¿æ¢ä¸ºä»»æ„ä¸€ä¸ªé™æ€çš„å¯¹è±¡å³å¯ï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">public class SdkContainer implements HasAndroidInjector {
    @Inject
    protected DispatchingAndroidInjector&lt;Object&gt; androidInjector;

    @Override
    public AndroidInjector&lt;Object&gt; androidInjector() {
        return androidInjector;
    }
}

public class SdkInjector {
    private static final String TAG = &quot;SdkInjector&quot;;

    private static SdkContainer sSdkContainer;

    public static SdkContainer getSdkContainer() {
        return sSdkContainer;
    }

    public static void init(Application application) {
        if (sSdkContainer != null) {
            return;
        }
        SdkComponent sSdkComponent = DaggerSdkComponent.builder()
                .application(application)
                .build();
        SdkInjector.sSdkContainer = new SdkContainer(sSdkComponent);
        sSdkComponent.inject(sSdkContainer);
    }
}

@Singleton
@Component(
        modules = {  AndroidInjectionModule.class,}
)
public interface SdkComponent {
    void inject(SdkContainer sdkContainer);
    @Component.Builder
    interface Builder {
        @BindsInstance
        Builder application(Application application);
        SdkComponent build();
    }
}
</code></pre>
<h2 id="mvp-æ¶æ„çš„æ³¨å…¥é—®é¢˜">MVP æ¶æ„çš„æ³¨å…¥é—®é¢˜</h2>
<h3 id="mvp-ä¸­çš„æ³¨å…¥é—®é¢˜">MVP ä¸­çš„æ³¨å…¥é—®é¢˜ï¼Ÿ</h3>
<p>ä¸€ä¸ª Presenter çš„ä¸€èˆ¬æ„é€ æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="language-java">public class TestDiMvpActivityPresenter {
  public TestDiMvpActivityPresenter(TestDiView view) {}
}

public class TestDiMvpActivity extends Activity implements TestDiView {
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°Presenteræ„é€ æ—¶éœ€è¦ä¸€ä¸ªTestDiViewï¼Œè€Œè¿™ä¸ªTestDiViewå®é™…ä¸Šæ˜¯ TestDiMvpActivityï¼Œè€Œæˆ‘ä»¬æ— æ³•æ‰‹åŠ¨æ„é€  TestDiMvpActivity çš„å®ä¾‹ï¼Œåªèƒ½ç­‰ç³»ç»Ÿåˆ›å»ºä¹‹åæ‰èƒ½è·å–å®ä¾‹ï¼Œç„¶åè¿›è¡Œæ³¨å…¥ï¼Œæ‰€ä»¥<strong>ä¸€èˆ¬MVPçš„æ³¨å…¥å†™æ³•å¦‚ä¸‹</strong>ï¼š</p>
<h4 id="mvp-æ³¨å…¥çš„ä¸€èˆ¬å†™æ³•">MVP æ³¨å…¥çš„ä¸€èˆ¬å†™æ³•</h4>
<ol>
<li><strong>å®šä¹‰å­ç»„ä»¶åŠæ¨¡å—</strong></li>
</ol>
<pre><code class="language-java">// ä¿®æ”¹ç‚¹1âƒ£ï¸    
@Module(
          subcomponents = TestDiMvpActivityModule.MvpComponent.class
    )
    public interface TestDiMvpActivityModule {
  
      @Module
      class MvpModule {
          TestDiMvpActivityPresenter.TestDiView testDiView;
  
          public MvpModule(TestDiMvpActivityPresenter.TestDiView testDiView) {
              this.testDiView = testDiView;
          }
  
          @Provides
          public TestDiMvpActivityPresenter.TestDiView providerView() {
              return testDiView;
          }
      }
  
      @Subcomponent(modules = MvpModule.class)
      interface MvpComponent {
  
          void inject(TestDiMvpActivity activity);
  
          @Subcomponent.Builder
          interface Builder {
              MvpComponent build();
  
              Builder module(MvpModule mvpModule);
          }
      }
    }
</code></pre>
<ol start="2">
<li><strong>åœ¨ RootComponent ä¸­æ³¨å†Œæ¨¡å—å¹¶æä¾›Builderè·å–å‡½æ•°</strong></li>
</ol>
<pre><code class="language-java">   @Singleton
   @Component(
           modules = {
             			 //  ä¿®æ”¹ç‚¹2âƒ£ï¸
                   TestDiMvpActivityModule.class,
           }
   )
   public interface SdkComponent {
	     // ä¿®æ”¹ç‚¹3âƒ£ï¸
       TestDiMvpActivityModule.MvpComponent.Builder testDiMvpActivityMComponentBuilder();
   
       @Component.Builder
       interface Builder {
       }
   }
</code></pre>
<ol start="3">
<li><strong>ä½¿ç”¨æ—¶åœ¨ TestDiMvpActivity.onCreate</strong> ä¸­</li>
</ol>
<pre><code class="language-java">   public class TestDiMvpActivity extends Activity implements TestDiMvpActivityPresenter.TestDiView {
   
       @Override
       protected void onCreate(@Nullable  Bundle savedInstanceState) {
          // ä¿®æ”¹ç‚¹4âƒ£ï¸
   				SdkInjector.getSdkComponent().testDiMvpActivityMComponentBuilder()
                   .module(new TestDiMvpActivityModule.MvpModule(this)).build()
                   .inject(this);
          super.onCreate(savedInstanceState);
       }
   }
</code></pre>
<p><span style="color:green"><strong>å…¶å®ç°åŸç†åœ¨äºï¼š</strong></span></p>
<p><span style="color:green">1. åœ¨Activityè¢«ç³»ç»Ÿåˆå§‹åŒ–ä¹‹åï¼Œåœ¨å…¶onCreateä¸­è·å–å…¶å®ä¾‹Â </span></p>
<p><span style="color:green">2. å°†Activityå®ä¾‹ä¼ å…¥åˆ°MvpModuleä¸­ï¼Œç„¶åç”±MvpModuleä¸­çš„ providers æ–¹æ³•æ¥æä¾› View å±‚å¯¹è±¡Â </span></p>
<p><span style="color:green">3. å°† MvpModuleä½œä¸ºå‚æ•°æ„é€ MvpComponentï¼Œç„¶åä½¿ç”¨MvpComponent çš„inject æ–¹æ³•å¯¹TestDiMvpActivity æ‰§è¡Œæ³¨å…¥åŠ¨ä½œã€‚</span></p>
<h4 id="mvp-æ³¨å…¥ä¸€èˆ¬å†™æ³•çš„é—®é¢˜">MVP æ³¨å…¥ä¸€èˆ¬å†™æ³•çš„é—®é¢˜</h4>
<p><span style="color:red;"><strong>è¿™é‡Œçš„çš„é—®é¢˜åœ¨äºï¼š</strong></span></p>
<p><span style="color:red;">1. æ¯æ·»åŠ ä¸€ä¸ªMvpçš„ç»„ä»¶ï¼Œéƒ½ä¿®æ”¹å››ä¸ªåœ°æ–¹ï¼Œæ·»åŠ èµ·æ¥éå¸¸éº»çƒ¦ï¼Œå®¹æ˜“æ¼æ‰ï¼›Â </span></p>
<p><span style="color:red;">2. æ¯æ¬¡æ·»åŠ ç»„ä»¶éƒ½éƒ½éœ€è¦ä¿®æ”¹é¡¶å±‚çš„ Root Componentï¼ˆç¤ºä¾‹ä»£ç ä¸­çš„SdkComponentï¼‰ï¼› </span></p>
<p><span style="color:red;">3. éœ€è¦åœ¨æ¯ä¸ªå…·ä½“Mvpç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¦‚MvpActiviyçš„onCreateï¼‰ä¸­æ·»åŠ æ³¨å…¥ä»£ç ï¼Œå¯¼è‡´å…·ä½“çš„å®ç°çŸ¥é“äº†æ³¨å…¥ç»†èŠ‚ï¼› </span></p>
<h3 id="è§£å†³æ–¹æ¡ˆ-2">è§£å†³æ–¹æ¡ˆ</h3>
<p>ä¸Šé¢æåˆ°çš„é—®é¢˜å°±æ˜¯æ–°å¢ä¸€ä¸ªæ”¯æŒæ³¨å…¥çš„MVPç»„ä»¶å¤ªéº»çƒ¦ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ä¸€ç§ä¿®æ”¹ç‚¹å°‘çš„æ–¹æ¡ˆï¼Œè€Œä¸”å¯¹äºç»„ä»¶æ— æ„Ÿçš„æ–¹æ¡ˆã€‚å°±åƒ dagger-android ä¸€æ ·ã€‚</p>
<p><strong>ç°åœ¨æˆ‘ä»¬å…ˆç»™å‡ºæ–¹æ¡ˆï¼Œä»¥ä¾¿èƒ½å¤Ÿå¿«é€Ÿçš„æŸ¥çœ‹è§£å†³æ–¹æ¡ˆçš„å…¨è²Œæ•ˆæœï¼Œç„¶åå†è¯´æ˜å…¶ä¸­çš„å…³é”®ç»†èŠ‚</strong>ã€‚</p>
<p>æ•´ä½“æ–¹æ¡ˆç”±å¦‚ä¸‹ä¸»è¦æµç¨‹ï¼š</p>
<h4 id="æä¾›ç»Ÿä¸€çš„mvpæ¨¡å—åŠç»„ä»¶å£°æ˜">æä¾›ç»Ÿä¸€çš„Mvpæ¨¡å—åŠç»„ä»¶å£°æ˜</h4>
<p>æˆ‘ä»¬å¸Œæœ›æœ€ç»ˆå¢åŠ ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œåªä¿®æ”¹ä¸€ä¸ªåœ°æ–¹ï¼Œä¸ç”¨ä¿®æ”¹ Dagger çˆ¶ç»„ä»¶ï¼Œæ•…æˆ‘ä»¬ç”¨ä¸€ä¸ªç»Ÿä¸€çš„MvpModuleæ¥å®šä¹‰ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªéœ€è¦æ”¯æŒMvpçš„ç»„ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªä¸ºActivityï¼Œä¸€ä¸ªä¸ºFragmentã€‚å¢åŠ ä¸€ä¸ªMvp çš„Activityæˆ–è€…Fragmentæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨MvpProviderä¸­æ·»åŠ ä¸¤ä¸ªæ–¹æ³•å³å¯ï¼Œä¸€ä¸ª<code>@Provider</code>æ ‡è®°ï¼Œå¦å¤–ä¸€ä¸ª <code>@ContributesAndroidInjector</code> æ ‡è®°</p>
<p>æ³¨æ„å…¶ä¸­ç”¨åˆ°äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªAndroidProvider çš„ç±»ï¼Œåé¢æˆ‘ä»¬ä¼šè¯´æ˜æ­¤ç±»çš„ä½œç”¨ï¼š</p>
<pre><code class="language-java">@Module(subcomponents = {
        MvpModule.MvpComponent.class,
})
public interface MvpModule {
    @Module
    abstract class MvpProvider {

        @MvpScope
        @Provides
        static TestDiMvpActivityPresenter.TestDiView bindTestDiView(@Nullable AndroidProvider&lt;Activity&gt; activityProvider) {
            if (activityProvider != null) {
                return (TestDiMvpActivityPresenter.TestDiView) activityProvider.get();
            } else {
                throw new NullPointerException(&quot;Please provider activity provider when build component!&quot;);
            }
        }

        @ContributesAndroidInjector
        abstract TestDiMvpActivity contributeTestDiMvpActivity();

        @MvpScope
        @Provides
        static TestDiMvpFragmentPresenter.View bindTestTestDiMvpFragmentView(@Nullable AndroidProvider&lt;Fragment&gt; fragmentAndroidProvider) {
            // May delete null check to keep code clean since we provide Fragment correctly
//            if (fragmentAndroidProvider != null) {
            return (TestDiMvpFragmentPresenter.View) fragmentAndroidProvider.get();
//            } else {
//                throw new NullPointerException(&quot;Please provider Fragment provider when build component!&quot;);
//            }
        }

        /**
         * æä¾› TestDiMvpFragment çš„æ³¨å…¥æ¥å£
         *
         * @return TestDiMvpFragment
         */
        @ContributesAndroidInjector
        abstract TestDiMvpFragment contributeTestDiMvpFragment();

    }


    @MvpScope
    @Subcomponent(modules = {
            AndroidInjectionModule.class,
            MvpProvider.class,
    })
    interface MvpComponent {

        MvpContainer inject(MvpContainer mvpContainer);

        @Subcomponent.Builder
        interface Builder {
            @BindsInstance
            Builder activityProvider(@Nullable AndroidProvider&lt;Activity&gt; activityProvider);

            @BindsInstance
            Builder fragmentProvider(@Nullable AndroidProvider&lt;Fragment&gt; fragmentProvider);

            MvpComponent build();
        }
    }

}

/**
 * Android ç»„ä»¶æä¾›ç­‰ï¼Œä¸»è¦ç”¨äºå»¶è¿Ÿæä¾›
 * @param &lt;T&gt; ç»„ä»¶ç±»å‹ï¼ˆActivityï¼ŒFragmentï¼‰ç­‰
 */
public class AndroidProvider&lt;T&gt; implements Provider&lt;T&gt; {

    private final T item;

    public AndroidProvider(T item) {
        this.item = item;
    }

    @Override
    public T get() {
        return item;
    }

}
</code></pre>
<h4 id="æ³¨å†Œåˆ°-root-component">æ³¨å†Œåˆ° Root Component</h4>
<p>æˆ‘ä»¬åªéœ€è¦è¿™ä¹ˆæ³¨å†Œä¸€æ¬¡å³å¯ï¼Œåç»­æ·»åŠ ç»„ä»¶æ—¶æ— éœ€å†ä¿®æ”¹ã€‚</p>
<pre><code class="language-java">@Singleton
@Component(
        modules = {
          			// ...
                // MVP ç»„ä»¶
                MvpModule.class
        }
)
public interface SdkComponent {

    // ...
    MvpModule.MvpComponent.Builder mvpComponentBuilder();

    @Component.Builder
    interface Builder {
			// ...
    }

}
</code></pre>
<h4 id="æ³¨å…¥è¿‡ç¨‹å°è£…éšè—">æ³¨å…¥è¿‡ç¨‹å°è£…éšè—</h4>
<p>åœ¨ä¹‹å‰æè¿°çš„ä¸€èˆ¬çš„MVP Activity çš„æ³¨å…¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ˜¯åœ¨æ¯ä¸ªå…·ä½“çš„MvpActivityä¸­çš„onCreate æ–¹æ³•ä¸­è¿›è¡Œæ³¨å†Œçš„ï¼Œç°åœ¨æˆ‘ä»¬å°†æ³¨å…¥çš„æµç¨‹éšè—èµ·æ¥ï¼Œæ”¾ç½®åˆ° ActivityLifeCycleCallbacks ä¸­ã€‚</p>
<pre><code class="language-java">public class SdkInjector {

    private static final String TAG = &quot;SdkInjector&quot;;

    private static SdkContainer sSdkContainer;

    public static SdkComponent getSdkComponent() {
        return sSdkContainer.getSdkComponent();
    }

    public static SdkContainer getSdkContainer() {
        return sSdkContainer;
    }

    /**
     * åˆå§‹åŒ– DI
     *
     * @param application Application
     */
    public static void init(Application application) {
        if (sSdkContainer != null) {
            return;
        }
        SdkComponent sSdkComponent = DaggerSdkComponent.builder()
                .application(application)
                .build();
        SdkInjector.sSdkContainer = new SdkContainer(sSdkComponent);
        sSdkComponent.inject(sSdkContainer);
        sSdkContainer.testInject();
        application.registerActivityLifecycleCallbacks(new BasicActivityLifeCycleCallbacks() {
            @Override
            public void onActivityPreCreated(@NonNull Activity activity, @Nullable Bundle savedInstanceState) {
                injectActivity(activity, savedInstanceState);
                super.onActivityPreCreated(activity, savedInstanceState);
            }
        });
    }

    private static void injectActivity(@NotNull Activity activity, @Nullable Bundle savedInstanceState) {
        if (activity instanceof MvpInjectable) {
            // MVP çš„ Activity æ³¨å…¥
            MvpModule.MvpComponent mvpActivityComponent = SdkInjector.getSdkComponent()
                    .mvpComponentBuilder().activityProvider(new AndroidProvider&lt;&gt;(activity)).build();
            MvpContainer mvpContainer = new MvpContainer(mvpActivityComponent);
            mvpActivityComponent.inject(mvpContainer);
            SdkAndroidInjection.inject(activity, mvpContainer);
        } else if (activity instanceof Injectable) {
            SdkAndroidInjection.inject(activity);
        } else {
            Log.w(TAG, &quot;Warning! You Activity &quot; + activity.getClass().getSimpleName() + &quot;is not injectable! &quot;);
        }
        if (activity instanceof FragmentActivity) {
            final FragmentManager.FragmentLifecycleCallbacks lifecycleCallbacks = new FragmentManager.FragmentLifecycleCallbacks() {
                @Override
                public void onFragmentAttached(@NonNull @NotNull FragmentManager fm, @NonNull @NotNull Fragment f, @NonNull @NotNull Context context) {
                    super.onFragmentAttached(fm, f, context);
                    injectFragment(f, activity);
                }
            };
            ((FragmentActivity) activity).getSupportFragmentManager()
                    .registerFragmentLifecycleCallbacks(lifecycleCallbacks, true);
        }
    }

    private static void injectFragment(@NotNull Fragment f, @NotNull Activity activity) {
        if (f instanceof Injectable) {
            SdkAndroidInjection.inject(f);
        } else if (f instanceof MvpInjectable) {
            // MVP çš„ Fragment æ³¨å…¥
            MvpModule.MvpComponent mvpComponent = SdkInjector.getSdkComponent()
                    .mvpComponentBuilder()
                    .activityProvider(new AndroidProvider&lt;&gt;(activity))
                    .fragmentProvider(new AndroidProvider&lt;&gt;(f))
                    .build();
            MvpContainer mvpContainer = mvpComponent.inject(new MvpContainer(mvpComponent));
            SdkAndroidInjection.inject(f, mvpContainer);
        } else {
            Log.w(TAG, &quot;Warning! You fragment  &quot; + f.getClass().getSimpleName() + &quot; is not injectable!&quot;);
        }
    }
}
</code></pre>
<h3 id="è§£å†³æ–¹æ¡ˆå…³é”®ç‚¹è¯´æ˜">è§£å†³æ–¹æ¡ˆå…³é”®ç‚¹è¯´æ˜</h3>
<p>æˆ‘ä»¬è€ƒè™‘ä¸‹æ™®é€šçš„MVPæ³¨å…¥è¿‡ç¨‹ä¸­ä¸ºä»€ä¹ˆéœ€è¦å¦‚æ­¤å¤šçš„æ¨¡æ¿ä»£ç ã€‚</p>
<ol>
<li>
<p>ç”±äºPå±‚ä¾èµ–Vï¼Œè€Œ V å±‚æ˜¯Activityï¼Œæ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªèƒ½åœ¨onCreate å›è°ƒä¸­è·å–åˆ°Activityï¼Œç„¶åå°†å…¶å¡åˆ°Daggerçš„ä¾èµ–å¯¹è±¡çš„å›¾è°±ä¸­ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ä»£ç æ‰€åšçš„</p>
<p>å³ï¼Œå¿…é¡»æ<strong>ä¾›ä¸€ä¸ªModuleæ¥æ¥æ”¶Activity</strong>å°†å…¶æ”¾å…¥åˆ°Daggerå¯¹è±¡Graphä¸­ï¼ŒåŒæ—¶ä¹Ÿå¿…é¡»åœ¨onCreateä¸­ä½ æ‰èƒ½è·å–åˆ°Activityã€‚</p>
<pre><code class="language-java">			@Module
      class MvpModule {
          TestDiMvpActivityPresenter.TestDiView testDiView;
  
          public MvpModule(TestDiMvpActivityPresenter.TestDiView testDiView) {
              this.testDiView = testDiView;
          }
  
          @Provides
          public TestDiMvpActivityPresenter.TestDiView providerView() {
              return testDiView;
          }
      }


@Override
protected void onCreate(@Nullable  Bundle savedInstanceState) {
			SdkInjector.getSdkComponent().testDiMvpActivityMComponentBuilder()
        						// å°†Activityå¡è¿›ä¾èµ–Graph
                   .module(new TestDiMvpActivityModule.MvpModule(this)).build()
                   .inject(this);
}
</code></pre>
</li>
<li>
<p>å¯¹äºæ— æ³•è‡ªåŠ¨æ³¨å…¥çš„å¯¹è±¡ï¼Œå¿…é¡»è¦é€šè¿‡ Component æä¾›ä¸€ä¸ª <strong>inject æ–¹æ³•</strong>ï¼Œç„¶åè°ƒç”¨injectæ–¹æ³•å®Œæˆå¯¹å…¶çš„æ‰‹åŠ¨æ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢onCreateæ–¹æ³•ä¸­æ‰€å†™çš„éƒ¨åˆ†ã€‚</p>
</li>
</ol>
<h4 id="æ³¨å…¥é€»è¾‘ç§»åŠ¨åˆ°activitylifecyclecallbackå›è°ƒåŠé‡åˆ°çš„é—®é¢˜">æ³¨å…¥é€»è¾‘ç§»åŠ¨åˆ°ActivityLifecycleCallbackå›è°ƒåŠé‡åˆ°çš„é—®é¢˜</h4>
<p>å®é™…ä¸Šï¼Œé€šè¿‡å‘Applicationæ³¨å†ŒActivityLifecycleCallbackå›è°ƒï¼Œæˆ‘ä»¬å¯ä»¥å°†å…·ä½“MvpActivityä¸­çš„onCreateé‡Œçš„æ³¨å…¥ä»£ç éšè—èµ·æ¥ï¼Œæˆ‘ä»¬åœ¨ä»”ç»†ç ”ç©¶ä¸‹onCreate ä¸­çš„æ³¨å…¥é€»è¾‘ï¼Œè€ƒè™‘å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜ï¼š</p>
<pre><code class="language-java">@Override
protected void onCreate(@Nullable  Bundle savedInstanceState) {
			SdkInjector.getSdkComponent()
        .testDiMvpActivityMComponentBuilder()
        // å°†Activityå¡è¿›ä¾èµ–Graph
        // 1âƒ£ï¸  å¡å…¥
        .module(new TestDiMvpActivityModule.MvpModule(this)).build()
        // 2âƒ£ï¸  æ³¨å…¥
        .inject(this);
}
</code></pre>
<p>è€ƒè™‘å¦‚ä¸‹ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<ol>
<li>å¡å…¥ï¼šåœ¨æ„é€ TestDiMvpActivityModule.MvpModuleæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä¼ å…¥ä¸€ä¸ªå…·ä½“ç±»å‹ï¼ˆTestDiMvpActivityï¼‰ï¼Œè€Œå¦‚æœæˆ‘ä»¬ç§»åŠ¨åˆ°ActivityLifecycleCallbackä¸­ä¹‹åï¼Œè¿™ä¸ªå…·ä½“çš„ç±»å‹ä¿¡æ¯ä¼šä¸¢å¤±ï¼›</li>
<li>æ³¨å…¥ï¼šåœ¨injectæ—¶ï¼Œæˆ‘ä»¬çš„Componentä¸­å®šä¹‰çš„æ–¹æ³•ä¹Ÿæ˜¯éœ€è¦å…·ä½“ç±»å‹ä¿¡æ¯ï¼ˆTestDiMvpActivityï¼‰çš„ï¼Œå› ä¸ºè¿™æ ·Daggeræ‰èƒ½æ ¹æ®å…·ä½“ç±»å‹è·å–å…¶ä¾èµ–å“ªäº›ä¿¡æ¯ï¼Œç”Ÿæˆæ­£ç¡®çš„æ³¨å…¥ä»£ç ï¼Œè€Œç§»åŠ¨åˆ° ActivityLifecycleCallback ä¸­ä¹‹åï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿä¼šä¸¢å¤±ï¼›</li>
</ol>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œç§»åŠ¨åˆ° ActivityLifecycleCallbackä¸­ä¹‹åï¼Œå…·ä½“çš„ç±»å‹ä¿¡æ¯ä¸¢å¤±äº†ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•æ­£ç¡®çš„è°ƒç”¨å¡å…¥æ–¹æ³•å’Œæ³¨å…¥æ–¹æ³•ã€‚</p>
<h4 id="ä½¿ç”¨-dagger-android-ç”Ÿæˆ-inject-æ¨¡æ¿ä»£ç ">ä½¿ç”¨ Dagger-Android ç”Ÿæˆ inject æ¨¡æ¿ä»£ç </h4>
<p>å¯¹äºinjectæ–¹æ³•æ¥è¯´ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥ä½¿ç”¨ Dagger-Android çš„ <code>@ContributesAndroidInjector</code> æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³ï¼›</p>
<h4 id="ä½¿ç”¨åŒ…è£…ç±»å‹é¿å…daggerç±»å‹æ£€æŸ¥ä½¿ç”¨provideræ–¹æ³•è¿˜åŸç±»å‹ä¿¡æ¯">ä½¿ç”¨åŒ…è£…ç±»å‹é¿å…Daggerç±»å‹æ£€æŸ¥ï¼Œä½¿ç”¨provideræ–¹æ³•è¿˜åŸç±»å‹ä¿¡æ¯</h4>
<p>åœ¨å¡å…¥çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºä¸¢å¤±äº†Activityçš„å…·ä½“ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†æ— æ³•é€šè¿‡ç±»å‹æ£€æŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º AndroidProvider çš„åŒ…è£…ç±»å‹ï¼Œæˆ‘ä»¬åœ¨æ„é€ ç»„ä»¶æ—¶ï¼ŒåŸå…ˆéœ€è¦TestDiMvpActivityè¿™ä¸ªå…·ä½“ç±»å‹ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¼ å…¥æˆ‘ä»¬çš„åŒ…è£…ç±»å‹ï¼Œå¯ä»¥åšåˆ°ä»£ç ç»Ÿä¸€ã€‚</p>
<pre><code class="language-java">// MVP çš„ Activity æ³¨å…¥
            MvpModule.MvpComponent mvpActivityComponent = SdkInjector.getSdkComponent()
              // TestDiMvpActivity -&gt;  new AndroidProvider&lt;Activity&gt;(activity)
                    .mvpComponentBuilder().activityProvider(new AndroidProvider&lt;&gt;(activity)).build();
            MvpContainer mvpContainer = new MvpContainer(mvpActivityComponent);
            mvpActivityComponent.inject(mvpContainer);
            SdkAndroidInjection.inject(activity, mvpContainer);
</code></pre>
<p>é‚£ä¹ˆæˆ‘ä»¬ä½•æ—¶å°†å…¶è¿˜åŸå‘¢ï¼Ÿ</p>
<p>åœ¨æä¾›å¯¹åº”TestDiViewæ—¶ï¼Œæˆ‘ä»¬ç›´æ¥å¯¹å…¶è¿›è¡Œå¼ºåˆ¶è½¬æ¢ï¼Œç„¶åæä¾›ä¸º TestDiView ç±»å‹</p>
<pre><code class="language-java"> @Module
    abstract class MvpProvider {
        @Provides
        static TestDiMvpActivityPresenter.TestDiView bindTestDiView(@Nullable AndroidProvider&lt;Activity&gt; activityProvider) {
            if (activityProvider != null) {
                return (TestDiMvpActivityPresenter.TestDiView) activityProvider.get();
            } else {
                throw new NullPointerException(&quot;Please provider activity provider when build component!&quot;);
            }
        }
}
</code></pre>
<h2 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h2>
<p>å…·ä½“å®æ–½è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€äº›ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒGithubä¸­å¯¹åº”ç¤ºä¾‹æ¨¡å—çš„æºç ã€‚</p>
<ul>
<li><a href="https://github.com/hanlyjiang/android-libraries/tree/master/lib_di_sample">android-libraries/lib_di_sample at master Â· hanlyjiang/android-libraries (github.com)</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨Kotlinç¼–å†™gradleè„šæœ¬]]></title>
        <id>https://hanlyjiang.github.io/post/shi-yong-kotlin-bian-xie-gradle-jiao-ben/</id>
        <link href="https://hanlyjiang.github.io/post/shi-yong-kotlin-bian-xie-gradle-jiao-ben/">
        </link>
        <updated>2022-02-24T14:29:04.000Z</updated>
        <summary type="html"><![CDATA[<p>å°†gradle è„šæœ¬ä» groovy è¿ç§»åˆ° kotlin dslã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>å°†gradle è„šæœ¬ä» groovy è¿ç§»åˆ° kotlin dslã€‚</p>
<!-- more -->
<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<h3 id="ide-æ”¯æŒ">IDE æ”¯æŒ</h3>
<table>
<thead>
<tr>
<th style="text-align:right"></th>
<th style="text-align:center">Build import</th>
<th style="text-align:center">Syntax highlighting <sub>1</sub></th>
<th style="text-align:center">Semantic editor <sub>2</sub></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">IntelliJ IDEA</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
</tr>
<tr>
<td style="text-align:right">Android Studio</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
</tr>
<tr>
<td style="text-align:right">Eclipse IDE</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center">âœ–</td>
</tr>
<tr>
<td style="text-align:right">CLion</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center">âœ–</td>
</tr>
<tr>
<td style="text-align:right">Apache NetBeans</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center">âœ–</td>
</tr>
<tr>
<td style="text-align:right">Visual Studio Code (LSP)</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center">âœ–</td>
</tr>
<tr>
<td style="text-align:right">Visual Studio</td>
<td style="text-align:center"><strong>âœ“</strong></td>
<td style="text-align:center">âœ–</td>
<td style="text-align:center">âœ–</td>
</tr>
</tbody>
</table>
<ol>
<li>Gradle Kotlin DSL scripts ä¸­çš„Kotlinè¯­æ³•é«˜äº®</li>
<li>Gradle Kotlin DSL scripts ä¸­æ”¯æŒä»£ç è¡¥å…¨ï¼Œå¯¼èˆªåˆ°æºç ï¼Œæ–‡æ¡£æŸ¥çœ‹ï¼Œé‡æ„ç­‰ç­‰ï¼›</li>
</ol>
<h3 id="kotlin-dsl-è„šæœ¬å‘½å">Kotlin DSL è„šæœ¬å‘½å</h3>
<h4 id="å‘½å">å‘½å</h4>
<p>Groovy DSL script æ–‡ä»¶ä½¿ç”¨ <code>.gradle</code> æ‰©å±•æ–‡ä»¶å</p>
<p>Kotlin DSL script æ–‡ä»¶ä½¿ç”¨ <code>.gradle.kts</code> æ‰©å±•æ–‡ä»¶å</p>
<h4 id="æ¿€æ´»å¹¶ä½¿ç”¨-kotlin-dsl">æ¿€æ´»å¹¶ä½¿ç”¨ kotlin dsl</h4>
<ul>
<li>å°†è„šæœ¬æ–‡ä»¶å‘½åä¸º <code>.gradle.kts</code> å³å¯æ¿€æ´»ã€‚ä¹Ÿé€‚ç”¨äº <a href="https://docs.gradle.org/current/userguide/build_lifecycle.html#sec:settings_file">settings file</a>ï¼ˆ <code>settings.gradle.kts</code>)å’Œ <a href="https://docs.gradle.org/current/userguide/init_scripts.html#init_scripts">initialization scripts</a>.</li>
<li>ä¸ºäº†å¾—åˆ°æ›´å¥½çš„IDEæ”¯æŒï¼Œå»ºè®®ä½¿ç”¨å¦‚ä¸‹å‘½åçº¦å®šï¼š
<ul>
<li>Settingsè„šæœ¬å‘½åä¸º <code>*.settings.gradle.kts</code>ï¼ˆåŒ…æ‹¬æ‰€æœ‰ä»settingsè„šæœ¬ä¸­å¼•å…¥çš„è„šæœ¬ï¼‰</li>
<li><a href="https://docs.gradle.org/current/userguide/init_scripts.html#init_scripts">initialization scripts</a> æŒ‰ <code>*.init.gradle.kts</code>çš„å‘½åæ¨¡å¼å‘½åï¼Œæˆ–è€…ç®€å•çš„å–åä¸º <code>init.gradle.kts</code>ã€‚</li>
</ul>
</li>
<li>kotlin DSL æ„å»ºè„šæœ¬éšå¼çš„å¯¼å…¥äº†å¦‚ä¸‹å†…å®¹ï¼š
<ul>
<li><a href="https://docs.gradle.org/current/userguide/writing_build_scripts.html#script-default-imports">default Gradle API imports</a></li>
<li>åœ¨<code>org.gradle.kotlin.dsl</code> å’Œ <code>org.gradle.kotlin.dsl.plugins.dsl</code> åŒ…ä¸­çš„Kotlin DSL API</li>
</ul>
</li>
</ul>
<h3 id="kotlinä¸­è¯»å–è¿è¡Œæ—¶å±æ€§">kotlinä¸­è¯»å–è¿è¡Œæ—¶å±æ€§</h3>
<blockquote>
<p><a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html#kotdsl:properties">Gradle Kotlin DSL Primer</a></p>
</blockquote>
<p>gradle æ‹¥æœ‰ä¸¤ç§è¿è¡Œæ—¶å±æ€§:</p>
<ol>
<li><a href="https://docs.gradle.org/current/userguide/build_environment.html#sec:project_properties"><em>project properties</em></a></li>
<li><a href="https://docs.gradle.org/current/userguide/writing_build_scripts.html#sec:extra_properties"><em>extra properties</em></a></li>
</ol>
<h4 id="é¡¹ç›®å±æ€§">é¡¹ç›®å±æ€§</h4>
<p>å¯ä»¥é€šè¿‡kotlinçš„ä»£ç†å±æ€§æ¥è®¿é—®:</p>
<p><strong>build.gradle.kts</strong></p>
<pre><code class="language-kotlin">// å±æ€§å¿…é¡»å­˜åœ¨
val myProperty: String by project  
// å±æ€§å¯ä»¥ä¸å­˜åœ¨
val myNullableProperty: String? by project 
</code></pre>
<h4 id="extra-å±æ€§">extra å±æ€§</h4>
<p>extraå±æ€§åœ¨ä»»æ„å®ç°äº†<a href="https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtensionAware.html#org.gradle.api.plugins.ExtensionAware">ExtensionAware</a> æ¥å£çš„å¯¹è±¡ä¸Šéƒ½å¯ä»¥è®¿é—®;</p>
<p><strong>build.gradle.kts</strong></p>
<pre><code class="language-kotlin">val myNewProperty by extra(&quot;initial value&quot;)   // â¶
val myOtherNewProperty by extra { &quot;calculated initial value&quot; }   //â· 

val myProperty: String by extra   // â¸
val myNullableProperty: String? by extra   // â¹
</code></pre>
<p>â¶ åœ¨å½“å‰ä¸Šä¸‹æ–‡(å½“å‰ä¸ºprojectä¸­)åˆ›å»ºä¸€ä¸ªåä¸º<code>myNewProperty</code>æ–°çš„extraå±æ€§,å¹¶ä¸”åˆå§‹åŒ–å…¶å€¼ä¸º &quot;initial value&quot;</p>
<p>â· åŒ â¶ ï¼Œä¸è¿‡å±æ€§çš„åˆå§‹å€¼æ˜¯é€šè¿‡lamdbaè¡¨è¾¾å¼æ¥è®¡ç®—çš„;</p>
<p>â¸ ç»‘å®šå½“å‰ä¸Šä¸‹æ–‡(å½“å‰ä¸ºproject)ä¸­çš„å±æ€§åˆ°myPropertyå±æ€§ä¸­;</p>
<p>â¹ åŒ â¸ ï¼Œä¸è¿‡å…è®¸å€¼ä¸ºnullï¼›</p>
<h4 id="åœ¨å­é¡¹ç›®ä¸­è®¿é—®rootprojectçš„å±æ€§">åœ¨å­é¡¹ç›®ä¸­è®¿é—®rootProjectçš„å±æ€§</h4>
<pre><code class="language-kotlin">val myNewProperty: String by rootProject.extra
</code></pre>
<blockquote>
<p><code>by</code>æ˜¯kotlinçš„å…³é”®å­—ï¼Œè¡¨ç¤º provided by ï¼Œå³å±æ€§ç”±æŸä¸ªå…¶ä»–çš„å¯¹è±¡ä»£ç†</p>
</blockquote>
<h4 id="åœ¨ä»»åŠ¡ä¸­å®šä¹‰å’Œä½¿ç”¨å±æ€§">åœ¨ä»»åŠ¡ä¸­å®šä¹‰å’Œä½¿ç”¨å±æ€§</h4>
<p>ä»»åŠ¡ä¹Ÿç»§æ‰¿äº†ExtensionAwareï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨extraå±æ€§</p>
<pre><code class="language-kotlin">tasks {
    test {
        val reportType by extra(&quot;dev&quot;)  
        doLast {
            // Use 'suffix' for post processing of reports
        }
    }

    register&lt;Zip&gt;(&quot;archiveTestReports&quot;) {
        val reportType: String by test.get().extra  
        archiveAppendix.set(reportType)
        from(test.get().reports.html.destination)
    }
}
</code></pre>
<h4 id="é€šè¿‡mapæ ¼å¼å®šä¹‰å’Œè®¿é—®extraå±æ€§">é€šè¿‡mapæ ¼å¼å®šä¹‰å’Œè®¿é—®extraå±æ€§</h4>
<pre><code class="language-kotlin">extra[&quot;myNewProperty&quot;] = &quot;initial value&quot;   // â¶

tasks.create(&quot;myTask&quot;) {
    doLast {
        println(&quot;Property: ${project.extra[&quot;myNewProperty&quot;]}&quot;)  // â· 
    }
}
</code></pre>
<h2 id="è¿ç§»gradleæ„å»ºé€»è¾‘åˆ°kotlin">è¿ç§»gradleæ„å»ºé€»è¾‘åˆ°Kotlin</h2>
<blockquote>
<p>å‚è€ƒæ–‡æ¡£ï¼š</p>
<ol>
<li><a href="https://docs.gradle.org/current/userguide/migrating_from_groovy_to_kotlin_dsl.html">Migrating build logic from Groovy to Kotlin (gradle.org)</a></li>
<li><a href="https://www.cnblogs.com/mengdd/p/android-gradle-migrate-from-groovy-to-kotlin.html">Android Gradleè„šæœ¬ä»Groovyè¿ç§»åˆ°Kotlin DSL - åœ£éª‘å£«wind - åšå®¢å›­ (cnblogs.com)</a></li>
</ol>
</blockquote>
<h3 id="å‡†å¤‡groovyè„šæœ¬">å‡†å¤‡groovyè„šæœ¬</h3>
<ol>
<li>å¼•å·ç»Ÿä¸€ä¸ºåŒå¼•å·</li>
<li>æ–¹æ³•è°ƒç”¨åŠ ä¸Šæ‹¬å·</li>
<li>èµ‹å€¼æ“ä½œåŠ ä¸Šç­‰å·</li>
</ol>
<h4 id="å¼•å·ç»Ÿä¸€">å¼•å·ç»Ÿä¸€</h4>
<ul>
<li>
<p>é€šè¿‡<mark>âŒ˜â‡§R</mark>å¿«æ·é”®è°ƒå‡ºæŸ¥æ‰¾æ›¿æ¢å·¥å…·çª—ï¼Œå°†æ–‡ä»¶åŒ¹é…è®¾ç½®ä¸º <code>.gradle</code> ï¼Œç„¶åå°†æ‰€æœ‰å•å¼•å·æ›¿æ¢ä¸ºåŒå¼•å·ã€‚</p>
</li>
<li>
<p>å®Œæˆä¹‹åé‡æ–°ä½¿ç”¨gradleæ–‡ä»¶åŒæ­¥é¡¹ç›®ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯</p>
</li>
</ul>
<h4 id="èµ‹å€¼å’Œå±æ€§ä¿®æ”¹">èµ‹å€¼å’Œå±æ€§ä¿®æ”¹</h4>
<ul>
<li>å°†æ‰€æœ‰çš„èµ‹å€¼æ“ä½œæ·»åŠ ä¸Šç­‰å·</li>
<li>æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨æ“ä½œæ·»åŠ æ‹¬å·</li>
</ul>
<p>è¿™é‡Œå°±éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´äº†ã€‚</p>
<h3 id="é‡å‘½åæ–‡ä»¶">é‡å‘½åæ–‡ä»¶</h3>
<p>å°† <code>.gradle</code>æ–‡ä»¶é‡å‘½åä¸º<code>.gradle.kts</code>ï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯ä»¥å®Œæˆé‡å‘½åæ“ä½œ</p>
<pre><code class="language-shell">find . -name &quot;*.gradle&quot; -type f | xargs -I {} mv {} {}.kts
</code></pre>
<h3 id="å…¶ä»–å¸¸è§ä¿®æ”¹">å…¶ä»–å¸¸è§ä¿®æ”¹</h3>
<h4 id="åœ¨kotlin-rootprojectè„šæœ¬ä¸­è®¿é—®-gradle-å±æ€§">åœ¨kotlin rootProjectè„šæœ¬ä¸­è®¿é—® gradle å±æ€§</h4>
<pre><code class="language-kotlin">allprojects {
    repositories {
        maven {
            name = &quot;Sonatype-Snapshots&quot;
            setUrl(&quot;https://oss.sonatype.org/content/repositories/snapshots&quot;)
            credentials(PasswordCredentials::class.java) {
                username = property(&quot;ossrhUsername&quot;).toString()
                password = property(&quot;ossrhPassword&quot;).toString()
            }
        }
        google()
        jcenter()
        mavenCentral()
    }
}
</code></pre>
<h4 id="å®šä¹‰ä»»åŠ¡">å®šä¹‰ä»»åŠ¡</h4>
<pre><code class="language-kotlin">tasks.register(&quot;clean&quot;, Delete::class.java) {
    group = &quot;build&quot;
    delete(rootProject.buildDir)
}
</code></pre>
<h2 id="è¿ç§»é…ç½®å®ä¾‹">è¿ç§»é…ç½®å®ä¾‹</h2>
<h3 id="rootproject-kotlin-dsl-buildè„šæœ¬æ¨¡æ¿">rootProject kotlin dsl buildè„šæœ¬æ¨¡æ¿</h3>
<pre><code class="language-kotlin">// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
    // å®šä¹‰extra å±æ€§
    val kotlin_version by extra(&quot;1.4.32&quot;)
    val android_gradle_build_version by extra(&quot;4.1.3&quot;)
    repositories {
        maven { setUrl(&quot;https://maven.aliyun.com/repository/gradle-plugin&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/jcenter&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/google&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/public&quot;) }
        google()
        jcenter()
        mavenCentral()
    }
    dependencies {
        classpath(&quot;com.android.tools.build:gradle:$android_gradle_build_version&quot;)
        classpath(&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;)
        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        maven { setUrl(&quot;https://maven.aliyun.com/repository/jcenter&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/google&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/gradle-plugin&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/public&quot;) }
        // åŠ å…¥é¡¹ç›®ä¸´æ—¶ä»“åº“ï¼Œæ–¹ä¾¿æµ‹è¯•
        maven {
            name = &quot;ProjectLocal-Snapshots&quot;
            setUrl(File(rootProject.rootDir, &quot;local-maven-repo${File.separator}snapshots&quot;))
        }
        maven {
            name = &quot;ProjectLocal-Release&quot;
            setUrl(File(rootProject.rootDir, &quot;local-maven-repo${File.separator}release&quot;))
        }

        // åŠ å…¥ maven snapshot ä»“åº“åŠ release ä»“åº“
        maven {
            name = &quot;Sonatype-Snapshots&quot;
            setUrl(&quot;https://oss.sonatype.org/content/repositories/snapshots&quot;)
        }
        maven {
            name = &quot;Sonatype-Staging&quot;
            setUrl(&quot;https://oss.sonatype.org/service/local/staging/deploy/maven2/&quot;)
            credentials(PasswordCredentials::class.java) {
                username = property(&quot;ossrhUsername&quot;).toString()
                password = property(&quot;ossrhPassword&quot;).toString()
            }
        }
        google()
        mavenCentral()
        jcenter()
    }
}

tasks.register(&quot;clean&quot;, Delete::class.java) {
    group = &quot;build&quot;
    delete(rootProject.buildDir)
}
</code></pre>
<h3 id="æ¨¡å—-buildgradle-æ¨¡å—buildè„šæœ¬æ¨¡æ¿">æ¨¡å— build.gradle æ¨¡å—buildè„šæœ¬æ¨¡æ¿</h3>
<pre><code class="language-kotlin">plugins {
    id(&quot;com.android.library&quot;)
    id(&quot;signing&quot;)
    // ç­‰åŒäº id(&quot;&quot;)
    `maven-publish`
    kotlin(&quot;android&quot;)
    kotlin(&quot;android.extensions&quot;)

    // å¼•å…¥ä¸‰æ–¹Gradleæ’ä»¶
    id(&quot;com.github.hanlyjiang.android_maven_pub&quot;) version (&quot;0.0.9&quot;) apply (false)
}

android {
    compileSdkVersion(30)
    buildToolsVersion(&quot;30.0.3&quot;)

    defaultConfig {
        minSdkVersion(22)
        targetSdkVersion(30)
        versionCode(1)
        versionName(&quot;1.0.0&quot;)

        testInstrumentationRunner(&quot;androidx.test.runner.AndroidJUnitRunner&quot;)
        consumerProguardFiles(&quot;consumer-rules.pro&quot;)
    }

    buildTypes {
        getByName(&quot;release&quot;) {
            minifyEnabled(false)
            proguardFiles(
                getDefaultProguardFile(&quot;proguard-android-optimize.txt&quot;),
                &quot;proguard-rules.pro&quot;
            )
        }
    }

    compileOptions {
        sourceCompatibility(JavaVersion.VERSION_1_8)
        targetCompatibility(JavaVersion.VERSION_1_8)
    }
}

dependencies {
    implementation(&quot;org.jetbrains:annotations:21.0.1&quot;)
    testImplementation(&quot;junit:junit:4.13.2&quot;)
    androidTestImplementation(&quot;androidx.test.ext:junit:1.1.3&quot;)
    androidTestImplementation(&quot;androidx.test.espresso:espresso-core:3.4.0&quot;)
    
    // StringRes æ³¨è§£
    implementation(&quot;androidx.appcompat:appcompat:1.3.1&quot;)
    // æ³¨è§£åº“ https://developer.android.com/jetpack/androidx/releases/annotation#annotation-1.2.0
    implementation(&quot;androidx.annotation:annotation:1.2.0&quot;)
}

// åˆ›å»ºè‡ªå®šä¹‰ä»»åŠ¡
tasks.create(&quot;showGitRepoInfo&quot;) {
    group = &quot;help&quot;
    doLast {
        println(&quot;${getGitBranch()}/${getGitRevision()}&quot;)
    }
}

// æ‰©å±•å‡½æ•°
fun String.execute(): String {
    val process = Runtime.getRuntime().exec(this)
    return with(process.inputStream.bufferedReader()) {
        readText()
    }
}

/**
 * Get git revision with work tree status
 *
 * @return
 */
fun getGitRevision(): String {
    val rev = &quot;git rev-parse --short HEAD&quot;.execute().trim()
    val stat = &quot;git diff --stat&quot;.execute().trim()
    return if (stat.isEmpty()) {
        rev
    } else {
        &quot;$rev-dirty&quot;
    }
}

/**
 * Get git branch name
 *
 * @return
 */
fun getGitBranch(): String {
    return &quot;git rev-parse --abbrev-ref HEAD&quot;.execute().trim()
}
</code></pre>
<h3 id="702-ç‰ˆæœ¬agpæ’ä»¶é…ç½®å®ä¾‹-æ¨¡å—buildè„šæœ¬">7.0.2 ç‰ˆæœ¬AGPæ’ä»¶é…ç½®å®ä¾‹-æ¨¡å—buildè„šæœ¬</h3>
<pre><code class="language-kotlin">plugins {
    id(&quot;com.android.application&quot;)
}

android {
    compileSdk = 31

    defaultConfig {
        applicationId = &quot;com.github.hanlyjiang.sample&quot;
        minSdk = 21
        targetSdk = 31
        versionCode = 1
        versionName = &quot;1.0&quot;

        testInstrumentationRunner = &quot;androidx.test.runner.AndroidJUnitRunner&quot;
    }

    buildTypes {
        getByName(&quot;release&quot;) {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile(&quot;proguard-android-optimize.txt&quot;),
                &quot;proguard-rules.pro&quot;
            )
        }
    }
    compileOptions {
        sourceCompatibility(JavaVersion.VERSION_1_8)
        targetCompatibility(JavaVersion.VERSION_1_8)
    }

}

dependencies {
    implementation(files(&quot;../libs/lib-mod-release.aar&quot;))

    // https://mvnrepository.com/artifact/io.reactivex.rxjava3/rxjava
    implementation(&quot;io.reactivex.rxjava3:rxjava:3.1.3&quot;)

    implementation(&quot;androidx.appcompat:appcompat:1.2.0&quot;)
    implementation(&quot;com.google.android.material:material:1.3.0&quot;)
    implementation(&quot;androidx.constraintlayout:constraintlayout:2.1.3&quot;)
    testImplementation(&quot;junit:junit:4.+&quot;)
    androidTestImplementation(&quot;androidx.test.ext:junit:1.1.2&quot;)
    androidTestImplementation(&quot;androidx.test.espresso:espresso-core:3.3.0&quot;)
}
</code></pre>
<h3 id="702-root-build-gradle-è„šæœ¬é…ç½®">7.0.2 root Build gradle è„šæœ¬é…ç½®</h3>
<pre><code class="language-kotlin">dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
        jcenter() // Warning: this repository is going to shut down soon
        flatDir {
            dir(&quot;libs&quot;)
        }
    }
}
rootProject.name = &quot;NoSuchMethodError&quot;
include ':app'
include ':lib-mod'
</code></pre>
<h2 id="é™åˆ¶ä¸è¶³">é™åˆ¶/ä¸è¶³</h2>
<p>åœ¨ kotlin dsl è„šæœ¬ä¸­å¼•å…¥å…¶ä»–ç‹¬ç«‹çš„ kotlin çš„dsl è„šæœ¬ä¸æ–¹ä¾¿ï¼Œä¼šå­˜åœ¨æ— æ³•è¯†åˆ«ç›¸å…³ä¾èµ–å¯¹è±¡çš„é—®é¢˜ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹è¿˜æ˜¯å¾—å¯¼å…¥ä½¿ç”¨ groovy ç¼–å†™çš„ gradle è„šæœ¬ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[CLionæ­å»ºArduinoå¼€å‘ç¯å¢ƒ]]></title>
        <id>https://hanlyjiang.github.io/post/clion-da-jian-arduino-kai-fa-huan-jing/</id>
        <link href="https://hanlyjiang.github.io/post/clion-da-jian-arduino-kai-fa-huan-jing/">
        </link>
        <updated>2021-12-02T06:16:46.000Z</updated>
        <summary type="html"><![CDATA[<p>è®°å½•ä¸‹ä½¿ç”¨Clioné…ç½®Arduinoå¼€å‘ç¯å¢ƒçš„è¿‡ç¨‹ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>è®°å½•ä¸‹ä½¿ç”¨Clioné…ç½®Arduinoå¼€å‘ç¯å¢ƒçš„è¿‡ç¨‹ã€‚</p>
<!-- more -->
<p>Arduino å¼€å‘çš„ç¯å¢ƒæœ‰ä¸‹é¢å‡ ç§ï¼š</p>
<ol>
<li>Arduino IDEï¼šç›®å‰æœ‰1.8.x å’Œ 2.0.0 Betaç‰ˆæœ¬ï¼›</li>
<li>VSCode + PlatformIOï¼›</li>
<li>CLion + PlatformIOï¼›</li>
</ol>
<p>ç›®å‰å·²ç»è¯•è¿‡äº†å‰é¢ä¸¤ç§ï¼Œéƒ½æ„Ÿè§‰ä¸æ˜¯å¾ˆæ»¡æ„ã€‚</p>
<ul>
<li>Arduino IDEå¯¹ä»£ç è·³è½¬çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œ2.0æ”¯æŒï¼Œ1.8ä¸æ”¯æŒï¼Œ2.0çš„é€‰æ‹©Arduinoçš„å¼€å‘æ¿è¿˜æ­£å¸¸ï¼Œä½†æ˜¯é€‰æ‹©esp32çš„æ¿å­ä¸€ç›´æ˜¾ç¤ºçº¢è‰²çš„è­¦å‘Šï¼Œæ— æ³•è·³è½¬ã€‚</li>
</ul>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021303012.png" alt="image-20211202130350932" style="zoom: 50%;" />
<ul>
<li>VSCode åˆ™æ˜¯å®åœ¨ç”¨ä¸ä¹ æƒ¯ã€‚ï¼ˆä¸»è¦æ˜¯ä¸€ç›´ç”¨AndroidStudioï¼Œæ“ä½œç†Ÿç»œäº†ï¼Œä¸æ„¿æ„å­¦ğŸ˜«ï¼‰</li>
</ul>
<p>æ‰€ä»¥å‡†å¤‡å°è¯•ä¸‹CLionã€‚æµ‹è¯•ä¹‹åï¼Œæ„Ÿè§‰åˆ°äº†ç†Ÿæ‚‰çš„å‘³é“ğŸ˜‹ã€‚</p>
<h2 id="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</h2>
<ul>
<li>macOS 12.0.1</li>
<li>CLion 2021.2.3</li>
</ul>
<h2 id="å®‰è£…-platformio">å®‰è£… PlatformIO</h2>
<h3 id="å®‰è£…clionæ’ä»¶">å®‰è£…CLionæ’ä»¶</h3>
<ul>
<li>å®‰è£…æ’ä»¶ï¼Œå®‰è£…å®Œæˆä¹‹åï¼Œé‡å¯ä¸‹CLionã€‚</li>
</ul>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021310220.png" alt="image-20211202131036194" style="zoom:50%;" />
<p>é‡å¯å®Œæˆä¹‹åï¼Œæ–°å»ºé¡¹ç›®æ—¶é€‰æ‹©ä¼šå‘ç°æç¤ºéœ€è¦å®‰è£…PlatformIO Core CLI</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021318583.png" alt="image-20211202131833556" style="zoom:50%;" />
<h3 id="å®‰è£…platform-core-cli">å®‰è£…Platform Core CLI</h3>
<p>macOSä¸Šç›´æ¥ä½¿ç”¨ brew å®‰è£…å³å¯</p>
<pre><code class="language-shell">brew install platformio

# æµ‹è¯•ä¸€ä¸‹
pio home
# æ‰“å¼€ä¸€ä¸ªç½‘é¡µ http://127.0.0.1:8008
</code></pre>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021512524.png" alt="image-20211202151220500" style="zoom:50%;" />
<h2 id="è¿è¡Œç¤ºä¾‹">è¿è¡Œç¤ºä¾‹</h2>
<h3 id="æ–°å»ºé¡¹ç›®">æ–°å»ºé¡¹ç›®</h3>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021404249.png" alt="image-20211202140453212" style="zoom:50%;" />
<blockquote>
<p>åˆæ¬¡åˆå§‹åŒ–çš„æŸç§æ¿å­çš„æ—¶å€™éœ€è¦ä¸‹è½½ä¸€äº›å·¥å…·é“¾ï¼Œæ­¤æ—¶å¯èƒ½ä¼šå¤±è´¥ï¼Œä¿è¯ç½‘ç»œè‰¯å¥½çš„æƒ…å†µä¸‹å¤šè¯•å‡ æ¬¡-é€‰ä¸­ <code>platformio.ini</code> æ–‡ä»¶å³é”®ï¼Œç„¶åé€‰æ‹© <code>PlatformIO</code>-<code>Re-Init</code>ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021408296.png" alt="image-20211202140817270" style="zoom:50%;" />
</blockquote>
<h3 id="è¿è¡Œ">è¿è¡Œ</h3>
<p>é€‰æ‹©PlatformIO Upload çš„è¿è¡Œé…ç½®ï¼Œç‚¹å‡»å°é”¤å­å³å¯ç¼–è¯‘ï¼Œç‚¹å‡»è¿è¡ŒæŒ‰é’®å³å¯ä¸Šä¼ åˆ°å¼€å‘æ¿è¿è¡Œï¼ˆä¼šè‡ªåŠ¨é€‰æ‹©ä¸²å£ï¼‰ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021412112.png" alt="image-20211202141206079" style="zoom:50%;" />
<h3 id="ä¸²å£è¿æ¥">ä¸²å£è¿æ¥</h3>
<ul>
<li>æ‰¾åˆ°<code>Serial Monitor</code>å·¥å…·çª—å£</li>
<li>ç‚¹å‡»ğŸ”§è¿›è¡Œä¸²å£é…ç½®ç«¯å£åŠæ³¢ç‰¹ç‡ï¼Œç‚¹å‡»ğŸ”Œå›¾æ ‡è¿›è¡Œè¿æ¥ã€‚</li>
</ul>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021414501.png" alt="image-20211202141439470" style="zoom:50%;" />
<h2 id="ä¸‰æ–¹åº“å¯¼å…¥">ä¸‰æ–¹åº“å¯¼å…¥</h2>
<p>ç›´æ¥åœ¨ <code>platformio.ini</code>æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–çš„é…ç½®å³å¯ï¼Œå¦‚ï¼š</p>
<pre><code class="language-ini">[env:uno]
platform = atmelavr
board = uno
framework = arduino
lib_deps =
    Wire @ ^1.0
    fmalpartida/LiquidCrystal @ ^1.5.0
</code></pre>
<p>å¯¼å…¥äº† LiquidCrystal çš„åº“ï¼ˆä¾èµ–Wireï¼‰ï¼Œé…ç½®æ·»åŠ å®Œæˆä¹‹å <code>ReInit</code> ä¸€ä¸‹å³å¯ã€‚</p>
<p>é‚£ä¹ˆå»å“ªé‡ŒæŸ¥æ‰¾è¿™äº›åº“çš„åç§°åŠç‰ˆæœ¬ä¿¡æ¯å‘¢ï¼Ÿæ‰“å¼€ <code>pio home</code> ,åœ¨ç½‘é¡µä¸­å³å¯æŸ¥è¯¢ï¼Œç„¶åç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ã€‚</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021511824.png" alt="image-20211202151143802" style="zoom:50%;" />
<h2 id="ä½“éªŒ">ä½“éªŒ</h2>
<ul>
<li>ç¼–å†™ä»£ç ç®€ç›´ä¸è¦å¤ªæµç•…ã€‚</li>
<li>å¾ˆæ–¹ä¾¿çš„åœ¨ç¬¦å·ä¹‹é—´è·³è½¬ã€‚</li>
</ul>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://docs.platformio.org/en/latest//integration/ide/clion.html#installation">CLion â€” PlatformIO latest documentation</a></li>
<li><a href="https://docs.platformio.org/en/latest/core/index.html">PlatformIO Core (CLI) â€” PlatformIO latest documentation</a></li>
<li>PlatformIO ä¾èµ–åº“æŸ¥æ‰¾æ¡†æ¶ï¼š<a href="https://docs.platformio.org/en/latest/librarymanager/ldf.html">Library Dependency Finder (LDF) â€” PlatformIO latest documentation</a></li>
<li><a href="https://docs.platformio.org/en/latest/plus/debug-tools/esp-prog.html#debugging-tool-esp-prog">ESP-Prog â€” PlatformIO latest documentation</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[é¸¿è’™å¼€å‘åŸºç¡€çŸ¥è¯†]]></title>
        <id>https://hanlyjiang.github.io/post/hong-meng-kai-fa-ru-men/</id>
        <link href="https://hanlyjiang.github.io/post/hong-meng-kai-fa-ru-men/">
        </link>
        <updated>2021-11-30T02:13:11.000Z</updated>
        <summary type="html"><![CDATA[<p>åŸºäºå®˜æ–¹æ–‡æ¡£æ•´ç†çš„é¸¿è’™å¼€å‘çš„åŸºç¡€çŸ¥è¯†</p>
]]></summary>
        <content type="html"><![CDATA[<p>åŸºäºå®˜æ–¹æ–‡æ¡£æ•´ç†çš„é¸¿è’™å¼€å‘çš„åŸºç¡€çŸ¥è¯†</p>
<!-- more -->
<h1 id="abilityæ¡†æ¶">Abilityæ¡†æ¶</h1>
<h2 id="ç®€ä»‹">ç®€ä»‹</h2>
<h3 id="æ•´ä½“å†…å®¹">æ•´ä½“å†…å®¹</h3>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111301012735.png" alt="image-20211028145037926" style="zoom: 50%;" />
<p>åŒ<code>Android</code> å¯¹æ¯”å…³ç³»ï¼š</p>
<ul>
<li><code>FeatureAbility</code> - <code>Activity</code></li>
<li><code>ServiceAbility</code> - <code>Service</code></li>
<li><code>DataAbility</code> - <code>ContentProvider</code></li>
<li><code>CES</code> - å¹¿æ’­</li>
<li><code>ANS</code> - é€šçŸ¥</li>
<li>çº¿ç¨‹é€šä¿¡
<ul>
<li><code>InnerEvent</code> - <code>Message</code></li>
<li><code>EventHandler</code> - <code>Handler</code></li>
<li><code>EventRunner</code> - <code>Looper</code></li>
<li><code>EventQueue</code> - <code>MessageQueue</code></li>
</ul>
</li>
</ul>
<h3 id="abilityè¯´æ˜">Abilityè¯´æ˜</h3>
<p>åŒAndroid å•ç‹¬æä¾› Activityï¼ŒServiceï¼ŒContentProvider çš„åŸºç±»ä¸ä¸€æ ·ï¼Œé¸¿è’™è¿™ä¸‰ä¸ªç»„ä»¶å…¨éƒ½æ˜¯ç»§æ‰¿è‡ª Abilityï¼Œé‚£ä¹ˆå¦‚ä½•åŒºåˆ†ä¸€ä¸ªAbilityåˆ°åº•æ˜¯å“ªç§ç»„ä»¶å‘¢ï¼Ÿ</p>
<ul>
<li>
<p>ç»§æ‰¿åå®ç°æ—¶é€‰æ‹©æ€§å®ç°å¯¹åº”ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼›</p>
</li>
<li>
<p>åœ¨ <code>config.json</code> ä¸­å®šä¹‰abilityæ—¶ï¼Œéœ€è¦å£°æ˜å¯¹åº”çš„ç±»å‹ï¼ˆpage-FAï¼›service - ServiceAbilityï¼› data - DataAbilityï¼‰</p>
<pre><code class="language-json">{
    &quot;name&quot;: &quot;com.hanlyjiang.ohosdemo.MainJSAbility2&quot;,
    &quot;icon&quot;: &quot;$media:icon&quot;,
    &quot;description&quot;: &quot;$string:mainjsability2_description&quot;,
    &quot;label&quot;: &quot;$string:entry_MainJSAbility2&quot;,
    &quot;type&quot;: &quot;page&quot;,
    &quot;launchType&quot;: &quot;standard&quot;,
},
{
    &quot;name&quot;: &quot;com.hanlyjiang.ohosdemo.ServiceAbility&quot;,
    &quot;icon&quot;: &quot;$media:icon&quot;,
    &quot;description&quot;: &quot;$string:serviceability_description&quot;,
    &quot;type&quot;: &quot;service&quot;
},
{
    &quot;name&quot;: &quot;com.hanlyjiang.ohosdemo.DataAbility&quot;,
    &quot;icon&quot;: &quot;$media:icon&quot;,
    &quot;description&quot;: &quot;$string:dataability_description&quot;,
    &quot;type&quot;: &quot;data&quot;,
    &quot;uri&quot;: &quot;dataability://com.hanlyjiang.ohosdemo.DataAbility&quot;
}
</code></pre>
</li>
</ul>
<h2 id="fafeatureability">FAï¼ˆFeatureAbilityï¼‰</h2>
<h3 id="fa-ç”Ÿå‘½å‘¨æœŸ">FA ç”Ÿå‘½å‘¨æœŸ</h3>
<table>
<thead>
<tr>
<th>ç”Ÿå‘½å‘¨æœŸå›è°ƒ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>onStart</td>
<td>é¦–æ¬¡åˆ›å»ºè§¦å‘ï¼Œä»…æ‰§è¡Œä¸€æ¬¡ éœ€è¦setMainRoute</td>
</tr>
<tr>
<td>onActive</td>
<td>è¿›å…¥å‰å°å¯äº¤äº’çŠ¶æ€åè°ƒç”¨</td>
</tr>
<tr>
<td>onInactive</td>
<td>Pageå¤±å»ç„¦ç‚¹æ—¶è°ƒç”¨</td>
</tr>
<tr>
<td>onBackground</td>
<td>Pageä¸å†å¯è§ èµ„æºé‡Šæ”¾åŠè€—æ—¶ä¿å­˜æ“ä½œ</td>
</tr>
<tr>
<td>onForeground</td>
<td>é‡æ–°å›åˆ°å‰å°ï¼ˆè·å¾—ç„¦ç‚¹ é‡æ–°ç”³è¯·èµ„æº</td>
</tr>
<tr>
<td>onStop</td>
<td>é”€æ¯é¡µé¢æ—¶è°ƒç”¨ é‡Šæ”¾ç³»ç»Ÿèµ„æº</td>
</tr>
</tbody>
</table>
<p>åŒ<code>Android</code>å¯¹æ¯”ï¼Œå…³ç³»å¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111301012429.png" alt="image-20211028144542021" loading="lazy"></figure>
<table>
<thead>
<tr>
<th>é¸¿è’™</th>
<th>å®‰å“</th>
</tr>
</thead>
<tbody>
<tr>
<td>onStart</td>
<td>onCreate</td>
</tr>
<tr>
<td>onActive</td>
<td>onResume</td>
</tr>
<tr>
<td>onInactive</td>
<td>onPause</td>
</tr>
<tr>
<td>onBackground</td>
<td>onStop</td>
</tr>
<tr>
<td>onForeground</td>
<td>onRestart</td>
</tr>
<tr>
<td>onStop</td>
<td>onDestory</td>
</tr>
</tbody>
</table>
<h2 id="service-ability">Service Ability</h2>
<p>åŒ Android Serviceï¼Œæ²¡æœ‰ç•Œé¢ï¼Œå¯åå°è¿è¡Œï¼›</p>
<p>ä½†æ˜¯é¸¿è’™å¯ä»¥å¯åŠ¨/ç»‘å®šè¿œç¨‹è®¾å¤‡ä¸Šçš„æœåŠ¡ï¼ˆæŒ‡å®šè®¾å¤‡IDï¼‰ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111301012611.jpg" alt="ç‚¹å‡»æ”¾å¤§" loading="lazy"></figure>
<h1 id="uiå¼€å‘æ¡†æ¶">UIå¼€å‘æ¡†æ¶</h1>
<h2 id="arkui">ArkUI</h2>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š <a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/ui-js-fa-overview-0000000000585484">JS FAæ¦‚è¿°</a></p>
</blockquote>
<h2 id="arkui-js-ui">ArkUI-JS UI</h2>
<blockquote>
<p>äº†è§£æ›´å¤šï¼š</p>
<ul>
<li><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/project_overview-0000001053822398">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-å·¥å…·-HUAWEI DevEco Studioä½¿ç”¨æŒ‡å—-å·¥ç¨‹ç®¡ç†-HarmonyOSå·¥ç¨‹ä»‹ç»</a></li>
<li>JS API å‚è€ƒï¼š<a href="https://developer.harmonyos.com/cn/docs/documentation/doc-references/js-framework-file-0000000000611396">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-æ–‡ä»¶ç»„ç»‡</a></li>
</ul>
</blockquote>
<p>æ•´ä½“ä¸Šç±»ä¼¼ VUE &amp; å¾®ä¿¡å°ç¨‹åº</p>
<h3 id="å…³é”®è¯">å…³é”®è¯</h3>
<ul>
<li><code>AceAbility</code>ï¼šåŠ è½½JSçš„Abilityçš„åŸºç±»å®ç°</li>
<li><code>setInstanceName</code>ï¼š æŒ‡å®šAceAbilityåŠ è½½çš„jsç›®å½•ï¼ˆåŠ è½½å¤šä¸ªé€šè¿‡æ­¤æ–¹æ³•æŒ‡å®šjsç›®å½•ï¼‰</li>
</ul>
<h3 id="é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</h3>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111301012153.png" alt="image-20211027164638077" style="zoom:67%;" />
<ul>
<li><code>AceAbility</code> å­ç±»ï¼ˆä¸Šé¢å¯¹åº”çš„æ˜¯<code>MainJSAbility</code>ï¼‰</li>
<li><code>default</code> ç›®å½•
<ul>
<li><code>app.js</code> ï¼š å…¨å±€çš„JavaScripté€»è¾‘æ–‡ä»¶å’Œåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
<li><code>pages/index.js</code> : JS FA(JS ç•Œé¢) - <mark>å¯ä»¥æœ‰å¤šä¸ªpage</mark></li>
</ul>
</li>
<li><code>config.json</code>ï¼š js å£°æ˜</li>
</ul>
<h3 id="appjs">app.js</h3>
<p>åº”ç”¨ç”Ÿå‘½å‘¨æœŸå›è°ƒ</p>
<pre><code class="language-js">export default {
    onCreate() {
        console.info('AceApplication onCreate');
    },
    onDestroy() {
        console.info('AceApplication onDestroy');
    }
};
</code></pre>
<h3 id="indexjsjs-fa">index.js(JS FA)</h3>
<ul>
<li>é¡µé¢ç”Ÿå‘½ç”Ÿå‘½å‘¨æœŸå›è°ƒ</li>
<li>é¡µé¢ä¸šåŠ¡é€»è¾‘(æ•°æ®ç»‘å®šï¼Œäº‹ä»¶å¤„ç†ç­‰)</li>
</ul>
<pre><code class="language-js">export default {
    data: {
        title: &quot;&quot;
    },
    onInit() {
        console.log(&quot;JS Page onInit&quot;)
    },
    onActive(){
        console.log(&quot;JS Page onActive&quot;)
    },
    onInactive(){
        console.log(&quot;JS Page onInactive&quot;)
    },
    onShow(){
        console.log(&quot;JS Page onShow&quot;)
    },
    onHide(){
        console.log(&quot;JS Page onHide&quot;)
    },
    onDestroy(){
        console.log(&quot;JS Page onDestroy&quot;)
    }
}
</code></pre>
<h3 id="ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ</h3>
<p>è¯¦ç»†å‚è€ƒï¼š <a href="https://developer.harmonyos.com/cn/docs/documentation/doc-references/js-framework-lifecycle-0000001113708038">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-ç”Ÿå‘½å‘¨æœŸ</a></p>
<figure data-type="image" tabindex="3"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111301012303.png" alt="img" loading="lazy"></figure>
<pre><code class="language-shell">OHSO_DEMO:  Application initialized
OHSO_DEMO:  MainAbility onStart
OHSO_DEMO:  MainAbility onActive

// æ‰“å¼€JS PAGE
OHSO_DEMO:  MainAbility onInactive
OHSO_DEMO:  MainJSAbility onStart
JSApp:  app Log: AceApplication onCreateï¼ˆapp.jsï¼‰
OHSO_DEMO:  MainJSAbility onActive
JSApp:  app Log: JS Page onInit
JSApp:  app Log: JS Page onActive
JSApp:  app Log: JS Page onShow
OHSO_DEMO:  MainAbility onBackground

// åˆ‡æ¢æœ€è¿‘ä»»åŠ¡
OHSO_DEMO:  MainJSAbility onInactive
JSApp:  app Log: JS Page onInactive
OHSO_DEMO:  MainJSAbility onBackground
JSApp:  app Log: JS Page onHide

// æ¢å¤
OHSO_DEMO:  MainJSAbility onForeground
JSApp:  app Log: JS Page onShow
OHSO_DEMO:  MainJSAbility onActive
JSApp:  app Log: JS Page onActive

// å›é€€ï¼ˆé€€å‡ºJS PAGEï¼‰
JSApp:  app Log: JS Page onHide
JSApp:  app Log: JS Page onDestroy
OHSO_DEMO:  MainJSAbility onInactive
OHSO_DEMO:  MainAbility onInactive
OHSO_DEMO:  MainAbility onActive
OHSO_DEMO:  MainJSAbility onBackground
OHSO_DEMO:  MainJSAbility onStop
JSApp:  app Log: AceApplication onDestroy ï¼ˆapp.jsï¼‰
</code></pre>
<ul>
<li>JS çš„ç”Ÿå‘½å‘¨æœŸåœ¨Java Abilityçš„å†…éƒ¨ã€‚</li>
</ul>
<h3 id="hml">HML</h3>
<blockquote>
<p>HMLï¼ˆHarmonyOS Markup Languageï¼‰æ˜¯ä¸€å¥—ç±»HTMLçš„æ ‡è®°è¯­è¨€ã€‚é€šè¿‡ç»„ä»¶ã€äº‹ä»¶æ„å»ºå‡ºé¡µé¢çš„å†…å®¹ã€‚é¡µé¢å…·å¤‡æ•°æ®ç»‘å®šã€äº‹ä»¶ç»‘å®šã€åˆ—è¡¨æ¸²æŸ“ã€æ¡ä»¶æ¸²æŸ“ç­‰é«˜çº§èƒ½åŠ›ã€‚</p>
</blockquote>
<p>å…·ä½“å¯å‚è€ƒï¼š <a href="https://developer.harmonyos.com/cn/docs/documentation/doc-references/js-framework-syntax-hml-0000000000611413">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-è¯­æ³•-HMLè¯­æ³•å‚è€ƒ</a></p>
<h3 id="indexcss">index.CSS</h3>
<p>å‚è€ƒï¼š <a href="https://developer.harmonyos.com/cn/docs/documentation/doc-references/js-framework-syntax-css-0000000000611425">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-è¯­æ³•-CSSè¯­æ³•å‚è€ƒ</a></p>
<h1 id="é¸¿è’™ç‰¹æ€§">é¸¿è’™ç‰¹æ€§</h1>
<p>é¸¿è’™ç‰¹æœ‰çš„åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä¸»è¦åŒ…æ‹¬ï¼šæœåŠ¡å¡ç‰‡ï¼Œæµè½¬ï¼Œåä¸ºåˆ†äº«åŠå¹³è¡Œè§†ç•Œã€‚</p>
<h2 id="æœåŠ¡å¡ç‰‡">æœåŠ¡å¡ç‰‡</h2>
<p>æœåŠ¡å¡ç‰‡ï¼ˆä»¥ä¸‹ç®€ç§°â€œå¡ç‰‡â€ï¼‰æ˜¯<a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/glossary-0000000000029587#section5406185415236">FA</a>çš„ä¸€ç§ç•Œé¢å±•ç¤ºå½¢å¼ï¼Œå°†FAçš„é‡è¦ä¿¡æ¯æˆ–æ“ä½œå‰ç½®åˆ°å¡ç‰‡ï¼Œä»¥è¾¾åˆ°æœåŠ¡ç›´è¾¾ï¼Œå‡å°‘ä½“éªŒå±‚çº§çš„ç›®çš„ã€‚æœåŠ¡å¡ç‰‡ä¹Ÿæ˜¯ä¸€ä¸ªFAï¼Œåªä¸è¿‡æ˜¯æ˜¾ç¤ºåœ¨å…¶ä»–åº”ç”¨ä¸­çš„ç•Œé¢ã€‚</p>
<p>å¡ç‰‡å¸¸ç”¨äºåµŒå…¥åˆ°å…¶ä»–åº”ç”¨ï¼ˆå½“å‰åªæ”¯æŒç³»ç»Ÿåº”ç”¨ï¼‰ä¸­ä½œä¸ºå…¶ç•Œé¢çš„ä¸€éƒ¨åˆ†æ˜¾ç¤ºï¼Œå¹¶æ”¯æŒæ‹‰èµ·é¡µé¢ï¼Œå‘é€æ¶ˆæ¯ç­‰åŸºç¡€çš„äº¤äº’åŠŸèƒ½ã€‚å¡ç‰‡ä½¿ç”¨æ–¹è´Ÿè´£æ˜¾ç¤ºå¡ç‰‡ã€‚</p>
<figure data-type="image" tabindex="4"><img src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20210729150026.11448964563455945776572720158002:50520728101546:2800:FB99718B0883EC644C7B007DADE0F73F9A35B89CB4A68390F037D3A25D19B8B5.png?needInitFileName=true?needInitFileName=true" alt="img" loading="lazy"></figure>
<p>Java/JSå¡ç‰‡åœºæ™¯èƒ½åŠ›å·®å¼‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>Javaå¡ç‰‡</th>
<th>JSå¡ç‰‡</th>
<th>æ”¯æŒçš„ç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®æ—¶åˆ·æ–°ï¼ˆç±»ä¼¼æ—¶é’Ÿï¼‰</td>
<td>Javaä½¿ç”¨ComponentProvideråšå®æ—¶åˆ·æ–°ä»£ä»·æ¯”è¾ƒå¤§</td>
<td>JSå¯ä»¥åšåˆ°ç«¯ä¾§åˆ·æ–°ï¼Œä½†æ˜¯éœ€è¦å®šåˆ¶åŒ–ç»„ä»¶</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
<tr>
<td>å¼€å‘æ–¹å¼</td>
<td>Java UIåœ¨å¡ç‰‡æä¾›æ–¹éœ€è¦åŒæ—¶å¯¹æ•°æ®å’Œç»„ä»¶è¿›è¡Œå¤„ç†ï¼Œç”ŸæˆComponentProviderè¿œç«¯æ¸²æŸ“</td>
<td>JSå¡ç‰‡åœ¨ä½¿ç”¨æ–¹åŠ è½½æ¸²æŸ“ï¼Œæä¾›æ–¹åªè¦å¤„ç†æ•°æ®ã€ç»„ä»¶å’Œé€»è¾‘åˆ†ç¦»</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
<tr>
<td>ç»„ä»¶æ”¯æŒ</td>
<td>Textã€Imageã€DirectionalLayoutã€PositionLayoutã€DependentLayout</td>
<td>divã€listã€list-itemã€swiperã€stackã€imageã€textã€spanã€progressã€buttonï¼ˆå®šåˆ¶ï¼šchart ã€clockã€calendarï¼‰</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
<tr>
<td>å¡ç‰‡å†…åŠ¨æ•ˆ</td>
<td>ä¸æ”¯æŒ</td>
<td>æš‚ä¸å¼€æ”¾</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
<tr>
<td>é˜´å½±æ¨¡ç³Š</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
<tr>
<td>åŠ¨æ€é€‚åº”å¸ƒå±€</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
<tr>
<td>è‡ªå®šä¹‰å¡ç‰‡è·³è½¬é¡µé¢</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>HarmonyOS 2.0åŠä»¥ä¸Š</td>
</tr>
</tbody>
</table>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<mark>JSå¡ç‰‡æ¯”Javaå¡ç‰‡æ”¯æŒçš„æ§ä»¶å’Œèƒ½åŠ›éƒ½æ›´ä¸°å¯Œ</mark>ï¼š</p>
<ul>
<li>Javaå¡ç‰‡ï¼šé€‚åˆä½œä¸ºä¸€ä¸ªç›´è¾¾å…¥å£ï¼Œæ²¡æœ‰å¤æ‚çš„é¡µé¢å’Œäº‹ä»¶ã€‚</li>
<li>JSå¡ç‰‡ï¼šé€‚åˆæœ‰å¤æ‚ç•Œé¢çš„å¡ç‰‡ã€‚</li>
</ul>
<h3 id="å¡ç‰‡å¼€å‘link">å¡ç‰‡å¼€å‘ï¼ˆ<a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/ability-service-widget-provider-js-0000001150602175">link</a>ï¼‰</h3>
<p>éœ€è¦é€šè¿‡ä¸€äº›å‚æ•°è¿›è¡Œé…ç½®ã€‚</p>
<ol>
<li>é…ç½®ï¼›</li>
<li>FAä¸­å®ç°ç‰¹å®šçš„å›è°ƒæ–¹æ³•ç”¨æ¥å¤„ç†å¡ç‰‡çš„ç•Œé¢ç›¸å…³äº‹ä»¶</li>
</ol>
<blockquote>
<p>å¾…è¡¥å……</p>
</blockquote>
<h2 id="æœåŠ¡æµè½¬">æœåŠ¡æµè½¬</h2>
<blockquote>
<p><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/hop-architecture-0000001143104837">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-ä¸“é¢˜-æµè½¬-æµè½¬æ¶æ„</a></p>
</blockquote>
<p>ä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>è·¨ç«¯è¿ç§»</li>
<li>å¤šç«¯ååŒ</li>
</ul>
<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>
<ul>
<li>æµè½¬ï¼šåœ¨HarmonyOSä¸­æ³›æŒ‡å¤šè®¾å¤‡åˆ†å¸ƒå¼æ“ä½œã€‚æµè½¬èƒ½åŠ›æ‰“ç ´è®¾å¤‡ç•Œé™ï¼Œå¤šè®¾å¤‡è”åŠ¨ï¼Œä½¿ç”¨æˆ·åº”ç”¨ç¨‹åºå¯åˆ†å¯åˆã€å¯æµè½¬ï¼Œå®ç°å¦‚é‚®ä»¶è·¨è®¾å¤‡ç¼–è¾‘ã€å¤šè®¾å¤‡ååŒå¥èº«ã€å¤šå±æ¸¸æˆç­‰åˆ†å¸ƒå¼ä¸šåŠ¡ã€‚æµè½¬ä¸ºå¼€å‘è€…æä¾›æ›´å¹¿çš„ä½¿ç”¨åœºæ™¯å’Œæ›´æ–°çš„äº§å“è§†è§’ï¼Œå¼ºåŒ–äº§å“ä¼˜åŠ¿ï¼Œå®ç°ä½“éªŒå‡çº§ã€‚æµè½¬æŒ‰ç…§ä½“éªŒå¯åˆ†ä¸º<strong>è·¨ç«¯è¿ç§»</strong>å’Œ<strong>å¤šç«¯ååŒ</strong>ã€‚</li>
<li><strong>è·¨ç«¯è¿ç§»</strong>ï¼šä¸€ç§å®ç°ç”¨æˆ·åº”ç”¨ç¨‹åºæµè½¬çš„æŠ€æœ¯æ–¹æ¡ˆï¼ŒæŒ‡åœ¨Aç«¯è¿è¡Œçš„FAè¿ç§»åˆ°Bç«¯ä¸Šï¼Œå®Œæˆè¿ç§»åï¼Œ Bç«¯FAç»§ç»­ä»»åŠ¡ï¼Œè€ŒAç«¯åº”ç”¨é€€å‡ºã€‚åœ¨ç”¨æˆ·ä½¿ç”¨è®¾å¤‡çš„è¿‡ç¨‹ä¸­ï¼Œå½“ä½¿ç”¨æƒ…å¢ƒå‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ï¼šä»å®¤å†…èµ°åˆ°æˆ·å¤–æˆ–è€…å‘¨å›´æœ‰æ›´åˆé€‚çš„è®¾å¤‡ç­‰ï¼‰ï¼Œä¹‹å‰ä½¿ç”¨çš„è®¾å¤‡å¯èƒ½å·²ç»ä¸é€‚åˆç»§ç»­å½“å‰çš„ä»»åŠ¡ï¼Œæ­¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æ–°çš„è®¾å¤‡æ¥ç»§ç»­å½“å‰çš„ä»»åŠ¡ã€‚å¸¸è§çš„è·¨ç«¯è¿ç§»åœºæ™¯å®ä¾‹ï¼š
<ul>
<li>è§†é¢‘æ¥ç”µæ—¶ä»æ‰‹æœºè¿ç§»åˆ°æ™ºæ…§å±ï¼Œè§†é¢‘èŠå¤©ä½“éªŒæ›´ä½³ï¼Œæ‰‹æœºè§†é¢‘åº”ç”¨é€€å‡ºã€‚</li>
<li>æ‰‹æœºä¸Šé˜…è¯»åº”ç”¨æµè§ˆæ–‡ç« ï¼Œè¿ç§»åˆ°å¹³æ¿ä¸Šç»§ç»­æŸ¥çœ‹ï¼Œæ‰‹æœºé˜…è¯»åº”ç”¨é€€å‡ºã€‚</li>
</ul>
</li>
<li><strong>å¤šç«¯ååŒ</strong>ï¼šä¸€ç§å®ç°ç”¨æˆ·åº”ç”¨ç¨‹åºæµè½¬çš„æŠ€æœ¯æ–¹æ¡ˆï¼ŒæŒ‡å¤šç«¯ä¸Šçš„ä¸åŒFA/PAåŒæ—¶è¿è¡Œã€æˆ–è€…äº¤æ›¿è¿è¡Œå®ç°å®Œæ•´çš„ä¸šåŠ¡ï¼›æˆ–è€…ï¼Œå¤šç«¯ä¸Šçš„ç›¸åŒFA/PAåŒæ—¶è¿è¡Œå®ç°å®Œæ•´çš„ä¸šåŠ¡ã€‚å¤šä¸ªè®¾å¤‡ä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸ºç”¨æˆ·æä¾›æ¯”å•è®¾å¤‡æ›´åŠ é«˜æ•ˆã€æ²‰æµ¸çš„ä½“éªŒã€‚ä¾‹å¦‚ï¼šç”¨æˆ·é€šè¿‡æ™ºæ…§å±çš„åº”ç”¨Aæ‹ç…§åï¼ŒAå¯è°ƒç”¨æ‰‹æœºçš„åº”ç”¨Bè¿›è¡Œäººåƒç¾é¢œï¼Œæœ€ç»ˆå°†ç¾é¢œåçš„ç…§ç‰‡ä¿å­˜åœ¨æ™ºæ…§å±çš„åº”ç”¨Aã€‚å¸¸è§çš„å¤šç«¯ååŒåœºæ™¯å®ä¾‹è¿˜æœ‰ï¼š
<ul>
<li>æ‰‹æœºä¾§åº”ç”¨Aåšæ¸¸æˆæ‰‹æŸ„ï¼Œæ™ºæ…§å±ä¾§åº”ç”¨Båšæ¸¸æˆæ˜¾ç¤ºï¼Œä¸ºç”¨æˆ·ç»„æˆä¸€ä¸ªå…¨æ–°çš„æ¸¸æˆä½“éªŒã€‚</li>
<li>å¹³æ¿ä¾§åº”ç”¨Aåšç­”é¢˜æ¿ï¼Œæ™ºæ…§å±ä¾§åº”ç”¨Båšç›´æ’­ï¼Œä¸ºç”¨æˆ·ç»„æˆä¸€ä¸ªå…¨æ–°çš„ä¸Šç½‘è¯¾ä½“éªŒã€‚</li>
</ul>
</li>
</ul>
<h4 id="ä»»åŠ¡æµè½¬ç®¡ç†æœåŠ¡">ä»»åŠ¡æµè½¬ç®¡ç†æœåŠ¡</h4>
<p>åœ¨æµè½¬å‘èµ·ç«¯ï¼Œæ¥å—ç”¨æˆ·åº”ç”¨ç¨‹åºæ³¨å†Œï¼Œæä¾›æµè½¬å…¥å£ã€çŠ¶æ€æ˜¾ç¤ºã€é€€å‡ºæµè½¬ç­‰ç®¡ç†èƒ½åŠ›ã€‚æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æä¾›çš„æ³¨å†Œã€è§£æ³¨å†Œã€æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨ã€ä¸ŠæŠ¥ä¸šåŠ¡çŠ¶æ€æ˜¯å®ç°è·¨ç«¯è¿ç§»çš„å‰æã€‚</p>
<p><em>ä»»åŠ¡æµè½¬ç®¡ç†æœåŠ¡</em>ç”±ä¸€ä¸ªå®ç°äº†æµè½¬ <code>IContinuationRegisterManager</code> æ¥å£çš„ç®¡ç†å™¨æä¾›ï¼ŒåŒ…æ‹¬å¦‚ä¸‹æ¥å£ï¼š</p>
<ul>
<li><code>register</code>ï¼šæ³¨å†Œå¹¶è¿æ¥åˆ°æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ã€‚</li>
<li><code>showDeviceList</code>ï¼šæ˜¾ç¤ºç»„ç½‘å†…å¯é€‰æ‹©è®¾å¤‡åˆ—è¡¨ä¿¡æ¯ã€‚</li>
<li><code>updateConnectStatus</code>ï¼šé€šçŸ¥æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æ›´æ–°å½“å‰ç”¨æˆ·ç¨‹åºçš„è¿æ¥çŠ¶æ€ï¼Œå¹¶åœ¨æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ç•Œé¢å±•ç¤ºç»™ç”¨æˆ·ã€‚</li>
<li><code>disconnect</code>ï¼šåœ¨åº”ç”¨é€€å‡ºæ—¶ï¼Œä¸»åŠ¨è°ƒç”¨æ–­å¼€å’Œæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡çš„è¿æ¥ã€‚</li>
<li><code>unregister</code>ï¼šä»æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡è§£æ³¨å†Œã€‚</li>
</ul>
<p>ä¸€èˆ¬æµç¨‹æ˜¯: FA startæ—¶æ³¨å†Œï¼Œç„¶åæ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨ï¼Œç”¨æˆ·é€‰æ‹©è®¾å¤‡åæ›´æ–°è¿æ¥çŠ¶æ€ã€‚é¡µé¢é”€æ¯æ—¶æ–­å¼€è¿æ¥å¹¶è§£é™¤æ³¨å†Œã€‚</p>
<p><strong>éƒ¨åˆ†è®¾å¤‡ä¸Šæœ‰å†…ç½®çš„æµè½¬ç®¡ç†æœåŠ¡ï¼Œéƒ¨åˆ†è®¾å¤‡æ²¡æœ‰ã€‚</strong></p>
<ul>
<li>å½“å‰ä»…æ‰‹æœºã€å¹³æ¿è®¾å¤‡æ”¯æŒæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ã€‚</li>
<li>å¦‚æœæ²¡æœ‰å†…ç½®çš„æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ï¼Œåˆ™éœ€è¦å¼€å‘è€…è‡ªè¡Œé€šè¿‡ DeviceManager å®ç°æµè½¬ä»»åŠ¡ç®¡ç†</li>
</ul>
<h4 id="è·¨ç«¯è¿ç§»æµç¨‹"><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/hop-architecture-0000001143104837">è·¨ç«¯è¿ç§»æµç¨‹ï¼š</a></h4>
<figure data-type="image" tabindex="5"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20211101142614.png" alt="ç‚¹å‡»æ”¾å¤§" loading="lazy"></figure>
<blockquote>
<p><strong>è¯´æ˜</strong></p>
<p>è·¨ç«¯è¿ç§»åï¼Œè®¾å¤‡Aä¸Šçš„åº”ç”¨éœ€è¦è‡ªè¡Œé€€å‡ºã€‚</p>
</blockquote>
<h4 id="å¤šç«¯ååŒæµç¨‹"><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/hop-architecture-0000001143104837">å¤šç«¯ååŒæµç¨‹</a></h4>
<figure data-type="image" tabindex="6"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20211101142633.png" alt="ç‚¹å‡»æ”¾å¤§" loading="lazy"></figure>
<blockquote>
<p><strong>è¯´æ˜</strong></p>
<p>è®¾å¤‡Aå’ŒBè¿›è¡Œå¤šç«¯ååŒåï¼Œè®¾å¤‡Aå’Œè®¾å¤‡Cé‡å¤å¦‚ä¸Šæµç¨‹ï¼Œå¯å®ç°è®¾å¤‡Aã€Bã€Cè¿›è¡Œå¤šç«¯ååŒï¼Œæ­¤æ—¶è®¾å¤‡Aæ˜¯ä¸­å¿ƒæ§åˆ¶ç‚¹ã€‚</p>
</blockquote>
<h3 id="è·¨ç«¯è¿ç§»å¼€å‘æµç¨‹">è·¨ç«¯è¿ç§»å¼€å‘æµç¨‹</h3>
<h4 id="æµç¨‹">æµç¨‹</h4>
<p>æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<img src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20211009142428.92713305432234037812857590541318:50521008090619:2800:FA3F702E046589CA52C8B1239687350203E8377D522BB15B8B25BF2F4F6BC475.png?needInitFileName=true?needInitFileName=true" alt="img" style="zoom:67%;" />
<h4 id="é™åˆ¶">é™åˆ¶</h4>
<ul>
<li>æ¯ä¸ªåº”ç”¨æ³¨å†Œæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡çš„<code>Ability</code>æ•°é‡ä¸Šé™ä¸º5ä¸ªï¼Œåç»­æ–°å¢æ³¨å†Œçš„Abilityä¼šå°†æœ€å¼€å§‹æ³¨å†Œçš„è¦†ç›–ã€‚</li>
<li>ä¸€ä¸ªåº”ç”¨å¯èƒ½åŒ…å«å¤šä¸ªFAï¼Œä»…éœ€è¦åœ¨æ”¯æŒè·¨ç«¯è¿ç§»çš„FAåŠå…¶æ‰€åŒ…å«çš„<code>AbilitySlice</code>ä¸­ï¼Œè°ƒç”¨æˆ–å®ç°ç›¸å…³æ¥å£ã€‚</li>
<li>è·¨ç«¯è¿ç§»ä¸æ”¯æŒä¸¤ä¸ªè®¾å¤‡ä¹‹é—´åˆ†åˆ«ç™»å½•ä¸åŒçš„å¸å·ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚å¤šä¸ªè®¾å¤‡æ˜¯åŒå¸å·ã€‚</li>
<li><strong>è·¨ç«¯è¿ç§»ä¸æ”¯æŒå¯¹PAçš„è¿ç§»ï¼Œåªæ”¯æŒå¯¹FAçš„è¿ç§»</strong>ã€‚</li>
<li>è·¨ç«¯è¿ç§»å®Œæˆæ—¶ï¼Œç³»ç»Ÿä¸ä¼šä¸»åŠ¨å…³é—­å‘èµ·è¿ç§»çš„FAï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œä¸»åŠ¨è°ƒç”¨<code>terminateAbility</code>æˆ–<code>stopAbility</code>å…³é—­FAï¼Œå¹¶è°ƒç”¨<code>updateConnectStatus()</code>æ›´æ–°è®¾å¤‡çš„è¿æ¥çŠ¶æ€ã€‚</li>
<li>é€šè¿‡<code>continueAbility</code>è¿›è¡Œè·¨ç«¯è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè¿œç«¯FAé¦–å…ˆæ¥æ”¶åˆ°å‘èµ·ç«¯FAä¼ è¾“çš„æ•°æ®ï¼Œå†æ‰§è¡Œå¯åŠ¨ï¼Œå³<code>onRestoreData()</code>å‘ç”Ÿåœ¨<code>onStart()</code>ä¹‹å‰ã€‚</li>
<li><strong>è·¨ç«¯è¿ç§»çš„æ•°æ®å¤§å°é™åˆ¶200KBä»¥å†…ï¼Œå³<code>onSaveData</code>åªèƒ½ä¼ é€’200KBä»¥å†…çš„æ•°æ®ã€‚</strong></li>
<li>è¿ç§»ä¼ è¾“çš„æ•°æ®ï¼Œå½“å‰ä»…æ”¯æŒåŸºç¡€ç±»å‹æ•°æ®ä¼ é€’å’Œç³»ç»Ÿ<code>Sequenceable</code>å¯¹è±¡ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰å¯¹è±¡åŠæ–‡ä»¶æ•°æ®ä¼ é€’ã€‚</li>
<li>FAæµè½¬è¿‡ç¨‹ä¸­ï¼Œåœ¨æµè½¬æœªå®Œæˆæ—¶å†æ¬¡è°ƒç”¨<code>continueAbility</code>å‘èµ·æµè½¬ï¼Œæ¥å£å°†ä¼šæŠ›å‡ºçŠ¶æ€å¼‚å¸¸ï¼Œåº”ç”¨éœ€è¦åŠ ä»¥é™åˆ¶å¤„ç†ã€‚</li>
<li>è·¨ç«¯è¿ç§»è¦æ±‚HarmonyOS 2.0ä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½æ”¯æŒï¼Œæ³¨å†Œåˆ°æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æ—¶jsonParamsä¸­éœ€è¦å¢åŠ <code>{&quot;harmonyVersion&quot;:&quot;2.0.0&quot;}</code>è¿‡æ»¤æ¡ä»¶ã€‚</li>
</ul>
<h3 id="å¤šç«¯ååŒå¼€å‘æµç¨‹">å¤šç«¯ååŒå¼€å‘æµç¨‹</h3>
<h4 id="æµç¨‹-2">æµç¨‹</h4>
<p>ç›¸å¯¹è·¨ç«¯è¿ç§»ï¼Œå¤šäº† DeviceManager çš„å‚ä¸ï¼Œç”¨äºåˆå§‹åŒ–å’Œå…³é—­åˆ†å¸ƒå¼ç¯å¢ƒã€‚å¦å¤–ï¼Œè·¨ç«¯è¿ç§»åªæ¶‰åŠFAï¼Œè€Œå¤šç«¯ååŒéœ€è¦PAå‚ä¸ã€‚</p>
<figure data-type="image" tabindex="7"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20211102112816.png" alt="img" loading="lazy"></figure>
<p>ååŒå®é™…ä¸Šçš„æµç¨‹å°±æ˜¯ï¼Œé€šè¿‡startAbility å¯åŠ¨FAï¼ŒåŠPAï¼Œé€šè¿‡connectAbilityè¿æ¥åˆ°PAï¼Œç„¶åé€šè¿‡è¿œç¨‹PAæ¥è¿›è¡Œåä½œã€‚</p>
<h4 id="é™åˆ¶-2">é™åˆ¶</h4>
<ul>
<li>æ¯ä¸ªåº”ç”¨æ³¨å†Œæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡çš„Abilityæ•°é‡ä¸Šé™ä¸º5ä¸ªï¼Œåç»­æ–°å¢æ³¨å†Œçš„Abilityä¼šå°†æœ€å¼€å§‹æ³¨å†Œçš„è¦†ç›–ã€‚</li>
<li><strong>startAbilityã€connectAbilityä¸­è·¨è®¾å¤‡ä¼ é€’çš„intentæ•°æ®å¤§å°é™åˆ¶200KBä»¥å†…ã€‚</strong></li>
<li>ä¸æ”¯æŒä½¿ç”¨connectAbilityè§¦å‘è¿œç«¯PAçš„å…å®‰è£…ã€‚</li>
<li><strong>connectAbilityä¸­è·¨è®¾å¤‡ä¼ é€’çš„remoteObjectæ•°æ®å¤§å°é™åˆ¶200KBä»¥å†…ã€‚</strong></li>
<li>å¤šç«¯ååŒè¦æ±‚HarmonyOS 2.0ä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½æ”¯æŒï¼Œæ³¨å†Œåˆ°æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æ—¶jsonParamsä¸­éœ€è¦å¢åŠ {&quot;harmonyVersion&quot;:&quot;2.0.0&quot;}è¿‡æ»¤æ¡ä»¶ã€‚</li>
<li>stopAbilityä¸æ”¯æŒä¸¤ä¸ªè®¾å¤‡ä¹‹é—´åˆ†åˆ«ç™»å½•ä¸åŒçš„å¸å·ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚å¤šä¸ªè®¾å¤‡æ˜¯åŒå¸å·ã€‚</li>
</ul>
<h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3>
<p>å‚è€ƒå®˜æ–¹ç¤ºä¾‹ï¼š</p>
<ul>
<li><a href="https://gitee.com/harmonyos/harmonyos_app_samples/tree/master/ability/DistributedScheduler">ability/DistributedScheduler Â· HarmonyOS/harmonyos_app_samples - ç äº‘ - å¼€æºä¸­å›½ (gitee.com)</a></li>
<li><a href="https://developer.harmonyos.com/cn/docs/documentation/doc-guides/hop-multi-device-collaboration-guidelines-0000001139737211#section27065313575">HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-ä¸“é¢˜-æµè½¬-HarmonyOSç«¯å‘èµ·å¤šç«¯ååŒ-å¤šç«¯ååŒå¼€å‘æŒ‡å¯¼</a></li>
</ul>
<h1 id="å…¶ä»–">å…¶ä»–</h1>
<h2 id="æ—¥å¿—è¾“å‡º">æ—¥å¿—è¾“å‡º</h2>
<h3 id="hilog">HiLog</h3>
<pre><code class="language-java">    static final HiLogLabel label = new HiLogLabel(HiLog.LOG_APP, MY_MODULE, &quot;MY_TAG&quot;); //MY_MODULE=0x00201
    HiLog.warn(label, &quot;Failed to visit %{private}s, reason:%{public}d.&quot;, url, errno);
</code></pre>
<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">Result: 05-26 11:01:06.870 1051 1051 W 00201/test: Failed to visit &lt;private&gt;, reason:503.
</code></pre>
<blockquote>
<p>æ³¨æ„ï¼š <private> éšè—äº†æœ¬è¯¥è¢«è¾“å‡ºçš„ url</p>
</blockquote>
<h2 id="å¯¹åº”æ¦‚å¿µç±»">å¯¹åº”æ¦‚å¿µ/ç±»</h2>
<ul>
<li><code>LayoutBoost</code> -&gt; <code>LayoutInflater</code></li>
</ul>
<h2 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h2>
<h3 id="éšè—-actionbar">éšè— ActionBar</h3>
<p>å°†å¦‚ä¸‹é…ç½®æ®µæ·»åŠ åˆ° module ä¸­ï¼Œæˆ–è€…æ·»åŠ åˆ° ability ä¸­ã€‚</p>
<pre><code class="language-json">	&quot;metaData&quot;: {
          &quot;customizeData&quot;: [
            {
              &quot;name&quot;: &quot;hwc-theme&quot;,
              &quot;value&quot;: &quot;androidhwext:style/Theme.Emui.Light.NoTitleBar&quot;
            }
          ]
    }
</code></pre>
<blockquote>
<p>æŒ‰ç†åº”è¯¥æä¾›ç›´æ¥å¯¹Abilityè®¾ç½®ä¸»é¢˜çš„é…ç½®æ–¹å¼ï¼Œä½†æ˜¯ä¸çŸ¥é“é…ç½®é¡¹ã€‚</p>
</blockquote>
<h2 id="hdc-ä½¿ç”¨">HDC ä½¿ç”¨</h2>
<p>hdc è·¯å¾„ï¼š <code>$USER_HOME/Library/Huawei/sdk/toolchains/</code></p>
<ul>
<li>
<p>æŸ¥çœ‹å¸®åŠ©ï¼š <code>hdc help</code></p>
<p>ä¸€èˆ¬ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">hdc [options] &lt;command&gt; [arguments]
</code></pre>
</li>
<li>
<p>æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨ï¼š <code>hdc list targets -v </code></p>
</li>
<li>
<p>æŸ¥çœ‹æ—¥å¿—ï¼š hilog</p>
<pre><code>hdc hilog | grep com.hanlyjiang.ohosdemo
</code></pre>
</li>
<li>
<p>æŸ¥çœ‹å¯è°ƒè¯•åº”ç”¨PIDåˆ—è¡¨ï¼š <code>hdc listpid</code></p>
</li>
</ul>
<h3 id="ä½¿ç”¨æ‰‹æœºå†…çš„androidå‘½ä»¤">ä½¿ç”¨æ‰‹æœºå†…çš„<code>android</code>å‘½ä»¤</h3>
<p>ä½¿ç”¨ hdc shell è¿›å…¥æ‰‹æœºshellç¯å¢ƒï¼Œç„¶åå¯æ‰§è¡Œå¯¹åº”çš„androidå‘½ä»¤</p>
<p>å¦‚ä¸‹ï¼Œé€šè¿‡<code>dumpsys activity services -p com.hanlyjiang.ohosdemo</code>å¯ä»¥çœ‹åˆ°å®é™…ä¸Š é¸¿è’™ä¸ºæˆ‘ä»¬çš„ <code>com.hanlyjiang.ohosdemo.pa.ServiceAbility</code> ç”Ÿæˆäº†ä¸€ä¸ªå¯¹åº”çš„shellServiceï¼ˆ<code>com.hanlyjiang.ohosdemo/.pa.ServiceAbilityShellService</code>ï¼‰</p>
<pre><code class="language-shell">$ dumpsys activity services -p com.hanlyjiang.ohosdemo
ACTIVITY MANAGER SERVICES (dumpsys activity services)
  User 0 active services:
  * ServiceRecord{b2375c9 u0 com.hanlyjiang.ohosdemo/.pa.ServiceAbilityShellService}
    intent={pkg=com.hanlyjiang.ohosdemo cmp=com.hanlyjiang.ohosdemo/.pa.ServiceAbilityShellService}
    packageName=com.hanlyjiang.ohosdemo
    processName=com.hanlyjiang.ohosdemo
    baseDir=/data/app/com.hanlyjiang.ohosdemo-XmLCnshi-zSpv76TYXTvwA==/base.apk
    dataDir=/data/user/0/com.hanlyjiang.ohosdemo
    app=ProcessRecord{b340b59 7888:com.hanlyjiang.ohosdemo/u0a191}
    createTime=-10m43s889ms startingBgTimeout=--
    lastActivity=-10m43s889ms restartTime=-10m43s889ms createdFromFg=true
    startRequested=true delayedStop=false stopIfKilled=true callStart=true lastStartId=1
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Arduino LCDåº“å®‰è£…ä¸ä½¿ç”¨]]></title>
        <id>https://hanlyjiang.github.io/post/arduino-lcd-ku-an-zhuang-yu-shi-yong/</id>
        <link href="https://hanlyjiang.github.io/post/arduino-lcd-ku-an-zhuang-yu-shi-yong/">
        </link>
        <updated>2021-11-30T01:43:24.000Z</updated>
        <summary type="html"><![CDATA[<p>ä»githubä¸‹è½½ LiquidCrystal çš„åº“ï¼Œå®‰è£…åˆ°Arduino IDEï¼Œå¹¶ç‚¹äº®1602 LCDã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<p>ä»githubä¸‹è½½ LiquidCrystal çš„åº“ï¼Œå®‰è£…åˆ°Arduino IDEï¼Œå¹¶ç‚¹äº®1602 LCDã€‚</p>
<!-- more -->
<p>å‡†å¤‡ä½¿ç”¨Arduino UNOç‚¹äº®ä¸€ä¸ªLCD1602ï¼Œå‘ç°ArduinoIDEï¼ˆæˆ‘ç”¨çš„2.0Betaç‰ˆæœ¬ï¼‰ä¸­é»˜è®¤æ²¡æœ‰å®‰è£… LiquidCrystal çš„åº“ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¿›è¡Œå®‰è£…ã€‚</p>
<h2 id="å®‰è£…">å®‰è£…</h2>
<p>ç¬¬ä¸€ç§å®‰è£…æ–¹å¼æ˜¯ä»Arduino IDEçš„ Library Managerä¸­æœç´¢ğŸ”å¹¶å®‰è£…ã€‚å¦å¤–å°±æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡å–æ‰‹åŠ¨å®‰è£…çš„æ–¹å¼ã€‚</p>
<ol>
<li>
<p>è®¿é—®å…¶githubä»“åº“ï¼ˆhttps://github.com/arduino-libraries/LiquidCrystalï¼‰ï¼Œä¸‹è½½ä¸ºzipåŒ…ï¼Œä¸‹è½½å®Œæ¯•åå°±æ˜¯ <code>LiquidCrystal-master.zip</code></p>
</li>
<li>
<p>æŒ‰å¦‚ä¸‹è·¯å¾„æ‰¾åˆ°æ·»åŠ  ZIP åº“çš„èœå•</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111300938313.png" alt="image-20211130093814250" style="zoom:50%;" />
</li>
<li>
<p>é€‰æ‹©æˆ‘ä»¬çš„  <code>LiquidCrystal-master.zip</code> æ–‡ä»¶ï¼Œå®‰è£…å®Œæ¯•åé‡å¯ä¸€ä¸‹ Arduino IDEã€‚</p>
</li>
<li>
<p>é‡æ–°æ‰“å¼€IDEï¼Œå³å¯çœ‹åˆ°ç¤ºä¾‹ä¸­å¤šäº†LiquidCrystal çš„ç¤ºä¾‹</p>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111300940469.png" alt="image-20211130093952928" style="zoom:50%;" />
</li>
</ol>
<h2 id="è¿è¡Œç¤ºä¾‹">è¿è¡Œç¤ºä¾‹</h2>
<p>å¼€ä¸€ä¸ª Blink çš„ç¤ºä¾‹ï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼æ¥çº¿ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111300942772.png" alt="image-20211130094241742" loading="lazy"></figure>
<p>è¿è¡Œä¹‹åæ•ˆæœï¼š</p>
<p><em>å¾…è¡¥å›¾ã€‚</em> å¯å‚è€ƒï¼š http://www.taichi-maker.com/homepage/reference-index/arduino-library-index/liquidcrystal-library/</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç®€åŒ–Androidåº“ä¸Šä¼ åˆ°Mavenä»“åº“çš„gradleé…ç½®]]></title>
        <id>https://hanlyjiang.github.io/post/jian-hua-android-ku-shang-chuan-dao-maven-cang-ku-de-gradle-pei-zhi/</id>
        <link href="https://hanlyjiang.github.io/post/jian-hua-android-ku-shang-chuan-dao-maven-cang-ku-de-gradle-pei-zhi/">
        </link>
        <updated>2021-06-01T02:26:00.000Z</updated>
        <summary type="html"><![CDATA[<p>é…ç½® android ä¸Šä¼ åˆ° maven ä¸­å¿ƒä»“åº“ï¼Œå‘ç°é…ç½®çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè€Œä¸”å¦‚æœæœ‰å¤šä¸ªåº“æ¨¡å—éœ€è¦ä¸Šä¼ ï¼Œåˆ™éœ€è¦å¤åˆ¶ç²˜è´´ä¸å°‘é‡å¤çš„é…ç½®ä»£ç ï¼Œäºæ˜¯ç¼–å†™äº†ä¸€ä¸ª gradle æ’ä»¶ç”¨äºç®€åŒ–æå–è¿™ä¸ªé…ç½®è¿‡ç¨‹ï¼›</p>
]]></summary>
        <content type="html"><![CDATA[<p>é…ç½® android ä¸Šä¼ åˆ° maven ä¸­å¿ƒä»“åº“ï¼Œå‘ç°é…ç½®çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè€Œä¸”å¦‚æœæœ‰å¤šä¸ªåº“æ¨¡å—éœ€è¦ä¸Šä¼ ï¼Œåˆ™éœ€è¦å¤åˆ¶ç²˜è´´ä¸å°‘é‡å¤çš„é…ç½®ä»£ç ï¼Œäºæ˜¯ç¼–å†™äº†ä¸€ä¸ª gradle æ’ä»¶ç”¨äºç®€åŒ–æå–è¿™ä¸ªé…ç½®è¿‡ç¨‹ï¼›</p>
<!-- more -->
<h2 id="æ’ä»¶ç”¨é€”åŠæ•ˆæœ">æ’ä»¶ç”¨é€”åŠæ•ˆæœ</h2>
<p>æœ¬æ’ä»¶ç”¨äºç®€åŒ–Androidåº“ä¸Šä¼ åˆ°Mavenä¸­å¿ƒä»“åº“çš„é…ç½®ï¼Œé¿å…æ¯ä¸ªprojectçš„gradleä¸­éƒ½æ”¾ç½®ä¸€ä»½é‡å¤è¾ƒå¤šçš„é…ç½®ï¼›</p>
<p>æ’ä»¶æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<ol>
<li>ç®€åŒ– maven-publish æ’ä»¶çš„é…ç½®æµç¨‹ï¼›</li>
<li>æ·»åŠ ä¸Šä¼ åˆ°Mavenä¸­å¿ƒä»“åº“çš„ publish ä»»åŠ¡ï¼›</li>
<li>æ”¯æŒé…ç½®ä¸Šä¼ æ—¶æ˜¯å¦åŒ…å« javadoc åŠæºç ï¼›</li>
</ol>
<h3 id="ç›´æ¥ä½¿ç”¨maven-publishæ’ä»¶çš„é…ç½®">ç›´æ¥ä½¿ç”¨maven-publishæ’ä»¶çš„é…ç½®ï¼š</h3>
<pre><code class="language-kotlin">import org.gradle.api.publish.maven.MavenPom

plugins {
    id(&quot;com.android.library&quot;)
    id(&quot;signing&quot;)
    `maven-publish`
}

android {
    defaultConfig {
        versionName(&quot;1.0.0-SNAPSHOT&quot;)
    }
}

dependencies {
   // 
}

tasks.register(&quot;javadoc&quot;, Javadoc::class.java) {
    group = &quot;publishing&quot;
    dependsOn(&quot;assemble&quot;)
    source = android.sourceSets[&quot;main&quot;].java.getSourceFiles()
    classpath += project.files(android.bootClasspath + File.pathSeparator)
    if (JavaVersion.current().isJava9Compatible) {
        (options as StandardJavadocDocletOptions).addBooleanOption(&quot;html5&quot;, true)
    }
    android.libraryVariants.forEach { libraryVariant -&gt;
        classpath += libraryVariant.javaCompileProvider.get().classpath
    }
    options.apply {
        encoding(&quot;UTF-8&quot;)
        charset(&quot;UTF-8&quot;)
        isFailOnError = false

        (this as StandardJavadocDocletOptions).apply {
//            addStringOption(&quot;Xdoclint:none&quot;)
            links?.add(&quot;https://developer.android.google.cn/reference/&quot;)
            links?.add(&quot;http://docs.oracle.com/javase/8/docs/api/&quot;)
        }
    }
}

tasks.register(&quot;jarSource&quot;, Jar::class.java) {
    group = &quot;publishing&quot;
    from(android.sourceSets[&quot;main&quot;].java.srcDirs)
    archiveClassifier.set(&quot;sources&quot;)
}

tasks.register(&quot;jarJavadoc&quot;, Jar::class.java) {
    group = &quot;publishing&quot;
    dependsOn(&quot;javadoc&quot;)
    val javadoc: Javadoc = tasks.getByName(&quot;javadoc&quot;) as Javadoc
    from(javadoc.destinationDir)
    archiveClassifier.set(&quot;javadoc&quot;)
}

fun getMyPom(): Action&lt;in MavenPom&gt; {
    return Action&lt;MavenPom&gt; {
        name.set(&quot;Android Common Utils Lib&quot;)
        description.set(&quot;Android Common Utils Library For HJ&quot;)
        url.set(&quot;https://github.com/hanlyjiang/lib_common_utils&quot;)
        licenses {
            license {
                name.set(&quot;The Apache License, Version 2.0&quot;)
                url.set(&quot;http://www.apache.org/licenses/LICENSE-2.0.txt&quot;)
            }
        }
        developers {
            developer {
                id.set(&quot;hanlyjiang&quot;)
                name.set(&quot;Hanly Jiang&quot;)
                email.set(&quot;hanlyjiang@outlook.com&quot;)
            }
        }
        scm {
            connection.set(&quot;scm:git:git://github.com/hanlyjiang/lib_common_utils.git&quot;)
            developerConnection.set(&quot;scm:git:ssh://github.com/hanlyjiang/lib_common_utils.git&quot;)
            url.set(&quot;https://github.com/hanlyjiang/lib_common_utils&quot;)
        }
    }
}


afterEvaluate {
    publishing {
        publications {
            create&lt;MavenPublication&gt;(&quot;release&quot;) {
                from(components.getByName(&quot;release&quot;))
                groupId = &quot;com.github.hanlyjiang&quot;
                artifactId = &quot;android_common_utils&quot;
                version = android.defaultConfig.versionName
                pom(getMyPom())
                // æ·»åŠ javadoc
                artifact(tasks.getByName(&quot;jarJavadoc&quot;) as Jar)
                // æ·»åŠ source
                artifact(tasks.getByName(&quot;jarSource&quot;) as Jar)
            }
        }

        repositories {
            val ossrhCredentials = Action&lt;PasswordCredentials&gt; {
                username = properties[&quot;ossrhUsername&quot;].toString()
                password = properties[&quot;ossrhPassword&quot;].toString()
            }
            // sonarçš„ä»“åº“ï¼Œåœ°å€æ ¹æ®é¡¹ç›®çš„ç‰ˆæœ¬å·æ¥ç¡®å®šæ˜¯snapshotè¿˜æ˜¯æ­£å¼ä»“åº“
            maven {
                name = &quot;Sonartype&quot;

                val releasesRepoUrl = uri(&quot;https://oss.sonatype.org/service/local/staging/deploy/maven2&quot;)
                val snapshotsRepoUrl = uri(&quot;https://oss.sonatype.org/content/repositories/snapshots/&quot;)
                url = if (android.defaultConfig.versionName.toString().endsWith(&quot;SNAPSHOT&quot;)) snapshotsRepoUrl else releasesRepoUrl
                credentials(ossrhCredentials)
                // snapshotçš„åœ°å€ï¼š
                // https://oss.sonatype.org/content/repositories/snapshots/com/github/hanlyjiang/android_common_utils/
            }
            // é¡¹ç›®æœ¬åœ°çš„ä»“åº“
            maven {
                name = &quot;ProjectLocal&quot;

                val releasesRepoUrl = uri(layout.buildDirectory.dir(&quot;repos/releases&quot;))
                val snapshotsRepoUrl = uri(layout.buildDirectory.dir(&quot;repos/snapshots&quot;))
                url = if (android.defaultConfig.versionName.toString().endsWith(&quot;SNAPSHOT&quot;)) snapshotsRepoUrl else releasesRepoUrl
            }
        }
    }

    signing {
        sign(publishing.publications.getByName(&quot;release&quot;))
    }

}
</code></pre>
<h3 id="ä½¿ç”¨androidmavenpubpluginç®€åŒ–åçš„é…ç½®">ä½¿ç”¨AndroidMavenPubPluginç®€åŒ–åçš„é…ç½®ï¼š</h3>
<pre><code class="language-kotlin">import org.gradle.api.publish.maven.MavenPom


plugins {
    id(&quot;com.android.library&quot;)
    id(&quot;signing&quot;)
    `maven-publish`
    // å¼•å…¥æˆ‘ä»¬æœ¬åœ°ä»“åº“ä¸­çš„gradleæ’ä»¶
    id(&quot;com.github.hanlyjiang.android_maven_pub&quot;) version (&quot;0.0.5&quot;) apply (false)
}

android {
    defaultConfig {
        versionName(&quot;1.0.1-SNAPSHOT&quot;)
    }
}

dependencies {
  // 
}

apply(plugin = &quot;com.github.hanlyjiang.android_maven_pub&quot;)

configure&lt;io.hanlyjiang.gradle.android.AndroidMavenPubPluginExtension&gt; {
    groupId.set(&quot;com.github.hanlyjiang&quot;)
    artifactId.set(&quot;android-common-utils&quot;)
    projectLocalRepoPath.set(&quot;local-maven-repo&quot;)
    mavenPomAction.set(Action&lt;MavenPom&gt; {
        name.set(&quot;Android Common Utils Lib&quot;)
        description.set(&quot;Android Common Utils Library For HJ&quot;)
        url.set(&quot;https://github.com/hanlyjiang/lib_common_utils&quot;)
        properties.set(
            mapOf(
                &quot;myProp&quot; to &quot;value&quot;,
                &quot;prop.with.dots&quot; to &quot;anotherValue&quot;
            )
        )
        licenses {
            license {
                name.set(&quot;The Apache License, Version 2.0&quot;)
                url.set(&quot;http://www.apache.org/licenses/LICENSE-2.0.txt&quot;)
            }
        }
        developers {
            developer {
                id.set(&quot;hanlyjiang&quot;)
                name.set(&quot;Hanly Jiang&quot;)
                email.set(&quot;hanlyjiang@outlook.com&quot;)
            }
        }
        scm {
            connection.set(&quot;scm:git:git://github.com/hanlyjiang/lib_common_utils.git&quot;)
            developerConnection.set(&quot;scm:git:ssh://github.com/hanlyjiang/lib_common_utils.git&quot;)
            url.set(&quot;https://github.com/hanlyjiang/lib_common_utils&quot;)
        }
    })
}
</code></pre>
<h2 id="ä½¿ç”¨æ­¥éª¤">ä½¿ç”¨æ­¥éª¤</h2>
<h3 id="å¼•å…¥æ’ä»¶">å¼•å…¥æ’ä»¶</h3>
<p>åœ¨éœ€è¦ä½¿ç”¨çš„æ¨¡å—çš„buildè„šæœ¬ä¸­ï¼Œå¼•å…¥æˆ‘ä»¬çš„æ’ä»¶ï¼ŒåŒæ—¶å¼•å…¥ <code>maven-publish</code> æ’ä»¶å’Œ<code> signing</code> æ’ä»¶ã€‚</p>
<h4 id="kotlinkts-è„šæœ¬å†™æ³•">kotlin.kts è„šæœ¬å†™æ³•</h4>
<pre><code class="language-kotlin">plugins {
    id(&quot;com.android.library&quot;)
    
    // å¼•å…¥signingæ’ä»¶
    id(&quot;signing&quot;)
    // å¼•å…¥maven-publishæ’ä»¶
    `maven-publish`
    // å¼•å…¥ android_maven_pub æ’ä»¶ï¼Œæ³¨æ„è¿™é‡Œè®¾ç½® apply ä¸º falseï¼Œè¡¨ç¤ºå¼•å…¥ä½†æ˜¯ä¸åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ”¾åœ¨androidé…ç½®æ®µå®šä¹‰ä¹‹åå†åº”ç”¨
    id(&quot;com.github.hanlyjiang.android_maven_pub&quot;) version (&quot;0.0.5&quot;) apply (false)
}
</code></pre>
<h4 id="groovy-çš„å†™æ³•">groovy çš„å†™æ³•</h4>
<pre><code class="language-groovy">plugins {
    id 'com.android.library'
    id 'signing'
    id 'maven-publish'
    id(&quot;com.github.hanlyjiang.android_maven_pub&quot;) version(&quot;0.0.5&quot;) apply(false)
}
</code></pre>
<h3 id="é…ç½®-gradle">é…ç½® gradle</h3>
<p>åœ¨å¼•å…¥  AndroidMavenPubPlugin æ’ä»¶ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ’ä»¶è¿›è¡Œé…ç½®ã€‚ å»ºè®®å°†è„šæœ¬è½¬æ¢ä¸º kotlin dsl çš„å†™æ³•ï¼Œèƒ½æœ‰å¯¹åº”çš„è‡ªåŠ¨æç¤ºï¼›</p>
<h4 id="kotlin-dsl-å†™æ³•">kotlin dsl å†™æ³•</h4>
<pre><code class="language-kotlin">android {
    
}

// éœ€è¦å…ˆåº”ç”¨æ’ä»¶ï¼Œåœ¨androidé…ç½®å®Œæˆä¹‹åï¼Œå»ºè®®æ”¾åœ¨è„šæœ¬æœ€ä¸‹æ–¹
apply(plugin = &quot;com.github.hanlyjiang.android_maven_pub&quot;)

configure&lt;io.hanlyjiang.gradle.android.AndroidMavenPubPluginExtension&gt; {
    groupId.set(&quot;com.github.hanlyjiang&quot;)
    artifactId.set(&quot;android_common_utils&quot;)
    mavenPomAction.set(Action&lt;MavenPom&gt; {
        name.set(&quot;Android Common Utils Lib&quot;)
        description.set(&quot;Android Common Utils Library For HJ&quot;)
        url.set(&quot;https://github.com/hanlyjiang/lib_common_utils&quot;)
        properties.set(
            mapOf(
                &quot;myProp&quot; to &quot;value&quot;,
                &quot;prop.with.dots&quot; to &quot;anotherValue&quot;
            )
        )
        licenses {
            license {
                name.set(&quot;The Apache License, Version 2.0&quot;)
                url.set(&quot;http://www.apache.org/licenses/LICENSE-2.0.txt&quot;)
            }
        }
        developers {
            developer {
                id.set(&quot;hanlyjiang&quot;)
                name.set(&quot;Hanly Jiang&quot;)
                email.set(&quot;hanlyjiang@outlook.com&quot;)
            }
        }
        scm {
            connection.set(&quot;scm:git:git://github.com/hanlyjiang/lib_common_utils.git&quot;)
            developerConnection.set(&quot;scm:git:ssh://github.com/hanlyjiang/lib_common_utils.git&quot;)
            url.set(&quot;https://github.com/hanlyjiang/lib_common_utils&quot;)
        }
    })
}
</code></pre>
<h4 id="groovy-è„šæœ¬å†™æ³•">groovy è„šæœ¬å†™æ³•</h4>
<pre><code class="language-groovy">apply plugin: &quot;com.github.hanlyjiang.android_maven_pub&quot;

android_maven_pub {
    groupId.set(&quot;com.github.hanlyjiang&quot;)
    artifactId.set(&quot;android-common-utils&quot;)
    mavenPomAction.set({ pom -&gt;
        pom.with {
            name.set('HJ Android Plugin Framework')
            description.set(&quot;A Android Plugin Framework&quot;)
            url.set(&quot;https://github.com/hanlyjiang/apf-library&quot;)
            licenses {
                license {
                    name = 'The Apache Software License, Version 2.0'
                    url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                }
            }
            developers {
                developer {
                    id = 'hanlyjiang'
                    name = 'hanly jiang'
                    email = 'hanlyjiang@outlook.com'
                }
            }
            scm {
                connection = 'https://github.com/hanlyjiang/apf-library'
                developerConnection = 'https://github.com/hanlyjiang/apf-library.git'
                url = 'https://github.com/hanlyjiang/apf-library'
            }
        }
    } as Action&lt;MavenPom&gt;)
}

</code></pre>
<blockquote>
<p>âš ï¸<strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œå¹¶æ²¡æœ‰å®šä¹‰ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·ä» <code>android.defaultConfig.versionName</code> ä¸­å– ï¼›</p>
</li>
<li>
<p>åŒæ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ç»“å°¾ä¸º <code>-SNAPSHOT</code>ï¼Œåˆ™ä¼šå‘å¸ƒåˆ° snapshot ä»“åº“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å‘å¸ƒåˆ° release ä»“åº“ï¼›</p>
</li>
</ul>
</blockquote>
<h3 id="mavenä»“åº“çš„å±æ€§æ–‡ä»¶é…ç½®">mavenä»“åº“çš„å±æ€§æ–‡ä»¶é…ç½®</h3>
<p>ä¸Šä¼ åˆ°maven centerä¸­å¿ƒä»“åº“éœ€è¦è¿›è¡Œä¸€äº›è´¦å·ç”³è¯·å’Œkeyçš„ç”Ÿæˆæ“ä½œï¼Œå¯ä»¥å‚è€ƒ<a href="https://xie.infoq.cn/article/e2345e367a139f37fc2fc0bbb">Jcenter åœæ­¢æœåŠ¡ï¼Œè¯´ä¸€è¯´æˆ‘ä»¬çš„è¿ç§»æ–¹æ¡ˆ - InfoQ å†™ä½œå¹³å°</a> æ¥å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦å°†æœ€åè·å–åˆ°çš„è®¤è¯ä¿¡æ¯ï¼š</p>
<p>æŒ‰å¦‚ä¸‹é…ç½®ï¼Œå°†å¯¹åº”çš„ value çš„å€¼æ›´æ”¹ä¸ºè‡ªå·±çš„è´¦å·åŠ key çš„å¯¹åº”å€¼ï¼Œç„¶åå¡«å…¥åˆ° <code> ~/.gradle/gradle.properties</code> ä¸­å³å¯</p>
<pre><code class="language-properties"># é…ç½®mavenä¸­å¿ƒä»“åº“è®¿é—®è´¦å·
ossrhUsername=sonatype jira è´¦å·çš„ç”¨æˆ·å
ossrhPassword=sonatype jira è´¦å·çš„å¯†ç 

# é…ç½®ç­¾åä¿¡æ¯
signing.keyId=å…¬é’¥ ID çš„å 8 ä½
signing.password=é’¥åŒ™ä¸²çš„å¯†ç 
signing.secretKeyRingFile=å¯¼å‡ºçš„ gpg æ–‡ä»¶è·¯å¾„ å¦‚ï¼š /Users/hanlyjiang/.gnupg/secring.gpg 
</code></pre>
<blockquote>
<p>âš ï¸æ³¨æ„ï¼š è¿™é‡Œçš„ key æ˜¯å›ºå®šçš„ï¼Œä¸è¦ä¿®æ”¹</p>
</blockquote>
<h3 id="æ‰§è¡Œä¸Šä¼ ä»»åŠ¡">æ‰§è¡Œä¸Šä¼ ä»»åŠ¡</h3>
<p>ç»è¿‡ä¸Šé¢çš„é…ç½®ï¼Œæˆ‘ä»¬åŒæ­¥ä¸‹ gradle ï¼Œå¯¹åº”å¼•å…¥äº†æ’ä»¶çš„é¡¹ç›®ä¸­ä¼šç”Ÿæˆè‹¥å¹²ä»»åŠ¡ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://img-blog.csdnimg.cn/20210531175716679.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21vc3B1aXRv,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy"></figure>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><code>jarJavadoc</code>, <code>jarSource</code>,<code>javadoc</code> ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„è¾…åŠ©ä»»åŠ¡</li>
<li><code>publish</code> åŠ <code>generate</code> å¼€å¤´çš„ä¸º <code>mave-publish</code> æ’ä»¶ç”Ÿæˆçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬æ‰§è¡Œ <code>publish</code> ç›¸å…³çš„ä»»åŠ¡å³å¯å‘å¸ƒ maven åº“ï¼›</li>
</ul>
<p><code>publish </code> ç›¸å…³çš„ä»»åŠ¡æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š</p>
<table>
<thead>
<tr>
<th>Task Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>publish</td>
<td>ç­‰äºæ‰§è¡Œäº†ä¸‹é¢çš„æ‰€æœ‰ä»»åŠ¡</td>
</tr>
<tr>
<td>publishAllPublicationsToProjectLocalRepository</td>
<td>å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„æ‰€æœ‰Mavenåº“å‘å¸ƒåˆ° ProjectLocal å­˜å‚¨åº“ã€‚ ProjectLocal å®šä¹‰ä¸ºå½“å‰é¡¹ç›®çš„ build ç›®å½•çš„ <code>mavenRepos</code> ç›®å½•ä¸­ï¼Œæœ‰ä¸¤ä¸ªå­ç›®å½• <code>snapshots</code>åŠ <code>release</code>ï¼Œ æ–¹ä¾¿æŸ¥çœ‹å°†è¦å‘å¸ƒçš„ç”Ÿæˆç‰©åŠè¿›è¡Œæœ¬åœ°æµ‹è¯•ï¼›</td>
</tr>
<tr>
<td>publishAllPublicationsToSonartypeRepository</td>
<td>å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„æ‰€æœ‰ Maven åº“å‘å¸ƒåˆ° Sonartype å­˜å‚¨åº“ã€‚</td>
</tr>
<tr>
<td>publishReleasePublicationToMavenLocal</td>
<td>å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„åä¸º<code>release</code>çš„ Mavenåº“å‘å¸ƒåˆ°æœ¬æœº maven ç¼“å­˜åº“ã€‚</td>
</tr>
<tr>
<td>publishReleasePublicationToProjectLocalRepository</td>
<td>å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„åä¸º<code>release</code>çš„ Mavenåº“å‘å¸ƒåˆ°æœ¬æœº ProjectLocal åº“ã€‚</td>
</tr>
<tr>
<td>publishReleasePublicationToSonartypeRepository</td>
<td>å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„åä¸º<code>release</code>çš„ Mavenåº“å‘å¸ƒåˆ°æœ¬æœº Sonartype åº“ã€‚</td>
</tr>
<tr>
<td>publishToMavenLocal</td>
<td>å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„æ‰€æœ‰ Maven åº“å‘å¸ƒåˆ° æœ¬æœº maven ç¼“å­˜åº“ã€‚</td>
</tr>
</tbody>
</table>
<p><strong>è¯´æ˜ï¼š</strong></p>
<p>ä¸Šé¢çš„ä»»åŠ¡ç”± <code>maven-publish</code> çš„æ’ä»¶ç”Ÿæˆï¼Œè¯¥æ’ä»¶ç”Ÿæˆä»»åŠ¡çš„è§„åˆ™ä½¿ç”¨ Publications å’Œ Repo æ¥ç»„åˆå®ç°ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>publication æ˜¯æˆ‘ä»¬å®šä¹‰çš„å‘å¸ƒåº“ï¼›<code>android_maven_pub</code> æ’ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>release</code> çš„é…ç½®ï¼›</li>
<li>repo æ˜¯æˆ‘ä»¬å®šä¹‰çš„ maven ä»“åº“çš„ä½ç½®ï¼Œ<code>android_maven_pub</code> å®šä¹‰äº†ä¸¤ä¸ªä»“åº“çš„ä½ç½®ï¼Œåˆ†åˆ«åä¸º ProjectLocal å’Œ Sonartype ï¼Œå¦å¤–<code>maven-publish</code>ä¼šç»™æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ª MavenLocal çš„é…ç½®ï¼ˆæŒ‡å‘æœ¬æœº maven ä»“åº“ç¼“å­˜ç›®å½•ï¼‰
<ul>
<li>å…¶ä¸­ ProjectLocal æŒ‡å‘å¼•å…¥äº†è¯¥æ’ä»¶çš„é¡¹ç›®ï¼ˆæ¨¡å—ï¼‰çš„ <code>build/repos</code> ç›®å½•</li>
<li><code>Sonartype</code> åˆ™é»˜è®¤æŒ‡å‘ maven ä¸­å¿ƒä»“åº“çš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥æ›´æ”¹ï¼›</li>
</ul>
</li>
</ul>
<h2 id="å¯é…ç½®é¡¹ç›®è¯´æ˜">å¯é…ç½®é¡¹ç›®è¯´æ˜</h2>
<table>
<thead>
<tr>
<th>é…ç½®å­—æ®µ</th>
<th>è¯´æ˜</th>
<th>é»˜è®¤å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>groupId</td>
<td>maven çš„ group idï¼Œéœ€è¦è®¾ç½®ä¸ºè‡ªå·±ç”³è¯·çš„</td>
<td>æ— é»˜è®¤å€¼-å¿…éœ€å¡«å†™</td>
</tr>
<tr>
<td>artifactId</td>
<td>library çš„ id</td>
<td>æ— é»˜è®¤å€¼-å¿…éœ€å¡«å†™</td>
</tr>
<tr>
<td>mavenPomAction</td>
<td>ç”¨äºé…ç½® pom ä¿¡æ¯çš„å­—æ®µ</td>
<td>æ— é»˜è®¤å€¼-å¿…éœ€å¡«å†™</td>
</tr>
<tr>
<td>fromAndroidPubName</td>
<td>è¡¨ç¤ºå‘å¸ƒçš„ android çš„ aar çš„ç±»å‹ï¼Œ<code>release</code> æˆ– <code>debug</code></td>
<td><code>release</code></td>
</tr>
<tr>
<td>releasesRepoUrl</td>
<td>maven release ä»“åº“çš„ä¸Šä¼ åœ°å€</td>
<td><code>https://oss.sonatype.org/service/local/staging/deploy/maven2</code></td>
</tr>
<tr>
<td>snapshotsRepoUrl</td>
<td>maven snapshots ä»“åº“çš„ä¸Šä¼ åœ°å€</td>
<td><code>https://oss.sonatype.org/content/repositories/snapshots/</code></td>
</tr>
<tr>
<td>includeSourceJar</td>
<td>æ˜¯å¦ä¸Šä¼ æºç </td>
<td><code>true</code></td>
</tr>
<tr>
<td>includeJavadocJar</td>
<td>æ˜¯å¦ä¸Šä¼  javadoc</td>
<td><code>true</code></td>
</tr>
<tr>
<td>projectLocalRepoPath</td>
<td>æœ¬åœ°ä»“åº“çš„ç›®å½•ï¼Œç›¸å¯¹äºrootProjectçš„ç›®å½•ï¼Œå¦‚ï¼š<code>local-maven-repo</code></td>
<td>é»˜è®¤ä½äºæ ¹é¡¹ç›®çš„ <code>build/mavenRepos</code> ç›®å½•ä¸­</td>
</tr>
</tbody>
</table>
<h2 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h2>
<h3 id="å‘å¸ƒåˆ°-snapshot">å‘å¸ƒåˆ° snapshot</h3>
<p>æˆ‘ä»¬æ ¹æ®ç‰ˆæœ¬å·æ¥é€‰æ‹©å‘å¸ƒåˆ°çš„æ˜¯ snapshot è¿˜æ˜¯ release ä»“åº“ï¼Œç‰ˆæœ¬å·ä» <code>android-&gt;defaultConfig - versionName</code> ä¸­è¯»å–ï¼Œå¦‚ï¼š</p>
<pre><code class="language-kotlin">android {
    compileSdkVersion(30)
    buildToolsVersion(&quot;30.0.3&quot;)

    defaultConfig {
        minSdkVersion(22)
        targetSdkVersion(30)
        versionCode(1)
        versionName(&quot;1.0.0-SNAPSHOT&quot;)
    }
}
</code></pre>
<h3 id="å‘å¸ƒåˆ°æœ¬åœ°å¹¶è¿›è¡Œæµ‹è¯•">å‘å¸ƒåˆ°æœ¬åœ°å¹¶è¿›è¡Œæµ‹è¯•</h3>
<p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡ <code>projectLocalRepoPath</code> æ¥æ”¹å˜ ProjectLocal ä»“åº“çš„ç›®å½•ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä¸­å°†å…¶è®¾ç½®ä¸º rootProject çš„ local-maven-repo ç›®å½•ä¸­</p>
<pre><code class="language-kotlin">apply(plugin = &quot;com.github.hanlyjiang.android_maven_pub&quot;)

configure&lt;io.hanlyjiang.gradle.android.AndroidMavenPubPluginExtension&gt; {
    groupId.set(&quot;com.github.hanlyjiang&quot;)
    artifactId.set(&quot;android-common-utils&quot;)
    projectLocalRepoPath.set(&quot;local-maven-repo&quot;)
	// ...
}
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰æœ¬åœ°çš„ Repo ï¼Œè§ä¸‹æ–¹åä¸º <code>ProjectLocal-Snapshots</code> åŠ <code>ProjectLocal-Release</code> çš„ä»“åº“ã€‚</p>
<pre><code class="language-kotlin">allprojects {
    repositories {
        maven { setUrl(&quot;https://maven.aliyun.com/repository/jcenter&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/google&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/gradle-plugin&quot;) }
        maven { setUrl(&quot;https://maven.aliyun.com/repository/public&quot;) }
        // å®šä¹‰æœ¬åœ°repoè·¯å¾„
        maven {
            name = &quot;ProjectLocal-Snapshots&quot;
            setUrl(File(rootProject.rootDir, &quot;local-maven-repo${File.separator}snapshots&quot;))
        }
        maven {
            name = &quot;ProjectLocal-Release&quot;
            setUrl(File(rootProject.rootDir, &quot;local-maven-repo${File.separator}release&quot;))
        }
        maven {
            name = &quot;Sonatype-Snapshots&quot;
            setUrl(&quot;https://oss.sonatype.org/content/repositories/snapshots&quot;)
//            setUrl(&quot;https://s01.oss.sonatype.org/content/repositories/snapshots&quot;)
            // snapshotå¯ä»¥ä¸ç”¨ç”¨æˆ·åå¯†ç 
            // æŸ¥çœ‹è‡ªå·±çš„snapshotç‰ˆæœ¬ï¼š https://oss.sonatype.org/content/repositories/snapshots/com/github/hanlyjiang/
            credentials(PasswordCredentials::class.java) {
                username = property(&quot;ossrhUsername&quot;).toString()
                password = property(&quot;ossrhPassword&quot;).toString()
            }
        }
        maven {
            name = &quot;Sonatype-Staging&quot;
            setUrl(&quot;https://oss.sonatype.org/service/local/staging/deploy/maven2/&quot;)
//            setUrl(&quot;https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/&quot;)
            credentials(PasswordCredentials::class.java) {
                username = property(&quot;ossrhUsername&quot;).toString()
                password = property(&quot;ossrhPassword&quot;).toString()
            }
        }
    }
}
</code></pre>
<!-- more -->
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[GitlabæŒç»­é›†æˆä¸æŒç»­éƒ¨ç½²-å®ä¾‹]]></title>
        <id>https://hanlyjiang.github.io/post/gitlab-chi-xu-ji-cheng-yu-chi-xu-bu-shu-shi-li/</id>
        <link href="https://hanlyjiang.github.io/post/gitlab-chi-xu-ji-cheng-yu-chi-xu-bu-shu-shi-li/">
        </link>
        <updated>2021-05-26T08:12:17.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•åŸºäºGitlabæ¥é…ç½®ä¸€ä¸ªæœåŠ¡é›†ç¾¤çš„è‡ªåŠ¨æ„å»ºä¸éƒ¨ç½²æ›´æ–°ï¼Œå…¶ä¸­æœåŠ¡çš„æ›´æ–°åŸºäºdockeræ¥å®Œæˆï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨å¦‚ä½•å®Œæˆéƒ¨ç½²æ“ä½œï¼ŒåŠå¦‚ä½•å®Œæˆgitlabä¸Šciçš„é…ç½®ï¼›åœ¨å®Œæˆå•ä¸€çš„æœåŠ¡è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åï¼Œæˆ‘ä»¬é€šè¿‡gitlabçš„includeåŠtriggeræœºåˆ¶æ¥ç®€åŒ–ç»Ÿä¸€éƒ¨ç½²æµç¨‹ï¼›</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•åŸºäºGitlabæ¥é…ç½®ä¸€ä¸ªæœåŠ¡é›†ç¾¤çš„è‡ªåŠ¨æ„å»ºä¸éƒ¨ç½²æ›´æ–°ï¼Œå…¶ä¸­æœåŠ¡çš„æ›´æ–°åŸºäºdockeræ¥å®Œæˆï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨å¦‚ä½•å®Œæˆéƒ¨ç½²æ“ä½œï¼ŒåŠå¦‚ä½•å®Œæˆgitlabä¸Šciçš„é…ç½®ï¼›åœ¨å®Œæˆå•ä¸€çš„æœåŠ¡è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åï¼Œæˆ‘ä»¬é€šè¿‡gitlabçš„includeåŠtriggeræœºåˆ¶æ¥ç®€åŒ–ç»Ÿä¸€éƒ¨ç½²æµç¨‹ï¼›</p>
<!-- more -->
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>æˆ‘ä»¬éœ€è¦å®ç°æœåŠ¡çš„è‡ªåŠ¨æ„å»ºåçš„è‡ªåŠ¨æ›´æ–°éƒ¨ç½²ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬åªéœ€è¦èƒ½åšåˆ°æ›´æ–°éƒ¨ç½²çš„æœåŠ¡å³å¯ï¼ŒæœåŠ¡çš„åˆæ¬¡éƒ¨ç½²å±äºä½é¢‘æ“ä½œï¼Œä¸”å’ŒæœåŠ¡å™¨ç¯å¢ƒç›¸å…³ï¼Œéœ€è¦æ‰‹åŠ¨æ¥å®Œæˆï¼›æˆ‘ä»¬è¿™é‡Œå‡å®šæœºå™¨ä¸Šå·²ç»éƒ¨ç½²å¥½äº†æœåŠ¡ï¼›</p>
<h2 id="å•ä¸€é¡¹ç›®çš„è‡ªåŠ¨éƒ¨ç½²çš„ç¤ºä¾‹">å•ä¸€é¡¹ç›®çš„è‡ªåŠ¨éƒ¨ç½²çš„ç¤ºä¾‹</h2>
<p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆä»¥ä¸€ä¸ªspringbootçš„æœåŠ¡ä½œä¸ºç¤ºä¾‹ï¼Œå®ç°äº†æ•´ä¸ªè‡ªåŠ¨æ‰“åŒ…åŠéƒ¨ç½²æ›´æ–°çš„æµç¨‹ï¼›</p>
<h3 id="æ•ˆæœ">æ•ˆæœ</h3>
<ul>
<li>
<p>æäº¤ä¹‹åï¼Œè‡ªåŠ¨æ„å»ºjarï¼Œå¹¶æ‰“åŒ…dockeré•œåƒ</p>
<figure data-type="image" tabindex="1"><img src="https://s2.loli.net/2022/05/26/15jIx7oVTpdN2qG.png" alt="202203192258673" loading="lazy"></figure>
</li>
<li>
<p>æ„å»ºå®Œæˆåï¼Œé€šè¿‡gitlabç•Œé¢ï¼Œå¯ä»¥è§¦å‘éƒ¨ç½²ï¼Œå®Œæˆåå¯ä»¥è®¿é—®å¯¹åº”çš„ç¯å¢ƒï¼ˆè¯¦è§ä¸‹æ–¹è¯´æ˜ï¼‰</p>
</li>
</ul>
<h3 id="è§¦å‘éƒ¨ç½²æ­¥éª¤çš„æ–¹å¼">è§¦å‘éƒ¨ç½²æ­¥éª¤çš„æ–¹å¼</h3>
<p>è§¦å‘éƒ¨ç½²æœ‰å¤šä¸ªå…¥å£ï¼š</p>
<ol>
<li>
<p>æµæ°´çº¿åˆ—è¡¨å°¾éƒ¨çš„æ‰‹åŠ¨ä½œä¸šæŒ‰é’®</p>
<figure data-type="image" tabindex="2"><img src="https://s2.loli.net/2022/05/26/H4IPizrx1pOlMwG.png" alt="20210526101412" loading="lazy"></figure>
</li>
<li>
<p>æµæ°´çº¿åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»å¯¹åº”çš„æ‰‹åŠ¨ä»»åŠ¡ï¼Œåœ¨å¼¹å‡ºæ¡†ä¸­ç‚¹å‡»è¿è¡Œ</p>
<figure data-type="image" tabindex="3"><img src="https://s2.loli.net/2022/05/26/TN472VCvmxjhHwe.png" alt="20210526101519" loading="lazy"></figure>
</li>
<li>
<p>æµæ°´çº¿è¯¦æƒ…ä¸­ï¼Œç‚¹å‡»è§¦å‘éƒ¨ç½²</p>
<figure data-type="image" tabindex="4"><img src="https://s2.loli.net/2022/05/26/TpsmiNOa5AWVf32.png" alt="202203192259870" loading="lazy"></figure>
</li>
<li>
<p>å¯¹åº”æ‰‹åŠ¨ä½œä¸šçš„è¯¦æƒ…ä¸­ï¼Œç‚¹å‡»â€œè§¦å‘æ­¤æ‰‹åŠ¨æ“ä½œâ€</p>
<figure data-type="image" tabindex="5"><img src="https://s2.loli.net/2022/05/26/GDTRWdy2iXAP1Le.png" alt="202203192300715" loading="lazy"></figure>
</li>
<li>
<p>ä½œä¸šåˆ—è¡¨ä¸­å¯¹åº”çš„éƒ¨ç½²ä½œä¸šçš„å°¾éƒ¨</p>
<figure data-type="image" tabindex="6"><img src="https://s2.loli.net/2022/05/26/574YeyxSfMqoaju.png" alt="202203192301127" loading="lazy"></figure>
</li>
</ol>
<h3 id="è®¿é—®éƒ¨ç½²ç¯å¢ƒçš„æ–¹å¼">è®¿é—®éƒ¨ç½²ç¯å¢ƒçš„æ–¹å¼</h3>
<p>éƒ¨ç½²ä¹‹åï¼Œä¼šåœ¨gitlabä¸­ç”Ÿæˆä¸€ä¸ªç¯å¢ƒï¼Œåœ¨ç¯å¢ƒçš„ç›¸å…³ç•Œé¢å³å¯è®¿é—®å¯¹åº”çš„æœåŠ¡åœ°å€</p>
<ol>
<li>åœ¨é¡¹ç›®çš„â€œè¿ç»´-ç¯å¢ƒâ€å…¥å£å¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„ç¯å¢ƒ</li>
</ol>
<figure data-type="image" tabindex="7"><img src="https://s2.loli.net/2022/05/26/z6jTAhZRkmXGFqe.png" alt="20210526101758" loading="lazy"></figure>
<ol start="2">
<li>
<p>ç‚¹å‡»å¯¹åº”ç¯å¢ƒå°¾éƒ¨çš„é“¾æ¥å›¾æ ‡å³å¯è®¿é—®</p>
<figure data-type="image" tabindex="8"><img src="https://s2.loli.net/2022/05/26/NHU1YLsjnP8x3ib.png" alt="20210526101901" loading="lazy"></figure>
</li>
<li>
<p>ä¹Ÿå¯ä»¥åœ¨å¯¹åº”çš„ç¯å¢ƒè¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»â€œæŸ¥çœ‹éƒ¨ç½²â€ ï¼ˆæ³¨æ„åœ¨éƒ¨ç½²ä½œä¸šçš„è¯¦æƒ…ä¸­ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”ç¯å¢ƒçš„å…¥å£å“¦-è§¦å‘éƒ¨ç½²æ­¥éª¤çš„æ–¹å¼çš„ç¬¬å››ä¸­æ–¹å¼çš„é™„å›¾ï¼‰</p>
<figure data-type="image" tabindex="9"><img src="https://s2.loli.net/2022/05/26/NHU1YLsjnP8x3ib.png" alt="" loading="lazy"></figure>
</li>
</ol>
<h3 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼</h3>
<p>æˆ‘ä»¬æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼š</p>
<ul>
<li>æ„å»ºjar</li>
<li>æ„å»ºdockeré•œåƒ</li>
<li>éƒ¨ç½²æœåŠ¡ï¼ˆé€šè¿‡swarmï¼‰</li>
</ul>
<p>å…¶ä¸­æ„å»ºjarå’Œæ„å»ºdockeré•œåƒæ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œéƒ¨ç½²æ­¥éª¤åˆ™éœ€è¦æ‰‹åŠ¨é€šè¿‡gitlabç•Œé¢è¿›è¡Œè§¦å‘ï¼›</p>
<h4 id="gitlab-ciyml-é…ç½®">gitlab-ci.yml é…ç½®</h4>
<pre><code class="language-yaml">variables:
  #  é…ç½®ä»“åº“ç¯å¢ƒ
  DOCKER_REGISTRY: zh-registry.colorless.com.cn
  DOCKER_NAMESPACE: colorless
  DEPLOY_PATH: /Wksp/colorlessWork/colorless-deploy/deploy/
  #  é…ç½®é•œåƒæœåŠ¡å
  SERVICE_NAME: graphql-token

stages:
  - test
  - build
  - build_image
  - deploy

# å¼•å…¥ä»£ç æ£€æŸ¥ä»»åŠ¡
#include:
#  local: ci/gitlab-ci-sonar.yml

build:jar:
  # éƒ¨åˆ†æ¨¡å—è‹¥ä¸ä½¿ç”¨1.8ç¼–è¯‘ä¼šæŠ¥é”™
  image: maven:3.6.3-jdk-8
  stage: build
  script:
    - mvn package
    - mkdir _archiver
    - cp target/*.jar _archiver/
    - ls -lh _archiver/
  artifacts:
    name: &quot;dist-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA&quot;
    paths:
      - _archiver/*.jar
    # ç”Ÿæˆçš„å½’æ¡£åŒ…æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬åªä¿ç•™çŸ­æ—¶é—´
    expire_in: 1 hours
  tags:
    - common-build
  only:
    - master
    - web

build:docker:
  stage: build_image
  script:
    # ç™»å½•å…¬å¸çš„Harborï¼Œæ³¨æ„å¿…é¡»åœ¨ç¯å¢ƒå˜é‡é…ç½® HARBOR_PWD
    - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin
    # å®šä¹‰é•œåƒTAG
    - IMAGE_NAME=$DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA
    - echo &quot;Docker build options $DOCKER_OPTIONS, set DOCKER_OPTIONS to --no-cache force rebuild all stage&quot;
    - cp _archiver/*.jar docker/
    # buildé•œåƒ
    - JAR_FILE=`ls docker/ | grep -E *.jar`
    - echo $JAR_FILE
    - docker build $DOCKER_OPTIONS --build-arg JAR_FILE=$JAR_FILE -t $IMAGE_NAME ./docker/
    # æ¨é€é•œåƒ
    - docker push $IMAGE_NAME
    - echo &quot;é•œåƒæ„å»ºå®Œæˆï¼š$IMAGE_NAME&quot;
  tags:
    - docker
  only:
    - master
    - web

deploy:
  stage: deploy
  script:
    - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin
    - cd $DEPLOY_PATH
    - source deploy.sh
    - update_service $DOCKER_NAMESPACE $SERVICE_NAME $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA
  environment:
    name: test_env_deploy
    url: $APP_URL/
  when: manual
  only:
    - branches
    - web
  tags:
    - deploy_graphql

</code></pre>
<p>æ³¨æ„ deploy ä»»åŠ¡ä¸­å®šä¹‰çš„ç¯å¢ƒé…ç½®ï¼š</p>
<pre><code class="language-yaml">  environment:
    name: test_env_deploy
    url: $APP_URL/
  when: manual
</code></pre>
<ol>
<li>
<p>é€šè¿‡environmenté…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨gitlabçš„ â€œè¿ç»´-ç¯å¢ƒâ€ ä¸­ç”Ÿæˆä¸€æ¡ç¯å¢ƒä¿¡æ¯ï¼Œä¸€ä¸ªç¯å¢ƒä¿¡æ¯å³å¯¹åº”ä¸€ä¸ªéƒ¨ç½²æœåŠ¡ï¼›</p>
<p>å®šä¹‰ç¯å¢ƒä¿¡æ¯ï¼Œéœ€è¦é…ç½®nameå’Œurlä¸¤ä¸ªå­—æ®µï¼Œå…¶ä¸­nameæ˜¯ç¯å¢ƒåç§°ï¼Œurlåˆ™åº”æŒ‡å‘æœåŠ¡çš„åœ°å€ï¼Œè¯¥urlå³æ˜¯æˆ‘ä»¬åœ¨gitlabç¯å¢ƒä¸­æŸ¥çœ‹éƒ¨ç½²æ—¶è·³è½¬çš„é¡µé¢ï¼›</p>
</li>
<li>
<p>è¿™é‡Œçš„urlæˆ‘ä»¬é€šè¿‡å˜é‡æ¥è¿›è¡Œé…ç½®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™æ­»ï¼›</p>
</li>
<li>
<p>æ³¨æ„è¿™é‡Œçš„nameä¸èƒ½è®¾ç½®ä¸ºä¸­æ–‡ï¼›</p>
</li>
<li>
<p>é€šè¿‡å°†when è®¾ç½®ä¸º manual ï¼Œå¯ä»¥å°†éƒ¨ç½²ä»»åŠ¡è®¾ç½®ä¸ºæ‰‹åŠ¨è§¦å‘çš„æ–¹å¼ï¼›</p>
</li>
</ol>
<h2 id="ä¼˜åŒ–æ”¹è¿›æ–¹æ¡ˆç ”ç©¶">ä¼˜åŒ–æ”¹è¿›æ–¹æ¡ˆç ”ç©¶</h2>
<h3 id="æ”¹è¿›ç›®æ ‡">æ”¹è¿›ç›®æ ‡</h3>
<p>æˆ‘ä»¬çš„ä¸€ä¸ªé›†ç¾¤ä¹‹ä¸­æœ‰å¤šä¸ªæœåŠ¡å•å…ƒï¼Œæ¯ä¸ªæœåŠ¡å•å…ƒæäº¤ä»£ç æ›´æ–°ä¹‹åï¼Œéƒ½éœ€è¦è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åˆ°å¯¹åº”çš„ç¯å¢ƒä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†ä¸Šé¢å•ä¸ªé¡¹ç›®ä¸­çš„æµç¨‹åœ¨æ‰€æœ‰é¡¹ç›®ä¸­éƒ½å¤åˆ¶ä¸€éï¼Œä¸è¿‡ï¼š</p>
<ul>
<li>é‡å¤å·¥ä½œè¾ƒå¤šï¼Œä¸€æ—¦éƒ¨ç½²è„šæœ¬å‘ç”Ÿå˜åŒ–ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦å•ç‹¬å˜åŒ–</li>
<li>æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦é…ç½®åˆ°éƒ¨ç½²æœåŠ¡å™¨çš„runner</li>
</ul>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å°†è¿™ä¸ªé‡å¤çš„æ­¥éª¤é›†ä¸­èµ·æ¥ã€‚</p>
<blockquote>
<p>å®é™…ä¸Šï¼Œæ‰“åŒ…jarå’Œæ„å»ºé•œåƒçš„æµç¨‹æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘ä¼˜åŒ–å¤ç”¨ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œä¸»è¦ä¸“æ³¨äºéƒ¨ç½²çš„æ”¹è¿›ã€‚å½“æœåŠ¡è¢«æ‰“åŒ…æˆé•œåƒä¹‹åï¼Œéƒ¨ç½²çš„æµç¨‹åªå…³æ³¨äºé•œåƒï¼Œæ— éœ€é’ˆå¯¹ä¸åŒçš„æœåŠ¡è¿›è¡ŒåŒºåˆ†å¯¹å¾…ï¼Œæ˜¯éå¸¸é€‚åˆæå–ç»Ÿä¸€çš„ï¼›</p>
</blockquote>
<h3 id="ç°çŠ¶">ç°çŠ¶</h3>
<p>ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å®ç°ä¸Šä¼ ä»£ç åè‡ªåŠ¨ç¼–è¯‘ï¼Œæ„å»ºé•œåƒï¼Œé€šè¿‡gitlabç•Œé¢å®ç°éƒ¨ç½²äº†ã€‚ä¸è¿‡é¡¹ç›®æ¯”è¾ƒå¤šæ—¶ï¼Œæˆ‘ä»¬æ¯ä¸ªéƒ½å¦‚æ­¤é…ç½®ï¼Œä¸€æ—¦éœ€è¦æ”¹åŠ¨ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†è¿™äº›ä»»åŠ¡æå–æˆå…¬ç”¨çš„è„šæœ¬ï¼Œåœ¨é¡¹ç›®ä¸­è¿›è¡Œå¼•å…¥ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°è¯•å°†è¿™éƒ¨ç½²ä»»åŠ¡æå–æˆå…¬å…±çš„ã€‚</p>
<p>å®é™…ä¸Šï¼Œä¸Šé¢çš„éƒ¨ç½²æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»éƒ¨ç½²æ›´æ–°çš„æµç¨‹åšäº†å°è£…ï¼Œå…·ä½“è„šæœ¬å¦‚ä¸‹ï¼Œåœ¨æ›´æ–°æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ <code>update_service</code> å‡½æ•°å³å¯å®ŒæˆæœåŠ¡çš„æ›´æ–°åŠæœ¬åœ°ymléƒ¨ç½²æ–‡ä»¶çš„ä¿®æ”¹ï¼›</p>
<pre><code class="language-shell"># æ›´æ–°æœåŠ¡
update_service colorless graphql-engine zh-registry.colorless.com.cn/colorless/graphql-engine:1aaa7ad9
</code></pre>
<p>deploy.sh è„šæœ¬å†…å®¹ï¼šï¼ˆåªå…³æ³¨update_service çš„æµç¨‹å³å¯ï¼‰</p>
<pre><code class="language-shell">#!/usr/bin/env bash
#set -eo pipefail

REGISTRY_ALIYUN=registry.cn-hangzhou.aliyuncs.com/hasura
REGISTRY_HARBOR=zh-registry.colorless.com.cn/colorless
# éƒ¨ç½²æœåŠ¡
STACK_NAME=colorless

function getSedOption() {
  if [ &quot;$(uname)&quot; = &quot;Darwin&quot; ]; then
    echo &quot;-i .bak&quot;
  else
    echo &quot;-i.bak&quot;
  fi
}

function logInfo() {
  echo &quot;--&gt;: $*&quot;
}

function logError() {
  echo &quot;--&gt;Error: $*&quot; &gt;&amp;2
}

# è®¾ç½®éƒ¨ç½²ç›®å½•
if [ &quot;$0&quot; = &quot;-bash&quot; ]; then
  DEPLOY_DIR=$PWD
else
  DEPLOY_DIR=$(
    cd $(dirname $0)
    pwd
  )
fi
echo &quot;DEPLOY_DIR:$DEPLOY_DIR&quot;

# ä½¿ç”¨é˜¿é‡Œäº‘çš„é•œåƒ
function use_aliyun_images() {
  sed &quot;$(getSedOption)&quot; &quot;s|$REGISTRY_HARBOR|$REGISTRY_ALIYUN|g&quot; $DEPLOY_DIR/*/*.yml
}

# ä½¿ç”¨å†…ç½‘ harbor é•œåƒ
function use_harbor_images() {
  sed &quot;$(getSedOption)&quot; &quot;s|$REGISTRY_ALIYUN|$REGISTRY_HARBOR|g&quot; $DEPLOY_DIR/*/*.yml
}

# éƒ¨ç½²å•ä¸ªè„šæœ¬æœåŠ¡
function deploy() {
  service=$1
  stack_name=$2
  if [ -z &quot;$service&quot; ]; then
    echo &quot;ç”¨æ³•ï¼šdeploy {æœåŠ¡åç§°} [stackåç§°]&quot;
    echo &quot;     {æœåŠ¡åç§°} - å¯ä¸º hasuraï¼Œkafkaï¼Œevent_track&quot;
    return
  fi
  if [ -z &quot;$stack_name&quot; ]; then
    stack_name=$STACK_NAME
  fi
  printf &quot;\n%s\n&quot; &quot;è·å–é•œåƒ: $service &quot;
  grep &quot;image:&quot; &quot;$DEPLOY_DIR/$service/docker-compose.yml&quot; | sed 's/image://g' | xargs -I {} docker pull {}
  printf &quot;\n%s\n&quot; &quot;å¯åŠ¨æœåŠ¡: $service &quot;
  docker stack deploy -c &quot;$DEPLOY_DIR/$service/docker-compose.yml&quot; $stack_name
  printf &quot;\n\n&quot;
}

function deploy_offline() {
  service=$1
  stack_name=$2
  if [ -z &quot;$service&quot; ]; then
    echo &quot;ç”¨æ³•ï¼šdeploy {æœåŠ¡åç§°} [stackåç§°]&quot;
    echo &quot;     {æœåŠ¡åç§°} - å¯ä¸º hasuraï¼Œkafkaï¼Œevent_track&quot;
    return
  fi
  if [ -z &quot;$stack_name&quot; ]; then
    stack_name=$STACK_NAME
  fi
  printf &quot;\n%s\n&quot; &quot;å¯åŠ¨æœåŠ¡: $service &quot;
  docker stack deploy -c &quot;$DEPLOY_DIR/$service/docker-compose.yml&quot; $STACK_NAME
  printf &quot;\n\n&quot;
}

# å¯¼å‡ºä¸€ä¸ªè„šæœ¬ä¸­çš„é•œåƒ
function export_images() {
  service=$1
  if [ -z &quot;$service&quot; ]; then
    echo &quot;ç”¨æ³•ï¼šdeploy {æœåŠ¡åç§°}&quot;
    echo &quot;     {æœåŠ¡åç§°} - å¯ä¸º hasuraï¼Œkafkaï¼Œevent_track&quot;
    return
  fi
  printf &quot;\n%s\n&quot; &quot;å¯¼å‡ºé•œåƒ: $service &quot;
  image_list=$(grep &quot;image:&quot; &quot;$DEPLOY_DIR/$service/docker-compose.yml&quot; | sed 's/image://g' | awk '{print $1}' | tr &quot;\n&quot; &quot; &quot;)
  echo &quot;docker image save --output=$DEPLOY_DIR/$service.tar $image_list&quot;
  docker image save --output=&quot;$DEPLOY_DIR/$service&quot;.tar &quot;$image_list&quot;
  printf &quot;\n\n&quot;
}

# éƒ¨ç½²æ‰€æœ‰æœåŠ¡
# deploy_all [stack_name]
# - stack_name ï¼š stack åç§°ï¼Œä¸ä¼ åˆ™ä¸º colorless
function deploy_all() {
  stack_name=$1
  if [ -z &quot;$stack_name&quot; ]; then
    stack_name=$STACK_NAME
  fi
  deploy graphql $stack_name
  deploy kafka $stack_name
  deploy &quot;gpl-datacollection&quot; $stack_name
}

# ä¸pullé•œåƒï¼Œéƒ¨ç½²æ‰€æœ‰æœåŠ¡
# deploy_all_offline [stack_name]
# - stack_name ï¼š stack åç§°ï¼Œä¸ä¼ åˆ™ä¸º colorless
function deploy_all_offline() {
  stack_name=$1
  if [ -z &quot;$stack_name&quot; ]; then
    stack_name=$STACK_NAME
  fi
  deploy_offline graphql $stack_name
  deploy_offline kafka $stack_name
  deploy_offline &quot;gpl-datacollection&quot; $stack_name
}

function pull_image() {
  image=$1
  if [ -z $image ]; then
    logError &quot;imageå‚æ•°æœªæŒ‡å®š&quot;
    return
  fi
  docker pull $image
}

function _usage_update_service() {
  logInfo &quot;ç”¨æ³•ï¼š update_service {stack} {service} {image}&quot;
}

# æ›´æ–°æœåŠ¡ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š
# update_service {stack} {service} {image}
# update_service colorless graphql-engine zh-registry.colorless.com.cn/colorless/graphql-engine:1aaa7ad9
# æœ¬å‡½æ•°æŒ‰å¦‚ä¸‹æµç¨‹æ‰§è¡Œï¼š
# 1. è·å–é•œåƒï¼›
# 2. æ›´æ–°æœåŠ¡ï¼›å¦‚æ›´æ–°å¤±è´¥ï¼Œåˆ™å°è¯•å›æ»šæœåŠ¡ï¼›
# 3. å¦‚æ›´æ–°æˆåŠŸï¼Œåˆ™ä¿®æ”¹æœ¬åœ°ymlæ–‡ä»¶ï¼›
function update_service() {
  # è¦æ›´æ–°çš„stack
  stack=$1
  # è¦æ›´æ–°çš„æœåŠ¡
  service=$2
  # æœåŠ¡çš„é•œåƒ
  image=$3
  if [ -z &quot;$stack&quot; ]; then
    logError &quot;stack å‚æ•°ä¸èƒ½ä¸ºç©º&quot;
    _usage_update_service
    return 1
  fi
  if [ -z &quot;$service&quot; ]; then
    logError &quot;service å‚æ•°ä¸èƒ½ä¸ºç©º&quot;
    _usage_update_service
    return 1
  fi
  if [ -z &quot;$image&quot; ]; then
    logError &quot;image å‚æ•°ä¸èƒ½ä¸ºç©º&quot;
    _usage_update_service
    return 1
  fi
  logInfo &quot;è·å–é•œåƒï¼š$image&quot;
  pull_image &quot;$image&quot;
  if [ $? -eq 1 ]; then
    logError &quot;é•œåƒè·å–å¤±è´¥&quot;
    return 1
  fi
  service_name=&quot;${stack}_${service}&quot;
  logInfo &quot;å¼€å§‹æ›´æ–°æœåŠ¡ï¼šdocker service update $service_name --image=$image&quot;
  docker service update &quot;$service_name&quot; --image=&quot;$image&quot;
  update_result=$?
  logInfo &quot;å½“å‰æœåŠ¡çŠ¶æ€: &quot;
  docker stack services $stack
  # æ›´æ–°å¤±è´¥
  if [ $update_result -eq 1 ]; then
    logError &quot;æ›´æ–°å¤±è´¥ï¼Œç¡®å®šæ˜¯å¦éœ€è¦å›æ»šæœåŠ¡&quot;
    docker service ls --format=&quot;{{.Image}}&quot; | grep -E &quot;^$image$&quot;
    find_image=$?
    if [ $find_image -eq 0 ]; then
      logInfo &quot;å¼€å§‹å›æ»šæœåŠ¡ï¼š$service_name&quot;
      docker service rollback &quot;$service_name&quot;
      logInfo &quot;å›æ»šå®Œæˆï¼Œè¾“å‡ºæœåŠ¡çŠ¶æ€ï¼š(å¯æ‰‹åŠ¨ç¡®è®¤æœåŠ¡çŠ¶æ€)&quot;
      docker service ls
    else
      logInfo &quot;æ— éœ€å›æ»š&quot;
    fi
    # ç›´æ¥é€€å‡º
    logError &quot;æ›´æ–°å¤±è´¥ï¼Œå³å°†é€€å‡ºï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡é•œåƒæ˜¯å¦æ­£å¸¸&quot;
    return 1
  fi
  # æ›´æ–°æˆåŠŸï¼Œå¼€å§‹æ›´æ–°æœ¬åœ°ymléƒ¨ç½²è„šæœ¬
  logInfo &quot;å¼€å§‹æ›´æ–°æœ¬åœ°ymléƒ¨ç½²è„šæœ¬&quot;
  update_service_yaml_config &quot;$stack&quot; &quot;$service&quot; &quot;$image&quot;
}

# æ›´æ–°æœ¬åœ°çš„ymlæ–‡ä»¶é…ç½®
function update_service_yaml_config() {
  # è¦æ›´æ–°çš„stack
  stack=$1
  # è¦æ›´æ–°çš„æœåŠ¡
  service=$2
  # æœåŠ¡çš„é•œåƒ
  image=$3
  if [ -z &quot;$stack&quot; ]; then
    logError &quot;stack å‚æ•°ä¸èƒ½ä¸ºç©º&quot;
    return 1
  fi
  if [ -z &quot;$service&quot; ]; then
    logError &quot;service å‚æ•°ä¸èƒ½ä¸ºç©º&quot;
    return 1
  fi
  if [ -z &quot;$image&quot; ]; then
    logError &quot;image å‚æ•°ä¸èƒ½ä¸ºç©º&quot;
    return 1
  fi
  service_name=&quot;${stack}_${service}&quot;

  # æŸ¥æ‰¾éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶(æ ¹æ®æœåŠ¡åæŸ¥æ‰¾ï¼Œæ’é™¤armï¼‰
  # -H è¾“å‡ºåŒ¹é…çš„æ–‡ä»¶è·¯å¾„
  # -v è¿‡æ»¤æ‰ arm
  # -print0 | xargs -0 ç”¨äºå¤„ç†æ–‡ä»¶åä¸­å¯èƒ½å­˜åœ¨çš„ç‰¹æ®Šå­—ç¬¦
  # è¿™é‡Œ /b:/b çš„åŒ¹é…æ¨¡å¼ ç¡®ä¿æœ‰ç©ºæ ¼çš„æƒ…å†µä¸‹å°½å¯èƒ½çš„åŒ¹é…åˆ°service
  # å®Œæˆåè¾“å‡ºç±»ä¼¼å¦‚ä¸‹ï¼š
  # ./graphql/docker-compose-20210325.yml:  graphql-engine:
  # ./graphql/docker-compose.yml:  graphql-engine:
  # è·å–éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
  #   IFS=&quot; &quot; read -r -a file_list &lt;&lt;&lt; find . -type f -name &quot;*.yml&quot; -print0 | xargs -0 -I {} grep -H &quot;$service *: *$&quot; {} | grep -v &quot;arm&quot; | awk -F: '{print $1}' | tr &quot;\n&quot; &quot; &quot;
#  file_list=($(find . -type f -name &quot;*.yml&quot; -print0 | xargs -0 -I {} grep -H &quot;$service *: *$&quot; {} | grep -v &quot;arm&quot; | awk -F: '{print $1}' | tr &quot;\n&quot; &quot; &quot;))
# ä¸Šé¢å˜é‡çš„å†™æ³•åœ¨gitlab-runnerä¸Šæœ‰é—®é¢˜
#  for file in &quot;${file_list[@]}&quot;; do
  for file in $(find . -type f -name &quot;*.yml&quot; -print0 | xargs -0 -I {} grep -H &quot;$service *: *$&quot; {} | grep -v &quot;arm&quot; | awk -F: '{print $1}' | tr &quot;\n&quot; &quot; &quot;); do
    logInfo å¼€å§‹ä¿®æ”¹æ–‡ä»¶:&quot;$file&quot;
    # è·å–æ–‡ä»¶ä¸­çš„é•œåƒå…¨å &quot; *&quot; åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼
    # æ³¨æ„ï¼šè¿™é‡Œé€šè¿‡æœåŠ¡åç§°æ¥æŸ¥æ‰¾é•œåƒåç§°ï¼Œé€šè¿‡ grep -A 4 å¤šè¾“å‡ºå››è¡Œï¼Œç„¶ååœ¨è¿™å››è¡Œä¸­å¯»æ‰¾imageæ®µï¼Œä»è€Œè·å–æ–‡ä»¶ä¸­å¯¹åº”serviceçš„imageçš„å…¨å
    raw_image=$(grep -A 4 &quot;$service *: *$&quot; &quot;$file&quot; | grep image | sed 's/.*image: *//g')
    logInfo &quot;å¤‡ä»½æ–‡ä»¶: $file.bak&quot;
    #    cp -f &quot;$file&quot; &quot;$file.bak&quot;
    # å¼€å§‹ä¿®æ”¹æ–‡ä»¶
    sed &quot;$(getSedOption)&quot; &quot;s|$raw_image|$image|g&quot; &quot;$file&quot;
    if [ $? -eq 0 ]; then
      confirm_ed_result=$(grep &quot;$image&quot; &quot;$file&quot;)
      if [ -n &quot;$confirm_ed_result&quot; ]; then
        logInfo &quot;ä¿®æ”¹æˆåŠŸ&quot;
        logInfo &quot;æœåŠ¡æ›´æ–°å®Œæˆ&quot;
      else
        logError &quot;æ–‡ä»¶ä¿®æ”¹å¤±è´¥&quot;
      fi
    else
      logError &quot;æ–‡ä»¶ä¿®æ”¹å¤±è´¥&quot;
    fi
  done
}

# å¯¼å‡ºæ‰€æœ‰é•œåƒ
function export_all_images() {
  export_images graphql
  export_images kafka
  export_images &quot;gpl-datacollection&quot;
}

echo &quot;å¯¼å…¥éƒ¨ç½²è„šæœ¬æˆåŠŸ&quot;

</code></pre>
<h3 id="è°ƒæŸ¥">è°ƒæŸ¥</h3>
<p>è§‚å¯Ÿå¦‚ä¸‹ä¸€ä¸ªå…·ä½“çš„deployçš„jobï¼Œæˆ‘ä»¬å¯ä»¥æœ‰å¦‚ä¸‹æå–æ–¹å‘ï¼š</p>
<ol>
<li>å°†æ•´ä¸ªjobéƒ½æå–å‡ºå»ï¼›</li>
<li>å°†scriptæ®µæå–å‡ºæ¥ï¼›</li>
<li>å°†éƒ¨ç½²ä»»åŠ¡é›†ä¸­åˆ°ä¸€ä¸ªå•ç‹¬çš„éƒ¨ç½²é¡¹ç›®ï¼Œå„ä¸ªæœåŠ¡æ¨¡å—æ›´æ–°åè§¦å‘éƒ¨ç½²é¡¹ç›®è¿›è¡Œéƒ¨ç½²ï¼›</li>
</ol>
<pre><code class="language-yaml">deploy:
  stage: deploy
  script:
    - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin
    - cd $DEPLOY_PATH
    #- sudo chmod 777 -R $DEPLOY_PATH   éœ€è¦è‡ªè¡Œä½¿ç”¨rootç”¨æˆ·æ·»åŠ æƒé™
    - echo &quot;$SERVICE_NAME&quot;
    - echo &quot;$DEPLOY_PATH&quot;
    - echo &quot;$DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA&quot;
    - source deploy.sh
    - update_service $DOCKER_NAMESPACE $SERVICE_NAME $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA
  environment:
    name: test_env_deploy
    url: $APP_URL/
  when: manual
  only:
    - branches
    - web
  tags:
    - deploy_graphql
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¸¦ç€ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜æ¥å¯»æ‰¾ç›¸å…³çš„æŠ€æœ¯æ”¯æŒ - å³ï¼šgitlabèƒ½å¸®åŠ©æˆ‘ä»¬åšåˆ°å“ªäº›åŠä»€ä¹ˆç¨‹åº¦ï¼Ÿ</p>
<p>ç»è¿‡ç®€å•çš„è°ƒæŸ¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œgitlabciçš„é…ç½®ä¸­ï¼Œæœ‰ä¸€ä¸ª<code>include</code> çš„é…ç½®å¯ä»¥å¼•å…¥å¤–éƒ¨çš„yamlï¼Œæˆ‘ä»¬è¯¦ç»†äº†è§£ä¸‹è¿™ä¸ªé…ç½®ï¼ˆ<a href="https://docs.gitlab.com/ee/ci/yaml/README.html#include">Keyword reference for the .gitlab-ci.yml file | GitLab</a>ï¼‰</p>
<p>è€Œæå–è„šæœ¬æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¡®å®šå¯ä»¥å®ç°çš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸äºˆè°ƒæŸ¥ï¼›</p>
<h4 id="include"><strong>include</strong></h4>
<p><strong>ç”¨é€”ï¼š</strong></p>
<ol>
<li>åœ¨cié…ç½®ä¸­å¯¼å…¥å¤–éƒ¨çš„yamlé…ç½®ï¼›</li>
<li>æ‹†åˆ†é•¿çš„é…ç½®ï¼Œæå‡å¯è¯»æ€§ï¼›</li>
<li>æå–å…¬å…±çš„é…ç½®ï¼Œå‡å°‘é‡å¤é…ç½®ï¼›</li>
<li>æ‹†åˆ†æ”¾ç½®åˆ°ä¸­å¿ƒä»“åº“ï¼Œåœ¨å…¶ä»–é¡¹ç›®ä¸­å¼•å…¥ï¼›</li>
</ol>
<p><strong>æ”¯æŒçš„æº</strong>ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">Keyword</th>
<th style="text-align:left">Method</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://docs.gitlab.com/ee/ci/yaml/README.html#includelocal"><code>local</code></a></td>
<td style="text-align:left">æœ¬é¡¹ç›®ä¸­çš„æ–‡ä»¶</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.gitlab.com/ee/ci/yaml/README.html#includefile"><code>file</code></a></td>
<td style="text-align:left">å¼•å…¥å…¶ä»–é¡¹ç›®ä¸­çš„æ–‡ä»¶</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.gitlab.com/ee/ci/yaml/README.html#includeremote"><code>remote</code></a></td>
<td style="text-align:left">å¼•å…¥è¿œç¨‹çš„URLä¸­çš„æ–‡ä»¶ï¼ˆå¿…é¡»èƒ½è¢«å…¬å¼€è®¿é—®åˆ°ï¼‰</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.gitlab.com/ee/ci/yaml/README.html#includetemplate"><code>template</code></a></td>
<td style="text-align:left">å¼•å…¥Gitlabæä¾›çš„æ¨¡æ¿æ–‡ä»¶</td>
</tr>
</tbody>
</table>
<p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦æŸ¥çœ‹<code>file</code>- å³å¦‚ä½•å¼•å…¥å…¶ä»–é¡¹ç›®ä¸­çš„æ–‡ä»¶ï¼›</p>
<p><strong>åŸºæœ¬ç”¨æ³•ï¼š</strong>ï¼ˆéœ€è¦ä½¿ç”¨projectæŒ‡å®šé¡¹ç›®ï¼‰</p>
<p>é¡¹ç›®çš„åœ°å€æ˜¯ç›¸å¯¹äºæ ¹ç›®å½•ï¼ˆ<code>/</code>ï¼‰</p>
<pre><code class="language-yaml">include:
  - project: 'my-group/my-project'
    file: '/templates/.gitlab-ci-template.yml'
</code></pre>
<p><strong>æŒ‡å®šåˆ†æ”¯/Tag/æäº¤ï¼š</strong>(é€šè¿‡refæŒ‡å®š)</p>
<pre><code class="language-yaml">include:
  - project: 'my-group/my-project'
    ref: main
    file: '/templates/.gitlab-ci-template.yml'

  - project: 'my-group/my-project'
    ref: v1.0.0
    file: '/templates/.gitlab-ci-template.yml'

  - project: 'my-group/my-project'
    ref: 787123b47f14b552955ca2786bc9542ae66fee5b  # Git SHA
    file: '/templates/.gitlab-ci-template.yml'
</code></pre>
<p><strong>åŒæ—¶å¼•å…¥å¤šä¸ªæ–‡ä»¶ï¼š</strong>ï¼ˆfileä¸­ä½¿ç”¨æ•°ç»„è¯­æ³•ï¼‰</p>
<pre><code class="language-yaml">include:
  - project: 'my-group/my-project'
    ref: main
    file:
      - '/templates/.builds.yml'
      - '/templates/.tests.yml'
</code></pre>
<p><strong>åµŒå¥—å¼•å…¥ï¼š</strong></p>
<p>æ‰€æœ‰åµŒå¥—çš„includeséƒ½åœ¨å½“å‰ç›®æ ‡é¡¹ç›®çš„èŒƒå›´å†…æ‰§è¡Œï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨local (ç›¸å¯¹äºç›®æ ‡é¡¹ç›®), project, remote, æˆ–è€… template includesã€‚</p>
<ul>
<li>
<p>å¯ä»¥æœ€å¤šæœ‰ 100 ä¸ª includesï¼›</p>
</li>
<li>
<p>ä¸èƒ½æœ‰é‡å¤çš„include</p>
</li>
<li>
<p>åœ¨<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/28212">GitLab 12.4</a> åŠåç»­ç‰ˆæœ¬ä¸­, è§£ææ‰€æœ‰æ–‡ä»¶çš„æ—¶é—´è¢«é™åˆ¶åœ¨30ç§’ä¹‹å†…ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è€ƒè™‘æ–‡ä»¶çš„å¤æ‚åº¦ï¼›</p>
</li>
</ul>
<p><strong>æƒé™ï¼š</strong></p>
<p>æ‰§è¡Œäººéœ€è¦å…·æœ‰é¡¹ç›®çš„æƒé™ï¼›</p>
<p>All <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#nested-includes">nested includes</a> are executed only with the permission of the user, so itâ€™s possible to use project, remote or template includes.</p>
<h4 id="trigger">trigger</h4>
<p>gitlabå¯ä»¥ä½¿ç”¨triggeræ¥è§¦å‘å¤šé¡¹ç›®æ„å»ºï¼Œåœ¨gitlab-cié…ç½®ä¸­ï¼Œå¯ä»¥ä½¿ç”¨triggeræ¥å®šä¹‰ä¸€ä¸ªä¸‹æ¸¸æµæ°´çº¿çš„è§¦å‘å™¨ï¼Œå½“Gitlabå¯åŠ¨è¿™ä¸ªtriggerçš„ä»»åŠ¡æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä¸‹æ¸¸æµæ°´çº¿ï¼›</p>
<p>å¯¹æ¯”äºæ­£å¸¸çš„ä»»åŠ¡ï¼Œtriggerç±»å‹çš„ä»»åŠ¡åªæœ‰å°‘é‡å…³é”®å­—å¯ä»¥ä½¿ç”¨ï¼›</p>
<p>Gitlabä¸­å¯ä½¿ç”¨triggeråˆ›å»ºä¸¤ç§ç±»å‹çš„ä¸‹æ¸¸æµæ°´çº¿ï¼š</p>
<ol>
<li>å¤šé¡¹ç›®æµæ°´çº¿ï¼š è§¦å‘å…¶ä»–é¡¹ç›®çš„æµæ°´çº¿ï¼›</li>
<li>å­æµæ°´çº¿ï¼š è§¦å‘å½“å‰é¡¹ç›®çš„æµæ°´çº¿ï¼›</li>
</ol>
<p><strong>å¤šé¡¹ç›®æµæ°´çº¿çš„è§¦å‘ä»»åŠ¡åŸºæœ¬å†™æ³•ï¼š</strong></p>
<pre><code class="language-yaml">rspec:
  stage: test
  script: bundle exec rspec

staging:
  stage: deploy
  trigger: my/deployment
</code></pre>
<p><strong>å¤šé¡¹ç›®æµæ°´çº¿çš„è§¦å‘ä»»åŠ¡å¤æ‚å†™æ³•ï¼š</strong></p>
<ul>
<li>
<p>é€šè¿‡branchæŒ‡å®šåˆ†æ”¯</p>
<pre><code class="language-yaml">rspec:
  stage: test
  script: bundle exec rspec

staging:
  stage: deploy
  trigger:
    project: my/deployment
    branch: stable
</code></pre>
</li>
<li>
<p>é•œåƒä¸‹æµæµæ°´çº¿çš„çŠ¶æ€(é€šè¿‡è®¾ç½®<code>strategy: depend</code>,é»˜è®¤æƒ…å†µä¸‹ï¼Œè§¦å‘å™¨ä»»åŠ¡ä¼šè¢«æ ‡è®°ä¸ºæˆåŠŸï¼Œè®¾ç½®æ­¤æ ‡è®°åï¼Œåˆ™ä¼šç­‰å¾…ä¸‹æ¸¸æµæ°´çº¿æ‰§è¡Œå®Œæˆï¼Œç„¶åä½¿ç”¨ä¸‹æµæµæ°´çº¿çš„çŠ¶æ€æ¥æ ‡è®°è¯¥è§¦å‘å™¨ä»»åŠ¡çš„çŠ¶æ€)</p>
<pre><code class="language-yaml">trigger_job:
trigger:
  project: my/project
  strategy: depend
</code></pre>
</li>
<li>
<p>åœ¨ä¸‹æ¸¸æµæ°´çº¿ä¸­ï¼Œä¹Ÿå¯ä»¥è·å–ä¸Šæ¸¸æµæ°´çº¿çš„çŠ¶æ€</p>
<pre><code class="language-shell">upstream_bridge:
  stage: test
  needs:
    pipeline: other/project
</code></pre>
</li>
</ul>
<p><strong>å­æµæ°´çº¿çš„å†™æ³•ï¼š</strong></p>
<ul>
<li>
<p>æŒ‡å®šé¡¹ç›®ä¸­çš„YAMLæ–‡ä»¶çš„è·¯å¾„å³å¯åˆ›å»ºå­æµæ°´çº¿</p>
<pre><code class="language-shell">trigger_job:
  trigger:
    include: path/to/child-pipeline.yml
</code></pre>
</li>
<li>
<p>åŒæ ·çš„ï¼Œä¹Ÿå¯ä»¥è®¾ç½®è·å–ä¸‹æ¸¸çŠ¶æ€</p>
<pre><code class="language-yaml">trigger_job:
  trigger:
    include:
      - local: path/to/child-pipeline.yml
    strategy: depend
</code></pre>
</li>
<li>
<p>å¯ä»¥ä½¿ç”¨å…¶ä»–é¡¹ç›®ä¸­çš„YAMLæ–‡ä»¶æ¥å®šä¹‰å­æµæ°´çº¿</p>
<pre><code class="language-yaml">child-pipeline:
  trigger:
    include:
      - project: 'my-group/my-pipeline-library'
        ref: 'main'
        file: '/path/to/child-pipeline.yml'
</code></pre>
</li>
<li>
<p>å¯ä»¥ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®æ¥ç”Ÿæˆå­æµæ°´çº¿(å‚è€ƒï¼š<a href="https://docs.gitlab.com/ee/ci/parent_child_pipelines.html#dynamic-child-pipelines">Parent-child pipelines | GitLab</a>)</p>
<pre><code class="language-yaml">generate-config:
  stage: build
  script: generate-ci-config &gt; generated-config.yml
  artifacts:
    paths:
      - generated-config.yml

child-pipeline:
  stage: test
  trigger:
    include:
      - artifact: generated-config.yml
        job: generate-config
</code></pre>
</li>
</ul>
<h3 id="æ•´ä½“æ–¹æ¡ˆ">æ•´ä½“æ–¹æ¡ˆ</h3>
<p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>gitlabæ”¯æŒé€šè¿‡<code>include</code>æ¥å¼•å…¥å¤–éƒ¨çš„è„šæœ¬ï¼Œè„šæœ¬å¯ä»¥æ¥è‡ªäºæœ¬é¡¹ç›®ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªäºå…¶ä»–é¡¹ç›®ï¼›</li>
<li>é€šè¿‡<code>trigger</code>å¯ä»¥è§¦å‘å…¶ä»–é¡¹ç›®çš„æµæ°´çº¿æˆ–è€…åœ¨æœ¬é¡¹ç›®ä¸­ç”Ÿæˆä¸€ä¸ªå­æµæ°´çº¿ï¼Œå¯ä»¥é€‰æ‹©è·Ÿè¸ªå­æµæ°´çº¿çš„æ‰§è¡ŒçŠ¶æ€ï¼›</li>
</ul>
<p>ç»è¿‡å¦‚ä¸Šåˆ†æï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨å¦‚ä¸‹æ–¹æ¡ˆå¯¹ç°æœ‰éƒ¨ç½²éœ€æ±‚è¿›è¡Œå®æ–½ï¼š</p>
<svg width="982px" height="690px" viewBox="0 0 982 690" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="ğŸ¶-colorlesséƒ¨ç½²ç­–ç•¥" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="PPT" transform="translate(-417.000000, -233.000000)">
            <g id="colorless" transform="translate(863.000000, 481.000000)">
                <g id="æ¶æ„å›¾/æ ‡é¢˜/å¸¦æ æ¡†/åœ†è§’">
                    <g id="åˆ†ç»„">
                        <rect id="è¾¹æ¡†æ " stroke="#FF9500" x="0.5" y="0.5" width="226" height="155" rx="6"></rect>
                        <path d="M6,0 L221,0 C224.313708,-1.44363618e-14 227,2.6862915 227,6 L227,32 L227,32 L0,32 L0,6 C4.82366169e-16,2.6862915 2.6862915,1.4968968e-15 6,0 Z" id="æ ‡é¢˜æ " fill="#FF9500"></path>
                    </g>
                    <text id="æ ‡é¢˜" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.107999999" fill="#FFFFFF">
                        <tspan x="35.5778135" y="22">colorlesséƒ¨ç½²ä»“åº“</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-2" transform="translate(42.000000, 78.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="142" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="43.0598756" y="21.5">éƒ¨ç½²æœåŠ¡</tspan>
                    </text>
                </g>
            </g>
            <g id="TokenManager" transform="translate(417.000000, 233.000000)">
                <g id="æ¶æ„å›¾/æ ‡é¢˜/å¸¦æ æ¡†/åœ†è§’">
                    <g id="åˆ†ç»„">
                        <rect id="è¾¹æ¡†æ " stroke="#FF9500" x="0.5" y="0.5" width="260" height="149" rx="6"></rect>
                        <path d="M6,0 L255,0 C258.313708,-6.08718376e-16 261,2.6862915 261,6 L261,32 L261,32 L0,32 L0,6 C-4.05812251e-16,2.6862915 2.6862915,6.08718376e-16 6,0 Z" id="æ ‡é¢˜æ " fill="#FF9500"></path>
                    </g>
                    <text id="æ ‡é¢˜" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.107999999" fill="#FFFFFF">
                        <tspan x="66.0686269" y="22">TokenManager</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’" transform="translate(34.000000, 52.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="69.826" y="21.5">æ„å»ºJAR</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½" transform="translate(34.000000, 99.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="44.745" y="21.5">æ‰“åŒ…Dockeré•œåƒ</tspan>
                    </text>
                </g>
                <path id="ç›´çº¿" d="M131,82 L131,90 L135,90 L130.5,99 L126,90 L130,90 L130,82 L131,82 Z" fill="#979797" fill-rule="nonzero"></path>
            </g>
            <g id="RESTAPI" transform="translate(417.000000, 413.000000)">
                <g id="æ¶æ„å›¾/æ ‡é¢˜/å¸¦æ æ¡†/åœ†è§’">
                    <g id="åˆ†ç»„">
                        <rect id="è¾¹æ¡†æ " stroke="#FF9500" x="0.5" y="0.5" width="260" height="149" rx="6"></rect>
                        <path d="M6,0 L255,0 C258.313708,-6.08718376e-16 261,2.6862915 261,6 L261,32 L261,32 L0,32 L0,6 C-4.05812251e-16,2.6862915 2.6862915,6.08718376e-16 6,0 Z" id="æ ‡é¢˜æ " fill="#FF9500"></path>
                    </g>
                    <text id="æ ‡é¢˜" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.107999999" fill="#FFFFFF">
                        <tspan x="95.9576269" y="22">RestAPI</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’" transform="translate(34.000000, 52.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="69.826" y="21.5">æ„å»ºJAR</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½" transform="translate(34.000000, 99.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="44.745" y="21.5">æ‰“åŒ…Dockeré•œåƒ</tspan>
                    </text>
                </g>
                <path id="ç›´çº¿" d="M131,82 L131,90 L135,90 L130.5,99 L126,90 L130,90 L130,82 L131,82 Z" fill="#979797" fill-rule="nonzero"></path>
            </g>
            <g id="GraphQLAPI" transform="translate(417.000000, 593.000000)">
                <g id="æ¶æ„å›¾/æ ‡é¢˜/å¸¦æ æ¡†/åœ†è§’">
                    <g id="åˆ†ç»„">
                        <rect id="è¾¹æ¡†æ " stroke="#FF9500" x="0.5" y="0.5" width="260" height="149" rx="6"></rect>
                        <path d="M6,0 L255,0 C258.313708,-6.08718376e-16 261,2.6862915 261,6 L261,32 L261,32 L0,32 L0,6 C-4.05812251e-16,2.6862915 2.6862915,6.08718376e-16 6,0 Z" id="æ ‡é¢˜æ " fill="#FF9500"></path>
                    </g>
                    <text id="æ ‡é¢˜" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.107999999" fill="#FFFFFF">
                        <tspan x="69.7226269" y="22">GraphQLAPIå¼•æ“</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’" transform="translate(34.000000, 52.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="82.846" y="21.5">æ„å»º</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½" transform="translate(34.000000, 99.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="44.745" y="21.5">æ‰“åŒ…Dockeré•œåƒ</tspan>
                    </text>
                </g>
                <path id="ç›´çº¿" d="M131,82 L131,90 L135,90 L130.5,99 L126,90 L130,90 L130,82 L131,82 Z" fill="#979797" fill-rule="nonzero"></path>
            </g>
            <g id="å…¶ä»–æœåŠ¡" transform="translate(417.000000, 773.000000)">
                <g id="æ¶æ„å›¾/æ ‡é¢˜/å¸¦æ æ¡†/åœ†è§’">
                    <g id="åˆ†ç»„">
                        <rect id="è¾¹æ¡†æ " stroke="#FF9500" x="0.5" y="0.5" width="260" height="149" rx="6"></rect>
                        <path d="M6,0 L255,0 C258.313708,-6.08718376e-16 261,2.6862915 261,6 L261,32 L261,32 L0,32 L0,6 C-4.05812251e-16,2.6862915 2.6862915,6.08718376e-16 6,0 Z" id="æ ‡é¢˜æ " fill="#FF9500"></path>
                    </g>
                    <text id="æ ‡é¢˜" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.107999999" fill="#FFFFFF">
                        <tspan x="83.7086269" y="22">å…¶ä»–æœåŠ¡â€¦</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’" transform="translate(34.000000, 52.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="82.846" y="21.5">æ„å»º</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½" transform="translate(34.000000, 99.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#34C759" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="44.745" y="21.5">æ‰“åŒ…Dockeré•œåƒ</tspan>
                    </text>
                </g>
                <path id="ç›´çº¿" d="M131,82 L131,90 L135,90 L130.5,99 L126,90 L130,90 L130,82 L131,82 Z" fill="#979797" fill-rule="nonzero"></path>
            </g>
            <path id="ç›´çº¿-2" d="M792.124777,345 L792.124,566.999 L845,566.999 L845,559 L864,568.5 L845,578 L845,569.999 L789.124777,570 L789.124,347.999 L642,348 L642,345 L792.124777,345 Z" fill="#AFAFAF" fill-rule="nonzero"></path>
            <path id="ç›´çº¿-3" d="M676.006644,509.993385 L677.50663,510.000015 L790.631407,510.500015 L792.124777,510.506615 L792.124,567 L845,567 L845,559 L864,568.5 L845,578 L845,570 L789.124777,570 L789.124,513.492 L677.49337,512.999985 L675.993385,512.993356 L676.006644,509.993385 Z" fill="#AFAFAF" fill-rule="nonzero"></path>
            <path id="ç›´çº¿-4" d="M845,559 L864,568.5 L845,578 L845,570 L792.301,570 L792.301081,707 L642,707 L642,704 L789.301,704 L789.301081,567 L845,567 L845,559 Z" fill="#AFAFAF" fill-rule="nonzero"></path>
            <path id="ç›´çº¿-5" d="M845,559 L864,568.5 L845,578 L845,570 L792.301,570 L792.301081,889 L642,889 L642,886 L789.301,886 L789.301081,567 L845,567 L845,559 Z" fill="#AFAFAF" fill-rule="nonzero"></path>
            <text id="è§¦å‘" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.6264844" fill="#6272A4">
                <tspan x="710" y="340">è§¦å‘</tspan>
            </text>
            <text id="è§¦å‘å¤‡ä»½" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.6264844" fill="#6272A4">
                <tspan x="710" y="506">è§¦å‘</tspan>
            </text>
            <text id="è§¦å‘å¤‡ä»½-2" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.6264844" fill="#6272A4">
                <tspan x="710" y="700">è§¦å‘</tspan>
            </text>
            <text id="è§¦å‘å¤‡ä»½-3" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.6264844" fill="#6272A4">
                <tspan x="710" y="882">è§¦å‘</tspan>
            </text>
            <g id="éƒ¨ç½²æœºå™¨" transform="translate(1195.000000, 463.000000)">
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-2">
                    <rect id="æ ‡é¢˜æ¡†" fill="#AF52DE" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="67.649" y="21.5">postgres</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-3" transform="translate(0.000000, 46.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#AF52DE" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="80.095" y="21.5">redis</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-4" transform="translate(0.000000, 92.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#AF52DE" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="41.847" y="21.5">graphql-engine</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-5" transform="translate(0.000000, 138.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#AF52DE" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="45.69" y="21.5">graphql-token</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-6" transform="translate(0.000000, 184.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#AF52DE" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="41.476" y="21.5">graphql-restapi</tspan>
                    </text>
                </g>
                <g id="æ¶æ„å›¾/æ ‡é¢˜/çº¯æ ‡é¢˜/ç›´è§’å¤‡ä»½-7" transform="translate(0.000000, 228.000000)">
                    <rect id="æ ‡é¢˜æ¡†" fill="#AF52DE" x="0" y="0" width="193" height="31"></rect>
                    <text id="æ ‡é¢˜" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing="0.153999999" fill="#FFFFFF">
                        <tspan x="89.048" y="21.5">â€¦</tspan>
                    </text>
                </g>
            </g>
            <path id="ç›´çº¿-6" d="M1161,565 L1180,574.5 L1161,584 L1161,576 L1089,576 L1089,573 L1161,573 L1161,565 Z" fill="#979797" fill-rule="nonzero"></path>
            <text id="deploy" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.6264844" fill="#6272A4">
                <tspan x="1104" y="562">deploy</tspan>
            </text>
            <g id="æ¶æ„å›¾/æ ‡é¢˜/å¸¦æ æ¡†/åœ†è§’" transform="translate(1179.000000, 418.500000)">
                <g id="åˆ†ç»„">
                    <rect id="è¾¹æ¡†æ " stroke="#FF9500" x="0.5" y="0.5" width="219" height="318" rx="6"></rect>
                    <path d="M6,0 L214,0 C217.313708,-6.08718376e-16 220,2.6862915 220,6 L220,32 L220,32 L0,32 L0,6 C-4.05812251e-16,2.6862915 2.6862915,6.08718376e-16 6,0 Z" id="æ ‡é¢˜æ " fill="#FF9500"></path>
                </g>
                <text id="æ ‡é¢˜" font-family="PingFangSC-Regular, PingFang SC" font-size="18" font-weight="normal" letter-spacing="0.107999999" fill="#FFFFFF">
                    <tspan x="72.5016166" y="22">éƒ¨ç½²æœºå™¨</tspan>
                </text>
            </g>
        </g>
    </g>
</svg>
<ol>
<li>æ¯ä¸ªé¡¹ç›®åˆ†åˆ«å®šä¹‰è‡ªå·±çš„æ„å»ºå’Œé•œåƒæ‰“åŒ…ä»»åŠ¡ï¼›</li>
<li>é•œåƒæ‰“åŒ…å®Œæˆåé€šè¿‡<code>trigger</code>æ¥è§¦å‘colorlesséƒ¨ç½²ä»“åº“çš„éƒ¨ç½²ä»»åŠ¡ï¼Œéœ€è¦ä¼ é€’è‡ªå·±çš„ä¿¡æ¯ç»™éƒ¨ç½²ä»“åº“ç”Ÿæˆçš„æµæ°´çº¿ï¼›</li>
<li>è§¦å‘ä»»åŠ¡çš„å®šä¹‰æ–‡ä»¶æ”¾ç½®åˆ°colorlesséƒ¨ç½²ä»“åº“ä¸­ï¼Œåœ¨å„ä¸ªæœåŠ¡é¡¹ç›®ä¸­é€šè¿‡<code>include</code>æ¥å¼•å…¥ï¼›</li>
</ol>
<h2 id="ä¼˜åŒ–æ–¹æ¡ˆå®ç°">ä¼˜åŒ–æ–¹æ¡ˆå®ç°</h2>
<p>å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å°†éƒ¨ç½²æ“ä½œé›†ä¸­åˆ°ä¸€ä¸ªå•ç‹¬é¡¹ç›®ä¸­ï¼Œè€Œåˆå„ä¸ªæœåŠ¡é¡¹ç›®è§¦å‘å…¶éƒ¨ç½²æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°†è¿™ä¸ªå•ç‹¬çš„ç”¨äºéƒ¨ç½²çš„é¡¹ç›®ç§°ä¸ºç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ï¼Œå°†å…¶ä»–æœåŠ¡çš„é¡¹ç›®ç§°ä¹‹ä¸ºå­æœåŠ¡é¡¹ç›®ï¼›ä»¥ä¸‹åˆ†åˆ«è¯´æ˜ä¸Šè¿°æ–¹æ¡ˆä¸­ä¸¤ç§é¡¹ç›®ä¸­çš„é…ç½®æ–¹å¼ï¼›</p>
<h3 id="å„å­æœåŠ¡é¡¹ç›®çš„é…ç½®">å„å­æœåŠ¡é¡¹ç›®çš„é…ç½®</h3>
<h4 id="gitlab-ciymlé…ç½®">gitlab-ci.ymlé…ç½®</h4>
<p>æˆ‘ä»¬å°†éƒ¨ç½²ä»»åŠ¡æ›¿æ¢ä¸ºä¸€ä¸ªè§¦å‘ä»»åŠ¡ï¼Œå¹¶ä»ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ä¸­å¼•å…¥ä»»åŠ¡çš„é…ç½®</p>
<pre><code class="language-yaml">stages:
  - test
  - build
  - build_image
  - auto-build-deploy

# çœç•¥å…¶ä»–å®šä¹‰

# å¼•å…¥è§¦å‘è‡ªåŠ¨ç¼–è¯‘éƒ¨ç½²ä»»åŠ¡é…ç½® 
include:
  - project: 'Deptproduct-project/colorless/colorless-deploy'
    # ref: master
    file: '/ci/gitlab-ci-base.yml'
</code></pre>
<p>è¿™æ®µé…ç½®ä¼šä» <code>Deptproduct-project/colorless/colorless-deploy</code> é¡¹ç›®ä¸­å¯¼å…¥ <code>/ci/gitlab-ci-base.yml</code> çš„é…ç½®ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-yaml"># å­æ¨¡å—ç”¨çš„å…¬ç”¨è§¦å‘é¡¹ç›®ï¼Œå¯ä»¥åœ¨å­æ¨¡å—æºç ä¸­ include
trigger:auto-build-deploy:
  stage: auto-build-deploy
  variables:
    TRIGGER_CI_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA
    #  é…ç½®ä»“åº“ç¯å¢ƒ
    # è‡ªå®šä¹‰å˜é‡å¿…é¡»é…ç½®åœ¨ä¸Šæ¸¸UIç•Œé¢
    DOCKER_REGISTRY: $DOCKER_REGISTRY
    DOCKER_NAMESPACE: $DOCKER_NAMESPACE
    HARBOR_PWD: $HARBOR_PWD
    HARBOR_USER: $HARBOR_USER
    SERVICE_NAME: $SERVICE_NAME
  trigger:
    project: Deptproduct-project/colorless/colorless-deploy
</code></pre>
<p>åœ¨å­é¡¹ç›®ä¸­çš„cié…ç½®ä¸­<code>include</code>è¯¥æ–‡ä»¶æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªè§¦å‘ä»»åŠ¡ï¼Œè¿™ä¸ªè§¦å‘ä»»åŠ¡ä¼šè§¦å‘<code>Deptproduct-project/colorless/colorless-deploy</code>è¿™ä¸ªé¡¹ç›®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ï¼›</p>
<p>ä¹Ÿå°±æ˜¯è¯´ä¼šè§¦å‘æˆ‘ä»¬ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ç”Ÿæˆä¸€ä¸ªæµæ°´çº¿ï¼Œæ­¤æ—¶æµæ°´çº¿è¯»å–çš„å°±æ˜¯æˆ‘ä»¬ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®çš„<code>.gitlab-ci.yml</code> æ–‡ä»¶ï¼›</p>
<h4 id="web-uiä¸­cicdå˜é‡é…ç½®">web UIä¸­CI/CDå˜é‡é…ç½®</h4>
<p>ä¸Šè¿°çš„è§¦å‘ä»»åŠ¡çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‡ ä¸ªå˜é‡ï¼Œç”¨äºå‘éƒ¨ç½²é¡¹ç›®çš„æµæ°´çº¿è¯´æ˜æˆ‘ä»¬è‡ªèº«çš„ä¸€äº›ä¿¡æ¯</p>
<pre><code class="language-yaml">    TRIGGER_CI_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA
    DOCKER_REGISTRY: $DOCKER_REGISTRY
    DOCKER_NAMESPACE: $DOCKER_NAMESPACE
    HARBOR_PWD: $HARBOR_PWD
    HARBOR_USER: $HARBOR_USER
    SERVICE_NAME: $SERVICE_NAME
</code></pre>
<p>å…¶ä¸­ï¼Œç”±æˆ‘ä»¬è‡ªè¡Œå®šä¹‰çš„å˜é‡ï¼ˆ<code>$DOCKER_REGISTRY</code>,<code>DOCKER_NAMESPACE</code>,<code>$HARBOR_PWD</code>,<code>$HARBOR_USER</code>,<code>$SERVICE_NAME</code>ï¼‰éœ€è¦åœ¨é¡¹ç›®/ç¾¤ç»„çš„CIçš„å˜é‡ä¸­è¿›è¡Œé…ç½®ï¼Œåœ¨è§£ææ­¤è§¦å‘ä»»åŠ¡æ—¶æ‰å¯ä»¥è¯»å–åˆ°ï¼›</p>
<figure data-type="image" tabindex="10"><img src="https://s2.loli.net/2022/05/26/tLyelhx2DPbznmV.png" alt="202203192303519" loading="lazy"></figure>
<h3 id="ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®çš„é…ç½®">ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®çš„é…ç½®</h3>
<h4 id="gitlab-ciyml-é…ç½®-2">gitlab-ci.yml é…ç½®</h4>
<pre><code class="language-yaml">variables:
#  UIç•Œé¢é…ç½® DEPLOY_PATH
  DEPLOY_PATH: /Wksp/colorlessWork/colorless-deploy/deploy/
#  éƒ¨ç½²çš„stack
  DOCKER_STACK: colorless

deploy:
  stage: deploy
  script:
    - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin
    - cd $DEPLOY_PATH
    - source deploy.sh
    - update_service $DOCKER_STACK $SERVICE_NAME $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$TRIGGER_CI_COMMIT_SHORT_SHA
  environment:
    name: test_env_deploy
    url: $APP_URL/
  when: manual
  tags:
    - deploy_graphql
</code></pre>
<h4 id="web-uiä¸­cicdå˜é‡é…ç½®-2">web UIä¸­CI/CDå˜é‡é…ç½®</h4>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº›éƒ¨ç½²ç›¸å…³çš„å˜é‡éœ€è¦ä»å­æœåŠ¡é¡¹ç›®ä¸­æå–åˆ°å½“å‰ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ä¸­æ¥å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼š<code>DEPLOY_PATH</code>,<code>DOCKER_STACK</code>,<code>APP_URL</code>ï¼Œå…¶ä¸­<code>DEPLOY_PATH</code>,<code>DOCKER_STACK</code>æˆ‘ä»¬åœ¨ymlä¸­æœ‰å®šä¹‰é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸åœ¨UIç•Œé¢ä¸­è¿›è¡Œå®šä¹‰ï¼Œåªéœ€è¦åœ¨UIç•Œé¢ä¸­å®šä¹‰APP_URLå³å¯ï¼›</p>
<h3 id="è¿è¡Œæ•ˆæœè¯´æ˜">è¿è¡Œæ•ˆæœè¯´æ˜</h3>
<ol>
<li>æ¯æ¬¡å­æœåŠ¡é¡¹ç›®ä¸­æäº¤ä»£ç ï¼Œä¸”æ»¡è¶³cié…ç½®ä¸­å®šä¹‰çš„æ¡ä»¶æ—¶ï¼Œå³ä¼šç”Ÿæˆä¸€ä¸ªè§¦å‘ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œå‰æœŸé˜¶æ®µçš„ä»»åŠ¡åï¼Œå½“æ‰§è¡Œè§¦å‘ä»»åŠ¡æ—¶ï¼Œå°±ä¼šè§¦å‘æˆ‘ä»¬çš„ç‹¬ç«‹ä»“åº“çš„éƒ¨ç½²ä»»åŠ¡ã€‚å…·ä½“ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼›</li>
</ol>
<figure data-type="image" tabindex="11"><img src="https://s2.loli.net/2022/05/26/dQ9ZWJeE7GOcqYz.png" alt="20210526155720" loading="lazy"></figure>
<ol start="2">
<li>ç‚¹å‡»ä¸‹æ¸¸ä»»åŠ¡å³å¯è·³è½¬åˆ°æˆ‘ä»¬çš„ç‹¬ç«‹éƒ¨ç½²ä»“åº“ä¸­å¯¹åº”çš„æµæ°´çº¿ä¸­ï¼›</li>
</ol>
<figure data-type="image" tabindex="12"><img src="https://s2.loli.net/2022/05/26/38HPnbIrW17AiUY.png" alt="202203192305536" loading="lazy"></figure>
<ol start="3">
<li>
<p>ç‚¹å‡»deployä»»åŠ¡çš„è¿è¡ŒæŒ‰é’®ï¼Œå³å¯è¿›è¡Œéƒ¨ç½²ï¼›</p>
</li>
<li>
<p>éƒ¨ç½²å®Œæˆåï¼Œå¯åœ¨ç‹¬ç«‹éƒ¨ç½²ä»“åº“ä¸­ç”Ÿæˆä¸€ä¸ªéƒ¨ç½²ç¯å¢ƒï¼Œç‚¹å‡»å³å¯å‰å¾€ï¼›</p>
<figure data-type="image" tabindex="13"><img src="https://s2.loli.net/2022/05/26/Xf8ygsvLGwIzbqE.png" alt="202203192306371" loading="lazy"></figure>
</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Dockeræ•°æ®ç›®å½•(/var/lib/docker)è¿ç§»]]></title>
        <id>https://hanlyjiang.github.io/post/Dockeræ•°æ®ç›®å½•è¿ç§»/</id>
        <link href="https://hanlyjiang.github.io/post/Dockeræ•°æ®ç›®å½•è¿ç§»/">
        </link>
        <updated>2021-04-21T08:51:40.000Z</updated>
        <summary type="html"><![CDATA[<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•å®‰å…¨çš„è¿ç§»Dockerçš„æ•°æ®ç›®å½•/var/lib/docker</p>
]]></summary>
        <content type="html"><![CDATA[<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•å®‰å…¨çš„è¿ç§»Dockerçš„æ•°æ®ç›®å½•/var/lib/docker</p>
<!-- more -->
<h2 id="ä¸ºä»€ä¹ˆè¦è¿ç§»">ä¸ºä»€ä¹ˆè¦è¿ç§»</h2>
<ul>
<li>è™šæ‹Ÿæœºåˆ›å»ºæ—¶ï¼Œä¸€èˆ¬åˆ†é…ä¸€ä¸ªæ¯”è¾ƒå°çš„ç³»ç»Ÿç›˜ï¼Œç„¶åæŒ‚è½½ä¸€ä¸ªå¤§å®¹é‡çš„æ•°æ®ç›˜ï¼Œdockeré»˜è®¤æƒ…å†µä¸‹æ•°æ®å­˜å‚¨åœ¨ç³»ç»Ÿç›˜(/var/lib/docker)ç›®å½•ï¼Œæ—¶é—´ä¸€ä¹…ï¼Œä¼šå æ»¡ç³»ç»Ÿç›˜ã€‚</li>
</ul>
<h2 id="è¿ç§»æ­¥éª¤">è¿ç§»æ­¥éª¤</h2>
<ol>
<li><strong>é¦–å…ˆéœ€è¦åœæ­¢dockeræœåŠ¡</strong></li>
</ol>
<pre><code>systemctl stop docker
</code></pre>
<ol start="2">
<li><strong>é€šè¿‡å‘½ä»¤df -h å…ˆå»çœ‹ä¸‹ç£ç›˜å¤§æ¦‚çš„æƒ…å†µï¼Œæ‰¾ä¸€ä¸ªå¤§çš„ç©ºé—´</strong></li>
<li><strong>åˆ›å»ºdockerçš„æ–°ç›®å½•ï¼Œæˆ‘è¿™è¾¹æ‰¾äº†data, æ‰€ä»¥æˆ‘è¿™è¾¹çš„æ–°ç›®å½•åœ°å€æ˜¯ /data/docker/lib/</strong></li>
</ol>
<pre><code>

mkdir -p /data/docker/lib
</code></pre>
<blockquote>
<p>æ³¨ï¼šå‚æ•°-p ç¡®ä¿ç›®å½•åç§°å­˜åœ¨ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨çš„å°±æ–°åˆ›å»ºä¸€ä¸ªã€‚</p>
</blockquote>
<ol start="4">
<li><strong>å¼€å§‹è¿ç§»</strong></li>
</ol>
<pre><code>rsync -avzP /var/lib/docker /data/docker/lib/
</code></pre>
<blockquote>
<p>å…ˆç¡®è®¤æ˜¯å¦å®‰è£…äº†rsync.</p>
</blockquote>
<p>å‚æ•°è§£é‡Šï¼š</p>
<ul>
<li>-aï¼Œå½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºé€’å½’ä¼ è¾“å¹¶ä¿æŒæ–‡ä»¶å±æ€§ã€‚</li>
<li>-vï¼Œæ˜¾ç¤ºrsyncè¿‡ç¨‹ä¸­è¯¦ç»†ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨&quot;-vvvv&quot;è·å–æ›´è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li>-Pï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¼ è¾“çš„è¿›åº¦ä¿¡æ¯ã€‚(å®é™…ä¸Š&quot;-P&quot;=&quot;--partial --progress&quot;ï¼Œå…¶ä¸­çš„&quot;--progress&quot;æ‰æ˜¯æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯çš„)ã€‚</li>
<li>-z,Â  Â ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©æé«˜æ•ˆç‡ã€‚</li>
</ul>
<ol start="5">
<li><strong>æŒ‡å®šæ–°çš„dockerç›®å½•</strong></li>
</ol>
<pre><code>vim /lib/systemd/system/docker.service
</code></pre>
<p>åœ¨ExecStartåŠ å…¥:</p>
<pre><code>Â --graph=/data/docker/lib/docker
</code></pre>
<ol start="6">
<li><strong>é‡å¯docker</strong></li>
</ol>
<pre><code>sudo systemctl daemon-reload
sudoÂ systemctl restart docker
sudoÂ systemctl enable docker # è¿è¡Œdockerè‡ªåŠ¨å¯åŠ¨ï¼Œè¿™é‡Œå¯ä»¥ä¸æ‰§è¡Œ
</code></pre>
<ol start="7">
<li><strong>å¯åŠ¨ä¹‹åç¡®è®¤docker æ²¡æœ‰é—®é¢˜ï¼Œç¡®è®¤ä¹‹å‰çš„å®¹å™¨å’Œé•œåƒéƒ½è¿˜åœ¨ï¼Œç„¶ååˆ é™¤æ—§çš„/var/lib/docker/ç›®å½•</strong></li>
</ol>
<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« ï¼š</h2>
<ul>
<li><a href="https://www.cnblogs.com/insist-forever/p/11739207.html?fileGuid=qQhpHWDVq8HrH9kj">https://www.cnblogs.com/insist-forever/p/11739207.html</a></li>
</ul>
]]></content>
    </entry>
</feed>