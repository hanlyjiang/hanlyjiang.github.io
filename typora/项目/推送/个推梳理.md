# 个推

## 能力梳理

### 消息形式

  个推消息推送支持通知和透传两种形式。同时支持==大图、大文本等富媒体==展示，支持启动应用、打开第三方链接、打开应用内特定页面等后续操作等后续操作。

**1.通知**

  指定通知标题和内容后，由个推SDK自动处理后、在系统通知栏中以通知栏消息的形式展示，同时响铃或震动提醒用户(响铃和震动受手机系统的设置状态影响)。

**2.透传**

  即自定义消息，消息体格式客户可以自己定义，如纯文本、json串等。透传消息个推只传递数据，不做任何处理，客户端接收到透传消息后需要自己去做后续动作处理，如通知栏展示、弹框等。

  ### 推送目标

  个推支持通过标签、别名、CID、用户分组四种方式来管理目标用户设置，开发者可根据自身业务需求灵活使用。

**1.全部用户（All）**

  即选择向APP的全体用户（所有已经安装该APP的用户）发送推送，通常适用于APP公告、更新升级等推送场景。

**2.标签（Tag）**

  标签是用户的一种属性，用于描述用户的基础属性、兴趣爱好、行为特征等，在给某些用户设置某类标签后，就可以通过标签圈选具有共同特征的特定用户群，实现精准推送。比如给喜欢“足球”打上“足球”标签后，我们就可以通过圈选“足球”标签，给喜欢足球的用户，发送精准推送。

  详情见：[名词解释-标签](https://docs.getui.com/getui/more/word/)
  使用说明见：[用户API-标签](https://docs.getui.com/getui/server/rest_v2/user/)

> 标签是用户的一种属性，用于描述用户的基础属性、兴趣爱好、行为特征等，在给某些用户设置某类标签后，就可以通过标签圈选具有共同特征的特定用户群，实现精准推送。比如给喜欢“足球”打上“足球”标签后，我们就可以通过圈选“足球”标签，给喜欢足球的用户，发送精准推送。
>
> - 单个标签长度最大为32字节，单个ClientID标签总长度最大为512字节，单个ClientID最多设置100个标签。
> - 两次调用标签接口的时间间隔需大于1s。
> - 标签的设定支持除英文逗号和空格以外键盘上的所有字符。
> - 标签的设定，一定要在获取到ClientID之后才可以设定。支持应用端和服务端调用接口实现标签的设定，设定成功后，可在个推开发者中心-配置管理-应用标签，查看应用的标签、导出各标签下的CID列表。
> - 可在个推开发者中心-配置管理-应用标签，查看应用的标签、导出各标签下的CID列表。

**3.别名（Alias）**

  别名是APP为用户取的标识，该标识可以是APP业务层的用户标识，也可以是用户的昵称等。APP运营人员为用户绑定别名后，可以通过别名圈选目标用户组，方便APP运营同学快速、便捷地向特定的某群用户推送消息。

  详情见：[名词解释-别名](https://docs.getui.com/getui/more/word/)
  使用说明见：[用户API-别名](https://docs.getui.com/getui/server/rest_v2/user/)

> 别名是APP为用户取的标识，该标识可以是APP业务层的用户标识，也可以是用户的昵称等。为用户绑定别名后，可以通过别名圈选目标用户组，方便APP运营同学快速、便捷地向特定的某群用户推送消息。
>
> - 有效的别名组成：长度最长为40字节，支持中、英文（区分大小写）、数字、下划线。
> - 服务端调用接口即可实现别名的绑定，一个CID只能绑定一个别名，重复绑定以最后一次为准，两次调用别名绑定接口的时间间隔需大于1s；一个别名最多可以绑定10个CID。
> - 应用场景1：个推CID为32位，较长，运营同学发推送时不便获取、使用CID时，可通过别名圈选用户。
> - 应用场景2：同一个设备上的同一个APP，只有1个CID，切换多个账号登陆时直接用CID发送推送，可能导致多个账号的推送信息串行，影响用户体验、泄露用户隐私；将账号设置为别名，并且切换账号时，需要解绑旧的账号，设置新的账号为别名，通过别名发送推送，就能确保收到推送的用户，即为当前登录的用户，避免消息串行。
> - 应用场景3：同一个账号（比如手机号）分别登陆在 A、B、C 三台设备上的同一个 APP， 产生了 3 个不同的 CID, 想让这三台设备同时接收到推送，就可以考虑使用该接口，让三台设备的三个 CID都绑定同一个别名也就是你的账号（比如手机号），最多支持 10 台设备，也就是最多绑定 10 个 CID。

**4.ClientID（简称CID）**

  个推业务中的对外用户标识，用于标识客户端身份，由APP获取并保存到开发者服务端，是个推SDK的唯一标识。

**5.用户分组**

  用户可以事先通过个推提供的省市地区标签、用户属性标签或自己设定的应用标签，筛选出目标用户成立用户分组，在推送时直接选取某一用户分组作为推送目标，能够方便快捷地实现对特定用户群的推送。

  使用说明见：[开发者中心使用说明](https://docs.getui.com/getui/start/devcenter/)

> APP可将特定某些用户添加至同一个用户分组，推送的时候，选择该用户分组，即可向该组内的所有用户推送消息。
>
> - 可以通过个推开发者中心-消息推送-配置管理-用户分组，对用户分组进行管理，支持通过标签圈选用户分组。
> - 应用场景：APP可能经常会向具有某几个标签特征的用户推送消息，通过标签圈选将这些用户添加至一个用户分组，每次推送的时候直接选择该用户组即可，无需再进行标签圈选。

### 厂商集成

#### 功能说明

功能说明：个推整合适配版目前已整合**小米、华为、魅族、OPPO、vivo、锤子、索尼、海信**等厂商通道，开发者可以一次性接入多家厂商的推送 SDK，或者选择性接入，支持 maven 配置，集成简单、维护方便。并且支持智能判断下发通道，可极大提升消息送达率。

应用场景：**应用运行在后台、锁屏、应用被杀死时，通过厂商通道下发消息，提升消息送达率**。

使用说明：前往[下载中心](https://docs.getui.com/download.html)下载个推SDK，参照[厂商应用开通指南](https://docs.getui.com/getui/mobile/vendor/vendor_open/)及个推Android[集成指南](https://docs.getui.com/getui/mobile/android/androidstudio/)开通、集成多厂商推送。

#### 厂商推送策略

功能说明：支持每条消息自选下发通道，支持智能判断设备是否在线、是否有厂商模块（华为、小米等），以此来判断推送请求是否走厂商通道，以及走哪个厂商通道，最大化地下发、送达消息。

应用场景：设置下发通道的优先级，先走个推还是先走厂商，只走个推还是只走厂商等。

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210724121907.png" alt="img" style="zoom:50%;" />

厂商消息推送默认逻辑：消息推送的时候，设备应用在线，走个推渠道下发，离线走厂商渠道下发。个推和厂商渠道支持设置五种消息类型，个推渠道目前都支持，厂商支持情况不一，下面具体介绍下各厂商的情况：

- 通知+启动应用：都支持；
- 通知+网页：都支持；
- 通知+intent：都支持；
- ==通知+透传：华为、oppo渠道不支持；==
- ==纯透传：魅族、oppo、vivo不支持；华为、小米离线情况下，消息存离线库，消息有效期内SDK在线以后下发。==

> 注:==目前厂商渠道建议使用通知+intent方式。==

## Android端使用

![image-20210523190647357](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210724110500.png)

### 基础流程:

1. 注册获取GETUI_APPID,配置到项目Manifest
2. 配置通知图标(push.png/push_small.png),可选配置多套资源(如:push1.png)
3. 实现 消息回调Service(继承 `com.igexin.sdk.GTIntentService`)并注册到Manifest,用于接收消息及事件通知
4. 调用初始化方法进行初始化(`com.igexin.sdk.PushManager.getInstance().initialize(Context context)`)

### 回调接口

**GTIntentService**

* 推送进程启动: `onReceiveServicePid`
* ==获取CID== :  `onReceiveClientId`
* 获取厂商 Token: `onReceiveDeviceToken`
* 接收透传消息: `onReceiveMessageData`
* 通知到达: `onNotificationMessageArrived`
* 通知点击: `onNotificationMessageClicked`
* 命令回执: `onReceiveCommandResult`
* 监听在线状态: `onReceiveOnlineState`

### 主动接口

**PushManager**

*  开启推送: `turnOnPush`
* 关闭推送: `turnOffPush`
* 设置静默时间: `setSilentTime`
* 获取缓存CID: `getClientid`
* 获取 SDK 服务状态: `isPushTurnedOn`
* 发送自定义回执: `sendFeedbackMessage`
* 设置标签: `setTag`
* 绑定别名: `bindAlias`
* 解绑别名: `unBindAlias`
* 发送 Applink 点击回执: `sendApplinkFeedback`



## 限制

> 单个ClientID标签总长度最大为512字节

### 别名

- 命名: 
  - 长度最长为40字节
  - 支持：中文、英文字母（区分大小写）、数字、下划线、除英文逗号以外的其他特殊符号
- 绑定/解绑调用限制:  
  - 重复绑定以最后一次为准，两次调用的间隔需大于 1s，每天限制调用 100 次(**APP?**)
  - 一个CID一天绑定别名和解绑别名次数各有50次机会
  - 一个别名下最多绑定10个CID，若超出10个，则绑定后者，剔除第一个已绑定的CID，以此类推；一个CID只能绑定一个别名，若超出则以最后一次绑定的别名为准。

### 标签

* 命名:
  * 标签名称：长度32字节，中文、英文字母（大小写）、数字、除英文逗号以外的其他特殊符号
* 调用限制:
  * 标签的设定，一定要在获取到CID之后才可以设定。
  * 默认一天只能成功设置一次（可联系技术支持进行修改）(**APP?**)
  * 两次调用标签接口的时间间隔需大于1s。
  * 一个CID一天默认绑定只有一次标签绑定次数。
  * **一个CID默认可支持100个标签，标签的绑定是全量覆盖的，后面一次的覆盖前面一次的 。**

### 厂商

> * [Android常见问题-个推文档中心 (getui.com)](https://docs.getui.com/getui/question/android/) - 安卓厂商消息分类

#### 厂商收不到消息可能的限制

- 华为
  - 标题长度限制40个字，内容长度限制1024个字。
  - emui10的华为手机，检查手机通知权限设置，将【营销通知】的权限也打开，不要默认静默，静默的话是需要下拉通知栏才能看到。
  - 手机通知栏消息是否有存满，清除已存的通知栏消息看下新的消息是否能展示。
  - 服务端Intent中指定的Activity，在客户端manifest里面是否配置exported=true属性，若未配置会影响华为机型的消息展示。
  - 主动或者被动将APP杀死，则华为系统会清空对应APP的通知栏消息。
- VIVO
  - 标题长度限制20个字，内容长度限制50个字。
  - 检查通知权限，vivo机型默认关闭
  - vivo【运营消息】，一个设备一天只能收到5条离线消息
  - 1个自然日内相同文案的运营消息给同个设备发，vivo会在客户端做去重处理，导致消息不展示
  - vivo要求：通知文案中不能带 “包含测试、test字符”、“纯数字”、“纯表情”、“符号”或者“符号+数
    字”、“表情+数字”、“表情＋符号”
- 小米
  - 标题长度限制50个字，内容长度限制128个字。
  - 检查手机通知权限设置，小米有不重要通知功能，部分消息可能会存在通知栏不重要通知里
  - 服务端推送时，推送代码要加上ttl的离线时间设置，不能为空。
- OPPO
  - 标题长度限制32个字，内容长度限制200个字。
  - 检查手机通知权限是否打开，oppo是默认关闭的，将通知权限下的【Default】通道权限也打开。
  - 手机系统时间是否正常
- 魅族
  - 标题长度限制32个字，内容长度限制100个字。
  - 检查消息是否存入了魅族手机右上角【魅族消息盒子】中。
  - 清除缓存：手机【系统设置】-【应用管理】-【所有应用】点击右上角【显示系统服务应用】找到【推送服务】和【您自己的 App】，如下图，分别进行“清除数据”，然后重启手机。



#### 厂商通道限额

参考:  [厂商通道限额说明-个推文档中心 (getui.com)](https://docs.getui.com/getui/question/qps/)

### 其他

#### 消息推送频次限制

- **推送条数限制**：没有限制！
- **单推（toSingle）频次限制**：没有限制！
- **批量推（toList）频次限制**：200万次/天。
- **群推（toAPP）频次限制**：100次/天，每分钟不能超过5次，10分钟内不能推重复消息体 。

#### 厂商支持的消息类型限制

厂商消息推送默认逻辑：消息推送的时候，设备应用在线，走个推渠道下发，离线走厂商渠道下发。个推和厂商渠道支持设置五种消息类型，个推渠道目前都支持，厂商支持情况不一，下面具体介绍下各厂商的情况：

- 通知+启动应用：都支持；
- 通知+网页：都支持；
- 通知+intent：都支持；（离线）
- ==通知+透传：华为、oppo渠道不支持；==
- ==纯透传：魅族、oppo、vivo不支持；华为、小米离线情况下，消息存离线库，消息有效期内SDK在线以后下发。==

> 注:==目前厂商渠道建议使用通知+intent方式。==

#### Android权限配置

参考:  [SDK权限配置说明-个推文档中心 (getui.com)](https://docs.getui.com/getui/question/sdk/)



#### 合规指引

**App使用个推SDK时的合规指引** 　

1. 在使用个推SDK产品时，开发者需在App《隐私政策》的 “与授权合作伙伴共享”条款中，将[个推用户隐私政策](http://docs.getui.com/privacy/)加入其中，并向终端用户逐一明示您嵌入的SDK收集使用个人信息的目的、方式和范围。具体请参考文档中心合规指引：https://docs.getui.com/compliance 　

2. 您应确保在App首次运行时通过明显方式提示终端用户阅读您的《隐私政策》并取得终端用户的合法授权后，再初始化SDK进行信息收集与处理。 　为帮助开发者高效制定隐私政策，个推针对不同细分领域的App整理输出了各个类型的App隐私政策模板，供开发者参考使用。 下载地址：http://docs.getui.com/templet 　同时，我们也建议您对接入的个推SDK版本进行更新。 　SDK下载地址：http://docs.getui.com/download.html 　

3. 如果您和您的用户请求访问、更正、补充其用户信息，或要求行使删除权、更改其授权同意的范围等，您可以查看《个推隐私政策》，或联系个推用户信息保护负责人邮箱[support@getui.com](mailto:support@getui.com)，向我们提出相关请求。

## 其他

### CID什么情况下会变化

- 用户超过三个月未登录，CID会置为无效CID，若再次登录会重新生成一个CID；
- 如果应用没有获取sd卡权限，卸载重装/清除缓存，CID会变（CID信息会写入sd卡）。
- 个推Appid参数、应用的包名、苹果Bundleid的修改。
- 苹果手机则是进行了越狱或系统还原。

