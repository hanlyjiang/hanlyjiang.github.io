# 本文档内容总体说明

**更新记录**

| 时间       | 内容                                                         |
| ---------- | ------------------------------------------------------------ |
| 2021/03/16 | 创建文档                                                     |
| 2021/03/23 | 添加GeoPanel服务容器编排及可视化部署运维系统的章节<br/>添加社管e通打包壳维护章节<br/>添加GeoPanel-移动中心-代码同步章节 |
| 2021/03/25 | 补充arm镜像构建中交叉构建与运行的相关问题及建议              |
| 2021/03/26 | 添加移动中心国产化镜像制作相关内容                           |
| 2021/03/29 | 添加Gitlab&持续集成&效率工具章节                             |
| 2021/03/30 | 添加Gitlab相关的安装配置及使用文档                           |
| 2021/03/31 | 添加整理Gitlab CI自动化相关文档及内容                        |
| 2021/04/01 | 补充Gitlab使用中常见的问题及技巧<br/>补充使用gitlab-ci的缓存加速构建的方式 |





可能需要交接的工作内容概览如下，后面会按照这个内容大纲来一一梳理：

```mermaid
graph LR

A[工作内容]

A --> MOA
A --> Gitlab
A --> Docker
A --> SGET

MOA[MOA移动中心] --> 代码同步
MOA --> APP打包&系统部署
MOA --> APP定制化修改
MOA --> 简化框架

Gitlab[Gitlab&持续集成&效率工具]
Gitlab --> 服务维护
Gitlab --> Gitlab&Sonar使用问题解答与解决
Gitlab --> CI[基于Gitlab CI的自动化流程]

Docker[GeoPanel容器化]

Docker --> 镜像制作
Docker --> 服务编排
Docker --> 国产化镜像制作

SGET[项目维护] 
SGET --> 社管e通系列

```



# GeoPanel容器化概览

此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。

主要包括如下部分：

```mermaid
graph 

GeoPanel[GeoPanel容器化]
GeoPanel --> pgspider打包
GeoPanel --> hasura-块数据API引擎
GeoPanel --> 公司自研镜像打包
GeoPanel --> 服务编排
```

* 由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出；
* 公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说；
* 服务编排中描述当前已经容器化的服务及使用swarm编排的情况；



# GeoPanel容器化-ARM镜像构建-通用步骤

这里的国产化主要指：制作arm版本的镜像

## 前言

移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；

1. ARM 版本Docker安装；
2. 构建所有镜像的ARM版本；

## 测试机信息

| CPU      | FT-1500A 4核 arm64 |
| :------- | :----------------- |
| 内存     | 8G                 |
| OS       | 麒麟V10            |
| 包管理器 | apt                |

## ARM机器上安装Docker

>[Docker官方文档](https://docs.docker.com/engine/install/?fileGuid=0l3NVKX0BgflYN3R)

Docker支持如下系统及架构

![图片](https://uploader.shimo.im/f/EgAMxl7X6CbHg4J9.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R)

国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按[官方文档- Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/?fileGuid=0l3NVKX0BgflYN3R)进行安装。

### 查看系统信息

```plain
geostar@geostar-ft1500a:~$ cat /proc/version
Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
```

这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源

### 添加软件源

>参考：
>https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/
>https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/

添加清华镜像软件源（arm架构）

```plain
# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
```

更新：

```plain
sudo apt-get install apt-transport-https
sudo apt-get clean
sudo apt-get update
```

### 安装Docker

```plain
# 卸载旧版本docker
sudo apt-get remove docker docker-engine docker.io containerd runc
sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
    
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88)
sudo apt-key fingerprint 0EBFCD88
```

编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存

```plain
# https://docs.docker.com/engine/install/ubuntu/
deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable
```

安装 docker

```plain
sudo apt-get update
# 安装Docker
sudo apt-get install docker-ce docker-ce-cli containerd.io
# 安装成功，查看版本
docker --version
Docker version 19.03.12, build 48a6621
```

## 在Dockerhub上查找已有的arm镜像

实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以[postgres](https://hub.docker.com/_/postgres?fileGuid=0l3NVKX0BgflYN3R)为例，在dockerhub上可以看到

![图片](https://uploader.shimo.im/f/mEUtglSoqQESjJXs.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R)

在具体的tag中也可以看到版本的镜像是否支持arm架构

![图片](https://uploader.shimo.im/f/nUbvEcHQlUFCmAkl.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R)

但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。

## ARM版本镜像构建（非ARM机器上执行）

>参考：
>-[https://github.com/docker/cli/blob/master/experimental/README.md](https://github.com/docker/cli/blob/master/experimental/README.md?fileGuid=0l3NVKX0BgflYN3R)
>-[跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R)

### 构建ARM镜像的两种方式

对于构建镜像的ARM版本，有如下两种方式：

1. 在ARM机器上使用 docker build 进行构建；
2. 在X86/AMD64 的机器上使用 docker buildx 进行交叉构建；

实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；

关于第二种构建方式，可先阅读[跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R)进行了解，以下简要介绍使用buildx交叉构建的方式；

> **⚠️注意：**
>
> 1. 交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；
>
> 2. 实际测试发现，使用[qemu方式](https://github.com/multiarch/qemu-user-static)在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；
>
>    上面第二点按如下方式测试： 
>
>    * `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch` 可正常输出；
>    * `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version` 则会**卡住**，且需要使用`docker stop`停止容器才可以退出容器；

### 启用试验性功能

>参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features
>注意：buildx 仅支持 docker19.03 及以上docker版本

如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：

* 编辑   /etc/docker/daemon.json
* 添加：

```json
{
    "experimental": true
}
```

* 编辑 ～/.docker/config.json 添加：

```json
"experimental" : "enabled"
```

* 重启Docker使生效：
  * sudo systemctl  daemon-reload
  * sudo systemctl  restart docker
* 确认是否开启：
  * docker version -f'{{.Server.Experimental}}'
  * 如果输出true，则表示开启成功

### 使用buildx构建

buildx 的详细使用可参考：[Docker官方文档-Reference-buildx ](https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R)

#### 创建 buildx 构建器

使用 docker buildx ls 命令查看现有的构建器

```shell
docker buildx ls
```

创建并构建器：

```shell
# 下面的创建命令任选一条符合情况的即可
# 1. 不指定任何参数创建
docker buildx create --use --name multiarch-builder
# 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令
docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder
# 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 
docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder 
```

buildx-config.toml 配置文件写法类似：

```plain
# https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md
# registry configures a new Docker register used for cache import or output.
[registry."zh-registry.geostar.com.cn"]
  mirrors = ["zh-registry.geostar.com.cn"]
  http = true
  insecure = true
```

**启用构建器**

```shell
# 初始化并激活
docker buildx inspect multiarch-builder --bootstrap
```

**确认成功**

```plain
# 使用 docker buildx ls 查看
docker buildx ls 
```

### 修改Dockerfile

对 Dockerfile 的修改，大致需要进行如下操作：

1. 确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译；
2. 确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件

`ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz`

此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：

`ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz`

当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；

> **提示：**
>
> 怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 `file {可执行文件路径}` 来查看，
>
> 如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-`x86_64&arm64e`：
>
> ```shell
> file $(which git)
> /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
> /usr/bin/git (for architecture x86_64):	Mach-O 64-bit executable x86_64
> /usr/bin/git (for architecture arm64e):	Mach-O 64-bit executable arm64e
> ```
>
> 下面的命令则对一个so文件执行了file，可以看到其中的架构信息 `ARM aarch64`：
>
> ```shell
> file /lib/aarch64-linux-gnu/libpthread-2.23.so
> /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped
> ```

### docker buildx 构建arm64镜像的命令

使用 --platform来指定架构，使用 `--push` 或 `--load` 来指定构建完毕后的动作。

```shell
docker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push 
```

> 提示：当指定多个架构时，只能使用 --push 推送到远程仓库，无法 --load，推送成功后再通过 docker pull --platform 来拉取指定架构的镜像

### 检查构建成果

1. 通过 `docker buildx imagetools inspect` 命令查看镜像信息，看是否有对应的arm架构信息；
2. 实际运行镜像，确认运行正常；（在arm机器上执行）

>提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。



## 在x86上运行arm镜像

可参考 [github/qemu-user-static](https://github.com/multiarch/qemu-user-static) ,简要描述如下：

* 执行如下命令安装：

  `docker run --rm --privileged multiarch/qemu-user-static --reset -p yes`

* 之后即可运行arm版本的镜像，如：

  ```shell
  docker run --rm -t arm64v8/fedora uname -m
  ```

  





# GeoPanel容器化-PGspider镜像构建

## 概览

postgreSQL是一个开源的对象-关系型数据库管理系统，本身提供了x86及arm版本的镜像，那么我们为什么要自己构建对应呢？

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210319141649.png" alt="image-20210319141649673" style="zoom: 50%;" />

因为我们需要使用[pgspider](https://github.com/pgspider/pgspider)，它是给予pg11.6的代码补丁包，所以我们无法直接复用官方的镜像作为基础镜像；

同时，我们还添加了许多pg的插件用于扩展pg的能力，如此，我们必须自行打包pg镜像；

### 镜像需要包括的组件：

| 组件                 | 说明                                                        |
| -------------------- | ----------------------------------------------------------- |
| postgis11.6          | postgreSQL                                                  |
| pgspider             | postgreSQL源码补丁，增强FDW功能                             |
| postgis2.5.3及其依赖 | postgres gis 插件，用于提供geometry相关支持                 |
| postgres_fdw         | postgres_fdw 接入外部postgres数据源                         |
| sqlite_fdw           | sqlite_fdw 接入外部sqlite数据源                             |
| mysql_fdw            | mysql_fdw 接入外部mysql数据源                               |
| oracle_fdw           | oracle_fdw 接入外部oracle数据源                             |
| zdb(es_fdw)          | es_fdw 接入外部es数据源                                     |
| debezium             | 数据库事件转为事件流，配合kafka使用，实现数据实时同步       |
| wal2json             | pg 日志格式转换插件，配合debezium使用，以json格式推送事件流 |



### 整体构建流程

为了构建此镜像，我们制作了若干辅助镜像，包括：

```mermaid
graph 
builder

pgspider-base

postgis-pgspider
```

其中:

* `builder` 镜像为我们的构建器镜像，用做pgspider的编译环境，其中包含pg11.6源码及pgspider源码，及编译好的pg及pgspider，但是我们并未对成果物进行提取，因为此进行要保留所有构建环境，用于后续其他我们附加到pg的插件的构建；
* `pgspider-base` 镜像中安装postgres运行所需要的若干依赖，作为最终镜像构建的基础，避免每次构建镜像都需要执行重复的依赖安装操作；
* `postgis-pgspider` 为我们的最终镜像；基于`pgspider-base`镜像制作，并合并我们使用 `builder` 镜像构建的所有需要的成果文件；

接下来我们详细说明以上几个镜像分别如何构建。



### 现在成果仓库

Gitlab仓库地址：[geopanel-deploy](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider)

> 提示： 可查看[仓库目录中的README.md](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider) 了解更多信息；

目录结构如下：

```shell
pgspider
    ├── Dockerfile-base.dockerfile - 构建pgspider-base镜像的脚本
    ├── Dockerfile-builder.dockerfile - 构建pgspider-builder镜像的脚本
    ├── Dockerfile-source-arm-add.dockerfile - 构建postgis-pgspider镜像的脚本（用于增量构建）
    ├── Dockerfile-source-arm.dockerfile - 构建postgis-pgspider镜像的脚本
    ├── Dockerfile-source.dockerfile - 构建postgis-pgspider镜像的脚本
    ├── README.md
    ├── binary - 我方有修改的预编译的fdw（x86架构）
    │   ├── mysql_fdw
    │   │   ├── mysql_fdw--1.1.sql
    │   │   ├── mysql_fdw.control
    │   │   └── mysql_fdw.so
    │   ├── oracle
    │   │   └── oracle_fdw.so
    │   └── zdblibs
    │       ├── zombodb--1.0.0a1--1.0.0a2.sql
    │       ├── zombodb--1.0.0a2--1.0.0a3.sql
    │       ├── zombodb--1.0.0a3--1.0.0a4.sql
    │       ├── zombodb--1.0.0a4--1.0.0a5.sql
    │       ├── zombodb--1.0.0a5--1.0.0a6.sql
    │       ├── zombodb--1.0.0a6--1.0.0a7.sql
    │       ├── zombodb--1.0.0a7--1.0.0a8.sql
    │       ├── zombodb--1.0.0a8--1.0.0a9.sql
    │       ├── zombodb--1.0.0a9--10-1.0.0a9.sql
    │       ├── zombodb--10-1.0.0--10-1.0.1.sql
    │       ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql
    │       ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql
    │       ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql
    │       ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql
    │       ├── zombodb--10-1.0.0b12--10-1.0.0.sql
    │       ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql
    │       ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql
    │       ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql
    │       ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql
    │       ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql
    │       ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql
    │       ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql
    │       ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql
    │       ├── zombodb--10-1.0.1--10-1.0.2.sql
    │       ├── zombodb--10-1.0.2--10-1.0.3.sql
    │       ├── zombodb--10-1.0.3--10-1.0.4.sql
    │       ├── zombodb--10-1.0.4--10-1.0.5.sql
    │       ├── zombodb--10-1.0.5--4.0.sql
    │       ├── zombodb--4.0.sql
    │       ├── zombodb.control
    │       └── zombodb.so
    ├── binary-arm 我方有修改的预编译的fdw（arm架构）
    │   ├── mysql_fdw
    │   │   ├── mysql_fdw--1.1.sql
    │   │   ├── mysql_fdw.control
    │   │   └── mysql_fdw.so
    │   └── zdblibs
    │       ├── zombodb--1.0.0a1--1.0.0a2.sql
    │       ├── zombodb--1.0.0a2--1.0.0a3.sql
    │       ├── zombodb--1.0.0a3--1.0.0a4.sql
    │       ├── zombodb--1.0.0a4--1.0.0a5.sql
    │       ├── zombodb--1.0.0a5--1.0.0a6.sql
    │       ├── zombodb--1.0.0a6--1.0.0a7.sql
    │       ├── zombodb--1.0.0a7--1.0.0a8.sql
    │       ├── zombodb--1.0.0a8--1.0.0a9.sql
    │       ├── zombodb--1.0.0a9--10-1.0.0a9.sql
    │       ├── zombodb--10-1.0.0--10-1.0.1.sql
    │       ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql
    │       ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql
    │       ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql
    │       ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql
    │       ├── zombodb--10-1.0.0b12--10-1.0.0.sql
    │       ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql
    │       ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql
    │       ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql
    │       ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql
    │       ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql
    │       ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql
    │       ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql
    │       ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql
    │       ├── zombodb--10-1.0.1--10-1.0.2.sql
    │       ├── zombodb--10-1.0.2--10-1.0.3.sql
    │       ├── zombodb--10-1.0.3--10-1.0.4.sql
    │       ├── zombodb--10-1.0.4--10-1.0.5.sql
    │       ├── zombodb--10-1.0.5--4.0.sql
    │       ├── zombodb--4.0.sql
    │       ├── zombodb.control
    │       └── zombodb.so
    ├── config - 数据库配置文件
    │   ├── pg_hba.conf
    │   ├── pg_hba.conf.raw
    │   └── postgresql.conf
    ├── debezium - debezium插件的源码及wal2json的源码
    │   ├── README.md
    │   ├── init-debezium.sh
    │   ├── postgres-decoderbufs.tar.gz
    │   ├── test.sql
    │   └── wal2json-wal2json_1_0.tar.gz
    ├── docker-entrypoint.sh - 入口启动脚本
    ├── draft - 临时文件，可忽略
    │   ├── Dockerfile
    │   ├── Dockerfile-all-in-one.dockerfile
    │   ├── Dockerfile-apt.dockerfile
    │   ├── Dockerfile-postGIS.dockerfile
    │   └── README.md
    ├── initdb-fdw.sh - 初始化fdws脚本
    ├── oracle
    │   ├── instantclient-basic-linux.x64-12.2.0.1.0.zip
    │   ├── instantclient-sdk-linux.x64-12.2.0.1.0.zip
    │   ├── instantclient-sqlplus-linux.x64-12.2.0.1.0.zip
    │   └── oracle_fdw-ORACLE_FDW_2_2_0.tar.gz
    ├── postgis - postgis及其依赖库源码及初始化脚本
    │   ├── CGAL-4.11.2.tar.xz
    │   ├── SFCGAL-1.3.5.tar.gz
    │   ├── boost_1_67_0.tar.gz
    │   ├── gdal-3.0.2.tar.gz
    │   ├── geos-3.8.0.tar.bz2
    │   ├── initdb-postgis.sh
    │   ├── libspatialite-4.3.0a.tar.gz
    │   ├── mpfr-4.0.2.tar.gz
    │   ├── postgis-2.5.2.tar.gz
    │   ├── postgis-2.5.3.tar.gz
    │   ├── proj-6.2.0.tar.gz
    │   └── update-postgis.sh
    └── test.sql - 测试是否正常工作的sql文件

```



## builder镜像构建

builder镜像的打包脚本为 `Dockerfile-builder.dockerfile`，我们使用相同的脚本构建arm及x86版本的镜像；

### 打包命令

```shell
TAG=$(date +%Y%m%d)
# X86 镜像构建
docker build -t pgspider-builder:$TAG -f Dockerfile-builder.dockerfile ./
## arm
docker buildx build \
      --progress plain \
      --platform=linux/arm64 \
      -t pgspider-builder-arm:latest \
      -f Dockerfile-builder.dockerfile ./ --load
```

### 脚本详解

> 文件地址： [Dockerfile-builder.dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-builder.dockerfile)

脚本内容如下，请查看脚本中的注释：

这里需要注意的是，我们编译后的成果其实位于 `/usr/local/pgspider` 目录中，这个后面会用到；

```dockerfile
#
# pgspider 源码构建镜像，包含pgspider源码及中间临时成果，用于后续构建其他fdw及提取pgspider可运行镜像
#
## 使用 debian:stretch-slim 作为基础
FROM debian:stretch-slim
RUN apt-get update && apt-get install -y build-essential git libossp-uuid-dev wget libreadline-dev  zlib1g-dev
## 设置工作目录为app
WORKDIR /app
## 
# 来源 https://github.com/docker-library/postgres/blob/master/11/Dockerfile
## 配置locales为en_US.utf8
RUN set -eux; \
   if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \
       # if this file exists, we're likely in "debian:xxx-slim", and locales are thus being excluded so we need to remove that exclusion (since we need locales)
       grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \
       sed -ri '/\/usr\/share\/locale/d' /etc/dpkg/dpkg.cfg.d/docker; \
       ! grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \
   fi; \
   apt-get update; apt-get install -y locales; rm -rf /var/lib/apt/lists/*; \
   localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
ENV LANG en_US.utf8

## 安装所需依赖
RUN set -eux; \
   apt-get update; \
# install "nss_wrapper" in case we need to fake "/etc/passwd" and "/etc/group" (especially for OpenShift)
# https://github.com/docker-library/postgres/issues/359
# https://cwrap.org/nss_wrapper.html
   apt-get install -y --no-install-recommends libnss-wrapper; \
   rm -rf /var/lib/apt/lists/*
  
## 获取pg11.6源码
RUN wget https://ftp.postgresql.org/pub/source/v11.6/postgresql-11.6.tar.gz
## 获取pgspider的补丁包
RUN wget https://raw.githubusercontent.com/pgspider/pgspider/master/pgspider.patch
## 解压pg
RUN tar xvf postgresql-11.6.tar.gz
## 应用pgspider源码补丁包到pg源码
RUN patch -p1 -d postgresql-11.6 < /app/pgspider.patch
## 开始执行编译，可参考pgspider github页面
RUN cd postgresql-11.6 \
   && ./configure --with-uuid=ossp \
   ## 编译PG并install
   && make && make install \
   ## 编译pgspider_core_fdw 并install
   && cd /app/postgresql-11.6/contrib/pgspider_core_fdw \
   && make && make install \
   ## 编译 pgspider_fdw 并install
   && cd /app/postgresql-11.6/contrib/pgspider_fdw \
   && make && make install \
   ## 编译postgres_fdw并install
   && cd /app/postgresql-11.6/contrib/postgres_fdw \
   && make && make install \
   ## 编译contrib并install
   && cd /app/postgresql-11.6/contrib \
   && make && make install
ENV PATH $PATH:/usr/local/pgspider/bin
```



## base镜像构建

base 镜像的打包脚本为 `Dockerfile-base.dockerfile`，我们使用相同的脚本构建arm及x86版本的镜像；

### 打包命令

```shell
TAG=$(date +%Y%m%d)
# 打包x86版本
docker build -t pgspider-base:$TAG -f Dockerfile-base.dockerfile ./
## arm
docker buildx build \
      --progress plain \
      --platform=linux/arm64 \
      -t pgspider-base-arm:$TAG \
      -f Dockerfile-base.dockerfile ./ --load
      
## 也可使用一条命令构建两个版本的镜像，此时必须在镜像tag中包含可用的docker registry地址，并且使用 `--push` 参数在打包完成后推送镜像到registry
## 完成后再拉取到本地进行测试
docker buildx build \
      --progress plain \
      --platform=linux/arm64,linux/amd64 \
      -t hanlyjiang/pgspider-base-arm:$TAG \
      -f Dockerfile-base.dockerfile ./ --push
```



### 脚本详解

> 脚本在线地址： [gitlab](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-base.dockerfile)

```dockerfile
#
# PGSpider 基础镜像
# 1. 安装需要的依赖，避免后续每次构建时都需要安装（依赖部分可能需要精简）
# 2. 添加对应的postgres用户
FROM debian:stretch-slim

## 安装必要依赖
RUN set -ex; \
	if ! command -v gpg > /dev/null; then \
		apt-get update; \
		apt-get install -y --no-install-recommends \
			gnupg \
			dirmngr \
		; \
		rm -rf /var/lib/apt/lists/*; \
	fi

## 安装依赖，并创建pg需要的用户及组id，创建pg需要的目录并赋予对应的组和id改目录的权限
# explicitly set user/group IDs
RUN set -eux; \
	groupadd -r postgres --gid=999; \
# https://salsa.debian.org/postgresql/postgresql-common/blob/997d842ee744687d99a2b2d95c1083a2615c79e8/debian/postgresql-common.postinst#L32-35
	useradd -r -g postgres --uid=999 --home-dir=/var/lib/postgresql --shell=/bin/bash postgres; \
# also create the postgres user's home directory with appropriate permissions
# see https://github.com/docker-library/postgres/issues/274
	mkdir -p /var/lib/postgresql; \
	chown -R postgres:postgres /var/lib/postgresql

## 添加 gosu 用于后续方便使从root降权限
# grab gosu for easy step-down from root
# https://github.com/tianon/gosu/releases
ENV GOSU_VERSION 1.12
RUN set -eux; \
	savedAptMark="$(apt-mark showmanual)"; \
	apt-get update; \
	apt-get install -y --no-install-recommends ca-certificates wget; \
	rm -rf /var/lib/apt/lists/*; \
	dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \
	wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch"; \
	wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc"; \
	export GNUPGHOME="$(mktemp -d)"; \
	gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \
	gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \
	gpgconf --kill all; \
	rm -rf "$GNUPGHOME" /usr/local/bin/gosu.asc; \
	apt-mark auto '.*' > /dev/null; \
	[ -z "$savedAptMark" ] || apt-mark manual $savedAptMark > /dev/null; \
	apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \
	chmod +x /usr/local/bin/gosu; \
	gosu --version; \
	gosu nobody true

## 配置locale
# make the "en_US.UTF-8" locale so postgres will be utf-8 enabled by default
RUN set -eux; \
	if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \
# if this file exists, we're likely in "debian:xxx-slim", and locales are thus being excluded so we need to remove that exclusion (since we need locales)
		grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \
		sed -ri '/\/usr\/share\/locale/d' /etc/dpkg/dpkg.cfg.d/docker; \
		! grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \
	fi; \
	apt-get update; apt-get install -y --no-install-recommends locales; rm -rf /var/lib/apt/lists/*; \
	localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8
ENV LANG en_US.utf8

## 安装必要依赖库
RUN set -eux; \
	apt-get update; \
	apt-get install -y --no-install-recommends \
# install "nss_wrapper" in case we need to fake "/etc/passwd" and "/etc/group" (especially for OpenShift)
# https://github.com/docker-library/postgres/issues/359
# https://cwrap.org/nss_wrapper.html
		libnss-wrapper \
# install "xz-utils" for .sql.xz docker-entrypoint-initdb.d files
		xz-utils \
	; \
	rm -rf /var/lib/apt/lists/*

## 配置信任的gpg key
RUN set -ex; \
# pub   4096R/ACCC4CF8 2011-10-13 [expires: 2019-07-02]
#       Key fingerprint = B97B 0AFC AA1A 47F0 44F2  44A0 7FCC 7D46 ACCC 4CF8
# uid                  PostgreSQL Debian Repository
	key='B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8'; \
	export GNUPGHOME="$(mktemp -d)"; \
	gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys "$key"; \
	gpg --batch --export "$key" > /etc/apt/trusted.gpg.d/postgres.gpg; \
	command -v gpgconf > /dev/null && gpgconf --kill all; \
	rm -rf "$GNUPGHOME"; \
	apt-key list

ENV PG_MAJOR 11
ENV GOSU_VERSION 1.11

## 添加postgresql软件源仓库
RUN set -ex; \
	\
# see note below about "*.pyc" files
	export PYTHONDONTWRITEBYTECODE=1; \
	\
	dpkgArch="$(dpkg --print-architecture)"; \
	case "$dpkgArch" in \
		amd64 | i386 | ppc64el) \
# arches officialy built by upstream
			echo "deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR" > /etc/apt/sources.list.d/pgdg.list; \
			echo "apt-get update;"; \
			;; \
		*) \
# we're on an architecture upstream doesn't officially build for
# let's build binaries from their published source packages
        echo "deb-src http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR" > /etc/apt/sources.list.d/pgdg.list; \
        ;; \
	esac;

# 添加必要的工具及依赖
RUN apt-get update && apt-get install -y --no-install-recommends unzip wget \
    libreadline-dev \
    libmongoc-1.0-0  \
    libmysql++-dev \
    libsqlite3-dev libspatialite7 \
    libsybdb5 \
    libhiredis-dev \
    freetds-dev freetds-common libcurl4-nss-dev unixodbc-dev  \
    # libaio-dev - oracle_fdw
    libaio-dev \
    && rm -rf /var/lib/apt/lists/*;

```



## pgspider镜像构建

对x86及arm架构，我们分别编写了对应的脚本，其中x86使用 Dockerfile-source.dockerfile 脚本构建，arm使用Dockerfile-source-arm.dockerfile脚本构建；

### 构建命令

```shell
TAG=$(date +%Y%m%d)
docker build -t pgspider-postgis:$TAG -f Dockerfile-source.dockerfile ./
## arm 
docker buildx build \
      --progress plain \
      --build-arg --platform=linux/arm64 \
      -t pgspider-postgis:arm-$TAG \
      -f Dockerfile-source-arm.dockerfile ./ --load
```

### 脚本详解

* pgspider 镜像构建的步骤较多，我们采取分步骤构建的方式使用中间构建过程来减小最终镜像的层数及大小；

* 另外两个平台的构建脚本大体一致，仅有少数过程有差异，我们先使用x86版本的对整体过程进行说明，后面我们会说明两个平台之间的差异；

#### x86 构建脚本

> 提示：脚本中有多个FROM段，此为Docker多阶段构建可以通过[此文章](https://zhuanlan.zhihu.com/p/33795821)进行了解；

主要过程如下：

**第一阶段：**

1. 从builder镜像开始，由于builder镜像中已经包含pg源码还有已经编好的pg及pgspider等，所以我们无需再编译这些；

2. 编译 mysql_fdw 及 sqlite_fdw（注意，其中mysql_fdw其实可以不用了）

3. 安装 oracle_fdw 所需要的依赖（oracle instant client）；

4. 编译postgis，编译postgis需要先编译其依赖（mpfr，boost_1_67_0，CGAL等），这里我们将postgis的所有的依赖及其自身的安装路径都设置为 `/usr/local/pgspider/plugin/postgis`

   ```shell
   ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis
   ```

5. 编译并安装 debezium及wal2json；

6. 使用strip对postgis目录中的所有so库进行大小优化

7. 将预先编译好的 几个fdw的so及配置及sql文件拷贝到指定目录以安装或更新这些fdw；

**第二阶段：**

1. 从 pgspider-base 镜像开始构建；
2. 安装必要的依赖；
3. 从第一阶段拷贝出oracle_instantclient的依赖；（arm版本无此步骤，因为oracle_instantclient不支持arm架构）
4. 从第一阶段拷贝出 /usr/local/pgspider 目录，其中包含了我们之前编译的的成果；
5. 添加各种初始化脚本，并为pg运行做必要的准备，可以参考官方dockerfile；
6. 最后使用 EXPOSE 暴露 5432端口，使用 CMD ["postgres"] 默认启动pg；

```dockerfile
# ---
# 构建融合中心pg镜像(从源码构建）：
# 1. 构建pgspider（pgspider-base镜像中包含）
# 2. 添加若干fdw：mysql_fdw,oracle_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中）
# 3. 添加 postgis
#
# 参考：
# - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one
# ---
## 构建 sqlite_fdw  mysql_fdw  oracle_fdw
#FROM pgspider-builder as build
FROM hanlyjiang/pgspider-builder as build

WORKDIR /app

## PG 主版本
ENV PG_MAJOR 11
ENV PG_VERSION 6

## 安装构建所需的依赖
RUN apt-get update \
    && apt-get install -y automake autoconf libtool pkg-config libssl-dev \
    libsqlite3-dev libsybdb5 freetds-dev freetds-common \
    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \
    # for oracle
    unzip \
#    libmysql++-dev
    libmysql++-dev \
    # libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7
    libspatialite7
#    postgresql-${PG_MAJOR}-python-multicorn python-pip

## 安装 sqlite_fdw
RUN git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw
RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw && make && make install

## 安装 mysql_fdw
RUN git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw
RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw && make && make install

## 安装 Install es_fdw
#RUN pip install pg_es_fdw

## 安装 oracle_fdw
### 安装oracle instantclient
# https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle
ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip
ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip
ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip
RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/
RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/
RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/
RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient
RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so
RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus
ENV ORACLE_HOME=/usr/local/instantclient
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient

#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \
ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/
RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \
    && cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \
    && make && make install

##  POSTGIS 构建
### 安装依赖
RUN apt-get install  -y --no-install-recommends \
    libtool libxml2 libxml2-dev \
    libxslt1.1 libxslt1-dev \
    libjson-c-dev libgmp-dev \
    cmake libmpfr-dev

### 创建临时工作目录
RUN mkdir /app/postgis/
ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis
ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib
ENV PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH

### 构建 mpfr
ADD postgis/mpfr-4.0.2.tar.gz /app/postgis/
RUN cd /app/postgis/mpfr-4.0.2 \
    && ./configure --prefix=$PGIS_INSTALL_PATH \
    && make && make install

### 构建 boost
ADD postgis/boost_1_67_0.tar.gz /app/postgis/
RUN cd /app/postgis/boost_1_67_0  \
    && ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH && ./b2 && ./b2 install

### 构建 CGAL
ADD postgis/CGAL-4.11.2.tar.xz /app/postgis/
RUN cd /app/postgis/CGAL-4.11.2  \
    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install

### 构建 SFCGAL
ADD postgis/SFCGAL-1.3.5.tar.gz /app/postgis/
RUN cd /app/postgis/SFCGAL-1.3.5 \
    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install

### 构建 proj，需要先安装sqlite3
RUN apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev
ADD postgis/proj-6.2.0.tar.gz /app/postgis/
RUN cd /app/postgis/proj-6.2.0  \
    && ./configure --prefix=$PGIS_INSTALL_PATH && make -j$(nproc) && make install

### 构建 gdal
ADD postgis/gdal-3.0.2.tar.gz /app/postgis/
RUN cd /app/postgis/gdal-3.0.2  \
    && ./configure --prefix=$PGIS_INSTALL_PATH \
    # proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同
        --with-proj=$PGIS_INSTALL_PATH \
    && make -j$(nproc) && make install

### 构建 geos
ADD postgis/geos-3.8.0.tar.bz2 /app/postgis/
RUN cd /app/postgis/geos-3.8.0  \
    && ./configure --prefix=$PGIS_INSTALL_PATH  \
    && make -j$(nproc) && make install

### 构建 postgis
ADD postgis/postgis-2.5.3.tar.gz /app/postgis/
RUN cd /app/postgis/postgis-2.5.3  \
    && ./configure --prefix=$PGIS_INSTALL_PATH \
    # 几个config命令直接配置PATH后可以找到，所以不在使用参数配置
#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \
#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \
#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \
        --with-projdir=$PGIS_INSTALL_PATH \
    && make -j$(nproc) && make install


RUN set -ex \
#    && sed -i "s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list \
#    && sed -i "s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g"  /etc/apt/sources.list \
    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev
#    && echo "deb http://deb.debian.org/debian stretch-backports main" >>/etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
      libprotobuf-c-dev \
#      postgresql-12-wal2json \
      protobuf-c-compiler \
      && rm -rf /var/lib/apt/lists/*

## 添加 debezium https://github.com/eulerto/wal2json
ADD debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/
RUN cd /app/debezium/wal2json-wal2json_1_0 \
    && make -j$(nproc) && make install

## 添加 debezium - decoderbufs 研究院修改版本
ADD debezium/postgres-decoderbufs.tar.gz /app/debezium/
RUN cd /app/debezium/postgres-decoderbufs \
    && cd proto \
    && protoc-c --c_out=../src/proto pg_logicaldec.proto \
    && cd .. \
    ## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean
    && make -B -j$(nproc) && make install

## 添加 debezium - decoderbufs 官方版本
#ADD debezium/postgres-decoderbufs-v.1.3.1.Final.tar.gz /app/debezium/
#RUN cd /app/debezium/postgres-decoderbufs-v.1.3.1.Final \
#    && make -j$(nproc) && make install

### 对构建postgis过程中生成的文件进行优化，以减小大小
#### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化
RUN cd $PGIS_INSTALL_PATH/lib \
    && rm *.a \
    && find . -type f -name "lib*.so.*" -exec strip {} +
#    && cd /usr/local/pgspider/plugin/proj/lib \
#    && rm *.a && find . -type f -name "lib*.so.*" -exec strip {} +

## 拷贝mysql
COPY binary/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/
COPY binary/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/
COPY binary/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/
## 拷贝zombodb
COPY binary/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/
COPY binary/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/
COPY binary/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/

## 拷贝oracle fdw
COPY binary/oracle/*.so           /usr/local/pgspider/lib/postgresql/

# ------ 开始构建实际发布的镜像 ------
FROM hanlyjiang/pgspider-base:latest
LABEL maintainer="jianghanghang@geostar.com.cn"

## 设置若干ENV，指示版本信息
# buster 上为12 ，stretch 上为 12
# ENV CDAL_VERSION 12
ENV BOOST_VERSION=1.67.0 \
    PG_MAJOR=11 \
    PG_VERSION=6 \
    POSTGIS_VESION=2.5.3

## 安装必要的依赖（TODO: 部分依赖可能不需要）
RUN set -ex \
#    && sed -i "s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list \
#    && sed -i "s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g"  /etc/apt/sources.list \
    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev
#    && echo "deb http://deb.debian.org/debian stretch-backports main" >>/etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
      curl \
      libcurl3-gnutls \
      libexpat1 \
      libgmp10 \
      libgmpxx4ldbl \
      libjson-c3 \
      # buster 上为6，stretch上为4
#      libmpfr6 \
#      libmpfr4 \
      libprotobuf-c1 \
      libtiff5 \
      libxml2 \
      # for debezium
      postgresql-12-wal2json \
      libprotobuf-c-dev \
      && rm -rf /var/lib/apt/lists/*

## 安装oracle_fdw需要的 Oracle instantclient
### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle
COPY --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2
RUN set -ex \
    && ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \
    && ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus

## 设置若干运行需要的环境变量
ENV ORACLE_HOME=/usr/local/instantclient \
    PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \
    PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH
## 拷贝构建好的成果
COPY --from=build  /usr/local/pgspider /usr/local/pgspider
## 入口脚本添加
COPY docker-entrypoint.sh /usr/local/bin/
RUN mkdir /docker-entrypoint-initdb.d \
    && chmod +x /usr/local/bin/docker-entrypoint.sh \
    && ln -s usr/local/bin/docker-entrypoint.sh /

## postgis 脚本添加
### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template
COPY ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh
COPY ./postgis/update-postgis.sh /usr/local/bin
## 添加扩展初始化脚本
COPY ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh
COPY ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh

## make the sample config easier to munge (and "correct by default")
RUN sed -ri "s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = '*'!" /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \
   grep -F "listen_addresses = '*'" /usr/local/pgspider/share/postgresql/postgresql.conf.sample

RUN mkdir -p /var/run/postgresql && chown -R postgres:postgres /var/run/postgresql  && chmod 2777 /var/run/postgresql

ENV PGDATA /var/lib/postgresql/data
## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary "--user" values)
RUN mkdir -p "$PGDATA" && chown -R postgres:postgres "$PGDATA" && chmod 777 "$PGDATA"
VOLUME /var/lib/postgresql/data

ENTRYPOINT ["docker-entrypoint.sh"]

# COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile
# We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL
# calls "Fast Shutdown mode" wherein new connections are disallowed and any
# in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and
# flush tables to disk, which is the best compromise available to avoid data
# corruption.
#
# Users who know their applications do not keep open long-lived idle connections
# may way to use a value of SIGTERM instead, which corresponds to "Smart
# Shutdown mode" in which any existing sessions are allowed to finish and the
# server stops when all sessions are terminated.
#
# See https://www.postgresql.org/docs/12/server-shutdown.html for more details
# about available PostgreSQL server shutdown signals.
#
# See also https://www.postgresql.org/docs/12/server-start.html for further
# justification of this as the default value, namely that the example (and
# shipped) systemd service files use the "Fast Shutdown mode" for service
# termination.
#
STOPSIGNAL SIGINT

# An additional setting that is recommended for all users regardless of this
# value is the runtime "--stop-timeout" (or your orchestrator/runtime's
# equivalent) for controlling how long to wait between sending the defined
# STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).
#
# The default in most runtimes (such as Docker) is 10 seconds, and the
# documentation at https://www.postgresql.org/docs/12/server-start.html notes
# that even 90 seconds may not be long enough in many instances.
EXPOSE 5432
CMD ["postgres"]
```

### ARM版本构建脚本

与x86版本不同之处在于：

1. from的镜像不同，一个是x86版本，一个是arm版本；
2. arm版本不包含oracle_fdw 构建的相关步骤；

```dockerfile
# ---
# 构建融合中心pg镜像-armb版本(从源码构建）：
# 1. 构建pgspider（pgspider-base镜像中包含）
# 2. 添加若干fdw：mysql_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中）
# 3. 添加 postgis
#
# 参考：
# - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one
# ---
## 构建 sqlite_fdw  mysql_fdw
FROM zh-registry.geostar.com.cn/geopanel/pgspider-builder-arm:latest as build

WORKDIR /app

## PG 主版本
ENV PG_MAJOR 11
ENV PG_VERSION 6

## 安装构建所需的依赖
RUN apt-get update \
    && apt-get install -y automake autoconf libtool pkg-config libssl-dev \
    libsqlite3-dev libsybdb5 freetds-dev freetds-common \
    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \
    # for oracle
    unzip \
#    libmysql++-dev
    libmysql++-dev \
    # libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7
    libspatialite7
#    postgresql-${PG_MAJOR}-python-multicorn python-pip

## 安装 sqlite_fdw
RUN git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw
RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw && make && make install

## 安装 mysql_fdw
RUN git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw
RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw && make && make install

## 安装 Install es_fdw
#RUN pip install pg_es_fdw

## 安装 oracle_fdw(arm 不支持)
### 安装oracle instantclient
# https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle
#ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip
#ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip
#ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip
#RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/
#RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/
#RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/
#RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient
#RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so
#RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus
#ENV ORACLE_HOME=/usr/local/instantclient
#ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient

#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \
#ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/
#RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \
#    && cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \
#    && make && make install

##  POSTGIS 构建
### 安装依赖
RUN apt-get install  -y --no-install-recommends \
    libtool libxml2 libxml2-dev \
    libxslt1.1 libxslt1-dev \
    libjson-c-dev libgmp-dev \
    cmake libmpfr-dev

### 创建临时工作目录
RUN mkdir /app/postgis/
ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis
ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib
ENV PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH

### 构建 mpfr
ADD postgis/mpfr-4.0.2.tar.gz /app/postgis/
RUN cd /app/postgis/mpfr-4.0.2 \
    && ./configure --prefix=$PGIS_INSTALL_PATH \
    && make && make install

### 构建 boost
ADD postgis/boost_1_67_0.tar.gz /app/postgis/
RUN cd /app/postgis/boost_1_67_0  \
    && ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH && ./b2 && ./b2 install

### 构建 CGAL
ADD postgis/CGAL-4.11.2.tar.xz /app/postgis/
RUN cd /app/postgis/CGAL-4.11.2  \
    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install

### 构建 SFCGAL
ADD postgis/SFCGAL-1.3.5.tar.gz /app/postgis/
RUN cd /app/postgis/SFCGAL-1.3.5 \
    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install

### 构建 proj，需要先安装sqlite3
RUN apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev
ADD postgis/proj-6.2.0.tar.gz /app/postgis/
RUN cd /app/postgis/proj-6.2.0  \
    && ./configure --prefix=$PGIS_INSTALL_PATH && make -j$(nproc) && make install

### 构建 gdal
ADD postgis/gdal-3.0.2.tar.gz /app/postgis/
RUN cd /app/postgis/gdal-3.0.2  \
    && ./configure --prefix=$PGIS_INSTALL_PATH \
    # proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同
        --with-proj=$PGIS_INSTALL_PATH \
    && make -j$(nproc) && make install

### 构建 geos
ADD postgis/geos-3.8.0.tar.bz2 /app/postgis/
RUN cd /app/postgis/geos-3.8.0  \
    && ./configure --prefix=$PGIS_INSTALL_PATH  \
    && make -j$(nproc) && make install

### 构建 postgis
ADD postgis/postgis-2.5.3.tar.gz /app/postgis/
RUN cd /app/postgis/postgis-2.5.3  \
    && ./configure --prefix=$PGIS_INSTALL_PATH \
    # 几个config命令直接配置PATH后可以找到，所以不在使用参数配置
#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \
#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \
#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \
        --with-projdir=$PGIS_INSTALL_PATH \
    && make -j$(nproc) && make install

RUN set -ex \
#    && sed -i "s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list \
#    && sed -i "s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g"  /etc/apt/sources.list \
    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev
#    && echo "deb http://deb.debian.org/debian stretch-backports main" >>/etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
      libprotobuf-c-dev \
#      postgresql-12-wal2json \
      protobuf-c-compiler \
      && rm -rf /var/lib/apt/lists/*

## 添加 debezium https://github.com/eulerto/wal2json
ADD debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/
RUN cd /app/debezium/wal2json-wal2json_1_0 \
    && make -j$(nproc) && make install

## 添加 debezium - decoderbufs 研究院修改版本
ADD debezium/postgres-decoderbufs.tar.gz /app/debezium/
RUN cd /app/debezium/postgres-decoderbufs \
    && cd proto \
    && protoc-c --c_out=../src/proto pg_logicaldec.proto \
    && cd .. \
    ## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean
    && make -B -j$(nproc) && make install

### 对构建postgis过程中生成的文件进行优化，以减小大小
#### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化
RUN cd $PGIS_INSTALL_PATH/lib \
    && rm *.a \
    && find . -type f -name "lib*.so.*" -exec strip {} +
#    && cd /usr/local/pgspider/plugin/proj/lib \
#    && rm *.a && find . -type f -name "lib*.so.*" -exec strip {} +

## 拷贝mysql
COPY binary-arm/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/
COPY binary-arm/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/
COPY binary-arm/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/
# 拷贝zombodb
COPY binary-arm/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/
COPY binary-arm/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/
COPY binary-arm/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/

# ------ 开始构建实际发布的镜像 ------
FROM zh-registry.geostar.com.cn/geopanel/pgspider-base-arm:latest
LABEL maintainer="jianghanghang@geostar.com.cn"

## 设置若干ENV，指示版本信息
# buster 上为12 ，stretch 上为 12
# ENV CDAL_VERSION 12
ENV BOOST_VERSION=1.67.0 \
    PG_MAJOR=11 \
    PG_VERSION=6 \
    POSTGIS_VESION=2.5.3

## 安装必要的依赖（TODO: 部分依赖可能不需要）
RUN set -ex \
#    && sed -i "s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list \
#    && sed -i "s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g"  /etc/apt/sources.list \
    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev
#    && echo "deb http://deb.debian.org/debian stretch-backports main" >>/etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
      curl \
      libcurl3-gnutls \
      libexpat1 \
      libgmp10 \
      libgmpxx4ldbl \
      libjson-c3 \
      # buster 上为6，stretch上为4
#      libmpfr6 \
#      libmpfr4 \
      libprotobuf-c1 \
      libtiff5 \
      libxml2 \
      && rm -rf /var/lib/apt/lists/*

## 安装oracle_fdw需要的 Oracle instantclient (arm版本不支持）
### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle
#COPY --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2
#RUN set -ex \
#    && ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \
#    && ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus

## 设置若干运行需要的环境变量
#ENV ORACLE_HOME=/usr/local/instantclient \
ENV PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis
ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \
    PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH
## 拷贝构建好的成果
COPY --from=build  /usr/local/pgspider /usr/local/pgspider
## 入口脚本添加
COPY docker-entrypoint.sh /usr/local/bin/
RUN mkdir /docker-entrypoint-initdb.d \
    && chmod +x /usr/local/bin/docker-entrypoint.sh \
    && ln -s usr/local/bin/docker-entrypoint.sh /

## postgis 脚本添加
### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template
COPY ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh
COPY ./postgis/update-postgis.sh /usr/local/bin
## 添加扩展初始化脚本
COPY ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh
COPY ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh

## make the sample config easier to munge (and "correct by default")
RUN sed -ri "s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = '*'!" /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \
   grep -F "listen_addresses = '*'" /usr/local/pgspider/share/postgresql/postgresql.conf.sample

RUN mkdir -p /var/run/postgresql && chown -R postgres:postgres /var/run/postgresql  && chmod 2777 /var/run/postgresql

ENV PGDATA /var/lib/postgresql/data
## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary "--user" values)
RUN mkdir -p "$PGDATA" && chown -R postgres:postgres "$PGDATA" && chmod 777 "$PGDATA"
VOLUME /var/lib/postgresql/data

ENTRYPOINT ["docker-entrypoint.sh"]

# COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile
# We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL
# calls "Fast Shutdown mode" wherein new connections are disallowed and any
# in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and
# flush tables to disk, which is the best compromise available to avoid data
# corruption.
#
# Users who know their applications do not keep open long-lived idle connections
# may way to use a value of SIGTERM instead, which corresponds to "Smart
# Shutdown mode" in which any existing sessions are allowed to finish and the
# server stops when all sessions are terminated.
#
# See https://www.postgresql.org/docs/12/server-shutdown.html for more details
# about available PostgreSQL server shutdown signals.
#
# See also https://www.postgresql.org/docs/12/server-start.html for further
# justification of this as the default value, namely that the example (and
# shipped) systemd service files use the "Fast Shutdown mode" for service
# termination.
#
STOPSIGNAL SIGINT

# An additional setting that is recommended for all users regardless of this
# value is the runtime "--stop-timeout" (or your orchestrator/runtime's
# equivalent) for controlling how long to wait between sending the defined
# STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).
#
# The default in most runtimes (such as Docker) is 10 seconds, and the
# documentation at https://www.postgresql.org/docs/12/server-start.html notes
# that even 90 seconds may not be long enough in many instances.
EXPOSE 5432
CMD ["postgres"]
```



## 镜像测试及使用

> 提示：镜像使用了pg官方的入口脚本，官方支持的配置及变量都可以使用，具体可查看[官方dockerhub页面](https://hub.docker.com/_/postgres?tab=description&page=1&ordering=last_updated)

下面描述了一个简单的测试流程，详细可参考： [pgspider镜像运行测试](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/README.md#%E8%BF%90%E8%A1%8C-1)

```shell
## 根据平台及需要使用的源，设置 `PG_IMAGE` 变量
# x86 - dockerhub 
PG_IMAGE=hanlyjiang/pgspider-postgis:latest
# arm - dockerhub
PG_IMAGE=hanlyjiang/pgspider-postgis-arm:latest
# x86 - 阿里云
PG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis:latest
# arm - 阿里云
PG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis-arm:latest

# 启动 pgspider （可以将 --rm 换成 -d 以便持续在后台运行 ）
## 通过 POSTGRES_PASSWORD 变量可以设置密码
docker run -it --rm \
    --name pgspider \
    -p 5434:5432 \
    -e POSTGRES_PASSWORD=mysecretpassword \
    -v $PWD/data:/var/lib/postgresql/data \
    $PG_IMAGE

## 启动后进入容器：
docker exec -it pgspider bash
### 然后可以执行 psql 等命令

# 测试用，正常运行可以不用管
docker run -it --rm \
    --entrypoint="" \
    --name pgspider \
    -e POSTGRES_PASSWORD=mysecretpassword \
    -v $PWD/data:/var/lib/postgresql/data \
    pgspider-postgis:latest bash

```

## 可优化部分

builder镜像和base镜像的构建arm及x86两个架构的镜像构建可以合并成一条命令并使用相同的镜像名称；同时pgspider镜像也可以经过一定的更改统一成一个打包脚本；





# GeoPanel容器化-hasura即块数据API引擎镜像构建

## Hasura镜像构建概览

### hasura 是什么？

引用[hasura官方]([https://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md](https://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md)
)的介绍

> Hasura GraphQL引擎是一个高性能的GraphQL服务器，可为您提供 **Postgres上开箱即用的实时GraphQL API**， 响应数据库事件的 [**Webhook触发器**](https://github.com/hasura/graphql-engine/blob/master/event-triggers.md)，以及用于业务逻辑处理的 [**远端Schema**](https://github.com/hasura/graphql-engine/blob/master/remote-schemas.md)。
> Hasura可帮助您构建基于Postgres的GraphQL应用程序，或将使用Postgres的现有应用迁移到GraphQL上。

Github及DockerHub地址：

* 开源仓库Github地址：[hasura/graphql-engine](hasura/graphql-engine)
* 官方Dockerhub镜像地址：[hasura/graphql-engine](https://hub.docker.com/r/hasura/graphql-engine/tags?page=1&ordering=last_updated)

### 我们做的修改

我们使用hasura作为融合中心的块数据API引擎，针对开源版本作了如下修改/扩展：

1. 汉化了 graphl-engine console，其中包括：
   * 汉化 graphql-engine的console入口文件中的 `Loading...`;
   * console web页面的所有界面；
2. 根据需要扩展了几个模块，模块扩展的方式为：1）在console中添加扩展模块的web操作界面；2）提供对应的springboot服务作为后端接口提供服务；到目前为止，包括以下模块：
   * token管理服务
   * 数据库集成服务
   * restapi服务

### 目标及成果

通过官方的dockerhub可以看到，目前没有arm版本的镜像，故我们需要从头编译。同时我们希望能让hasura在arm平台上运行，最终也完成了构建流程，整体如下：

![image-20210316140949364](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316140949.png)

### hasura整体结构

```mermaid
graph

graphql-engine

console

cli

```

1. graphql-engine: graphql 引擎

2. console：前端界面，实际上console也会一起打包到graphql-engine的镜像里面

3. Hasura CLI是一个命令行工具，是管理Hasura项目和迁移的主要模式。

实际上我们只需要前两个部分即可

### 整体构建流程梳理

#### 代码结构说明

```shell
graphql-engine 
	|-- server
		  |-- src-rsr
		  		|-- console.html
	|-- console
		  |-- xx.html
		  |-- xxxx
```

server 目录会编译出一个 graphql-engine 的二进制文件，其中会包含 `server/src-rsr/console.html` 文件作为首页的加载模板（即console.html）。

#### graphql-engine console

console为web工程，使用npm run build即可编译，非常简单。我们只需要重点关注server部分即可。现在我们重点分析这个server部分：

#### graphql-engine server

- graphql-engine server 使用haskell语言进行编写，使用 cabal 进行构建；
- haskell是一个函数式编程语言，编译器为GHC，编译工具一般使用cabal，cabal同时也是项目的管理工具（如包管理，依赖管理）。

也就是说为了编译server，我们需要GHC及cabal，那么这两个工具的arm版本现状如何了？

* GHC： 无arm版本现成的docker镜像，有预编译的二进制；
* cabal： 无arm版本现成的docker镜像及二进制文件；

为了不污染环境，并且持久化构建环境，我们准备构建一个docker的镜像，包含ghc及cabal，也就是说，我们两者都需要构建。

总结以下构建步骤：

1. 准备haskell的ARM版本编译环境（包括GHC编译器及hasura编译所需要的cabal工具）；
2. 使用之前准备好的ARM版本编译环境编译hasura；
3. 打包成Docker镜像；



#### 整体构建流程

在浏览`graphql-engine` 的仓库中ci构建的部分文件之后，我发现还需要其他一些辅助镜像，最后梳理出如下构建流程：

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316090603.png" alt="docker-image-builder-flow" style="zoom: 50%;" />



1. 首先，我们需要构建 `graphql-engine-builder` 的镜像，其中包括haskell的GHC编译器及cabal依赖管理工具；
2. 然后我们使用`graphql-engine-builder`镜像对 graphql-engine 的源码进行编译，生成 graphql-engine 的二进制可执行文件及 graphql-engine 运行所需要的依赖库；
3. 由于第二步构建过程中有很多中间成果，我需要为graphql-engine创造一个纯净的运行环境以缩小最终的运行镜像的大小，所以我们需要构建 `graphql-engine-packager` 镜像，其中包含一个精简版的根文件系统。
4. 现在，我们将第二步中生成的graphql-engine及其依赖文件和第三步 `graphql-engine-packager` 镜像中的根文件系统合并到一个scratch镜像，然后生成 `graphql-engine-base` 的镜像，这个镜像已经包含了一个可以正常运行的 graphql-engine ，只是没有集成console资源到镜像中；
5. 最后我们对console进行编译，生成assets资源，然后基于 `graphql-engine-base` 添加这些前端资源文件，生成我们最终需要的 `graphql-engine` 镜像；



## graphql-engine-builder 镜像构建

基于以下原因，我决定构建一个graphql-engine-builder的镜像：

1. 不想污染自己的主机的环境，安装一堆haskell的构建环境；
2. 持久化编译环境，使得构建过程可以无成本迁移到任何机器；

这个builder镜像包含以下内容(实际上就是haskell语言的构建环境)：

* GHC
* cabal

经过一番尝试，确定了如下Dockerfile构建脚本：

### **X86** Dockerfile

```dockerfile
#  x86 用于构建hasura的镜像
# 构建命令 docker build -f Dockerfile -t hanlyjiang/graphql-engine-builder:latest .
FROM haskell:8.10.1

## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误）
ENV LANG            C.UTF-8

# 避免配置tzdata时出现的交互式等待界面导致构建卡住
## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/
ENV DEBIAN_FRONTEND noninteractive

RUN sed -i "s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g" /etc/apt/sources.list && \
   sed -i "s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g"  /etc/apt/sources.list && \
   apt-get update && \
   apt-get install -y --no-install-recommends apt-utils lsb-release wget && \
   echo "deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
   wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc |  apt-key add - && \
   apt-get update && \
   apt-get install -y --no-install-recommends  postgresql libpq-dev && \
   rm -fr /var/lib/apt/lists/* && \
   # 安装 upx
   wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz && \
           tar -xf upx-3.96-amd64_linux.tar.xz  && \
           cp upx-3.96-amd64_linux/upx /usr/bin/upx && \
           rm -fr upx-3.96-amd64_linux
```

x86版本基于 haskell官方的`haskell:8.10.1` 镜像，添加了如下动作：

1. 替换软件源为国内软件源；
2. 安装必要的软件依赖；
3. 添加了upx用于二进制文件优化；

### **ARM** Dockerfile

arm版本的则需要从头构建

* 我们使用 `ubuntu:18.04` 作为基础镜像；
* 首先安装了 LLVM6.0 及 GHC8.6.5 ；
* 使用 GHC8.6.5 构建 Cabal3.2.0.0（包括cabal-install），因为GHC8.10.1无法成功构建cabal-install 3.2；
* 然后安装 LLVM 9 及GHC8.10.1，用于后续编译hasura；
* 添加必要的依赖；
* 添加了upx用于二进制文件优化；

```dockerfile
## Hasura graphql-engine 编译环境
# 测试发现只有在arm机器上才可能构建成功，x86 docker交叉构建失败
# docker build -t registry.cn-hangzhou.aliyuncs.com/geostar_private_arm/haskell-ghc8.6.5_8.10.1-cabal3.2:20200817 .

# ghc-8.6.5的安装构建需要在ubuntu18.04上（glibc2.27)
## 通过如下方式确认glibc版本：
### docker run -it --rm ubuntu:18.04 bash -c "find / -type f | grep libc-.*.so" # 输出 /lib/x86_64-linux-gnu/libc-2.27.so
### docker run -it --rm debian:stretch bash -c "find / -type f | grep libc-.*.so" # 输出 /lib/x86_64-linux-gnu/libc-2.24.so
### docker run -it --rm debian:buster bash -c "find / -type f | grep libc-.*.so" # 输出 /lib/aarch64-linux-gnu/libc-2.28.so
### debian也可以在此页面查看：https://packages.debian.org/search?searchon=sourcenames&keywords=glibc
#FROM debian:stretch
FROM ubuntu:18.04

## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误）
ENV LANG            C.UTF-8

# 避免配置tzdata时出现的交互式等待界面导致构建卡住
## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/
ENV DEBIAN_FRONTEND noninteractive

# 以防网络不好，切换到国内镜像源
RUN apt-get update && \
     apt install -y apt-transport-https ca-certificates
ADD ubuntu18.04-sources.list /etc/apt/sources.list


# 避免 hash sum mismatch 问题：
## https://stackoverflow.com/questions/15505775/debian-apt-packages-hash-sum-mismatch
# RUN apt-get clean && rm -rf /var/lib/apt/lists/* && apt-get clean && apt-get update && \

# 安装常用软件及GHC构建相关依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends gnupg ca-certificates dirmngr curl git wget && \
    apt-get install -y --no-install-recommends zlib1g-dev libtinfo-dev libsqlite3-dev \
                g++ netbase xz-utils libnuma-dev make openssh-client \
                # hasura 构建需要（pg-client）
                ## https://stackoverflow.com/questions/17915098/openssl-ssl-h-no-such-file-or-directory-during-installation-of-git
                libssl-dev libkrb5-dev && \
    # 安装llvm 6.0（用于构建cabal）
    LLVM_VERSION=6.0 && \
    # apt-get install -y software-properties-common && \
    apt-get install -y --no-install-recommends libghc-network-dev \
        llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev && \
        rm -fr /var/lib/apt/lists/* && \
    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc  && \
    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt

# 安装 GHC 8.6.5（用于构建Cabal3.2.0.0）
RUN GHC=8.6.5 && GHC_OS_DIST=ubuntu18.04 && \
    ## 下载链接类似：https://downloads.haskell.org/~ghc/8.10.1/ghc-8.10.1-aarch64-deb9-linux.tar.xz 
    wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \
    tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \
    cd ghc-${GHC}  && \
    ./configure && \
    make install && \
    cd ../ && \
    rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} 

# 构建 Cabal 3.2.0.0 （包括 cabal-install）
RUN git clone -b cabal-install-v3.2.0.0 https://github.com/haskell/cabal.git && \
    cd cabal/cabal-install && \
    ./bootstrap.sh && \
    cd ../.. && \
    rm -fr cabal

# 安装 llvm 9 及其他构建所需 （postgresql libpq-dev）pg_config
RUN LLVM_VERSION=9 && \
    apt-get update && \
    apt-get install -y --no-install-recommends llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev && \
    # 如果有旧版本的，则移除链接
    rm /usr/local/bin/llc /usr/local/bin/opt && \
    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc && \
    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt && \
    # 安装ghc8.10.1 ，自带Cabal库的3.2版本
    GHC=8.10.1 && GHC_OS_DIST=deb9 && \
    wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \
    tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \
    cd ghc-${GHC}  && \
    ./configure && \
    make install && \
    cd ../ && \
    rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} && \
    # 安装3.96版本的upx-用于压缩优化graphql-engine二进制可执行文件（软件源中的3.94版本有压缩aarch的二进制后有问题 https://github.com/upx/upx/issues/130）
    wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-arm64_linux.tar.xz && \
    tar -xf upx-3.96-arm64_linux.tar.xz  && \
    cp upx-3.96-arm64_linux/upx /usr/bin/upx && \
    rm -fr upx-3.96-arm64_linux upx-3.96-arm64_linux.tar.xz /var/lib/apt/lists/*


## stack 安装(hasura构建可不安装stack)
# ARG STACK=2.1.3
# ARG STACK_KEY=C5705533DA4F78D8664B5DC0575159689BEFB442
# ARG STACK_RELEASE_KEY=2C6A674E85EE3FB896AFC9B965101FF31C5C154D

# RUN arch=`uname -m` && \
#     echo $arch && \ 
#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz -o  stack.tar.gz && \
#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz.asc -o stack.tar.gz.asc 
# RUN export GNUPGHOME="$(mktemp -d)" && \
#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_KEY} && \
#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_RELEASE_KEY} && \
#     gpg --batch --trusted-key 0x575159689BEFB442 --verify stack.tar.gz.asc stack.tar.gz && \
#     tar -xf stack.tar.gz -C /usr/local/bin --strip-components=1 && \
#     /usr/local/bin/stack config set system-ghc --global true && \
#     /usr/local/bin/stack config set install-ghc --global false && \
#     rm -rf "$GNUPGHOME" /var/lib/apt/lists/* /stack.tar.gz.asc /stack.tar.gz;

# 设置环境变量使可以找到cabal，GHC的默认会安装到PATH中，无需额外设置
ENV PATH /root/.cabal/bin:$PATH

## 没有指定命令的时候默认运行ghci
CMD ["ghci"]

```

> 注意：由于以上builder镜像是用于编译graphql-engine的工具镜像，而非最终的镜像，所以并未刻意对镜像大小进行优化；

## graphql-engine-packager 构建

packager镜像中包含一个纯净的根文件系统，可为graphql-engine server提供基础的运行环境；

### 整体说明

graphql-engine-packager的镜像构建脚本位于源码的 `server/packaging` 目录中的 `package.df` 文件中，内容如下：

```dockerfile
FROM hasura/haskell-docker-packager:20190731
MAINTAINER vamshi@hasura.io

RUN apt-get update && apt-get install -y libpq5 upx \
 && update-ca-certificates \
 && mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \
 && cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \
 && rm -rf /var/lib/apt/lists/*
```

可以看到其基于 `hasura/haskell-docker-packager:20190731` 的镜像（[DockerHub对应页面](https://hub.docker.com/r/hasura/haskell-docker-packager/tags?page=1&ordering=last_updated)），具体构建方式如下：

```shell
registry=hanlyjiang  # 替换成自行设置的值
packager_ver=20210316 # 替换成自行设置的值

docker build -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager.df ./packaging/
```

从以上分析可知，我们要构建packager镜像，需要先构建`haskell-docker-packager`镜像，而对于X86版本来说，可以直接使用使用官方已经构建好的镜像，对于ARM版本来说，则需要我们从头构建；



### X86镜像构建

如上所述，我们直接基于官方的 `hasura/haskell-docker-packager:20190731`并使用源码目录中的 `packaging/packager.df` 文件构建出对应的`graphql-engine-packager`镜像即可；

### ARM

#### haskell-docker-packager 镜像构建

arm版本则需要我们从头构建 `haskell-docker-packager` 的镜像，基于官方的 [github/hasura/haskell-docker-builder](https://github.com/hasura/haskell-docker-builder) 源码，我略作修改，让其可以构建出arm版本的镜像，对应的代码放置于 [github/hanlyjiang/haskell-docker-builder](https://github.com/hanlyjiang/haskell-docker-builder) 中，执行如下命令即可构建出arm版本的 `haskell-docker-packager` 镜像：

```shell
git clone git@github.com:hanlyjiang/haskell-docker-builder.git 
make build 
```

上述命令执行完毕后会生成一个 `hanlyjiang/haskell-docker-packager:当前日期` 的镜像。



#### graphql-engine-packager 镜像构建

同样的，我们在 graphql-engine的源代码的 `server/packaging` 目录中添加一个名为 `packaging-arm.df` 的文件用于构建 arm 版本的 `graphql-engine-packager` 镜像，内容如下：

```dockerfile
FROM hanlyjiang/haskell-docker-packager:20200814
MAINTAINER hanlyjiang@outlook.com

RUN apt-get update && apt-get install -y libpq5 upx \
 && update-ca-certificates \
 && mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \
 && cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \
 && rm -rf /var/lib/apt/lists/*
```

可通过如下命令构建arm版本镜像：

```shell
registry=hanlyjiang  # 替换成自行设置的值
packager_ver=20210316 # 替换成自行设置的值
```

构建可以在arm机器上执行，也可以在x86机器上通过buildx来交叉构建：

- arm 机器上执行：    

```shell
docker build -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager-arm.df ./packaging/
```

- 非arm机器上交叉构建arm镜像

```shell
docker buildx build --platform=linux/arm64 -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager-arm.df ./packaging/ --load
```



## graphql-engine-base 构建

`graphql-engine-base` 镜像包含 graphql-engine 的 server，当不包含 console 的 web 资源；

### X86镜像构建

```dockerfile
### 构建 graphql-engine 镜像
## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./

## -- 编译 graphql-engine
# 
FROM hanlyjiang/graphql-engine-builder:20201111 as builder

ARG GIT_TAG=v1.3.2
ARG GIT_USER=docker-build
ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq

RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine 

WORKDIR /app/graphql-engine/server

# 初始化cabal的配置
RUN ln -s cabal.project.ci cabal.project.local && \
    export LANG=C.UTF-8 && \
    # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html
    cabal user-config update && \
    # 替换为国内源
    sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config  && \
    sed -i 's/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g' /root/.cabal/config

# 重新更新软件包信息(单独作为一层，以便缓存)
RUN cabal new-update

# 编译 graphql-engine 可执行文件
# 我们将加载中替换为中文
RUN sed -i 's/Loading/加载中/g' src-rsr/console.html && \
    # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs
    cabal new-build --jobs=$(nproc)
RUN build_output=../_build_output && \
    exec_glob=`find ./dist-newstyle/ -type f -name "graphql-engine"` && \
    mkdir $build_output && \
    cp "$exec_glob" $build_output/ && \
    # get-version 需要基于git仓库获取版本号
    ../scripts/get-version.sh >$build_output/version.txt 


## -- 提取基础的rootfs
# docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./
FROM hasura/graphql-engine-packager:20190731 as baseRootfs
COPY --from=builder /app/graphql-engine/_build_output/ /root/
RUN mkdir /rootfs/ && /build.sh graphql-engine | tar -x -C /rootfs/


## 构建最终的rootfs
# docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./
FROM builder as bulderRootfs
WORKDIR /app/graphql-engine/
COPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs

RUN pg_dump_ver=12 && \
    exec_glob=`find server/dist-newstyle/ -type f -name "graphql-engine"` && \
    build_output=./_build_output  && \
    packaging_dir=./server/packaging/  && \
    rootfs_dir=$packaging_dir/build/rootfs  && \
    cp $build_output/graphql-engine $rootfs_dir/bin && \
    # 获取所有动态链接库
    ldd $build_output/graphql-engine | awk 'BEGIN{ORS="\n"}$1~/^\//{print $1}$3~/^\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ && \
    # 获取 pg_dump
    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump && \
    # 优化&压缩
    strip --strip-unneeded $rootfs_dir/bin/graphql-engine && \
    upx $rootfs_dir/bin/graphql-engine 

## - 不带 console-assets
# docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./
FROM scratch as graphql-engine-base
COPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
CMD ["graphql-engine", "serve"]
```

执行如下命令构建：

```shell
TAG=$(date '+%Y%m%d')

docker build -t graphql-engine-base:$TAG ./ 
```



### ARM版本镜像构建

```dockerfile
### 构建 graphql-engine 镜像
## docker buildx build --platform=linux/arm64  -f Dockerfile-base-arm.dockerfile -t graphql-engine-base:arm-20201109 ./ --load


## 构建准备
# docker pull hanlyjiang/graphql-engine-builder:arm-latest

## -- 编译 graphql-engine
# 
FROM hanlyjiang/graphql-engine-builder:arm-latest as builder

ARG GIT_TAG=v1.3.2
ARG GIT_USER=docker-build
ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq

RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine 

WORKDIR /app/graphql-engine/server

# 初始化cabal的配置
RUN ln -s cabal.project.ci cabal.project.local && \
    export LANG=C.UTF-8 && \
    # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html
    cabal user-config update && \
    # 替换为国内源
    sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config  && \
    sed -i 's/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g' /root/.cabal/config

# 重新更新软件包信息(单独作为一层，以便缓存)
## update 过程中可能自动去github下载仓库
RUN cabal new-update

# 编译 graphql-engine 可执行文件
RUN sed -i 's/Loading/加载中/g' src-rsr/console.html && \
    # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs
    cabal new-build --jobs=$(nproc)
RUN build_output=../_build_output && \
    exec_glob=`find ./dist-newstyle/ -type f -name "graphql-engine"` && \
    mkdir $build_output && \
    cp "$exec_glob" $build_output/ && \
    # get-version 需要基于git仓库获取版本号
    ../scripts/get-version.sh >$build_output/version.txt 


## -- 提取基础的rootfs
# docker buildx build --platform=linux/arm64  -f Dockerfile-base.dockerfile --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ --load
FROM hanlyjiang/graphql-engine-packager:20200814 as baseRootfs
COPY --from=builder /app/graphql-engine/_build_output/ /root/
# build.sh 的内容就是下面的 ldd graphql-engine | awk 'BEGIN{ORS="\n"}$1~/^\//{print $1}$3~/^\//{print $3}' | xargs cp -n -L --parents -t ，用于拷贝packager镜像中graphql-engine需要的依赖库到rootfs
RUN mkdir /rootfs/ && /build.sh graphql-engine | tar -x -C /rootfs/


## 构建最终的rootfs
# docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ --load
FROM builder as bulderRootfs
WORKDIR /app/graphql-engine/
COPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs

RUN pg_dump_ver=12 && \
    exec_glob=`find server/dist-newstyle/ -type f -name "graphql-engine"` && \
    build_output=./_build_output  && \
    packaging_dir=./server/packaging/  && \
    rootfs_dir=$packaging_dir/build/rootfs  && \
    cp $build_output/graphql-engine $rootfs_dir/bin && \
    # 获取所有动态链接库
    ldd $build_output/graphql-engine | awk 'BEGIN{ORS="\n"}$1~/^\//{print $1}$3~/^\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ && \
    # 获取 pg_dump(arm builder镜像路径不一样)
    cp /usr/share/postgresql-common/pg_wrapper $rootfs_dir/bin/pg_dump && \
    # 优化&压缩
    strip --strip-unneeded $rootfs_dir/bin/graphql-engine && \
    upx $rootfs_dir/bin/graphql-engine 

## - 不带 console-assets
# docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base-arm:20201110 --target graphql-engine-base ./ --load
FROM scratch as graphql-engine-base
LABEL maintainer="jianghanghang@geostar.com.cn"
COPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
CMD ["graphql-engine", "serve"]

```

执行如下命令构建：

```shell
TAG=$(date '+%Y%m%d')

# ARM机器执行
docker build  -t graphql-engine-base:arm-$TAG  ./

# x86交叉构建
docker buildx build --platform=linux/arm64 -t  graphql-engine-base:arm-$TAG ./ --load
```



### 构建脚本合并简化（未验证）

```dockerfile
### 构建 graphql-engine 镜像
## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./

## -- 编译 graphql-engine
# 

ARG builder_image
ARG packager_image
FROM ${builder_image} as builder

ARG GIT_TAG=v1.3.2
ARG GIT_USER=docker-build
ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq

RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine 

WORKDIR /app/graphql-engine/server

# 初始化cabal的配置
RUN ln -s cabal.project.ci cabal.project.local && \
    export LANG=C.UTF-8 && \
    # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html
    cabal user-config update && \
    # 替换为国内源
    sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config  && \
    sed -i 's/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g' /root/.cabal/config

# 重新更新软件包信息(单独作为一层，以便缓存)
RUN cabal new-update

# 编译 graphql-engine 可执行文件
# 我们将加载中替换为中文
RUN sed -i 's/Loading/加载中/g' src-rsr/console.html && \
    # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs
    cabal new-build --jobs=$(nproc)
RUN build_output=../_build_output && \
    exec_glob=`find ./dist-newstyle/ -type f -name "graphql-engine"` && \
    mkdir $build_output && \
    cp "$exec_glob" $build_output/ && \
    # get-version 需要基于git仓库获取版本号
    ../scripts/get-version.sh >$build_output/version.txt 


## -- 提取基础的rootfs
# docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./
FROM ${packager_image} as baseRootfs
COPY --from=builder /app/graphql-engine/_build_output/ /root/
RUN mkdir /rootfs/ && /build.sh graphql-engine | tar -x -C /rootfs/


## 构建最终的rootfs
# docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./
FROM builder as bulderRootfs
WORKDIR /app/graphql-engine/
COPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs

RUN pg_dump_ver=12 && \
    exec_glob=`find server/dist-newstyle/ -type f -name "graphql-engine"` && \
    build_output=./_build_output  && \
    packaging_dir=./server/packaging/  && \
    rootfs_dir=$packaging_dir/build/rootfs  && \
    cp $build_output/graphql-engine $rootfs_dir/bin && \
    # 获取所有动态链接库
    ldd $build_output/graphql-engine | awk 'BEGIN{ORS="\n"}$1~/^\//{print $1}$3~/^\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ && \
    # 获取 pg_dump
    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump && \
    # 优化&压缩
    strip --strip-unneeded $rootfs_dir/bin/graphql-engine && \
    upx $rootfs_dir/bin/graphql-engine 

## - 不带 console-assets
# docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./
FROM scratch as graphql-engine-base
COPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8
CMD ["graphql-engine", "serve"]
```

构建命令：

* **X86**

  ```shell
  builder_image=hanlyjiang/graphql-engine-builder:20201111
  packager_image=hasura/graphql-engine-packager:20190731
  TAG=$(date '+%Y%m%d')
  
  docker build ./ -t graphql-engine-base:$TAG --build-arg builder_image="$builder_image" --build-arg packager_image="$packager_image"
  ```

* **ARM**

  ```shell
  builder_image=hanlyjiang/graphql-engine-builder:arm-latest
  packager_image=hanlyjiang/graphql-engine-packager:20200814
  TAG=$(date '+%Y%m%d')
  
  # ARM机器执行
  docker build  -t graphql-engine-base:arm-$TAG --build-arg builder_image="$builder_image" --build-arg packager_image="$packager_image" ./
  
  # x86交叉构建
  docker buildx build --platform=linux/arm64 -t  graphql-engine-base:arm-$TAG --build-arg builder_image="$builder_image" --build-arg packager_image="$packager_image" ./ --load
  ```

  

## graphql-engine 镜像构建

graphql-engine 即是我们最终需要使用的镜像，包含graphql-engine 的server及console web资源；

### X86

```dockerfile
### 构建 graphql-engine 镜像
## docker build -t graphql-engine:20201111 ./

## -- 构建 console 
# docker build --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./
FROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder
# 有时console代码更新，我们直接从仓库获取最新代码
# COPY --from=builder /app/graphql-engine/console /app/console
ARG GIT_TAG=v1.3.2
ARG GIT_USER=docker-build
ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq
RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine

WORKDIR /app/graphql-engine/console
# 单独提取install步骤便于缓存
RUN set -eux ; \
    npm config set sass_binary_site=https://npm.taobao.org/mirrors/node-sass && \
    npm install --registry=https://registry.npm.taobao.org
# RUN npm install
RUN git pull && npm run build
# 开始构建
RUN set -eux ; \
    CONSOLE_ASSETS_PATH=./static/assets && \
    DIST_PATH=./static/dist && \
    ls -laR $DIST_PATH && \
    if [ ! -d "$CONSOLE_ASSETS_PATH/common" ]; then \
		mkdir -p $CONSOLE_ASSETS_PATH/common; \
		cp -r "$DIST_PATH/../assets/common" "$CONSOLE_ASSETS_PATH"; \
	fi;  \ 
	rm -rf "$CONSOLE_ASSETS_PATH/versioned" && \
	mkdir -p "$CONSOLE_ASSETS_PATH/versioned" && \
    cp "$DIST_PATH"/*.js "$CONSOLE_ASSETS_PATH/versioned/" && \
	gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js && \
    # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成
    cp "$DIST_PATH"/*.css "$CONSOLE_ASSETS_PATH/versioned/" || true && \
    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true

## -- 构建最终镜像
# docker build --progress plain -t graphql-engine:20201110 ./
FROM zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123
LABEL maintainer="jianghanghang@geostar.com.cn"
COPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets

COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh \
    && ln -s usr/local/bin/docker-entrypoint.sh /

ENTRYPOINT ["docker-entrypoint.sh"]
```

执行如下命令构建：

```shell
TAG=$(date '+%Y%m%d')
docker build -t graphql-engine:$TAG ./
```



### ARM

```dockerfile
### 构建 graphql-engine 镜像
## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./
## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load

## -- 构建 console 
# docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load
FROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder
# 有时console代码更新，我们直接从仓库获取最新代码
# COPY --from=builder /app/graphql-engine/console /app/console
ARG GIT_TAG=v1.3.2
ARG GIT_USER=docker-build
ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq
RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine

WORKDIR /app/graphql-engine/console
# 单独提取install步骤便于缓存
RUN npm install --registry=https://registry.npm.taobao.org
RUN npm run build 
# 开始构建
RUN set -eux ; \
    CONSOLE_ASSETS_PATH=./static/assets && \
    DIST_PATH=./static/dist && \
    ls -laR $DIST_PATH && \
    if [ ! -d "$CONSOLE_ASSETS_PATH/common" ]; then \
		mkdir -p $CONSOLE_ASSETS_PATH/common; \
		cp -r "$DIST_PATH/../assets/common" "$CONSOLE_ASSETS_PATH"; \
	fi;  \ 
	rm -rf "$CONSOLE_ASSETS_PATH/versioned" && \
	mkdir -p "$CONSOLE_ASSETS_PATH/versioned" && \
    cp "$DIST_PATH"/*.js "$CONSOLE_ASSETS_PATH/versioned/" && \
	gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js && \
    # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成
    cp "$DIST_PATH"/*.css "$CONSOLE_ASSETS_PATH/versioned/" || true && \
    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true

## -- 构建最终镜像
# docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load
FROM zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2
LABEL maintainer="jianghanghang@geostar.com.cn"
COPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets
# COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets

COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh \
    && ln -s usr/local/bin/docker-entrypoint.sh /

ENTRYPOINT ["docker-entrypoint.sh"]

```

构建命令：

```shell
TAG=$(date '+%Y%m%d')
docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:$TAG ./
docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-$TAG ./ --load
```



### 构建脚本简化(未验证)

```dockerfile
### 构建 graphql-engine 镜像
## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./
## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load

ARG base_image

## -- 构建 console 
# docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load
FROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder
# 有时console代码更新，我们直接从仓库获取最新代码
# COPY --from=builder /app/graphql-engine/console /app/console
ARG GIT_TAG=v1.3.2
ARG GIT_USER=docker-build
ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq
RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine

WORKDIR /app/graphql-engine/console
# 单独提取install步骤便于缓存
RUN npm install --registry=https://registry.npm.taobao.org
RUN npm run build 
# 开始构建
RUN set -eux ; \
    CONSOLE_ASSETS_PATH=./static/assets && \
    DIST_PATH=./static/dist && \
    ls -laR $DIST_PATH && \
    if [ ! -d "$CONSOLE_ASSETS_PATH/common" ]; then \
		mkdir -p $CONSOLE_ASSETS_PATH/common; \
		cp -r "$DIST_PATH/../assets/common" "$CONSOLE_ASSETS_PATH"; \
	fi;  \ 
	rm -rf "$CONSOLE_ASSETS_PATH/versioned" && \
	mkdir -p "$CONSOLE_ASSETS_PATH/versioned" && \
    cp "$DIST_PATH"/*.js "$CONSOLE_ASSETS_PATH/versioned/" && \
	gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js && \
    # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成
    cp "$DIST_PATH"/*.css "$CONSOLE_ASSETS_PATH/versioned/" || true && \
    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true

## -- 构建最终镜像
# docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load
FROM ${base_image}
LABEL maintainer="jianghanghang@geostar.com.cn"
COPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets
# COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets

COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh \
    && ln -s usr/local/bin/docker-entrypoint.sh /

ENTRYPOINT ["docker-entrypoint.sh"]
```

* x86构建：

  ```shell
  base_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123
  
  TAG=$(date '+%Y%m%d')
  
  docker build ./ -t graphql-engine-base:$TAG --build-arg base_image="$base_image" --build-arg 
  ```

  

* arm构建

  ```shell
  base_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2
  
  TAG=$(date '+%Y%m%d')
  
  # arm 机器直接构建
  docker build ./ -t graphql-engine:arm-$TAG --build-arg base_image="$base_image" --build-arg 
  
  
  # x86交叉构建
  docker buildx build --platform=linux/arm64 -t  graphql-engine:arm-$TAG --build-arg base_image="$base_image" ./ --load
  ```





# GeoPanel容器化-自研服务镜像构建

## 前言

所有当前已经构建的服务，都可以通过[gepanel-deploy 仓库中的readme](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/README.md)进行快速导航，如：

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210319162128.png" alt="image-20210319162127913" style="zoom: 50%;" />

## blockapi-token 服务镜像构建

镜像构建的相关文件目录位于 [gitlab此路径](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/tree/v1.3.2/docker/hasura-token)，具体构建时操作步骤如下：

1. **王峰**提供成品jar包；
2. 放置到此目录执行docker buildx build 命令打包；

由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：

* [dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/Dockerfile)
* [打包及使用方式](http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/README.md)



## blockapi-db-integrate 服务镜像构建

数据库集成服务的镜像构建相关文件位于 [gitlab此路径](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev/docker) ，具体构建时操作步骤如下：

1. **韩小乐** 提供成品jar或者我们自行从[源码](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev)编译jar；
2. 放置到docker构建目录使用docker buildx build命令构建；

由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：

* [dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/Dockerfile)
* [打包及使用方式](http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/README.md)



## blockapi-restapi 服务镜像构建

由于之前有完成过，在此不在叙述，可参考 [此gitlab目录](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/rest-api/-/tree/master/docker)



## gpl-datacollection 服务镜像构建

埋点系统服务镜像的构建文件位于 [gitlab此路径](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/tree/develop/docker) ，具体构建时操作步骤如下：

1. **王峰** 提供成品jar；
2. 放置到docker构建目录使用 docker buildx build命令构建；

由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：

* [dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/Dockerfile)
* [打包及使用方式](http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/README.md)





# GeoPanel容器化-服务编排

## 镜像存储及分发管理

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210323092448.png" alt="geopanel-registrys" style="zoom: 40%;" />

1. harbor 为内网基于 [harbor](https://goharbor.io/) 搭建的私有docker registry;
2. 对于自行构建的镜像，我们只需要将镜像推送到harbor，根据配置好的自动复制规则，镜像会自动同步到阿里云私有docker镜像仓库，之后该镜像即可从阿里云镜像仓库拉取；
3. harbor仓库可使用域账号进行登录，按项目进行读写权限控制；   
4. 阿里云的私有镜像仓库开放一个公用的只读账号，不接受手动镜像推送；   
5. 实际部署时，可根据现场的网络情况，选择使用公司仓库/阿里云仓库在线拉取，或者使用镜像批量导出脚本批量导出镜像文件，进行离线部署；



## GeoPanel服务名及变量命名约定

### 自有服务命名约定   
规范服务命名能方便标识服务之间的逻辑关系，对应的服务命名会反映到集群部署中服务的名称，服务中接口/页面的基础地址，服务相关的配置变量。

* 服务中应包含服务所属的模块内容缩写，如块数据api引擎为blockapi；
* 服务的容器编排名称，镜像名称，服务的基础服务地址，服务在整个集群中的导入或导出的配置变量名称均应保持一致性；

目前有如下几个主要服务单元：

#### **当前集群服务命名**

| 服务             | 命名说明                                                     |
| ---------------- | ------------------------------------------------------------ |
| 块数据API引擎    | 命名为 blockapi ，包含以下服务：<br/>1. `blockapi` : 块数据api引擎服务（基础hasura graphql引擎）<br/>2. `blockapi-token`: 块数据api引擎扩展模块-token管理service <br/>3. `blockapi-db-integrate`：块数据api引擎扩展模块-数据库集成service <br/>4. `blockapi-restapi`: 块数据api引擎扩展模块-restapi service |
| 埋点日志管理系统 | 命名 ： `gpl-data-collection`                                |

#### **当前各服务接口/web界面基础地址：**

| 服务                  | 基础地址             | 示例                                                         |
| --------------------- | -------------------- | ------------------------------------------------------------ |
| blockapi              | -                    | 保持和开源版本graphql-engine一致                             |
| blockapi-token        | /block-api/tks       | http://192.168.43.73:8881/block-api/tks                      |
| blockapi-db-integrate | /block-api/db-intgrs | http://192.168.43.73:8882/block-api/db-intgrs                |
| blockapi-restapi      | /block-api/restapi   | [http://172.17.0.105:8884/block-api/restapi](http://172.17.0.105:8884/block-api/restapi) |
| gpl-data-collection   | /gpl-dc              | http://192.168.43.73:8883/gpl-dc                             |

### 通用变量说明

#### 概述

在服务部署时，我们使用环境变量来为各个服务提供需要的配置，以下通用变量用于减少服务部署时所需要的变量，大致按以下原则：

* 相同含义的变量尽量统一为一个
* 有可能内部和外部用途的服务使用两个变量区分开来
* 变量命名需要带上服务名前缀

> **外部URL和内部URL说明：（下方部分服务会导出内部和外部两个url的变量）**
>
> * **内部URL**：在docker集群内部，可以使用服务名替代IP地址访问对应的服务，一般用于服务内部之间互相访问；（如使用内部URL，在部署时可不需要修改配置）
> * **外部URL**：当服务需要给客户端（如APP或浏览器）或不属于我方服务集群的其他服务调用时，需要提供外部的IP（非docker集群内部）给外部访问；

| **服务**              | **变量名**                                                   | 说明及示例值                                                 | **springboot变量名**                      |
| :-------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | ----------------------------------------- |
| postgres              |                                                              |                                                              |                                           |
| zookeeper             |                                                              | 暂未供外部使用，不导出变量                                   |                                           |
| kafka                 | *kafka 内部地址*<br/>`KAFKA_INTERNAL_URL`                    | kafka:9092                                                   | kafka.internal_url                        |
|                       | *kafka 外部地址*<br/>`KAFKA_EXTERNAL_URL`                    | 192.168.43.22:9094                                           | kafka.external_url                        |
| redis                 | Redis服务主机<br/>`REDIS_HOST`                               | redis                                                        | redis.host                                |
|                       | Redis服务端口<br/>`REDIS_PORT`                               | 6379                                                         | redis.port                                |
|                       | Redis服务访问密码<br/>`REDIS_PASSWORD`                       | vsMEDgmxZdjOi7Nd                                             | redis.password                            |
| blockapi              | 块数据API引擎数据库地址<br/>`HASURA_GRAPHQL_DATABASE_URL`<br/>`BLOCKAPI_DATABASE_URL` | postgres://postgres:<br/>d8cfe3137214759a932014084ac410b9<br/>@postgres:5432/hasura | blockapi.database_url                     |
|                       | 块数据API引擎管理密钥<br/>`HASURA_GRAPHQL_ADMIN_SECRET`<br/>`BLOCKAPI_ADMIN_SECRET` | d8cfe3137214759a932014084ac410b9<br/>两个变量含义一致，优先使用 BLOCKAPI_ADMIN_SECRET | blockapi.admin_secert                     |
|                       | 块数据API引擎内部地址<br/>`BLOCKAPI_INTERNAL_URL`            | `http://graphql-engine:8080`                                 | blockapi.internal_url                     |
|                       | 块数据API引擎的外部地址<br>`BLOCKAPI_EXTERNAL_URL`           | `http://192.168.43.22:8883`                                  | blockapi.external_url                     |
| blockapi-token<br>    | 块数据API引擎token管理服务内部接口地址<br>`BLOCKAPI_TOKEN_INTERNAL_URL` | http://blockapi-token:9099/block-api/tks                     | blockapi.token.internal_url               |
|                       | 块数据API引擎token管理服务外部接口地址<br>`BLOCKAPI_TOKEN_EXTERNAL_URL` | http://192.168.43.73:8881/block-api/tks                      | blockapi.token.external_url               |
| blockapi-db-integrate | 块数据API引擎数据库集成服务外部接口地址<br>`BLOCKAPI_DATABASE_INTEGRATE_EXTERNAL_URL` | http://192.168.43.73:8882/block-api/db-intgrs                | blockapi.database_intergrate.external_url |
| gpl-data-collection   | 埋点系统服务地址，暂未供外部使用，但提供预定义2个变量<br>`GPL_DATACOLLECTION_INTERNAL_URL` |                                                              | gpl_datacollection.internal_url           |
|                       | `GPL_DATACOLLECTION_EXTERNAL_URL`                            |                                                              | gpl_datacollection.external_url           |

#### 在springboot中使用变量
> 待补充



## 当前服务编排策略

当前将所有已经容器化的服务划分为如下服务部署单元：

```mermaid
graph LR

G[GeoPanel] --> B

G --> K

G --> GPL_DC

B[blockapi] --> blockapi-engine
B --> postgres
B --> redis
B --> blockapi-token
B --> blockapi-db-integrate
B --> blockapi-restapi

K[kafka] --> kafka
K --> zookeeper

GPL_DC[gpl-datacollection] --> gpl-datacollection
```

目前分为三块（blockapi，kafka，gpl-datacollection），每个模块分别对应一个swarm的部署yml配置，可以单独进行启动，使用相同的stack名称启动后，则可以进入一个stack中；

部署仓库地址位于[gitlab上](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/geopanel-deploy)。

## 当前部署仓库细节说明

```shell
.
├── README.md -- 文档说明
├── blockapi -- 块数据api引擎的部署配置所在目录
│   ├── README.md -- 块数据api引擎的配置及启动说明文档
│   ├── config.env -- 单独的配置文件，目前未使用
│   ├── db-init - 数据库初始化脚本，仅做备份，目前未使用
│   │   ├── 00_fdws.sh
│   │   ├── 10_postgis.sh
│   │   └── 20_gpl_data_collection.sql
│   ├── docker-compose-arm.yml -- arm版本的部署配置文件
│   ├── docker-compose.yml -- x86版本的部署配置文件
│   └── redis-config -- redis 配置
│       └── redis.conf
├── data -- 数据挂载目录
│   └── redis
├── deploy.sh -- 辅助部署脚本
├── env -- 全局配置目录
│   └── global.env -- 全局配置，包含所有配置项目，如可能有需要使用公共配置的，服务都应该在yml中声明时引用此配置
├── gpl-datacollection -- 埋点管理系统部署配置目录
│   ├── README.md -- 埋点系统的配置修改及启动方式说明文档
│   ├── config.env -- 埋点系统的单独的配置文件，目前未使用
│   └── docker-compose.yml --埋点系统的部署启动配置文件
├── kafka -- kafka的部署配置目录
│   ├── README.md -- kafka服务说明，kafka验证方式说明
│   └── docker-compose.yml -- 部署配置文件
```

总的来说，目前有如下结构设计：

1. 按逻辑相关性将服务进行一定的划分，一个单元的服务的部署相关文件及配置在一个部署目录中单独存储，使用一个docker-compose.yml文件来编排，可以单独启动；
2. 使用一个 `env/global.env` 文件来存放所有需要修改的配置及全局配置/需要共享的配置-以方便部署时统一修改，每个部署单元中预留一个`.env`文件-用于存放私有配置，只是目前都没有使用；
3. 提供了一个 `deploy.sh` 的辅助部署脚本用于简化部署步骤，但此脚本目前并不够完善；
4. 每个部署目录提供README.md单独对当前目录中的部署单元进行说明，一般应包含配置修改说明，部署启动说明，启动成功确认方式，数据挂载情况说明，根据具体情况也可以提供简单的测试步骤；

> 对于各个部署单元的部署文件，不再单独说明，请参考仓库中的yml部署文件及readme





# Gitlab&持续集成&效率工具

```mermaid
graph 
Gitlab[Gitlab&持续集成&效率工具]
Gitlab --> 服务维护
Gitlab --> Gitlab&Sonar使用问题解答与解决
Gitlab --> CI[基于Gitlab CI的自动化流程]
```

## 服务维护

目前有3个服务器需要维护，上面有部署若干服务：

```mermaid
graph 
205[172.17.0.205]
206[172.17.0.206]
208[172.17.0.208]

205 --> gitlab
206 --> sonarqube
206 --> mattermost
208 --> yapi
208 --> confluence
208 --> gitlab-runner
208 --> 移动中心H5站点
```

服务的连接方式及部署的服务可以参考文档： [《Gitlab-SonarQube服务信息汇总》](https://shimo.im/docs/REkKVZppmPcjFQqx/)， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；

以下简要说明各个服务的维护方式及可能遇到的问题。

### gitlab（205）

* 部署目录： `/data/gitlab/`

teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问[tb的此文档目录](https://thoughts.teambition.com/workspaces/5e8da16aaf7af5001a4c7222/folders/5ee970c5b7ad5400012b51ac) 进行查阅；

这里我们重点强调下gitlab的重启可能遇到的问题，**使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab**详细可参考[tb上的此文章](https://thoughts.teambition.com/workspaces/5e8da16aaf7af5001a4c7222/docs/5f4c5eaf77f66f00010659ae)。



### sonarqube （206）

* 部署目录：`/data/_data/sonarqube`

一般只需要启动及重启，可参考   [《Gitlab-SonarQube服务信息汇总》](https://shimo.im/docs/REkKVZppmPcjFQqx/) 的相关小节，主要命令如下：

```shell
# 部署    
docker stack deploy -c docker-compose.yml sonarqube

# 停止 
docker stack down sonarqube

# 重新启动
docker stack up sonarqube -c docker-compose.yml
```

### yapi（208）

* 部署目录： `/data/yapi-docker-deploy` 

```shell
# 启动命令
docker stack deploy -c docker-compose.yml yapi
# 其他维护命令基于yapi的stack执行即可
```

### mattermost相关（206）

mattermost相关请联系段春先



### gitlab-runner（208）

208上的gitlab-runner作为部门的公用runner，执行各种通用任务。



我们在208上注册启动了两个runner，一个使用docker方式运行，一个使用二进制方式直接运行在主机上，使用的时候需要注意区分；

#### docker方式运行的runner

* 使用docker方式运行的runner使用geostar用户运行，用于执行通用任务，使用docker作为执行器。
* 相关维护操作直接对容器进行即可：
  * 重启：`docker restart gitlab-runner`
  * 扩展了命令别名，默认情况下，使用geostar用户在主机上直接执行 gitlab-runner命令时，实际上时执行 `docker exec -it gitlab-runner [命令]` 
  * 执行命令：`docker exec -it gitlab-runner bash`

#### 二进制运行的runner

* 使用二进制运行的runner使用root用户运行，使用shell作为执行器，用于执行需要直接操作主机的命令，如打包docker镜像。
* 相关维护操作需要使用root用户完成（通过 /usr/bin/gitlab-runner 命令）
  * 如，查看状态：`sudo /usr/bin/gitlab-runner status`

## Gitlab&Sonar使用问题解答与解决

sonarqube的启动重启请参考 [《Gitlab-SonarQube服务信息汇总》](https://shimo.im/docs/REkKVZppmPcjFQqx/) 中的sonar的部署方式。

## 基于Gitlab CI的自动化流程相关

这里下面另外启动一个章节说明



# Gitlab相关-Gitlab安装及配置

## 安装

我们使用docker来安装Gitlab，执行如下命令即可安装运行，完成后使用

```shell
export GITLAB_DATA=/data/gitlab
# 设置主机的ip域名
export HOST_IP=192.168.43.62
mkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data
docker run --detach \
        --hostname $HOST_IP \
        --publish 443:443 --publish 80:80 --publish 22:22 \
        --name gitlab \
        --restart always \
        --volume $GITLAB_DATA/config:/etc/gitlab \
        --volume $GITLAB_DATA/logs:/var/log/gitlab \
        --volume $GITLAB_DATA/data:/var/opt/gitlab \
        gitlab/gitlab-ce:13.9.1-ce.0
```

> * 数据全部挂载在外部目录 GITLAB_DATA 中
> * `--hostname 192.168.43.62` : 指定当前服务的IP或者域名，后续将会显示为gitlab代码仓库的克隆地址
> * `--restart always` : 设置服务自动重启

> 查看gitlab的可用版本： 
>
> * [dockerhub/gitlab-ce](dockerhub/gitlab-ce)
> * [gitlab release page](https://about.gitlab.com/releases/categories/releases/)

### **查看启动状态**

启动期间可以使用 `docker ps` 查看状态，如STATUS中显示为`starting`则表示服务还在启动中，如显示为`healthy`则表示服务已正常启动，即可访问 http://192.168.43.62 访问Gitlab的web地址。

```shell
CONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS                 PORTS                                                          NAMES
79b432f0f601        gitlab/gitlab-ce:13.0.6-ce.0   "/assets/wrapper"   2 months ago        Up 2 weeks (healthy)   0.0.0.0:22->22/tcp, 0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp   gitlab
```

也可使用 `docker logs -f gitlab` 来查看gitlab的服务启动日志

### 设置root管理员用户密码

首次打开页面后会提示设置root用户的密码，设置后务必记录好用户密码，后续将使用此用户对Gitlab进行管理

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302163607.png" alt="image-20210302163607120" style="zoom:50%;" />

## 配置LDAP

服务启动正常后，`$GITLAB_DATA/config` 文件夹中即生成了gitlab的配置文件，可编辑`$GITLAB_DATA/config/gitlab.rb` （对应容器内部 `/etc/gitlab/gitlab.rb` ）文件来修改gitlab配置以使用LDAP

```shell
vim /etc/gitlab/gitlab.rb
```

通过`?` 搜索`LDAP`，找到如下配置端，按如下方式进行修改：

```ruby
### LDAP Settings
###! Docs: https://docs.gitlab.com/omnibus/settings/ldap.html
###! **Be careful not to break the indentation in the ldap_servers block. It is
###!   in yaml format and the spaces must be retained. Using tabs will not work.**

gitlab_rails['ldap_enabled'] = true

gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
   main:
     label: '域账号'
     host: '172.17.0.3'
     port: 389
     uid: 'sAMAccountName'
     bind_dn: 'CN=智慧城市Mattermost系统,OU=邮箱用户,DC=geostar,DC=com,DC=cn'
     password: '3uQ5V2LDgG'
     encryption: 'plain' # "start_tls" or "simple_tls" or "plain"
     verify_certificates: false
     smartcard_auth: false
     active_directory: true
     allow_username_or_email_login: false # 是否允许以用户名登录（邮箱也会取用户名来严重）
     lowercase_usernames: false
     block_auto_created_users: false
     base: 'OU=武大吉奥-域用户,DC=geostar,DC=com,DC=cn'
     user_filter: ''
EOS
```

> 配置修改说明：
>
> * `ldap_enabled` 需要设置为true
> * `ldap_servers` 配置AD域相关信息
>   * label： 随便取，会显示在gitlab的登录页面
>   * host： 域控制服务器主机地址
>   * port： 域控制器服务端口
>   * uid：  将域用户信息中的哪个字段作为gitlab上的登录标识（一般都是sAMAccountName）
>   * bind_dn： 用于访问域控制服务器的用户账号，用户账号的格式需要使用`CN=xxx,OU=XXX,DC=XXXX` 类似的格式
>   * password： 对应的base_dn账号的密码
>   * base： 用于登录时，会去base所定义的组里面去检索用户是否存在，如用户在这个范围内，才可以登录；如及用于公司一个部门的登录，可将base值配置到部门级别，则其他部分无法以域账号进行登录；
>
> 提示： 如无法确认 uid，bind_dn，base 等的值，可以咨询信息中心或者使用AD域访问查看软件（如：[Apache Directory](http://directory.apache.org/)）连接到域账号控制器服务后，通过图形界面查看对应信息；

修改完毕后需要保存文件后重启gitlab服务，对于docker启动的gitlab来说，可执行如下命令重启服务：

```shell
# 其中gitlab为我们使用docker run 命令时通过--name选项指定的容器名称
docker restart gitlab 
```

待gitlab重启完毕后，登录界面即出现域账号登录的tab入口，点击域账号tab即可使用域账号进行登录

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302161215.png" alt="image-20210302161215567" style="zoom:50%;" />

## 配置邮箱通知

公司邮箱服务器配置：

我们使用向信息中心申请的公共的mattermost邮箱账号。

```ruby
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "mail.geostar.com.cn"
gitlab_rails['smtp_port'] = 25
gitlab_rails['smtp_user_name'] = "zh-mattermost@geostar.com.cn"
gitlab_rails['smtp_password'] = "3uQ5V2LDgG"
gitlab_rails['smtp_domain'] = "geostar.com.cn"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = false
```

163邮箱配置示例：（需在163邮箱中开启SMTP服务，可参考： [CSDN-如何使用163的SMTP服务发邮件？](https://blog.csdn.net/liuyuinsdu/article/details/113878840)）

```ruby
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.163.com"
gitlab_rails['smtp_port'] = 25
gitlab_rails['smtp_user_name'] = "colorless@163.com"
gitlab_rails['smtp_password'] = "密码"
gitlab_rails['smtp_domain'] = "163.com"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = false
```



## 关闭及管理员配置

### 赋予指定域账号管理员权限

在配置了域账号登录之后，先让需要设置为管理员的账号使用域账号登录一次gitlab，登录后gitlab即会为该用户创建关联的gitlab账号。

然后使用root用户登录，进入

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164307.png" alt="image-20210302164306980" style="zoom:50%;" />

将用户的访问类型切换为管理员：

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164354.png" alt="image-20210302164354791" style="zoom:50%;" />

### 关闭用户注册

在配置了域账号登录之后，可以关闭用户注册，即只允许拥有域账号的人员进行登录；

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164139.png" alt="image-20210302164139380" style="zoom:67%;" />



# Gitlab相关-安装并注册Gitlab-Runner 

## 安装Gitlab-Runner

gitlab-runner可以使用docker方式运行，也可以在主机上运行其二进制可执行文件，可按如下方式进行选择：

* 执行通用的构建测试任务及与不需要直接访问主机目录的，以docker方式安装；
* 执行部署类任务或需要直接访问主机目录的，以二进制方式安装；

以下分别介绍上述两种安装方式。



### 使用docker安装gitlab-runner

使用docker方式安装的，需先在主机上安装docker环境，可参考 Docker 官方安装文档。以下操作假设主机上已正确安装并配置了docker运行环境；

>我们使用alpine的镜像来减小大小

```shell
# 建立配置挂载目录
mkdir -p /data/gitlab-runner/config
# 建立构建目录挂载目录
mkdir -p /data/gitlab-runner/home
# 注意，这里我们使用了基于alpine的镜像来减小大小；使用 --restart 标识来自动重启
docker run -d --name gitlab-runner --restart always \
  -v /data/gitlab-runner/config:/etc/gitlab-runner \
  -v /data/gitlab-runner/home:/home/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:alpine
  
# 通过以下命令设置docker开机自启
sudo systemctl enable docker
```

### docker安装的gitlab-runner常用操作

#### 运行命令

使用已有容器

```shell
# 容器已经运行的情况下
# 1. 交互式执行，执行以下命令，然后输入命令
docker exec -it gitlab-runner /bin/bash
# 然后执行命令
gitlab-runer --help
# 2. 单次执行
docker exec gitlab-runner gitlab-runner --help
```

使用临时的：

```shell
docker run --rm -t -i gitlab/gitlab-runner:alpine --help
# -it 使用交互式终端
# --rm 自动删除
```

#### 重启gitlab-runner

```
docker restart gitlab-runner
```

#### 升级版本

```shell
# 获取最新
docker pull gitlab/gitlab-runner:alpine
docker stop gitlab-runner && docker rm gitlab-runner
docker run -d --name gitlab-runner --restart always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /data/gitlab-runner/config:/etc/gitlab-runner \
  -v /data/gitlab-runner/home:/home/gitlab-runner \
  gitlab/gitlab-runner:alpine
```

#### 查看日志

```shell
docker logs gitlab-runner
```

#### 配置 gitlab-runner 别名

在 `~/.bash_profile` 或 `~/.bashrc` 文件中加入如下函数配置，后续运行 gitlab-runner 命令时即可省去docker exec 命令

```shell
# 添加 gitlab-runner 直接执行到容器
function gitlab-runner(){
    docker exec -it gitlab-runner gitlab-runner $@
}
```



### 使用二进制包安装运行gitlab-runner

#### 获取安装包安装并运行

* Centos or RedHat 使用如下命令安装：

  ```shell
  ARCH=$(arch)
  
  curl -LJO "https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner$ARCH.rpm"
  
  rpm -i gitlab-runner_$ARCH.rpm
  ```

* Debian or Ubuntu 使用如下命令安装

  ```shell
  ARCH=$(arch)
  
  curl -LJO "https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_$ARCH.deb"
  
  dpkg -i gitlab-runner_$ARCH.deb
  ```

* Windows 安装

  请参考官方文档： https://docs.gitlab.com/runner/install/windows.html#installation

* 测试是否安装成功，如能成功输出gitlab-runner的用法信息，则表示安装成功

  ```
  gitlab-runner --help
  ```

* 测试是否成功启动

  ```
  gitlab-runner status
  # 如输出 Service is running，则表示成功启动了
  ```

  > 通过docker方式运行的runner在运行 `gitlab-runner status`时会输出 `not running`，这对于docker方式运行的runner是正常的，只有直接运行于主机上的runner需要启动对应的服务；

#### 安装并更新Git版本

Gitlab-CI 任务在 runner 机器上执行，会先通过git获取对应仓库的最新代码，这个获取代码的操作是通过git来完成的，所以我们需要安装git工具；

* **安装Git**

  ```shell
  sudo yum install -y git
   # 查看版本
  git --version
  # centos7 上为 1.8.x，无法满足gitlab要求
  ```

* **升级Git版本**

  某些linux发型版上git版本过低，在执行流水线时会失败，需要升级git版本，可按如下方式从源码安装最新git版本；

  * 下载git v2.27.0源码

    ```shell
    ## 以下下载方式任选其一
    # 可选下载方式1 - 从gitee 克隆
    git clone -b v2.27.0 https://gitee.com/hanlyjiang/git.git git-2.27.0
    cd git-2.27.0 && git checkout -b tag-v2.27.0 v2.27.0
    
    # 可选下载方式2 - 从github直接下载包
    curl -LJO https://github.com/git/git/archive/v2.27.0.tar.gz
    tar -xvf git-2.27.0.tar.gz 
    cd git-2.27.0
    ```

  * 编译安装

    ```shell
    # 安装编译依赖库
    sudo yum install  -y autoconf gcc openssh zlib-devel
    
    # 编译并安装
    make configure ;# as yourself
    ./configure --prefix=/usr ;# as yourself
    make -j8 all ;# as yourself
    sudo make install ;# as root
    
    # 确认版本：
    git --version
    # git version 2.27.0
    ```

#### 将gitlab-runner用户添加到docker用户组（可选）

如需要在该gitlab-runner的CI脚本中运行docker命令，这需要将 gitlab-runner用户添加到docker的用户组，可执行如下命令：

```shell
sudo usermod -a -G docker gitlab-runner

# 验证权限
sudo -u gitlab-runner -H docker info
```

#### 修改 gitlab-runner 构建目录

如在执行ci任务时，拉取代码时报build目录权限问题，可尝试按如下方式修改指定runner的构建目录

1. 查找配置文件路径

   ``` shell
   gitlab-runner list 
   # 其中ConfigFile的值就是对应的配置文件，如：
   # ConfigFile=/etc/gitlab-runner/config.toml
   ```

2. 修改 `builds_dir` 指向

   找对该任务对应的`[[runner]]` 配置段，并在该配置中添加 `builds_dir` 指向新的具有权限的目录，然后重启启动gitlab-runner即可；

   ```yaml
   [[runners]]
     name = "blockdataapi-engine"
     url = "http://172.17.0.205/"
     token = "Y-6zdV9zzi8xsY1rygbn"
     executor = "shell"
     builds_dir = "/data/gitlab-runner/builds"
     [runners.custom_build_dir]
     [runners.cache]
       [runners.cache.s3]
       [runners.cache.gcs]
   ```



## 注册 Runner 到 Gitlab

这里我们将runner注册为群组的Runner，群组runner可以在群组中共享，所有子群组和项目都可以使用该Runner。也可以将Runner注册到指定项目仓库上，操作上只有获取gitlab-runner注册信息时不一样；

### 获取gitlab-runner注册信息

> 如需注册到具体项目，在项目的设置在进入对应的CI/CD设置即可，后续操作流程一致；

在群组的设置中打开 CI/CD 设置

![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180602.png!thumbnail)

展开 Runner 栏位

![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180606.png!thumbnail)

这里我们选择通过手动设置group runner的方式来注册，可以获取到以下信息：

![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180610.png!thumbnail)

### 注册runner

以docker方式运行的gitlab-runner可按如下方式进入交互环境，**直接二进制运行的无需此操作**；

在gitlab-runner 的机器上执行注册命令，将runner注册到gitlab，为了方便操作，我们使用以下命令进入gitlab-runner容器shell环境：

```shell
docker exec -it gitlab-runner /bin/bash
```

执行完成后出现如下交互窗口

```shell
bash-4.4#
```

docker方式运行的runner需在此bash中执行命令，主机之间运行的runner直接在shell中执行即可。

### 执行register命令进行注册

```shell
gitlab-runner register 
# url：
http://172.17.0.205/
# token
cEJ611JDeCWSMyu7WXWi
# description - 用于辨识该注册所属的群组或项目，可以设置为方便区分的字符串
sonarqube-runner
# ci-tag - 标签用于后续CI配置中选择此执行器，后期可以通过gitlab界面更改
sonarqube,common-build
# executor - 后续CI任务的执行方式，docker方式运行的请选择docker
docker
# default image - CI配置中未指定镜像时默认使用的镜像
busybox:1.31.1
```

以下为一个注册过程的交互示例：

```shell
bash-4.4# gitlab-runner register 
Runtime platform                                    arch=amd64 os=linux pid=205 revision=05161b14 version=12.4.1
Running in system-mode.                            
                                                   
Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):
http://172.17.0.205/
Please enter the gitlab-ci token for this runner:
cEJ611JDeCWSMyu7WXWi
Please enter the gitlab-ci description for this runner:
[e0311b0ce34b]: sonarqube-runner
Please enter the gitlab-ci tags for this runner (comma separated):
sonarqube,common-build
Registering runner... succeeded                     runner=cEJ611JD
Please enter the executor: virtualbox, docker+machine, docker-ssh+machine, custom, docker-ssh, parallels, kubernetes, docker, shell, ssh:
docker
Please enter the default Docker image (e.g. ruby:2.6):
busybox:1.31.1
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!
```

### 注册后确认

完成后在刚才的页面可以看到；
![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180615.png)

### 取消注册

使用 list 命令查看当前注册的token及url

```shell
gitlab-runner list
# 输出类似
Runtime platform                                    arch=amd64 os=linux pid=23 revision=05161b14 version=12.4.1
Listing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml
sonarqube-runner                                    Executor=docker Token=wNwxjEztRpKxYDyK1zVd URL=http://172.17.0.205/
```

使用list命令输出的token机url作为参数 使用unregister命令取消注册

```shell
gitlab-runner unregister -t 7KM7ftthLAYeJdsB3Tbk -u http://172.17.0.205/
```



## 了解更多

* [DOCKER 方式安装gitlab-runner](https://docs.gitlab.com/runner/install/docker.html)
* [Linux安装gitlab-runner-Gitlab官方文档](https://docs.gitlab.com/runner/install/linux-manually.html)
* [使用Docker运行Gitlab-Runner-Gitlab官方文档](https://docs.gitlab.com/runner/install/docker.html)
* [注册Runner-Gitlab官方文档](https://docs.gitlab.com/runner/register/index.html)
* [Gitlab-Runner alpine Dockerfile](https://gitlab.com/gitlab-org/gitlab-runner/blob/master/dockerfiles/alpine/Dockerfile)
* [Windows上注册Runner](https://docs.gitlab.com/runner/install/windows.html)
* [如何在docker执行器中构建Docker镜像？](http://github.com/help/ci/docker/using_docker_build.md)



# Gitlab相关-GitlabCI&CD自动化

**可先阅读文档：** 

* Gitlab&Mattermost&Sonarqube介绍-无批注.pdf（本地文件）
* [Gitlab协作工具使用指引](http://172.17.0.205/Public-Share/gitlab-usage)

**关键点总结：**

* 主要概念：Gitlab，gitlab-ci.yml，runner，流水线，job

  * Gitlab 提供代码托管，提供ci/cd能力
  * Gitlab-CI从 项目源码中的gitlab-ci.yml文件中读取CI流程，然后执行，我们在此文件中定义流水线及任务
  * Runner是一个具体的机器，用于执行任务

* Runner执行器：

  * shell：执行与机器相关的任务，需要使用主机命令的，如docker打包，部署
  * docker： 使用容器执行通用的构建任务
  * 注册流程参考：[《2019/11/19-GitlabRunner配置-共享》](https://shimo.im/docs/PVAPV289P6tmFVql/ )

* Gitlab-ci配置参考： http://172.17.0.205/help/ci/yaml/README.md

* Gitlab-ci重要配置 - **job**

  * 定义要执行的任务，使用script定义具体要执行的命令

* Gitlab-ci重要概念 - 阶段 - 定义执行顺序

  * 顶层的stage定义流水线的阶段，job下的stage确定该job的归属，按顶层的stage定义的顺序执行job

* Gitlab-ci重要概念 - **变量** - 用于参数化构建流程 

  * 预定义变量：http://172.17.0.205/help/ci/variables/predefined_variables.md
  * Gitlab Web界面配置变量，支持在群组及项目级别分别配置，项目级别的优先级较高
  * gitlab-ci.yml 中配置变量，yml中配置的变量会被web界面中配置的覆盖

* Gitlab-ci重要配置 - 归档

  * 用于将成果归档，可供下载
  * 用于将成果在不同的阶段的job中传递（Gitlab自动完成）
  * 使用时指定要归档的文件相对于CI_PROJECT_DIR的路径即可
  * **特别注意**要限制归档可以存储的时间，避免无用的归档文件占据gitlab磁盘空间

* Gitlab-ci重要配置 - 规则（only，except，rule）

  * **only/expect**

  * - 提交相关：

    - - branches - 所有分支
      - tags - 所有标签
      - pushes - 推送
      - merge_requests - 提起合并请求
      - external_pull_requests - 外部合并请求（基本用不到）

  * - 其他：

    - - api - 调用gitlab api触发
      - external - 未了解
      - pipelines - 未了解
      - **schedules** ： 定时器（gitlabCI/CD设置页面设置）
      - triggers：- 未了解
      - **web**： 界面手动触发
      - chat - 用不到

  * rules

    * 参考使用规则定义 http://172.17.0.205/help/ci/yaml/README.md#rules
    * 参考示例 [GeoSocial自动部署](http://172.17.0.205/geosocial-pc/auto-build-deploy/front-auto-deploy/-/blob/master/.gitlab-ci.yml)



**CI/CD配置示例**

* [VuePress Web项目CI自动构建及部署](http://172.17.0.205/Development/Mobile/geopanel/h5-sdk-api-document/-/blob/master/.gitlab-ci.yml)
* Android
  * [Android项目CI自动打包-洪山管理通](http://172.17.0.205/Development/Mobile/support/cgt-sgt/hongshan-sgt/-/blob/master/.gitlab-ci.yml)
  * [Android项目自动打包-移动中心APP](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/.gitlab-ci.yml)
* springboot:
  * [springboot gradle自动打包-GeoRobox3.0-后台](http://172.17.0.205/Development/Mobile/georobox_3_0/georobox-mobile-server/-/blob/master/.gitlab-ci.yml)
  * [springboot-gradle打包示例-自动打包-多环境部署](http://172.17.0.205/Public-Share/gitlab-ci-examples/springboot-gradle/-/blob/gitlab-ci/.gitlab-ci.yml)
* sonar代码检查：
  * [使用帮助-Sonar检查通用模板配置](http://172.17.0.205/Public-Share/gitlab-usage/-/wikis/%E4%BD%BF%E7%94%A8Gitlab/%E4%BD%BF%E7%94%A8gitlab-ci%E8%BF%9B%E8%A1%8Csonar%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5#331-%E9%80%9A%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E9%99%A4msbuild%E4%B9%8B%E5%A4%96%E7%9A%84%E9%A1%B9%E7%9B%AE)
  * [C#代码检查示例项目](http://172.17.0.205/Public-Share/gitlab-ci-examples/donet-sonar-scanner-sample-project/-/blob/master/.gitlab-ci.yml)
  * [移动中心Android代码检查](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/.gitlab-ci.yml)

# Gitlab相关-使用提示

## CI脚本中变量含有特殊字符时的处理

对于变量中有`$`的，可以使用两个 `$` 来进行转义，如：

```
robot$$gitlab
```



## 如何检查CI配置？

> 注意： CI规则的检查是和项目相关的，只能在对应的项目中进行检查

检查CI配置是否合规，可在项目的CI/CD界面，点击`CI配置检查（CI lint）`，然后粘贴自己的配置到输入框中执行检查

<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210331103427.png" alt="image-20210331103427469" style="zoom:50%;" />



## Docker Runner的构建加速（配置数据卷）

Docker的Runner非常适合用于作为通用的构建机器，以执行各种不同类型的语言及不同打包工具的编译任务，比方说gradle,maven，npm等等。

一般来说，我们的项目都会使用很多第三方的依赖，而且这些依赖只是在构建需要时从网络上获取，然后构建工具会将这些包缓存在某个目录中，如：

* gradle 一般放置在 `~/.gradle` 目录中，同时也会存储 gradle 的各种版本；
* mvn 一般放置于 `~/.m2` 目录中；

使用容器构建时，这些缓存目录都位于容器内部，也就是每次都需要重新下载，非常浪费时间。所以我们需要能让这些目录可以自动挂载到执行的容器中，gitlab-runner提供了这种能力，具体配置方式参考如下：

1. 找到gitlab-runner的配置文件，可通过如下命令查找，查看其中的ConfigFile指向的目录

   ```shell
   $ sudo /usr/bin/gitlab-runner list
   
   Runtime platform                                    arch=amd64 os=linux pid=15738 revision=05161b14 version=12.4.1
   Listing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml
   blockdataapi-engine                                 Executor=shell Token=Y-6zdV9zzi8xsY1rygbn URL=http://172.17.0.205/
   产品开发部                                               Executor=shell Token=vdxuftxm6EL_fVgAS7Td URL=http://172.17.0.205/
   移动中心-部署                                             Executor=shell Token=zx2vFV3x4S19n5mJDjD_ URL=http://172.17.0.205/
   localhost                                           Executor=shell Token=3xHHCWiysKqf4kWdnA_e URL=http://172.17.0.205/
   ```

   > 注意：如果是通过gitlab运行的gitlab-runner，则在挂载的config目录

2. 找到对应的Runner配置段，可通过name进行区分

   ```yaml
   [[runners]]
     name = "sonarqube-runner"
     url = "http://172.17.0.205/"
     token = "wNwxjEztRpKxYDyK1zVd"
     executor = "docker"
     [runners.custom_build_dir]
     [runners.docker]
       tls_verify = false
       image = "busybox:1.31.1"
       privileged = false
       disable_entrypoint_overwrite = false
       oom_kill_disable = false
       disable_cache = false
       shm_size = 0
     [runners.cache]
       [runners.cache.s3]
       [runners.cache.gcs]
   ```

3. 在  `[runners.docker]` 配置中添加`volumes`配置，示例如下，写法于通过docker挂载命名卷一致 

   ```yaml
   [[runners]]
     name = "sonarqube-runner"
     url = "http://172.17.0.205/"
     token = "wNwxjEztRpKxYDyK1zVd"
     executor = "docker"
     [runners.custom_build_dir]
     [runners.docker]
       tls_verify = false
       image = "busybox:1.31.1"
       privileged = false
       disable_entrypoint_overwrite = false
       oom_kill_disable = false
       disable_cache = false
       volumes = ["/cache", "maven:/root/.m2", "gradle_gradle:/home/gradle/.gradle", "nginx_static:/work/html", "android_build_tools:/android-sdk/build-tools", "android_platforms:/android-sdk/platforms", "android_extras:/android-sdk/extras"]
       shm_size = 0
     [runners.cache]
       [runners.cache.s3]
       [runners.cache.gcs]
   ```

   > 提示：修改后直接保存，无需重新启动gitlab-runner，下次对应的任务跑到这个runner上时，即会自动生效

   > 这里解释下几个卷的配置：
   >
   > * `"maven:/root/.m2"`: 一般的maven的镜像的缓存配置目录在`/root/.m2` 
   > * `"gradle_gradle:/home/gradle/.gradle"`: 一般的gradle镜像的缓存目录 `/home/gradle/.gradle`
   > * `"nginx_static:/work/html"`: 为我们通过docker启动的一个nginx服务，启动时挂载了 nginx_static 到/work/html，在ci任务中，我们可在容器中将web资源拷贝到执行任务的容器内部的/work/html目录即可将web资源发布到该runner上启动的nginx服务中
   > * 另外两个都是自行构建的android构建镜像的缓存目录。

## 使用cache-缓存加速构建

可使用gitlab的cache关键字缓存构建的依赖下载文件

```yaml
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/

stages:
    - test
    - build
    - deploy

build:
  stage: build
  image: node:11-alpine
  script:
    # - npm install --registry=https://registry.npm.taobao.org
    - npm install 
    - npm run build:prod
  artifacts:
    expire_in: 1 hours
    name: "$CI_PROJECT_NAME--$CI_COMMIT_REF_NAME--$CI_COMMIT_SHORT_SHA--$CI_JOB_NAME--$CI_JOB_ID"
    paths:
      - dist/
  tags:
    - common-build
  only:
    - branches
    - web
```

之后在任务开始时，会加载缓存：

![image-20210401153959401](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210406143904.png)

在任务完成后，会保存缓存：

![image-20210401154038947](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401154039.png)

配置前后的构建时间差距如下：（第一次需要3分钟，第二次只需要1分钟）

![image-20210401154401344](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401154404.png)

> 参考： 
>
> * [Cache dependencies in GitLab CI/CD](https://docs.gitlab.com/ee/ci/caching/index.html)
> * [gitlab-ci.yaml - cache](https://docs.gitlab.com/ee/ci/yaml/README.html#cache)





# Gitlab相关-升级记录（12.10.0-13.0.6）

考虑到后续可能需要对gitlab进行升级，这里将之前的一次升级记录贴出，供后续升级作为参考。

> 升级需要选择无人使用的时段，并提前通知。

## 升级准备工作

### **确定升级路线**

- 现有版本：12.10.0
- 当下目标版本：13.0.6
- 结合 [Gitlab升级路线建议](https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations) 确定如下升级路线：
  - 12.10.0 -> 13.0.0 -> 13.0.6 
  - 由于我们跨大版本升级了（12-13），所以引入了 13.0.0 的中间升级路径

### **获取最新版本信息**

- 查看 gitlab release页面 信息
- 查看 gitlab docker hub 获取gitlab-ce docker镜像版本TAG：
- 13.0.0: `gitlab/gitlab-ce:13.0.0-ce.0`
- 13.0.6: `gitlab/gitlab-ce:13.0.6-ce.0`
- 查看升级注意事项
- 升级流程： https://docs.gitlab.com/omnibus/docker/README.html#update
- 版本升级建议路线：https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations

## 备份

备份有两种方式，备份的数据量不相同：

* 对docker挂载的gitlab数据目录整体备份
* 使用 gitlab的 `gitlab-backup create` 命令创建备份，可包含所有git仓库，包括wiki及权限信息。

> 建议对挂载的gitlab数据目录进行一次整体备份，目前暂不清楚gitlab-backup create命令创建的备份是否包含ci相关内容。

以下对gitalb-backup 命令执行备份进行简要介绍。数据目录的备份方式直接对目录进行操作即可。

进入到gitlab部署机器，执行如下命令：

```shell l
docker exec -t <container name> gitlab-backup create
# 如果docker容器的名称是gitlab，则可以执行如下命令，备份完成后位于gitlab的数据目录，如：/data/gitlab/data/backups/
docker exec -t $(docker ps | grep gitlab | awk '{print $1}') gitlab-backup create
# 备份配置目录
sudo tar -cvf /data/gitlab/data/backups/1592710400_2020_06_21_12.10.0_gitlab_config_backup.tar /data/gitlab/config 
```

## 执行升级：

- 进入到gitlab部署机器 

```shell
ssh -p 10022 geostar@172.17.0.205
```

- 获取Gitlab中间版本镜像及最终版本镜像

```shell
docker pull gitlab/gitlab-ce:13.0.0-ce.0
docker pull gitlab/gitlab-ce:13.0.6-ce.0
```

- 停止并移除现有服务

```shell
sudo docker stop gitlab 
sudo docker rm gitlab 
```

- 进行升级，使用 13.0.0 的镜像运行gitlab，gitlab会自动处理数据升级流程

```shell
    sudo docker run --detach \
        --hostname 172.17.0.205 \
        --publish 443:443 --publish 80:80 --publish 22:22 \
        --name gitlab \
        --restart always \
        --volume /data/gitlab/config:/etc/gitlab \
        --volume /data/gitlab/logs:/var/log/gitlab \
        --volume /data/gitlab/data:/var/opt/gitlab \
        gitlab/gitlab-ce:13.0.0-ce.0
```

- 待 13.0.0 升级完毕之后，升级到 13.0.6，使用 13.0.6 的镜像运行gitlab

```shell
      sudo docker stop gitlab 
      sudo docker rm gitlab 
      sudo docker run --detach \
        --hostname 172.17.0.205 \
        --publish 443:443 --publish 80:80 --publish 22:22 \
        --name gitlab \
        --restart always \
        --volume /data/gitlab/config:/etc/gitlab \
        --volume /data/gitlab/logs:/var/log/gitlab \
        --volume /data/gitlab/data:/var/opt/gitlab \
        gitlab/gitlab-ce:13.0.6-ce.0
```

## 确认升级成功

登录管理员账号，进入管理中心-仪表盘，查看gitlab版本：

![image-20210302165417697](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302165417.png)





# 可视化部署及运维系统（未开始...）

此部分工作暂未开始，仅简单记录。

## 整体实现方式考虑

整体实现上需要建立一套概念模型，可结合k8s及swarm中的相关单元进行组合建立；



## 单点功能考虑

针对单个点可能的实现方式进行比较分析，选择合适的方向。

* 即时打包镜像vs预打包镜像： 结论是使用预打包镜像；

### 即时打包镜像vs预打包镜像

#### **说明：**

* docker体系中，服务的模板是镜像，从镜像启动容器作为服务；

#### **即时打包镜像**:

* 优点：

  * 节省基础镜像空间
  * 可以后期修改打包过程(如修改启动参数等）

* 缺点：

  * **增加运维人员理解负担**：运维人员关注的应该是如何启动服务，升级服务，扩展服务； docker运行的服务的基础是镜像，镜像打包其实是一个中间过程，最终的服务模板其实是镜像，服务镜像制作的过程对于每个服务是不一样的，（如java的打包，web的打包，go的打包，甚至于同一种框架说产生的服务，其打包脚本可能都有区别），服务之间的差异性较大，而这些差异性对于运维人员来说，没有必要知道；
  * **因非高频动作引入太多复杂度**： 
    * 不同服务的镜像制作流程差异非常大，如果将各种服务的打包过程定义到部署运维系统中，并提供可视化的界面，需要针对每一种类型的服务提供
      * 各自的基础镜像；
      * 增量打包脚本；
      * 打包参数提取及参数配置界面开发制作；
      * 打包后镜像的可用性自动验证代码编写；
      * 更新（包括基础镜像更新，打包脚本更新，配置参数等的后期更新）
  * **不利于服务版本管理**： 由于最终将运行的服务镜像制作过程后移到了运维系统使用人员手中，镜像打包的版本标记可能失去控制，不利于后期的版本升级，回退，扩展操作，后期有问题时，开发也要花费一定时间厘清版本（当然可以通过引入额外的机制来解决，不过又引入了复杂度）

  

#### **预打包镜像**：

* 优点
  * **服务可用性及一致性保证**：
    * 服务提供者直接提供服务镜像，可在镜像打包后进行测试确认，保证镜像工作符合开发人员预期；
    * 没有中间过程，运行的镜像一定是经过服务提供的开发人员认可的，后期有问题无疑义；
  * **镜像版本统一管理**：
    * 服务提供者可以控制镜像版本，可以较好的控制服务的升级，回退及扩展；
* 缺点：
  * 预打包镜像由于包含了基础镜像，文件大小相较于即时打包时直接提供成果物的方式可能会大一些；



### 离线网络环境中，镜像的分发

> 待补充





# GeoPanel-移动中心-代码同步

## 一般步骤

1. 克隆gitlab代码到本地



<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" viewBox="586.5 -80 601.5 198.46154" width="601.5" height="198.46154">
  <defs>
    <font-face font-family="Helvetica" font-size="16" units-per-em="1000" underline-position="-75.68359" underline-thickness="49.316406" slope="0" x-height="522.9492" cap-height="717.28516" ascent="770.0195" descent="-229.98047" font-weight="400">
      <font-face-src>
        <font-face-name name="Helvetica"/>
      </font-face-src>
    </font-face>
    <font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.0021" descent="-340.0007" font-weight="400">
      <font-face-src>
        <font-face-name name="PingFangSC-Regular"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.9958" descent="-212.99744" font-weight="400">
      <font-face-src>
        <font-face-name name="HelveticaNeue"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Courier New" font-size="16" panose-1="2 7 3 9 2 2 5 2 4 4" units-per-em="1000" underline-position="-232.91016" underline-thickness="41.015625" slope="0" x-height="422.85156" cap-height="571.28906" ascent="832.5195" descent="-300.29297" font-weight="400">
      <font-face-src>
        <font-face-name name="CourierNewPSMT"/>
      </font-face-src>
    </font-face>
  </defs>
  <metadata> Produced by OmniGraffle 7.18.4\n2021-03-23 05:56:46 +0000</metadata>
  <g id="Canvas_1" stroke="none" fill-opacity="1" fill="none" stroke-opacity="1" stroke-dasharray="none">
    <title>Canvas 1</title>
    <g id="Canvas_1_Layer_1">
      <title>Layer 1</title>
      <g id="Group_33">
        <title>General - Internet</title>
        <g id="Group_35">
          <g id="Graphic_37">
            <path d="M 1188 27.79753 L 1188 34.97935 C 1188 47.996394 1173.6364 61.4623 1156.1307 61.4623 L 1061.8693 61.4623 C 1044.1392 61.4623 1030 48.220826 1030 34.97935 L 1030 27.79753 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_36">
            <path d="M 1090.821 -42.000765 C 1107.2045 -42.000765 1121.3438 -32.350197 1127.6278 -18.210992 C 1130.9943 -20.45531 1134.8097 -21.8019 1139.2983 -21.8019 C 1150.5199 -21.8019 1159.4972 -13.04906 1159.7216 -2.0519012 C 1175.6562 -.7053103 1188 14.556053 1188 26.899803 L 1188 29.592985 C 1188 42.83446 1173.6364 56.07594 1155.9062 56.07594 L 1061.8693 56.07594 C 1044.1392 56.07594 1030 42.83446 1030 29.592985 L 1030 26.899803 C 1030 16.800372 1038.5284 2.8855988 1050.4233 -.4808785 C 1050.4233 -.9297421 1050.4233 -1.154174 1050.4233 -1.6030376 C 1050.4233 -24.04622 1068.3778 -42.000765 1090.821 -42.000765 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_34">
          <text transform="translate(1085.4865 63.4623)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">Gitlab</tspan>
          </text>
        </g>
      </g>
      <g id="Group_38">
        <title>Mobile Services - SNS - Topic</title>
        <g id="Group_40">
          <title>Layer_1</title>
          <g id="Group_53">
            <g id="Graphic_54">
              <rect x="586.5" y="48.76923" width="279" height="47.69231" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_51">
            <g id="Graphic_52">
              <rect x="586.5" y="-5.736264" width="279" height="43.263736" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_49">
            <g id="Graphic_50">
              <path d="M 865.1593 -28.9011 L 865.1593 -20.384615 L 586.5 -20.384615 L 586.5 -28.9011 L 746.95055 -75.23077 Z" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_47">
            <g id="Graphic_48">
              <rect x="586.5" y="-80" width="279" height="51.0989" fill="#ad688b"/>
              <text transform="translate(591.5 -65.45055)" fill="white">
                <tspan font-family="PingFang SC" font-size="16" font-weight="400" fill="white" x="102.5" y="17">本地仓库</tspan>
              </text>
            </g>
          </g>
          <g id="Group_45">
            <g id="Graphic_46">
              <rect x="586.5" y="-13.571429" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Group_43">
            <g id="Graphic_44">
              <rect x="586.5" y="45.36264" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Graphic_42">
            <rect x="595.35714" y="-4.7142857" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 -1.6745485)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="73.91253" y="15">remotes/origin</tspan>
            </text>
          </g>
          <g id="Graphic_41">
            <rect x="595.35714" y="54.56044" width="260.94505" height="24.527473" fill="white"/>
          </g>
        </g>
        <g id="Graphic_39">
          <text transform="translate(677.9922 98.46154)" fill="black">
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="4.800781" y="13">git clone </tspan>
          </text>
        </g>
      </g>
      <g id="Line_55">
        <line x1="865.5" y1="19.23077" x2="1030" y2="21.23077" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="8.0,8.0" stroke-width="2"/>
      </g>
    </g>
  </g>
</svg>


2. 添加github远程仓库到本地仓库（下面取名为github）

   可使用 `git remote -v show` 命令确认当前说注册的远程仓库列表

<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" viewBox="285 274 903 216.46154" width="903" height="216.46154">
  <defs>
    <font-face font-family="Helvetica" font-size="16" units-per-em="1000" underline-position="-75.68359" underline-thickness="49.316406" slope="0" x-height="522.9492" cap-height="717.28516" ascent="770.0195" descent="-229.98047" font-weight="400">
      <font-face-src>
        <font-face-name name="Helvetica"/>
      </font-face-src>
    </font-face>
    <font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.0021" descent="-340.0007" font-weight="400">
      <font-face-src>
        <font-face-name name="PingFangSC-Regular"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.9958" descent="-212.99744" font-weight="400">
      <font-face-src>
        <font-face-name name="HelveticaNeue"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Courier New" font-size="16" panose-1="2 7 3 9 2 2 5 2 4 4" units-per-em="1000" underline-position="-232.91016" underline-thickness="41.015625" slope="0" x-height="422.85156" cap-height="571.28906" ascent="832.5195" descent="-300.29297" font-weight="400">
      <font-face-src>
        <font-face-name name="CourierNewPSMT"/>
      </font-face-src>
    </font-face>
  </defs>
  <metadata> Produced by OmniGraffle 7.18.4\n2021-03-23 05:56:46 +0000</metadata>
  <g id="Canvas_1" stroke="none" fill-opacity="1" fill="none" stroke-opacity="1" stroke-dasharray="none">
    <title>Canvas 1</title>
    <g id="Canvas_1_Layer_1">
      <title>Layer 1</title>
      <g id="Group_3">
        <title>General - Internet</title>
        <g id="Group_5">
          <g id="Graphic_7">
            <path d="M 443 414.7983 L 443 421.9801 C 443 434.99716 428.63636 448.46307 411.1307 448.46307 L 316.8693 448.46307 C 299.1392 448.46307 285 435.2216 285 421.9801 L 285 414.7983 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_6">
            <path d="M 345.82102 345 C 362.20455 345 376.34375 354.65057 382.62784 368.78977 C 385.9943 366.54545 389.80966 365.19886 394.2983 365.19886 C 405.5199 365.19886 414.49716 373.9517 414.7216 384.94886 C 430.65625 386.29545 443 401.5568 443 413.90057 L 443 416.59375 C 443 429.83523 428.63636 443.0767 410.90625 443.0767 L 316.8693 443.0767 C 299.1392 443.0767 285 429.83523 285 416.59375 L 285 413.90057 C 285 403.80114 293.5284 389.88636 305.4233 386.5199 C 305.4233 386.071 305.4233 385.8466 305.4233 385.39773 C 305.4233 362.95455 323.37784 345 345.82102 345 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_4">
          <text transform="translate(336.4865 450.46307)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">GitHub</tspan>
          </text>
        </g>
      </g>
      <g id="Group_8">
        <title>General - Internet</title>
        <g id="Group_10">
          <g id="Graphic_12">
            <path d="M 1188 381.79753 L 1188 388.97935 C 1188 401.9964 1173.6364 415.4623 1156.1307 415.4623 L 1061.8693 415.4623 C 1044.1392 415.4623 1030 402.22083 1030 388.97935 L 1030 381.79753 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_11">
            <path d="M 1090.821 311.99924 C 1107.2045 311.99924 1121.3438 321.6498 1127.6278 335.789 C 1130.9943 333.5447 1134.8097 332.1981 1139.2983 332.1981 C 1150.5199 332.1981 1159.4972 340.95094 1159.7216 351.9481 C 1175.6562 353.2947 1188 368.55605 1188 380.8998 L 1188 383.593 C 1188 396.83446 1173.6364 410.07594 1155.9062 410.07594 L 1061.8693 410.07594 C 1044.1392 410.07594 1030 396.83446 1030 383.593 L 1030 380.8998 C 1030 370.80037 1038.5284 356.8856 1050.4233 353.51912 C 1050.4233 353.07026 1050.4233 352.84583 1050.4233 352.39696 C 1050.4233 329.9538 1068.3778 311.99924 1090.821 311.99924 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_9">
          <text transform="translate(1085.4865 417.4623)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">Gitlab</tspan>
          </text>
        </g>
      </g>
      <g id="Group_13">
        <title>Mobile Services - SNS - Topic</title>
        <g id="Group_15">
          <title>Layer_1</title>
          <g id="Group_28">
            <g id="Graphic_29">
              <rect x="586.5" y="402.76923" width="279" height="47.69231" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_26">
            <g id="Graphic_27">
              <rect x="586.5" y="348.26374" width="279" height="43.263736" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_24">
            <g id="Graphic_25">
              <path d="M 865.1593 325.0989 L 865.1593 333.6154 L 586.5 333.6154 L 586.5 325.0989 L 746.95055 278.76923 Z" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_22">
            <g id="Graphic_23">
              <rect x="586.5" y="274" width="279" height="51.0989" fill="#ad688b"/>
              <text transform="translate(591.5 288.54945)" fill="white">
                <tspan font-family="PingFang SC" font-size="16" font-weight="400" fill="white" x="102.5" y="17">本地仓库</tspan>
              </text>
            </g>
          </g>
          <g id="Group_20">
            <g id="Graphic_21">
              <rect x="586.5" y="340.42857" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Group_18">
            <g id="Graphic_19">
              <rect x="586.5" y="399.36264" width="279" height="42.58242" fill="#ad688b"/>
              <text transform="translate(591.5 402.42985)" fill="black">
                <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="130.5" y="15">s</tspan>
              </text>
            </g>
          </g>
          <g id="Graphic_17">
            <rect x="595.35714" y="349.2857" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 352.32545)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="73.91253" y="15">remotes/origin</tspan>
            </text>
          </g>
          <g id="Graphic_16">
            <rect x="595.35714" y="408.56044" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 411.6002)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="71.23253" y="15">remotes/github</tspan>
            </text>
          </g>
        </g>
        <g id="Graphic_14">
          <text transform="translate(605.9805 452.46154)" fill="black">
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="19.203125" y="13">git remote add github</tspan>
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="0" y="31">https://github/com/xx.git</tspan>
          </text>
        </g>
      </g>
      <g id="Line_30">
        <line x1="586.5" y1="409" x2="443" y2="408.23153" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="8.0,8.0" stroke-width="2"/>
      </g>
      <g id="Line_32">
        <line x1="865.5" y1="382.23077" x2="1030" y2="375.23077" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="8.0,8.0" stroke-width="2"/>
      </g>
    </g>
  </g>
</svg>


3. 使用 `fetch` 命令获取github远程仓库代码到本地

   > 通过 `git fetch github` 获取github远程仓库上的所有分支及tag
   >
   > 如我们需要获取指定分支（如：alpha分支），也可以通过 `git fetch github alpha:refs/remotes/github/alpha` 只拉取指定分支；
   >
   > 如果我们需要获取指定tag（如 v1.3.3），可通过 `git fetch github v1.3.3:refs/tagg/v1.3.3` 只拉取指定tag；


<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" viewBox="285 616.5008 903 198.46154" width="903" height="198.46154">
  <defs>
    <font-face font-family="Helvetica" font-size="16" units-per-em="1000" underline-position="-75.68359" underline-thickness="49.316406" slope="0" x-height="522.9492" cap-height="717.28516" ascent="770.0195" descent="-229.98047" font-weight="400">
      <font-face-src>
        <font-face-name name="Helvetica"/>
      </font-face-src>
    </font-face>
    <font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.0021" descent="-340.0007" font-weight="400">
      <font-face-src>
        <font-face-name name="PingFangSC-Regular"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.9958" descent="-212.99744" font-weight="400">
      <font-face-src>
        <font-face-name name="HelveticaNeue"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Courier New" font-size="16" panose-1="2 7 3 9 2 2 5 2 4 4" units-per-em="1000" underline-position="-232.91016" underline-thickness="41.015625" slope="0" x-height="422.85156" cap-height="571.28906" ascent="832.5195" descent="-300.29297" font-weight="400">
      <font-face-src>
        <font-face-name name="CourierNewPSMT"/>
      </font-face-src>
    </font-face>
    <marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="StickArrow_Marker" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-6 -3 7 6" markerWidth="7" markerHeight="6" color="black">
      <g>
        <path d="M -4.8 0 L 0 0 M 0 1.8 L -4.8 0 L 0 -1.8" fill="none" stroke="currentColor" stroke-width="1"/>
      </g>
    </marker>
  </defs>
  <metadata> Produced by OmniGraffle 7.18.4\n2021-03-23 06:35:35 +0000</metadata>
  <g id="Canvas_1" stroke="none" fill-opacity="1" fill="none" stroke-opacity="1" stroke-dasharray="none">
    <title>Canvas 1</title>
    <g id="Canvas_1_Layer_1">
      <title>Layer 1</title>
      <g id="Group_57">
        <title>General - Internet</title>
        <g id="Group_59">
          <g id="Graphic_61">
            <path d="M 443 757.2991 L 443 764.4809 C 443 777.4979 428.63636 790.9638 411.1307 790.9638 L 316.8693 790.9638 C 299.1392 790.9638 285 777.7224 285 764.4809 L 285 757.2991 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_60">
            <path d="M 345.82102 687.5008 C 362.20455 687.5008 376.34375 697.1513 382.62784 711.2905 C 385.9943 709.0462 389.80966 707.6996 394.2983 707.6996 C 405.5199 707.6996 414.49716 716.4525 414.7216 727.4496 C 430.65625 728.7962 443 744.0576 443 756.4013 L 443 759.0945 C 443 772.336 428.63636 785.5775 410.90625 785.5775 L 316.8693 785.5775 C 299.1392 785.5775 285 772.336 285 759.0945 L 285 756.4013 C 285 746.3019 293.5284 732.3871 305.4233 729.02065 C 305.4233 728.5718 305.4233 728.34736 305.4233 727.8985 C 305.4233 705.4553 323.37784 687.5008 345.82102 687.5008 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_58">
          <text transform="translate(336.4865 792.9638)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">GitHub</tspan>
          </text>
        </g>
      </g>
      <g id="Group_62">
        <title>General - Internet</title>
        <g id="Group_64">
          <g id="Graphic_66">
            <path d="M 1188 724.2983 L 1188 731.4801 C 1188 744.4972 1173.6364 757.9631 1156.1307 757.9631 L 1061.8693 757.9631 C 1044.1392 757.9631 1030 744.7216 1030 731.4801 L 1030 724.2983 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_65">
            <path d="M 1090.821 654.5 C 1107.2045 654.5 1121.3438 664.1506 1127.6278 678.2898 C 1130.9943 676.04545 1134.8097 674.6989 1139.2983 674.6989 C 1150.5199 674.6989 1159.4972 683.4517 1159.7216 694.4489 C 1175.6562 695.79545 1188 711.0568 1188 723.4006 L 1188 726.09375 C 1188 739.3352 1173.6364 752.5767 1155.9062 752.5767 L 1061.8693 752.5767 C 1044.1392 752.5767 1030 739.3352 1030 726.09375 L 1030 723.4006 C 1030 713.3011 1038.5284 699.3864 1050.4233 696.0199 C 1050.4233 695.571 1050.4233 695.3466 1050.4233 694.8977 C 1050.4233 672.45455 1068.3778 654.5 1090.821 654.5 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_63">
          <text transform="translate(1085.4865 759.9631)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">Gitlab</tspan>
          </text>
        </g>
      </g>
      <g id="Group_67">
        <title>Mobile Services - SNS - Topic</title>
        <g id="Group_69">
          <title>Layer_1</title>
          <g id="Group_82">
            <g id="Graphic_83">
              <rect x="586.5" y="745.27" width="279" height="47.69231" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_80">
            <g id="Graphic_81">
              <rect x="586.5" y="690.7645" width="279" height="43.263736" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_78">
            <g id="Graphic_79">
              <path d="M 865.1593 667.5997 L 865.1593 676.11615 L 586.5 676.11615 L 586.5 667.5997 L 746.95055 621.27 Z" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_76">
            <g id="Graphic_77">
              <rect x="586.5" y="616.5008" width="279" height="51.0989" fill="#ad688b"/>
              <text transform="translate(591.5 631.0502)" fill="white">
                <tspan font-family="PingFang SC" font-size="16" font-weight="400" fill="white" x="102.5" y="17">本地仓库</tspan>
              </text>
            </g>
          </g>
          <g id="Group_74">
            <g id="Graphic_75">
              <rect x="586.5" y="682.9293" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Group_72">
            <g id="Graphic_73">
              <rect x="586.5" y="741.8634" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Graphic_71">
            <rect x="595.35714" y="691.7865" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 694.8262)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="73.91253" y="15">remotes/origin</tspan>
            </text>
          </g>
          <g id="Graphic_70">
            <rect x="595.35714" y="751.0612" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 754.1009)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="71.23253" y="15">remotes/github</tspan>
            </text>
          </g>
        </g>
        <g id="Graphic_68">
          <text transform="translate(649.1875 794.9623)" fill="black">
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="0" y="13">git fetch github</tspan>
          </text>
        </g>
      </g>
      <g id="Line_84">
        <line x1="573.6002" y1="751.4317" x2="443" y2="750.7323" marker-start="url(#StickArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
      </g>
      <g id="Line_85">
        <line x1="865.5" y1="715.7315" x2="1030" y2="717.7315" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="8.0,8.0" stroke-width="2"/>
      </g>
    </g>
  </g>
</svg>




4. 将上一步拉取的github远程仓库上的分支/tag推送到gitlab远程仓库的指定分支；

   > 推送分支到gitlab：`git push origin refs/remotes/github/alpha:alpha` 
   >
   > 推送tag到github：`git push origin refs/tags/v1.3.3:v1.3.3`

<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns="http://www.w3.org/2000/svg" xmlns:xl="http://www.w3.org/1999/xlink" viewBox="285 956 903 234.46154" width="903" height="234.46154">
  <defs>
    <font-face font-family="Helvetica" font-size="16" units-per-em="1000" underline-position="-75.68359" underline-thickness="49.316406" slope="0" x-height="522.9492" cap-height="717.28516" ascent="770.0195" descent="-229.98047" font-weight="400">
      <font-face-src>
        <font-face-name name="Helvetica"/>
      </font-face-src>
    </font-face>
    <font-face font-family="PingFang SC" font-size="16" panose-1="2 11 4 0 0 0 0 0 0 0" units-per-em="1000" underline-position="-150" underline-thickness="58" slope="0" x-height="600" cap-height="860" ascent="1060.0021" descent="-340.0007" font-weight="400">
      <font-face-src>
        <font-face-name name="PingFangSC-Regular"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Helvetica Neue" font-size="16" panose-1="2 0 5 3 0 0 0 2 0 4" units-per-em="1000" underline-position="-100" underline-thickness="50" slope="0" x-height="517" cap-height="714" ascent="951.9958" descent="-212.99744" font-weight="400">
      <font-face-src>
        <font-face-name name="HelveticaNeue"/>
      </font-face-src>
    </font-face>
    <font-face font-family="Courier New" font-size="16" panose-1="2 7 3 9 2 2 5 2 4 4" units-per-em="1000" underline-position="-232.91016" underline-thickness="41.015625" slope="0" x-height="422.85156" cap-height="571.28906" ascent="832.5195" descent="-300.29297" font-weight="400">
      <font-face-src>
        <font-face-name name="CourierNewPSMT"/>
      </font-face-src>
    </font-face>
    <marker orient="auto" overflow="visible" markerUnits="strokeWidth" id="FilledArrow_Marker" stroke-linejoin="miter" stroke-miterlimit="10" viewBox="-1 -3 7 6" markerWidth="7" markerHeight="6" color="black">
      <g>
        <path d="M 4.8 0 L 0 -1.8 L 0 1.8 Z" fill="currentColor" stroke="currentColor" stroke-width="1"/>
      </g>
    </marker>
  </defs>
  <metadata> Produced by OmniGraffle 7.18.4\n2021-03-23 06:34:36 +0000</metadata>
  <g id="Canvas_1" stroke="none" fill-opacity="1" fill="none" stroke-opacity="1" stroke-dasharray="none">
    <title>Canvas 1</title>
    <g id="Canvas_1_Layer_1">
      <title>Layer 1</title>
      <g id="Group_87">
        <title>General - Internet</title>
        <g id="Group_89">
          <g id="Graphic_91">
            <path d="M 443 1096.7983 L 443 1103.9801 C 443 1116.9972 428.63636 1130.4631 411.1307 1130.4631 L 316.8693 1130.4631 C 299.1392 1130.4631 285 1117.2216 285 1103.9801 L 285 1096.7983 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_90">
            <path d="M 345.82102 1027 C 362.20455 1027 376.34375 1036.6506 382.62784 1050.7898 C 385.9943 1048.5455 389.80966 1047.1989 394.2983 1047.1989 C 405.5199 1047.1989 414.49716 1055.9517 414.7216 1066.9489 C 430.65625 1068.2955 443 1083.5568 443 1095.9006 L 443 1098.5938 C 443 1111.8352 428.63636 1125.0767 410.90625 1125.0767 L 316.8693 1125.0767 C 299.1392 1125.0767 285 1111.8352 285 1098.5938 L 285 1095.9006 C 285 1085.8011 293.5284 1071.8864 305.4233 1068.5199 C 305.4233 1068.071 305.4233 1067.8466 305.4233 1067.3977 C 305.4233 1044.9545 323.37784 1027 345.82102 1027 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_88">
          <text transform="translate(336.4865 1132.4631)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">GitHub</tspan>
          </text>
        </g>
      </g>
      <g id="Group_92">
        <title>General - Internet</title>
        <g id="Group_94">
          <g id="Graphic_96">
            <path d="M 1188 1063.7975 L 1188 1070.9793 C 1188 1083.9964 1173.6364 1097.4623 1156.1307 1097.4623 L 1061.8693 1097.4623 C 1044.1392 1097.4623 1030 1084.2208 1030 1070.9793 L 1030 1063.7975 Z" fill="#7d7c7c"/>
          </g>
          <g id="Graphic_95">
            <path d="M 1090.821 993.9992 C 1107.2045 993.9992 1121.3438 1003.6498 1127.6278 1017.789 C 1130.9943 1015.5447 1134.8097 1014.1981 1139.2983 1014.1981 C 1150.5199 1014.1981 1159.4972 1022.951 1159.7216 1033.9481 C 1175.6562 1035.2947 1188 1050.556 1188 1062.8998 L 1188 1065.593 C 1188 1078.8345 1173.6364 1092.076 1155.9062 1092.076 L 1061.8693 1092.076 C 1044.1392 1092.076 1030 1078.8345 1030 1065.593 L 1030 1062.8998 C 1030 1052.8004 1038.5284 1038.8856 1050.4233 1035.5191 C 1050.4233 1035.0703 1050.4233 1034.8458 1050.4233 1034.397 C 1050.4233 1011.9538 1068.3778 993.9992 1090.821 993.9992 Z" fill="#d2d3d3"/>
          </g>
        </g>
        <g id="Graphic_93">
          <text transform="translate(1085.4865 1099.4623)" fill="black">
            <tspan font-family="Helvetica" font-size="16" font-weight="400" fill="black" x="0" y="15">Gitlab</tspan>
          </text>
        </g>
      </g>
      <g id="Group_97">
        <title>Mobile Services - SNS - Topic</title>
        <g id="Group_99">
          <title>Layer_1</title>
          <g id="Group_112">
            <g id="Graphic_113">
              <rect x="586.5" y="1084.7692" width="279" height="47.69231" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_110">
            <g id="Graphic_111">
              <rect x="586.5" y="1030.2637" width="279" height="43.263736" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_108">
            <g id="Graphic_109">
              <path d="M 865.1593 1007.0989 L 865.1593 1015.6154 L 586.5 1015.6154 L 586.5 1007.0989 L 746.95055 960.7692 Z" fill="#692f56"/>
            </g>
          </g>
          <g id="Group_106">
            <g id="Graphic_107">
              <rect x="586.5" y="956" width="279" height="51.0989" fill="#ad688b"/>
              <text transform="translate(591.5 970.5495)" fill="white">
                <tspan font-family="PingFang SC" font-size="16" font-weight="400" fill="white" x="102.5" y="17">本地仓库</tspan>
              </text>
            </g>
          </g>
          <g id="Group_104">
            <g id="Graphic_105">
              <rect x="586.5" y="1022.4286" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Group_102">
            <g id="Graphic_103">
              <rect x="586.5" y="1081.3626" width="279" height="42.58242" fill="#ad688b"/>
            </g>
          </g>
          <g id="Graphic_101">
            <rect x="595.35714" y="1031.2857" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 1034.3255)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="73.91253" y="15">remotes/origin</tspan>
            </text>
          </g>
          <g id="Graphic_100">
            <rect x="595.35714" y="1090.5604" width="260.94505" height="24.527473" fill="white"/>
            <text transform="translate(600.35714 1093.6002)" fill="black">
              <tspan font-family="Helvetica Neue" font-size="16" font-weight="400" fill="black" x="71.23253" y="15">remotes/github</tspan>
            </text>
          </g>
        </g>
        <g id="Graphic_98">
          <text transform="translate(572.375 1134.4615)" fill="black">
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="76.05078" y="13">git push origin </tspan>
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="52.046875" y="31">refs/remotes/github/</tspan>
            <tspan font-family="Courier New" font-size="16" font-weight="400" fill="black" x="95.25391" y="49">alpha:alpha </tspan>
          </text>
        </g>
      </g>
      <g id="Line_114">
        <line x1="586.5" y1="1091" x2="443" y2="1090.2315" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="8.0,8.0" stroke-width="2"/>
      </g>
      <g id="Line_115">
        <line x1="870.5" y1="1034.1538" x2="1017.2329" y2="1055.3836" marker-end="url(#FilledArrow_Marker)" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
      </g>
    </g>
  </g>
</svg>






## 移动中心同步脚本说明

> 同步脚本gitlab地址： [syncCode.sh](http://172.17.0.205/Development/Mobile/tools/all/-/blob/master/scripts/sync-code/syncCode.sh)

### 用法说明

```shell
source syncCode.sh
WORKDIR=/Users/hanlyjiang/Wksp/work/gitlab/MOA-auto-sync
# 移动端代码同步 
sync_work_repo_branch https://chuanqi900:stgzsz821006@github.com/3930615/moa-release-geo.git $WORKDIR/moa-release-geo-github.git git@172.17.0.205:GeoPanel/MobileCenter/geopanel-android.git 
# 后台代码同步
sync_work_repo_branch https://chuanqi900:stgzsz821006@github.com/3930615/moa-release.git $WORKDIR/moa-release-github.git git@172.17.0.205:GeoPanel/MobileCenter/geopanel-mobile-server.git
```

执行如上同步命令之后，会将从链动github仓库获取的所有分支及tag推送到gitlab仓库；





# GeoPanel-移动中心-ARM镜像制作-成果链接

本节介绍移动中心国产化的构建成果，请阅读以下文章：

* [《移动中心国产化-ARM迁移基本思路》](https://shimo.im/docs/0l3NVKX0BgflYN3R/)
* [《移动中心国产化-MOA服务迁移记录》](https://shimo.im/docs/VHgRHrXYq9vQkX3Q/ )
* [《移动中心国产化-实时音视频服务迁移记录》](https://shimo.im/docs/gO3ox1XzJlHlVzqD/ )

相关成果已上传到gitlab仓库的如下分支：

* [arm/0.5.0-dev](http://zh-gitlab.geostar.com.cn/GeoPanel/MobileCenter/geopanel-mobile-server/-/tree/arm/0.5.0-dev)
* [arm/v0.3.0-im](http://zh-gitlab.geostar.com.cn/GeoPanel/MobileCenter/geopanel-mobile-server/-/tree/arm/v0.3.0-im)



# GeoPanel-移动中心-APP相关

本小节介绍移动中心APP相关内容，主要包括如下内容：

* 项目仓库介绍
* 注意点介绍：主要是我方进行的一些修改，对修改点有所了解，以便后续需要合并代码时减少可能由合并导致的错误。

## 项目仓库介绍

### 项目地址

* 项目仓库地址： http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android
* 相关文档： 

### 仓库分支及Tag说明

#### 分支说明

此仓库同步了链动的代码分支，并新建新的分支对链动代码进行修改，具体分支跟踪关系如下：


<svg width="834px" height="587px" viewBox="0 0 834 587" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="移动中心APP分支图" transform="translate(-196.000000, -78.000000)">
            <g id="export" transform="translate(197.000000, 79.000000)">
                <g id="Github链动分支">
                    <g id="架构图/带标题栏框">
                        <g id="编组" stroke-linejoin="round">
                            <g id="分组">
                                <rect id="边框栏" stroke="#FF9500" x="0.5" y="0.5" width="283" height="584"></rect>
                                <rect id="标题栏" fill="#FF9500" x="0" y="0" width="284" height="26"></rect>
                            </g>
                        </g>
                        <text id="标题" font-family="PingFangSC-Regular, PingFang SC" font-size="16" font-weight="normal" letter-spacing="0.0959999995" fill="#FFFFFF">
                            <tspan x="84.8480622" y="17">链动Github仓库</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份-7" transform="translate(20.000000, 499.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-app-workbench</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="157.85841" y="13.2608696">小应用-工作台</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份-6" transform="translate(20.000000, 434.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-app-task</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="169.93041" y="13.2608696">小应用-任务</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份-5" transform="translate(20.000000, 369.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-app-calendar</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="169.93041" y="13.2608696">小应用-日历</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份-4" transform="translate(20.000000, 304.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-app-appmarket</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="145.78641" y="13.2608696">小应用-应用市场</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份-3" transform="translate(20.000000, 239.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-app-addressbook</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="157.85841" y="13.2608696">小应用-通讯录</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份-2" transform="translate(20.000000, 174.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-web-imsdk</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="198.29841" y="13.2608696">imsdk</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支备份" transform="translate(20.000000, 109.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-client-android-module</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="174.31041" y="13.2608696">APP库模块</tspan>
                        </text>
                    </g>
                    <g id="分支/直线分支" transform="translate(20.000000, 44.000000)">
                        <line x1="0.603462208" y1="20.5434783" x2="234.508368" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                        <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="0" y="13.2608696">moa-client-android</tspan>
                        </text>
                        <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="210.52641" y="13.2608696">APP</tspan>
                        </text>
                    </g>
                </g>
                <g id="GeoStar仓库备份" transform="translate(370.000000, 0.000000)">
                    <g id="架构图/带标题栏框备份">
                        <g id="编组" stroke-linejoin="round">
                            <g id="分组">
                                <rect id="边框栏" stroke="#FF9500" x="0.5" y="0.5" width="461" height="583"></rect>
                                <rect id="标题栏" fill="#FF9500" x="0" y="0" width="462" height="26"></rect>
                            </g>
                        </g>
                        <text id="标题" font-family="PingFangSC-Regular, PingFang SC" font-size="16" font-weight="normal" letter-spacing="0.0959999995" fill="#FFFFFF">
                            <tspan x="158.956777" y="17">GeoStar Gitlab仓库</tspan>
                        </text>
                    </g>
                    <g id="链动原分支" transform="translate(18.000000, 44.000000)">
                        <g id="分支/直线分支备份-8" transform="translate(0.000000, 455.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-app-workbench</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="155.172218" y="13.2608696">小应用-工作台</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-9" transform="translate(0.000000, 390.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-app-task</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="167.244218" y="13.2608696">小应用-任务</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-10" transform="translate(0.000000, 325.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-app-calendar</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="167.244218" y="13.2608696">小应用-日历</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-11" transform="translate(0.000000, 260.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-app-appmarket</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="143.100218" y="13.2608696">小应用-应用市场</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-12" transform="translate(0.000000, 195.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-app-addressbook</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="155.172218" y="13.2608696">小应用-通讯录</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-13" transform="translate(0.000000, 130.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-web-imsdk</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="195.612218" y="13.2608696">imsdk</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-14" transform="translate(0.000000, 65.000000)">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-client-android-module</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="171.624218" y="13.2608696">APP库模块</tspan>
                            </text>
                        </g>
                        <g id="分支/直线分支备份-15">
                            <line x1="0.595758436" y1="20.5434783" x2="231.514644" y2="20.5434783" id="分支直线" stroke="#979797" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"></line>
                            <text id="分支名称" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="0" y="13.2608696">moa-client-android</tspan>
                            </text>
                            <text id="说明" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                                <tspan x="207.840218" y="13.2608696">APP</tspan>
                            </text>
                        </g>
                    </g>
                    <g id="编组" transform="translate(115.000000, 67.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="172.132" y="16.5">geo-client-android/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份" transform="translate(115.000000, 129.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="93.772" y="16.5">geo-moa-client-android-module/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份-2" transform="translate(115.000000, 196.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="161.584" y="16.5">geo-moa-web-imsdk/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份-3" transform="translate(118.000000, 259.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="155.548" y="16.5">geo-app-addressbook/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份-4" transform="translate(115.000000, 326.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="166.204" y="16.5">geo-app-appmarket/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份-5" transform="translate(115.000000, 393.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="144.148" y="16.5">geo-app-calendar/nskst/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份-6" transform="translate(115.000000, 456.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="171.112" y="16.5">geo-app-task/nskst/master</tspan>
                        </text>
                    </g>
                    <g id="分支/派生备份-7" transform="translate(115.000000, 519.500000)">
                        <path d="M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24" id="路径-2" stroke="#F7B500" stroke-width="5" stroke-linecap="round"></path>
                        <text id="geo-client-android/m" font-family="NotoSerifCJKsc-Regular, Noto Serif CJK SC" font-size="12" font-weight="normal" letter-spacing="0.0719999996" fill="#000000" fill-opacity="0.85">
                            <tspan x="128.956" y="16.5">geo-app-workbench/nskst/master</tspan>
                        </text>
                    </g>
                </g>
                <g id="连接线" transform="translate(259.000000, 63.000000)" fill="#7A7A7A" fill-rule="nonzero">
                    <path id="直线-2" d="M0.188059701,-4 C2.5043073,-4 4.41182503,-2.25001939 4.6605859,-8.51613636e-05 L9.6880597,0 L9.6880597,1 L4.66051705,1.00070744 C4.41147331,3.25034205 2.50409376,5 0.188059701,5 C-2.29722167,5 -4.3119403,2.98528137 -4.3119403,0.5 C-4.3119403,-1.98528137 -2.29722167,-4 0.188059701,-4 Z M117.31194,-4 L126.31194,0.5 L117.31194,5 L117.311,1 L113.68806,1 L113.68806,0 L117.311,0 L117.31194,-4 Z M19.6880597,0 L19.6880597,1 L13.6880597,1 L13.6880597,0 L19.6880597,0 Z M29.6880597,0 L29.6880597,1 L23.6880597,1 L23.6880597,0 L29.6880597,0 Z M39.6880597,0 L39.6880597,1 L33.6880597,1 L33.6880597,0 L39.6880597,0 Z M49.6880597,0 L49.6880597,1 L43.6880597,1 L43.6880597,0 L49.6880597,0 Z M59.6880597,0 L59.6880597,1 L53.6880597,1 L53.6880597,0 L59.6880597,0 Z M69.6880597,0 L69.6880597,1 L63.6880597,1 L63.6880597,0 L69.6880597,0 Z M79.6880597,0 L79.6880597,1 L73.6880597,1 L73.6880597,0 L79.6880597,0 Z M89.6880597,0 L89.6880597,1 L83.6880597,1 L83.6880597,0 L89.6880597,0 Z M99.6880597,0 L99.6880597,1 L93.6880597,1 L93.6880597,0 L99.6880597,0 Z M109.68806,0 L109.68806,1 L103.68806,1 L103.68806,0 L109.68806,0 Z"></path>
                    <path id="直线-2备份" d="M0.5,61 C2.81637876,61 4.72398135,62.7501788 4.97256844,65.000297 L10,65 L10,66 L4.97245735,66.0007074 C4.7234136,68.2503421 2.81603406,70 0.5,70 C-1.98528137,70 -4,67.9852814 -4,65.5 C-4,63.0147186 -1.98528137,61 0.5,61 Z M117.31194,61 L126.31194,65.5 L117.31194,70 L117.311,66 L114,66 L114,65 L117.311,65 L117.31194,61 Z M20,65 L20,66 L14,66 L14,65 L20,65 Z M30,65 L30,66 L24,66 L24,65 L30,65 Z M40,65 L40,66 L34,66 L34,65 L40,65 Z M50,65 L50,66 L44,66 L44,65 L50,65 Z M60,65 L60,66 L54,66 L54,65 L60,65 Z M70,65 L70,66 L64,66 L64,65 L70,65 Z M80,65 L80,66 L74,66 L74,65 L80,65 Z M90,65 L90,66 L84,66 L84,65 L90,65 Z M100,65 L100,66 L94,66 L94,65 L100,65 Z M110,65 L110,66 L104,66 L104,65 L110,65 Z"></path>
                    <path id="直线-2备份-2" d="M0.5,127 C2.81637876,127 4.72398135,128.750179 4.97256844,131.000297 L10,131 L10,132 L4.97245735,132.000707 C4.7234136,134.250342 2.81603406,136 0.5,136 C-1.98528137,136 -4,133.985281 -4,131.5 C-4,129.014719 -1.98528137,127 0.5,127 Z M117.31194,127 L126.31194,131.5 L117.31194,136 L117.311,132 L114,132 L114,131 L117.311,131 L117.31194,127 Z M20,131 L20,132 L14,132 L14,131 L20,131 Z M30,131 L30,132 L24,132 L24,131 L30,131 Z M40,131 L40,132 L34,132 L34,131 L40,131 Z M50,131 L50,132 L44,132 L44,131 L50,131 Z M60,131 L60,132 L54,132 L54,131 L60,131 Z M70,131 L70,132 L64,132 L64,131 L70,131 Z M80,131 L80,132 L74,132 L74,131 L80,131 Z M90,131 L90,132 L84,132 L84,131 L90,131 Z M100,131 L100,132 L94,132 L94,131 L100,131 Z M110,131 L110,132 L104,132 L104,131 L110,131 Z"></path>
                    <path id="直线-2备份-3" d="M1.5,191 C3.81637876,191 5.72398135,192.750179 5.97256844,195.000297 L11,195 L11,196 L5.97245735,196.000707 C5.7234136,198.250342 3.81603406,200 1.5,200 C-0.985281374,200 -3,197.985281 -3,195.5 C-3,193.014719 -0.985281374,191 1.5,191 Z M117.31194,191 L126.31194,195.5 L117.31194,200 L117.311,196 L115,196 L115,195 L117.311,195 L117.31194,191 Z M21,195 L21,196 L15,196 L15,195 L21,195 Z M31,195 L31,196 L25,196 L25,195 L31,195 Z M41,195 L41,196 L35,196 L35,195 L41,195 Z M51,195 L51,196 L45,196 L45,195 L51,195 Z M61,195 L61,196 L55,196 L55,195 L61,195 Z M71,195 L71,196 L65,196 L65,195 L71,195 Z M81,195 L81,196 L75,196 L75,195 L81,195 Z M91,195 L91,196 L85,196 L85,195 L91,195 Z M101,195 L101,196 L95,196 L95,195 L101,195 Z M111,195 L111,196 L105,196 L105,195 L111,195 Z"></path>
                    <path id="直线-2备份-4" d="M0.482071855,257.000036 C2.79821908,256.990808 4.7126401,258.733051 4.97047097,260.981861 L9.99586739,260.962164 L9.99985142,261.962156 L4.97441669,261.982885 C4.73433754,264.233494 2.83394382,265.990737 0.517928145,265.999964 C-1.96733351,266.009866 -3.99006285,264.00319 -3.99996429,261.517928 C-4.00986573,259.032666 -2.00318979,257.009937 0.482071855,257.000036 Z M117.482139,256.5339 L126.499996,260.998008 L117.517996,265.533829 L117.501,261.533 L114.499022,261.545825 L113.999026,261.547817 L113.995042,260.547825 L114.495038,260.545833 L117.498,260.533 L117.482139,256.5339 Z M19.995788,260.922324 L19.9997721,261.922316 L13.9998197,261.94622 L13.9958356,260.946228 L19.995788,260.922324 Z M29.9957087,260.882483 L29.9996927,261.882475 L23.9997403,261.90638 L23.9957563,260.906387 L29.9957087,260.882483 Z M39.9956293,260.842643 L39.9996133,261.842635 L33.9996609,261.866539 L33.9956769,260.866547 L39.9956293,260.842643 Z M49.9955499,260.802803 L49.999534,261.802795 L43.9995816,261.826699 L43.9955976,260.826707 L49.9955499,260.802803 Z M59.9954706,260.762962 L59.9994546,261.762954 L53.9995022,261.786859 L53.9955182,260.786866 L59.9954706,260.762962 Z M69.9953912,260.723122 L69.9993752,261.723114 L63.9994229,261.747018 L63.9954388,260.747026 L69.9953912,260.723122 Z M79.9953118,260.683282 L79.9992959,261.683274 L73.9993435,261.707178 L73.9953595,260.707186 L79.9953118,260.683282 Z M89.9952325,260.643441 L89.9992165,261.643433 L83.9992641,261.667338 L83.9952801,260.667346 L89.9952325,260.643441 Z M99.9951531,260.603601 L99.9991372,261.603593 L93.9991848,261.627497 L93.9952007,260.627505 L99.9951531,260.603601 Z M109.995074,260.563761 L109.999058,261.563753 L103.999105,261.587657 L103.995121,260.587665 L109.995074,260.563761 Z"></path>
                    <path id="直线-2备份-5" d="M1.48192786,323.000036 C3.79794324,322.990735 5.71233408,324.732719 5.97041043,326.981335 L10.9958338,326.96186 L10.9998499,327.961852 L5.97453919,327.981737 C5.73499066,330.232835 3.83443222,331.990661 1.51807214,331.999964 C-0.967189189,332.009945 -2.98998274,330.003333 -2.99996371,327.518072 C-3.00994468,325.032811 -1.00333348,323.010017 1.48192786,323.000036 Z M117.481996,322.534173 L126.499996,326.997992 L117.518141,331.5341 L117.502,327.534 L115.499007,327.542177 L114.999011,327.544185 L114.994995,326.544193 L115.494991,326.542185 L117.497,326.534 L117.481996,322.534173 Z M20.9957532,326.9217 L20.9997692,327.921692 L14.9998176,327.945788 L14.9958016,326.945796 L20.9957532,326.9217 Z M30.9956726,326.881539 L30.9996886,327.881531 L24.999737,327.905628 L24.9957209,326.905636 L30.9956726,326.881539 Z M40.9955919,326.841379 L40.999608,327.841371 L34.9996563,327.865467 L34.9956403,326.865475 L40.9955919,326.841379 Z M50.9955113,326.801219 L50.9995273,327.801211 L44.9995757,327.825307 L44.9955597,326.825315 L50.9955113,326.801219 Z M60.9954306,326.761058 L60.9994467,327.76105 L54.9994951,327.785147 L54.995479,326.785155 L60.9954306,326.761058 Z M70.99535,326.720898 L70.999366,327.72089 L64.9994144,327.744986 L64.9953984,326.744994 L70.99535,326.720898 Z M80.9952693,326.680738 L80.9992854,327.68073 L74.9993338,327.704826 L74.9953177,326.704834 L80.9952693,326.680738 Z M90.9951887,326.640578 L90.9992047,327.640569 L84.9992531,327.664666 L84.9952371,326.664674 L90.9951887,326.640578 Z M100.995108,326.600417 L100.999124,327.600409 L94.9991725,327.624505 L94.9951564,326.624513 L100.995108,326.600417 Z M110.995027,326.560257 L110.999043,327.560249 L104.999092,327.584345 L104.995076,326.584353 L110.995027,326.560257 Z"></path>
                    <path id="直线-2备份-6" d="M1.5,387 C3.81637876,387 5.72398135,388.750179 5.97256844,391.000297 L11,391 L11,392 L5.97245735,392.000707 C5.7234136,394.250342 3.81603406,396 1.5,396 C-0.985281374,396 -3,393.985281 -3,391.5 C-3,389.014719 -0.985281374,387 1.5,387 Z M117.31194,387 L126.31194,391.5 L117.31194,396 L117.311,392 L115,392 L115,391 L117.311,391 L117.31194,387 Z M21,391 L21,392 L15,392 L15,391 L21,391 Z M31,391 L31,392 L25,392 L25,391 L31,391 Z M41,391 L41,392 L35,392 L35,391 L41,391 Z M51,391 L51,392 L45,392 L45,391 L51,391 Z M61,391 L61,392 L55,392 L55,391 L61,391 Z M71,391 L71,392 L65,392 L65,391 L71,391 Z M81,391 L81,392 L75,392 L75,391 L81,391 Z M91,391 L91,392 L85,392 L85,391 L91,391 Z M101,391 L101,392 L95,392 L95,391 L101,391 Z M111,391 L111,392 L105,392 L105,391 L111,391 Z"></path>
                    <path id="直线-2备份-7" d="M0,451 C2.31637876,451 4.22398135,452.750179 4.47256844,455.000297 L9.5,455 L9.5,456 L4.47245735,456.000707 C4.2234136,458.250342 2.31603406,460 0,460 C-2.48528137,460 -4.5,457.985281 -4.5,455.5 C-4.5,453.014719 -2.48528137,451 0,451 Z M117.31194,451 L126.31194,455.5 L117.31194,460 L117.311,456 L113.5,456 L113.5,455 L117.311,455 L117.31194,451 Z M19.5,455 L19.5,456 L13.5,456 L13.5,455 L19.5,455 Z M29.5,455 L29.5,456 L23.5,456 L23.5,455 L29.5,455 Z M39.5,455 L39.5,456 L33.5,456 L33.5,455 L39.5,455 Z M49.5,455 L49.5,456 L43.5,456 L43.5,455 L49.5,455 Z M59.5,455 L59.5,456 L53.5,456 L53.5,455 L59.5,455 Z M69.5,455 L69.5,456 L63.5,456 L63.5,455 L69.5,455 Z M79.5,455 L79.5,456 L73.5,456 L73.5,455 L79.5,455 Z M89.5,455 L89.5,456 L83.5,456 L83.5,455 L89.5,455 Z M99.5,455 L99.5,456 L93.5,456 L93.5,455 L99.5,455 Z M109.5,455 L109.5,456 L103.5,456 L103.5,455 L109.5,455 Z"></path>
                </g>
            </g>
        </g>
    </g>
</svg>

由上面图可以看出，链动在一个仓库中通过分支分别存放了移动端Android源码，移动端APP库源码，imsdk及示例源码，还有5个基础H5小应用。

* 首先，我们完全同步链动的几个分支（`moa-xxx`）到我们的gitlab仓库；
* 然后，我们基于链动的几个分支，分别拉取了我们自己的分支进行修改，命名为 `geo-xxxx`

#### Tag管理

由于我们在一个仓库中放置了若干个模块，通过分支区分，在建立tag时，也需要相应的区分；另外由于链动也会在仓库中提交tag，所以我们需要对tag的命名作一定的约束，一般tag应将分支名称作为前缀，如：

* [geo-client-android-v1.2.22](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/releases/geo-client-android-v1.2.22): 为android端的最新版本tag
* [geo-app-appmarket-v1.0.2](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/releases/geo-app-appmarket-v1.0.2)： 为小应用的最新版本tag



**Android端版本tag说明**

Android端代码会对应多个地区的项目，如果为每个地区单独区分版本号，会造成主线版本管理混乱。

APP的版本号不与任何项目进行关联，打包时不论针对哪个项目/产品发包，只要发布了Release版本，就将版本号递增。如下图所示：

* 南山块事通发布版本时，版本号为 1.2.19 
* 洪山管理通时则将版本号设置为 1.2.20 

![image-20210406160652462](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210406160652.png)



