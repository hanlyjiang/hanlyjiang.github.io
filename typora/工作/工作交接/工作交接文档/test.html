<h1 id="geopanelå®¹å™¨åŒ–æ¦‚è§ˆ">GeoPanelå®¹å™¨åŒ–æ¦‚è§ˆ</h1>
<p>æ­¤éƒ¨åˆ†ä¸»è¦å·¥ä½œæ˜¯å¯¹GeoPanelä¸­çš„å„æœåŠ¡è¿›è¡Œå®¹å™¨åŒ–æ”¹é€ ï¼Œå³åˆ¶ä½œdockeré•œåƒï¼Œç„¶åå¯¹æœåŠ¡è¿›è¡Œå®¹å™¨åŒ–ç¼–æ’ï¼Œç®€åŒ–éƒ¨ç½²æ­¥éª¤ï¼Œé€‚åº”æ›´åŠ æ™ºèƒ½åŒ–çš„éƒ¨ç½²éœ€æ±‚ã€‚</p>
<p>ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹éƒ¨åˆ†ï¼š</p>
<pre class="mermaid"><code>graph 

GeoPanel[GeoPanelå®¹å™¨åŒ–]
GeoPanel --&gt; pgspideræ‰“åŒ…
GeoPanel --&gt; hasura-å—æ•°æ®APIå¼•æ“
GeoPanel --&gt; å…¬å¸è‡ªç ”é•œåƒæ‰“åŒ…
GeoPanel --&gt; æœåŠ¡ç¼–æ’</code></pre>
<ul>
<li>ç”±äºpgspiderå’Œhasuraçš„æ‰“åŒ…è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥éœ€è¦è¿™é‡Œå•ç‹¬åˆ—å‡ºï¼›</li>
<li>å…¬å¸è‡ªç ”æœåŠ¡çš„é•œåƒæ‰“åŒ…ä¸»è¦æ˜¯springbootçš„é•œåƒæ‰“åŒ…ï¼Œæµç¨‹æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥åˆå¹¶èµ·æ¥è¯´ï¼›</li>
<li>æœåŠ¡ç¼–æ’ä¸­æè¿°å½“å‰å·²ç»å®¹å™¨åŒ–çš„æœåŠ¡åŠä½¿ç”¨swarmç¼–æ’çš„æƒ…å†µï¼›</li>
</ul>
<h1 id="geopanelå®¹å™¨åŒ–-armé•œåƒæ„å»º-é€šç”¨æ­¥éª¤">GeoPanelå®¹å™¨åŒ–-ARMé•œåƒæ„å»º-é€šç”¨æ­¥éª¤</h1>
<p>è¿™é‡Œçš„å›½äº§åŒ–ä¸»è¦æŒ‡ï¼šåˆ¶ä½œarmç‰ˆæœ¬çš„é•œåƒ</p>
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ç§»åŠ¨ä¸­å¿ƒæ‰€æœ‰æœåŠ¡å…¨éƒ¨åŸºäºdockerï¼Œæ•…æ­¤æ–‡æ¡£å®é™…å™è¿°çš„æ˜¯åŸºäºdockeréƒ¨ç½²çš„æœåŠ¡åœ¨armå¹³å°ä¸Šè¿ç§»çš„åŸºæœ¬è·¯å¾„ï¼›</p>
<ol type="1">
<li>ARM ç‰ˆæœ¬Dockerå®‰è£…ï¼›</li>
<li>æ„å»ºæ‰€æœ‰é•œåƒçš„ARMç‰ˆæœ¬ï¼›</li>
</ol>
<h2 id="æµ‹è¯•æœºä¿¡æ¯">æµ‹è¯•æœºä¿¡æ¯</h2>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">CPU</th>
<th style="text-align: left;">FT-1500A 4æ ¸ arm64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">å†…å­˜</td>
<td style="text-align: left;">8G</td>
</tr>
<tr class="even">
<td style="text-align: left;">OS</td>
<td style="text-align: left;">éº’éºŸV10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">åŒ…ç®¡ç†å™¨</td>
<td style="text-align: left;">apt</td>
</tr>
</tbody>
</table>
<h2 id="armæœºå™¨ä¸Šå®‰è£…docker">ARMæœºå™¨ä¸Šå®‰è£…Docker</h2>
<blockquote>
<p><a href="https://docs.docker.com/engine/install/?fileGuid=0l3NVKX0BgflYN3R">Dockerå®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<p>Dockeræ”¯æŒå¦‚ä¸‹ç³»ç»ŸåŠæ¶æ„</p>
<figure>
<img src="https://uploader.shimo.im/f/EgAMxl7X6CbHg4J9.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R" alt="å›¾ç‰‡" /><figcaption aria-hidden="true">å›¾ç‰‡</figcaption>
</figure>
<p>å›½äº§ç³»ç»Ÿä¾æ®å®‰è£…åŒ…çš„æ ¼å¼é€‰æ‹©å¯¹åº”çš„å‚è€ƒç³»ç»Ÿå³å¯ï¼Œå¦‚éº’éºŸv10åŸºäºubuntuï¼Œå¯ä»¥æŒ‰<a href="https://docs.docker.com/engine/install/ubuntu/?fileGuid=0l3NVKX0BgflYN3R">å®˜æ–¹æ–‡æ¡£- Install Docker Engine on Ubuntu</a>è¿›è¡Œå®‰è£…ã€‚</p>
<h3 id="æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯">æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</h3>
<pre class="plain"><code>geostar@geostar-ft1500a:~$ cat /proc/version
Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020</code></pre>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ç³»ç»Ÿæ˜¯åŸºäºubuntu16.04 çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ ubuntu16.04ï¼ˆxenialï¼‰çš„è½¯ä»¶æº</p>
<h3 id="æ·»åŠ è½¯ä»¶æº">æ·»åŠ è½¯ä»¶æº</h3>
<blockquote>
<p>å‚è€ƒï¼š https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/</p>
</blockquote>
<p>æ·»åŠ æ¸…åé•œåƒè½¯ä»¶æºï¼ˆarmæ¶æ„ï¼‰</p>
<pre class="plain"><code># é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse</code></pre>
<p>æ›´æ–°ï¼š</p>
<pre class="plain"><code>sudo apt-get install apt-transport-https
sudo apt-get clean
sudo apt-get update</code></pre>
<h3 id="å®‰è£…docker">å®‰è£…Docker</h3>
<pre class="plain"><code># å¸è½½æ—§ç‰ˆæœ¬docker
sudo apt-get remove docker docker-engine docker.io containerd runc
sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
    
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# ç¡®è®¤keyæ·»åŠ æˆåŠŸ(æŸ¥æ‰¾ï¼š9DC8 5822 9FC7 DD38 854AÂ Â E2D8 8D81 803C 0EBF CD88)
sudo apt-key fingerprint 0EBFCD88</code></pre>
<p>ç¼–è¾‘ /etc/apt/source.listï¼Œæ·»åŠ dockerè½¯ä»¶æºï¼ˆarm64 xenialï¼‰ï¼Œå¹¶ä¿å­˜</p>
<pre class="plain"><code># https://docs.docker.com/engine/install/ubuntu/
deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable</code></pre>
<p>å®‰è£… docker</p>
<pre class="plain"><code>sudo apt-get update
# å®‰è£…Docker
sudo apt-get install docker-ce docker-ce-cli containerd.io
# å®‰è£…æˆåŠŸï¼ŒæŸ¥çœ‹ç‰ˆæœ¬
docker --version
Docker version 19.03.12, build 48a6621</code></pre>
<h2 id="åœ¨dockerhubä¸ŠæŸ¥æ‰¾å·²æœ‰çš„armé•œåƒ">åœ¨Dockerhubä¸ŠæŸ¥æ‰¾å·²æœ‰çš„armé•œåƒ</h2>
<p>å®é™…ä¸Šå¾ˆå¤šé•œåƒéƒ½æœ‰æ„å»ºarmç‰ˆæœ¬ï¼Œå¯¹äºç›´æ¥ä½¿ç”¨çš„é•œåƒï¼Œæˆ–è€…ä½œä¸ºDockerfileä¸­FROMçš„é•œåƒï¼Œå¦‚æœæœ‰å¯¹åº”çš„armç‰ˆæœ¬ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œçœç•¥æ„å»ºè¿‡ç¨‹ã€‚ä»¥<a href="https://hub.docker.com/_/postgres?fileGuid=0l3NVKX0BgflYN3R">postgres</a>ä¸ºä¾‹ï¼Œåœ¨dockerhubä¸Šå¯ä»¥çœ‹åˆ°</p>
<figure>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172741.png!thumbnail" alt="å›¾ç‰‡" /><figcaption aria-hidden="true">å›¾ç‰‡</figcaption>
</figure>
<p>åœ¨å…·ä½“çš„tagä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬çš„é•œåƒæ˜¯å¦æ”¯æŒarmæ¶æ„</p>
<figure>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172750.png!thumbnail" alt="å›¾ç‰‡" /><figcaption aria-hidden="true">å›¾ç‰‡</figcaption>
</figure>
<p>ä½†éœ€è¦ä½¿ç”¨çš„é•œåƒä¸æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥ç¡®è®¤è¯¥é•œåƒæ˜¯å¦æœ‰å¯¹åº”çš„armç‰ˆæœ¬ã€‚</p>
<h2 id="armç‰ˆæœ¬é•œåƒæ„å»ºéarmæœºå™¨ä¸Šæ‰§è¡Œ">ARMç‰ˆæœ¬é•œåƒæ„å»ºï¼ˆéARMæœºå™¨ä¸Šæ‰§è¡Œï¼‰</h2>
<blockquote>
<p>å‚è€ƒï¼š -<a href="https://github.com/docker/cli/blob/master/experimental/README.md?fileGuid=0l3NVKX0BgflYN3R">https://github.com/docker/cli/blob/master/experimental/README.md</a> -<a href="https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R">è·¨å¹³å°æ„å»º Docker é•œåƒæ–°å§¿åŠ¿ï¼Œx86ã€arm ä¸€æŠŠæ¢­</a></p>
</blockquote>
<h3 id="æ„å»ºarmé•œåƒçš„ä¸¤ç§æ–¹å¼">æ„å»ºARMé•œåƒçš„ä¸¤ç§æ–¹å¼</h3>
<p>å¯¹äºæ„å»ºé•œåƒçš„ARMç‰ˆæœ¬ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p>
<ol type="1">
<li>åœ¨ARMæœºå™¨ä¸Šä½¿ç”¨ docker build è¿›è¡Œæ„å»ºï¼›</li>
<li>åœ¨X86/AMD64 çš„æœºå™¨ä¸Šä½¿ç”¨ docker buildx è¿›è¡Œäº¤å‰æ„å»ºï¼›</li>
</ol>
<p>å®é™…æµ‹è¯•ä¸­å‘ç°ç¬¬ä¸€ç§æ–¹å¼åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæœ‰é—®é¢˜ï¼Œå»ºè®®é‡‡ç”¨ç»“åˆé‡‡ç”¨è¿™äºŒç§æ–¹å¼ï¼›</p>
<p>å…³äºç¬¬äºŒç§æ„å»ºæ–¹å¼ï¼Œå¯å…ˆé˜…è¯»<a href="https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R">è·¨å¹³å°æ„å»º Docker é•œåƒæ–°å§¿åŠ¿ï¼Œx86ã€arm ä¸€æŠŠæ¢­</a>è¿›è¡Œäº†è§£ï¼Œä»¥ä¸‹ç®€è¦ä»‹ç»ä½¿ç”¨buildxäº¤å‰æ„å»ºçš„æ–¹å¼ï¼›</p>
<blockquote>
<p><strong>âš ï¸æ³¨æ„ï¼š</strong></p>
<ol type="1">
<li><p>äº¤å‰æ„å»ºå’Œäº¤å‰è¿è¡Œçš„æ–¹å¼ä¼šæœ‰ä¸€äº›æ— æ³•é¢„çŸ¥çš„é—®é¢˜ï¼Œå»ºè®®ç®€å•çš„æ„å»ºæ­¥éª¤ï¼ˆå¦‚åªæ˜¯ä¸‹è½½è§£å‹å¯¹åº”æ¶æ„çš„æ–‡ä»¶ï¼‰å¯è€ƒè™‘åœ¨x86ä¸‹äº¤å‰æ„å»ºï¼Œå¤æ‚çš„ï¼ˆå¦‚éœ€è¦ç¼–è¯‘çš„ï¼‰åˆ™ç›´æ¥åœ¨armæœºå™¨ä¸Šè¿›è¡Œæ„å»ºï¼›</p></li>
<li><p>å®é™…æµ‹è¯•å‘ç°ï¼Œä½¿ç”¨<a href="https://github.com/multiarch/qemu-user-static">qemuæ–¹å¼</a>åœ¨x86å¹³å°ä¸‹è¿è¡Œarmç‰ˆæœ¬çš„é•œåƒæ—¶ï¼Œæ‰§è¡Œç®€å•çš„å‘½ä»¤å¯ä»¥æˆåŠŸï¼ˆå¦‚archï¼‰ï¼Œæ‰§è¡ŒæŸäº›å¤æ‚çš„ç¨‹åºæ—¶ï¼ˆå¦‚å¯åŠ¨javaè™šæ‹Ÿæœºï¼‰ï¼Œä¼šæ— å“åº”ï¼Œæ‰€ä»¥é•œåƒçš„éªŒè¯å·¥ä½œåº”å°½é‡æ”¾ç½®åˆ°armæœºå™¨ä¸Šè¿›è¡Œï¼›</p>
<p>ä¸Šé¢ç¬¬äºŒç‚¹æŒ‰å¦‚ä¸‹æ–¹å¼æµ‹è¯•ï¼š</p>
<ul>
<li><code>docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch</code> å¯æ­£å¸¸è¾“å‡ºï¼›</li>
<li><code>docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version</code> åˆ™ä¼š<strong>å¡ä½</strong>ï¼Œä¸”éœ€è¦ä½¿ç”¨<code>docker stop</code>åœæ­¢å®¹å™¨æ‰å¯ä»¥é€€å‡ºå®¹å™¨ï¼›</li>
</ul></li>
</ol>
</blockquote>
<h3 id="å¯ç”¨è¯•éªŒæ€§åŠŸèƒ½">å¯ç”¨è¯•éªŒæ€§åŠŸèƒ½</h3>
<blockquote>
<p>å‚è€ƒï¼šhttps://docs.docker.com/engine/reference/commandline/cli/#experimental-features æ³¨æ„ï¼šbuildx ä»…æ”¯æŒ docker19.03 åŠä»¥ä¸Šdockerç‰ˆæœ¬</p>
</blockquote>
<p>å¦‚éœ€ä½¿ç”¨ buildxï¼Œéœ€è¦å¼€å¯dockerçš„å®éªŒåŠŸèƒ½åï¼Œæ‰å¯ä»¥ä½¿ç”¨ï¼Œå¼€å¯æ–¹å¼ï¼š</p>
<ul>
<li>ç¼–è¾‘ /etc/docker/daemon.json</li>
<li>æ·»åŠ ï¼š</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="er">Â Â Â </span> <span class="dt">&quot;experimental&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<ul>
<li>ç¼–è¾‘ ï½/.docker/config.json æ·»åŠ ï¼š</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="er">&quot;experimental&quot;</span> <span class="er">:</span> <span class="er">&quot;enabled&quot;</span></span></code></pre></div>
<ul>
<li>é‡å¯Dockerä½¿ç”Ÿæ•ˆï¼š
<ul>
<li>sudo systemctl daemon-reload</li>
<li>sudo systemctl restart docker</li>
</ul></li>
<li>ç¡®è®¤æ˜¯å¦å¼€å¯ï¼š
<ul>
<li>docker version -fâ€™{{.Server.Experimental}}â€™</li>
<li>å¦‚æœè¾“å‡ºtrueï¼Œåˆ™è¡¨ç¤ºå¼€å¯æˆåŠŸ</li>
</ul></li>
</ul>
<h3 id="ä½¿ç”¨buildxæ„å»º">ä½¿ç”¨buildxæ„å»º</h3>
<p>buildx çš„è¯¦ç»†ä½¿ç”¨å¯å‚è€ƒï¼š<a href="https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R">Dockerå®˜æ–¹æ–‡æ¡£-Reference-buildx</a></p>
<h4 id="åˆ›å»º-buildx-æ„å»ºå™¨">åˆ›å»º buildx æ„å»ºå™¨</h4>
<p>ä½¿ç”¨ docker buildx ls å‘½ä»¤æŸ¥çœ‹ç°æœ‰çš„æ„å»ºå™¨</p>
<pre class="shell"><code>docker buildx ls</code></pre>
<p>åˆ›å»ºå¹¶æ„å»ºå™¨ï¼š</p>
<pre class="shell"><code># ä¸‹é¢çš„åˆ›å»ºå‘½ä»¤ä»»é€‰ä¸€æ¡ç¬¦åˆæƒ…å†µçš„å³å¯
# 1. ä¸æŒ‡å®šä»»ä½•å‚æ•°åˆ›å»º
docker buildx create --use --name multiarch-builder
# 2. å¦‚åˆ›å»ºåä½¿ç”¨docker buildx ls å‘ç°æ„å»ºèµ·æ²¡æœ‰armæ¶æ„æ”¯æŒï¼Œå¯ä½¿ç”¨--platformæ˜ç¡®æŒ‡å®šè¦æ”¯æŒçš„æ„å»ºç±»å‹ï¼Œå¦‚ä»¥ä¸‹å‘½ä»¤
docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder
# 3. å¦‚éœ€åœ¨buildxè®¿é—®ç§æœ‰registryï¼Œå¯ä½¿ç”¨hostæ¨¡å¼ï¼Œå¹¶æ‰‹åŠ¨æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œé¿å…buildxæ—¶æ— æ³•è®¿é—®æœ¬åœ°çš„registryä¸»æœº 
docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder </code></pre>
<p>buildx-config.toml é…ç½®æ–‡ä»¶å†™æ³•ç±»ä¼¼ï¼š</p>
<pre class="plain"><code># https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md
# registry configures a new Docker register used for cache import or output.
[registry.&quot;zh-registry.geostar.com.cn&quot;]
Â  mirrors = [&quot;zh-registry.geostar.com.cn&quot;]
Â  http = true
Â  insecure = true</code></pre>
<p><strong>å¯ç”¨æ„å»ºå™¨</strong></p>
<pre class="shell"><code># åˆå§‹åŒ–å¹¶æ¿€æ´»
docker buildx inspect multiarch-builder --bootstrap</code></pre>
<p><strong>ç¡®è®¤æˆåŠŸ</strong></p>
<pre class="plain"><code># ä½¿ç”¨ docker buildx ls æŸ¥çœ‹
docker buildx ls </code></pre>
<h3 id="ä¿®æ”¹dockerfile">ä¿®æ”¹Dockerfile</h3>
<p>å¯¹ Dockerfile çš„ä¿®æ”¹ï¼Œå¤§è‡´éœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ol type="1">
<li>ç¡®è®¤åŸºç¡€é•œåƒï¼ˆFROMï¼‰æ˜¯å¦æœ‰armç‰ˆæœ¬ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯ä»¥ä¸ç”¨æ”¹åŠ¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦å¯»æ‰¾æ›¿ä»£é•œåƒï¼Œå¦‚æ²¡æœ‰æ›¿ä»£é•œåƒï¼Œåˆ™å¯èƒ½éœ€è¦è‡ªè¡Œç¼–è¯‘ï¼›</li>
<li>ç¡®è®¤dockerfileçš„å„ä¸ªæ­¥éª¤ä¸­æ˜¯å¦æœ‰ä¾èµ–CPUæ¶æ„çš„ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éœ€è¦æ›¿æ¢æˆarmæ¶æ„çš„ï¼Œå¦‚åœ¨æ„å»ºjitisçš„é•œåƒæ—¶ï¼ŒDockerfileä¸­æœ‰æ·»åŠ ä¸€ä¸ªamd64æ¶æ„çš„è½¯ä»¶</li>
</ol>
<p><code>ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz</code></p>
<p>æ­¤æ—¶éœ€è¦æ›¿æ¢ä¸ºä¸‹é¢çš„åœ°å€(æ³¨æ„amd64æ›¿æ¢æˆäº†aarch64ï¼Œå½“ç„¶ï¼Œéœ€è¦å…ˆç¡®è®¤ä¸‹è½½åœ°å€ä¸­æœ‰æ— å¯¹åº”æ¶æ„çš„gzåŒ…ï¼Œä¸èƒ½ç®€å•åšå­—ç¬¦æ›¿æ¢)ï¼š</p>
<p><code>ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz</code></p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤è¯¥è½¯ä»¶æœ‰æ­¤æ¶æ„çš„å½’æ¡£åŒ…ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦è€ƒè™‘ä»æºç æ„å»ºï¼›</p>
<blockquote>
<p><strong>æç¤ºï¼š</strong></p>
<p>æ€ä¹ˆç¡®å®šä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶/soåº“çš„å¯¹åº”çš„æ‰§è¡Œæ¶æ„ï¼Ÿ å¯ä»¥é€šè¿‡ <code>file {å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„}</code> æ¥æŸ¥çœ‹ï¼Œ</p>
<p>å¦‚ä¸‹é¢æ˜¯macOSä¸Šæ‰§è¡Œfileå‘½ä»¤çš„è¾“å…¥ï¼Œå¯ä»¥å‘ç°macOSä¸Šçš„gitç¨‹åºå¯ä»¥å…¼å®¹ä¸¤ç§æ¶æ„-<code>x86_64&amp;arm64e</code>ğŸ™„ï¼š</p>
<pre class="shell"><code>file $(which git)
/usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
/usr/bin/git (for architecture x86_64):   Mach-O 64-bit executable x86_64
/usr/bin/git (for architecture arm64e):   Mach-O 64-bit executable arm64e</code></pre>
<p>ä¸‹é¢çš„å‘½ä»¤åˆ™å¯¹ä¸€ä¸ªsoæ–‡ä»¶æ‰§è¡Œäº†fileï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­çš„æ¶æ„ä¿¡æ¯ <code>ARM aarch64</code>ï¼š</p>
<pre class="shell"><code>file /lib/aarch64-linux-gnu/libpthread-2.23.so
/lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped</code></pre>
</blockquote>
<h3 id="docker-buildx-æ„å»ºarm64é•œåƒçš„å‘½ä»¤">docker buildx æ„å»ºarm64é•œåƒçš„å‘½ä»¤</h3>
<p>ä½¿ç”¨ â€“platformæ¥æŒ‡å®šæ¶æ„ï¼Œä½¿ç”¨ <code>--push</code> æˆ– <code>--load</code> æ¥æŒ‡å®šæ„å»ºå®Œæ¯•åçš„åŠ¨ä½œã€‚</p>
<pre class="shell"><code>docker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push </code></pre>
<blockquote>
<p>æç¤ºï¼šå½“æŒ‡å®šå¤šä¸ªæ¶æ„æ—¶ï¼Œåªèƒ½ä½¿ç”¨ â€“push æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œæ— æ³• â€“loadï¼Œæ¨é€æˆåŠŸåå†é€šè¿‡ docker pull â€“platform æ¥æ‹‰å–æŒ‡å®šæ¶æ„çš„é•œåƒ</p>
</blockquote>
<h3 id="æ£€æŸ¥æ„å»ºæˆæœ">æ£€æŸ¥æ„å»ºæˆæœ</h3>
<ol type="1">
<li>é€šè¿‡ <code>docker buildx imagetools inspect</code> å‘½ä»¤æŸ¥çœ‹é•œåƒä¿¡æ¯ï¼Œçœ‹æ˜¯å¦æœ‰å¯¹åº”çš„armæ¶æ„ä¿¡æ¯ï¼›</li>
<li>å®é™…è¿è¡Œé•œåƒï¼Œç¡®è®¤è¿è¡Œæ­£å¸¸ï¼›ï¼ˆåœ¨armæœºå™¨ä¸Šæ‰§è¡Œï¼‰</li>
</ol>
<blockquote>
<p>æç¤ºï¼šå¦‚è¿è¡Œæ—¶è¾“å‡º exec format error ç±»ä¼¼é”™è¯¯ï¼Œåˆ™è¡¨ç¤ºé•œåƒä¸­éƒ¨åˆ†å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ä¸åŒ¹é…ã€‚</p>
</blockquote>
<h2 id="åœ¨x86ä¸Šè¿è¡Œarmé•œåƒ">åœ¨x86ä¸Šè¿è¡Œarmé•œåƒ</h2>
<p>å¯å‚è€ƒ <a href="https://github.com/multiarch/qemu-user-static">github/qemu-user-static</a> ,ç®€è¦æè¿°å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š</p>
<p><code>docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</code></p></li>
<li><p>ä¹‹åå³å¯è¿è¡Œarmç‰ˆæœ¬çš„é•œåƒï¼Œå¦‚ï¼š</p>
<pre class="shell"><code>docker run --rm -t arm64v8/fedora uname -m</code></pre></li>
</ul>
<h1 id="geopanelå®¹å™¨åŒ–-pgspideré•œåƒæ„å»º">GeoPanelå®¹å™¨åŒ–-PGspideré•œåƒæ„å»º</h1>
<h2 id="æ¦‚è§ˆ">æ¦‚è§ˆ</h2>
<p>postgreSQLæ˜¯ä¸€ä¸ªå¼€æºçš„å¯¹è±¡-å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œæœ¬èº«æä¾›äº†x86åŠarmç‰ˆæœ¬çš„é•œåƒï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è‡ªå·±æ„å»ºå¯¹åº”å‘¢ï¼Ÿ</p>
<p><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172802.png" alt="image-20210319141649673" style="zoom: 50%;" /></p>
<p>å› ä¸ºæˆ‘ä»¬éœ€è¦ä½¿ç”¨<a href="https://github.com/pgspider/pgspider">pgspider</a>ï¼Œå®ƒæ˜¯ç»™äºˆpg11.6çš„ä»£ç è¡¥ä¸åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥å¤ç”¨å®˜æ–¹çš„é•œåƒä½œä¸ºåŸºç¡€é•œåƒï¼›</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜æ·»åŠ äº†è®¸å¤špgçš„æ’ä»¶ç”¨äºæ‰©å±•pgçš„èƒ½åŠ›ï¼Œå¦‚æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è‡ªè¡Œæ‰“åŒ…pgé•œåƒï¼›</p>
<h3 id="é•œåƒéœ€è¦åŒ…æ‹¬çš„ç»„ä»¶">é•œåƒéœ€è¦åŒ…æ‹¬çš„ç»„ä»¶ï¼š</h3>
<table>
<thead>
<tr class="header">
<th>ç»„ä»¶</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>postgis11.6</td>
<td>postgreSQL</td>
</tr>
<tr class="even">
<td>pgspider</td>
<td>postgreSQLæºç è¡¥ä¸ï¼Œå¢å¼ºFDWåŠŸèƒ½</td>
</tr>
<tr class="odd">
<td>postgis2.5.3åŠå…¶ä¾èµ–</td>
<td>postgres gis æ’ä»¶ï¼Œç”¨äºæä¾›geometryç›¸å…³æ”¯æŒ</td>
</tr>
<tr class="even">
<td>postgres_fdw</td>
<td>postgres_fdw æ¥å…¥å¤–éƒ¨postgresæ•°æ®æº</td>
</tr>
<tr class="odd">
<td>sqlite_fdw</td>
<td>sqlite_fdw æ¥å…¥å¤–éƒ¨sqliteæ•°æ®æº</td>
</tr>
<tr class="even">
<td>mysql_fdw</td>
<td>mysql_fdw æ¥å…¥å¤–éƒ¨mysqlæ•°æ®æº</td>
</tr>
<tr class="odd">
<td>oracle_fdw</td>
<td>oracle_fdw æ¥å…¥å¤–éƒ¨oracleæ•°æ®æº</td>
</tr>
<tr class="even">
<td>zdb(es_fdw)</td>
<td>es_fdw æ¥å…¥å¤–éƒ¨esæ•°æ®æº</td>
</tr>
<tr class="odd">
<td>debezium</td>
<td>æ•°æ®åº“äº‹ä»¶è½¬ä¸ºäº‹ä»¶æµï¼Œé…åˆkafkaä½¿ç”¨ï¼Œå®ç°æ•°æ®å®æ—¶åŒæ­¥</td>
</tr>
<tr class="even">
<td>wal2json</td>
<td>pg æ—¥å¿—æ ¼å¼è½¬æ¢æ’ä»¶ï¼Œé…åˆdebeziumä½¿ç”¨ï¼Œä»¥jsonæ ¼å¼æ¨é€äº‹ä»¶æµ</td>
</tr>
</tbody>
</table>
<h3 id="æ•´ä½“æ„å»ºæµç¨‹">æ•´ä½“æ„å»ºæµç¨‹</h3>
<p>ä¸ºäº†æ„å»ºæ­¤é•œåƒï¼Œæˆ‘ä»¬åˆ¶ä½œäº†è‹¥å¹²è¾…åŠ©é•œåƒï¼ŒåŒ…æ‹¬ï¼š</p>
<pre class="mermaid"><code>graph 
builder

pgspider-base

postgis-pgspider</code></pre>
<p>å…¶ä¸­:</p>
<ul>
<li><code>builder</code> é•œåƒä¸ºæˆ‘ä»¬çš„æ„å»ºå™¨é•œåƒï¼Œç”¨åšpgspiderçš„ç¼–è¯‘ç¯å¢ƒï¼Œå…¶ä¸­åŒ…å«pg11.6æºç åŠpgspideræºç ï¼ŒåŠç¼–è¯‘å¥½çš„pgåŠpgspiderï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æœªå¯¹æˆæœç‰©è¿›è¡Œæå–ï¼Œå› ä¸ºæ­¤è¿›è¡Œè¦ä¿ç•™æ‰€æœ‰æ„å»ºç¯å¢ƒï¼Œç”¨äºåç»­å…¶ä»–æˆ‘ä»¬é™„åŠ åˆ°pgçš„æ’ä»¶çš„æ„å»ºï¼›</li>
<li><code>pgspider-base</code> é•œåƒä¸­å®‰è£…postgresè¿è¡Œæ‰€éœ€è¦çš„è‹¥å¹²ä¾èµ–ï¼Œä½œä¸ºæœ€ç»ˆé•œåƒæ„å»ºçš„åŸºç¡€ï¼Œé¿å…æ¯æ¬¡æ„å»ºé•œåƒéƒ½éœ€è¦æ‰§è¡Œé‡å¤çš„ä¾èµ–å®‰è£…æ“ä½œï¼›</li>
<li><code>postgis-pgspider</code> ä¸ºæˆ‘ä»¬çš„æœ€ç»ˆé•œåƒï¼›åŸºäº<code>pgspider-base</code>é•œåƒåˆ¶ä½œï¼Œå¹¶åˆå¹¶æˆ‘ä»¬ä½¿ç”¨ <code>builder</code> é•œåƒæ„å»ºçš„æ‰€æœ‰éœ€è¦çš„æˆæœæ–‡ä»¶ï¼›</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†è¯´æ˜ä»¥ä¸Šå‡ ä¸ªé•œåƒåˆ†åˆ«å¦‚ä½•æ„å»ºã€‚</p>
<h3 id="ç°åœ¨æˆæœä»“åº“">ç°åœ¨æˆæœä»“åº“</h3>
<p>Gitlabä»“åº“åœ°å€ï¼š<a href="http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider">geopanel-deploy</a></p>
<blockquote>
<p>æç¤ºï¼š å¯æŸ¥çœ‹<a href="http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider">ä»“åº“ç›®å½•ä¸­çš„README.md</a> äº†è§£æ›´å¤šä¿¡æ¯ï¼›</p>
</blockquote>
<p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre class="shell"><code>pgspider
    â”œâ”€â”€ Dockerfile-base.dockerfile - æ„å»ºpgspider-baseé•œåƒçš„è„šæœ¬
    â”œâ”€â”€ Dockerfile-builder.dockerfile - æ„å»ºpgspider-builderé•œåƒçš„è„šæœ¬
    â”œâ”€â”€ Dockerfile-source-arm-add.dockerfile - æ„å»ºpostgis-pgspideré•œåƒçš„è„šæœ¬ï¼ˆç”¨äºå¢é‡æ„å»ºï¼‰
    â”œâ”€â”€ Dockerfile-source-arm.dockerfile - æ„å»ºpostgis-pgspideré•œåƒçš„è„šæœ¬
    â”œâ”€â”€ Dockerfile-source.dockerfile - æ„å»ºpostgis-pgspideré•œåƒçš„è„šæœ¬
    â”œâ”€â”€ README.md
    â”œâ”€â”€ binary - æˆ‘æ–¹æœ‰ä¿®æ”¹çš„é¢„ç¼–è¯‘çš„fdwï¼ˆx86æ¶æ„ï¼‰
    â”‚Â Â  â”œâ”€â”€ mysql_fdw
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql_fdw--1.1.sql
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql_fdw.control
    â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql_fdw.so
    â”‚Â Â  â”œâ”€â”€ oracle
    â”‚Â Â  â”‚Â Â  â””â”€â”€ oracle_fdw.so
    â”‚Â Â  â””â”€â”€ zdblibs
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a1--1.0.0a2.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a2--1.0.0a3.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a3--1.0.0a4.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a4--1.0.0a5.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a5--1.0.0a6.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a6--1.0.0a7.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a7--1.0.0a8.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a8--1.0.0a9.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a9--10-1.0.0a9.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0--10-1.0.1.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0a9--10-1.0.0b1.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b1--10-1.0.0b2.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b10--10-1.0.0b11.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b11--10-1.0.0b12.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b12--10-1.0.0.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b2--10-1.0.0b3.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b3--10-1.0.0b4.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b4--10-1.0.0b5.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b5--10-1.0.0b6.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b6--10-1.0.0b7.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b7--10-1.0.0b8.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b8--10-1.0.0b9.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b9--10-1.0.0b10.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.1--10-1.0.2.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.2--10-1.0.3.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.3--10-1.0.4.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.4--10-1.0.5.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.5--4.0.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--4.0.sql
    â”‚Â Â      â”œâ”€â”€ zombodb.control
    â”‚Â Â      â””â”€â”€ zombodb.so
    â”œâ”€â”€ binary-arm æˆ‘æ–¹æœ‰ä¿®æ”¹çš„é¢„ç¼–è¯‘çš„fdwï¼ˆarmæ¶æ„ï¼‰
    â”‚Â Â  â”œâ”€â”€ mysql_fdw
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql_fdw--1.1.sql
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mysql_fdw.control
    â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql_fdw.so
    â”‚Â Â  â””â”€â”€ zdblibs
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a1--1.0.0a2.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a2--1.0.0a3.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a3--1.0.0a4.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a4--1.0.0a5.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a5--1.0.0a6.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a6--1.0.0a7.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a7--1.0.0a8.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a8--1.0.0a9.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--1.0.0a9--10-1.0.0a9.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0--10-1.0.1.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0a9--10-1.0.0b1.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b1--10-1.0.0b2.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b10--10-1.0.0b11.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b11--10-1.0.0b12.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b12--10-1.0.0.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b2--10-1.0.0b3.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b3--10-1.0.0b4.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b4--10-1.0.0b5.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b5--10-1.0.0b6.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b6--10-1.0.0b7.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b7--10-1.0.0b8.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b8--10-1.0.0b9.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.0b9--10-1.0.0b10.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.1--10-1.0.2.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.2--10-1.0.3.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.3--10-1.0.4.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.4--10-1.0.5.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--10-1.0.5--4.0.sql
    â”‚Â Â      â”œâ”€â”€ zombodb--4.0.sql
    â”‚Â Â      â”œâ”€â”€ zombodb.control
    â”‚Â Â      â””â”€â”€ zombodb.so
    â”œâ”€â”€ config - æ•°æ®åº“é…ç½®æ–‡ä»¶
    â”‚Â Â  â”œâ”€â”€ pg_hba.conf
    â”‚Â Â  â”œâ”€â”€ pg_hba.conf.raw
    â”‚Â Â  â””â”€â”€ postgresql.conf
    â”œâ”€â”€ debezium - debeziumæ’ä»¶çš„æºç åŠwal2jsonçš„æºç 
    â”‚Â Â  â”œâ”€â”€ README.md
    â”‚Â Â  â”œâ”€â”€ init-debezium.sh
    â”‚Â Â  â”œâ”€â”€ postgres-decoderbufs.tar.gz
    â”‚Â Â  â”œâ”€â”€ test.sql
    â”‚Â Â  â””â”€â”€ wal2json-wal2json_1_0.tar.gz
    â”œâ”€â”€ docker-entrypoint.sh - å…¥å£å¯åŠ¨è„šæœ¬
    â”œâ”€â”€ draft - ä¸´æ—¶æ–‡ä»¶ï¼Œå¯å¿½ç•¥
    â”‚Â Â  â”œâ”€â”€ Dockerfile
    â”‚Â Â  â”œâ”€â”€ Dockerfile-all-in-one.dockerfile
    â”‚Â Â  â”œâ”€â”€ Dockerfile-apt.dockerfile
    â”‚Â Â  â”œâ”€â”€ Dockerfile-postGIS.dockerfile
    â”‚Â Â  â””â”€â”€ README.md
    â”œâ”€â”€ initdb-fdw.sh - åˆå§‹åŒ–fdwsè„šæœ¬
    â”œâ”€â”€ oracle
    â”‚Â Â  â”œâ”€â”€ instantclient-basic-linux.x64-12.2.0.1.0.zip
    â”‚Â Â  â”œâ”€â”€ instantclient-sdk-linux.x64-12.2.0.1.0.zip
    â”‚Â Â  â”œâ”€â”€ instantclient-sqlplus-linux.x64-12.2.0.1.0.zip
    â”‚Â Â  â””â”€â”€ oracle_fdw-ORACLE_FDW_2_2_0.tar.gz
    â”œâ”€â”€ postgis - postgisåŠå…¶ä¾èµ–åº“æºç åŠåˆå§‹åŒ–è„šæœ¬
    â”‚Â Â  â”œâ”€â”€ CGAL-4.11.2.tar.xz
    â”‚Â Â  â”œâ”€â”€ SFCGAL-1.3.5.tar.gz
    â”‚Â Â  â”œâ”€â”€ boost_1_67_0.tar.gz
    â”‚Â Â  â”œâ”€â”€ gdal-3.0.2.tar.gz
    â”‚Â Â  â”œâ”€â”€ geos-3.8.0.tar.bz2
    â”‚Â Â  â”œâ”€â”€ initdb-postgis.sh
    â”‚Â Â  â”œâ”€â”€ libspatialite-4.3.0a.tar.gz
    â”‚Â Â  â”œâ”€â”€ mpfr-4.0.2.tar.gz
    â”‚Â Â  â”œâ”€â”€ postgis-2.5.2.tar.gz
    â”‚Â Â  â”œâ”€â”€ postgis-2.5.3.tar.gz
    â”‚Â Â  â”œâ”€â”€ proj-6.2.0.tar.gz
    â”‚Â Â  â””â”€â”€ update-postgis.sh
    â””â”€â”€ test.sql - æµ‹è¯•æ˜¯å¦æ­£å¸¸å·¥ä½œçš„sqlæ–‡ä»¶
</code></pre>
<h2 id="builderé•œåƒæ„å»º">builderé•œåƒæ„å»º</h2>
<p>builderé•œåƒçš„æ‰“åŒ…è„šæœ¬ä¸º <code>Dockerfile-builder.dockerfile</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„è„šæœ¬æ„å»ºarmåŠx86ç‰ˆæœ¬çš„é•œåƒï¼›</p>
<h3 id="æ‰“åŒ…å‘½ä»¤">æ‰“åŒ…å‘½ä»¤</h3>
<pre class="shell"><code>TAG=$(date +%Y%m%d)
# X86 é•œåƒæ„å»º
docker build -t pgspider-builder:$TAG -f Dockerfile-builder.dockerfile ./
## arm
docker buildx build \
      --progress plain \
      --platform=linux/arm64 \
      -t pgspider-builder-arm:latest \
      -f Dockerfile-builder.dockerfile ./ --load</code></pre>
<h3 id="è„šæœ¬è¯¦è§£">è„šæœ¬è¯¦è§£</h3>
<blockquote>
<p>æ–‡ä»¶åœ°å€ï¼š <a href="http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-builder.dockerfile">Dockerfile-builder.dockerfile</a></p>
</blockquote>
<p>è„šæœ¬å†…å®¹å¦‚ä¸‹ï¼Œè¯·æŸ¥çœ‹è„šæœ¬ä¸­çš„æ³¨é‡Šï¼š</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ç¼–è¯‘åçš„æˆæœå…¶å®ä½äº <code>/usr/local/pgspider</code> ç›®å½•ä¸­ï¼Œè¿™ä¸ªåé¢ä¼šç”¨åˆ°ï¼›</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pgspider æºç æ„å»ºé•œåƒï¼ŒåŒ…å«pgspideræºç åŠä¸­é—´ä¸´æ—¶æˆæœï¼Œç”¨äºåç»­æ„å»ºå…¶ä»–fdwåŠæå–pgspiderå¯è¿è¡Œé•œåƒ</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">## ä½¿ç”¨ debian:stretch-slim ä½œä¸ºåŸºç¡€</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> debian:stretch-slim</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y build-essential git libossp-uuid-dev wget libreadline-dev  zlib1g-dev</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®å·¥ä½œç›®å½•ä¸ºapp</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">## </span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># æ¥æº https://github.com/docker-library/postgres/blob/master/11/Dockerfile</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">## é…ç½®localesä¸ºen_US.utf8</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux; \</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>   if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>       <span class="co"># if this file exists, we&#39;re likely in &quot;debian:xxx-slim&quot;, and locales are thus being excluded so we need to remove that exclusion (since we need locales)</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>       grep -q <span class="st">&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; \</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>       sed -ri <span class="st">&#39;/\/usr\/share\/locale/d&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; \</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>       ! grep -q <span class="st">&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; \</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>   fi; \</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>   apt-get update; apt-get install -y locales; rm -rf /var/lib/apt/lists/*; \</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>   localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG en_US.utf8</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…æ‰€éœ€ä¾èµ–</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux; \</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>   apt-get update; \</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># install &quot;nss_wrapper&quot; in case we need to fake &quot;/etc/passwd&quot; and &quot;/etc/group&quot; (especially for OpenShift)</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/docker-library/postgres/issues/359</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co"># https://cwrap.org/nss_wrapper.html</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>   apt-get install -y --no-install-recommends libnss-wrapper; \</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>   rm -rf /var/lib/apt/lists/*</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co">## è·å–pg11.6æºç </span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> wget https://ftp.postgresql.org/pub/source/v11.6/postgresql-11.6.tar.gz</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co">## è·å–pgspiderçš„è¡¥ä¸åŒ…</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> wget https://raw.githubusercontent.com/pgspider/pgspider/master/pgspider.patch</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co">## è§£å‹pg</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> tar xvf postgresql-11.6.tar.gz</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co">## åº”ç”¨pgspideræºç è¡¥ä¸åŒ…åˆ°pgæºç </span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> patch -p1 -d postgresql-11.6 &lt; /app/pgspider.patch</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co">## å¼€å§‹æ‰§è¡Œç¼–è¯‘ï¼Œå¯å‚è€ƒpgspider githubé¡µé¢</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd postgresql-11.6 \</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; ./configure --with-uuid=ossp \</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>   <span class="co">## ç¼–è¯‘PGå¹¶install</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; make &amp;&amp; make install \</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>   <span class="co">## ç¼–è¯‘pgspider_core_fdw å¹¶install</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; cd /app/postgresql-11.6/contrib/pgspider_core_fdw \</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; make &amp;&amp; make install \</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>   <span class="co">## ç¼–è¯‘ pgspider_fdw å¹¶install</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; cd /app/postgresql-11.6/contrib/pgspider_fdw \</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; make &amp;&amp; make install \</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>   <span class="co">## ç¼–è¯‘postgres_fdwå¹¶install</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; cd /app/postgresql-11.6/contrib/postgres_fdw \</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; make &amp;&amp; make install \</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>   <span class="co">## ç¼–è¯‘contribå¹¶install</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; cd /app/postgresql-11.6/contrib \</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>   &amp;&amp; make &amp;&amp; make install</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PATH $PATH:/usr/local/pgspider/bin</span></code></pre></div>
<p>ä¸Šé¢çš„é•œåƒæ„å»ºå®Œæˆä¹‹åï¼Œé•œåƒä¸­å³åŒ…å«äº†pgspiderçš„æºç ï¼Œå·²ç»ç¼–è¯‘å¥½çš„pgspdierï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šåŸºäºæ­¤é•œåƒè¿›è¡Œæ„å»ºï¼›</p>
<h2 id="baseé•œåƒæ„å»º">baseé•œåƒæ„å»º</h2>
<p>base é•œåƒçš„æ‰“åŒ…è„šæœ¬ä¸º <code>Dockerfile-base.dockerfile</code>ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„è„šæœ¬æ„å»ºarmåŠx86ç‰ˆæœ¬çš„é•œåƒï¼›</p>
<h3 id="æ‰“åŒ…å‘½ä»¤-1">æ‰“åŒ…å‘½ä»¤</h3>
<pre class="shell"><code>TAG=$(date +%Y%m%d)
# æ‰“åŒ…x86ç‰ˆæœ¬
docker build -t pgspider-base:$TAG -f Dockerfile-base.dockerfile ./
## arm
docker buildx build \
      --progress plain \
      --platform=linux/arm64 \
      -t pgspider-base-arm:$TAG \
      -f Dockerfile-base.dockerfile ./ --load
      
## ä¹Ÿå¯ä½¿ç”¨ä¸€æ¡å‘½ä»¤æ„å»ºä¸¤ä¸ªç‰ˆæœ¬çš„é•œåƒï¼Œæ­¤æ—¶å¿…é¡»åœ¨é•œåƒtagä¸­åŒ…å«å¯ç”¨çš„docker registryåœ°å€ï¼Œå¹¶ä¸”ä½¿ç”¨ `--push` å‚æ•°åœ¨æ‰“åŒ…å®Œæˆåæ¨é€é•œåƒåˆ°registry
## å®Œæˆåå†æ‹‰å–åˆ°æœ¬åœ°è¿›è¡Œæµ‹è¯•
docker buildx build \
      --progress plain \
      --platform=linux/arm64,linux/amd64 \
      -t hanlyjiang/pgspider-base-arm:$TAG \
      -f Dockerfile-base.dockerfile ./ --push</code></pre>
<h3 id="è„šæœ¬è¯¦è§£-1">è„šæœ¬è¯¦è§£</h3>
<blockquote>
<p>è„šæœ¬åœ¨çº¿åœ°å€ï¼š <a href="http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-base.dockerfile">gitlab</a></p>
</blockquote>
<div class="sourceCode" id="cb24"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PGSpider åŸºç¡€é•œåƒ</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. å®‰è£…éœ€è¦çš„ä¾èµ–ï¼Œé¿å…åç»­æ¯æ¬¡æ„å»ºæ—¶éƒ½éœ€è¦å®‰è£…ï¼ˆä¾èµ–éƒ¨åˆ†å¯èƒ½éœ€è¦ç²¾ç®€ï¼‰</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. æ·»åŠ å¯¹åº”çš„postgresç”¨æˆ·</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> debian:stretch-slim</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…å¿…è¦ä¾èµ–</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex; \</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    if ! command -v gpg &gt; /dev/null; then \</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        apt-get update; \</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        apt-get install -y --no-install-recommends \</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            gnupg \</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            dirmngr \</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        ; \</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        rm -rf /var/lib/apt/lists/*; \</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    fi</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…ä¾èµ–ï¼Œå¹¶åˆ›å»ºpgéœ€è¦çš„ç”¨æˆ·åŠç»„idï¼Œåˆ›å»ºpgéœ€è¦çš„ç›®å½•å¹¶èµ‹äºˆå¯¹åº”çš„ç»„å’Œidæ”¹ç›®å½•çš„æƒé™</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># explicitly set user/group IDs</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux; \</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    groupadd -r postgres --gid=999; \</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># https://salsa.debian.org/postgresql/postgresql-common/blob/997d842ee744687d99a2b2d95c1083a2615c79e8/debian/postgresql-common.postinst#L32-35</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    useradd -r -g postgres --uid=999 --home-dir=/var/lib/postgresql --shell=/bin/bash postgres; \</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co"># also create the postgres user&#39;s home directory with appropriate permissions</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co"># see https://github.com/docker-library/postgres/issues/274</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    mkdir -p /var/lib/postgresql; \</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    chown -R postgres:postgres /var/lib/postgresql</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ  gosu ç”¨äºåç»­æ–¹ä¾¿ä½¿ä»rooté™æƒé™</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co"># grab gosu for easy step-down from root</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/tianon/gosu/releases</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> GOSU_VERSION 1.12</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux; \</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    savedAptMark=<span class="st">&quot;$(apt-mark showmanual)&quot;</span>; \</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    apt-get update; \</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    apt-get install -y --no-install-recommends ca-certificates wget; \</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    rm -rf /var/lib/apt/lists/*; \</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    dpkgArch=<span class="st">&quot;$(dpkg --print-architecture | awk -F- &#39;{ print $NF }&#39;)&quot;</span>; \</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    wget -O /usr/local/bin/gosu <span class="st">&quot;https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch&quot;</span>; \</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    wget -O /usr/local/bin/gosu.asc <span class="st">&quot;https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc&quot;</span>; \</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    export GNUPGHOME=<span class="st">&quot;$(mktemp -d)&quot;</span>; \</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    gpgconf --kill all; \</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    rm -rf <span class="st">&quot;$GNUPGHOME&quot;</span> /usr/local/bin/gosu.asc; \</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    apt-mark auto <span class="st">&#39;.*&#39;</span> &gt; /dev/null; \</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    [ -z <span class="st">&quot;$savedAptMark&quot;</span> ] || apt-mark manual $savedAptMark &gt; /dev/null; \</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    chmod +x /usr/local/bin/gosu; \</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    gosu --version; \</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    gosu nobody true</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="co">## é…ç½®locale</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="co"># make the &quot;en_US.UTF-8&quot; locale so postgres will be utf-8 enabled by default</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux; \</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>    if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="co"># if this file exists, we&#39;re likely in &quot;debian:xxx-slim&quot;, and locales are thus being excluded so we need to remove that exclusion (since we need locales)</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>        grep -q <span class="st">&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; \</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>        sed -ri <span class="st">&#39;/\/usr\/share\/locale/d&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; \</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>        ! grep -q <span class="st">&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; \</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    fi; \</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    apt-get update; apt-get install -y --no-install-recommends locales; rm -rf /var/lib/apt/lists/*; \</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG en_US.utf8</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…å¿…è¦ä¾èµ–åº“</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux; \</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>    apt-get update; \</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    apt-get install -y --no-install-recommends \</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a><span class="co"># install &quot;nss_wrapper&quot; in case we need to fake &quot;/etc/passwd&quot; and &quot;/etc/group&quot; (especially for OpenShift)</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/docker-library/postgres/issues/359</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="co"># https://cwrap.org/nss_wrapper.html</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>        libnss-wrapper \</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="co"># install &quot;xz-utils&quot; for .sql.xz docker-entrypoint-initdb.d files</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>        xz-utils \</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>    ; \</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    rm -rf /var/lib/apt/lists/*</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="co">## é…ç½®ä¿¡ä»»çš„gpg key</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex; \</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a><span class="co"># pub   4096R/ACCC4CF8 2011-10-13 [expires: 2019-07-02]</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="co">#       Key fingerprint = B97B 0AFC AA1A 47F0 44F2  44A0 7FCC 7D46 ACCC 4CF8</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="co"># uid                  PostgreSQL Debian Repository</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>    key=<span class="st">&#39;B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8&#39;</span>; \</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    export GNUPGHOME=<span class="st">&quot;$(mktemp -d)&quot;</span>; \</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>    gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys <span class="st">&quot;$key&quot;</span>; \</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>    gpg --batch --export <span class="st">&quot;$key&quot;</span> &gt; /etc/apt/trusted.gpg.d/postgres.gpg; \</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>    command -v gpgconf &gt; /dev/null &amp;&amp; gpgconf --kill all; \</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    rm -rf <span class="st">&quot;$GNUPGHOME&quot;</span>; \</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>    apt-key list</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PG_MAJOR 11</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> GOSU_VERSION 1.11</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ postgresqlè½¯ä»¶æºä»“åº“</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex; \</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    \</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a><span class="co"># see note below about &quot;*.pyc&quot; files</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    export PYTHONDONTWRITEBYTECODE=1; \</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    \</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    dpkgArch=<span class="st">&quot;$(dpkg --print-architecture)&quot;</span>; \</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>    case <span class="st">&quot;$dpkgArch&quot;</span> in \</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>        amd64 | i386 | ppc64el) \</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a><span class="co"># arches officialy built by upstream</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>            echo <span class="st">&quot;deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR&quot;</span> &gt; /etc/apt/sources.list.d/pgdg.list; \</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>            echo <span class="st">&quot;apt-get update;&quot;</span>; \</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>            ;; \</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>        *) \</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a><span class="co"># we&#39;re on an architecture upstream doesn&#39;t officially build for</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="co"># let&#39;s build binaries from their published source packages</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>        echo <span class="st">&quot;deb-src http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR&quot;</span> &gt; /etc/apt/sources.list.d/pgdg.list; \</span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>        ;; \</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    esac;</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a><span class="co"># æ·»åŠ å¿…è¦çš„å·¥å…·åŠä¾èµ–</span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y --no-install-recommends unzip wget \</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    libreadline-dev \</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    libmongoc-1.0-0  \</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    libmysql++-dev \</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>    libsqlite3-dev libspatialite7 \</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    libsybdb5 \</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>    libhiredis-dev \</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>    freetds-dev freetds-common libcurl4-nss-dev unixodbc-dev  \</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># libaio-dev - oracle_fdw</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>    libaio-dev \</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; rm -rf /var/lib/apt/lists/*;</span></code></pre></div>
<h2 id="pgspideré•œåƒæ„å»º">pgspideré•œåƒæ„å»º</h2>
<p>å¯¹x86åŠarmæ¶æ„ï¼Œæˆ‘ä»¬åˆ†åˆ«ç¼–å†™äº†å¯¹åº”çš„è„šæœ¬ï¼Œå…¶ä¸­x86ä½¿ç”¨ Dockerfile-source.dockerfile è„šæœ¬æ„å»ºï¼Œarmä½¿ç”¨Dockerfile-source-arm.dockerfileè„šæœ¬æ„å»ºï¼›</p>
<h3 id="æ„å»ºå‘½ä»¤">æ„å»ºå‘½ä»¤</h3>
<pre class="shell"><code>TAG=$(date +%Y%m%d)
docker build -t pgspider-postgis:$TAG -f Dockerfile-source.dockerfile ./
## arm 
docker buildx build \
      --progress plain \
      --build-arg --platform=linux/arm64 \
      -t pgspider-postgis:arm-$TAG \
      -f Dockerfile-source-arm.dockerfile ./ --load</code></pre>
<h3 id="è„šæœ¬è¯¦è§£-2">è„šæœ¬è¯¦è§£</h3>
<ul>
<li><p>pgspider é•œåƒæ„å»ºçš„æ­¥éª¤è¾ƒå¤šï¼Œæˆ‘ä»¬é‡‡å–åˆ†æ­¥éª¤æ„å»ºçš„æ–¹å¼ä½¿ç”¨ä¸­é—´æ„å»ºè¿‡ç¨‹æ¥å‡å°æœ€ç»ˆé•œåƒçš„å±‚æ•°åŠå¤§å°ï¼›</p></li>
<li><p>å¦å¤–ä¸¤ä¸ªå¹³å°çš„æ„å»ºè„šæœ¬å¤§ä½“ä¸€è‡´ï¼Œä»…æœ‰å°‘æ•°è¿‡ç¨‹æœ‰å·®å¼‚ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨x86ç‰ˆæœ¬çš„å¯¹æ•´ä½“è¿‡ç¨‹è¿›è¡Œè¯´æ˜ï¼Œåé¢æˆ‘ä»¬ä¼šè¯´æ˜ä¸¤ä¸ªå¹³å°ä¹‹é—´çš„å·®å¼‚ï¼›</p></li>
</ul>
<h4 id="x86-æ„å»ºè„šæœ¬">x86 æ„å»ºè„šæœ¬</h4>
<blockquote>
<p>æç¤ºï¼šè„šæœ¬ä¸­æœ‰å¤šä¸ªFROMæ®µï¼Œæ­¤ä¸ºDockerå¤šé˜¶æ®µæ„å»ºå¯ä»¥é€šè¿‡<a href="https://zhuanlan.zhihu.com/p/33795821">æ­¤æ–‡ç« </a>è¿›è¡Œäº†è§£ï¼›</p>
</blockquote>
<p>ä¸»è¦è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p><strong>ç¬¬ä¸€é˜¶æ®µï¼š</strong></p>
<ol type="1">
<li><p>ä»builderé•œåƒå¼€å§‹ï¼Œç”±äºbuilderé•œåƒä¸­å·²ç»åŒ…å«pgæºç è¿˜æœ‰å·²ç»ç¼–å¥½çš„pgåŠpgspiderç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— éœ€å†ç¼–è¯‘è¿™äº›ï¼›</p></li>
<li><p>ç¼–è¯‘ mysql_fdw åŠ sqlite_fdwï¼ˆæ³¨æ„ï¼Œå…¶ä¸­mysql_fdwå…¶å®å¯ä»¥ä¸ç”¨äº†ï¼‰</p></li>
<li><p>å®‰è£… oracle_fdw æ‰€éœ€è¦çš„ä¾èµ–ï¼ˆoracle instant clientï¼‰ï¼›</p></li>
<li><p>ç¼–è¯‘postgisï¼Œç¼–è¯‘postgiséœ€è¦å…ˆç¼–è¯‘å…¶ä¾èµ–ï¼ˆmpfrï¼Œboost_1_67_0ï¼ŒCGALç­‰ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°†postgisçš„æ‰€æœ‰çš„ä¾èµ–åŠå…¶è‡ªèº«çš„å®‰è£…è·¯å¾„éƒ½è®¾ç½®ä¸º <code>/usr/local/pgspider/plugin/postgis</code></p>
<pre class="shell"><code>ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis</code></pre></li>
<li><p>ç¼–è¯‘å¹¶å®‰è£… debeziumåŠwal2jsonï¼›</p></li>
<li><p>ä½¿ç”¨stripå¯¹postgisç›®å½•ä¸­çš„æ‰€æœ‰soåº“è¿›è¡Œå¤§å°ä¼˜åŒ–</p></li>
<li><p>å°†é¢„å…ˆç¼–è¯‘å¥½çš„ å‡ ä¸ªfdwçš„soåŠé…ç½®åŠsqlæ–‡ä»¶æ‹·è´åˆ°æŒ‡å®šç›®å½•ä»¥å®‰è£…æˆ–æ›´æ–°è¿™äº›fdwï¼›</p></li>
</ol>
<p><strong>ç¬¬äºŒé˜¶æ®µï¼š</strong></p>
<ol type="1">
<li>ä» pgspider-base é•œåƒå¼€å§‹æ„å»ºï¼›</li>
<li>å®‰è£…å¿…è¦çš„ä¾èµ–ï¼›</li>
<li>ä»ç¬¬ä¸€é˜¶æ®µæ‹·è´å‡ºoracle_instantclientçš„ä¾èµ–ï¼›ï¼ˆarmç‰ˆæœ¬æ— æ­¤æ­¥éª¤ï¼Œå› ä¸ºoracle_instantclientä¸æ”¯æŒarmæ¶æ„ï¼‰</li>
<li>ä»ç¬¬ä¸€é˜¶æ®µæ‹·è´å‡º /usr/local/pgspider ç›®å½•ï¼Œå…¶ä¸­åŒ…å«äº†æˆ‘ä»¬ä¹‹å‰ç¼–è¯‘çš„çš„æˆæœï¼›</li>
<li>æ·»åŠ å„ç§åˆå§‹åŒ–è„šæœ¬ï¼Œå¹¶ä¸ºpgè¿è¡Œåšå¿…è¦çš„å‡†å¤‡ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹dockerfileï¼›</li>
<li>æœ€åä½¿ç”¨ EXPOSE æš´éœ² 5432ç«¯å£ï¼Œä½¿ç”¨ CMD [â€œpostgresâ€] é»˜è®¤å¯åŠ¨pgï¼›</li>
</ol>
<div class="sourceCode" id="cb27"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># æ„å»ºèåˆä¸­å¿ƒpgé•œåƒ(ä»æºç æ„å»ºï¼‰ï¼š</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. æ„å»ºpgspiderï¼ˆpgspider-baseé•œåƒä¸­åŒ…å«ï¼‰</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. æ·»åŠ è‹¥å¹²fdwï¼šmysql_fdw,oracle_fdw,sqlite_fdw,postgres_fdwï¼ˆpostgres_fdwåŒ…å«äºpgspider-baseé•œåƒä¸­ï¼‰</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. æ·»åŠ  postgis</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># å‚è€ƒï¼š</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">## æ„å»º sqlite_fdw  mysql_fdw  oracle_fdw</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co">#FROM pgspider-builder as build</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/pgspider-builder as build</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">## PG ä¸»ç‰ˆæœ¬</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PG_MAJOR 11</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PG_VERSION 6</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…æ„å»ºæ‰€éœ€çš„ä¾èµ–</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update \</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; apt-get install -y automake autoconf libtool pkg-config libssl-dev \</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    libsqlite3-dev libsybdb5 freetds-dev freetds-common \</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for oracle</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    unzip \</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co">#    libmysql++-dev</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    libmysql++-dev \</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># libspatialite sqlite ç©ºé—´æ•°æ®æ”¯æŒ - https://packages.debian.org/stretch/libspatialite7</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    libspatialite7</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a><span class="co">#    postgresql-${PG_MAJOR}-python-multicorn python-pip</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… sqlite_fdw</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw &amp;&amp; make &amp;&amp; make install</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… mysql_fdw</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw &amp;&amp; make &amp;&amp; make install</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… Install es_fdw</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN pip install pg_es_fdw</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… oracle_fdw</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="co">### å®‰è£…oracle instantclient</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> ln -s /usr/local/instantclient_12_2 /usr/local/instantclient</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> ORACLE_HOME=/usr/local/instantclient</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a><span class="co">ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make &amp;&amp; make install</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a><span class="co">##  POSTGIS æ„å»º</span></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a><span class="co">### å®‰è£…ä¾èµ–</span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get install  -y --no-install-recommends \</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    libtool libxml2 libxml2-dev \</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>    libxslt1.1 libxslt1-dev \</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>    libjson-c-dev libgmp-dev \</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>    cmake libmpfr-dev</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a><span class="co">### åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•</span></span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /app/postgis/</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º mpfr</span></span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/mpfr-4.0.2.tar.gz /app/postgis/</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/mpfr-4.0.2 \</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH \</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make &amp;&amp; make install</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º boost</span></span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/boost_1_67_0.tar.gz /app/postgis/</span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/boost_1_67_0  \</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH &amp;&amp; ./b2 &amp;&amp; ./b2 install</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º CGAL</span></span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/CGAL-4.11.2.tar.xz /app/postgis/</span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/CGAL-4.11.2  \</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º SFCGAL</span></span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/SFCGAL-1.3.5.tar.gz /app/postgis/</span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/SFCGAL-1.3.5 \</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º projï¼Œéœ€è¦å…ˆå®‰è£…sqlite3</span></span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev</span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/proj-6.2.0.tar.gz /app/postgis/</span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/proj-6.2.0  \</span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º gdal</span></span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/gdal-3.0.2.tar.gz /app/postgis/</span>
<span id="cb27-108"><a href="#cb27-108" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/gdal-3.0.2  \</span>
<span id="cb27-109"><a href="#cb27-109" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH \</span>
<span id="cb27-110"><a href="#cb27-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># proj æ— æ³•ç›´æ¥æ‰¾åˆ°ï¼Œå¿…é¡»æ‰‹åŠ¨æŒ‡å®šï¼ˆå¯èƒ½æ˜¯éœ€è¦é…ç½®includeï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æŒ‡å®šï¼Œpostgisé‡Œé¢åŒ</span></span>
<span id="cb27-111"><a href="#cb27-111" aria-hidden="true" tabindex="-1"></a>        --with-proj=$PGIS_INSTALL_PATH \</span>
<span id="cb27-112"><a href="#cb27-112" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-113"><a href="#cb27-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-114"><a href="#cb27-114" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º geos</span></span>
<span id="cb27-115"><a href="#cb27-115" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/geos-3.8.0.tar.bz2 /app/postgis/</span>
<span id="cb27-116"><a href="#cb27-116" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/geos-3.8.0  \</span>
<span id="cb27-117"><a href="#cb27-117" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH  \</span>
<span id="cb27-118"><a href="#cb27-118" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-119"><a href="#cb27-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-120"><a href="#cb27-120" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º postgis</span></span>
<span id="cb27-121"><a href="#cb27-121" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/postgis-2.5.3.tar.gz /app/postgis/</span>
<span id="cb27-122"><a href="#cb27-122" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/postgis-2.5.3  \</span>
<span id="cb27-123"><a href="#cb27-123" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH \</span>
<span id="cb27-124"><a href="#cb27-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å‡ ä¸ªconfigå‘½ä»¤ç›´æ¥é…ç½®PATHåå¯ä»¥æ‰¾åˆ°ï¼Œæ‰€ä»¥ä¸åœ¨ä½¿ç”¨å‚æ•°é…ç½®</span></span>
<span id="cb27-125"><a href="#cb27-125" aria-hidden="true" tabindex="-1"></a><span class="co">#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \</span></span>
<span id="cb27-126"><a href="#cb27-126" aria-hidden="true" tabindex="-1"></a><span class="co">#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \</span></span>
<span id="cb27-127"><a href="#cb27-127" aria-hidden="true" tabindex="-1"></a><span class="co">#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \</span></span>
<span id="cb27-128"><a href="#cb27-128" aria-hidden="true" tabindex="-1"></a><span class="co">        --with-projdir=$PGIS_INSTALL_PATH \</span></span>
<span id="cb27-129"><a href="#cb27-129" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span></span>
<span id="cb27-130"><a href="#cb27-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-131"><a href="#cb27-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-132"><a href="#cb27-132" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex \</span>
<span id="cb27-133"><a href="#cb27-133" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list \</span></span>
<span id="cb27-134"><a href="#cb27-134" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot;  /etc/apt/sources.list \</span></span>
<span id="cb27-135"><a href="#cb27-135" aria-hidden="true" tabindex="-1"></a><span class="co">    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span></span>
<span id="cb27-136"><a href="#cb27-136" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; echo &quot;deb http://deb.debian.org/debian stretch-backports main&quot; &gt;&gt;/etc/apt/sources.list \</span></span>
<span id="cb27-137"><a href="#cb27-137" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get update \</span></span>
<span id="cb27-138"><a href="#cb27-138" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get install -y --no-install-recommends \</span></span>
<span id="cb27-139"><a href="#cb27-139" aria-hidden="true" tabindex="-1"></a><span class="co">      libprotobuf-c-dev \</span></span>
<span id="cb27-140"><a href="#cb27-140" aria-hidden="true" tabindex="-1"></a><span class="co">#      postgresql-12-wal2json \</span></span>
<span id="cb27-141"><a href="#cb27-141" aria-hidden="true" tabindex="-1"></a><span class="co">      protobuf-c-compiler \</span></span>
<span id="cb27-142"><a href="#cb27-142" aria-hidden="true" tabindex="-1"></a><span class="co">      &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span>
<span id="cb27-143"><a href="#cb27-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-144"><a href="#cb27-144" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ  debezium https://github.com/eulerto/wal2json</span></span>
<span id="cb27-145"><a href="#cb27-145" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/</span>
<span id="cb27-146"><a href="#cb27-146" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/debezium/wal2json-wal2json_1_0 \</span>
<span id="cb27-147"><a href="#cb27-147" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-148"><a href="#cb27-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-149"><a href="#cb27-149" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ  debezium - decoderbufs ç ”ç©¶é™¢ä¿®æ”¹ç‰ˆæœ¬</span></span>
<span id="cb27-150"><a href="#cb27-150" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> debezium/postgres-decoderbufs.tar.gz /app/debezium/</span>
<span id="cb27-151"><a href="#cb27-151" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/debezium/postgres-decoderbufs \</span>
<span id="cb27-152"><a href="#cb27-152" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cd proto \</span>
<span id="cb27-153"><a href="#cb27-153" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; protoc-c --c_out=../src/proto pg_logicaldec.proto \</span>
<span id="cb27-154"><a href="#cb27-154" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cd .. \</span>
<span id="cb27-155"><a href="#cb27-155" aria-hidden="true" tabindex="-1"></a>    <span class="co">## make -Bï¼š ç ”ç©¶é™¢æä¾›çš„åŒ…ä¸­å¯èƒ½å¸¦æœ‰ä¹‹å‰makeçš„æˆæœï¼Œæ­¤æ—¶ä¸ä¼šé‡æ–°æ„å»ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ -B æ¥å¼ºåˆ¶é‡æ–°æ„å»ºï¼Œä¹Ÿå¯ä»¥å…ˆæ‰§è¡Œ make clean</span></span>
<span id="cb27-156"><a href="#cb27-156" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -B -j$(nproc) &amp;&amp; make install</span>
<span id="cb27-157"><a href="#cb27-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-158"><a href="#cb27-158" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ  debezium - decoderbufs å®˜æ–¹ç‰ˆæœ¬</span></span>
<span id="cb27-159"><a href="#cb27-159" aria-hidden="true" tabindex="-1"></a><span class="co">#ADD debezium/postgres-decoderbufs-v.1.3.1.Final.tar.gz /app/debezium/</span></span>
<span id="cb27-160"><a href="#cb27-160" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN cd /app/debezium/postgres-decoderbufs-v.1.3.1.Final \</span></span>
<span id="cb27-161"><a href="#cb27-161" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span></span>
<span id="cb27-162"><a href="#cb27-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-163"><a href="#cb27-163" aria-hidden="true" tabindex="-1"></a><span class="co">### å¯¹æ„å»ºpostgisè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œä»¥å‡å°å¤§å°</span></span>
<span id="cb27-164"><a href="#cb27-164" aria-hidden="true" tabindex="-1"></a><span class="co">#### 1. ç§»é™¤é™æ€é“¾æ¥åº“æ–‡ä»¶ï¼›2. ä½¿ç”¨stripå‘½ä»¤å¯¹åŠ¨æ€é“¾æ¥åº“soæ–‡ä»¶è¿›è¡Œç¬¦å·è¡¨ä¼˜åŒ–</span></span>
<span id="cb27-165"><a href="#cb27-165" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd $PGIS_INSTALL_PATH/lib \</span>
<span id="cb27-166"><a href="#cb27-166" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; rm *.a \</span>
<span id="cb27-167"><a href="#cb27-167" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; find . -type f -name <span class="st">&quot;lib*.so.*&quot;</span> -exec strip {} +</span>
<span id="cb27-168"><a href="#cb27-168" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; cd /usr/local/pgspider/plugin/proj/lib \</span></span>
<span id="cb27-169"><a href="#cb27-169" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; rm *.a &amp;&amp; find . -type f -name &quot;lib*.so.*&quot; -exec strip {} +</span></span>
<span id="cb27-170"><a href="#cb27-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-171"><a href="#cb27-171" aria-hidden="true" tabindex="-1"></a><span class="co">## æ‹·è´mysql</span></span>
<span id="cb27-172"><a href="#cb27-172" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb27-173"><a href="#cb27-173" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb27-174"><a href="#cb27-174" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/</span>
<span id="cb27-175"><a href="#cb27-175" aria-hidden="true" tabindex="-1"></a><span class="co">## æ‹·è´zombodb</span></span>
<span id="cb27-176"><a href="#cb27-176" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb27-177"><a href="#cb27-177" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb27-178"><a href="#cb27-178" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/</span>
<span id="cb27-179"><a href="#cb27-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-180"><a href="#cb27-180" aria-hidden="true" tabindex="-1"></a><span class="co">## æ‹·è´oracle fdw</span></span>
<span id="cb27-181"><a href="#cb27-181" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary/oracle/*.so           /usr/local/pgspider/lib/postgresql/</span>
<span id="cb27-182"><a href="#cb27-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-183"><a href="#cb27-183" aria-hidden="true" tabindex="-1"></a><span class="co"># ------ å¼€å§‹æ„å»ºå®é™…å‘å¸ƒçš„é•œåƒ ------</span></span>
<span id="cb27-184"><a href="#cb27-184" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/pgspider-base:latest</span>
<span id="cb27-185"><a href="#cb27-185" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;jianghanghang@geostar.com.cn&quot;</span></span>
<span id="cb27-186"><a href="#cb27-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-187"><a href="#cb27-187" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®è‹¥å¹²ENVï¼ŒæŒ‡ç¤ºç‰ˆæœ¬ä¿¡æ¯</span></span>
<span id="cb27-188"><a href="#cb27-188" aria-hidden="true" tabindex="-1"></a><span class="co"># buster ä¸Šä¸º12 ï¼Œstretch ä¸Šä¸º 12</span></span>
<span id="cb27-189"><a href="#cb27-189" aria-hidden="true" tabindex="-1"></a><span class="co"># ENV CDAL_VERSION 12</span></span>
<span id="cb27-190"><a href="#cb27-190" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> BOOST_VERSION=1.67.0 \</span>
<span id="cb27-191"><a href="#cb27-191" aria-hidden="true" tabindex="-1"></a>    PG_MAJOR=11 \</span>
<span id="cb27-192"><a href="#cb27-192" aria-hidden="true" tabindex="-1"></a>    PG_VERSION=6 \</span>
<span id="cb27-193"><a href="#cb27-193" aria-hidden="true" tabindex="-1"></a>    POSTGIS_VESION=2.5.3</span>
<span id="cb27-194"><a href="#cb27-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-195"><a href="#cb27-195" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…å¿…è¦çš„ä¾èµ–ï¼ˆTODO: éƒ¨åˆ†ä¾èµ–å¯èƒ½ä¸éœ€è¦ï¼‰</span></span>
<span id="cb27-196"><a href="#cb27-196" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex \</span>
<span id="cb27-197"><a href="#cb27-197" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list \</span></span>
<span id="cb27-198"><a href="#cb27-198" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot;  /etc/apt/sources.list \</span></span>
<span id="cb27-199"><a href="#cb27-199" aria-hidden="true" tabindex="-1"></a><span class="co">    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span></span>
<span id="cb27-200"><a href="#cb27-200" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; echo &quot;deb http://deb.debian.org/debian stretch-backports main&quot; &gt;&gt;/etc/apt/sources.list \</span></span>
<span id="cb27-201"><a href="#cb27-201" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get update \</span></span>
<span id="cb27-202"><a href="#cb27-202" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get install -y --no-install-recommends \</span></span>
<span id="cb27-203"><a href="#cb27-203" aria-hidden="true" tabindex="-1"></a><span class="co">      curl \</span></span>
<span id="cb27-204"><a href="#cb27-204" aria-hidden="true" tabindex="-1"></a><span class="co">      libcurl3-gnutls \</span></span>
<span id="cb27-205"><a href="#cb27-205" aria-hidden="true" tabindex="-1"></a><span class="co">      libexpat1 \</span></span>
<span id="cb27-206"><a href="#cb27-206" aria-hidden="true" tabindex="-1"></a><span class="co">      libgmp10 \</span></span>
<span id="cb27-207"><a href="#cb27-207" aria-hidden="true" tabindex="-1"></a><span class="co">      libgmpxx4ldbl \</span></span>
<span id="cb27-208"><a href="#cb27-208" aria-hidden="true" tabindex="-1"></a><span class="co">      libjson-c3 \</span></span>
<span id="cb27-209"><a href="#cb27-209" aria-hidden="true" tabindex="-1"></a><span class="co">      # buster ä¸Šä¸º6ï¼Œstretchä¸Šä¸º4</span></span>
<span id="cb27-210"><a href="#cb27-210" aria-hidden="true" tabindex="-1"></a><span class="co">#      libmpfr6 \</span></span>
<span id="cb27-211"><a href="#cb27-211" aria-hidden="true" tabindex="-1"></a><span class="co">#      libmpfr4 \</span></span>
<span id="cb27-212"><a href="#cb27-212" aria-hidden="true" tabindex="-1"></a><span class="co">      libprotobuf-c1 \</span></span>
<span id="cb27-213"><a href="#cb27-213" aria-hidden="true" tabindex="-1"></a><span class="co">      libtiff5 \</span></span>
<span id="cb27-214"><a href="#cb27-214" aria-hidden="true" tabindex="-1"></a><span class="co">      libxml2 \</span></span>
<span id="cb27-215"><a href="#cb27-215" aria-hidden="true" tabindex="-1"></a><span class="co">      # for debezium</span></span>
<span id="cb27-216"><a href="#cb27-216" aria-hidden="true" tabindex="-1"></a>      postgresql-12-wal2json \</span>
<span id="cb27-217"><a href="#cb27-217" aria-hidden="true" tabindex="-1"></a>      libprotobuf-c-dev \</span>
<span id="cb27-218"><a href="#cb27-218" aria-hidden="true" tabindex="-1"></a>      &amp;&amp; rm -rf /var/lib/apt/lists/*</span>
<span id="cb27-219"><a href="#cb27-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-220"><a href="#cb27-220" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…oracle_fdwéœ€è¦çš„ Oracle instantclient</span></span>
<span id="cb27-221"><a href="#cb27-221" aria-hidden="true" tabindex="-1"></a><span class="co">### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span></span>
<span id="cb27-222"><a href="#cb27-222" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2</span>
<span id="cb27-223"><a href="#cb27-223" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex \</span>
<span id="cb27-224"><a href="#cb27-224" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \</span>
<span id="cb27-225"><a href="#cb27-225" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus</span>
<span id="cb27-226"><a href="#cb27-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-227"><a href="#cb27-227" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®è‹¥å¹²è¿è¡Œéœ€è¦çš„ç¯å¢ƒå˜é‡</span></span>
<span id="cb27-228"><a href="#cb27-228" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> ORACLE_HOME=/usr/local/instantclient \</span>
<span id="cb27-229"><a href="#cb27-229" aria-hidden="true" tabindex="-1"></a>    PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis</span>
<span id="cb27-230"><a href="#cb27-230" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \</span>
<span id="cb27-231"><a href="#cb27-231" aria-hidden="true" tabindex="-1"></a>    PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH</span>
<span id="cb27-232"><a href="#cb27-232" aria-hidden="true" tabindex="-1"></a><span class="co">## æ‹·è´æ„å»ºå¥½çš„æˆæœ</span></span>
<span id="cb27-233"><a href="#cb27-233" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=build  /usr/local/pgspider /usr/local/pgspider</span>
<span id="cb27-234"><a href="#cb27-234" aria-hidden="true" tabindex="-1"></a><span class="co">## å…¥å£è„šæœ¬æ·»åŠ </span></span>
<span id="cb27-235"><a href="#cb27-235" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> docker-entrypoint.sh /usr/local/bin/</span>
<span id="cb27-236"><a href="#cb27-236" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /docker-entrypoint-initdb.d \</span>
<span id="cb27-237"><a href="#cb27-237" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; chmod +x /usr/local/bin/docker-entrypoint.sh \</span>
<span id="cb27-238"><a href="#cb27-238" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s usr/local/bin/docker-entrypoint.sh /</span>
<span id="cb27-239"><a href="#cb27-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-240"><a href="#cb27-240" aria-hidden="true" tabindex="-1"></a><span class="co">## postgis è„šæœ¬æ·»åŠ </span></span>
<span id="cb27-241"><a href="#cb27-241" aria-hidden="true" tabindex="-1"></a><span class="co">### fromï¼š https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template</span></span>
<span id="cb27-242"><a href="#cb27-242" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh</span>
<span id="cb27-243"><a href="#cb27-243" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./postgis/update-postgis.sh /usr/local/bin</span>
<span id="cb27-244"><a href="#cb27-244" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ æ‰©å±•åˆå§‹åŒ–è„šæœ¬</span></span>
<span id="cb27-245"><a href="#cb27-245" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh</span>
<span id="cb27-246"><a href="#cb27-246" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh</span>
<span id="cb27-247"><a href="#cb27-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-248"><a href="#cb27-248" aria-hidden="true" tabindex="-1"></a><span class="co">## make the sample config easier to munge (and &quot;correct by default&quot;)</span></span>
<span id="cb27-249"><a href="#cb27-249" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> sed -ri <span class="st">&quot;s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = &#39;*&#39;!&quot;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \</span>
<span id="cb27-250"><a href="#cb27-250" aria-hidden="true" tabindex="-1"></a>   grep -F <span class="st">&quot;listen_addresses = &#39;*&#39;&quot;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample</span>
<span id="cb27-251"><a href="#cb27-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-252"><a href="#cb27-252" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir -p /var/run/postgresql &amp;&amp; chown -R postgres:postgres /var/run/postgresql  &amp;&amp; chmod 2777 /var/run/postgresql</span>
<span id="cb27-253"><a href="#cb27-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-254"><a href="#cb27-254" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PGDATA /var/lib/postgresql/data</span>
<span id="cb27-255"><a href="#cb27-255" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®ç›®å½•æƒé™ - this 777 will be replaced by 700 at runtime (allows semi-arbitrary &quot;--user&quot; values)</span></span>
<span id="cb27-256"><a href="#cb27-256" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir -p <span class="st">&quot;$PGDATA&quot;</span> &amp;&amp; chown -R postgres:postgres <span class="st">&quot;$PGDATA&quot;</span> &amp;&amp; chmod 777 <span class="st">&quot;$PGDATA&quot;</span></span>
<span id="cb27-257"><a href="#cb27-257" aria-hidden="true" tabindex="-1"></a><span class="kw">VOLUME</span> /var/lib/postgresql/data</span>
<span id="cb27-258"><a href="#cb27-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-259"><a href="#cb27-259" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;docker-entrypoint.sh&quot;</span>]</span>
<span id="cb27-260"><a href="#cb27-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-261"><a href="#cb27-261" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile</span></span>
<span id="cb27-262"><a href="#cb27-262" aria-hidden="true" tabindex="-1"></a><span class="co"># We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL</span></span>
<span id="cb27-263"><a href="#cb27-263" aria-hidden="true" tabindex="-1"></a><span class="co"># calls &quot;Fast Shutdown mode&quot; wherein new connections are disallowed and any</span></span>
<span id="cb27-264"><a href="#cb27-264" aria-hidden="true" tabindex="-1"></a><span class="co"># in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and</span></span>
<span id="cb27-265"><a href="#cb27-265" aria-hidden="true" tabindex="-1"></a><span class="co"># flush tables to disk, which is the best compromise available to avoid data</span></span>
<span id="cb27-266"><a href="#cb27-266" aria-hidden="true" tabindex="-1"></a><span class="co"># corruption.</span></span>
<span id="cb27-267"><a href="#cb27-267" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-268"><a href="#cb27-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Users who know their applications do not keep open long-lived idle connections</span></span>
<span id="cb27-269"><a href="#cb27-269" aria-hidden="true" tabindex="-1"></a><span class="co"># may way to use a value of SIGTERM instead, which corresponds to &quot;Smart</span></span>
<span id="cb27-270"><a href="#cb27-270" aria-hidden="true" tabindex="-1"></a><span class="co"># Shutdown mode&quot; in which any existing sessions are allowed to finish and the</span></span>
<span id="cb27-271"><a href="#cb27-271" aria-hidden="true" tabindex="-1"></a><span class="co"># server stops when all sessions are terminated.</span></span>
<span id="cb27-272"><a href="#cb27-272" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-273"><a href="#cb27-273" aria-hidden="true" tabindex="-1"></a><span class="co"># See https://www.postgresql.org/docs/12/server-shutdown.html for more details</span></span>
<span id="cb27-274"><a href="#cb27-274" aria-hidden="true" tabindex="-1"></a><span class="co"># about available PostgreSQL server shutdown signals.</span></span>
<span id="cb27-275"><a href="#cb27-275" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-276"><a href="#cb27-276" aria-hidden="true" tabindex="-1"></a><span class="co"># See also https://www.postgresql.org/docs/12/server-start.html for further</span></span>
<span id="cb27-277"><a href="#cb27-277" aria-hidden="true" tabindex="-1"></a><span class="co"># justification of this as the default value, namely that the example (and</span></span>
<span id="cb27-278"><a href="#cb27-278" aria-hidden="true" tabindex="-1"></a><span class="co"># shipped) systemd service files use the &quot;Fast Shutdown mode&quot; for service</span></span>
<span id="cb27-279"><a href="#cb27-279" aria-hidden="true" tabindex="-1"></a><span class="co"># termination.</span></span>
<span id="cb27-280"><a href="#cb27-280" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-281"><a href="#cb27-281" aria-hidden="true" tabindex="-1"></a><span class="kw">STOPSIGNAL</span> SIGINT</span>
<span id="cb27-282"><a href="#cb27-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-283"><a href="#cb27-283" aria-hidden="true" tabindex="-1"></a><span class="co"># An additional setting that is recommended for all users regardless of this</span></span>
<span id="cb27-284"><a href="#cb27-284" aria-hidden="true" tabindex="-1"></a><span class="co"># value is the runtime &quot;--stop-timeout&quot; (or your orchestrator/runtime&#39;s</span></span>
<span id="cb27-285"><a href="#cb27-285" aria-hidden="true" tabindex="-1"></a><span class="co"># equivalent) for controlling how long to wait between sending the defined</span></span>
<span id="cb27-286"><a href="#cb27-286" aria-hidden="true" tabindex="-1"></a><span class="co"># STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).</span></span>
<span id="cb27-287"><a href="#cb27-287" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb27-288"><a href="#cb27-288" aria-hidden="true" tabindex="-1"></a><span class="co"># The default in most runtimes (such as Docker) is 10 seconds, and the</span></span>
<span id="cb27-289"><a href="#cb27-289" aria-hidden="true" tabindex="-1"></a><span class="co"># documentation at https://www.postgresql.org/docs/12/server-start.html notes</span></span>
<span id="cb27-290"><a href="#cb27-290" aria-hidden="true" tabindex="-1"></a><span class="co"># that even 90 seconds may not be long enough in many instances.</span></span>
<span id="cb27-291"><a href="#cb27-291" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 5432</span>
<span id="cb27-292"><a href="#cb27-292" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;postgres&quot;</span>]</span></code></pre></div>
<h3 id="armç‰ˆæœ¬æ„å»ºè„šæœ¬">ARMç‰ˆæœ¬æ„å»ºè„šæœ¬</h3>
<p>ä¸x86ç‰ˆæœ¬ä¸åŒä¹‹å¤„åœ¨äºï¼š</p>
<ol type="1">
<li>fromçš„é•œåƒä¸åŒï¼Œä¸€ä¸ªæ˜¯x86ç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯armç‰ˆæœ¬ï¼›</li>
<li>armç‰ˆæœ¬ä¸åŒ…å«oracle_fdw æ„å»ºçš„ç›¸å…³æ­¥éª¤ï¼›</li>
</ol>
<div class="sourceCode" id="cb28"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># æ„å»ºèåˆä¸­å¿ƒpgé•œåƒ-armbç‰ˆæœ¬(ä»æºç æ„å»ºï¼‰ï¼š</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. æ„å»ºpgspiderï¼ˆpgspider-baseé•œåƒä¸­åŒ…å«ï¼‰</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. æ·»åŠ è‹¥å¹²fdwï¼šmysql_fdw,sqlite_fdw,postgres_fdwï¼ˆpostgres_fdwåŒ…å«äºpgspider-baseé•œåƒä¸­ï¼‰</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. æ·»åŠ  postgis</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># å‚è€ƒï¼š</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">## æ„å»º sqlite_fdw  mysql_fdw</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> zh-registry.geostar.com.cn/geopanel/pgspider-builder-arm:latest as build</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">## PG ä¸»ç‰ˆæœ¬</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PG_MAJOR 11</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PG_VERSION 6</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…æ„å»ºæ‰€éœ€çš„ä¾èµ–</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update \</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; apt-get install -y automake autoconf libtool pkg-config libssl-dev \</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    libsqlite3-dev libsybdb5 freetds-dev freetds-common \</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for oracle</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    unzip \</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co">#    libmysql++-dev</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    libmysql++-dev \</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># libspatialite sqlite ç©ºé—´æ•°æ®æ”¯æŒ - https://packages.debian.org/stretch/libspatialite7</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    libspatialite7</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="co">#    postgresql-${PG_MAJOR}-python-multicorn python-pip</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… sqlite_fdw</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw &amp;&amp; make &amp;&amp; make install</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… mysql_fdw</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw &amp;&amp; make &amp;&amp; make install</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… Install es_fdw</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN pip install pg_es_fdw</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£… oracle_fdw(arm ä¸æ”¯æŒ)</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="co">### å®‰è£…oracle instantclient</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="co">#ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="co">#ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="co">#ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="co">#ENV ORACLE_HOME=/usr/local/instantclient</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="co">#ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="co">#ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; make &amp;&amp; make install</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="co">##  POSTGIS æ„å»º</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="co">### å®‰è£…ä¾èµ–</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get install  -y --no-install-recommends \</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    libtool libxml2 libxml2-dev \</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    libxslt1.1 libxslt1-dev \</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    libjson-c-dev libgmp-dev \</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    cmake libmpfr-dev</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a><span class="co">### åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /app/postgis/</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º mpfr</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/mpfr-4.0.2.tar.gz /app/postgis/</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/mpfr-4.0.2 \</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH \</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make &amp;&amp; make install</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º boost</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/boost_1_67_0.tar.gz /app/postgis/</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/boost_1_67_0  \</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH &amp;&amp; ./b2 &amp;&amp; ./b2 install</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º CGAL</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/CGAL-4.11.2.tar.xz /app/postgis/</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/CGAL-4.11.2  \</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º SFCGAL</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/SFCGAL-1.3.5.tar.gz /app/postgis/</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/SFCGAL-1.3.5 \</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º projï¼Œéœ€è¦å…ˆå®‰è£…sqlite3</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/proj-6.2.0.tar.gz /app/postgis/</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/proj-6.2.0  \</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º gdal</span></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/gdal-3.0.2.tar.gz /app/postgis/</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/gdal-3.0.2  \</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH \</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># proj æ— æ³•ç›´æ¥æ‰¾åˆ°ï¼Œå¿…é¡»æ‰‹åŠ¨æŒ‡å®šï¼ˆå¯èƒ½æ˜¯éœ€è¦é…ç½®includeï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æŒ‡å®šï¼Œpostgisé‡Œé¢åŒ</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>        --with-proj=$PGIS_INSTALL_PATH \</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º geos</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/geos-3.8.0.tar.bz2 /app/postgis/</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/geos-3.8.0  \</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH  \</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º postgis</span></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> postgis/postgis-2.5.3.tar.gz /app/postgis/</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/postgis/postgis-2.5.3  \</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ./configure --prefix=$PGIS_INSTALL_PATH \</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å‡ ä¸ªconfigå‘½ä»¤ç›´æ¥é…ç½®PATHåå¯ä»¥æ‰¾åˆ°ï¼Œæ‰€ä»¥ä¸åœ¨ä½¿ç”¨å‚æ•°é…ç½®</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="co">#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a><span class="co">#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a><span class="co">#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \</span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a><span class="co">        --with-projdir=$PGIS_INSTALL_PATH \</span></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex \</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list \</span></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot;  /etc/apt/sources.list \</span></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="co">    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; echo &quot;deb http://deb.debian.org/debian stretch-backports main&quot; &gt;&gt;/etc/apt/sources.list \</span></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get update \</span></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get install -y --no-install-recommends \</span></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a><span class="co">      libprotobuf-c-dev \</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a><span class="co">#      postgresql-12-wal2json \</span></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a><span class="co">      protobuf-c-compiler \</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a><span class="co">      &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ  debezium https://github.com/eulerto/wal2json</span></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/</span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/debezium/wal2json-wal2json_1_0 \</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ  debezium - decoderbufs ç ”ç©¶é™¢ä¿®æ”¹ç‰ˆæœ¬</span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> debezium/postgres-decoderbufs.tar.gz /app/debezium/</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd /app/debezium/postgres-decoderbufs \</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cd proto \</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; protoc-c --c_out=../src/proto pg_logicaldec.proto \</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; cd .. \</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>    <span class="co">## make -Bï¼š ç ”ç©¶é™¢æä¾›çš„åŒ…ä¸­å¯èƒ½å¸¦æœ‰ä¹‹å‰makeçš„æˆæœï¼Œæ­¤æ—¶ä¸ä¼šé‡æ–°æ„å»ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ -B æ¥å¼ºåˆ¶é‡æ–°æ„å»ºï¼Œä¹Ÿå¯ä»¥å…ˆæ‰§è¡Œ make clean</span></span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; make -B -j$(nproc) &amp;&amp; make install</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a><span class="co">### å¯¹æ„å»ºpostgisè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œä»¥å‡å°å¤§å°</span></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a><span class="co">#### 1. ç§»é™¤é™æ€é“¾æ¥åº“æ–‡ä»¶ï¼›2. ä½¿ç”¨stripå‘½ä»¤å¯¹åŠ¨æ€é“¾æ¥åº“soæ–‡ä»¶è¿›è¡Œç¬¦å·è¡¨ä¼˜åŒ–</span></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cd $PGIS_INSTALL_PATH/lib \</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; rm *.a \</span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; find . -type f -name <span class="st">&quot;lib*.so.*&quot;</span> -exec strip {} +</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; cd /usr/local/pgspider/plugin/proj/lib \</span></span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; rm *.a &amp;&amp; find . -type f -name &quot;lib*.so.*&quot; -exec strip {} +</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a><span class="co">## æ‹·è´mysql</span></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary-arm/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary-arm/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary-arm/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/</span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a><span class="co"># æ‹·è´zombodb</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary-arm/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary-arm/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/</span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> binary-arm/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/</span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="co"># ------ å¼€å§‹æ„å»ºå®é™…å‘å¸ƒçš„é•œåƒ ------</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> zh-registry.geostar.com.cn/geopanel/pgspider-base-arm:latest</span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;jianghanghang@geostar.com.cn&quot;</span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®è‹¥å¹²ENVï¼ŒæŒ‡ç¤ºç‰ˆæœ¬ä¿¡æ¯</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="co"># buster ä¸Šä¸º12 ï¼Œstretch ä¸Šä¸º 12</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a><span class="co"># ENV CDAL_VERSION 12</span></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> BOOST_VERSION=1.67.0 \</span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a>    PG_MAJOR=11 \</span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>    PG_VERSION=6 \</span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a>    POSTGIS_VESION=2.5.3</span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…å¿…è¦çš„ä¾èµ–ï¼ˆTODO: éƒ¨åˆ†ä¾èµ–å¯èƒ½ä¸éœ€è¦ï¼‰</span></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -ex \</span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list \</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; sed -i &quot;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot;  /etc/apt/sources.list \</span></span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a><span class="co">    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span></span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; echo &quot;deb http://deb.debian.org/debian stretch-backports main&quot; &gt;&gt;/etc/apt/sources.list \</span></span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get update \</span></span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a><span class="co">    &amp;&amp; apt-get install -y --no-install-recommends \</span></span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a><span class="co">      curl \</span></span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a><span class="co">      libcurl3-gnutls \</span></span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a><span class="co">      libexpat1 \</span></span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a><span class="co">      libgmp10 \</span></span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a><span class="co">      libgmpxx4ldbl \</span></span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a><span class="co">      libjson-c3 \</span></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a><span class="co">      # buster ä¸Šä¸º6ï¼Œstretchä¸Šä¸º4</span></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a><span class="co">#      libmpfr6 \</span></span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a><span class="co">#      libmpfr4 \</span></span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a><span class="co">      libprotobuf-c1 \</span></span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a><span class="co">      libtiff5 \</span></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a><span class="co">      libxml2 \</span></span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a><span class="co">      &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a><span class="co">## å®‰è£…oracle_fdwéœ€è¦çš„ Oracle instantclient (armç‰ˆæœ¬ä¸æ”¯æŒï¼‰</span></span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a><span class="co">### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a><span class="co">#COPY --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2</span></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN set -ex \</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \</span></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a><span class="co">#    &amp;&amp; ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus</span></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®è‹¥å¹²è¿è¡Œéœ€è¦çš„ç¯å¢ƒå˜é‡</span></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a><span class="co">#ENV ORACLE_HOME=/usr/local/instantclient \</span></span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a><span class="co">ENV PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis</span></span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>    PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a><span class="co">## æ‹·è´æ„å»ºå¥½çš„æˆæœ</span></span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=build  /usr/local/pgspider /usr/local/pgspider</span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a><span class="co">## å…¥å£è„šæœ¬æ·»åŠ </span></span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> docker-entrypoint.sh /usr/local/bin/</span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /docker-entrypoint-initdb.d \</span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; chmod +x /usr/local/bin/docker-entrypoint.sh \</span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s usr/local/bin/docker-entrypoint.sh /</span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a><span class="co">## postgis è„šæœ¬æ·»åŠ </span></span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a><span class="co">### fromï¼š https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template</span></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh</span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./postgis/update-postgis.sh /usr/local/bin</span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a><span class="co">## æ·»åŠ æ‰©å±•åˆå§‹åŒ–è„šæœ¬</span></span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a><span class="co">## make the sample config easier to munge (and &quot;correct by default&quot;)</span></span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> sed -ri <span class="st">&quot;s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = &#39;*&#39;!&quot;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>   grep -F <span class="st">&quot;listen_addresses = &#39;*&#39;&quot;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample</span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir -p /var/run/postgresql &amp;&amp; chown -R postgres:postgres /var/run/postgresql  &amp;&amp; chmod 2777 /var/run/postgresql</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PGDATA /var/lib/postgresql/data</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a><span class="co">## è®¾ç½®ç›®å½•æƒé™ - this 777 will be replaced by 700 at runtime (allows semi-arbitrary &quot;--user&quot; values)</span></span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir -p <span class="st">&quot;$PGDATA&quot;</span> &amp;&amp; chown -R postgres:postgres <span class="st">&quot;$PGDATA&quot;</span> &amp;&amp; chmod 777 <span class="st">&quot;$PGDATA&quot;</span></span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a><span class="kw">VOLUME</span> /var/lib/postgresql/data</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;docker-entrypoint.sh&quot;</span>]</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile</span></span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a><span class="co"># We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL</span></span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a><span class="co"># calls &quot;Fast Shutdown mode&quot; wherein new connections are disallowed and any</span></span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a><span class="co"># in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and</span></span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a><span class="co"># flush tables to disk, which is the best compromise available to avoid data</span></span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a><span class="co"># corruption.</span></span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a><span class="co"># Users who know their applications do not keep open long-lived idle connections</span></span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a><span class="co"># may way to use a value of SIGTERM instead, which corresponds to &quot;Smart</span></span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a><span class="co"># Shutdown mode&quot; in which any existing sessions are allowed to finish and the</span></span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a><span class="co"># server stops when all sessions are terminated.</span></span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a><span class="co"># See https://www.postgresql.org/docs/12/server-shutdown.html for more details</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a><span class="co"># about available PostgreSQL server shutdown signals.</span></span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a><span class="co"># See also https://www.postgresql.org/docs/12/server-start.html for further</span></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a><span class="co"># justification of this as the default value, namely that the example (and</span></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a><span class="co"># shipped) systemd service files use the &quot;Fast Shutdown mode&quot; for service</span></span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a><span class="co"># termination.</span></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a><span class="kw">STOPSIGNAL</span> SIGINT</span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a><span class="co"># An additional setting that is recommended for all users regardless of this</span></span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a><span class="co"># value is the runtime &quot;--stop-timeout&quot; (or your orchestrator/runtime&#39;s</span></span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a><span class="co"># equivalent) for controlling how long to wait between sending the defined</span></span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a><span class="co"># STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).</span></span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a><span class="co"># The default in most runtimes (such as Docker) is 10 seconds, and the</span></span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a><span class="co"># documentation at https://www.postgresql.org/docs/12/server-start.html notes</span></span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a><span class="co"># that even 90 seconds may not be long enough in many instances.</span></span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 5432</span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;postgres&quot;</span>]</span></code></pre></div>
<h2 id="é•œåƒæµ‹è¯•åŠä½¿ç”¨">é•œåƒæµ‹è¯•åŠä½¿ç”¨</h2>
<blockquote>
<p>æç¤ºï¼šé•œåƒä½¿ç”¨äº†pgå®˜æ–¹çš„å…¥å£è„šæœ¬ï¼Œå®˜æ–¹æ”¯æŒçš„é…ç½®åŠå˜é‡éƒ½å¯ä»¥ä½¿ç”¨ï¼Œå…·ä½“å¯æŸ¥çœ‹<a href="https://hub.docker.com/_/postgres?tab=description&amp;page=1&amp;ordering=last_updated">å®˜æ–¹dockerhubé¡µé¢</a></p>
</blockquote>
<p>ä¸‹é¢æè¿°äº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•æµç¨‹ï¼Œè¯¦ç»†å¯å‚è€ƒï¼š <a href="http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/README.md#%E8%BF%90%E8%A1%8C-1">pgspideré•œåƒè¿è¡Œæµ‹è¯•</a></p>
<pre class="shell"><code>## æ ¹æ®å¹³å°åŠéœ€è¦ä½¿ç”¨çš„æºï¼Œè®¾ç½® `PG_IMAGE` å˜é‡
# x86 - dockerhub 
PG_IMAGE=hanlyjiang/pgspider-postgis:latest
# arm - dockerhub
PG_IMAGE=hanlyjiang/pgspider-postgis-arm:latest
# x86 - é˜¿é‡Œäº‘
PG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis:latest
# arm - é˜¿é‡Œäº‘
PG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis-arm:latest

# å¯åŠ¨ pgspider ï¼ˆå¯ä»¥å°† --rm æ¢æˆ -d ä»¥ä¾¿æŒç»­åœ¨åå°è¿è¡Œ ï¼‰
## é€šè¿‡ POSTGRES_PASSWORD å˜é‡å¯ä»¥è®¾ç½®å¯†ç 
docker run -it --rm \
    --name pgspider \
    -p 5434:5432 \
    -e POSTGRES_PASSWORD=mysecretpassword \
    -v $PWD/data:/var/lib/postgresql/data \
    $PG_IMAGE

## å¯åŠ¨åè¿›å…¥å®¹å™¨ï¼š
docker exec -it pgspider bash
### ç„¶åå¯ä»¥æ‰§è¡Œ psql ç­‰å‘½ä»¤

# æµ‹è¯•ç”¨ï¼Œæ­£å¸¸è¿è¡Œå¯ä»¥ä¸ç”¨ç®¡
docker run -it --rm \
    --entrypoint=&quot;&quot; \
    --name pgspider \
    -e POSTGRES_PASSWORD=mysecretpassword \
    -v $PWD/data:/var/lib/postgresql/data \
    pgspider-postgis:latest bash
</code></pre>
<h2 id="å¯ä¼˜åŒ–éƒ¨åˆ†">å¯ä¼˜åŒ–éƒ¨åˆ†</h2>
<p>builderé•œåƒå’Œbaseé•œåƒçš„æ„å»ºarmåŠx86ä¸¤ä¸ªæ¶æ„çš„é•œåƒæ„å»ºå¯ä»¥åˆå¹¶æˆä¸€æ¡å‘½ä»¤å¹¶ä½¿ç”¨ç›¸åŒçš„é•œåƒåç§°ï¼›åŒæ—¶pgspideré•œåƒä¹Ÿå¯ä»¥ç»è¿‡ä¸€å®šçš„æ›´æ”¹ç»Ÿä¸€æˆä¸€ä¸ªæ‰“åŒ…è„šæœ¬ï¼›</p>
<h1 id="geopanelå®¹å™¨åŒ–-hasuraå³å—æ•°æ®apiå¼•æ“é•œåƒæ„å»º">GeoPanelå®¹å™¨åŒ–-hasuraå³å—æ•°æ®APIå¼•æ“é•œåƒæ„å»º</h1>
<h2 id="hasuraé•œåƒæ„å»ºæ¦‚è§ˆ">Hasuraé•œåƒæ„å»ºæ¦‚è§ˆ</h2>
<h3 id="hasura-æ˜¯ä»€ä¹ˆ">hasura æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<p>å¼•ç”¨<a href="%5Bhttps://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md%5D(https://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md)">hasuraå®˜æ–¹</a>çš„ä»‹ç»</p>
<blockquote>
<p>Hasura GraphQLå¼•æ“æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„GraphQLæœåŠ¡å™¨ï¼Œå¯ä¸ºæ‚¨æä¾› <strong>Postgresä¸Šå¼€ç®±å³ç”¨çš„å®æ—¶GraphQL API</strong>ï¼Œ å“åº”æ•°æ®åº“äº‹ä»¶çš„ <a href="https://github.com/hasura/graphql-engine/blob/master/event-triggers.md"><strong>Webhookè§¦å‘å™¨</strong></a>ï¼Œä»¥åŠç”¨äºä¸šåŠ¡é€»è¾‘å¤„ç†çš„ <a href="https://github.com/hasura/graphql-engine/blob/master/remote-schemas.md"><strong>è¿œç«¯Schema</strong></a>ã€‚ Hasuraå¯å¸®åŠ©æ‚¨æ„å»ºåŸºäºPostgresçš„GraphQLåº”ç”¨ç¨‹åºï¼Œæˆ–å°†ä½¿ç”¨Postgresçš„ç°æœ‰åº”ç”¨è¿ç§»åˆ°GraphQLä¸Šã€‚</p>
</blockquote>
<p>GithubåŠDockerHubåœ°å€ï¼š</p>
<ul>
<li>å¼€æºä»“åº“Githubåœ°å€ï¼š<a href="hasura/graphql-engine">hasura/graphql-engine</a></li>
<li>å®˜æ–¹Dockerhubé•œåƒåœ°å€ï¼š<a href="https://hub.docker.com/r/hasura/graphql-engine/tags?page=1&amp;ordering=last_updated">hasura/graphql-engine</a></li>
</ul>
<h3 id="æˆ‘ä»¬åšçš„ä¿®æ”¹">æˆ‘ä»¬åšçš„ä¿®æ”¹</h3>
<p>æˆ‘ä»¬ä½¿ç”¨hasuraä½œä¸ºèåˆä¸­å¿ƒçš„å—æ•°æ®APIå¼•æ“ï¼Œé’ˆå¯¹å¼€æºç‰ˆæœ¬ä½œäº†å¦‚ä¸‹ä¿®æ”¹/æ‰©å±•ï¼š</p>
<ol type="1">
<li>æ±‰åŒ–äº† graphl-engine consoleï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š
<ul>
<li>æ±‰åŒ– graphql-engineçš„consoleå…¥å£æ–‡ä»¶ä¸­çš„ <code>Loading...</code>;</li>
<li>console webé¡µé¢çš„æ‰€æœ‰ç•Œé¢ï¼›</li>
</ul></li>
<li>æ ¹æ®éœ€è¦æ‰©å±•äº†å‡ ä¸ªæ¨¡å—ï¼Œæ¨¡å—æ‰©å±•çš„æ–¹å¼ä¸ºï¼š1ï¼‰åœ¨consoleä¸­æ·»åŠ æ‰©å±•æ¨¡å—çš„webæ“ä½œç•Œé¢ï¼›2ï¼‰æä¾›å¯¹åº”çš„springbootæœåŠ¡ä½œä¸ºåç«¯æ¥å£æä¾›æœåŠ¡ï¼›åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ¨¡å—ï¼š
<ul>
<li>tokenç®¡ç†æœåŠ¡</li>
<li>æ•°æ®åº“é›†æˆæœåŠ¡</li>
<li>restapiæœåŠ¡</li>
</ul></li>
</ol>
<h3 id="ç›®æ ‡åŠæˆæœ">ç›®æ ‡åŠæˆæœ</h3>
<p>é€šè¿‡å®˜æ–¹çš„dockerhubå¯ä»¥çœ‹åˆ°ï¼Œç›®å‰æ²¡æœ‰armç‰ˆæœ¬çš„é•œåƒï¼Œæ•…æˆ‘ä»¬éœ€è¦ä»å¤´ç¼–è¯‘ã€‚åŒæ—¶æˆ‘ä»¬å¸Œæœ›èƒ½è®©hasuraåœ¨armå¹³å°ä¸Šè¿è¡Œï¼Œæœ€ç»ˆä¹Ÿå®Œæˆäº†æ„å»ºæµç¨‹ï¼Œæ•´ä½“å¦‚ä¸‹ï¼š</p>
<figure>
<img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316140949.png" alt="image-20210316140949364" /><figcaption aria-hidden="true">image-20210316140949364</figcaption>
</figure>
<h3 id="hasuraæ•´ä½“ç»“æ„">hasuraæ•´ä½“ç»“æ„</h3>
<pre class="mermaid"><code>graph

graphql-engine

console

cli
</code></pre>
<ol type="1">
<li><p>graphql-engine: graphql å¼•æ“</p></li>
<li><p>consoleï¼šå‰ç«¯ç•Œé¢ï¼Œå®é™…ä¸Šconsoleä¹Ÿä¼šä¸€èµ·æ‰“åŒ…åˆ°graphql-engineçš„é•œåƒé‡Œé¢</p></li>
<li><p>Hasura CLIæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæ˜¯ç®¡ç†Hasuraé¡¹ç›®å’Œè¿ç§»çš„ä¸»è¦æ¨¡å¼ã€‚</p></li>
</ol>
<p>å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦å‰ä¸¤ä¸ªéƒ¨åˆ†å³å¯</p>
<h3 id="æ•´ä½“æ„å»ºæµç¨‹æ¢³ç†">æ•´ä½“æ„å»ºæµç¨‹æ¢³ç†</h3>
<h4 id="ä»£ç ç»“æ„è¯´æ˜">ä»£ç ç»“æ„è¯´æ˜</h4>
<pre class="shell"><code>graphql-engine 
    |-- server
          |-- src-rsr
                |-- console.html
    |-- console
          |-- xx.html
          |-- xxxx</code></pre>
<p>server ç›®å½•ä¼šç¼–è¯‘å‡ºä¸€ä¸ª graphql-engine çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶ä¸­ä¼šåŒ…å« <code>server/src-rsr/console.html</code> æ–‡ä»¶ä½œä¸ºé¦–é¡µçš„åŠ è½½æ¨¡æ¿ï¼ˆå³console.htmlï¼‰ã€‚</p>
<h4 id="graphql-engine-console">graphql-engine console</h4>
<p>consoleä¸ºwebå·¥ç¨‹ï¼Œä½¿ç”¨npm run buildå³å¯ç¼–è¯‘ï¼Œéå¸¸ç®€å•ã€‚æˆ‘ä»¬åªéœ€è¦é‡ç‚¹å…³æ³¨serveréƒ¨åˆ†å³å¯ã€‚ç°åœ¨æˆ‘ä»¬é‡ç‚¹åˆ†æè¿™ä¸ªserveréƒ¨åˆ†ï¼š</p>
<h4 id="graphql-engine-server">graphql-engine server</h4>
<ul>
<li>graphql-engine server ä½¿ç”¨haskellè¯­è¨€è¿›è¡Œç¼–å†™ï¼Œä½¿ç”¨ cabal è¿›è¡Œæ„å»ºï¼›</li>
<li>haskellæ˜¯ä¸€ä¸ªå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œç¼–è¯‘å™¨ä¸ºGHCï¼Œç¼–è¯‘å·¥å…·ä¸€èˆ¬ä½¿ç”¨cabalï¼ŒcabalåŒæ—¶ä¹Ÿæ˜¯é¡¹ç›®çš„ç®¡ç†å·¥å…·ï¼ˆå¦‚åŒ…ç®¡ç†ï¼Œä¾èµ–ç®¡ç†ï¼‰ã€‚</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ä¸ºäº†ç¼–è¯‘serverï¼Œæˆ‘ä»¬éœ€è¦GHCåŠcabalï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå·¥å…·çš„armç‰ˆæœ¬ç°çŠ¶å¦‚ä½•äº†ï¼Ÿ</p>
<ul>
<li>GHCï¼š æ— armç‰ˆæœ¬ç°æˆçš„dockeré•œåƒï¼Œæœ‰é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶ï¼›</li>
<li>cabalï¼š æ— armç‰ˆæœ¬ç°æˆçš„dockeré•œåƒåŠäºŒè¿›åˆ¶æ–‡ä»¶ï¼›</li>
</ul>
<p>ä¸ºäº†ä¸æ±¡æŸ“ç¯å¢ƒï¼Œå¹¶ä¸”æŒä¹…åŒ–æ„å»ºç¯å¢ƒï¼Œæˆ‘ä»¬å‡†å¤‡æ„å»ºä¸€ä¸ªdockerçš„é•œåƒï¼ŒåŒ…å«ghcåŠcabalï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸¤è€…éƒ½éœ€è¦æ„å»ºã€‚</p>
<p>æ€»ç»“ä»¥ä¸‹æ„å»ºæ­¥éª¤ï¼š</p>
<ol type="1">
<li>å‡†å¤‡haskellçš„ARMç‰ˆæœ¬ç¼–è¯‘ç¯å¢ƒï¼ˆåŒ…æ‹¬GHCç¼–è¯‘å™¨åŠhasuraç¼–è¯‘æ‰€éœ€è¦çš„cabalå·¥å…·ï¼‰ï¼›</li>
<li>ä½¿ç”¨ä¹‹å‰å‡†å¤‡å¥½çš„ARMç‰ˆæœ¬ç¼–è¯‘ç¯å¢ƒç¼–è¯‘hasuraï¼›</li>
<li>æ‰“åŒ…æˆDockeré•œåƒï¼›</li>
</ol>
<h4 id="æ•´ä½“æ„å»ºæµç¨‹-1">æ•´ä½“æ„å»ºæµç¨‹</h4>
<p>åœ¨æµè§ˆ<code>graphql-engine</code> çš„ä»“åº“ä¸­ciæ„å»ºçš„éƒ¨åˆ†æ–‡ä»¶ä¹‹åï¼Œæˆ‘å‘ç°è¿˜éœ€è¦å…¶ä»–ä¸€äº›è¾…åŠ©é•œåƒï¼Œæœ€åæ¢³ç†å‡ºå¦‚ä¸‹æ„å»ºæµç¨‹ï¼š</p>
<p><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316090603.png" alt="docker-image-builder-flow" style="zoom: 50%;" /></p>
<ol type="1">
<li>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ„å»º <code>graphql-engine-builder</code> çš„é•œåƒï¼Œå…¶ä¸­åŒ…æ‹¬haskellçš„GHCç¼–è¯‘å™¨åŠcabalä¾èµ–ç®¡ç†å·¥å…·ï¼›</li>
<li>ç„¶åæˆ‘ä»¬ä½¿ç”¨<code>graphql-engine-builder</code>é•œåƒå¯¹ graphql-engine çš„æºç è¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆ graphql-engine çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åŠ graphql-engine è¿è¡Œæ‰€éœ€è¦çš„ä¾èµ–åº“ï¼›</li>
<li>ç”±äºç¬¬äºŒæ­¥æ„å»ºè¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šä¸­é—´æˆæœï¼Œæˆ‘éœ€è¦ä¸ºgraphql-engineåˆ›é€ ä¸€ä¸ªçº¯å‡€çš„è¿è¡Œç¯å¢ƒä»¥ç¼©å°æœ€ç»ˆçš„è¿è¡Œé•œåƒçš„å¤§å°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ„å»º <code>graphql-engine-packager</code> é•œåƒï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç²¾ç®€ç‰ˆçš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</li>
<li>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ç¬¬äºŒæ­¥ä¸­ç”Ÿæˆçš„graphql-engineåŠå…¶ä¾èµ–æ–‡ä»¶å’Œç¬¬ä¸‰æ­¥ <code>graphql-engine-packager</code> é•œåƒä¸­çš„æ ¹æ–‡ä»¶ç³»ç»Ÿåˆå¹¶åˆ°ä¸€ä¸ªscratché•œåƒï¼Œç„¶åç”Ÿæˆ <code>graphql-engine-base</code> çš„é•œåƒï¼Œè¿™ä¸ªé•œåƒå·²ç»åŒ…å«äº†ä¸€ä¸ªå¯ä»¥æ­£å¸¸è¿è¡Œçš„ graphql-engine ï¼Œåªæ˜¯æ²¡æœ‰é›†æˆconsoleèµ„æºåˆ°é•œåƒä¸­ï¼›</li>
<li>æœ€åæˆ‘ä»¬å¯¹consoleè¿›è¡Œç¼–è¯‘ï¼Œç”Ÿæˆassetsèµ„æºï¼Œç„¶ååŸºäº <code>graphql-engine-base</code> æ·»åŠ è¿™äº›å‰ç«¯èµ„æºæ–‡ä»¶ï¼Œç”Ÿæˆæˆ‘ä»¬æœ€ç»ˆéœ€è¦çš„ <code>graphql-engine</code> é•œåƒï¼›</li>
</ol>
<h2 id="graphql-engine-builder-é•œåƒæ„å»º">graphql-engine-builder é•œåƒæ„å»º</h2>
<p>åŸºäºä»¥ä¸‹åŸå› ï¼Œæˆ‘å†³å®šæ„å»ºä¸€ä¸ªgraphql-engine-builderçš„é•œåƒï¼š</p>
<ol type="1">
<li>ä¸æƒ³æ±¡æŸ“è‡ªå·±çš„ä¸»æœºçš„ç¯å¢ƒï¼Œå®‰è£…ä¸€å †haskellçš„æ„å»ºç¯å¢ƒï¼›</li>
<li>æŒä¹…åŒ–ç¼–è¯‘ç¯å¢ƒï¼Œä½¿å¾—æ„å»ºè¿‡ç¨‹å¯ä»¥æ— æˆæœ¬è¿ç§»åˆ°ä»»ä½•æœºå™¨ï¼›</li>
</ol>
<p>è¿™ä¸ªbuilderé•œåƒåŒ…å«ä»¥ä¸‹å†…å®¹(å®é™…ä¸Šå°±æ˜¯haskellè¯­è¨€çš„æ„å»ºç¯å¢ƒ)ï¼š</p>
<ul>
<li>GHC</li>
<li>cabal</li>
</ul>
<p>ç»è¿‡ä¸€ç•ªå°è¯•ï¼Œç¡®å®šäº†å¦‚ä¸‹Dockerfileæ„å»ºè„šæœ¬ï¼š</p>
<h3 id="x86-dockerfile"><strong>X86</strong> Dockerfile</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#  x86 ç”¨äºæ„å»ºhasuraçš„é•œåƒ</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># æ„å»ºå‘½ä»¤ docker build -f Dockerfile -t hanlyjiang/graphql-engine-builder:latest .</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> haskell:8.10.1</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">## ensure locale is set during buildï¼ˆå¦åˆ™æ— æ³•æ„å»ºcabalï¼Œä¼šå‡ºç°hGetContenté”™è¯¯ï¼‰</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG            C.UTF-8</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># é¿å…é…ç½®tzdataæ—¶å‡ºç°çš„äº¤äº’å¼ç­‰å¾…ç•Œé¢å¯¼è‡´æ„å»ºå¡ä½</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> DEBIAN_FRONTEND noninteractive</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> sed -i <span class="st">&quot;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>   sed -i <span class="st">&quot;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&quot;</span>  /etc/apt/sources.list &amp;&amp; \</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>   apt-get update &amp;&amp; \</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>   apt-get install -y --no-install-recommends apt-utils lsb-release wget &amp;&amp; \</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">&quot;deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main&quot;</span> &gt; /etc/apt/sources.list.d/pgdg.list &amp;&amp; \</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>   wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc |  apt-key add - &amp;&amp; \</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>   apt-get update &amp;&amp; \</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>   apt-get install -y --no-install-recommends  postgresql libpq-dev &amp;&amp; \</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>   rm -fr /var/lib/apt/lists/* &amp;&amp; \</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>   <span class="co"># å®‰è£… upx</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>   wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz &amp;&amp; \</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>           tar -xf upx-3.96-amd64_linux.tar.xz  &amp;&amp; \</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>           cp upx-3.96-amd64_linux/upx /usr/bin/upx &amp;&amp; \</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>           rm -fr upx-3.96-amd64_linux</span></code></pre></div>
<p>x86ç‰ˆæœ¬åŸºäº haskellå®˜æ–¹çš„<code>haskell:8.10.1</code> é•œåƒï¼Œæ·»åŠ äº†å¦‚ä¸‹åŠ¨ä½œï¼š</p>
<ol type="1">
<li>æ›¿æ¢è½¯ä»¶æºä¸ºå›½å†…è½¯ä»¶æºï¼›</li>
<li>å®‰è£…å¿…è¦çš„è½¯ä»¶ä¾èµ–ï¼›</li>
<li>æ·»åŠ äº†upxç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶ä¼˜åŒ–ï¼›</li>
</ol>
<h3 id="arm-dockerfile"><strong>ARM</strong> Dockerfile</h3>
<p>armç‰ˆæœ¬çš„åˆ™éœ€è¦ä»å¤´æ„å»º</p>
<ul>
<li>æˆ‘ä»¬ä½¿ç”¨ <code>ubuntu:18.04</code> ä½œä¸ºåŸºç¡€é•œåƒï¼›</li>
<li>é¦–å…ˆå®‰è£…äº† LLVM6.0 åŠ GHC8.6.5 ï¼›</li>
<li>ä½¿ç”¨ GHC8.6.5 æ„å»º Cabal3.2.0.0ï¼ˆåŒ…æ‹¬cabal-installï¼‰ï¼Œå› ä¸ºGHC8.10.1æ— æ³•æˆåŠŸæ„å»ºcabal-install 3.2ï¼›</li>
<li>ç„¶åå®‰è£… LLVM 9 åŠGHC8.10.1ï¼Œç”¨äºåç»­ç¼–è¯‘hasuraï¼›</li>
<li>æ·»åŠ å¿…è¦çš„ä¾èµ–ï¼›</li>
<li>æ·»åŠ äº†upxç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶ä¼˜åŒ–ï¼›</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Hasura graphql-engine ç¼–è¯‘ç¯å¢ƒ</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># æµ‹è¯•å‘ç°åªæœ‰åœ¨armæœºå™¨ä¸Šæ‰å¯èƒ½æ„å»ºæˆåŠŸï¼Œx86 dockeräº¤å‰æ„å»ºå¤±è´¥</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build -t registry.cn-hangzhou.aliyuncs.com/geostar_private_arm/haskell-ghc8.6.5_8.10.1-cabal3.2:20200817 .</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ghc-8.6.5çš„å®‰è£…æ„å»ºéœ€è¦åœ¨ubuntu18.04ä¸Šï¼ˆglibc2.27)</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">## é€šè¿‡å¦‚ä¸‹æ–¹å¼ç¡®è®¤glibcç‰ˆæœ¬ï¼š</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">### docker run -it --rm ubuntu:18.04 bash -c &quot;find / -type f | grep libc-.*.so&quot; # è¾“å‡º /lib/x86_64-linux-gnu/libc-2.27.so</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">### docker run -it --rm debian:stretch bash -c &quot;find / -type f | grep libc-.*.so&quot; # è¾“å‡º /lib/x86_64-linux-gnu/libc-2.24.so</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">### docker run -it --rm debian:buster bash -c &quot;find / -type f | grep libc-.*.so&quot; # è¾“å‡º /lib/aarch64-linux-gnu/libc-2.28.so</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">### debianä¹Ÿå¯ä»¥åœ¨æ­¤é¡µé¢æŸ¥çœ‹ï¼šhttps://packages.debian.org/search?searchon=sourcenames&amp;keywords=glibc</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">#FROM debian:stretch</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ubuntu:18.04</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">## ensure locale is set during buildï¼ˆå¦åˆ™æ— æ³•æ„å»ºcabalï¼Œä¼šå‡ºç°hGetContenté”™è¯¯ï¼‰</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG            C.UTF-8</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># é¿å…é…ç½®tzdataæ—¶å‡ºç°çš„äº¤äº’å¼ç­‰å¾…ç•Œé¢å¯¼è‡´æ„å»ºå¡ä½</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co">## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> DEBIAN_FRONTEND noninteractive</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ä»¥é˜²ç½‘ç»œä¸å¥½ï¼Œåˆ‡æ¢åˆ°å›½å†…é•œåƒæº</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update &amp;&amp; \</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>     apt install -y apt-transport-https ca-certificates</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="kw">ADD</span> ubuntu18.04-sources.list /etc/apt/sources.list</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="co"># é¿å… hash sum mismatch é—®é¢˜ï¼š</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co">## https://stackoverflow.com/questions/15505775/debian-apt-packages-hash-sum-mismatch</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* &amp;&amp; apt-get clean &amp;&amp; apt-get update &amp;&amp; \</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co"># å®‰è£…å¸¸ç”¨è½¯ä»¶åŠGHCæ„å»ºç›¸å…³ä¾èµ–</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update &amp;&amp; \</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    apt-get install -y --no-install-recommends gnupg ca-certificates dirmngr curl git wget &amp;&amp; \</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    apt-get install -y --no-install-recommends zlib1g-dev libtinfo-dev libsqlite3-dev \</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>                g++ netbase xz-utils libnuma-dev make openssh-client \</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>                <span class="co"># hasura æ„å»ºéœ€è¦ï¼ˆpg-clientï¼‰</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>                <span class="co">## https://stackoverflow.com/questions/17915098/openssl-ssl-h-no-such-file-or-directory-during-installation-of-git</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>                libssl-dev libkrb5-dev &amp;&amp; \</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å®‰è£…llvm 6.0ï¼ˆç”¨äºæ„å»ºcabalï¼‰</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    LLVM_VERSION=6.0 &amp;&amp; \</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># apt-get install -y software-properties-common &amp;&amp; \</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="co">    apt-get install -y --no-install-recommends libghc-network-dev \</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="co">        llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev &amp;&amp; \</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="co">        rm -fr /var/lib/apt/lists/* &amp;&amp; \</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co">    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc  &amp;&amp; \</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="co">    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="co"># å®‰è£… GHC 8.6.5ï¼ˆç”¨äºæ„å»ºCabal3.2.0.0ï¼‰</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> GHC=8.6.5 &amp;&amp; GHC_OS_DIST=ubuntu18.04 &amp;&amp; \</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">## ä¸‹è½½é“¾æ¥ç±»ä¼¼ï¼šhttps://downloads.haskell.org/~ghc/8.10.1/ghc-8.10.1-aarch64-deb9-linux.tar.xz </span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz &amp;&amp; \</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz &amp;&amp; \</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    cd ghc-${GHC}  &amp;&amp; \</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>    ./configure &amp;&amp; \</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    make install &amp;&amp; \</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>    cd ../ &amp;&amp; \</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>    rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} </span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="co"># æ„å»º Cabal 3.2.0.0 ï¼ˆåŒ…æ‹¬ cabal-installï¼‰</span></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b cabal-install-v3.2.0.0 https://github.com/haskell/cabal.git &amp;&amp; \</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>    cd cabal/cabal-install &amp;&amp; \</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    ./bootstrap.sh &amp;&amp; \</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    cd ../.. &amp;&amp; \</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    rm -fr cabal</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a><span class="co"># å®‰è£… llvm 9 åŠå…¶ä»–æ„å»ºæ‰€éœ€ ï¼ˆpostgresql libpq-devï¼‰pg_config</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> LLVM_VERSION=9 &amp;&amp; \</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>    apt-get update &amp;&amp; \</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>    apt-get install -y --no-install-recommends llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev &amp;&amp; \</span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å¦‚æœæœ‰æ—§ç‰ˆæœ¬çš„ï¼Œåˆ™ç§»é™¤é“¾æ¥</span></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>    rm /usr/local/bin/llc /usr/local/bin/opt &amp;&amp; \</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc &amp;&amp; \</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt &amp;&amp; \</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å®‰è£…ghc8.10.1 ï¼Œè‡ªå¸¦Cabalåº“çš„3.2ç‰ˆæœ¬</span></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>    GHC=8.10.1 &amp;&amp; GHC_OS_DIST=deb9 &amp;&amp; \</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>    wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz &amp;&amp; \</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>    tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz &amp;&amp; \</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>    cd ghc-${GHC}  &amp;&amp; \</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>    ./configure &amp;&amp; \</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>    make install &amp;&amp; \</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>    cd ../ &amp;&amp; \</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>    rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} &amp;&amp; \</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># å®‰è£…3.96ç‰ˆæœ¬çš„upx-ç”¨äºå‹ç¼©ä¼˜åŒ–graphql-engineäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè½¯ä»¶æºä¸­çš„3.94ç‰ˆæœ¬æœ‰å‹ç¼©aarchçš„äºŒè¿›åˆ¶åæœ‰é—®é¢˜ https://github.com/upx/upx/issues/130ï¼‰</span></span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>    wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-arm64_linux.tar.xz &amp;&amp; \</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>    tar -xf upx-3.96-arm64_linux.tar.xz  &amp;&amp; \</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>    cp upx-3.96-arm64_linux/upx /usr/bin/upx &amp;&amp; \</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>    rm -fr upx-3.96-arm64_linux upx-3.96-arm64_linux.tar.xz /var/lib/apt/lists/*</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a><span class="co">## stack å®‰è£…(hasuraæ„å»ºå¯ä¸å®‰è£…stack)</span></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a><span class="co"># ARG STACK=2.1.3</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a><span class="co"># ARG STACK_KEY=C5705533DA4F78D8664B5DC0575159689BEFB442</span></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a><span class="co"># ARG STACK_RELEASE_KEY=2C6A674E85EE3FB896AFC9B965101FF31C5C154D</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN arch=`uname -m` &amp;&amp; \</span></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a><span class="co">#     echo $arch &amp;&amp; \ </span></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a><span class="co">#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz -o  stack.tar.gz &amp;&amp; \</span></span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a><span class="co">#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz.asc -o stack.tar.gz.asc </span></span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN export GNUPGHOME=&quot;$(mktemp -d)&quot; &amp;&amp; \</span></span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a><span class="co">#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_KEY} &amp;&amp; \</span></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a><span class="co">#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_RELEASE_KEY} &amp;&amp; \</span></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a><span class="co">#     gpg --batch --trusted-key 0x575159689BEFB442 --verify stack.tar.gz.asc stack.tar.gz &amp;&amp; \</span></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a><span class="co">#     tar -xf stack.tar.gz -C /usr/local/bin --strip-components=1 &amp;&amp; \</span></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a><span class="co">#     /usr/local/bin/stack config set system-ghc --global true &amp;&amp; \</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a><span class="co">#     /usr/local/bin/stack config set install-ghc --global false &amp;&amp; \</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a><span class="co">#     rm -rf &quot;$GNUPGHOME&quot; /var/lib/apt/lists/* /stack.tar.gz.asc /stack.tar.gz;</span></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a><span class="co"># è®¾ç½®ç¯å¢ƒå˜é‡ä½¿å¯ä»¥æ‰¾åˆ°cabalï¼ŒGHCçš„é»˜è®¤ä¼šå®‰è£…åˆ°PATHä¸­ï¼Œæ— éœ€é¢å¤–è®¾ç½®</span></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> PATH /root/.cabal/bin:$PATH</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a><span class="co">## æ²¡æœ‰æŒ‡å®šå‘½ä»¤çš„æ—¶å€™é»˜è®¤è¿è¡Œghci</span></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;ghci&quot;</span>]</span></code></pre></div>
<blockquote>
<p>æ³¨æ„ï¼šç”±äºä»¥ä¸Šbuilderé•œåƒæ˜¯ç”¨äºç¼–è¯‘graphql-engineçš„å·¥å…·é•œåƒï¼Œè€Œéæœ€ç»ˆçš„é•œåƒï¼Œæ‰€ä»¥å¹¶æœªåˆ»æ„å¯¹é•œåƒå¤§å°è¿›è¡Œä¼˜åŒ–ï¼›</p>
</blockquote>
<h2 id="graphql-engine-packager-æ„å»º">graphql-engine-packager æ„å»º</h2>
<p>packageré•œåƒä¸­åŒ…å«ä¸€ä¸ªçº¯å‡€çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä¸ºgraphql-engine serveræä¾›åŸºç¡€çš„è¿è¡Œç¯å¢ƒï¼›</p>
<h3 id="æ•´ä½“è¯´æ˜">æ•´ä½“è¯´æ˜</h3>
<p>graphql-engine-packagerçš„é•œåƒæ„å»ºè„šæœ¬ä½äºæºç çš„ <code>server/packaging</code> ç›®å½•ä¸­çš„ <code>package.df</code> æ–‡ä»¶ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hasura/haskell-docker-packager:20190731</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">MAINTAINER</span> vamshi@hasura.io</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y libpq5 upx \</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a> &amp;&amp; update-ca-certificates \</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a> &amp;&amp; mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a> &amp;&amp; cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a> &amp;&amp; rm -rf /var/lib/apt/lists/*</span></code></pre></div>
<p>å¯ä»¥çœ‹åˆ°å…¶åŸºäº <code>hasura/haskell-docker-packager:20190731</code> çš„é•œåƒï¼ˆ<a href="https://hub.docker.com/r/hasura/haskell-docker-packager/tags?page=1&amp;ordering=last_updated">DockerHubå¯¹åº”é¡µé¢</a>ï¼‰ï¼Œå…·ä½“æ„å»ºæ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre class="shell"><code>registry=hanlyjiang  # æ›¿æ¢æˆè‡ªè¡Œè®¾ç½®çš„å€¼
packager_ver=20210316 # æ›¿æ¢æˆè‡ªè¡Œè®¾ç½®çš„å€¼

docker build -t &#39;$registry/graphql-engine-packager:$packager_ver&#39; -f packaging/packager.df ./packaging/</code></pre>
<p>ä»ä»¥ä¸Šåˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬è¦æ„å»ºpackageré•œåƒï¼Œéœ€è¦å…ˆæ„å»º<code>haskell-docker-packager</code>é•œåƒï¼Œè€Œå¯¹äºX86ç‰ˆæœ¬æ¥è¯´ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä½¿ç”¨å®˜æ–¹å·²ç»æ„å»ºå¥½çš„é•œåƒï¼Œå¯¹äºARMç‰ˆæœ¬æ¥è¯´ï¼Œåˆ™éœ€è¦æˆ‘ä»¬ä»å¤´æ„å»ºï¼›</p>
<h3 id="x86é•œåƒæ„å»º">X86é•œåƒæ„å»º</h3>
<p>å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬ç›´æ¥åŸºäºå®˜æ–¹çš„ <code>hasura/haskell-docker-packager:20190731</code>å¹¶ä½¿ç”¨æºç ç›®å½•ä¸­çš„ <code>packaging/packager.df</code> æ–‡ä»¶æ„å»ºå‡ºå¯¹åº”çš„<code>graphql-engine-packager</code>é•œåƒå³å¯ï¼›</p>
<h3 id="arm">ARM</h3>
<h4 id="haskell-docker-packager-é•œåƒæ„å»º">haskell-docker-packager é•œåƒæ„å»º</h4>
<p>armç‰ˆæœ¬åˆ™éœ€è¦æˆ‘ä»¬ä»å¤´æ„å»º <code>haskell-docker-packager</code> çš„é•œåƒï¼ŒåŸºäºå®˜æ–¹çš„ <a href="https://github.com/hasura/haskell-docker-builder">github/hasura/haskell-docker-builder</a> æºç ï¼Œæˆ‘ç•¥ä½œä¿®æ”¹ï¼Œè®©å…¶å¯ä»¥æ„å»ºå‡ºarmç‰ˆæœ¬çš„é•œåƒï¼Œå¯¹åº”çš„ä»£ç æ”¾ç½®äº <a href="https://github.com/hanlyjiang/haskell-docker-builder">github/hanlyjiang/haskell-docker-builder</a> ä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯æ„å»ºå‡ºarmç‰ˆæœ¬çš„ <code>haskell-docker-packager</code> é•œåƒï¼š</p>
<pre class="shell"><code>git clone git@github.com:hanlyjiang/haskell-docker-builder.git 
make build </code></pre>
<p>ä¸Šè¿°å‘½ä»¤æ‰§è¡Œå®Œæ¯•åä¼šç”Ÿæˆä¸€ä¸ª <code>hanlyjiang/haskell-docker-packager:å½“å‰æ—¥æœŸ</code> çš„é•œåƒã€‚</p>
<h4 id="graphql-engine-packager-é•œåƒæ„å»º">graphql-engine-packager é•œåƒæ„å»º</h4>
<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨ graphql-engineçš„æºä»£ç çš„ <code>server/packaging</code> ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ªåä¸º <code>packaging-arm.df</code> çš„æ–‡ä»¶ç”¨äºæ„å»º arm ç‰ˆæœ¬çš„ <code>graphql-engine-packager</code> é•œåƒï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/haskell-docker-packager:20200814</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">MAINTAINER</span> hanlyjiang@outlook.com</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y libpq5 upx \</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a> &amp;&amp; update-ca-certificates \</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a> &amp;&amp; mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a> &amp;&amp; cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a> &amp;&amp; rm -rf /var/lib/apt/lists/*</span></code></pre></div>
<p>å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ„å»ºarmç‰ˆæœ¬é•œåƒï¼š</p>
<pre class="shell"><code>registry=hanlyjiang  # æ›¿æ¢æˆè‡ªè¡Œè®¾ç½®çš„å€¼
packager_ver=20210316 # æ›¿æ¢æˆè‡ªè¡Œè®¾ç½®çš„å€¼</code></pre>
<p>æ„å»ºå¯ä»¥åœ¨armæœºå™¨ä¸Šæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨x86æœºå™¨ä¸Šé€šè¿‡buildxæ¥äº¤å‰æ„å»ºï¼š</p>
<ul>
<li>arm æœºå™¨ä¸Šæ‰§è¡Œï¼š</li>
</ul>
<pre class="shell"><code>docker build -t &#39;$registry/graphql-engine-packager:$packager_ver&#39; -f packaging/packager-arm.df ./packaging/</code></pre>
<ul>
<li>éarmæœºå™¨ä¸Šäº¤å‰æ„å»ºarmé•œåƒ</li>
</ul>
<pre class="shell"><code>docker buildx build --platform=linux/arm64 -t &#39;$registry/graphql-engine-packager:$packager_ver&#39; -f packaging/packager-arm.df ./packaging/ --load</code></pre>
<h2 id="graphql-engine-base-æ„å»º">graphql-engine-base æ„å»º</h2>
<p><code>graphql-engine-base</code> é•œåƒåŒ…å« graphql-engine çš„ serverï¼Œå½“ä¸åŒ…å« console çš„ web èµ„æºï¼›</p>
<h3 id="x86é•œåƒæ„å»º-1">X86é•œåƒæ„å»º</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º graphql-engine é•œåƒ</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">## -- ç¼–è¯‘ graphql-engine</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/graphql-engine-builder:20201111 as builder</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_TAG=v1.3.2</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_USER=docker-build</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_PWD=4Kqy9Cb4FcYx2H4goiEq</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine </span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/server</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co"># åˆå§‹åŒ–cabalçš„é…ç½®</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> ln -s cabal.project.ci cabal.project.local &amp;&amp; \</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    export LANG=C.UTF-8 &amp;&amp; \</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ç”Ÿæˆé…ç½®æ–‡ä»¶(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    cabal user-config update &amp;&amp; \</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ›¿æ¢ä¸ºå›½å†…æº</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    sed -i <span class="st">&#39;s/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /root/.cabal/config  &amp;&amp; \</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    sed -i <span class="st">&#39;s/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g&#39;</span> /root/.cabal/config</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co"># é‡æ–°æ›´æ–°è½¯ä»¶åŒ…ä¿¡æ¯(å•ç‹¬ä½œä¸ºä¸€å±‚ï¼Œä»¥ä¾¿ç¼“å­˜)</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cabal new-update</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ç¼–è¯‘ graphql-engine å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="co"># æˆ‘ä»¬å°†åŠ è½½ä¸­æ›¿æ¢ä¸ºä¸­æ–‡</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> sed -i <span class="st">&#39;s/Loading/åŠ è½½ä¸­/g&#39;</span> src-rsr/console.html &amp;&amp; \</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    cabal new-build --jobs=$(nproc)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> build_output=../_build_output &amp;&amp; \</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    exec_glob=`find ./dist-newstyle/ -type f -name <span class="st">&quot;graphql-engine&quot;</span>` &amp;&amp; \</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    mkdir $build_output &amp;&amp; \</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$exec_glob&quot;</span> $build_output/ &amp;&amp; \</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get-version éœ€è¦åŸºäºgitä»“åº“è·å–ç‰ˆæœ¬å·</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    ../scripts/get-version.sh &gt;$build_output/version.txt </span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æå–åŸºç¡€çš„rootfs</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hasura/graphql-engine-packager:20190731 as baseRootfs</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=builder /app/graphql-engine/_build_output/ /root/</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /rootfs/ &amp;&amp; /build.sh graphql-engine | tar -x -C /rootfs/</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="co">## æ„å»ºæœ€ç»ˆçš„rootfs</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> builder as bulderRootfs</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> pg_dump_ver=12 &amp;&amp; \</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    exec_glob=`find server/dist-newstyle/ -type f -name <span class="st">&quot;graphql-engine&quot;</span>` &amp;&amp; \</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>    build_output=./_build_output  &amp;&amp; \</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>    packaging_dir=./server/packaging/  &amp;&amp; \</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>    rootfs_dir=$packaging_dir/build/rootfs  &amp;&amp; \</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>    cp $build_output/graphql-engine $rootfs_dir/bin &amp;&amp; \</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å–æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>    ldd $build_output/graphql-engine | awk <span class="st">&#39;BEGIN{ORS=&quot;\n&quot;}$1~/^\//{print $1}$3~/^\//{print $3}&#39;</span> | xargs cp -n -L --parents -t $rootfs_dir/ &amp;&amp; \</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å– pg_dump</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump &amp;&amp; \</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ä¼˜åŒ–&amp;å‹ç¼©</span></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>    strip --strip-unneeded $rootfs_dir/bin/graphql-engine &amp;&amp; \</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>    upx $rootfs_dir/bin/graphql-engine </span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a><span class="co">## - ä¸å¸¦ console-assets</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./</span></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> scratch as graphql-engine-base</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG=C.UTF-8 LC_ALL=C.UTF-8</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;graphql-engine&quot;</span>, <span class="st">&quot;serve&quot;</span>]</span></code></pre></div>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ„å»ºï¼š</p>
<pre class="shell"><code>TAG=$(date &#39;+%Y%m%d&#39;)

docker build -t graphql-engine-base:$TAG ./ </code></pre>
<h3 id="armç‰ˆæœ¬é•œåƒæ„å»º">ARMç‰ˆæœ¬é•œåƒæ„å»º</h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º graphql-engine é•œåƒ</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">## docker buildx build --platform=linux/arm64  -f Dockerfile-base-arm.dockerfile -t graphql-engine-base:arm-20201109 ./ --load</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">## æ„å»ºå‡†å¤‡</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># docker pull hanlyjiang/graphql-engine-builder:arm-latest</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">## -- ç¼–è¯‘ graphql-engine</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/graphql-engine-builder:arm-latest as builder</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_TAG=v1.3.2</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_USER=docker-build</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_PWD=4Kqy9Cb4FcYx2H4goiEq</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/server</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="co"># åˆå§‹åŒ–cabalçš„é…ç½®</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> ln -s cabal.project.ci cabal.project.local &amp;&amp; \</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    export LANG=C.UTF-8 &amp;&amp; \</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ç”Ÿæˆé…ç½®æ–‡ä»¶(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    cabal user-config update &amp;&amp; \</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ›¿æ¢ä¸ºå›½å†…æº</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    sed -i <span class="st">&#39;s/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /root/.cabal/config  &amp;&amp; \</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    sed -i <span class="st">&#39;s/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g&#39;</span> /root/.cabal/config</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="co"># é‡æ–°æ›´æ–°è½¯ä»¶åŒ…ä¿¡æ¯(å•ç‹¬ä½œä¸ºä¸€å±‚ï¼Œä»¥ä¾¿ç¼“å­˜)</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="co">## update è¿‡ç¨‹ä¸­å¯èƒ½è‡ªåŠ¨å»githubä¸‹è½½ä»“åº“</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cabal new-update</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ç¼–è¯‘ graphql-engine å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> sed -i <span class="st">&#39;s/Loading/åŠ è½½ä¸­/g&#39;</span> src-rsr/console.html &amp;&amp; \</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    cabal new-build --jobs=$(nproc)</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> build_output=../_build_output &amp;&amp; \</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    exec_glob=`find ./dist-newstyle/ -type f -name <span class="st">&quot;graphql-engine&quot;</span>` &amp;&amp; \</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    mkdir $build_output &amp;&amp; \</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$exec_glob&quot;</span> $build_output/ &amp;&amp; \</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get-version éœ€è¦åŸºäºgitä»“åº“è·å–ç‰ˆæœ¬å·</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    ../scripts/get-version.sh &gt;$build_output/version.txt </span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æå–åŸºç¡€çš„rootfs</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64  -f Dockerfile-base.dockerfile --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ --load</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/graphql-engine-packager:20200814 as baseRootfs</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=builder /app/graphql-engine/_build_output/ /root/</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a><span class="co"># build.sh çš„å†…å®¹å°±æ˜¯ä¸‹é¢çš„ ldd graphql-engine | awk &#39;</span><span class="re">BEGIN</span><span class="co">{ORS=&quot;\n&quot;}$1~/^\//{print $1}$3~/^\//{print $3}&#39; | xargs cp -n -L --parents -t ï¼Œç”¨äºæ‹·è´packageré•œåƒä¸­graphql-engineéœ€è¦çš„ä¾èµ–åº“åˆ°rootfs</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /rootfs/ &amp;&amp; /build.sh graphql-engine | tar -x -C /rootfs/</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a><span class="co">## æ„å»ºæœ€ç»ˆçš„rootfs</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ --load</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> builder as bulderRootfs</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> pg_dump_ver=12 &amp;&amp; \</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    exec_glob=`find server/dist-newstyle/ -type f -name <span class="st">&quot;graphql-engine&quot;</span>` &amp;&amp; \</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    build_output=./_build_output  &amp;&amp; \</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    packaging_dir=./server/packaging/  &amp;&amp; \</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    rootfs_dir=$packaging_dir/build/rootfs  &amp;&amp; \</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    cp $build_output/graphql-engine $rootfs_dir/bin &amp;&amp; \</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å–æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“</span></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    ldd $build_output/graphql-engine | awk <span class="st">&#39;BEGIN{ORS=&quot;\n&quot;}$1~/^\//{print $1}$3~/^\//{print $3}&#39;</span> | xargs cp -n -L --parents -t $rootfs_dir/ &amp;&amp; \</span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å– pg_dump(arm builderé•œåƒè·¯å¾„ä¸ä¸€æ ·)</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>    cp /usr/share/postgresql-common/pg_wrapper $rootfs_dir/bin/pg_dump &amp;&amp; \</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ä¼˜åŒ–&amp;å‹ç¼©</span></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    strip --strip-unneeded $rootfs_dir/bin/graphql-engine &amp;&amp; \</span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>    upx $rootfs_dir/bin/graphql-engine </span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a><span class="co">## - ä¸å¸¦ console-assets</span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base-arm:20201110 --target graphql-engine-base ./ --load</span></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> scratch as graphql-engine-base</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;jianghanghang@geostar.com.cn&quot;</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /</span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG=C.UTF-8 LC_ALL=C.UTF-8</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;graphql-engine&quot;</span>, <span class="st">&quot;serve&quot;</span>]</span></code></pre></div>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ„å»ºï¼š</p>
<pre class="shell"><code>TAG=$(date &#39;+%Y%m%d&#39;)

# ARMæœºå™¨æ‰§è¡Œ
docker build  -t graphql-engine-base:arm-$TAG  ./

# x86äº¤å‰æ„å»º
docker buildx build --platform=linux/arm64 -t  graphql-engine-base:arm-$TAG ./ --load</code></pre>
<h3 id="æ„å»ºè„šæœ¬åˆå¹¶ç®€åŒ–æœªéªŒè¯">æ„å»ºè„šæœ¬åˆå¹¶ç®€åŒ–ï¼ˆæœªéªŒè¯ï¼‰</h3>
<div class="sourceCode" id="cb45"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º graphql-engine é•œåƒ</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">## -- ç¼–è¯‘ graphql-engine</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> builder_image</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> packager_image</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ${builder_image} as builder</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_TAG=v1.3.2</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_USER=docker-build</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_PWD=4Kqy9Cb4FcYx2H4goiEq</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine </span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/server</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="co"># åˆå§‹åŒ–cabalçš„é…ç½®</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> ln -s cabal.project.ci cabal.project.local &amp;&amp; \</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    export LANG=C.UTF-8 &amp;&amp; \</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ç”Ÿæˆé…ç½®æ–‡ä»¶(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    cabal user-config update &amp;&amp; \</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># æ›¿æ¢ä¸ºå›½å†…æº</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    sed -i <span class="st">&#39;s/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /root/.cabal/config  &amp;&amp; \</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    sed -i <span class="st">&#39;s/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g&#39;</span> /root/.cabal/config</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a><span class="co"># é‡æ–°æ›´æ–°è½¯ä»¶åŒ…ä¿¡æ¯(å•ç‹¬ä½œä¸ºä¸€å±‚ï¼Œä»¥ä¾¿ç¼“å­˜)</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> cabal new-update</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ç¼–è¯‘ graphql-engine å¯æ‰§è¡Œæ–‡ä»¶</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="co"># æˆ‘ä»¬å°†åŠ è½½ä¸­æ›¿æ¢ä¸ºä¸­æ–‡</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> sed -i <span class="st">&#39;s/Loading/åŠ è½½ä¸­/g&#39;</span> src-rsr/console.html &amp;&amp; \</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    cabal new-build --jobs=$(nproc)</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> build_output=../_build_output &amp;&amp; \</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    exec_glob=`find ./dist-newstyle/ -type f -name <span class="st">&quot;graphql-engine&quot;</span>` &amp;&amp; \</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    mkdir $build_output &amp;&amp; \</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$exec_glob&quot;</span> $build_output/ &amp;&amp; \</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get-version éœ€è¦åŸºäºgitä»“åº“è·å–ç‰ˆæœ¬å·</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    ../scripts/get-version.sh &gt;$build_output/version.txt </span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æå–åŸºç¡€çš„rootfs</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ${packager_image} as baseRootfs</span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=builder /app/graphql-engine/_build_output/ /root/</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> mkdir /rootfs/ &amp;&amp; /build.sh graphql-engine | tar -x -C /rootfs/</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a><span class="co">## æ„å»ºæœ€ç»ˆçš„rootfs</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> builder as bulderRootfs</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> pg_dump_ver=12 &amp;&amp; \</span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>    exec_glob=`find server/dist-newstyle/ -type f -name <span class="st">&quot;graphql-engine&quot;</span>` &amp;&amp; \</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>    build_output=./_build_output  &amp;&amp; \</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>    packaging_dir=./server/packaging/  &amp;&amp; \</span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>    rootfs_dir=$packaging_dir/build/rootfs  &amp;&amp; \</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>    cp $build_output/graphql-engine $rootfs_dir/bin &amp;&amp; \</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å–æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“</span></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>    ldd $build_output/graphql-engine | awk <span class="st">&#39;BEGIN{ORS=&quot;\n&quot;}$1~/^\//{print $1}$3~/^\//{print $3}&#39;</span> | xargs cp -n -L --parents -t $rootfs_dir/ &amp;&amp; \</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># è·å– pg_dump</span></span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump &amp;&amp; \</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ä¼˜åŒ–&amp;å‹ç¼©</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>    strip --strip-unneeded $rootfs_dir/bin/graphql-engine &amp;&amp; \</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>    upx $rootfs_dir/bin/graphql-engine </span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a><span class="co">## - ä¸å¸¦ console-assets</span></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./</span></span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> scratch as graphql-engine-base</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LANG=C.UTF-8 LC_ALL=C.UTF-8</span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;graphql-engine&quot;</span>, <span class="st">&quot;serve&quot;</span>]</span></code></pre></div>
<p>æ„å»ºå‘½ä»¤ï¼š</p>
<ul>
<li><p><strong>X86</strong></p>
<pre class="shell"><code>builder_image=hanlyjiang/graphql-engine-builder:20201111
packager_image=hasura/graphql-engine-packager:20190731
TAG=$(date &#39;+%Y%m%d&#39;)

docker build ./ -t graphql-engine-base:$TAG --build-arg builder_image=&quot;$builder_image&quot; --build-arg packager_image=&quot;$packager_image&quot;</code></pre></li>
<li><p><strong>ARM</strong></p>
<pre class="shell"><code>builder_image=hanlyjiang/graphql-engine-builder:arm-latest
packager_image=hanlyjiang/graphql-engine-packager:20200814
TAG=$(date &#39;+%Y%m%d&#39;)

# ARMæœºå™¨æ‰§è¡Œ
docker build  -t graphql-engine-base:arm-$TAG --build-arg builder_image=&quot;$builder_image&quot; --build-arg packager_image=&quot;$packager_image&quot; ./

# x86äº¤å‰æ„å»º
docker buildx build --platform=linux/arm64 -t  graphql-engine-base:arm-$TAG --build-arg builder_image=&quot;$builder_image&quot; --build-arg packager_image=&quot;$packager_image&quot; ./ --load</code></pre></li>
</ul>
<h2 id="graphql-engine-é•œåƒæ„å»º">graphql-engine é•œåƒæ„å»º</h2>
<p>graphql-engine å³æ˜¯æˆ‘ä»¬æœ€ç»ˆéœ€è¦ä½¿ç”¨çš„é•œåƒï¼ŒåŒ…å«graphql-engine çš„serveråŠconsole webèµ„æºï¼›</p>
<h3 id="x86">X86</h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º graphql-engine é•œåƒ</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co">## docker build -t graphql-engine:20201111 ./</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æ„å»º console </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># æœ‰æ—¶consoleä»£ç æ›´æ–°ï¼Œæˆ‘ä»¬ç›´æ¥ä»ä»“åº“è·å–æœ€æ–°ä»£ç </span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY --from=builder /app/graphql-engine/console /app/console</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_TAG=v1.3.2</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_USER=docker-build</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_PWD=4Kqy9Cb4FcYx2H4goiEq</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/console</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co"># å•ç‹¬æå–installæ­¥éª¤ä¾¿äºç¼“å­˜</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux ; \</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    npm config set sass_binary_site=https://npm.taobao.org/mirrors/node-sass &amp;&amp; \</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    npm install --registry=https://registry.npm.taobao.org</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN npm install</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git pull &amp;&amp; npm run build</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co"># å¼€å§‹æ„å»º</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux ; \</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    CONSOLE_ASSETS_PATH=./static/assets &amp;&amp; \</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    DIST_PATH=./static/dist &amp;&amp; \</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    ls -laR $DIST_PATH &amp;&amp; \</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    if [ ! -d <span class="st">&quot;$CONSOLE_ASSETS_PATH/common&quot;</span> ]; then \</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        mkdir -p $CONSOLE_ASSETS_PATH/common; \</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>        cp -r <span class="st">&quot;$DIST_PATH/../assets/common&quot;</span> <span class="st">&quot;$CONSOLE_ASSETS_PATH&quot;</span>; \</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    fi;  \ </span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    rm -rf <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned&quot;</span> &amp;&amp; \</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    mkdir -p <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned&quot;</span> &amp;&amp; \</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$DIST_PATH&quot;</span>/*.js <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned/&quot;</span> &amp;&amp; \</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js &amp;&amp; \</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># console æ‰“åŒ…æ–¹å¼ä¸­å¯èƒ½å°†cssæ”¾ç½®åˆ°jsä¸­ï¼Œè¿™é‡Œä¸å¼ºåˆ¶è¦æ±‚æœ‰cssæ–‡ä»¶ç”Ÿæˆ</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$DIST_PATH&quot;</span>/*.css <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned/&quot;</span> || true &amp;&amp; \</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æ„å»ºæœ€ç»ˆé•œåƒ</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="co"># docker build --progress plain -t graphql-engine:20201110 ./</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;jianghanghang@geostar.com.cn&quot;</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> docker-entrypoint.sh /usr/local/bin/</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh \</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s usr/local/bin/docker-entrypoint.sh /</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;docker-entrypoint.sh&quot;</span>]</span></code></pre></div>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ„å»ºï¼š</p>
<pre class="shell"><code>TAG=$(date &#39;+%Y%m%d&#39;)
docker build -t graphql-engine:$TAG ./</code></pre>
<h3 id="arm-1">ARM</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º graphql-engine é•œåƒ</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co">## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co">## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æ„å»º console </span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># æœ‰æ—¶consoleä»£ç æ›´æ–°ï¼Œæˆ‘ä»¬ç›´æ¥ä»ä»“åº“è·å–æœ€æ–°ä»£ç </span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY --from=builder /app/graphql-engine/console /app/console</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_TAG=v1.3.2</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_USER=docker-build</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_PWD=4Kqy9Cb4FcYx2H4goiEq</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/console</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="co"># å•ç‹¬æå–installæ­¥éª¤ä¾¿äºç¼“å­˜</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> npm install --registry=https://registry.npm.taobao.org</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> npm run build </span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="co"># å¼€å§‹æ„å»º</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux ; \</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    CONSOLE_ASSETS_PATH=./static/assets &amp;&amp; \</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>    DIST_PATH=./static/dist &amp;&amp; \</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>    ls -laR $DIST_PATH &amp;&amp; \</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    if [ ! -d <span class="st">&quot;$CONSOLE_ASSETS_PATH/common&quot;</span> ]; then \</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>        mkdir -p $CONSOLE_ASSETS_PATH/common; \</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        cp -r <span class="st">&quot;$DIST_PATH/../assets/common&quot;</span> <span class="st">&quot;$CONSOLE_ASSETS_PATH&quot;</span>; \</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    fi;  \ </span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    rm -rf <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned&quot;</span> &amp;&amp; \</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    mkdir -p <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned&quot;</span> &amp;&amp; \</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$DIST_PATH&quot;</span>/*.js <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned/&quot;</span> &amp;&amp; \</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js &amp;&amp; \</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># console æ‰“åŒ…æ–¹å¼ä¸­å¯èƒ½å°†cssæ”¾ç½®åˆ°jsä¸­ï¼Œè¿™é‡Œä¸å¼ºåˆ¶è¦æ±‚æœ‰cssæ–‡ä»¶ç”Ÿæˆ</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$DIST_PATH&quot;</span>/*.css <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned/&quot;</span> || true &amp;&amp; \</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æ„å»ºæœ€ç»ˆé•œåƒ</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;jianghanghang@geostar.com.cn&quot;</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> docker-entrypoint.sh /usr/local/bin/</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh \</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s usr/local/bin/docker-entrypoint.sh /</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;docker-entrypoint.sh&quot;</span>]</span></code></pre></div>
<p>æ„å»ºå‘½ä»¤ï¼š</p>
<pre class="shell"><code>TAG=$(date &#39;+%Y%m%d&#39;)
docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:$TAG ./
docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-$TAG ./ --load</code></pre>
<h3 id="æ„å»ºè„šæœ¬ç®€åŒ–æœªéªŒè¯">æ„å»ºè„šæœ¬ç®€åŒ–(æœªéªŒè¯)</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">### æ„å»º graphql-engine é•œåƒ</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co">## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> base_image</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æ„å»º console </span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co"># æœ‰æ—¶consoleä»£ç æ›´æ–°ï¼Œæˆ‘ä»¬ç›´æ¥ä»ä»“åº“è·å–æœ€æ–°ä»£ç </span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY --from=builder /app/graphql-engine/console /app/console</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_TAG=v1.3.2</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_USER=docker-build</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> GIT_PWD=4Kqy9Cb4FcYx2H4goiEq</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app/graphql-engine/console</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co"># å•ç‹¬æå–installæ­¥éª¤ä¾¿äºç¼“å­˜</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> npm install --registry=https://registry.npm.taobao.org</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> npm run build </span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co"># å¼€å§‹æ„å»º</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> set -eux ; \</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    CONSOLE_ASSETS_PATH=./static/assets &amp;&amp; \</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    DIST_PATH=./static/dist &amp;&amp; \</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>    ls -laR $DIST_PATH &amp;&amp; \</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    if [ ! -d <span class="st">&quot;$CONSOLE_ASSETS_PATH/common&quot;</span> ]; then \</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>        mkdir -p $CONSOLE_ASSETS_PATH/common; \</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>        cp -r <span class="st">&quot;$DIST_PATH/../assets/common&quot;</span> <span class="st">&quot;$CONSOLE_ASSETS_PATH&quot;</span>; \</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    fi;  \ </span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    rm -rf <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned&quot;</span> &amp;&amp; \</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>    mkdir -p <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned&quot;</span> &amp;&amp; \</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$DIST_PATH&quot;</span>/*.js <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned/&quot;</span> &amp;&amp; \</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js &amp;&amp; \</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># console æ‰“åŒ…æ–¹å¼ä¸­å¯èƒ½å°†cssæ”¾ç½®åˆ°jsä¸­ï¼Œè¿™é‡Œä¸å¼ºåˆ¶è¦æ±‚æœ‰cssæ–‡ä»¶ç”Ÿæˆ</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    cp <span class="st">&quot;$DIST_PATH&quot;</span>/*.css <span class="st">&quot;$CONSOLE_ASSETS_PATH/versioned/&quot;</span> || true &amp;&amp; \</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="co">## -- æ„å»ºæœ€ç»ˆé•œåƒ</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="co"># docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> ${base_image}</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;jianghanghang@geostar.com.cn&quot;</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="co"># COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> docker-entrypoint.sh /usr/local/bin/</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh \</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>    &amp;&amp; ln -s usr/local/bin/docker-entrypoint.sh /</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="kw">ENTRYPOINT</span> [<span class="st">&quot;docker-entrypoint.sh&quot;</span>]</span></code></pre></div>
<ul>
<li><p>x86æ„å»ºï¼š</p>
<pre class="shell"><code>base_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123

TAG=$(date &#39;+%Y%m%d&#39;)

docker build ./ -t graphql-engine-base:$TAG --build-arg base_image=&quot;$base_image&quot; --build-arg </code></pre></li>
<li><p>armæ„å»º</p>
<pre class="shell"><code>base_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2

TAG=$(date &#39;+%Y%m%d&#39;)

# arm æœºå™¨ç›´æ¥æ„å»º
docker build ./ -t graphql-engine:arm-$TAG --build-arg base_image=&quot;$base_image&quot; --build-arg 


# x86äº¤å‰æ„å»º
docker buildx build --platform=linux/arm64 -t  graphql-engine:arm-$TAG --build-arg base_image=&quot;$base_image&quot; ./ --load</code></pre></li>
</ul>
<h1 id="geopanelå®¹å™¨åŒ–-è‡ªç ”æœåŠ¡é•œåƒæ„å»º">GeoPanelå®¹å™¨åŒ–-è‡ªç ”æœåŠ¡é•œåƒæ„å»º</h1>
<h2 id="å‰è¨€-1">å‰è¨€</h2>
<p>æ‰€æœ‰å½“å‰å·²ç»æ„å»ºçš„æœåŠ¡ï¼Œéƒ½å¯ä»¥é€šè¿‡<a href="http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/README.md">gepanel-deploy ä»“åº“ä¸­çš„readme</a>è¿›è¡Œå¿«é€Ÿå¯¼èˆªï¼Œå¦‚ï¼š</p>
<p><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210319162128.png" alt="image-20210319162127913" style="zoom: 50%;" /></p>
<h2 id="blockapi-token-æœåŠ¡é•œåƒæ„å»º">blockapi-token æœåŠ¡é•œåƒæ„å»º</h2>
<p>é•œåƒæ„å»ºçš„ç›¸å…³æ–‡ä»¶ç›®å½•ä½äº <a href="http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/tree/v1.3.2/docker/hasura-token">gitlabæ­¤è·¯å¾„</a>ï¼Œå…·ä½“æ„å»ºæ—¶æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><strong>ç‹å³°</strong>æä¾›æˆå“jaråŒ…ï¼›</li>
<li>æ”¾ç½®åˆ°æ­¤ç›®å½•æ‰§è¡Œdocker buildx build å‘½ä»¤æ‰“åŒ…ï¼›</li>
</ol>
<p>ç”±äºå…¶dockerfileéå¸¸ç®€å•ï¼Œæ‰€ä»¥åœ¨æ­¤ä¸å†è§£é‡Šï¼Œå¯ç›´æ¥æŸ¥çœ‹gitlabä¸­å¯¹åº”çš„ï¼š</p>
<ul>
<li><a href="http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/Dockerfile">dockerfile</a></li>
<li><a href="http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/README.md">æ‰“åŒ…åŠä½¿ç”¨æ–¹å¼</a></li>
</ul>
<h2 id="blockapi-db-integrate-æœåŠ¡é•œåƒæ„å»º">blockapi-db-integrate æœåŠ¡é•œåƒæ„å»º</h2>
<p>æ•°æ®åº“é›†æˆæœåŠ¡çš„é•œåƒæ„å»ºç›¸å…³æ–‡ä»¶ä½äº <a href="http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev/docker">gitlabæ­¤è·¯å¾„</a> ï¼Œå…·ä½“æ„å»ºæ—¶æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><strong>éŸ©å°ä¹</strong> æä¾›æˆå“jaræˆ–è€…æˆ‘ä»¬è‡ªè¡Œä»<a href="http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev">æºç </a>ç¼–è¯‘jarï¼›</li>
<li>æ”¾ç½®åˆ°dockeræ„å»ºç›®å½•ä½¿ç”¨docker buildx buildå‘½ä»¤æ„å»ºï¼›</li>
</ol>
<p>ç”±äºå…¶dockerfileéå¸¸ç®€å•ï¼Œæ‰€ä»¥åœ¨æ­¤ä¸å†è§£é‡Šï¼Œå¯ç›´æ¥æŸ¥çœ‹gitlabä¸­å¯¹åº”çš„ï¼š</p>
<ul>
<li><a href="http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/Dockerfile">dockerfile</a></li>
<li><a href="http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/README.md">æ‰“åŒ…åŠä½¿ç”¨æ–¹å¼</a></li>
</ul>
<h2 id="blockapi-restapi-æœåŠ¡é•œåƒæ„å»º">blockapi-restapi æœåŠ¡é•œåƒæ„å»º</h2>
<p>ç”±äºä¹‹å‰æœ‰å®Œæˆè¿‡ï¼Œåœ¨æ­¤ä¸åœ¨å™è¿°ï¼Œå¯å‚è€ƒ <a href="http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/rest-api/-/tree/master/docker">æ­¤gitlabç›®å½•</a></p>
<h2 id="gpl-datacollection-æœåŠ¡é•œåƒæ„å»º">gpl-datacollection æœåŠ¡é•œåƒæ„å»º</h2>
<p>åŸ‹ç‚¹ç³»ç»ŸæœåŠ¡é•œåƒçš„æ„å»ºæ–‡ä»¶ä½äº <a href="http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/tree/develop/docker">gitlabæ­¤è·¯å¾„</a> ï¼Œå…·ä½“æ„å»ºæ—¶æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li><strong>ç‹å³°</strong> æä¾›æˆå“jarï¼›</li>
<li>æ”¾ç½®åˆ°dockeræ„å»ºç›®å½•ä½¿ç”¨ docker buildx buildå‘½ä»¤æ„å»ºï¼›</li>
</ol>
<p>ç”±äºå…¶dockerfileéå¸¸ç®€å•ï¼Œæ‰€ä»¥åœ¨æ­¤ä¸å†è§£é‡Šï¼Œå¯ç›´æ¥æŸ¥çœ‹gitlabä¸­å¯¹åº”çš„ï¼š</p>
<ul>
<li><a href="http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/Dockerfile">dockerfile</a></li>
<li><a href="http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/README.md">æ‰“åŒ…åŠä½¿ç”¨æ–¹å¼</a></li>
</ul>
<h1 id="geopanelå®¹å™¨åŒ–-æœåŠ¡ç¼–æ’">GeoPanelå®¹å™¨åŒ–-æœåŠ¡ç¼–æ’</h1>
<h2 id="é•œåƒå­˜å‚¨åŠåˆ†å‘ç®¡ç†">é•œåƒå­˜å‚¨åŠåˆ†å‘ç®¡ç†</h2>
<p><img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210323092448.png" alt="geopanel-registrys" style="zoom: 40%;" /></p>
<ol type="1">
<li>harbor ä¸ºå†…ç½‘åŸºäº <a href="https://goharbor.io/">harbor</a> æ­å»ºçš„ç§æœ‰docker registry;</li>
<li>å¯¹äºè‡ªè¡Œæ„å»ºçš„é•œåƒï¼Œæˆ‘ä»¬åªéœ€è¦å°†é•œåƒæ¨é€åˆ°harborï¼Œæ ¹æ®é…ç½®å¥½çš„è‡ªåŠ¨å¤åˆ¶è§„åˆ™ï¼Œé•œåƒä¼šè‡ªåŠ¨åŒæ­¥åˆ°é˜¿é‡Œäº‘ç§æœ‰dockeré•œåƒä»“åº“ï¼Œä¹‹åè¯¥é•œåƒå³å¯ä»é˜¿é‡Œäº‘é•œåƒä»“åº“æ‹‰å–ï¼›</li>
<li>harborä»“åº“å¯ä½¿ç”¨åŸŸè´¦å·è¿›è¡Œç™»å½•ï¼ŒæŒ‰é¡¹ç›®è¿›è¡Œè¯»å†™æƒé™æ§åˆ¶ï¼›<br />
</li>
<li>é˜¿é‡Œäº‘çš„ç§æœ‰é•œåƒä»“åº“å¼€æ”¾ä¸€ä¸ªå…¬ç”¨çš„åªè¯»è´¦å·ï¼Œä¸æ¥å—æ‰‹åŠ¨é•œåƒæ¨é€ï¼›<br />
</li>
<li>å®é™…éƒ¨ç½²æ—¶ï¼Œå¯æ ¹æ®ç°åœºçš„ç½‘ç»œæƒ…å†µï¼Œé€‰æ‹©ä½¿ç”¨å…¬å¸ä»“åº“/é˜¿é‡Œäº‘ä»“åº“åœ¨çº¿æ‹‰å–ï¼Œæˆ–è€…ä½¿ç”¨é•œåƒæ‰¹é‡å¯¼å‡ºè„šæœ¬æ‰¹é‡å¯¼å‡ºé•œåƒæ–‡ä»¶ï¼Œè¿›è¡Œç¦»çº¿éƒ¨ç½²ï¼›</li>
</ol>
<h2 id="geopanelæœåŠ¡ååŠå˜é‡å‘½åçº¦å®š">GeoPanelæœåŠ¡ååŠå˜é‡å‘½åçº¦å®š</h2>
<h3 id="è‡ªæœ‰æœåŠ¡å‘½åçº¦å®š">è‡ªæœ‰æœåŠ¡å‘½åçº¦å®š</h3>
<p>è§„èŒƒæœåŠ¡å‘½åèƒ½æ–¹ä¾¿æ ‡è¯†æœåŠ¡ä¹‹é—´çš„é€»è¾‘å…³ç³»ï¼Œå¯¹åº”çš„æœåŠ¡å‘½åä¼šåæ˜ åˆ°é›†ç¾¤éƒ¨ç½²ä¸­æœåŠ¡çš„åç§°ï¼ŒæœåŠ¡ä¸­æ¥å£/é¡µé¢çš„åŸºç¡€åœ°å€ï¼ŒæœåŠ¡ç›¸å…³çš„é…ç½®å˜é‡ã€‚</p>
<ul>
<li>æœåŠ¡ä¸­åº”åŒ…å«æœåŠ¡æ‰€å±çš„æ¨¡å—å†…å®¹ç¼©å†™ï¼Œå¦‚å—æ•°æ®apiå¼•æ“ä¸ºblockapiï¼›</li>
<li>æœåŠ¡çš„å®¹å™¨ç¼–æ’åç§°ï¼Œé•œåƒåç§°ï¼ŒæœåŠ¡çš„åŸºç¡€æœåŠ¡åœ°å€ï¼ŒæœåŠ¡åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„å¯¼å…¥æˆ–å¯¼å‡ºçš„é…ç½®å˜é‡åç§°å‡åº”ä¿æŒä¸€è‡´æ€§ï¼›</li>
</ul>
<p>ç›®å‰æœ‰å¦‚ä¸‹å‡ ä¸ªä¸»è¦æœåŠ¡å•å…ƒï¼š</p>
<h4 id="å½“å‰é›†ç¾¤æœåŠ¡å‘½å"><strong>å½“å‰é›†ç¾¤æœåŠ¡å‘½å</strong></h4>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="header">
<th>æœåŠ¡</th>
<th>å‘½åè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>å—æ•°æ®APIå¼•æ“</td>
<td>å‘½åä¸º blockapi ï¼ŒåŒ…å«ä»¥ä¸‹æœåŠ¡ï¼š<br/>1. <code>blockapi</code> : å—æ•°æ®apiå¼•æ“æœåŠ¡ï¼ˆåŸºç¡€hasura graphqlå¼•æ“ï¼‰<br/>2. <code>blockapi-token</code>: å—æ•°æ®apiå¼•æ“æ‰©å±•æ¨¡å—-tokenç®¡ç†service <br/>3. <code>blockapi-db-integrate</code>ï¼šå—æ•°æ®apiå¼•æ“æ‰©å±•æ¨¡å—-æ•°æ®åº“é›†æˆservice <br/>4. <code>blockapi-restapi</code>: å—æ•°æ®apiå¼•æ“æ‰©å±•æ¨¡å—-restapi service</td>
</tr>
<tr class="even">
<td>åŸ‹ç‚¹æ—¥å¿—ç®¡ç†ç³»ç»Ÿ</td>
<td>å‘½å ï¼š <code>gpl-data-collection</code></td>
</tr>
</tbody>
</table>
<h4 id="å½“å‰å„æœåŠ¡æ¥å£webç•Œé¢åŸºç¡€åœ°å€"><strong>å½“å‰å„æœåŠ¡æ¥å£/webç•Œé¢åŸºç¡€åœ°å€ï¼š</strong></h4>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 19%" />
<col style="width: 59%" />
</colgroup>
<thead>
<tr class="header">
<th>æœåŠ¡</th>
<th>åŸºç¡€åœ°å€</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>blockapi</td>
<td>-</td>
<td>ä¿æŒå’Œå¼€æºç‰ˆæœ¬graphql-engineä¸€è‡´</td>
</tr>
<tr class="even">
<td>blockapi-token</td>
<td>/block-api/tks</td>
<td>http://192.168.43.73:8881/block-api/tks</td>
</tr>
<tr class="odd">
<td>blockapi-db-integrate</td>
<td>/block-api/db-intgrs</td>
<td>http://192.168.43.73:8882/block-api/db-intgrs</td>
</tr>
<tr class="even">
<td>blockapi-restapi</td>
<td>/block-api/restapi</td>
<td><a href="http://172.17.0.105:8884/block-api/restapi">http://172.17.0.105:8884/block-api/restapi</a></td>
</tr>
<tr class="odd">
<td>gpl-data-collection</td>
<td>/gpl-dc</td>
<td>http://192.168.43.73:8883/gpl-dc</td>
</tr>
</tbody>
</table>
<h3 id="é€šç”¨å˜é‡è¯´æ˜">é€šç”¨å˜é‡è¯´æ˜</h3>
<h4 id="æ¦‚è¿°">æ¦‚è¿°</h4>
<p>åœ¨æœåŠ¡éƒ¨ç½²æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¯å¢ƒå˜é‡æ¥ä¸ºå„ä¸ªæœåŠ¡æä¾›éœ€è¦çš„é…ç½®ï¼Œä»¥ä¸‹é€šç”¨å˜é‡ç”¨äºå‡å°‘æœåŠ¡éƒ¨ç½²æ—¶æ‰€éœ€è¦çš„å˜é‡ï¼Œå¤§è‡´æŒ‰ä»¥ä¸‹åŸåˆ™ï¼š</p>
<ul>
<li>ç›¸åŒå«ä¹‰çš„å˜é‡å°½é‡ç»Ÿä¸€ä¸ºä¸€ä¸ª</li>
<li>æœ‰å¯èƒ½å†…éƒ¨å’Œå¤–éƒ¨ç”¨é€”çš„æœåŠ¡ä½¿ç”¨ä¸¤ä¸ªå˜é‡åŒºåˆ†å¼€æ¥</li>
<li>å˜é‡å‘½åéœ€è¦å¸¦ä¸ŠæœåŠ¡åå‰ç¼€</li>
</ul>
<blockquote>
<p><strong>å¤–éƒ¨URLå’Œå†…éƒ¨URLè¯´æ˜ï¼šï¼ˆä¸‹æ–¹éƒ¨åˆ†æœåŠ¡ä¼šå¯¼å‡ºå†…éƒ¨å’Œå¤–éƒ¨ä¸¤ä¸ªurlçš„å˜é‡ï¼‰</strong></p>
<ul>
<li><strong>å†…éƒ¨URL</strong>ï¼šåœ¨dockeré›†ç¾¤å†…éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨æœåŠ¡åæ›¿ä»£IPåœ°å€è®¿é—®å¯¹åº”çš„æœåŠ¡ï¼Œä¸€èˆ¬ç”¨äºæœåŠ¡å†…éƒ¨ä¹‹é—´äº’ç›¸è®¿é—®ï¼›ï¼ˆå¦‚ä½¿ç”¨å†…éƒ¨URLï¼Œåœ¨éƒ¨ç½²æ—¶å¯ä¸éœ€è¦ä¿®æ”¹é…ç½®ï¼‰</li>
<li><strong>å¤–éƒ¨URL</strong>ï¼šå½“æœåŠ¡éœ€è¦ç»™å®¢æˆ·ç«¯ï¼ˆå¦‚APPæˆ–æµè§ˆå™¨ï¼‰æˆ–ä¸å±äºæˆ‘æ–¹æœåŠ¡é›†ç¾¤çš„å…¶ä»–æœåŠ¡è°ƒç”¨æ—¶ï¼Œéœ€è¦æä¾›å¤–éƒ¨çš„IPï¼ˆédockeré›†ç¾¤å†…éƒ¨ï¼‰ç»™å¤–éƒ¨è®¿é—®ï¼›</li>
</ul>
</blockquote>
<table style="width:100%;">
<colgroup>
<col style="width: 11%" />
<col style="width: 32%" />
<col style="width: 32%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>æœåŠ¡</strong></th>
<th style="text-align: left;"><strong>å˜é‡å</strong></th>
<th style="text-align: left;">è¯´æ˜åŠç¤ºä¾‹å€¼</th>
<th><strong>springbootå˜é‡å</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">postgres</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;">zookeeper</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">æš‚æœªä¾›å¤–éƒ¨ä½¿ç”¨ï¼Œä¸å¯¼å‡ºå˜é‡</td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: left;">kafka</td>
<td style="text-align: left;"><em>kafka å†…éƒ¨åœ°å€</em><br/><code>KAFKA_INTERNAL_URL</code></td>
<td style="text-align: left;">kafka:9092</td>
<td>kafka.internal_url</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"><em>kafka å¤–éƒ¨åœ°å€</em><br/><code>KAFKA_EXTERNAL_URL</code></td>
<td style="text-align: left;">192.168.43.22:9094</td>
<td>kafka.external_url</td>
</tr>
<tr class="odd">
<td style="text-align: left;">redis</td>
<td style="text-align: left;">RedisæœåŠ¡ä¸»æœº<br/><code>REDIS_HOST</code></td>
<td style="text-align: left;">redis</td>
<td>redis.host</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">RedisæœåŠ¡ç«¯å£<br/><code>REDIS_PORT</code></td>
<td style="text-align: left;">6379</td>
<td>redis.port</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">RedisæœåŠ¡è®¿é—®å¯†ç <br/><code>REDIS_PASSWORD</code></td>
<td style="text-align: left;">vsMEDgmxZdjOi7Nd</td>
<td>redis.password</td>
</tr>
<tr class="even">
<td style="text-align: left;">blockapi</td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“æ•°æ®åº“åœ°å€<br/><code>HASURA_GRAPHQL_DATABASE_URL</code><br/><code>BLOCKAPI_DATABASE_URL</code></td>
<td style="text-align: left;">postgres://postgres:<br/>d8cfe3137214759a932014084ac410b9<br/><span class="citation" data-cites="postgres:5432/hasura">@postgres:5432/hasura</span></td>
<td>blockapi.database_url</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“ç®¡ç†å¯†é’¥<br/><code>HASURA_GRAPHQL_ADMIN_SECRET</code><br/><code>BLOCKAPI_ADMIN_SECRET</code></td>
<td style="text-align: left;">d8cfe3137214759a932014084ac410b9<br/>ä¸¤ä¸ªå˜é‡å«ä¹‰ä¸€è‡´ï¼Œä¼˜å…ˆä½¿ç”¨ BLOCKAPI_ADMIN_SECRET</td>
<td>blockapi.admin_secert</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“å†…éƒ¨åœ°å€<br/><code>BLOCKAPI_INTERNAL_URL</code></td>
<td style="text-align: left;"><code>http://graphql-engine:8080</code></td>
<td>blockapi.internal_url</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“çš„å¤–éƒ¨åœ°å€<br><code>BLOCKAPI_EXTERNAL_URL</code></td>
<td style="text-align: left;"><code>http://192.168.43.22:8883</code></td>
<td>blockapi.external_url</td>
</tr>
<tr class="even">
<td style="text-align: left;">blockapi-token<br></td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“tokenç®¡ç†æœåŠ¡å†…éƒ¨æ¥å£åœ°å€<br><code>BLOCKAPI_TOKEN_INTERNAL_URL</code></td>
<td style="text-align: left;">http://blockapi-token:9099/block-api/tks</td>
<td>blockapi.token.internal_url</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“tokenç®¡ç†æœåŠ¡å¤–éƒ¨æ¥å£åœ°å€<br><code>BLOCKAPI_TOKEN_EXTERNAL_URL</code></td>
<td style="text-align: left;">http://192.168.43.73:8881/block-api/tks</td>
<td>blockapi.token.external_url</td>
</tr>
<tr class="even">
<td style="text-align: left;">blockapi-db-integrate</td>
<td style="text-align: left;">å—æ•°æ®APIå¼•æ“æ•°æ®åº“é›†æˆæœåŠ¡å¤–éƒ¨æ¥å£åœ°å€<br><code>BLOCKAPI_DATABASE_INTEGRATE_EXTERNAL_URL</code></td>
<td style="text-align: left;">http://192.168.43.73:8882/block-api/db-intgrs</td>
<td>blockapi.database_intergrate.external_url</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gpl-data-collection</td>
<td style="text-align: left;">åŸ‹ç‚¹ç³»ç»ŸæœåŠ¡åœ°å€ï¼Œæš‚æœªä¾›å¤–éƒ¨ä½¿ç”¨ï¼Œä½†æä¾›é¢„å®šä¹‰2ä¸ªå˜é‡<br><code>GPL_DATACOLLECTION_INTERNAL_URL</code></td>
<td style="text-align: left;"></td>
<td>gpl_datacollection.internal_url</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>GPL_DATACOLLECTION_EXTERNAL_URL</code></td>
<td style="text-align: left;"></td>
<td>gpl_datacollection.external_url</td>
</tr>
</tbody>
</table>
<h4 id="åœ¨springbootä¸­ä½¿ç”¨å˜é‡">åœ¨springbootä¸­ä½¿ç”¨å˜é‡</h4>
<blockquote>
<p>å¾…è¡¥å……</p>
</blockquote>
<h2 id="å½“å‰æœåŠ¡ç¼–æ’ç­–ç•¥">å½“å‰æœåŠ¡ç¼–æ’ç­–ç•¥</h2>
<p>å½“å‰å°†æ‰€æœ‰å·²ç»å®¹å™¨åŒ–çš„æœåŠ¡åˆ’åˆ†ä¸ºå¦‚ä¸‹æœåŠ¡éƒ¨ç½²å•å…ƒï¼š</p>
<pre class="mermaid"><code>graph LR

G[GeoPanel] --&gt; B

G --&gt; K

G --&gt; GPL_DC

B[blockapi] --&gt; blockapi-engine
B --&gt; postgres
B --&gt; redis
B --&gt; blockapi-token
B --&gt; blockapi-db-integrate
B --&gt; blockapi-restapi

K[kafka] --&gt; kafka
K --&gt; zookeeper

GPL_DC[gpl-datacollection] --&gt; gpl-datacollection</code></pre>
<p>ç›®å‰åˆ†ä¸ºä¸‰å—ï¼ˆblockapiï¼Œkafkaï¼Œgpl-datacollectionï¼‰ï¼Œæ¯ä¸ªæ¨¡å—åˆ†åˆ«å¯¹åº”ä¸€ä¸ªswarmçš„éƒ¨ç½²ymlé…ç½®ï¼Œå¯ä»¥å•ç‹¬è¿›è¡Œå¯åŠ¨ï¼Œä½¿ç”¨ç›¸åŒçš„stackåç§°å¯åŠ¨åï¼Œåˆ™å¯ä»¥è¿›å…¥ä¸€ä¸ªstackä¸­ï¼›</p>
<p>éƒ¨ç½²ä»“åº“åœ°å€ä½äº<a href="http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/geopanel-deploy">gitlabä¸Š</a>ã€‚</p>
<h2 id="å½“å‰éƒ¨ç½²ä»“åº“ç»†èŠ‚è¯´æ˜">å½“å‰éƒ¨ç½²ä»“åº“ç»†èŠ‚è¯´æ˜</h2>
<pre class="shell"><code>.
â”œâ”€â”€ README.md -- æ–‡æ¡£è¯´æ˜
â”œâ”€â”€ blockapi -- å—æ•°æ®apiå¼•æ“çš„éƒ¨ç½²é…ç½®æ‰€åœ¨ç›®å½•
â”‚Â Â  â”œâ”€â”€ README.md -- å—æ•°æ®apiå¼•æ“çš„é…ç½®åŠå¯åŠ¨è¯´æ˜æ–‡æ¡£
â”‚Â Â  â”œâ”€â”€ config.env -- å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼Œç›®å‰æœªä½¿ç”¨
â”‚Â Â  â”œâ”€â”€ db-init - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼Œä»…åšå¤‡ä»½ï¼Œç›®å‰æœªä½¿ç”¨
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 00_fdws.sh
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 10_postgis.sh
â”‚Â Â  â”‚Â Â  â””â”€â”€ 20_gpl_data_collection.sql
â”‚Â Â  â”œâ”€â”€ docker-compose-arm.yml -- armç‰ˆæœ¬çš„éƒ¨ç½²é…ç½®æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ docker-compose.yml -- x86ç‰ˆæœ¬çš„éƒ¨ç½²é…ç½®æ–‡ä»¶
â”‚Â Â  â””â”€â”€ redis-config -- redis é…ç½®
â”‚Â Â      â””â”€â”€ redis.conf
â”œâ”€â”€ data -- æ•°æ®æŒ‚è½½ç›®å½•
â”‚Â Â  â””â”€â”€ redis
â”œâ”€â”€ deploy.sh -- è¾…åŠ©éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ env -- å…¨å±€é…ç½®ç›®å½•
â”‚Â Â  â””â”€â”€ global.env -- å…¨å±€é…ç½®ï¼ŒåŒ…å«æ‰€æœ‰é…ç½®é¡¹ç›®ï¼Œå¦‚å¯èƒ½æœ‰éœ€è¦ä½¿ç”¨å…¬å…±é…ç½®çš„ï¼ŒæœåŠ¡éƒ½åº”è¯¥åœ¨ymlä¸­å£°æ˜æ—¶å¼•ç”¨æ­¤é…ç½®
â”œâ”€â”€ gpl-datacollection -- åŸ‹ç‚¹ç®¡ç†ç³»ç»Ÿéƒ¨ç½²é…ç½®ç›®å½•
â”‚Â Â  â”œâ”€â”€ README.md -- åŸ‹ç‚¹ç³»ç»Ÿçš„é…ç½®ä¿®æ”¹åŠå¯åŠ¨æ–¹å¼è¯´æ˜æ–‡æ¡£
â”‚Â Â  â”œâ”€â”€ config.env -- åŸ‹ç‚¹ç³»ç»Ÿçš„å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼Œç›®å‰æœªä½¿ç”¨
â”‚Â Â  â””â”€â”€ docker-compose.yml --åŸ‹ç‚¹ç³»ç»Ÿçš„éƒ¨ç½²å¯åŠ¨é…ç½®æ–‡ä»¶
â”œâ”€â”€ kafka -- kafkaçš„éƒ¨ç½²é…ç½®ç›®å½•
â”‚Â Â  â”œâ”€â”€ README.md -- kafkaæœåŠ¡è¯´æ˜ï¼ŒkafkaéªŒè¯æ–¹å¼è¯´æ˜
â”‚Â Â  â””â”€â”€ docker-compose.yml -- éƒ¨ç½²é…ç½®æ–‡ä»¶</code></pre>
<p>æ€»çš„æ¥è¯´ï¼Œç›®å‰æœ‰å¦‚ä¸‹ç»“æ„è®¾è®¡ï¼š</p>
<ol type="1">
<li>æŒ‰é€»è¾‘ç›¸å…³æ€§å°†æœåŠ¡è¿›è¡Œä¸€å®šçš„åˆ’åˆ†ï¼Œä¸€ä¸ªå•å…ƒçš„æœåŠ¡çš„éƒ¨ç½²ç›¸å…³æ–‡ä»¶åŠé…ç½®åœ¨ä¸€ä¸ªéƒ¨ç½²ç›®å½•ä¸­å•ç‹¬å­˜å‚¨ï¼Œä½¿ç”¨ä¸€ä¸ªdocker-compose.ymlæ–‡ä»¶æ¥ç¼–æ’ï¼Œå¯ä»¥å•ç‹¬å¯åŠ¨ï¼›</li>
<li>ä½¿ç”¨ä¸€ä¸ª <code>env/global.env</code> æ–‡ä»¶æ¥å­˜æ”¾æ‰€æœ‰éœ€è¦ä¿®æ”¹çš„é…ç½®åŠå…¨å±€é…ç½®/éœ€è¦å…±äº«çš„é…ç½®-ä»¥æ–¹ä¾¿éƒ¨ç½²æ—¶ç»Ÿä¸€ä¿®æ”¹ï¼Œæ¯ä¸ªéƒ¨ç½²å•å…ƒä¸­é¢„ç•™ä¸€ä¸ª<code>.env</code>æ–‡ä»¶-ç”¨äºå­˜æ”¾ç§æœ‰é…ç½®ï¼Œåªæ˜¯ç›®å‰éƒ½æ²¡æœ‰ä½¿ç”¨ï¼›</li>
<li>æä¾›äº†ä¸€ä¸ª <code>deploy.sh</code> çš„è¾…åŠ©éƒ¨ç½²è„šæœ¬ç”¨äºç®€åŒ–éƒ¨ç½²æ­¥éª¤ï¼Œä½†æ­¤è„šæœ¬ç›®å‰å¹¶ä¸å¤Ÿå®Œå–„ï¼›</li>
<li>æ¯ä¸ªéƒ¨ç½²ç›®å½•æä¾›README.mdå•ç‹¬å¯¹å½“å‰ç›®å½•ä¸­çš„éƒ¨ç½²å•å…ƒè¿›è¡Œè¯´æ˜ï¼Œä¸€èˆ¬åº”åŒ…å«é…ç½®ä¿®æ”¹è¯´æ˜ï¼Œéƒ¨ç½²å¯åŠ¨è¯´æ˜ï¼Œå¯åŠ¨æˆåŠŸç¡®è®¤æ–¹å¼ï¼Œæ•°æ®æŒ‚è½½æƒ…å†µè¯´æ˜ï¼Œæ ¹æ®å…·ä½“æƒ…å†µä¹Ÿå¯ä»¥æä¾›ç®€å•çš„æµ‹è¯•æ­¥éª¤ï¼›</li>
</ol>
<blockquote>
<p>å¯¹äºå„ä¸ªéƒ¨ç½²å•å…ƒçš„éƒ¨ç½²æ–‡ä»¶ï¼Œä¸å†å•ç‹¬è¯´æ˜ï¼Œè¯·å‚è€ƒä»“åº“ä¸­çš„ymléƒ¨ç½²æ–‡ä»¶åŠreadme</p>
</blockquote>
