

# 项目维护-社管e通打包壳维护

主要对接人员：肖荣

项目源码仓库： [Gitlab-社管e通打包壳](http://172.17.0.205/Development/Mobile/support/sgt-h5-package)

建议：

1. 已经配置好的地区的打包过程直接交给肖荣自行完成；
2. 如需添加新的地区的配置，需要辅助项目组进行配置，配置完成后，后续打包由项目组完成；
3. 如需进行原生侧代码调整，则需要特别注意，需要兼容不同地区的功能，建议直接复制原有类作为新的只用于单个地区的类进行修改；

## 打包说明

> 直接参考 [项目中的 REDME.md](http://172.17.0.205/Development/Mobile/support/sgt-h5-package/-/blob/master/README.md) 即可

本仓库旨在统一基于dcloud h5+ & mui 开发的社管e通的打包外壳，目前社管e通包括如下版本：

- 高明
- 寿阳
- 新疆
- 武汉：包括15个区的版本

master分支不存储代码，具体代码需切换到对应分支。

### 分支说明

虽然我们的目标是统一原生侧打包壳为一个，但是由于历史原因，部分版本的原生代码目前无法合并到一个版本中，故会区分不同分支。

1. 武昌区替换过包名及签名，无法合并，会单独拉一个分支；
2. 寿阳的地图相关功能有较多修改，无法与其他地区共用，会单独拉分支；
3. 其他地区目前情况暂不明确，暂共用一个分支；

当前仅梳理寿阳，高明，武昌三个版本，其他版本待具体有需求时再行加入测试；

#### 分支列表

- [`master_武昌社管通`]()： 武昌社管e通
- [`master_社管通_通用`]()： 其他地方的社管e通

### 通用打包流程

#### 切换分支

> 根据所需要打包的地区，确定使用的分支并切换！！！
> 根据所需要打包的地区，确定使用的分支并切换！！！
> 根据所需要打包的地区，确定使用的分支并切换！！！

##### 参考表

| 地区 | 所在分支             | 配置名称 |
| ---- | -------------------- | -------- |
| 高明 | `master_社管通_通用` | gaoming  |
| 寿阳 | `master_社管通_通用` | shouyang |
| 武昌 | `master_武昌社管通`  | wuchang  |

#### 更新H5

将H5包放置与对应的目录，如：`app-wh/src/wuchang/assets/apps/SGET` ，其中武昌需要替换为具体的地区的配置，可参考对应分支中的打包说明

```
.
└── app-wh
    └── src
        └── wuchang
            └── assets
                └── apps
                    └── SGET
                        └── www
```

#### 更新版本号

版本号的信息位于 `app-wh/build.gradle` 目录中，如：

```
productFlavors {
    wuchang
    {
        dimension "area"
        // 添加具体地方的apk的版本信息
        versionCode 20201016
        versionName "build1.1.0"
    }
}
```

修改其中的 `versionCode` 及 `versionName` 的值即可。

#### 打包

- 1. 修改 `local.properties` 文件中的 “sdk.dir” 路径，修改为Android SDK的文件路径。
- 1. 执行如下命令打包

```
gradlew assemble{配置}Release 
```

> 其中配置需要替换为对应的地区,如：   gradlew assembleShouYangRelease

- 3） 获取apk包
  apk位于 `app-wh/build/outputs/apk/{配置}/release` 目录



## 仓库详细说明

以下对仓库进行详细说明，主要是为了应对需要对原生侧修改，或者需要新加打包地区时的修改需求；

### 当前已经配置并测试过的地区打包配置

1. 高明；
2. 寿阳；
3. 武汉（需要肖荣确认）



### 项目目录说明

```shell
├── README.md
├── SGET.keystore
├── app-wh -- app 模块目录
│   ├── build
│   ├── build.gradle
│   ├── libs
│   ├── libs-dcloud
│   └── src
├── build.gradle -- 声明打包配置
├── doc
│   └── package.md
├── gradle
│   └── wrapper
├── gradle.properties
├── gradlew
├── gradlew.bat
├── local.properties
├── package.sh
├── settings.gradle
├── startapk.bat

```

app-wh 目录：

```shell
├── libs
├── libs-dcloud
└── src
    ├── common - 部分模块共有代码，build.gradle 中声明
    │   └── java
    ├── gaoming - 高明社管e通独有代码
    │   ├── assets
    │   └── res
    ├── main - 所有模块都有的代码
    │   ├── assets
    │   ├── java
    │   ├── jniLibs
    │   └── res
    ├── shouyang - 寿阳网格通独有代码
    │   ├── assets
    │   ├── java
    │   └── res
    ├── wuhan - 武汉的通用代码，暂未使用
    │   └── assets
    ├── wuhan_hongshanqu - 暂未使用
    │   └── assets
    ├── wuhan_jianghanqu - 暂未使用
    │   └── assets
    └── xinjianɡ
        └── assets
```

1. 通过 build.gradle 来声明不同的地区配置flavor；
2. 打包的H5资源放置在各自地区的 `assets` 目录中，实现打包隔离；
3. 地区独有的资源（图标，背景，app名称等）及代码也放置到对应的flaovr目录中；



### build.gradle 说明

build.gradle 中的重要配置代码如下，有两个主要的配置段：

1. sourceSets： 配置公用的源码
2. productFlavors： 配置地区打包的不同flavor配置

```groovy
    // 通用的代码，但是寿阳的不需要
    List<String> commonSourceDirs = ['common'] // 自己的代码

    sourceSets {
        gaoming {
            commonSourceDirs.each { dir ->
                assets.srcDirs "src/${dir}/assets"
                // 指定源码目录
                java.srcDirs "src/${dir}/java"
                //资源目录
                res.srcDirs "src/${dir}/res"
                jniLibs.srcDirs "src/${dir}/jniLibs"
            }
        }
        wuhan {
            commonSourceDirs.each { dir ->
                assets.srcDirs "src/${dir}/assets"
                // 指定源码目录
                java.srcDirs "src/${dir}/java"
                //资源目录
                res.srcDirs "src/${dir}/res"
                jniLibs.srcDirs "src/${dir}/jniLibs"
            }
        }
    }

    // Specifies one flavor dimension.
    flavorDimensions "area"
    productFlavors {
        /**
         * 寿阳
         */
        shouyang {
            dimension "area"
            // 添加具体地方的apk的版本信息
            versionCode 20210128
            versionName "build3.0.5"
        }
        /**
         * 高明区
         */
        gaoming
         {
            // Assigns this product flavor to the "version" flavor dimension.
            // If you are using only one dimension, this property is optional,
            // and the plugin automatically assigns all the module's flavors to
            // that dimension.
            dimension "area"
             // 添加具体地方的apk的版本信息
             versionCode 20200820
             versionName "build1.1.4"
        }

        /**
         * 新疆
         */
        xinjianɡ {
            dimension "area"

        }

        /**
         * 全局的武汉
         */
        wuhan {
            dimension "area"
            // 添加具体地方的apk的版本信息
            versionCode 20200720
            versionName "build1.1.6"
        }

        wuhan_jianghanqu {
            dimension "area"

        }

        wuhan_hongshanqu {
            dimension "area"

        }

    }
```

**注意点：**

1. 如新增加配置，需要在配置中添加 sourceSet 子配置项目以包含common部分代码，（shouyang的配置不需要），如：

   ```groovy
   xinjianɡ {
               commonSourceDirs.each { dir ->
                   assets.srcDirs "src/${dir}/assets"
                   // 指定源码目录
                   java.srcDirs "src/${dir}/java"
                   //资源目录
                   res.srcDirs "src/${dir}/res"
                   jniLibs.srcDirs "src/${dir}/jniLibs"
               }
           }
   ```

2. 可以在`productFlavors`的配置中指定的flavor中添加版本及版本号配置，如：

   ```groovy
           /**
            * 全局的武汉
            */
           wuhan {
               dimension "area"
               // 添加具体地方的apk的版本信息
               versionCode 20200720
               versionName "build1.1.6"
           }
   ```

3. 由于武昌地区的打包壳更改过包名，所以无法与现有的通用分支公用代码，在修改通用分支的部分基础性非业务相关bug时，可能需要同步到武昌的分支中，此时需要比对两个分支的代码，根据实际情况进行代码修改；





