# 结合TB&Gitlab的自动化开发流程

## 概述

![结合TB及Gitlab-CI&CD的开发流程](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180822.png)

我们使用TB作为任务管理的工具，使用Gitlab管理代码及执行自动流水线；

具体流程说明如下：

* 提交需求/BUG并在Teambition上建立对应任务

* 编码及本地测试

* 推送代码至Gitlab并提起合并请求，建立合并请求时会自动触发如下事件：
  * 推送合并请求建立消息到指定的Teambition任务
  * 推送合并请求建立消息到指定的Mattermost频道
  * 自动触发Gitlab CI/CD流水线
  
* 提交合并请求时会自动触发Gitlab 自动化流水线，其中的自动化任务可包括
  * 代码质量扫描
  * 自动构建
  * 自动部署验证环境
  * 冒烟测试
  
* 当Gitlab自动流水线完成之后，会发送通知到Mattermost指定频道

* 此时可从**Teambition任务/Mattermost消息**跳转到对应的Gitlab合并请求地址，进行合并前的检视

* 检视完成后通过Gitlab合并请求界面的合并按钮合并代码（某些情况下需要离线合并代码），代码合并后会自动触发如下事件
  * 推送合并请求建立消息到指定的Teambition任务
  * 推送合并请求建立消息到指定的Mattermost频道
  * 自动触发Gitlab CI/CD流水线
  
* 这一阶段的自动CI/CD流水线完成如下自动化任务
  * 自动构建
  * 自动部署（部署到预定义的测试环境）
  * 自动测试
  
* 流水线运行完毕后会推送消息到Mattermost中

* 此时相关人员可从**Teambition任务/Mattermost消息**跳转到对应的Gitlab合并请求地址，进行确认

* 确认通过后可在Gitlab上手动建立发布版本；


> 注意： 上述流程中自动触发的CI流水线任务会根据具体项目中的CI配置有所不同；

## TB&Gitlab&Mattermost关联设置

如需完成上述流程中的自动化消息推送，需要对Teambition，Gitlab及Mattermost做一些关联设置；

具体设置过程参考 ： [TB&Gitlab&Mattermost项目关联设置](TB&Gitlab&Mattermost项目关联设置.md)



## 需求/问题导入

- 如有对应需求或BUG需要修复，在Teambition上新建对应任务；
- 在任务中添加对应人员（以便相关人员能接受到后续通知）；

  

## 修改提交代码

- 如任务需要进行编码，则需在对应的Gitlab仓库中建立新的分支，分支命名中必须包含任务ID，可按如下规则命名：

| **类型** | **命名规则**                   | **说明**                                                     |
| :------- | ------------------------------ | :----------------------------------------------------------- |
| 需求     | `feature/{任务ID}[-可选说明] ` | 任务ID为必填项目，请填写Teambition上建立任务后生成的任务ID    可选说明只能使用英文字母，数字，下划线（_）及短横线（-），不能使用中文；<br/> ⚠️注意：“{任务ID}”中代表任务ID，实际填写时不要包含"{}" |
| BUG      | `bugfix/{任务ID}[-可选说明]  ` | 同上                                                         |
| 代码重构 | `refactor/{任务ID}[-可选说明]` | 同上                                                         |

- 编码请基于最新主线版本代码拉出新分支，并按如上规则命名，同一任务编码过程使用同一分支完成，可多次提交并推送到同一远程分支；

>  提示:
>
> * 编码过程中可多次提交多次推送到远程分支

## 发起合并请求

- 如需将代码合并到主线/稳定分支，需要提起合并请求；
- 合并请求填写要求：

| **字段**    | **说明**                                                     | **示例** |
| ----------- | ------------------------------------------------------------ | -------- |
| 标题        | 【#任务ID】-修改概述 <br/>如该合并请求关联多个任务，可在标题中包含多个任务ID，如【#IMC-41,#IMC-42】 |          |
| Description | 描述更改的目的及评审人员应注意的事项    <br/>（可选）@需要检视的人员    <br/>（可选）粘贴对应TB任务的链接 |          |
| Assignee    | 选择代码合并人员                                             |          |

- 提交合并请求后会自动推送通知到Teambition及Mattermost
- 如该合并请求关联多个TB任务（如修复了多个TB任务对应的BUG），则对应的合并请求只会关联到合并请求标题中第一个任务ID，此时需要手动打开其他TB任务，并在任务关联中关联第一个任务，以便后续进行跟踪追溯；

> 了解更多：
>
> * 如何获取TB任务ID - TB任务详情上方，点击即可复制任务ID
>
>   ![image-20210225144312451](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210225144312.png)
>
> * 提交合并请求后，会自动在合并请求标题中第一个任务ID对应的任务中关联当前合并请求，效果如下：
>
>   <img src="https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210225144541.png" alt="image-20210225144541305"  />
>

## AppReview&代码检视

* 提交合并请求的开发人员可等待自动化流水线运行完成后进入合并请求页面点击`查看应用`进行AppReView，查看SonarQube代码扫描结果并进行修复；(下图中点击查看应用即可进入AppReView)

  ![image-20210225141504404](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210225141504.png)

* 代码合并人员及其他相关成员可到Gitlab合并请求界面对代码进行检视，检查其中可能的问题，如有发现问题，可在gitlab合并请求中代码变更比对页面提交对应的检视意见；

  ![代码检视提交意见](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210225140922.png)

* （可选）测试人员亦可以在阶段对所声明修复的问题进行测试确认；
* 如发现问题，则可继续修改提交并推送到同一分支，会重新触发CI流水线；为节省其他成员的时间，请开发人员在本地测试无误后再提交合并请求，并对提交合并请求后的AppReView进行预先确认后再通知其他成员进行检视及测试；

> 说明：
>
> * AppView 指提交后GitlabCI自动对当前提交的分支代码进行编译，并部署一个反映当前修改的临时环境，供开发及测试人员进行确认及测试，一般AppView都对应于一个Web前端服务地址；
> * 是否能进行AppView依赖于项目上具体的CI配置，如没有配置则不会有对应的AppView链接入口；



## 合并代码

各成员角色对当前修改都确认无误之后，由代码合并人员对代码进行合并；

* 对于没有冲突的修改，一般可以通过Gitlab 合并请求页面上的合并按钮自动合并，合并前请务必对代码进行检视；
* 如有冲突，则需要在本地开发机上进行代码合并，合并完成后推送到对应的主分支，合并请求即自动关闭；
* ⚠️注意：**Git自动合并功能无法处理代码语义的合并，请代码合并人员务必确保了解了当前修改自动合并的效果后再使用Gitlab的自动合并功能**



## 发布版本

* 代码合并后会触发自动流水线，同时运行定义的一系列检测及自动化测试任务，完成后会自动部署到测试环境；

* 此时可由测试人员对测试环境进行确认；

* 测试通过后可通知开发人员对版本进行标记发布；

* 版本的标记发布过程需在Gitlab对应仓库中将当前测试通过的提交标记为发布；

  ![image-20210225143717465](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210225143717.png)

> 提示：
>
> 版本发布中所需要的自动归档等动作可通过配置Gitlab CI自动任务来完成

