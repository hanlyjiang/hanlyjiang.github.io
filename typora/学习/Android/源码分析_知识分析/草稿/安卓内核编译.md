# 安卓内核编译

## 前言

> 网络上的很多教程都已经过时了，那种直接从`https://android.googlesource.com/kernel/goldfish.git` 下载，然后使用AOSP源码目录使用`prebuilts/qemu-kernel/build-kernel.sh` 脚本，结合 `prebuilts/gcc` 来进行编译的现在已经无法使用。

参考如下文章：

* [[GUIDE\][Build|Mod|Update][kernel-ranchu][goldfish][5.4][5.10][GKI][ramdisk.img][modules][rootAVD][Android 11(R) 12(S)][AVD][Google Play Store API] | XDA Forums (xda-developers.com)](https://forum.xda-developers.com/t/guide-build-mod-update-kernel-ranchu-goldfish-5-4-5-10-gki-ramdisk-img-modules-rootavd-android-11-r-12-s-avd-google-play-store-api.4220697/)
* [构建内核  | Android 开源项目  | Android Open Source Project (google.cn)](https://source.android.google.cn/setup/build/building-kernels?hl=zh-cn#building)
* [内核  | Android 开源项目  | Android Open Source Project](https://source.android.google.cn/devices/architecture/kernel)
* [Android 通用内核  | Android 开源项目  | Android Open Source Project (google.cn)](https://source.android.google.cn/devices/architecture/kernel/android-common)
* [使用 KASAN+KCOV 构建 Pixel 内核  | Android 开源项目  | Android Open Source Project (google.cn)](https://source.android.google.cn/devices/tech/debug/kasan-kcov?hl=zh-cn)
* [Ubuntu中玩转Android模拟器](https://www.owalle.com/2020/05/11/android-emulator/)
* https://gist.github.com/yan12125/78a9004acb1bed5faf2ffd442163e2ef

### 内核相关信息

有一些信息



## 环境准备与内核编译

现在内核的仓库统一到了一个repo仓库（`https://android.googlesource.com/kernel/manifest`）中，直接获取repo仓库，然后repo sync即可获取所有内核代码，然后通过分支切换对应的内核版本。

### 安装依赖文件

```shell
# 安装内核构建的必要依赖文件
sudo apt-get install -y build-essential libssl-dev kernel-package libncurses5-dev bzip2 \
lib32z1 bison flex libelf-dev qt5-default qttools5-dev-tools qttools5-dev meld geany \
gtk+-2.0 libgtk-3-dev libwebkit2gtk-4.0-dev autogen libgtk2.0-dev libglade2-dev

# 获取repo
# get repo from google
wget https://storage.googleapis.com/git-repo-downloads/repo -O /usr/bin/repo
# get repo from mirror 
wget https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -O /usr/bin/repo
chmod a+x /usr/bin/repo
```

### 获取内核源码

```shell
BRANCH=common-android11-5.4
ROOTDIR=android-kernel
mkdir $ROOTDIR && cd $ROOTDIR
# init repo from google
repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b $BRANCH
# init repo from mirror
repo init --depth=1 -u https://mirrors.tuna.tsinghua.edu.cn/kernel/manifest -b $BRANCH
repo sync --force-sync --no-clone-bundle --no-tags -j$(nproc)
```



### 编译内核

```shell
cd $BRANCH

# 构建前先删除可能的DS_Store 文件
find . -type f -name ".DS_Store" -delete -print;

# 首次构建
BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
build/build.sh -j$(nproc)

# 后续构建
BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
SKIP_MRPROPER=1 \
build/build.sh -j$(nproc)
```



## 启动内核

### 直接替换AVD

可以直接基于现有的AVD来进行内核替换，具体操作步骤如下：

```shell

```

### AOSP 源码编译

在获取了AOSP源码之后，可以自行将内核编译到系统镜像中，使用模拟器启动。

AOSP源码树中放置了prebuild的模拟器内核，其路径及下属文件如下：

```shell
prebuilts/qemu-kernel/x86_64/5.4
- kernel-qemu2 
- ko
```

其中`kernel-qemu2`为内核，而`ko`则为内核模块，我们通过file命令可以获取内核版本信息：

```shell
$ file kernel-qemu2
kernel-qemu2: Linux kernel x86 boot executable bzImage, version 5.4.147-android11-2-00002-g937e6e41cc5d (build-user@build-host) #1 SMP PREEMPT Thu Nov 4 19:18:42 UTC 2021, RO-rootFS, swap_dev 0xF, Normal VGA

$ file ko/nd_virtio.ko
ko/nd_virtio.ko: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), BuildID[xxHash]=54e4430a79c1f3b4, with debug_info, not stripped
```

在进行内核替换编译时，我们通过如下两种方式进行尝试。

#### 方法一：扩展 `TARGET_PREBUILT_KERNEL` 变量

```shell
# 使用新的内核
export TARGET_PREBUILT_KERNEL=/Volumes/HIKVISION/android-kernel/out/android11-5.4/dist/bzImage
make bootimage # 测试可以替换内核，但是无法运行
make # 测试中...

# 恢复原始内核
export TARGET_PREBUILT_KERNEL=/Volumes/HIKVISION/android11/prebuilts/qemu-kernel/x86_64/5.4/kernel-qemu2
make bootimage # 测试可以替换内核，但是无法运行



```

编译结果：

```shell
[ 78% 82/104] depmod out/target/product/generic_x86_64/obj/PACKAGING/depmod_VEND
depmod: WARNING: could not open modules.order at /mnt/aosp/aosp-11/out/target/pr
oduct/generic_x86_64/obj/PACKAGING/depmod_VENDOR_RAMDISK_intermediates/lib/modul
es/0.0: No such file or directory
depmod: WARNING: could not open modules.builtin at /mnt/aosp/aosp-11/out/target/
product/generic_x86_64/obj/PACKAGING/depmod_VENDOR_RAMDISK_intermediates/lib/mod
ules/0.0: No such file or directory
[ 91% 95/104] build out/target/product/generic_x86_64/installed-files-vendor-ram
Installed file list: out/target/product/generic_x86_64/installed-files-vendor-ra
mdisk-debug.txt
[ 98% 102/104] Target super fs image for debug: out/target/product/generic_x86_6
2021-11-10 10:38:37 - build_super_image.py - INFO    : Building super image from
 info dict...
2021-11-10 10:38:37 - common.py - INFO    :   Running: "lpmake --metadata-size 6
5536 --super-name super --metadata-slots 2 --device super:3229614080 --group emu
lator_dynamic_partitions:3221225472 --partition system:readonly:1690095616:emula
tor_dynamic_partitions --image system=out/target/product/generic_x86_64/system.i
mg --partition vendor:readonly:65527808:emulator_dynamic_partitions --image vend
or=out/target/product/generic_x86_64/vendor.img --output out/target/product/gene
ric_x86_64/super.img"
2021-11-10 10:38:44 - common.py - INFO    : lpmake I 11-10 10:38:37   605   605 
builder.cpp:1031] [liblp]Partition system will resize from 0 bytes to 1690095616
 bytes
lpmake I 11-10 10:38:37   605   605 builder.cpp:1031] [liblp]Partition vendor wi
ll resize from 0 bytes to 65527808 bytes
Invalid sparse file format at header magic
Invalid sparse file format at header magic
2021-11-10 10:38:44 - build_super_image.py - INFO    : Done writing image out/ta
rget/product/generic_x86_64/super.img
[100% 104/104] Create system-qemu.img now
removing out/target/product/generic_x86_64/system-qemu.img.qcow2
updating out/target/product/generic_x86_64/system-qemu.img ...
done

```



> 关于 `TARGET_PREBUILT_KERNEL` 在 https://gist.github.com/yan12125/78a9004acb1bed5faf2ffd442163e2ef#gistcomment-2269389 和官方文档中都有说明

#### 方法二： 直接替换源码树中预置的内核文件

==测试没有用，跑出来的镜像还是无法启动==



```shell

@harishvk27: With the AOSP if you did not specify a TARGET_PREBUILT_KERNEL the common kernel is used by default.
You can export TARGET_PREBUILT_KERNEL=/your/default/goldfish/arch/$ARCH/boot/zImage

In BoardConfig.mk
Remove TARGET_NO_KERNEL if set
In your device Makefile, have something like
ifeq ($(TARGET_PREBUILT_KERNEL),)
LOCAL_KERNEL:= device/ti/panda/kernel
else
LOCAL_KERNEL:=$(TARGET_PREBUILT_KERNEL)
endif
PRODUCT_COPY_FILES := $(LOCAL_KERNEL):kernel
If that doesn't work you can replace the x86_64_defconfig config in the kernel folder ($AOSP/kernel/) with your own config and recompile the Kernel, you need also to remove the common Kernel that is used by default.

Best regards,
```

#### 运行到模拟器

有两种方式：

1. 使用 Android Goldfish 模拟器
2. 使用 CuttleFish 虚拟设备

关于两者的区别，可以参考：

> * [使用 Android 模拟器虚拟设备  | Android 开源项目  | Android Open Source Project (google.cn)](https://source.android.google.cn/setup/create/avd?hl=zh-cn#android_emulator_architecture)
> * [Cuttlefish 虚拟 Android 设备  | Android 开源项目  | Android Open Source Project (google.cn)](https://source.android.google.cn/setup/create/cuttlefish?hl=zh-cn)





## 周边梳理

### 安卓源码构建命令

通过`. build/envsetup.sh`之后即可扩展一些辅助命令，通过 `hmm` 可以查看这些命令的使用帮助：

```shell
Run "m help" for help with the build system itself.

Invoke ". build/envsetup.sh" from your shell to add the following functions to your environment:
- lunch:      lunch <product_name>-<build_variant>
              Selects <product_name> as the product to build, and <build_variant> as the variant to
              build, and stores those selections in the environment to be read by subsequent
              invocations of 'm' etc.
- tapas:      tapas [<App1> <App2> ...] [arm|x86|mips|arm64|x86_64|mips64] [eng|userdebug|user]
- croot:      Changes directory to the top of the tree, or a subdirectory thereof.
- m:          Makes from the top of the tree.
- mm:         Builds and installs all of the modules in the current directory, and their
              dependencies.
- mmm:        Builds and installs all of the modules in the supplied directories, and their
              dependencies.
              To limit the modules being built use the syntax: mmm dir/:target1,target2.
- mma:        Same as 'mm'
- mmma:       Same as 'mmm'
- provision:  Flash device with all required partitions. Options will be passed on to fastboot.
- cgrep:      Greps on all local C/C++ files.
- ggrep:      Greps on all local Gradle files.
- gogrep:     Greps on all local Go files.
- jgrep:      Greps on all local Java files.
- resgrep:    Greps on all local res/*.xml files.
- mangrep:    Greps on all local AndroidManifest.xml files.
- mgrep:      Greps on all local Makefiles and *.bp files.
- owngrep:    Greps on all local OWNERS files.
- sepgrep:    Greps on all local sepolicy files.
- sgrep:      Greps on all local source files.
- godir:      Go to the directory containing a file.
- allmod:     List all modules.
- gomod:      Go to the directory containing a module.
- pathmod:    Get the directory containing a module.
- refreshmod: Refresh list of modules for allmod/gomod.
```



### emulator 使用

```shell
emulator -avd (avd_name) -kernel /path/to/goldfish/arch/x86/boot/bzImage -show-kernel
```



### repo仓库编辑

#### 替换仓库地址为官方或者清华镜像源：

**macOS:**

```shell
find . -type f -name config |xargs -I {}  sed -i "" "s/android.googlesource.com/aosp.tuna.tsinghua.edu.cn/g" {};

find . -type f -name config |xargs -I {}  sed -i "" "s/aosp.tuna.tsinghua.edu.cn/android.googlesource.com/g" {};
```

**Ubuntu:**

```shell
find . -type f -name config |xargs -I {}  sed -i "s/android.googlesource.com/aosp.tuna.tsinghua.edu.cn/g" {};

find . -type f -name config |xargs -I {}  sed -i "s/aosp.tuna.tsinghua.edu.cn/android.googlesource.com/g" {};
```

### CuttleFish 安装

> 了解更多：
>
> * [Google官方文档链接](https://android.googlesource.com/device/google/cuttlefish/)
> * [Building and using Cuttlefish :: Nathan Chancellor](https://nathanchance.dev/posts/building-using-cuttlefish/)
>
> 
>
> https://android.googlesource.com/device/google/cuttlefish/+/e097bfd8e70bb9a2ca26a130c4ad10e14fc52931/required_images
>
> boot.img
>
> bootloader
>
> super.img
>
> userdata.img
>
> vbmeta.img
>
> vbmeta_system.img
>
> vendor_boot.img



* 确认主机是否支持KVM

```shell
$  grep -c -w "vmx\|svm" /proc/cpuinfo
12
```

* 下载安装并构建

  ```shell
  sudo apt install -y git devscripts config-package-dev debhelper-compat
  git clone https://github.com/google/android-cuttlefish
  cd android-cuttlefish
  debuild -i -us -uc -b
  sudo dpkg -i ../cuttlefish-common_*_*64.deb || sudo apt-get install -f
  sudo usermod -aG kvm,cvdnetwork $USER
  sudo reboot
  ```

  

* 打开 [ci.android.com](https://ci.android.com/builds/branches/aosp-master/grid?) 下载镜像

  * 去http://ci.android.com/
  * 输入分支名称。首先，如果你不知道你在找什么`aosp-master`
  * 导航并单击以获得最新构建`aosp_cf_x86_64_phone``userdebug`
  * 单击`Artifacts`
  * 向下滚动到 OTA 镜像。下载此文件`aosp_cf_x86_64_phone-img-xxxxxx.zip``img`
  * 向下滚动到 cvd-host_package.tar.gz

* 解压

  * ```
    mkdir cf
    cd cf
    tar xvf /path/to/cvd-host_package.tar.gz
    unzip /path/to/aosp_cf_x86_64_phone-img-xxxxxx.zip
    ```

* 启动 

  ```shell
  HOME=$PWD ./bin/launch_cvd
  ```

* 停止

  ```shell
  HOME=$PWD ./bin/stop_cvd
  ```

* ​	启动查看器 （WebRTC）

  当使用`---start_webrtc` (默认值)启动时，可以在`https://localhost:8443`看到所有可用的设备列表在。有关更多信息，请参阅cuttlefish[文档](https://source.android.com/setup/create/cuttlefish-ref-webrtc)中的 WebRTC。





## 错误处理

```shell
rm: include: Directory not empty
make[2]: *** [/mnt/hgfs/android-kernel/common/kernel/Makefile:144: kernel/kheaders_data.tar.xz] Error 1
make[2]: *** Deleting file 'kernel/kheaders_data.tar.xz'
make[1]: *** [/mnt/hgfs/android-kernel/common/Makefile:1816: kernel] Error 2
make[1]: *** Waiting for unfinished jobs....
```



## 其他

### 网络上的构建方式

```shell
############################################|########################
#####                           Android 11 (R) Kernel 5.4                             #####
#####                        BRANCH=common-android11-5.4-lts                          


#############################################|#############################################
###             Download Sources, Toolchain, Buildtools etc. (approx. 22GB)             ###
#############################################|#############################################

BRANCH=common-android11-5.4
ROOTDIR=android-kernel
mkdir $ROOTDIR && cd $ROOTDIR
# init repo from google
repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b $BRANCH
# init repo from mirror
repo init --depth=1 -u https://mirrors.tuna.tsinghua.edu.cn/kernel/manifest -b $BRANCH
repo sync --force-sync --no-clone-bundle --no-tags -j$(nproc)

#############################################|#############################################
###                       Preparing and modding the build.config                        ###
###                      add these lines to the BUILD_CONFIG file                       ###
###             common-modules/virtual-device/build.config.goldfish.x86_64              ###
#############################################|#############################################

BUILD_INITRAMFS=1
LZ4_RAMDISK=1
SKIP_CP_KERNEL_HDR=1

#############################################|#############################################
###                 Make changes and enable features via the Menuconfig                 ###
###                     changes will be saved into the gki_defconfig                    ###
###                   i.e. USB 3.0 or UHCI HCD for USB-Serial Adapters                  ###
###     Device Drivers -> USB support -> <*> xHCI HCD (USB 3.0) support                 ###
###                                      -*- Generic xHCI driver for a platform device  ###
###                                      <*> UHCI HCD (most Intel and VIA) support      ###
#############################################|#############################################




BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
FRAGMENT_CONFIG=common/arch/x86/configs/gki_defconfig \
build/config.sh

#############################################|#############################################
###                                       1st run                                       ###
###                          Building the Modules and Kernel                            ###
#############################################|#############################################

BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
build/build.sh -j$(nproc)

Files copied to $ROOTDIR/out/android11-5.4/dist

#############################################|#############################################
###               Copy bzImage & initramfs.img into the rootAVD directory               ###
###                                   and run rootAVD                                   ###
#############################################|#############################################

cp out/android11-5.4/dist/initramfs.img ~/rootAVD/
cp out/android11-5.4/dist/bzImage ~/rootAVD/
./rootAVD.sh ~/path-to-avd-system-images/android-30/ramdisk.img InstallKernelModules

[!] Installing new Kernel Modules
[*] Copy initramfs.img /data/data/com.android.shell/Magisk/tmp/initramfs
[-] Extracting Modules from initramfs.img
Detected format: [lz4_legacy]
Decompressing to [initramfs.cpio]
[*] Removing Stock Modules from ramdisk.img
[!] 5.4.61-android11-2-00064-g4271ad6e8ade-ab6991359
[!] Android (6443078 based on r383902)
[-] Installing new Modules into ramdisk.img
[!] 5.4.113-android11-2-g926c4200b8fc-dirty
[!] Android (7211189, based on r416183)
[*] Adjusting modules.load and modules.dep
[*] Repacking ramdisk ..

#############################################|#############################################
###                                   (1+n)th Build run                                 ###
###                        Building only changes, not everything                        ###
#############################################|#############################################

BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
SKIP_MRPROPER=1 \
build/build.sh -j$(nproc)

#############################################|#############################################
###              Copy bzImage as kernel-ranchu into the AVDs directory                  ###
###            Once the modules are installed, just the kernel is needed                ###
#############################################|#############################################

cp out/android11-5.4/dist/bzImage ~/path-to-avd-system-images/android-30/kernel-ranchu
```