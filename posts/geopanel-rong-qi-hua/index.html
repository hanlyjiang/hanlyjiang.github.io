<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GeoPanel容器化 | 清水池塘</title><meta name=keywords content><meta name=description content="GeoPanel容器化概览
此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。
主要包括如下部分：
graph 

GeoPanel[GeoPanel容器化]
GeoPanel --> pgspider打包
GeoPanel --> hasura-块数据API引擎
GeoPanel --> 公司自研镜像打包
GeoPanel --> 服务编排

由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出；
公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说；
服务编排中描述当前已经容器化的服务及使用swarm编排的情况；

GeoPanel容器化-ARM镜像构建-通用步骤
这里的国产化主要指：制作arm版本的镜像
前言
移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；

ARM 版本Docker安装；
构建所有镜像的ARM版本；

测试机信息

  
      
          CPU
          FT-1500A 4核 arm64
      
  
  
      
          内存
          8G
      
      
          OS
          麒麟V10
      
      
          包管理器
          apt
      
  

ARM机器上安装Docker

Docker官方文档

Docker支持如下系统及架构

国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。
查看系统信息
geostar@geostar-ft1500a:~$ cat /proc/version
Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源"><meta name=author content="野生莲藕"><link rel=canonical href=https://hanlyjiang.github.io/posts/geopanel-rong-qi-hua/><link crossorigin=anonymous href=/assets/css/stylesheet.e3ad983e2ed74d47928d2fcfb404b2d2a87f0ad3e1c106708add8cededbe9a25.css integrity="sha256-462YPi7XTUeSjS/PtASy0qh/CtPhwQZwit2M7e2+miU=" rel="preload stylesheet" as=style><link rel=icon href=https://hanlyjiang.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hanlyjiang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanlyjiang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hanlyjiang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hanlyjiang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hanlyjiang.github.io/posts/geopanel-rong-qi-hua/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://hanlyjiang.github.io/posts/geopanel-rong-qi-hua/"><meta property="og:site_name" content="清水池塘"><meta property="og:title" content="GeoPanel容器化"><meta property="og:description" content="GeoPanel容器化概览 此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。
主要包括如下部分：
graph GeoPanel[GeoPanel容器化] GeoPanel --> pgspider打包 GeoPanel --> hasura-块数据API引擎 GeoPanel --> 公司自研镜像打包 GeoPanel --> 服务编排 由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出； 公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说； 服务编排中描述当前已经容器化的服务及使用swarm编排的情况； GeoPanel容器化-ARM镜像构建-通用步骤 这里的国产化主要指：制作arm版本的镜像
前言 移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；
ARM 版本Docker安装； 构建所有镜像的ARM版本； 测试机信息 CPU FT-1500A 4核 arm64 内存 8G OS 麒麟V10 包管理器 apt ARM机器上安装Docker Docker官方文档
Docker支持如下系统及架构
国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。
查看系统信息 geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-08T15:10:06+00:00"><meta property="article:modified_time" content="2021-04-08T15:10:06+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="GeoPanel容器化"><meta name=twitter:description content="GeoPanel容器化概览
此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。
主要包括如下部分：
graph 

GeoPanel[GeoPanel容器化]
GeoPanel --> pgspider打包
GeoPanel --> hasura-块数据API引擎
GeoPanel --> 公司自研镜像打包
GeoPanel --> 服务编排

由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出；
公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说；
服务编排中描述当前已经容器化的服务及使用swarm编排的情况；

GeoPanel容器化-ARM镜像构建-通用步骤
这里的国产化主要指：制作arm版本的镜像
前言
移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；

ARM 版本Docker安装；
构建所有镜像的ARM版本；

测试机信息

  
      
          CPU
          FT-1500A 4核 arm64
      
  
  
      
          内存
          8G
      
      
          OS
          麒麟V10
      
      
          包管理器
          apt
      
  

ARM机器上安装Docker

Docker官方文档

Docker支持如下系统及架构

国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。
查看系统信息
geostar@geostar-ft1500a:~$ cat /proc/version
Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hanlyjiang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"GeoPanel容器化","item":"https://hanlyjiang.github.io/posts/geopanel-rong-qi-hua/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GeoPanel容器化","name":"GeoPanel容器化","description":"GeoPanel容器化概览 此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。\n主要包括如下部分：\ngraph GeoPanel[GeoPanel容器化] GeoPanel --\u0026gt; pgspider打包 GeoPanel --\u0026gt; hasura-块数据API引擎 GeoPanel --\u0026gt; 公司自研镜像打包 GeoPanel --\u0026gt; 服务编排 由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出； 公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说； 服务编排中描述当前已经容器化的服务及使用swarm编排的情况； GeoPanel容器化-ARM镜像构建-通用步骤 这里的国产化主要指：制作arm版本的镜像\n前言 移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；\nARM 版本Docker安装； 构建所有镜像的ARM版本； 测试机信息 CPU FT-1500A 4核 arm64 内存 8G OS 麒麟V10 包管理器 apt ARM机器上安装Docker Docker官方文档\nDocker支持如下系统及架构\n国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。\n查看系统信息 geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源\n","keywords":[],"articleBody":"GeoPanel容器化概览 此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。\n主要包括如下部分：\ngraph GeoPanel[GeoPanel容器化] GeoPanel --\u003e pgspider打包 GeoPanel --\u003e hasura-块数据API引擎 GeoPanel --\u003e 公司自研镜像打包 GeoPanel --\u003e 服务编排 由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出； 公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说； 服务编排中描述当前已经容器化的服务及使用swarm编排的情况； GeoPanel容器化-ARM镜像构建-通用步骤 这里的国产化主要指：制作arm版本的镜像\n前言 移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；\nARM 版本Docker安装； 构建所有镜像的ARM版本； 测试机信息 CPU FT-1500A 4核 arm64 内存 8G OS 麒麟V10 包管理器 apt ARM机器上安装Docker Docker官方文档\nDocker支持如下系统及架构\n国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。\n查看系统信息 geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源\n添加软件源 参考： https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/\n添加清华镜像软件源（arm架构）\n# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释 deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse 更新：\nsudo apt-get install apt-transport-https sudo apt-get clean sudo apt-get update 安装Docker # 卸载旧版本docker sudo apt-get remove docker docker-engine docker.io containerd runc sudo apt-get update sudo apt-get install \\ apt-transport-https \\ ca-certificates \\ curl \\ gnupg-agent \\ software-properties-common curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88) sudo apt-key fingerprint 0EBFCD88 编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存\n# https://docs.docker.com/engine/install/ubuntu/ deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable 安装 docker\nsudo apt-get update # 安装Docker sudo apt-get install docker-ce docker-ce-cli containerd.io # 安装成功，查看版本 docker --version Docker version 19.03.12, build 48a6621 在Dockerhub上查找已有的arm镜像 实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以postgres为例，在dockerhub上可以看到\n在具体的tag中也可以看到版本的镜像是否支持arm架构\n但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。\nARM版本镜像构建（非ARM机器上执行） 参考： -https://github.com/docker/cli/blob/master/experimental/README.md -跨平台构建 Docker 镜像新姿势，x86、arm 一把梭\n构建ARM镜像的两种方式 对于构建镜像的ARM版本，有如下两种方式：\n在ARM机器上使用 docker build 进行构建； 在X86/AMD64 的机器上使用 docker buildx 进行交叉构建； 实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；\n关于第二种构建方式，可先阅读跨平台构建 Docker 镜像新姿势，x86、arm 一把梭进行了解，以下简要介绍使用buildx交叉构建的方式；\n⚠️注意：\n交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；\n实际测试发现，使用qemu方式在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；\n上面第二点按如下方式测试：\ndocker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch 可正常输出； docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version 则会卡住，且需要使用docker stop停止容器才可以退出容器； 启用试验性功能 参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features 注意：buildx 仅支持 docker19.03 及以上docker版本\n如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：\n编辑 /etc/docker/daemon.json 添加： { \"experimental\": true } 编辑 ～/.docker/config.json 添加： \"experimental\" : \"enabled\" 重启Docker使生效： sudo systemctl daemon-reload sudo systemctl restart docker 确认是否开启： docker version -f’{{.Server.Experimental}}' 如果输出true，则表示开启成功 使用buildx构建 buildx 的详细使用可参考：Docker官方文档-Reference-buildx 创建 buildx 构建器 使用 docker buildx ls 命令查看现有的构建器\ndocker buildx ls 创建并构建器：\n# 下面的创建命令任选一条符合情况的即可 # 1. 不指定任何参数创建 docker buildx create --use --name multiarch-builder # 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令 docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder # 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder buildx-config.toml 配置文件写法类似：\n# https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md # registry configures a new Docker register used for cache import or output. [registry.\"zh-registry.geostar.com.cn\"] mirrors = [\"zh-registry.geostar.com.cn\"] http = true insecure = true 启用构建器\n# 初始化并激活 docker buildx inspect multiarch-builder --bootstrap 确认成功\n# 使用 docker buildx ls 查看 docker buildx ls 修改Dockerfile 对 Dockerfile 的修改，大致需要进行如下操作：\n确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译； 确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件 ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz\n此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：\nADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz\n当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；\n提示：\n怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 file {可执行文件路径} 来查看，\n如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-x86_64\u0026arm64e：\nfile $(which git) /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e] /usr/bin/git (for architecture x86_64):\tMach-O 64-bit executable x86_64 /usr/bin/git (for architecture arm64e):\tMach-O 64-bit executable arm64e 下面的命令则对一个so文件执行了file，可以看到其中的架构信息 ARM aarch64：\nfile /lib/aarch64-linux-gnu/libpthread-2.23.so /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped docker buildx 构建arm64镜像的命令 使用 –platform来指定架构，使用 --push 或 --load 来指定构建完毕后的动作。\ndocker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push 提示：当指定多个架构时，只能使用 –push 推送到远程仓库，无法 –load，推送成功后再通过 docker pull –platform 来拉取指定架构的镜像\n检查构建成果 通过 docker buildx imagetools inspect 命令查看镜像信息，看是否有对应的arm架构信息； 实际运行镜像，确认运行正常；（在arm机器上执行） 提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。\n在x86上运行arm镜像 可参考 github/qemu-user-static ,简要描述如下：\n执行如下命令安装：\ndocker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n之后即可运行arm版本的镜像，如：\ndocker run --rm -t arm64v8/fedora uname -m GeoPanel容器化-PGspider镜像构建 概览 postgreSQL是一个开源的对象-关系型数据库管理系统，本身提供了x86及arm版本的镜像，那么我们为什么要自己构建对应呢？\n因为我们需要使用pgspider，它是给予pg11.6的代码补丁包，所以我们无法直接复用官方的镜像作为基础镜像；\n同时，我们还添加了许多pg的插件用于扩展pg的能力，如此，我们必须自行打包pg镜像；\n镜像需要包括的组件： 组件 说明 postgis11.6 postgreSQL pgspider postgreSQL源码补丁，增强FDW功能 postgis2.5.3及其依赖 postgres gis 插件，用于提供geometry相关支持 postgres_fdw postgres_fdw 接入外部postgres数据源 sqlite_fdw sqlite_fdw 接入外部sqlite数据源 mysql_fdw mysql_fdw 接入外部mysql数据源 oracle_fdw oracle_fdw 接入外部oracle数据源 zdb(es_fdw) es_fdw 接入外部es数据源 debezium 数据库事件转为事件流，配合kafka使用，实现数据实时同步 wal2json pg 日志格式转换插件，配合debezium使用，以json格式推送事件流 整体构建流程 为了构建此镜像，我们制作了若干辅助镜像，包括：\ngraph builder pgspider-base postgis-pgspider 其中:\nbuilder 镜像为我们的构建器镜像，用做pgspider的编译环境，其中包含pg11.6源码及pgspider源码，及编译好的pg及pgspider，但是我们并未对成果物进行提取，因为此进行要保留所有构建环境，用于后续其他我们附加到pg的插件的构建； pgspider-base 镜像中安装postgres运行所需要的若干依赖，作为最终镜像构建的基础，避免每次构建镜像都需要执行重复的依赖安装操作； postgis-pgspider 为我们的最终镜像；基于pgspider-base镜像制作，并合并我们使用 builder 镜像构建的所有需要的成果文件； 接下来我们详细说明以上几个镜像分别如何构建。\n现在成果仓库 Gitlab仓库地址：geopanel-deploy\n提示： 可查看仓库目录中的README.md 了解更多信息；\n目录结构如下：\npgspider ├── Dockerfile-base.dockerfile - 构建pgspider-base镜像的脚本 ├── Dockerfile-builder.dockerfile - 构建pgspider-builder镜像的脚本 ├── Dockerfile-source-arm-add.dockerfile - 构建postgis-pgspider镜像的脚本（用于增量构建） ├── Dockerfile-source-arm.dockerfile - 构建postgis-pgspider镜像的脚本 ├── Dockerfile-source.dockerfile - 构建postgis-pgspider镜像的脚本 ├── README.md ├── binary - 我方有修改的预编译的fdw（x86架构） │ ├── mysql_fdw │ │ ├── mysql_fdw--1.1.sql │ │ ├── mysql_fdw.control │ │ └── mysql_fdw.so │ ├── oracle │ │ └── oracle_fdw.so │ └── zdblibs │ ├── zombodb--1.0.0a1--1.0.0a2.sql │ ├── zombodb--1.0.0a2--1.0.0a3.sql │ ├── zombodb--1.0.0a3--1.0.0a4.sql │ ├── zombodb--1.0.0a4--1.0.0a5.sql │ ├── zombodb--1.0.0a5--1.0.0a6.sql │ ├── zombodb--1.0.0a6--1.0.0a7.sql │ ├── zombodb--1.0.0a7--1.0.0a8.sql │ ├── zombodb--1.0.0a8--1.0.0a9.sql │ ├── zombodb--1.0.0a9--10-1.0.0a9.sql │ ├── zombodb--10-1.0.0--10-1.0.1.sql │ ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql │ ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql │ ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql │ ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql │ ├── zombodb--10-1.0.0b12--10-1.0.0.sql │ ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql │ ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql │ ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql │ ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql │ ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql │ ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql │ ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql │ ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql │ ├── zombodb--10-1.0.1--10-1.0.2.sql │ ├── zombodb--10-1.0.2--10-1.0.3.sql │ ├── zombodb--10-1.0.3--10-1.0.4.sql │ ├── zombodb--10-1.0.4--10-1.0.5.sql │ ├── zombodb--10-1.0.5--4.0.sql │ ├── zombodb--4.0.sql │ ├── zombodb.control │ └── zombodb.so ├── binary-arm 我方有修改的预编译的fdw（arm架构） │ ├── mysql_fdw │ │ ├── mysql_fdw--1.1.sql │ │ ├── mysql_fdw.control │ │ └── mysql_fdw.so │ └── zdblibs │ ├── zombodb--1.0.0a1--1.0.0a2.sql │ ├── zombodb--1.0.0a2--1.0.0a3.sql │ ├── zombodb--1.0.0a3--1.0.0a4.sql │ ├── zombodb--1.0.0a4--1.0.0a5.sql │ ├── zombodb--1.0.0a5--1.0.0a6.sql │ ├── zombodb--1.0.0a6--1.0.0a7.sql │ ├── zombodb--1.0.0a7--1.0.0a8.sql │ ├── zombodb--1.0.0a8--1.0.0a9.sql │ ├── zombodb--1.0.0a9--10-1.0.0a9.sql │ ├── zombodb--10-1.0.0--10-1.0.1.sql │ ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql │ ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql │ ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql │ ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql │ ├── zombodb--10-1.0.0b12--10-1.0.0.sql │ ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql │ ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql │ ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql │ ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql │ ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql │ ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql │ ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql │ ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql │ ├── zombodb--10-1.0.1--10-1.0.2.sql │ ├── zombodb--10-1.0.2--10-1.0.3.sql │ ├── zombodb--10-1.0.3--10-1.0.4.sql │ ├── zombodb--10-1.0.4--10-1.0.5.sql │ ├── zombodb--10-1.0.5--4.0.sql │ ├── zombodb--4.0.sql │ ├── zombodb.control │ └── zombodb.so ├── config - 数据库配置文件 │ ├── pg_hba.conf │ ├── pg_hba.conf.raw │ └── postgresql.conf ├── debezium - debezium插件的源码及wal2json的源码 │ ├── README.md │ ├── init-debezium.sh │ ├── postgres-decoderbufs.tar.gz │ ├── test.sql │ └── wal2json-wal2json_1_0.tar.gz ├── docker-entrypoint.sh - 入口启动脚本 ├── draft - 临时文件，可忽略 │ ├── Dockerfile │ ├── Dockerfile-all-in-one.dockerfile │ ├── Dockerfile-apt.dockerfile │ ├── Dockerfile-postGIS.dockerfile │ └── README.md ├── initdb-fdw.sh - 初始化fdws脚本 ├── oracle │ ├── instantclient-basic-linux.x64-12.2.0.1.0.zip │ ├── instantclient-sdk-linux.x64-12.2.0.1.0.zip │ ├── instantclient-sqlplus-linux.x64-12.2.0.1.0.zip │ └── oracle_fdw-ORACLE_FDW_2_2_0.tar.gz ├── postgis - postgis及其依赖库源码及初始化脚本 │ ├── CGAL-4.11.2.tar.xz │ ├── SFCGAL-1.3.5.tar.gz │ ├── boost_1_67_0.tar.gz │ ├── gdal-3.0.2.tar.gz │ ├── geos-3.8.0.tar.bz2 │ ├── initdb-postgis.sh │ ├── libspatialite-4.3.0a.tar.gz │ ├── mpfr-4.0.2.tar.gz │ ├── postgis-2.5.2.tar.gz │ ├── postgis-2.5.3.tar.gz │ ├── proj-6.2.0.tar.gz │ └── update-postgis.sh └── test.sql - 测试是否正常工作的sql文件 builder镜像构建 builder镜像的打包脚本为 Dockerfile-builder.dockerfile，我们使用相同的脚本构建arm及x86版本的镜像；\n打包命令 TAG=$(date +%Y%m%d) # X86 镜像构建 docker build -t pgspider-builder:$TAG -f Dockerfile-builder.dockerfile ./ ## arm docker buildx build \\ --progress plain \\ --platform=linux/arm64 \\ -t pgspider-builder-arm:latest \\ -f Dockerfile-builder.dockerfile ./ --load 脚本详解 文件地址： Dockerfile-builder.dockerfile\n脚本内容如下，请查看脚本中的注释：\n这里需要注意的是，我们编译后的成果其实位于 /usr/local/pgspider 目录中，这个后面会用到；\n# # pgspider 源码构建镜像，包含pgspider源码及中间临时成果，用于后续构建其他fdw及提取pgspider可运行镜像 # ## 使用 debian:stretch-slim 作为基础 FROM debian:stretch-slim RUN apt-get update \u0026\u0026 apt-get install -y build-essential git libossp-uuid-dev wget libreadline-dev zlib1g-dev ## 设置工作目录为app WORKDIR /app ## # 来源 https://github.com/docker-library/postgres/blob/master/11/Dockerfile ## 配置locales为en_US.utf8 RUN set -eux; \\ if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \\ # if this file exists, we're likely in \"debian:xxx-slim\", and locales are thus being excluded so we need to remove that exclusion (since we need locales) grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\ sed -ri '/\\/usr\\/share\\/locale/d' /etc/dpkg/dpkg.cfg.d/docker; \\ ! grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\ fi; \\ apt-get update; apt-get install -y locales; rm -rf /var/lib/apt/lists/*; \\ localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8 ENV LANG en_US.utf8 ## 安装所需依赖 RUN set -eux; \\ apt-get update; \\ # install \"nss_wrapper\" in case we need to fake \"/etc/passwd\" and \"/etc/group\" (especially for OpenShift) # https://github.com/docker-library/postgres/issues/359 # https://cwrap.org/nss_wrapper.html apt-get install -y --no-install-recommends libnss-wrapper; \\ rm -rf /var/lib/apt/lists/* ## 获取pg11.6源码 RUN wget https://ftp.postgresql.org/pub/source/v11.6/postgresql-11.6.tar.gz ## 获取pgspider的补丁包 RUN wget https://raw.githubusercontent.com/pgspider/pgspider/master/pgspider.patch ## 解压pg RUN tar xvf postgresql-11.6.tar.gz ## 应用pgspider源码补丁包到pg源码 RUN patch -p1 -d postgresql-11.6 \u003c /app/pgspider.patch ## 开始执行编译，可参考pgspider github页面 RUN cd postgresql-11.6 \\ \u0026\u0026 ./configure --with-uuid=ossp \\ ## 编译PG并install \u0026\u0026 make \u0026\u0026 make install \\ ## 编译pgspider_core_fdw 并install \u0026\u0026 cd /app/postgresql-11.6/contrib/pgspider_core_fdw \\ \u0026\u0026 make \u0026\u0026 make install \\ ## 编译 pgspider_fdw 并install \u0026\u0026 cd /app/postgresql-11.6/contrib/pgspider_fdw \\ \u0026\u0026 make \u0026\u0026 make install \\ ## 编译postgres_fdw并install \u0026\u0026 cd /app/postgresql-11.6/contrib/postgres_fdw \\ \u0026\u0026 make \u0026\u0026 make install \\ ## 编译contrib并install \u0026\u0026 cd /app/postgresql-11.6/contrib \\ \u0026\u0026 make \u0026\u0026 make install ENV PATH $PATH:/usr/local/pgspider/bin base镜像构建 base 镜像的打包脚本为 Dockerfile-base.dockerfile，我们使用相同的脚本构建arm及x86版本的镜像；\n打包命令 TAG=$(date +%Y%m%d) # 打包x86版本 docker build -t pgspider-base:$TAG -f Dockerfile-base.dockerfile ./ ## arm docker buildx build \\ --progress plain \\ --platform=linux/arm64 \\ -t pgspider-base-arm:$TAG \\ -f Dockerfile-base.dockerfile ./ --load ## 也可使用一条命令构建两个版本的镜像，此时必须在镜像tag中包含可用的docker registry地址，并且使用 `--push` 参数在打包完成后推送镜像到registry ## 完成后再拉取到本地进行测试 docker buildx build \\ --progress plain \\ --platform=linux/arm64,linux/amd64 \\ -t hanlyjiang/pgspider-base-arm:$TAG \\ -f Dockerfile-base.dockerfile ./ --push 脚本详解 脚本在线地址： gitlab\n# # PGSpider 基础镜像 # 1. 安装需要的依赖，避免后续每次构建时都需要安装（依赖部分可能需要精简） # 2. 添加对应的postgres用户 FROM debian:stretch-slim ## 安装必要依赖 RUN set -ex; \\ if ! command -v gpg \u003e /dev/null; then \\ apt-get update; \\ apt-get install -y --no-install-recommends \\ gnupg \\ dirmngr \\ ; \\ rm -rf /var/lib/apt/lists/*; \\ fi ## 安装依赖，并创建pg需要的用户及组id，创建pg需要的目录并赋予对应的组和id改目录的权限 # explicitly set user/group IDs RUN set -eux; \\ groupadd -r postgres --gid=999; \\ # https://salsa.debian.org/postgresql/postgresql-common/blob/997d842ee744687d99a2b2d95c1083a2615c79e8/debian/postgresql-common.postinst#L32-35 useradd -r -g postgres --uid=999 --home-dir=/var/lib/postgresql --shell=/bin/bash postgres; \\ # also create the postgres user's home directory with appropriate permissions # see https://github.com/docker-library/postgres/issues/274 mkdir -p /var/lib/postgresql; \\ chown -R postgres:postgres /var/lib/postgresql ## 添加 gosu 用于后续方便使从root降权限 # grab gosu for easy step-down from root # https://github.com/tianon/gosu/releases ENV GOSU_VERSION 1.12 RUN set -eux; \\ savedAptMark=\"$(apt-mark showmanual)\"; \\ apt-get update; \\ apt-get install -y --no-install-recommends ca-certificates wget; \\ rm -rf /var/lib/apt/lists/*; \\ dpkgArch=\"$(dpkg --print-architecture | awk -F- '{ print $NF }')\"; \\ wget -O /usr/local/bin/gosu \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch\"; \\ wget -O /usr/local/bin/gosu.asc \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc\"; \\ export GNUPGHOME=\"$(mktemp -d)\"; \\ gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \\ gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \\ gpgconf --kill all; \\ rm -rf \"$GNUPGHOME\" /usr/local/bin/gosu.asc; \\ apt-mark auto '.*' \u003e /dev/null; \\ [ -z \"$savedAptMark\" ] || apt-mark manual $savedAptMark \u003e /dev/null; \\ apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \\ chmod +x /usr/local/bin/gosu; \\ gosu --version; \\ gosu nobody true ## 配置locale # make the \"en_US.UTF-8\" locale so postgres will be utf-8 enabled by default RUN set -eux; \\ if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \\ # if this file exists, we're likely in \"debian:xxx-slim\", and locales are thus being excluded so we need to remove that exclusion (since we need locales) grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\ sed -ri '/\\/usr\\/share\\/locale/d' /etc/dpkg/dpkg.cfg.d/docker; \\ ! grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\ fi; \\ apt-get update; apt-get install -y --no-install-recommends locales; rm -rf /var/lib/apt/lists/*; \\ localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8 ENV LANG en_US.utf8 ## 安装必要依赖库 RUN set -eux; \\ apt-get update; \\ apt-get install -y --no-install-recommends \\ # install \"nss_wrapper\" in case we need to fake \"/etc/passwd\" and \"/etc/group\" (especially for OpenShift) # https://github.com/docker-library/postgres/issues/359 # https://cwrap.org/nss_wrapper.html libnss-wrapper \\ # install \"xz-utils\" for .sql.xz docker-entrypoint-initdb.d files xz-utils \\ ; \\ rm -rf /var/lib/apt/lists/* ## 配置信任的gpg key RUN set -ex; \\ # pub 4096R/ACCC4CF8 2011-10-13 [expires: 2019-07-02] # Key fingerprint = B97B 0AFC AA1A 47F0 44F2 44A0 7FCC 7D46 ACCC 4CF8 # uid PostgreSQL Debian Repository key='B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8'; \\ export GNUPGHOME=\"$(mktemp -d)\"; \\ gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys \"$key\"; \\ gpg --batch --export \"$key\" \u003e /etc/apt/trusted.gpg.d/postgres.gpg; \\ command -v gpgconf \u003e /dev/null \u0026\u0026 gpgconf --kill all; \\ rm -rf \"$GNUPGHOME\"; \\ apt-key list ENV PG_MAJOR 11 ENV GOSU_VERSION 1.11 ## 添加postgresql软件源仓库 RUN set -ex; \\ \\ # see note below about \"*.pyc\" files export PYTHONDONTWRITEBYTECODE=1; \\ \\ dpkgArch=\"$(dpkg --print-architecture)\"; \\ case \"$dpkgArch\" in \\ amd64 | i386 | ppc64el) \\ # arches officialy built by upstream echo \"deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR\" \u003e /etc/apt/sources.list.d/pgdg.list; \\ echo \"apt-get update;\"; \\ ;; \\ *) \\ # we're on an architecture upstream doesn't officially build for # let's build binaries from their echo \"deb-src http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR\" \u003e /etc/apt/sources.list.d/pgdg.list; \\ ;; \\ esac; # 添加必要的工具及依赖 RUN apt-get update \u0026\u0026 apt-get install -y --no-install-recommends unzip wget \\ libreadline-dev \\ libmongoc-1.0-0 \\ libmysql++-dev \\ libsqlite3-dev libspatialite7 \\ libsybdb5 \\ libhiredis-dev \\ freetds-dev freetds-common libcurl4-nss-dev unixodbc-dev \\ # libaio-dev - oracle_fdw libaio-dev \\ \u0026\u0026 rm -rf /var/lib/apt/lists/*; pgspider镜像构建 对x86及arm架构，我们分别编写了对应的脚本，其中x86使用 Dockerfile-source.dockerfile 脚本构建，arm使用Dockerfile-source-arm.dockerfile脚本构建；\n构建命令 TAG=$(date +%Y%m%d) docker build -t pgspider-postgis:$TAG -f Dockerfile-source.dockerfile ./ ## arm docker buildx build \\ --progress plain \\ --build-arg --platform=linux/arm64 \\ -t pgspider-postgis:arm-$TAG \\ -f Dockerfile-source-arm.dockerfile ./ --load 脚本详解 pgspider 镜像构建的步骤较多，我们采取分步骤构建的方式使用中间构建过程来减小最终镜像的层数及大小；\n另外两个平台的构建脚本大体一致，仅有少数过程有差异，我们先使用x86版本的对整体过程进行说明，后面我们会说明两个平台之间的差异；\nx86 构建脚本 提示：脚本中有多个FROM段，此为Docker多阶段构建可以通过此文章进行了解；\n主要过程如下：\n第一阶段：\n从builder镜像开始，由于builder镜像中已经包含pg源码还有已经编好的pg及pgspider等，所以我们无需再编译这些；\n编译 mysql_fdw 及 sqlite_fdw（注意，其中mysql_fdw其实可以不用了）\n安装 oracle_fdw 所需要的依赖（oracle instant client）；\n编译postgis，编译postgis需要先编译其依赖（mpfr，boost_1_67_0，CGAL等），这里我们将postgis的所有的依赖及其自身的安装路径都设置为 /usr/local/pgspider/plugin/postgis\nENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis 编译并安装 debezium及wal2json；\n使用strip对postgis目录中的所有so库进行大小优化\n将预先编译好的 几个fdw的so及配置及sql文件拷贝到指定目录以安装或更新这些fdw；\n第二阶段：\n从 pgspider-base 镜像开始构建； 安装必要的依赖； 从第一阶段拷贝出oracle_instantclient的依赖；（arm版本无此步骤，因为oracle_instantclient不支持arm架构） 从第一阶段拷贝出 /usr/local/pgspider 目录，其中包含了我们之前编译的的成果； 添加各种初始化脚本，并为pg运行做必要的准备，可以参考官方dockerfile； 最后使用 EXPOSE 暴露 5432端口，使用 CMD [“postgres”] 默认启动pg； # --- # 构建融合中心pg镜像(从源码构建）： # 1. 构建pgspider（pgspider-base镜像中包含） # 2. 添加若干fdw：mysql_fdw,oracle_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中） # 3. 添加 postgis # # 参考： # - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one # --- ## 构建 sqlite_fdw mysql_fdw oracle_fdw #FROM pgspider-builder as build FROM hanlyjiang/pgspider-builder as build WORKDIR /app ## PG 主版本 ENV PG_MAJOR 11 ENV PG_VERSION 6 ## 安装构建所需的依赖 RUN apt-get update \\ \u0026\u0026 apt-get install -y automake autoconf libtool pkg-config libssl-dev \\ libsqlite3-dev libsybdb5 freetds-dev freetds-common \\ libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \\ # for oracle unzip \\ # libmysql++-dev libmysql++-dev \\ # libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7 libspatialite7 # postgresql-${PG_MAJOR}-python-multicorn python-pip ## 安装 sqlite_fdw RUN git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw \u0026\u0026 make \u0026\u0026 make install ## 安装 mysql_fdw RUN git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw \u0026\u0026 make \u0026\u0026 make install ## 安装 Install es_fdw #RUN pip install pg_es_fdw ## 安装 oracle_fdw ### 安装oracle instantclient # https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/ RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/ RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/ RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus ENV ORACLE_HOME=/usr/local/instantclient ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient #RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \\ ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/ RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\ \u0026\u0026 cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\ \u0026\u0026 make \u0026\u0026 make install ## POSTGIS 构建 ### 安装依赖 RUN apt-get install -y --no-install-recommends \\ libtool libxml2 libxml2-dev \\ libxslt1.1 libxslt1-dev \\ libjson-c-dev libgmp-dev \\ cmake libmpfr-dev ### 创建临时工作目录 RUN mkdir /app/postgis/ ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib ENV PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH ### 构建 mpfr ADD postgis/mpfr-4.0.2.tar.gz /app/postgis/ RUN cd /app/postgis/mpfr-4.0.2 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ \u0026\u0026 make \u0026\u0026 make install ### 构建 boost ADD postgis/boost_1_67_0.tar.gz /app/postgis/ RUN cd /app/postgis/boost_1_67_0 \\ \u0026\u0026 ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH \u0026\u0026 ./b2 \u0026\u0026 ./b2 install ### 构建 CGAL ADD postgis/CGAL-4.11.2.tar.xz /app/postgis/ RUN cd /app/postgis/CGAL-4.11.2 \\ \u0026\u0026 cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 SFCGAL ADD postgis/SFCGAL-1.3.5.tar.gz /app/postgis/ RUN cd /app/postgis/SFCGAL-1.3.5 \\ \u0026\u0026 cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 proj，需要先安装sqlite3 RUN apt-get install -y --no-install-recommends sqlite3 libsqlite3-dev ADD postgis/proj-6.2.0.tar.gz /app/postgis/ RUN cd /app/postgis/proj-6.2.0 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 gdal ADD postgis/gdal-3.0.2.tar.gz /app/postgis/ RUN cd /app/postgis/gdal-3.0.2 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ # proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同 --with-proj=$PGIS_INSTALL_PATH \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 geos ADD postgis/geos-3.8.0.tar.bz2 /app/postgis/ RUN cd /app/postgis/geos-3.8.0 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 postgis ADD postgis/postgis-2.5.3.tar.gz /app/postgis/ RUN cd /app/postgis/postgis-2.5.3 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ # 几个config命令直接配置PATH后可以找到，所以不在使用参数配置 # --with-pgconfig=/usr/local/pgspider/bin/pg_config \\ # --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \\ # --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \\ --with-projdir=$PGIS_INSTALL_PATH \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install RUN set -ex \\ # \u0026\u0026 sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # \u0026\u0026 sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev # \u0026\u0026 echo \"deb http://deb.debian.org/debian stretch-backports main\" \u003e\u003e/etc/apt/sources.list \\ \u0026\u0026 apt-get update \\ \u0026\u0026 apt-get install -y --no-install-recommends \\ libprotobuf-c-dev \\ # postgresql-12-wal2json \\ protobuf-c-compiler \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* ## 添加 debezium https://github.com/eulerto/wal2json ADD debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/ RUN cd /app/debezium/wal2json-wal2json_1_0 \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ## 添加 debezium - decoderbufs 研究院修改版本 ADD debezium/postgres-decoderbufs.tar.gz /app/debezium/ RUN cd /app/debezium/postgres-decoderbufs \\ \u0026\u0026 cd proto \\ \u0026\u0026 protoc-c --c_out=../src/proto pg_logicaldec.proto \\ \u0026\u0026 cd .. \\ ## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean \u0026\u0026 make -B -j$(nproc) \u0026\u0026 make install ## 添加 debezium - decoderbufs 官方版本 #ADD debezium/postgres-decoderbufs-v.1.3.1.Final.tar.gz /app/debezium/ #RUN cd /app/debezium/postgres-decoderbufs-v.1.3.1.Final \\ # \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 对构建postgis过程中生成的文件进行优化，以减小大小 #### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化 RUN cd $PGIS_INSTALL_PATH/lib \\ \u0026\u0026 rm *.a \\ \u0026\u0026 find . -type f -name \"lib*.so.*\" -exec strip {} + # \u0026\u0026 cd /usr/local/pgspider/plugin/proj/lib \\ # \u0026\u0026 rm *.a \u0026\u0026 find . -type f -name \"lib*.so.*\" -exec strip {} + ## 拷贝mysql COPY binary/mysql_fdw/*.sql /usr/local/pgspider/share/postgresql/extension/ COPY binary/mysql_fdw/*.control /usr/local/pgspider/share/postgresql/extension/ COPY binary/mysql_fdw/*.so /usr/local/pgspider/lib/postgresql/ ## 拷贝zombodb COPY binary/zdblibs/*.sql /usr/local/pgspider/share/postgresql/extension/ COPY binary/zdblibs/*.control /usr/local/pgspider/share/postgresql/extension/ COPY binary/zdblibs/*.so /usr/local/pgspider/lib/postgresql/ ## 拷贝oracle fdw COPY binary/oracle/*.so /usr/local/pgspider/lib/postgresql/ # ------ 开始构建实际发布的镜像 ------ FROM hanlyjiang/pgspider-base:latest LABEL maintainer=\"jianghanghang@geostar.com.cn\" ## 设置若干ENV，指示版本信息 # buster 上为12 ，stretch 上为 12 # ENV CDAL_VERSION 12 ENV BOOST_VERSION=1.67.0 \\ PG_MAJOR=11 \\ PG_VERSION=6 \\ POSTGIS_VESION=2.5.3 ## 安装必要的依赖（TODO: 部分依赖可能不需要） RUN set -ex \\ # \u0026\u0026 sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # \u0026\u0026 sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev # \u0026\u0026 echo \"deb http://deb.debian.org/debian stretch-backports main\" \u003e\u003e/etc/apt/sources.list \\ \u0026\u0026 apt-get update \\ \u0026\u0026 apt-get install -y --no-install-recommends \\ curl \\ libcurl3-gnutls \\ libexpat1 \\ libgmp10 \\ libgmpxx4ldbl \\ libjson-c3 \\ # buster 上为6，stretch上为4 # libmpfr6 \\ # libmpfr4 \\ libprotobuf-c1 \\ libtiff5 \\ libxml2 \\ # for debezium postgresql-12-wal2json \\ libprotobuf-c-dev \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* ## 安装oracle_fdw需要的 Oracle instantclient ### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle COPY --from=build /usr/local/instantclient_12_2 /usr/local/instantclient_12_2 RUN set -ex \\ \u0026\u0026 ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \\ \u0026\u0026 ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus ## 设置若干运行需要的环境变量 ENV ORACLE_HOME=/usr/local/instantclient \\ PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \\ PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH ## 拷贝构建好的成果 COPY --from=build /usr/local/pgspider /usr/local/pgspider ## 入口脚本添加 COPY docker-entrypoint.sh /usr/local/bin/ RUN mkdir /docker-entrypoint-initdb.d \\ \u0026\u0026 chmod +x /usr/local/bin/docker-entrypoint.sh \\ \u0026\u0026 ln -s usr/local/bin/docker-entrypoint.sh / ## postgis 脚本添加 ### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template COPY ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh COPY ./postgis/update-postgis.sh /usr/local/bin ## 添加扩展初始化脚本 COPY ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh COPY ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh ## make the sample config easier to munge (and \"correct by default\") RUN sed -ri \"s!^#?(listen_addresses)\\s*=\\s*\\S+.*!\\1 = '*'!\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \\ grep -F \"listen_addresses = '*'\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample RUN mkdir -p /var/run/postgresql \u0026\u0026 chown -R postgres:postgres /var/run/postgresql \u0026\u0026 chmod 2777 /var/run/postgresql ENV PGDATA /var/lib/postgresql/data ## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary \"--user\" values) RUN mkdir -p \"$PGDATA\" \u0026\u0026 chown -R postgres:postgres \"$PGDATA\" \u0026\u0026 chmod 777 \"$PGDATA\" VOLUME /var/lib/postgresql/data ENTRYPOINT [\"docker-entrypoint.sh\"] # COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile # We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL # calls \"Fast Shutdown mode\" wherein new connections are disallowed and any # in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and # flush tables to disk, which is the best compromise available to avoid data # corruption. # # Users who know their applications do not keep open long-lived idle connections # may way to use a value of SIGTERM instead, which corresponds to \"Smart # Shutdown mode\" in which any existing sessions are allowed to finish and the # server stops when all sessions are terminated. # # See https://www.postgresql.org/docs/12/server-shutdown.html for more details # about available PostgreSQL server shutdown signals. # # See also https://www.postgresql.org/docs/12/server-start.html for further # justification of this as the default value, namely that the example (and # shipped) systemd service files use the \"Fast Shutdown mode\" for service # termination. # STOPSIGNAL SIGINT # An additional setting that is recommended for all users regardless of this # value is the runtime \"--stop-timeout\" (or your orchestrator/runtime's # equivalent) for controlling how long to wait between sending the defined # STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption). # # The default in most runtimes (such as Docker) is 10 seconds, and the # documentation at https://www.postgresql.org/docs/12/server-start.html notes # that even 90 seconds may not be long enough in many instances. EXPOSE 5432 CMD [\"postgres\"] ARM版本构建脚本 与x86版本不同之处在于：\nfrom的镜像不同，一个是x86版本，一个是arm版本； arm版本不包含oracle_fdw 构建的相关步骤； # --- # 构建融合中心pg镜像-armb版本(从源码构建）： # 1. 构建pgspider（pgspider-base镜像中包含） # 2. 添加若干fdw：mysql_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中） # 3. 添加 postgis # # 参考： # - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one # --- ## 构建 sqlite_fdw mysql_fdw FROM zh-registry.geostar.com.cn/geopanel/pgspider-builder-arm:latest as build WORKDIR /app ## PG 主版本 ENV PG_MAJOR 11 ENV PG_VERSION 6 ## 安装构建所需的依赖 RUN apt-get update \\ \u0026\u0026 apt-get install -y automake autoconf libtool pkg-config libssl-dev \\ libsqlite3-dev libsybdb5 freetds-dev freetds-common \\ libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \\ # for oracle unzip \\ # libmysql++-dev libmysql++-dev \\ # libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7 libspatialite7 # postgresql-${PG_MAJOR}-python-multicorn python-pip ## 安装 sqlite_fdw RUN git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw \u0026\u0026 make \u0026\u0026 make install ## 安装 mysql_fdw RUN git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw RUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw \u0026\u0026 make \u0026\u0026 make install ## 安装 Install es_fdw #RUN pip install pg_es_fdw ## 安装 oracle_fdw(arm 不支持) ### 安装oracle instantclient # https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle #ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip #ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip #ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip #RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/ #RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/ #RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/ #RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient #RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so #RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus #ENV ORACLE_HOME=/usr/local/instantclient #ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient #RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \\ #ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/ #RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\ # \u0026\u0026 cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\ # \u0026\u0026 make \u0026\u0026 make install ## POSTGIS 构建 ### 安装依赖 RUN apt-get install -y --no-install-recommends \\ libtool libxml2 libxml2-dev \\ libxslt1.1 libxslt1-dev \\ libjson-c-dev libgmp-dev \\ cmake libmpfr-dev ### 创建临时工作目录 RUN mkdir /app/postgis/ ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis ENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib ENV PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH ### 构建 mpfr ADD postgis/mpfr-4.0.2.tar.gz /app/postgis/ RUN cd /app/postgis/mpfr-4.0.2 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ \u0026\u0026 make \u0026\u0026 make install ### 构建 boost ADD postgis/boost_1_67_0.tar.gz /app/postgis/ RUN cd /app/postgis/boost_1_67_0 \\ \u0026\u0026 ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH \u0026\u0026 ./b2 \u0026\u0026 ./b2 install ### 构建 CGAL ADD postgis/CGAL-4.11.2.tar.xz /app/postgis/ RUN cd /app/postgis/CGAL-4.11.2 \\ \u0026\u0026 cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 SFCGAL ADD postgis/SFCGAL-1.3.5.tar.gz /app/postgis/ RUN cd /app/postgis/SFCGAL-1.3.5 \\ \u0026\u0026 cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 proj，需要先安装sqlite3 RUN apt-get install -y --no-install-recommends sqlite3 libsqlite3-dev ADD postgis/proj-6.2.0.tar.gz /app/postgis/ RUN cd /app/postgis/proj-6.2.0 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 gdal ADD postgis/gdal-3.0.2.tar.gz /app/postgis/ RUN cd /app/postgis/gdal-3.0.2 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ # proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同 --with-proj=$PGIS_INSTALL_PATH \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 geos ADD postgis/geos-3.8.0.tar.bz2 /app/postgis/ RUN cd /app/postgis/geos-3.8.0 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ### 构建 postgis ADD postgis/postgis-2.5.3.tar.gz /app/postgis/ RUN cd /app/postgis/postgis-2.5.3 \\ \u0026\u0026 ./configure --prefix=$PGIS_INSTALL_PATH \\ # 几个config命令直接配置PATH后可以找到，所以不在使用参数配置 # --with-pgconfig=/usr/local/pgspider/bin/pg_config \\ # --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \\ # --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \\ --with-projdir=$PGIS_INSTALL_PATH \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install RUN set -ex \\ # \u0026\u0026 sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # \u0026\u0026 sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev # \u0026\u0026 echo \"deb http://deb.debian.org/debian stretch-backports main\" \u003e\u003e/etc/apt/sources.list \\ \u0026\u0026 apt-get update \\ \u0026\u0026 apt-get install -y --no-install-recommends \\ libprotobuf-c-dev \\ # postgresql-12-wal2json \\ protobuf-c-compiler \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* ## 添加 debezium https://github.com/eulerto/wal2json ADD debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/ RUN cd /app/debezium/wal2json-wal2json_1_0 \\ \u0026\u0026 make -j$(nproc) \u0026\u0026 make install ## 添加 debezium - decoderbufs 研究院修改版本 ADD debezium/postgres-decoderbufs.tar.gz /app/debezium/ RUN cd /app/debezium/postgres-decoderbufs \\ \u0026\u0026 cd proto \\ \u0026\u0026 protoc-c --c_out=../src/proto pg_logicaldec.proto \\ \u0026\u0026 cd .. \\ ## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean \u0026\u0026 make -B -j$(nproc) \u0026\u0026 make install ### 对构建postgis过程中生成的文件进行优化，以减小大小 #### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化 RUN cd $PGIS_INSTALL_PATH/lib \\ \u0026\u0026 rm *.a \\ \u0026\u0026 find . -type f -name \"lib*.so.*\" -exec strip {} + # \u0026\u0026 cd /usr/local/pgspider/plugin/proj/lib \\ # \u0026\u0026 rm *.a \u0026\u0026 find . -type f -name \"lib*.so.*\" -exec strip {} + ## 拷贝mysql COPY binary-arm/mysql_fdw/*.sql /usr/local/pgspider/share/postgresql/extension/ COPY binary-arm/mysql_fdw/*.control /usr/local/pgspider/share/postgresql/extension/ COPY binary-arm/mysql_fdw/*.so /usr/local/pgspider/lib/postgresql/ # 拷贝zombodb COPY binary-arm/zdblibs/*.sql /usr/local/pgspider/share/postgresql/extension/ COPY binary-arm/zdblibs/*.control /usr/local/pgspider/share/postgresql/extension/ COPY binary-arm/zdblibs/*.so /usr/local/pgspider/lib/postgresql/ # ------ 开始构建实际发布的镜像 ------ FROM zh-registry.geostar.com.cn/geopanel/pgspider-base-arm:latest LABEL maintainer=\"jianghanghang@geostar.com.cn\" ## 设置若干ENV，指示版本信息 # buster 上为12 ，stretch 上为 12 # ENV CDAL_VERSION 12 ENV BOOST_VERSION=1.67.0 \\ PG_MAJOR=11 \\ PG_VERSION=6 \\ POSTGIS_VESION=2.5.3 ## 安装必要的依赖（TODO: 部分依赖可能不需要） RUN set -ex \\ # \u0026\u0026 sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # \u0026\u0026 sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\ # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev # \u0026\u0026 echo \"deb http://deb.debian.org/debian stretch-backports main\" \u003e\u003e/etc/apt/sources.list \\ \u0026\u0026 apt-get update \\ \u0026\u0026 apt-get install -y --no-install-recommends \\ curl \\ libcurl3-gnutls \\ libexpat1 \\ libgmp10 \\ libgmpxx4ldbl \\ libjson-c3 \\ # buster 上为6，stretch上为4 # libmpfr6 \\ # libmpfr4 \\ libprotobuf-c1 \\ libtiff5 \\ libxml2 \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* ## 安装oracle_fdw需要的 Oracle instantclient (arm版本不支持） ### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle #COPY --from=build /usr/local/instantclient_12_2 /usr/local/instantclient_12_2 #RUN set -ex \\ # \u0026\u0026 ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \\ # \u0026\u0026 ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus ## 设置若干运行需要的环境变量 #ENV ORACLE_HOME=/usr/local/instantclient \\ ENV PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \\ PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH ## 拷贝构建好的成果 COPY --from=build /usr/local/pgspider /usr/local/pgspider ## 入口脚本添加 COPY docker-entrypoint.sh /usr/local/bin/ RUN mkdir /docker-entrypoint-initdb.d \\ \u0026\u0026 chmod +x /usr/local/bin/docker-entrypoint.sh \\ \u0026\u0026 ln -s usr/local/bin/docker-entrypoint.sh / ## postgis 脚本添加 ### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template COPY ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh COPY ./postgis/update-postgis.sh /usr/local/bin ## 添加扩展初始化脚本 COPY ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh COPY ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh ## make the sample config easier to munge (and \"correct by default\") RUN sed -ri \"s!^#?(listen_addresses)\\s*=\\s*\\S+.*!\\1 = '*'!\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \\ grep -F \"listen_addresses = '*'\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample RUN mkdir -p /var/run/postgresql \u0026\u0026 chown -R postgres:postgres /var/run/postgresql \u0026\u0026 chmod 2777 /var/run/postgresql ENV PGDATA /var/lib/postgresql/data ## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary \"--user\" values) RUN mkdir -p \"$PGDATA\" \u0026\u0026 chown -R postgres:postgres \"$PGDATA\" \u0026\u0026 chmod 777 \"$PGDATA\" VOLUME /var/lib/postgresql/data ENTRYPOINT [\"docker-entrypoint.sh\"] # COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile # We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL # calls \"Fast Shutdown mode\" wherein new connections are disallowed and any # in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and # flush tables to disk, which is the best compromise available to avoid data # corruption. # # Users who know their applications do not keep open long-lived idle connections # may way to use a value of SIGTERM instead, which corresponds to \"Smart # Shutdown mode\" in which any existing sessions are allowed to finish and the # server stops when all sessions are terminated. # # See https://www.postgresql.org/docs/12/server-shutdown.html for more details # about available PostgreSQL server shutdown signals. # # See also https://www.postgresql.org/docs/12/server-start.html for further # justification of this as the default value, namely that the example (and # shipped) systemd service files use the \"Fast Shutdown mode\" for service # termination. # STOPSIGNAL SIGINT # An additional setting that is recommended for all users regardless of this # value is the runtime \"--stop-timeout\" (or your orchestrator/runtime's # equivalent) for controlling how long to wait between sending the defined # STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption). # # The default in most runtimes (such as Docker) is 10 seconds, and the # documentation at https://www.postgresql.org/docs/12/server-start.html notes # that even 90 seconds may not be long enough in many instances. EXPOSE 5432 CMD [\"postgres\"] 镜像测试及使用 提示：镜像使用了pg官方的入口脚本，官方支持的配置及变量都可以使用，具体可查看官方dockerhub页面\n下面描述了一个简单的测试流程，详细可参考： pgspider镜像运行测试\n## 根据平台及需要使用的源，设置 `PG_IMAGE` 变量 # x86 - dockerhub PG_IMAGE=hanlyjiang/pgspider-postgis:latest # arm - dockerhub PG_IMAGE=hanlyjiang/pgspider-postgis-arm:latest # x86 - 阿里云 PG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis:latest # arm - 阿里云 PG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis-arm:latest # 启动 pgspider （可以将 --rm 换成 -d 以便持续在后台运行 ） ## 通过 POSTGRES_PASSWORD 变量可以设置密码 docker run -it --rm \\ --name pgspider \\ -p 5434:5432 \\ -e POSTGRES_PASSWORD=mysecretpassword \\ -v $PWD/data:/var/lib/postgresql/data \\ $PG_IMAGE ## 启动后进入容器： docker exec -it pgspider bash ### 然后可以执行 psql 等命令 # 测试用，正常运行可以不用管 docker run -it --rm \\ --entrypoint=\"\" \\ --name pgspider \\ -e POSTGRES_PASSWORD=mysecretpassword \\ -v $PWD/data:/var/lib/postgresql/data \\ pgspider-postgis:latest bash 可优化部分 builder镜像和base镜像的构建arm及x86两个架构的镜像构建可以合并成一条命令并使用相同的镜像名称；同时pgspider镜像也可以经过一定的更改统一成一个打包脚本；\nGeoPanel容器化-hasura即块数据API引擎镜像构建 Hasura镜像构建概览 hasura 是什么？ 引用hasura官方的介绍\nHasura GraphQL引擎是一个高性能的GraphQL服务器，可为您提供 Postgres上开箱即用的实时GraphQL API， 响应数据库事件的 Webhook触发器，以及用于业务逻辑处理的 远端Schema。 Hasura可帮助您构建基于Postgres的GraphQL应用程序，或将使用Postgres的现有应用迁移到GraphQL上。\nGithub及DockerHub地址：\n开源仓库Github地址：hasura/graphql-engine 官方Dockerhub镜像地址：hasura/graphql-engine 我们做的修改 我们使用hasura作为融合中心的块数据API引擎，针对开源版本作了如下修改/扩展：\n汉化了 graphl-engine console，其中包括： 汉化 graphql-engine的console入口文件中的 Loading...; console web页面的所有界面； 根据需要扩展了几个模块，模块扩展的方式为：1）在console中添加扩展模块的web操作界面；2）提供对应的springboot服务作为后端接口提供服务；到目前为止，包括以下模块： token管理服务 数据库集成服务 restapi服务 目标及成果 通过官方的dockerhub可以看到，目前没有arm版本的镜像，故我们需要从头编译。同时我们希望能让hasura在arm平台上运行，最终也完成了构建流程，整体如下：\nhasura整体结构 graph graphql-engine console cli graphql-engine: graphql 引擎\nconsole：前端界面，实际上console也会一起打包到graphql-engine的镜像里面\nHasura CLI是一个命令行工具，是管理Hasura项目和迁移的主要模式。\n实际上我们只需要前两个部分即可\n整体构建流程梳理 代码结构说明 graphql-engine |-- server |-- src-rsr |-- console.html |-- console |-- xx.html |-- xxxx server 目录会编译出一个 graphql-engine 的二进制文件，其中会包含 server/src-rsr/console.html 文件作为首页的加载模板（即console.html）。\ngraphql-engine console console为web工程，使用npm run build即可编译，非常简单。我们只需要重点关注server部分即可。现在我们重点分析这个server部分：\ngraphql-engine server graphql-engine server 使用haskell语言进行编写，使用 cabal 进行构建； haskell是一个函数式编程语言，编译器为GHC，编译工具一般使用cabal，cabal同时也是项目的管理工具（如包管理，依赖管理）。 也就是说为了编译server，我们需要GHC及cabal，那么这两个工具的arm版本现状如何了？\nGHC： 无arm版本现成的docker镜像，有预编译的二进制； cabal： 无arm版本现成的docker镜像及二进制文件； 为了不污染环境，并且持久化构建环境，我们准备构建一个docker的镜像，包含ghc及cabal，也就是说，我们两者都需要构建。\n总结以下构建步骤：\n准备haskell的ARM版本编译环境（包括GHC编译器及hasura编译所需要的cabal工具）； 使用之前准备好的ARM版本编译环境编译hasura； 打包成Docker镜像； 整体构建流程 在浏览graphql-engine 的仓库中ci构建的部分文件之后，我发现还需要其他一些辅助镜像，最后梳理出如下构建流程：\n首先，我们需要构建 graphql-engine-builder 的镜像，其中包括haskell的GHC编译器及cabal依赖管理工具； 然后我们使用graphql-engine-builder镜像对 graphql-engine 的源码进行编译，生成 graphql-engine 的二进制可执行文件及 graphql-engine 运行所需要的依赖库； 由于第二步构建过程中有很多中间成果，我需要为graphql-engine创造一个纯净的运行环境以缩小最终的运行镜像的大小，所以我们需要构建 graphql-engine-packager 镜像，其中包含一个精简版的根文件系统。 现在，我们将第二步中生成的graphql-engine及其依赖文件和第三步 graphql-engine-packager 镜像中的根文件系统合并到一个scratch镜像，然后生成 graphql-engine-base 的镜像，这个镜像已经包含了一个可以正常运行的 graphql-engine ，只是没有集成console资源到镜像中； 最后我们对console进行编译，生成assets资源，然后基于 graphql-engine-base 添加这些前端资源文件，生成我们最终需要的 graphql-engine 镜像； graphql-engine-builder 镜像构建 基于以下原因，我决定构建一个graphql-engine-builder的镜像：\n不想污染自己的主机的环境，安装一堆haskell的构建环境； 持久化编译环境，使得构建过程可以无成本迁移到任何机器； 这个builder镜像包含以下内容(实际上就是haskell语言的构建环境)：\nGHC cabal 经过一番尝试，确定了如下Dockerfile构建脚本：\nX86 Dockerfile # x86 用于构建hasura的镜像 # 构建命令 docker build -f Dockerfile -t hanlyjiang/graphql-engine-builder:latest . FROM haskell:8.10.1 ## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误） ENV LANG C.UTF-8 # 避免配置tzdata时出现的交互式等待界面导致构建卡住 ## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/ ENV DEBIAN_FRONTEND noninteractive RUN sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \u0026\u0026 \\ sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \u0026\u0026 \\ apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends apt-utils lsb-release wget \u0026\u0026 \\ echo \"deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main\" \u003e /etc/apt/sources.list.d/pgdg.list \u0026\u0026 \\ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - \u0026\u0026 \\ apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends postgresql libpq-dev \u0026\u0026 \\ rm -fr /var/lib/apt/lists/* \u0026\u0026 \\ # 安装 upx wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz \u0026\u0026 \\ tar -xf upx-3.96-amd64_linux.tar.xz \u0026\u0026 \\ cp upx-3.96-amd64_linux/upx /usr/bin/upx \u0026\u0026 \\ rm -fr upx-3.96-amd64_linux x86版本基于 haskell官方的haskell:8.10.1 镜像，添加了如下动作：\n替换软件源为国内软件源； 安装必要的软件依赖； 添加了upx用于二进制文件优化； ARM Dockerfile arm版本的则需要从头构建\n我们使用 ubuntu:18.04 作为基础镜像； 首先安装了 LLVM6.0 及 GHC8.6.5 ； 使用 GHC8.6.5 构建 Cabal3.2.0.0（包括cabal-install），因为GHC8.10.1无法成功构建cabal-install 3.2； 然后安装 LLVM 9 及GHC8.10.1，用于后续编译hasura； 添加必要的依赖； 添加了upx用于二进制文件优化； ## Hasura graphql-engine 编译环境 # 测试发现只有在arm机器上才可能构建成功，x86 docker交叉构建失败 # docker build -t registry.cn-hangzhou.aliyuncs.com/geostar_private_arm/haskell-ghc8.6.5_8.10.1-cabal3.2:20200817 . # ghc-8.6.5的安装构建需要在ubuntu18.04上（glibc2.27) ## 通过如下方式确认glibc版本： ### docker run -it --rm ubuntu:18.04 bash -c \"find / -type f | grep libc-.*.so\" # 输出 /lib/x86_64-linux-gnu/libc-2.27.so ### docker run -it --rm debian:stretch bash -c \"find / -type f | grep libc-.*.so\" # 输出 /lib/x86_64-linux-gnu/libc-2.24.so ### docker run -it --rm debian:buster bash -c \"find / -type f | grep libc-.*.so\" # 输出 /lib/aarch64-linux-gnu/libc-2.28.so ### debian也可以在此页面查看：https://packages.debian.org/search?searchon=sourcenames\u0026keywords=glibc #FROM debian:stretch FROM ubuntu:18.04 ## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误） ENV LANG C.UTF-8 # 避免配置tzdata时出现的交互式等待界面导致构建卡住 ## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/ ENV DEBIAN_FRONTEND noninteractive # 以防网络不好，切换到国内镜像源 RUN apt-get update \u0026\u0026 \\ apt install -y apt-transport-https ca-certificates ADD ubuntu18.04-sources.list /etc/apt/sources.list # 避免 hash sum mismatch 问题： ## https://stackoverflow.com/questions/15505775/debian-apt-packages-hash-sum-mismatch # RUN apt-get clean \u0026\u0026 rm -rf /var/lib/apt/lists/* \u0026\u0026 apt-get clean \u0026\u0026 apt-get update \u0026\u0026 \\ # 安装常用软件及GHC构建相关依赖 RUN apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends gnupg ca-certificates dirmngr curl git wget \u0026\u0026 \\ apt-get install -y --no-install-recommends zlib1g-dev libtinfo-dev libsqlite3-dev \\ g++ netbase xz-utils libnuma-dev make openssh-client \\ # hasura 构建需要（pg-client） ## https://stackoverflow.com/questions/17915098/openssl-ssl-h-no-such-file-or-directory-during-installation-of-git libssl-dev libkrb5-dev \u0026\u0026 \\ # 安装llvm 6.0（用于构建cabal） LLVM_VERSION=6.0 \u0026\u0026 \\ # apt-get install -y software-properties-common \u0026\u0026 \\ apt-get install -y --no-install-recommends libghc-network-dev \\ llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev \u0026\u0026 \\ rm -fr /var/lib/apt/lists/* \u0026\u0026 \\ ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc \u0026\u0026 \\ ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt # 安装 GHC 8.6.5（用于构建Cabal3.2.0.0） RUN GHC=8.6.5 \u0026\u0026 GHC_OS_DIST=ubuntu18.04 \u0026\u0026 \\ ## 下载链接类似：https://downloads.haskell.org/~ghc/8.10.1/ghc-8.10.1-aarch64-deb9-linux.tar.xz wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz \u0026\u0026 \\ tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz \u0026\u0026 \\ cd ghc-${GHC} \u0026\u0026 \\ ./configure \u0026\u0026 \\ make install \u0026\u0026 \\ cd ../ \u0026\u0026 \\ rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} # 构建 Cabal 3.2.0.0 （包括 cabal-install） RUN git clone -b cabal-install-v3.2.0.0 https://github.com/haskell/cabal.git \u0026\u0026 \\ cd cabal/cabal-install \u0026\u0026 \\ ./bootstrap.sh \u0026\u0026 \\ cd ../.. \u0026\u0026 \\ rm -fr cabal # 安装 llvm 9 及其他构建所需 （postgresql libpq-dev）pg_config RUN LLVM_VERSION=9 \u0026\u0026 \\ apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev \u0026\u0026 \\ # 如果有旧版本的，则移除链接 rm /usr/local/bin/llc /usr/local/bin/opt \u0026\u0026 \\ ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc \u0026\u0026 \\ ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt \u0026\u0026 \\ # 安装ghc8.10.1 ，自带Cabal库的3.2版本 GHC=8.10.1 \u0026\u0026 GHC_OS_DIST=deb9 \u0026\u0026 \\ wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz \u0026\u0026 \\ tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz \u0026\u0026 \\ cd ghc-${GHC} \u0026\u0026 \\ ./configure \u0026\u0026 \\ make install \u0026\u0026 \\ cd ../ \u0026\u0026 \\ rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} \u0026\u0026 \\ # 安装3.96版本的upx-用于压缩优化graphql-engine二进制可执行文件（软件源中的3.94版本有压缩aarch的二进制后有问题 https://github.com/upx/upx/issues/130） wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-arm64_linux.tar.xz \u0026\u0026 \\ tar -xf upx-3.96-arm64_linux.tar.xz \u0026\u0026 \\ cp upx-3.96-arm64_linux/upx /usr/bin/upx \u0026\u0026 \\ rm -fr upx-3.96-arm64_linux upx-3.96-arm64_linux.tar.xz /var/lib/apt/lists/* ## stack 安装(hasura构建可不安装stack) # ARG STACK=2.1.3 # ARG STACK_KEY=C5705533DA4F78D8664B5DC0575159689BEFB442 # ARG STACK_RELEASE_KEY=2C6A674E85EE3FB896AFC9B965101FF31C5C154D # RUN arch=`uname -m` \u0026\u0026 \\ # echo $arch \u0026\u0026 \\ # curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz -o stack.tar.gz \u0026\u0026 \\ # curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz.asc -o stack.tar.gz.asc # RUN export GNUPGHOME=\"$(mktemp -d)\" \u0026\u0026 \\ # gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_KEY} \u0026\u0026 \\ # gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_RELEASE_KEY} \u0026\u0026 \\ # gpg --batch --trusted-key 0x575159689BEFB442 --verify stack.tar.gz.asc stack.tar.gz \u0026\u0026 \\ # tar -xf stack.tar.gz -C /usr/local/bin --strip-components=1 \u0026\u0026 \\ # /usr/local/bin/stack config set system-ghc --global true \u0026\u0026 \\ # /usr/local/bin/stack config set install-ghc --global false \u0026\u0026 \\ # rm -rf \"$GNUPGHOME\" /var/lib/apt/lists/* /stack.tar.gz.asc /stack.tar.gz; # 设置环境变量使可以找到cabal，GHC的默认会安装到PATH中，无需额外设置 ENV PATH /root/.cabal/bin:$PATH ## 没有指定命令的时候默认运行ghci CMD [\"ghci\"] 注意：由于以上builder镜像是用于编译graphql-engine的工具镜像，而非最终的镜像，所以并未刻意对镜像大小进行优化；\ngraphql-engine-packager 构建 packager镜像中包含一个纯净的根文件系统，可为graphql-engine server提供基础的运行环境；\n整体说明 graphql-engine-packager的镜像构建脚本位于源码的 server/packaging 目录中的 package.df 文件中，内容如下：\nFROM hasura/haskell-docker-packager:20190731 MAINTAINER vamshi@hasura.io RUN apt-get update \u0026\u0026 apt-get install -y libpq5 upx \\ \u0026\u0026 update-ca-certificates \\ \u0026\u0026 mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \\ \u0026\u0026 cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* 可以看到其基于 hasura/haskell-docker-packager:20190731 的镜像（DockerHub对应页面），具体构建方式如下：\nregistry=hanlyjiang # 替换成自行设置的值 packager_ver=20210316 # 替换成自行设置的值 docker build -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager.df ./packaging/ 从以上分析可知，我们要构建packager镜像，需要先构建haskell-docker-packager镜像，而对于X86版本来说，可以直接使用使用官方已经构建好的镜像，对于ARM版本来说，则需要我们从头构建；\nX86镜像构建 如上所述，我们直接基于官方的 hasura/haskell-docker-packager:20190731并使用源码目录中的 packaging/packager.df 文件构建出对应的graphql-engine-packager镜像即可；\nARM haskell-docker-packager 镜像构建 arm版本则需要我们从头构建 haskell-docker-packager 的镜像，基于官方的 github/hasura/haskell-docker-builder 源码，我略作修改，让其可以构建出arm版本的镜像，对应的代码放置于 github/hanlyjiang/haskell-docker-builder 中，执行如下命令即可构建出arm版本的 haskell-docker-packager 镜像：\ngit clone git@github.com:hanlyjiang/haskell-docker-builder.git make build 上述命令执行完毕后会生成一个 hanlyjiang/haskell-docker-packager:当前日期 的镜像。\ngraphql-engine-packager 镜像构建 同样的，我们在 graphql-engine的源代码的 server/packaging 目录中添加一个名为 packaging-arm.df 的文件用于构建 arm 版本的 graphql-engine-packager 镜像，内容如下：\nFROM hanlyjiang/haskell-docker-packager:20200814 MAINTAINER hanlyjiang@outlook.com RUN apt-get update \u0026\u0026 apt-get install -y libpq5 upx \\ \u0026\u0026 update-ca-certificates \\ \u0026\u0026 mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \\ \u0026\u0026 cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* 可通过如下命令构建arm版本镜像：\nregistry=hanlyjiang # 替换成自行设置的值 packager_ver=20210316 # 替换成自行设置的值 构建可以在arm机器上执行，也可以在x86机器上通过buildx来交叉构建：\narm 机器上执行： docker build -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager-arm.df ./packaging/ 非arm机器上交叉构建arm镜像 docker buildx build --platform=linux/arm64 -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager-arm.df ./packaging/ --load graphql-engine-base 构建 graphql-engine-base 镜像包含 graphql-engine 的 server，当不包含 console 的 web 资源；\nX86镜像构建 ### 构建 graphql-engine 镜像 ## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./ ## -- 编译 graphql-engine # FROM hanlyjiang/graphql-engine-builder:20201111 as builder ARG GIT_TAG=v1.3.2 ARG GIT_USER=docker-build ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine WORKDIR /app/graphql-engine/server # 初始化cabal的配置 RUN ln -s cabal.project.ci cabal.project.local \u0026\u0026 \\ export LANG=C.UTF-8 \u0026\u0026 \\ # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html cabal user-config update \u0026\u0026 \\ # 替换为国内源 sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config \u0026\u0026 \\ sed -i 's/mirrors.tuna.tsinghua.edu.cn\\//mirrors.tuna.tsinghua.edu.cn\\/hackage/g' /root/.cabal/config # 重新更新软件包信息(单独作为一层，以便缓存) RUN cabal new-update # 编译 graphql-engine 可执行文件 # 我们将加载中替换为中文 RUN sed -i 's/Loading/加载中/g' src-rsr/console.html \u0026\u0026 \\ # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs cabal new-build --jobs=$(nproc) RUN build_output=../_build_output \u0026\u0026 \\ exec_glob=`find ./dist-newstyle/ -type f -name \"graphql-engine\"` \u0026\u0026 \\ mkdir $build_output \u0026\u0026 \\ cp \"$exec_glob\" $build_output/ \u0026\u0026 \\ # get-version 需要基于git仓库获取版本号 ../scripts/get-version.sh \u003e$build_output/version.txt ## -- 提取基础的rootfs # docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ FROM hasura/graphql-engine-packager:20190731 as baseRootfs COPY --from=builder /app/graphql-engine/_build_output/ /root/ RUN mkdir /rootfs/ \u0026\u0026 /build.sh graphql-engine | tar -x -C /rootfs/ ## 构建最终的rootfs # docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ FROM builder as bulderRootfs WORKDIR /app/graphql-engine/ COPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs RUN pg_dump_ver=12 \u0026\u0026 \\ exec_glob=`find server/dist-newstyle/ -type f -name \"graphql-engine\"` \u0026\u0026 \\ build_output=./_build_output \u0026\u0026 \\ packaging_dir=./server/packaging/ \u0026\u0026 \\ rootfs_dir=$packaging_dir/build/rootfs \u0026\u0026 \\ cp $build_output/graphql-engine $rootfs_dir/bin \u0026\u0026 \\ # 获取所有动态链接库 ldd $build_output/graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ \u0026\u0026 \\ # 获取 pg_dump cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump \u0026\u0026 \\ # 优化\u0026压缩 strip --strip-unneeded $rootfs_dir/bin/graphql-engine \u0026\u0026 \\ upx $rootfs_dir/bin/graphql-engine ## - 不带 console-assets # docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./ FROM scratch as graphql-engine-base COPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ / ENV LANG=C.UTF-8 LC_ALL=C.UTF-8 CMD [\"graphql-engine\", \"serve\"] 执行如下命令构建：\nTAG=$(date '+%Y%m%d') docker build -t graphql-engine-base:$TAG ./ ARM版本镜像构建 ### 构建 graphql-engine 镜像 ## docker buildx build --platform=linux/arm64 -f Dockerfile-base-arm.dockerfile -t graphql-engine-base:arm-20201109 ./ --load ## 构建准备 # docker pull hanlyjiang/graphql-engine-builder:arm-latest ## -- 编译 graphql-engine # FROM hanlyjiang/graphql-engine-builder:arm-latest as builder ARG GIT_TAG=v1.3.2 ARG GIT_USER=docker-build ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine WORKDIR /app/graphql-engine/server # 初始化cabal的配置 RUN ln -s cabal.project.ci cabal.project.local \u0026\u0026 \\ export LANG=C.UTF-8 \u0026\u0026 \\ # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html cabal user-config update \u0026\u0026 \\ # 替换为国内源 sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config \u0026\u0026 \\ sed -i 's/mirrors.tuna.tsinghua.edu.cn\\//mirrors.tuna.tsinghua.edu.cn\\/hackage/g' /root/.cabal/config # 重新更新软件包信息(单独作为一层，以便缓存) ## update 过程中可能自动去github下载仓库 RUN cabal new-update # 编译 graphql-engine 可执行文件 RUN sed -i 's/Loading/加载中/g' src-rsr/console.html \u0026\u0026 \\ # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs cabal new-build --jobs=$(nproc) RUN build_output=../_build_output \u0026\u0026 \\ exec_glob=`find ./dist-newstyle/ -type f -name \"graphql-engine\"` \u0026\u0026 \\ mkdir $build_output \u0026\u0026 \\ cp \"$exec_glob\" $build_output/ \u0026\u0026 \\ # get-version 需要基于git仓库获取版本号 ../scripts/get-version.sh \u003e$build_output/version.txt ## -- 提取基础的rootfs # docker buildx build --platform=linux/arm64 -f Dockerfile-base.dockerfile --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ --load FROM hanlyjiang/graphql-engine-packager:20200814 as baseRootfs COPY --from=builder /app/graphql-engine/_build_output/ /root/ # build.sh 的内容就是下面的 ldd graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t ，用于拷贝packager镜像中graphql-engine需要的依赖库到rootfs RUN mkdir /rootfs/ \u0026\u0026 /build.sh graphql-engine | tar -x -C /rootfs/ ## 构建最终的rootfs # docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ --load FROM builder as bulderRootfs WORKDIR /app/graphql-engine/ COPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs RUN pg_dump_ver=12 \u0026\u0026 \\ exec_glob=`find server/dist-newstyle/ -type f -name \"graphql-engine\"` \u0026\u0026 \\ build_output=./_build_output \u0026\u0026 \\ packaging_dir=./server/packaging/ \u0026\u0026 \\ rootfs_dir=$packaging_dir/build/rootfs \u0026\u0026 \\ cp $build_output/graphql-engine $rootfs_dir/bin \u0026\u0026 \\ # 获取所有动态链接库 ldd $build_output/graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ \u0026\u0026 \\ # 获取 pg_dump(arm builder镜像路径不一样) cp /usr/share/postgresql-common/pg_wrapper $rootfs_dir/bin/pg_dump \u0026\u0026 \\ # 优化\u0026压缩 strip --strip-unneeded $rootfs_dir/bin/graphql-engine \u0026\u0026 \\ upx $rootfs_dir/bin/graphql-engine ## - 不带 console-assets # docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base-arm:20201110 --target graphql-engine-base ./ --load FROM scratch as graphql-engine-base LABEL maintainer=\"jianghanghang@geostar.com.cn\" COPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ / ENV LANG=C.UTF-8 LC_ALL=C.UTF-8 CMD [\"graphql-engine\", \"serve\"] 执行如下命令构建：\nTAG=$(date '+%Y%m%d') # ARM机器执行 docker build -t graphql-engine-base:arm-$TAG ./ # x86交叉构建 docker buildx build --platform=linux/arm64 -t graphql-engine-base:arm-$TAG ./ --load 构建脚本合并简化（未验证） ### 构建 graphql-engine 镜像 ## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./ ## -- 编译 graphql-engine # ARG builder_image ARG packager_image FROM ${builder_image} as builder ARG GIT_TAG=v1.3.2 ARG GIT_USER=docker-build ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine WORKDIR /app/graphql-engine/server # 初始化cabal的配置 RUN ln -s cabal.project.ci cabal.project.local \u0026\u0026 \\ export LANG=C.UTF-8 \u0026\u0026 \\ # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html cabal user-config update \u0026\u0026 \\ # 替换为国内源 sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config \u0026\u0026 \\ sed -i 's/mirrors.tuna.tsinghua.edu.cn\\//mirrors.tuna.tsinghua.edu.cn\\/hackage/g' /root/.cabal/config # 重新更新软件包信息(单独作为一层，以便缓存) RUN cabal new-update # 编译 graphql-engine 可执行文件 # 我们将加载中替换为中文 RUN sed -i 's/Loading/加载中/g' src-rsr/console.html \u0026\u0026 \\ # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs cabal new-build --jobs=$(nproc) RUN build_output=../_build_output \u0026\u0026 \\ exec_glob=`find ./dist-newstyle/ -type f -name \"graphql-engine\"` \u0026\u0026 \\ mkdir $build_output \u0026\u0026 \\ cp \"$exec_glob\" $build_output/ \u0026\u0026 \\ # get-version 需要基于git仓库获取版本号 ../scripts/get-version.sh \u003e$build_output/version.txt ## -- 提取基础的rootfs # docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ FROM ${packager_image} as baseRootfs COPY --from=builder /app/graphql-engine/_build_output/ /root/ RUN mkdir /rootfs/ \u0026\u0026 /build.sh graphql-engine | tar -x -C /rootfs/ ## 构建最终的rootfs # docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ FROM builder as bulderRootfs WORKDIR /app/graphql-engine/ COPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs RUN pg_dump_ver=12 \u0026\u0026 \\ exec_glob=`find server/dist-newstyle/ -type f -name \"graphql-engine\"` \u0026\u0026 \\ build_output=./_build_output \u0026\u0026 \\ packaging_dir=./server/packaging/ \u0026\u0026 \\ rootfs_dir=$packaging_dir/build/rootfs \u0026\u0026 \\ cp $build_output/graphql-engine $rootfs_dir/bin \u0026\u0026 \\ # 获取所有动态链接库 ldd $build_output/graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ \u0026\u0026 \\ # 获取 pg_dump cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump \u0026\u0026 \\ # 优化\u0026压缩 strip --strip-unneeded $rootfs_dir/bin/graphql-engine \u0026\u0026 \\ upx $rootfs_dir/bin/graphql-engine ## - 不带 console-assets # docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./ FROM scratch as graphql-engine-base COPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ / ENV LANG=C.UTF-8 LC_ALL=C.UTF-8 CMD [\"graphql-engine\", \"serve\"] 构建命令：\nX86\nbuilder_image=hanlyjiang/graphql-engine-builder:20201111 packager_image=hasura/graphql-engine-packager:20190731 TAG=$(date '+%Y%m%d') docker build ./ -t graphql-engine-base:$TAG --build-arg builder_image=\"$builder_image\" --build-arg packager_image=\"$packager_image\" ARM\nbuilder_image=hanlyjiang/graphql-engine-builder:arm-latest packager_image=hanlyjiang/graphql-engine-packager:20200814 TAG=$(date '+%Y%m%d') # ARM机器执行 docker build -t graphql-engine-base:arm-$TAG --build-arg builder_image=\"$builder_image\" --build-arg packager_image=\"$packager_image\" ./ # x86交叉构建 docker buildx build --platform=linux/arm64 -t graphql-engine-base:arm-$TAG --build-arg builder_image=\"$builder_image\" --build-arg packager_image=\"$packager_image\" ./ --load graphql-engine 镜像构建 graphql-engine 即是我们最终需要使用的镜像，包含graphql-engine 的server及console web资源；\nX86 ### 构建 graphql-engine 镜像 ## docker build -t graphql-engine:20201111 ./ ## -- 构建 console # docker build --progress plain -f Dockerfile-console.dockerfile -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./ FROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder # 有时console代码更新，我们直接从仓库获取最新代码 # COPY --from=builder /app/graphql-engine/console /app/console ARG GIT_TAG=v1.3.2 ARG GIT_USER=docker-build ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine WORKDIR /app/graphql-engine/console # 单独提取install步骤便于缓存 RUN set -eux ; \\ npm config set sass_binary_site=https://npm.taobao.org/mirrors/node-sass \u0026\u0026 \\ npm install --registry=https://registry.npm.taobao.org # RUN npm install RUN git pull \u0026\u0026 npm run build # 开始构建 RUN set -eux ; \\ CONSOLE_ASSETS_PATH=./static/assets \u0026\u0026 \\ DIST_PATH=./static/dist \u0026\u0026 \\ ls -laR $DIST_PATH \u0026\u0026 \\ if [ ! -d \"$CONSOLE_ASSETS_PATH/common\" ]; then \\ mkdir -p $CONSOLE_ASSETS_PATH/common; \\ cp -r \"$DIST_PATH/../assets/common\" \"$CONSOLE_ASSETS_PATH\"; \\ fi; \\ rm -rf \"$CONSOLE_ASSETS_PATH/versioned\" \u0026\u0026 \\ mkdir -p \"$CONSOLE_ASSETS_PATH/versioned\" \u0026\u0026 \\ cp \"$DIST_PATH\"/*.js \"$CONSOLE_ASSETS_PATH/versioned/\" \u0026\u0026 \\ gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js \u0026\u0026 \\ # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成 cp \"$DIST_PATH\"/*.css \"$CONSOLE_ASSETS_PATH/versioned/\" || true \u0026\u0026 \\ gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true ## -- 构建最终镜像 # docker build --progress plain -t graphql-engine:20201110 ./ FROM zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123 LABEL maintainer=\"jianghanghang@geostar.com.cn\" COPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets COPY docker-entrypoint.sh /usr/local/bin/ RUN chmod +x /usr/local/bin/docker-entrypoint.sh \\ \u0026\u0026 ln -s usr/local/bin/docker-entrypoint.sh / ENTRYPOINT [\"docker-entrypoint.sh\"] 执行如下命令构建：\nTAG=$(date '+%Y%m%d') docker build -t graphql-engine:$TAG ./ ARM ### 构建 graphql-engine 镜像 ## docker build -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./ ## docker buildx build --platform=linux/arm64 -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load ## -- 构建 console # docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./ --load FROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder # 有时console代码更新，我们直接从仓库获取最新代码 # COPY --from=builder /app/graphql-engine/console /app/console ARG GIT_TAG=v1.3.2 ARG GIT_USER=docker-build ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine WORKDIR /app/graphql-engine/console # 单独提取install步骤便于缓存 RUN npm install --registry=https://registry.npm.taobao.org RUN npm run build # 开始构建 RUN set -eux ; \\ CONSOLE_ASSETS_PATH=./static/assets \u0026\u0026 \\ DIST_PATH=./static/dist \u0026\u0026 \\ ls -laR $DIST_PATH \u0026\u0026 \\ if [ ! -d \"$CONSOLE_ASSETS_PATH/common\" ]; then \\ mkdir -p $CONSOLE_ASSETS_PATH/common; \\ cp -r \"$DIST_PATH/../assets/common\" \"$CONSOLE_ASSETS_PATH\"; \\ fi; \\ rm -rf \"$CONSOLE_ASSETS_PATH/versioned\" \u0026\u0026 \\ mkdir -p \"$CONSOLE_ASSETS_PATH/versioned\" \u0026\u0026 \\ cp \"$DIST_PATH\"/*.js \"$CONSOLE_ASSETS_PATH/versioned/\" \u0026\u0026 \\ gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js \u0026\u0026 \\ # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成 cp \"$DIST_PATH\"/*.css \"$CONSOLE_ASSETS_PATH/versioned/\" || true \u0026\u0026 \\ gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true ## -- 构建最终镜像 # docker buildx build --platform=linux/arm64 --progress plain -t graphql-engine:20201110 ./ --load FROM zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2 LABEL maintainer=\"jianghanghang@geostar.com.cn\" COPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets # COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets COPY docker-entrypoint.sh /usr/local/bin/ RUN chmod +x /usr/local/bin/docker-entrypoint.sh \\ \u0026\u0026 ln -s usr/local/bin/docker-entrypoint.sh / ENTRYPOINT [\"docker-entrypoint.sh\"] 构建命令：\nTAG=$(date '+%Y%m%d') docker build -f Dockerfile-arm.dockerfile -t graphql-engine:$TAG ./ docker buildx build --platform=linux/arm64 -f Dockerfile-arm.dockerfile -t graphql-engine:arm-$TAG ./ --load 构建脚本简化(未验证) ### 构建 graphql-engine 镜像 ## docker build -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./ ## docker buildx build --platform=linux/arm64 -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load ARG base_image ## -- 构建 console # docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./ --load FROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder # 有时console代码更新，我们直接从仓库获取最新代码 # COPY --from=builder /app/graphql-engine/console /app/console ARG GIT_TAG=v1.3.2 ARG GIT_USER=docker-build ARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq RUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine WORKDIR /app/graphql-engine/console # 单独提取install步骤便于缓存 RUN npm install --registry=https://registry.npm.taobao.org RUN npm run build # 开始构建 RUN set -eux ; \\ CONSOLE_ASSETS_PATH=./static/assets \u0026\u0026 \\ DIST_PATH=./static/dist \u0026\u0026 \\ ls -laR $DIST_PATH \u0026\u0026 \\ if [ ! -d \"$CONSOLE_ASSETS_PATH/common\" ]; then \\ mkdir -p $CONSOLE_ASSETS_PATH/common; \\ cp -r \"$DIST_PATH/../assets/common\" \"$CONSOLE_ASSETS_PATH\"; \\ fi; \\ rm -rf \"$CONSOLE_ASSETS_PATH/versioned\" \u0026\u0026 \\ mkdir -p \"$CONSOLE_ASSETS_PATH/versioned\" \u0026\u0026 \\ cp \"$DIST_PATH\"/*.js \"$CONSOLE_ASSETS_PATH/versioned/\" \u0026\u0026 \\ gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js \u0026\u0026 \\ # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成 cp \"$DIST_PATH\"/*.css \"$CONSOLE_ASSETS_PATH/versioned/\" || true \u0026\u0026 \\ gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true ## -- 构建最终镜像 # docker buildx build --platform=linux/arm64 --progress plain -t graphql-engine:20201110 ./ --load FROM ${base_image} LABEL maintainer=\"jianghanghang@geostar.com.cn\" COPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets # COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets COPY docker-entrypoint.sh /usr/local/bin/ RUN chmod +x /usr/local/bin/docker-entrypoint.sh \\ \u0026\u0026 ln -s usr/local/bin/docker-entrypoint.sh / ENTRYPOINT [\"docker-entrypoint.sh\"] x86构建：\nbase_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123 TAG=$(date '+%Y%m%d') docker build ./ -t graphql-engine-base:$TAG --build-arg base_image=\"$base_image\" --build-arg arm构建\nbase_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2 TAG=$(date '+%Y%m%d') # arm 机器直接构建 docker build ./ -t graphql-engine:arm-$TAG --build-arg base_image=\"$base_image\" --build-arg # x86交叉构建 docker buildx build --platform=linux/arm64 -t graphql-engine:arm-$TAG --build-arg base_image=\"$base_image\" ./ --load GeoPanel容器化-自研服务镜像构建 前言 所有当前已经构建的服务，都可以通过gepanel-deploy 仓库中的readme进行快速导航，如：\nblockapi-token 服务镜像构建 镜像构建的相关文件目录位于 gitlab此路径，具体构建时操作步骤如下：\n王峰提供成品jar包； 放置到此目录执行docker buildx build 命令打包； 由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：\ndockerfile 打包及使用方式 blockapi-db-integrate 服务镜像构建 数据库集成服务的镜像构建相关文件位于 gitlab此路径 ，具体构建时操作步骤如下：\n韩小乐 提供成品jar或者我们自行从源码编译jar； 放置到docker构建目录使用docker buildx build命令构建； 由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：\ndockerfile 打包及使用方式 blockapi-restapi 服务镜像构建 由于之前有完成过，在此不在叙述，可参考 此gitlab目录\ngpl-datacollection 服务镜像构建 埋点系统服务镜像的构建文件位于 gitlab此路径 ，具体构建时操作步骤如下：\n王峰 提供成品jar； 放置到docker构建目录使用 docker buildx build命令构建； 由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：\ndockerfile 打包及使用方式 GeoPanel容器化-服务编排 镜像存储及分发管理 harbor 为内网基于 harbor 搭建的私有docker registry; 对于自行构建的镜像，我们只需要将镜像推送到harbor，根据配置好的自动复制规则，镜像会自动同步到阿里云私有docker镜像仓库，之后该镜像即可从阿里云镜像仓库拉取； harbor仓库可使用域账号进行登录，按项目进行读写权限控制； 阿里云的私有镜像仓库开放一个公用的只读账号，不接受手动镜像推送； 实际部署时，可根据现场的网络情况，选择使用公司仓库/阿里云仓库在线拉取，或者使用镜像批量导出脚本批量导出镜像文件，进行离线部署； GeoPanel服务名及变量命名约定 自有服务命名约定 规范服务命名能方便标识服务之间的逻辑关系，对应的服务命名会反映到集群部署中服务的名称，服务中接口/页面的基础地址，服务相关的配置变量。\n服务中应包含服务所属的模块内容缩写，如块数据api引擎为blockapi； 服务的容器编排名称，镜像名称，服务的基础服务地址，服务在整个集群中的导入或导出的配置变量名称均应保持一致性； 目前有如下几个主要服务单元：\n当前集群服务命名 服务 命名说明 块数据API引擎 命名为 blockapi ，包含以下服务：1. blockapi : 块数据api引擎服务（基础hasura graphql引擎）2. blockapi-token: 块数据api引擎扩展模块-token管理service 3. blockapi-db-integrate：块数据api引擎扩展模块-数据库集成service 4. blockapi-restapi: 块数据api引擎扩展模块-restapi service 埋点日志管理系统 命名 ： gpl-data-collection 当前各服务接口/web界面基础地址： 服务 基础地址 示例 blockapi - 保持和开源版本graphql-engine一致 blockapi-token /block-api/tks http://192.168.43.73:8881/block-api/tks blockapi-db-integrate /block-api/db-intgrs http://192.168.43.73:8882/block-api/db-intgrs blockapi-restapi /block-api/restapi http://172.17.0.105:8884/block-api/restapi gpl-data-collection /gpl-dc http://192.168.43.73:8883/gpl-dc 通用变量说明 概述 在服务部署时，我们使用环境变量来为各个服务提供需要的配置，以下通用变量用于减少服务部署时所需要的变量，大致按以下原则：\n相同含义的变量尽量统一为一个 有可能内部和外部用途的服务使用两个变量区分开来 变量命名需要带上服务名前缀 外部URL和内部URL说明：（下方部分服务会导出内部和外部两个url的变量）\n内部URL：在docker集群内部，可以使用服务名替代IP地址访问对应的服务，一般用于服务内部之间互相访问；（如使用内部URL，在部署时可不需要修改配置） 外部URL：当服务需要给客户端（如APP或浏览器）或不属于我方服务集群的其他服务调用时，需要提供外部的IP（非docker集群内部）给外部访问； 服务 变量名 说明及示例值 springboot变量名 postgres zookeeper 暂未供外部使用，不导出变量 kafka kafka 内部地址KAFKA_INTERNAL_URL kafka:9092 kafka.internal_url kafka 外部地址KAFKA_EXTERNAL_URL 192.168.43.22:9094 kafka.external_url redis Redis服务主机REDIS_HOST redis redis.host Redis服务端口REDIS_PORT 6379 redis.port Redis服务访问密码REDIS_PASSWORD vsMEDgmxZdjOi7Nd redis.password blockapi 块数据API引擎数据库地址HASURA_GRAPHQL_DATABASE_URLBLOCKAPI_DATABASE_URL postgres://postgres:d8cfe3137214759a932014084ac410b9@postgres:5432/hasura blockapi.database_url 块数据API引擎管理密钥HASURA_GRAPHQL_ADMIN_SECRETBLOCKAPI_ADMIN_SECRET d8cfe3137214759a932014084ac410b9两个变量含义一致，优先使用 BLOCKAPI_ADMIN_SECRET blockapi.admin_secert 块数据API引擎内部地址BLOCKAPI_INTERNAL_URL http://graphql-engine:8080 blockapi.internal_url 块数据API引擎的外部地址BLOCKAPI_EXTERNAL_URL http://192.168.43.22:8883 blockapi.external_url blockapi-token 块数据API引擎token管理服务内部接口地址BLOCKAPI_TOKEN_INTERNAL_URL http://blockapi-token:9099/block-api/tks blockapi.token.internal_url 块数据API引擎token管理服务外部接口地址BLOCKAPI_TOKEN_EXTERNAL_URL http://192.168.43.73:8881/block-api/tks blockapi.token.external_url blockapi-db-integrate 块数据API引擎数据库集成服务外部接口地址BLOCKAPI_DATABASE_INTEGRATE_EXTERNAL_URL http://192.168.43.73:8882/block-api/db-intgrs blockapi.database_intergrate.external_url gpl-data-collection 埋点系统服务地址，暂未供外部使用，但提供预定义2个变量GPL_DATACOLLECTION_INTERNAL_URL gpl_datacollection.internal_url GPL_DATACOLLECTION_EXTERNAL_URL gpl_datacollection.external_url 在springboot中使用变量 待补充\n当前服务编排策略 当前将所有已经容器化的服务划分为如下服务部署单元：\ngraph LR G[GeoPanel] --\u003e B G --\u003e K G --\u003e GPL_DC B[blockapi] --\u003e blockapi-engine B --\u003e postgres B --\u003e redis B --\u003e blockapi-token B --\u003e blockapi-db-integrate B --\u003e blockapi-restapi K[kafka] --\u003e kafka K --\u003e zookeeper GPL_DC[gpl-datacollection] --\u003e gpl-datacollection 目前分为三块（blockapi，kafka，gpl-datacollection），每个模块分别对应一个swarm的部署yml配置，可以单独进行启动，使用相同的stack名称启动后，则可以进入一个stack中；\n部署仓库地址位于gitlab上。\n当前部署仓库细节说明 . ├── README.md -- 文档说明 ├── blockapi -- 块数据api引擎的部署配置所在目录 │ ├── README.md -- 块数据api引擎的配置及启动说明文档 │ ├── config.env -- 单独的配置文件，目前未使用 │ ├── db-init - 数据库初始化脚本，仅做备份，目前未使用 │ │ ├── 00_fdws.sh │ │ ├── 10_postgis.sh │ │ └── 20_gpl_data_collection.sql │ ├── docker-compose-arm.yml -- arm版本的部署配置文件 │ ├── docker-compose.yml -- x86版本的部署配置文件 │ └── redis-config -- redis 配置 │ └── redis.conf ├── data -- 数据挂载目录 │ └── redis ├── deploy.sh -- 辅助部署脚本 ├── env -- 全局配置目录 │ └── global.env -- 全局配置，包含所有配置项目，如可能有需要使用公共配置的，服务都应该在yml中声明时引用此配置 ├── gpl-datacollection -- 埋点管理系统部署配置目录 │ ├── README.md -- 埋点系统的配置修改及启动方式说明文档 │ ├── config.env -- 埋点系统的单独的配置文件，目前未使用 │ └── docker-compose.yml --埋点系统的部署启动配置文件 ├── kafka -- kafka的部署配置目录 │ ├── README.md -- kafka服务说明，kafka验证方式说明 │ └── docker-compose.yml -- 部署配置文件 总的来说，目前有如下结构设计：\n按逻辑相关性将服务进行一定的划分，一个单元的服务的部署相关文件及配置在一个部署目录中单独存储，使用一个docker-compose.yml文件来编排，可以单独启动； 使用一个 env/global.env 文件来存放所有需要修改的配置及全局配置/需要共享的配置-以方便部署时统一修改，每个部署单元中预留一个.env文件-用于存放私有配置，只是目前都没有使用； 提供了一个 deploy.sh 的辅助部署脚本用于简化部署步骤，但此脚本目前并不够完善； 每个部署目录提供README.md单独对当前目录中的部署单元进行说明，一般应包含配置修改说明，部署启动说明，启动成功确认方式，数据挂载情况说明，根据具体情况也可以提供简单的测试步骤； 对于各个部署单元的部署文件，不再单独说明，请参考仓库中的yml部署文件及readme\n","wordCount":"7129","inLanguage":"en","datePublished":"2021-04-08T15:10:06Z","dateModified":"2021-04-08T15:10:06Z","author":{"@type":"Person","name":"野生莲藕"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanlyjiang.github.io/posts/geopanel-rong-qi-hua/"},"publisher":{"@type":"Organization","name":"清水池塘","logo":{"@type":"ImageObject","url":"https://hanlyjiang.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hanlyjiang.github.io/ accesskey=h title="清水池塘 (Alt + H)">清水池塘</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hanlyjiang.github.io/ title=首页><span><i class='fas fa-home'></i>首页</span></a></li><li><a href=https://hanlyjiang.github.io/archives/ title=归档><span><i class='fas fa-tags'></i>归档</span></a></li><li><a href=https://hanlyjiang.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://hanlyjiang.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hanlyjiang.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://hanlyjiang.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">GeoPanel容器化</h1><div class=post-meta><span title='2021-04-08 15:10:06 +0000 UTC'>April 8, 2021</span>&nbsp;·&nbsp;<span>34 min</span>&nbsp;·&nbsp;<span>7129 words</span>&nbsp;·&nbsp;<span>野生莲藕</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#geopanel%e5%ae%b9%e5%99%a8%e5%8c%96%e6%a6%82%e8%a7%88 aria-label=GeoPanel容器化概览>GeoPanel容器化概览</a></li><li><a href=#geopanel%e5%ae%b9%e5%99%a8%e5%8c%96-arm%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba-%e9%80%9a%e7%94%a8%e6%ad%a5%e9%aa%a4 aria-label=GeoPanel容器化-ARM镜像构建-通用步骤>GeoPanel容器化-ARM镜像构建-通用步骤</a><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e6%b5%8b%e8%af%95%e6%9c%ba%e4%bf%a1%e6%81%af aria-label=测试机信息>测试机信息</a></li><li><a href=#arm%e6%9c%ba%e5%99%a8%e4%b8%8a%e5%ae%89%e8%a3%85docker aria-label=ARM机器上安装Docker>ARM机器上安装Docker</a><ul><li><a href=#%e6%9f%a5%e7%9c%8b%e7%b3%bb%e7%bb%9f%e4%bf%a1%e6%81%af aria-label=查看系统信息>查看系统信息</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e8%bd%af%e4%bb%b6%e6%ba%90 aria-label=添加软件源>添加软件源</a></li><li><a href=#%e5%ae%89%e8%a3%85docker aria-label=安装Docker>安装Docker</a></li></ul></li><li><a href=#%e5%9c%a8dockerhub%e4%b8%8a%e6%9f%a5%e6%89%be%e5%b7%b2%e6%9c%89%e7%9a%84arm%e9%95%9c%e5%83%8f aria-label=在Dockerhub上查找已有的arm镜像>在Dockerhub上查找已有的arm镜像</a></li><li><a href=#arm%e7%89%88%e6%9c%ac%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e9%9d%9earm%e6%9c%ba%e5%99%a8%e4%b8%8a%e6%89%a7%e8%a1%8c aria-label=ARM版本镜像构建（非ARM机器上执行）>ARM版本镜像构建（非ARM机器上执行）</a><ul><li><a href=#%e6%9e%84%e5%bb%baarm%e9%95%9c%e5%83%8f%e7%9a%84%e4%b8%a4%e7%a7%8d%e6%96%b9%e5%bc%8f aria-label=构建ARM镜像的两种方式>构建ARM镜像的两种方式</a></li><li><a href=#%e5%90%af%e7%94%a8%e8%af%95%e9%aa%8c%e6%80%a7%e5%8a%9f%e8%83%bd aria-label=启用试验性功能>启用试验性功能</a></li><li><a href=#%e4%bd%bf%e7%94%a8buildx%e6%9e%84%e5%bb%ba aria-label=使用buildx构建>使用buildx构建</a><ul><li><a href=#%e5%88%9b%e5%bb%ba-buildx-%e6%9e%84%e5%bb%ba%e5%99%a8 aria-label="创建 buildx 构建器">创建 buildx 构建器</a></li></ul></li><li><a href=#%e4%bf%ae%e6%94%b9dockerfile aria-label=修改Dockerfile>修改Dockerfile</a></li><li><a href=#docker-buildx-%e6%9e%84%e5%bb%baarm64%e9%95%9c%e5%83%8f%e7%9a%84%e5%91%bd%e4%bb%a4 aria-label="docker buildx 构建arm64镜像的命令">docker buildx 构建arm64镜像的命令</a></li><li><a href=#%e6%a3%80%e6%9f%a5%e6%9e%84%e5%bb%ba%e6%88%90%e6%9e%9c aria-label=检查构建成果>检查构建成果</a></li></ul></li><li><a href=#%e5%9c%a8x86%e4%b8%8a%e8%bf%90%e8%a1%8carm%e9%95%9c%e5%83%8f aria-label=在x86上运行arm镜像>在x86上运行arm镜像</a></li></ul></li><li><a href=#geopanel%e5%ae%b9%e5%99%a8%e5%8c%96-pgspider%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=GeoPanel容器化-PGspider镜像构建>GeoPanel容器化-PGspider镜像构建</a><ul><li><a href=#%e6%a6%82%e8%a7%88 aria-label=概览>概览</a><ul><li><a href=#%e9%95%9c%e5%83%8f%e9%9c%80%e8%a6%81%e5%8c%85%e6%8b%ac%e7%9a%84%e7%bb%84%e4%bb%b6 aria-label=镜像需要包括的组件：>镜像需要包括的组件：</a></li><li><a href=#%e6%95%b4%e4%bd%93%e6%9e%84%e5%bb%ba%e6%b5%81%e7%a8%8b aria-label=整体构建流程>整体构建流程</a></li><li><a href=#%e7%8e%b0%e5%9c%a8%e6%88%90%e6%9e%9c%e4%bb%93%e5%ba%93 aria-label=现在成果仓库>现在成果仓库</a></li></ul></li><li><a href=#builder%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=builder镜像构建>builder镜像构建</a><ul><li><a href=#%e6%89%93%e5%8c%85%e5%91%bd%e4%bb%a4 aria-label=打包命令>打包命令</a></li><li><a href=#%e8%84%9a%e6%9c%ac%e8%af%a6%e8%a7%a3 aria-label=脚本详解>脚本详解</a></li></ul></li><li><a href=#base%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=base镜像构建>base镜像构建</a><ul><li><a href=#%e6%89%93%e5%8c%85%e5%91%bd%e4%bb%a4-1 aria-label=打包命令>打包命令</a></li><li><a href=#%e8%84%9a%e6%9c%ac%e8%af%a6%e8%a7%a3-1 aria-label=脚本详解>脚本详解</a></li></ul></li><li><a href=#pgspider%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=pgspider镜像构建>pgspider镜像构建</a><ul><li><a href=#%e6%9e%84%e5%bb%ba%e5%91%bd%e4%bb%a4 aria-label=构建命令>构建命令</a></li><li><a href=#%e8%84%9a%e6%9c%ac%e8%af%a6%e8%a7%a3-2 aria-label=脚本详解>脚本详解</a><ul><li><a href=#x86-%e6%9e%84%e5%bb%ba%e8%84%9a%e6%9c%ac aria-label="x86 构建脚本">x86 构建脚本</a></li></ul></li><li><a href=#arm%e7%89%88%e6%9c%ac%e6%9e%84%e5%bb%ba%e8%84%9a%e6%9c%ac aria-label=ARM版本构建脚本>ARM版本构建脚本</a></li></ul></li><li><a href=#%e9%95%9c%e5%83%8f%e6%b5%8b%e8%af%95%e5%8f%8a%e4%bd%bf%e7%94%a8 aria-label=镜像测试及使用>镜像测试及使用</a></li><li><a href=#%e5%8f%af%e4%bc%98%e5%8c%96%e9%83%a8%e5%88%86 aria-label=可优化部分>可优化部分</a></li></ul></li><li><a href=#geopanel%e5%ae%b9%e5%99%a8%e5%8c%96-hasura%e5%8d%b3%e5%9d%97%e6%95%b0%e6%8d%aeapi%e5%bc%95%e6%93%8e%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=GeoPanel容器化-hasura即块数据API引擎镜像构建>GeoPanel容器化-hasura即块数据API引擎镜像构建</a><ul><li><a href=#hasura%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e6%a6%82%e8%a7%88 aria-label=Hasura镜像构建概览>Hasura镜像构建概览</a><ul><li><a href=#hasura-%e6%98%af%e4%bb%80%e4%b9%88 aria-label="hasura 是什么？">hasura 是什么？</a></li><li><a href=#%e6%88%91%e4%bb%ac%e5%81%9a%e7%9a%84%e4%bf%ae%e6%94%b9 aria-label=我们做的修改>我们做的修改</a></li><li><a href=#%e7%9b%ae%e6%a0%87%e5%8f%8a%e6%88%90%e6%9e%9c aria-label=目标及成果>目标及成果</a></li><li><a href=#hasura%e6%95%b4%e4%bd%93%e7%bb%93%e6%9e%84 aria-label=hasura整体结构>hasura整体结构</a></li><li><a href=#%e6%95%b4%e4%bd%93%e6%9e%84%e5%bb%ba%e6%b5%81%e7%a8%8b%e6%a2%b3%e7%90%86 aria-label=整体构建流程梳理>整体构建流程梳理</a><ul><li><a href=#%e4%bb%a3%e7%a0%81%e7%bb%93%e6%9e%84%e8%af%b4%e6%98%8e aria-label=代码结构说明>代码结构说明</a></li><li><a href=#graphql-engine-console aria-label="graphql-engine console">graphql-engine console</a></li><li><a href=#graphql-engine-server aria-label="graphql-engine server">graphql-engine server</a></li><li><a href=#%e6%95%b4%e4%bd%93%e6%9e%84%e5%bb%ba%e6%b5%81%e7%a8%8b-1 aria-label=整体构建流程>整体构建流程</a></li></ul></li></ul></li><li><a href=#graphql-engine-builder-%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="graphql-engine-builder 镜像构建">graphql-engine-builder 镜像构建</a><ul><li><a href=#x86-dockerfile aria-label="X86 Dockerfile">X86 Dockerfile</a></li><li><a href=#arm-dockerfile aria-label="ARM Dockerfile">ARM Dockerfile</a></li></ul></li><li><a href=#graphql-engine-packager-%e6%9e%84%e5%bb%ba aria-label="graphql-engine-packager 构建">graphql-engine-packager 构建</a><ul><li><a href=#%e6%95%b4%e4%bd%93%e8%af%b4%e6%98%8e aria-label=整体说明>整体说明</a></li><li><a href=#x86%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=X86镜像构建>X86镜像构建</a></li><li><a href=#arm aria-label=ARM>ARM</a><ul><li><a href=#haskell-docker-packager-%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="haskell-docker-packager 镜像构建">haskell-docker-packager 镜像构建</a></li><li><a href=#graphql-engine-packager-%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="graphql-engine-packager 镜像构建">graphql-engine-packager 镜像构建</a></li></ul></li></ul></li><li><a href=#graphql-engine-base-%e6%9e%84%e5%bb%ba aria-label="graphql-engine-base 构建">graphql-engine-base 构建</a><ul><li><a href=#x86%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba-1 aria-label=X86镜像构建>X86镜像构建</a></li><li><a href=#arm%e7%89%88%e6%9c%ac%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=ARM版本镜像构建>ARM版本镜像构建</a></li><li><a href=#%e6%9e%84%e5%bb%ba%e8%84%9a%e6%9c%ac%e5%90%88%e5%b9%b6%e7%ae%80%e5%8c%96%e6%9c%aa%e9%aa%8c%e8%af%81 aria-label=构建脚本合并简化（未验证）>构建脚本合并简化（未验证）</a></li></ul></li><li><a href=#graphql-engine-%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="graphql-engine 镜像构建">graphql-engine 镜像构建</a><ul><li><a href=#x86 aria-label=X86>X86</a></li><li><a href=#arm-1 aria-label=ARM>ARM</a></li><li><a href=#%e6%9e%84%e5%bb%ba%e8%84%9a%e6%9c%ac%e7%ae%80%e5%8c%96%e6%9c%aa%e9%aa%8c%e8%af%81 aria-label=构建脚本简化(未验证)>构建脚本简化(未验证)</a></li></ul></li></ul></li><li><a href=#geopanel%e5%ae%b9%e5%99%a8%e5%8c%96-%e8%87%aa%e7%a0%94%e6%9c%8d%e5%8a%a1%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label=GeoPanel容器化-自研服务镜像构建>GeoPanel容器化-自研服务镜像构建</a><ul><li><a href=#%e5%89%8d%e8%a8%80-1 aria-label=前言>前言</a></li><li><a href=#blockapi-token-%e6%9c%8d%e5%8a%a1%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="blockapi-token 服务镜像构建">blockapi-token 服务镜像构建</a></li><li><a href=#blockapi-db-integrate-%e6%9c%8d%e5%8a%a1%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="blockapi-db-integrate 服务镜像构建">blockapi-db-integrate 服务镜像构建</a></li><li><a href=#blockapi-restapi-%e6%9c%8d%e5%8a%a1%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="blockapi-restapi 服务镜像构建">blockapi-restapi 服务镜像构建</a></li><li><a href=#gpl-datacollection-%e6%9c%8d%e5%8a%a1%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba aria-label="gpl-datacollection 服务镜像构建">gpl-datacollection 服务镜像构建</a></li></ul></li><li><a href=#geopanel%e5%ae%b9%e5%99%a8%e5%8c%96-%e6%9c%8d%e5%8a%a1%e7%bc%96%e6%8e%92 aria-label=GeoPanel容器化-服务编排>GeoPanel容器化-服务编排</a><ul><li><a href=#%e9%95%9c%e5%83%8f%e5%ad%98%e5%82%a8%e5%8f%8a%e5%88%86%e5%8f%91%e7%ae%a1%e7%90%86 aria-label=镜像存储及分发管理>镜像存储及分发管理</a></li><li><a href=#geopanel%e6%9c%8d%e5%8a%a1%e5%90%8d%e5%8f%8a%e5%8f%98%e9%87%8f%e5%91%bd%e5%90%8d%e7%ba%a6%e5%ae%9a aria-label=GeoPanel服务名及变量命名约定>GeoPanel服务名及变量命名约定</a><ul><li><a href=#%e8%87%aa%e6%9c%89%e6%9c%8d%e5%8a%a1%e5%91%bd%e5%90%8d%e7%ba%a6%e5%ae%9a aria-label=自有服务命名约定>自有服务命名约定</a><ul><li><a href=#%e5%bd%93%e5%89%8d%e9%9b%86%e7%be%a4%e6%9c%8d%e5%8a%a1%e5%91%bd%e5%90%8d aria-label=当前集群服务命名>当前集群服务命名</a></li><li><a href=#%e5%bd%93%e5%89%8d%e5%90%84%e6%9c%8d%e5%8a%a1%e6%8e%a5%e5%8f%a3web%e7%95%8c%e9%9d%a2%e5%9f%ba%e7%a1%80%e5%9c%b0%e5%9d%80 aria-label=当前各服务接口/web界面基础地址：>当前各服务接口/web界面基础地址：</a></li></ul></li><li><a href=#%e9%80%9a%e7%94%a8%e5%8f%98%e9%87%8f%e8%af%b4%e6%98%8e aria-label=通用变量说明>通用变量说明</a><ul><li><a href=#%e6%a6%82%e8%bf%b0 aria-label=概述>概述</a></li><li><a href=#%e5%9c%a8springboot%e4%b8%ad%e4%bd%bf%e7%94%a8%e5%8f%98%e9%87%8f aria-label=在springboot中使用变量>在springboot中使用变量</a></li></ul></li></ul></li><li><a href=#%e5%bd%93%e5%89%8d%e6%9c%8d%e5%8a%a1%e7%bc%96%e6%8e%92%e7%ad%96%e7%95%a5 aria-label=当前服务编排策略>当前服务编排策略</a></li><li><a href=#%e5%bd%93%e5%89%8d%e9%83%a8%e7%bd%b2%e4%bb%93%e5%ba%93%e7%bb%86%e8%8a%82%e8%af%b4%e6%98%8e aria-label=当前部署仓库细节说明>当前部署仓库细节说明</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=geopanel容器化概览>GeoPanel容器化概览<a hidden class=anchor aria-hidden=true href=#geopanel容器化概览>#</a></h1><p>此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。</p><p>主要包括如下部分：</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph 

GeoPanel[GeoPanel容器化]
GeoPanel --&gt; pgspider打包
GeoPanel --&gt; hasura-块数据API引擎
GeoPanel --&gt; 公司自研镜像打包
GeoPanel --&gt; 服务编排
</code></pre><ul><li>由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出；</li><li>公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说；</li><li>服务编排中描述当前已经容器化的服务及使用swarm编排的情况；</li></ul><h1 id=geopanel容器化-arm镜像构建-通用步骤>GeoPanel容器化-ARM镜像构建-通用步骤<a hidden class=anchor aria-hidden=true href=#geopanel容器化-arm镜像构建-通用步骤>#</a></h1><p>这里的国产化主要指：制作arm版本的镜像</p><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；</p><ol><li>ARM 版本Docker安装；</li><li>构建所有镜像的ARM版本；</li></ol><h2 id=测试机信息>测试机信息<a hidden class=anchor aria-hidden=true href=#测试机信息>#</a></h2><table><thead><tr><th style=text-align:left>CPU</th><th style=text-align:left>FT-1500A 4核 arm64</th></tr></thead><tbody><tr><td style=text-align:left>内存</td><td style=text-align:left>8G</td></tr><tr><td style=text-align:left>OS</td><td style=text-align:left>麒麟V10</td></tr><tr><td style=text-align:left>包管理器</td><td style=text-align:left>apt</td></tr></tbody></table><h2 id=arm机器上安装docker>ARM机器上安装Docker<a hidden class=anchor aria-hidden=true href=#arm机器上安装docker>#</a></h2><blockquote><p><a href="https://docs.docker.com/engine/install/?fileGuid=0l3NVKX0BgflYN3R">Docker官方文档</a></p></blockquote><p>Docker支持如下系统及架构</p><p><img alt=图片 loading=lazy src="https://uploader.shimo.im/f/EgAMxl7X6CbHg4J9.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R"></p><p>国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按<a href="https://docs.docker.com/engine/install/ubuntu/?fileGuid=0l3NVKX0BgflYN3R">官方文档- Install Docker Engine on Ubuntu</a>进行安装。</p><h3 id=查看系统信息>查看系统信息<a hidden class=anchor aria-hidden=true href=#查看系统信息>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>geostar@geostar-ft1500a:~$ cat /proc/version
</span></span><span style=display:flex><span>Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
</span></span></code></pre></div><p>这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源</p><h3 id=添加软件源>添加软件源<a hidden class=anchor aria-hidden=true href=#添加软件源>#</a></h3><blockquote><p>参考：
<a href=https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/>https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a>
<a href=https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/>https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/</a></p></blockquote><p>添加清华镜像软件源（arm架构）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
</span></span></code></pre></div><p>更新：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>sudo apt-get install apt-transport-https
</span></span><span style=display:flex><span>sudo apt-get clean
</span></span><span style=display:flex><span>sudo apt-get update
</span></span></code></pre></div><h3 id=安装docker>安装Docker<a hidden class=anchor aria-hidden=true href=#安装docker>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># 卸载旧版本docker
</span></span><span style=display:flex><span>sudo apt-get remove docker docker-engine docker.io containerd runc
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install \
</span></span><span style=display:flex><span>    apt-transport-https \
</span></span><span style=display:flex><span>    ca-certificates \
</span></span><span style=display:flex><span>    curl \
</span></span><span style=display:flex><span>    gnupg-agent \
</span></span><span style=display:flex><span>    software-properties-common
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</span></span><span style=display:flex><span># 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88)
</span></span><span style=display:flex><span>sudo apt-key fingerprint 0EBFCD88
</span></span></code></pre></div><p>编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># https://docs.docker.com/engine/install/ubuntu/
</span></span><span style=display:flex><span>deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable
</span></span></code></pre></div><p>安装 docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span># 安装Docker
</span></span><span style=display:flex><span>sudo apt-get install docker-ce docker-ce-cli containerd.io
</span></span><span style=display:flex><span># 安装成功，查看版本
</span></span><span style=display:flex><span>docker --version
</span></span><span style=display:flex><span>Docker version 19.03.12, build 48a6621
</span></span></code></pre></div><h2 id=在dockerhub上查找已有的arm镜像>在Dockerhub上查找已有的arm镜像<a hidden class=anchor aria-hidden=true href=#在dockerhub上查找已有的arm镜像>#</a></h2><p>实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以<a href="https://hub.docker.com/_/postgres?fileGuid=0l3NVKX0BgflYN3R">postgres</a>为例，在dockerhub上可以看到</p><p><img alt=图片 loading=lazy src="https://uploader.shimo.im/f/mEUtglSoqQESjJXs.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R"></p><p>在具体的tag中也可以看到版本的镜像是否支持arm架构</p><p><img alt=图片 loading=lazy src="https://uploader.shimo.im/f/nUbvEcHQlUFCmAkl.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R"></p><p>但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。</p><h2 id=arm版本镜像构建非arm机器上执行>ARM版本镜像构建（非ARM机器上执行）<a hidden class=anchor aria-hidden=true href=#arm版本镜像构建非arm机器上执行>#</a></h2><blockquote><p>参考：
-<a href="https://github.com/docker/cli/blob/master/experimental/README.md?fileGuid=0l3NVKX0BgflYN3R">https://github.com/docker/cli/blob/master/experimental/README.md</a>
-<a href="https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R">跨平台构建 Docker 镜像新姿势，x86、arm 一把梭</a></p></blockquote><h3 id=构建arm镜像的两种方式>构建ARM镜像的两种方式<a hidden class=anchor aria-hidden=true href=#构建arm镜像的两种方式>#</a></h3><p>对于构建镜像的ARM版本，有如下两种方式：</p><ol><li>在ARM机器上使用 docker build 进行构建；</li><li>在X86/AMD64 的机器上使用 docker buildx 进行交叉构建；</li></ol><p>实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；</p><p>关于第二种构建方式，可先阅读<a href="https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R">跨平台构建 Docker 镜像新姿势，x86、arm 一把梭</a>进行了解，以下简要介绍使用buildx交叉构建的方式；</p><blockquote><p><strong>⚠️注意：</strong></p><ol><li><p>交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；</p></li><li><p>实际测试发现，使用<a href=https://github.com/multiarch/qemu-user-static>qemu方式</a>在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；</p><p>上面第二点按如下方式测试：</p><ul><li><code>docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch</code> 可正常输出；</li><li><code>docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version</code> 则会<strong>卡住</strong>，且需要使用<code>docker stop</code>停止容器才可以退出容器；</li></ul></li></ol></blockquote><h3 id=启用试验性功能>启用试验性功能<a hidden class=anchor aria-hidden=true href=#启用试验性功能>#</a></h3><blockquote><p>参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features
注意：buildx 仅支持 docker19.03 及以上docker版本</p></blockquote><p>如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：</p><ul><li>编辑 /etc/docker/daemon.json</li><li>添加：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;experimental&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>编辑 ～/.docker/config.json 添加：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;experimental&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;enabled&#34;</span>
</span></span></code></pre></div><ul><li>重启Docker使生效：<ul><li>sudo systemctl daemon-reload</li><li>sudo systemctl restart docker</li></ul></li><li>确认是否开启：<ul><li>docker version -f&rsquo;{{.Server.Experimental}}'</li><li>如果输出true，则表示开启成功</li></ul></li></ul><h3 id=使用buildx构建>使用buildx构建<a hidden class=anchor aria-hidden=true href=#使用buildx构建>#</a></h3><p>buildx 的详细使用可参考：<a href="https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R">Docker官方文档-Reference-buildx</a></p><h4 id=创建-buildx-构建器>创建 buildx 构建器<a hidden class=anchor aria-hidden=true href=#创建-buildx-构建器>#</a></h4><p>使用 docker buildx ls 命令查看现有的构建器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker buildx ls
</span></span></code></pre></div><p>创建并构建器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 下面的创建命令任选一条符合情况的即可</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 不指定任何参数创建</span>
</span></span><span style=display:flex><span>docker buildx create --use --name multiarch-builder
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令</span>
</span></span><span style=display:flex><span>docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 </span>
</span></span><span style=display:flex><span>docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network<span style=color:#f92672>=</span>host --config<span style=color:#f92672>=</span>/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder 
</span></span></code></pre></div><p>buildx-config.toml 配置文件写法类似：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md
</span></span><span style=display:flex><span># registry configures a new Docker register used for cache import or output.
</span></span><span style=display:flex><span>[registry.&#34;zh-registry.geostar.com.cn&#34;]
</span></span><span style=display:flex><span>  mirrors = [&#34;zh-registry.geostar.com.cn&#34;]
</span></span><span style=display:flex><span>  http = true
</span></span><span style=display:flex><span>  insecure = true
</span></span></code></pre></div><p><strong>启用构建器</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 初始化并激活</span>
</span></span><span style=display:flex><span>docker buildx inspect multiarch-builder --bootstrap
</span></span></code></pre></div><p><strong>确认成功</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># 使用 docker buildx ls 查看
</span></span><span style=display:flex><span>docker buildx ls 
</span></span></code></pre></div><h3 id=修改dockerfile>修改Dockerfile<a hidden class=anchor aria-hidden=true href=#修改dockerfile>#</a></h3><p>对 Dockerfile 的修改，大致需要进行如下操作：</p><ol><li>确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译；</li><li>确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件</li></ol><p><code>ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz</code></p><p>此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：</p><p><code>ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz</code></p><p>当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；</p><blockquote><p><strong>提示：</strong></p><p>怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 <code>file {可执行文件路径}</code> 来查看，</p><p>如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-<code>x86_64&amp;arm64e</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>file <span style=color:#66d9ef>$(</span>which git<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>/usr/bin/git: Mach-O universal binary with <span style=color:#ae81ff>2</span> architectures: <span style=color:#f92672>[</span>x86_64:Mach-O 64-bit executable x86_64<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>arm64e:Mach-O 64-bit executable arm64e<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/usr/bin/git <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> architecture x86_64<span style=color:#f92672>)</span>:	Mach-O 64-bit executable x86_64
</span></span><span style=display:flex><span>/usr/bin/git <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> architecture arm64e<span style=color:#f92672>)</span>:	Mach-O 64-bit executable arm64e
</span></span></code></pre></div><p>下面的命令则对一个so文件执行了file，可以看到其中的架构信息 <code>ARM aarch64</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>file /lib/aarch64-linux-gnu/libpthread-2.23.so
</span></span><span style=display:flex><span>/lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>GNU/Linux<span style=color:#f92672>)</span>, dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>880365ebb22114e4c10108b73243144d5fa315dc, <span style=color:#66d9ef>for</span> GNU/Linux 3.7.0, not stripped
</span></span></code></pre></div></blockquote><h3 id=docker-buildx-构建arm64镜像的命令>docker buildx 构建arm64镜像的命令<a hidden class=anchor aria-hidden=true href=#docker-buildx-构建arm64镜像的命令>#</a></h3><p>使用 &ndash;platform来指定架构，使用 <code>--push</code> 或 <code>--load</code> 来指定构建完毕后的动作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64,linux/amd64 -t xxxx:tag . --push 
</span></span></code></pre></div><blockquote><p>提示：当指定多个架构时，只能使用 &ndash;push 推送到远程仓库，无法 &ndash;load，推送成功后再通过 docker pull &ndash;platform 来拉取指定架构的镜像</p></blockquote><h3 id=检查构建成果>检查构建成果<a hidden class=anchor aria-hidden=true href=#检查构建成果>#</a></h3><ol><li>通过 <code>docker buildx imagetools inspect</code> 命令查看镜像信息，看是否有对应的arm架构信息；</li><li>实际运行镜像，确认运行正常；（在arm机器上执行）</li></ol><blockquote><p>提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。</p></blockquote><h2 id=在x86上运行arm镜像>在x86上运行arm镜像<a hidden class=anchor aria-hidden=true href=#在x86上运行arm镜像>#</a></h2><p>可参考 <a href=https://github.com/multiarch/qemu-user-static>github/qemu-user-static</a> ,简要描述如下：</p><ul><li><p>执行如下命令安装：</p><p><code>docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</code></p></li><li><p>之后即可运行arm版本的镜像，如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -t arm64v8/fedora uname -m
</span></span></code></pre></div></li></ul><h1 id=geopanel容器化-pgspider镜像构建>GeoPanel容器化-PGspider镜像构建<a hidden class=anchor aria-hidden=true href=#geopanel容器化-pgspider镜像构建>#</a></h1><h2 id=概览>概览<a hidden class=anchor aria-hidden=true href=#概览>#</a></h2><p>postgreSQL是一个开源的对象-关系型数据库管理系统，本身提供了x86及arm版本的镜像，那么我们为什么要自己构建对应呢？</p><p>因为我们需要使用<a href=https://github.com/pgspider/pgspider>pgspider</a>，它是给予pg11.6的代码补丁包，所以我们无法直接复用官方的镜像作为基础镜像；</p><p>同时，我们还添加了许多pg的插件用于扩展pg的能力，如此，我们必须自行打包pg镜像；</p><h3 id=镜像需要包括的组件>镜像需要包括的组件：<a hidden class=anchor aria-hidden=true href=#镜像需要包括的组件>#</a></h3><table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td>postgis11.6</td><td>postgreSQL</td></tr><tr><td>pgspider</td><td>postgreSQL源码补丁，增强FDW功能</td></tr><tr><td>postgis2.5.3及其依赖</td><td>postgres gis 插件，用于提供geometry相关支持</td></tr><tr><td>postgres_fdw</td><td>postgres_fdw 接入外部postgres数据源</td></tr><tr><td>sqlite_fdw</td><td>sqlite_fdw 接入外部sqlite数据源</td></tr><tr><td>mysql_fdw</td><td>mysql_fdw 接入外部mysql数据源</td></tr><tr><td>oracle_fdw</td><td>oracle_fdw 接入外部oracle数据源</td></tr><tr><td>zdb(es_fdw)</td><td>es_fdw 接入外部es数据源</td></tr><tr><td>debezium</td><td>数据库事件转为事件流，配合kafka使用，实现数据实时同步</td></tr><tr><td>wal2json</td><td>pg 日志格式转换插件，配合debezium使用，以json格式推送事件流</td></tr></tbody></table><h3 id=整体构建流程>整体构建流程<a hidden class=anchor aria-hidden=true href=#整体构建流程>#</a></h3><p>为了构建此镜像，我们制作了若干辅助镜像，包括：</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph 
builder

pgspider-base

postgis-pgspider
</code></pre><p>其中:</p><ul><li><code>builder</code> 镜像为我们的构建器镜像，用做pgspider的编译环境，其中包含pg11.6源码及pgspider源码，及编译好的pg及pgspider，但是我们并未对成果物进行提取，因为此进行要保留所有构建环境，用于后续其他我们附加到pg的插件的构建；</li><li><code>pgspider-base</code> 镜像中安装postgres运行所需要的若干依赖，作为最终镜像构建的基础，避免每次构建镜像都需要执行重复的依赖安装操作；</li><li><code>postgis-pgspider</code> 为我们的最终镜像；基于<code>pgspider-base</code>镜像制作，并合并我们使用 <code>builder</code> 镜像构建的所有需要的成果文件；</li></ul><p>接下来我们详细说明以上几个镜像分别如何构建。</p><h3 id=现在成果仓库>现在成果仓库<a hidden class=anchor aria-hidden=true href=#现在成果仓库>#</a></h3><p>Gitlab仓库地址：<a href=http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider>geopanel-deploy</a></p><blockquote><p>提示： 可查看<a href=http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider>仓库目录中的README.md</a> 了解更多信息；</p></blockquote><p>目录结构如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pgspider
</span></span><span style=display:flex><span>    ├── Dockerfile-base.dockerfile - 构建pgspider-base镜像的脚本
</span></span><span style=display:flex><span>    ├── Dockerfile-builder.dockerfile - 构建pgspider-builder镜像的脚本
</span></span><span style=display:flex><span>    ├── Dockerfile-source-arm-add.dockerfile - 构建postgis-pgspider镜像的脚本（用于增量构建）
</span></span><span style=display:flex><span>    ├── Dockerfile-source-arm.dockerfile - 构建postgis-pgspider镜像的脚本
</span></span><span style=display:flex><span>    ├── Dockerfile-source.dockerfile - 构建postgis-pgspider镜像的脚本
</span></span><span style=display:flex><span>    ├── README.md
</span></span><span style=display:flex><span>    ├── binary - 我方有修改的预编译的fdw（x86架构）
</span></span><span style=display:flex><span>    │   ├── mysql_fdw
</span></span><span style=display:flex><span>    │   │   ├── mysql_fdw--1.1.sql
</span></span><span style=display:flex><span>    │   │   ├── mysql_fdw.control
</span></span><span style=display:flex><span>    │   │   └── mysql_fdw.so
</span></span><span style=display:flex><span>    │   ├── oracle
</span></span><span style=display:flex><span>    │   │   └── oracle_fdw.so
</span></span><span style=display:flex><span>    │   └── zdblibs
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a1--1.0.0a2.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a2--1.0.0a3.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a3--1.0.0a4.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a4--1.0.0a5.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a5--1.0.0a6.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a6--1.0.0a7.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a7--1.0.0a8.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a8--1.0.0a9.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a9--10-1.0.0a9.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0--10-1.0.1.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b12--10-1.0.0.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.1--10-1.0.2.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.2--10-1.0.3.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.3--10-1.0.4.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.4--10-1.0.5.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.5--4.0.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--4.0.sql
</span></span><span style=display:flex><span>    │       ├── zombodb.control
</span></span><span style=display:flex><span>    │       └── zombodb.so
</span></span><span style=display:flex><span>    ├── binary-arm 我方有修改的预编译的fdw（arm架构）
</span></span><span style=display:flex><span>    │   ├── mysql_fdw
</span></span><span style=display:flex><span>    │   │   ├── mysql_fdw--1.1.sql
</span></span><span style=display:flex><span>    │   │   ├── mysql_fdw.control
</span></span><span style=display:flex><span>    │   │   └── mysql_fdw.so
</span></span><span style=display:flex><span>    │   └── zdblibs
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a1--1.0.0a2.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a2--1.0.0a3.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a3--1.0.0a4.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a4--1.0.0a5.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a5--1.0.0a6.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a6--1.0.0a7.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a7--1.0.0a8.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a8--1.0.0a9.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--1.0.0a9--10-1.0.0a9.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0--10-1.0.1.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b12--10-1.0.0.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.1--10-1.0.2.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.2--10-1.0.3.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.3--10-1.0.4.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.4--10-1.0.5.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--10-1.0.5--4.0.sql
</span></span><span style=display:flex><span>    │       ├── zombodb--4.0.sql
</span></span><span style=display:flex><span>    │       ├── zombodb.control
</span></span><span style=display:flex><span>    │       └── zombodb.so
</span></span><span style=display:flex><span>    ├── config - 数据库配置文件
</span></span><span style=display:flex><span>    │   ├── pg_hba.conf
</span></span><span style=display:flex><span>    │   ├── pg_hba.conf.raw
</span></span><span style=display:flex><span>    │   └── postgresql.conf
</span></span><span style=display:flex><span>    ├── debezium - debezium插件的源码及wal2json的源码
</span></span><span style=display:flex><span>    │   ├── README.md
</span></span><span style=display:flex><span>    │   ├── init-debezium.sh
</span></span><span style=display:flex><span>    │   ├── postgres-decoderbufs.tar.gz
</span></span><span style=display:flex><span>    │   ├── test.sql
</span></span><span style=display:flex><span>    │   └── wal2json-wal2json_1_0.tar.gz
</span></span><span style=display:flex><span>    ├── docker-entrypoint.sh - 入口启动脚本
</span></span><span style=display:flex><span>    ├── draft - 临时文件，可忽略
</span></span><span style=display:flex><span>    │   ├── Dockerfile
</span></span><span style=display:flex><span>    │   ├── Dockerfile-all-in-one.dockerfile
</span></span><span style=display:flex><span>    │   ├── Dockerfile-apt.dockerfile
</span></span><span style=display:flex><span>    │   ├── Dockerfile-postGIS.dockerfile
</span></span><span style=display:flex><span>    │   └── README.md
</span></span><span style=display:flex><span>    ├── initdb-fdw.sh - 初始化fdws脚本
</span></span><span style=display:flex><span>    ├── oracle
</span></span><span style=display:flex><span>    │   ├── instantclient-basic-linux.x64-12.2.0.1.0.zip
</span></span><span style=display:flex><span>    │   ├── instantclient-sdk-linux.x64-12.2.0.1.0.zip
</span></span><span style=display:flex><span>    │   ├── instantclient-sqlplus-linux.x64-12.2.0.1.0.zip
</span></span><span style=display:flex><span>    │   └── oracle_fdw-ORACLE_FDW_2_2_0.tar.gz
</span></span><span style=display:flex><span>    ├── postgis - postgis及其依赖库源码及初始化脚本
</span></span><span style=display:flex><span>    │   ├── CGAL-4.11.2.tar.xz
</span></span><span style=display:flex><span>    │   ├── SFCGAL-1.3.5.tar.gz
</span></span><span style=display:flex><span>    │   ├── boost_1_67_0.tar.gz
</span></span><span style=display:flex><span>    │   ├── gdal-3.0.2.tar.gz
</span></span><span style=display:flex><span>    │   ├── geos-3.8.0.tar.bz2
</span></span><span style=display:flex><span>    │   ├── initdb-postgis.sh
</span></span><span style=display:flex><span>    │   ├── libspatialite-4.3.0a.tar.gz
</span></span><span style=display:flex><span>    │   ├── mpfr-4.0.2.tar.gz
</span></span><span style=display:flex><span>    │   ├── postgis-2.5.2.tar.gz
</span></span><span style=display:flex><span>    │   ├── postgis-2.5.3.tar.gz
</span></span><span style=display:flex><span>    │   ├── proj-6.2.0.tar.gz
</span></span><span style=display:flex><span>    │   └── update-postgis.sh
</span></span><span style=display:flex><span>    └── test.sql - 测试是否正常工作的sql文件
</span></span></code></pre></div><h2 id=builder镜像构建>builder镜像构建<a hidden class=anchor aria-hidden=true href=#builder镜像构建>#</a></h2><p>builder镜像的打包脚本为 <code>Dockerfile-builder.dockerfile</code>，我们使用相同的脚本构建arm及x86版本的镜像；</p><h3 id=打包命令>打包命令<a hidden class=anchor aria-hidden=true href=#打包命令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># X86 镜像构建</span>
</span></span><span style=display:flex><span>docker build -t pgspider-builder:$TAG -f Dockerfile-builder.dockerfile ./
</span></span><span style=display:flex><span><span style=color:#75715e>## arm</span>
</span></span><span style=display:flex><span>docker buildx build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --progress plain <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --platform<span style=color:#f92672>=</span>linux/arm64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -t pgspider-builder-arm:latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -f Dockerfile-builder.dockerfile ./ --load
</span></span></code></pre></div><h3 id=脚本详解>脚本详解<a hidden class=anchor aria-hidden=true href=#脚本详解>#</a></h3><blockquote><p>文件地址： <a href=http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-builder.dockerfile>Dockerfile-builder.dockerfile</a></p></blockquote><p>脚本内容如下，请查看脚本中的注释：</p><p>这里需要注意的是，我们编译后的成果其实位于 <code>/usr/local/pgspider</code> 目录中，这个后面会用到；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># pgspider 源码构建镜像，包含pgspider源码及中间临时成果，用于后续构建其他fdw及提取pgspider可运行镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 使用 debian:stretch-slim 作为基础</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>debian:stretch-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y build-essential git libossp-uuid-dev wget libreadline-dev  zlib1g-dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置工作目录为app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 来源 https://github.com/docker-library/postgres/blob/master/11/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 配置locales为en_US.utf8</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f /etc/dpkg/dpkg.cfg.d/docker <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       <span style=color:#75715e># if this file exists, we&#39;re likely in &#34;debian:xxx-slim&#34;, and locales are thus being excluded so we need to remove that exclusion (since we need locales)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>       grep -q <span style=color:#e6db74>&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       sed -ri <span style=color:#e6db74>&#39;/\/usr\/share\/locale/d&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>       ! grep -q <span style=color:#e6db74>&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#66d9ef>fi</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   apt-get update; apt-get install -y locales; rm -rf /var/lib/apt/lists/*; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG en_US.utf8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装所需依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   apt-get update; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># install &#34;nss_wrapper&#34; in case we need to fake &#34;/etc/passwd&#34; and &#34;/etc/group&#34; (especially for OpenShift)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://github.com/docker-library/postgres/issues/359</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://cwrap.org/nss_wrapper.html</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   apt-get install -y --no-install-recommends libnss-wrapper; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 获取pg11.6源码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> wget https://ftp.postgresql.org/pub/source/v11.6/postgresql-11.6.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 获取pgspider的补丁包</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> wget https://raw.githubusercontent.com/pgspider/pgspider/master/pgspider.patch<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 解压pg</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> tar xvf postgresql-11.6.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 应用pgspider源码补丁包到pg源码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> patch -p1 -d postgresql-11.6 &lt; /app/pgspider.patch<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 开始执行编译，可参考pgspider github页面</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd postgresql-11.6 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> ./configure --with-uuid<span style=color:#f92672>=</span>ossp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#75715e>## 编译PG并install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#75715e>## 编译pgspider_core_fdw 并install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   <span style=color:#f92672>&amp;&amp;</span> cd /app/postgresql-11.6/contrib/pgspider_core_fdw <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#75715e>## 编译 pgspider_fdw 并install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   <span style=color:#f92672>&amp;&amp;</span> cd /app/postgresql-11.6/contrib/pgspider_fdw <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#75715e>## 编译postgres_fdw并install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   <span style=color:#f92672>&amp;&amp;</span> cd /app/postgresql-11.6/contrib/postgres_fdw <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#75715e>## 编译contrib并install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   <span style=color:#f92672>&amp;&amp;</span> cd /app/postgresql-11.6/contrib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PATH $PATH:/usr/local/pgspider/bin<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=base镜像构建>base镜像构建<a hidden class=anchor aria-hidden=true href=#base镜像构建>#</a></h2><p>base 镜像的打包脚本为 <code>Dockerfile-base.dockerfile</code>，我们使用相同的脚本构建arm及x86版本的镜像；</p><h3 id=打包命令-1>打包命令<a hidden class=anchor aria-hidden=true href=#打包命令-1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 打包x86版本</span>
</span></span><span style=display:flex><span>docker build -t pgspider-base:$TAG -f Dockerfile-base.dockerfile ./
</span></span><span style=display:flex><span><span style=color:#75715e>## arm</span>
</span></span><span style=display:flex><span>docker buildx build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --progress plain <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --platform<span style=color:#f92672>=</span>linux/arm64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -t pgspider-base-arm:$TAG <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -f Dockerfile-base.dockerfile ./ --load
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span><span style=color:#75715e>## 也可使用一条命令构建两个版本的镜像，此时必须在镜像tag中包含可用的docker registry地址，并且使用 `--push` 参数在打包完成后推送镜像到registry</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 完成后再拉取到本地进行测试</span>
</span></span><span style=display:flex><span>docker buildx build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --progress plain <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --platform<span style=color:#f92672>=</span>linux/arm64,linux/amd64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -t hanlyjiang/pgspider-base-arm:$TAG <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -f Dockerfile-base.dockerfile ./ --push
</span></span></code></pre></div><h3 id=脚本详解-1>脚本详解<a hidden class=anchor aria-hidden=true href=#脚本详解-1>#</a></h3><blockquote><p>脚本在线地址： <a href=http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-base.dockerfile>gitlab</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># PGSpider 基础镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 1. 安装需要的依赖，避免后续每次构建时都需要安装（依赖部分可能需要精简）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 2. 添加对应的postgres用户</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>debian:stretch-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装必要依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>if</span> ! command -v gpg &gt; /dev/null; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		apt-get update; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>			gnupg <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>			dirmngr <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		rm -rf /var/lib/apt/lists/*; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>fi</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装依赖，并创建pg需要的用户及组id，创建pg需要的目录并赋予对应的组和id改目录的权限</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># explicitly set user/group IDs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	groupadd -r postgres --gid<span style=color:#f92672>=</span>999; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># https://salsa.debian.org/postgresql/postgresql-common/blob/997d842ee744687d99a2b2d95c1083a2615c79e8/debian/postgresql-common.postinst#L32-35</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	useradd -r -g postgres --uid<span style=color:#f92672>=</span><span style=color:#ae81ff>999</span> --home-dir<span style=color:#f92672>=</span>/var/lib/postgresql --shell<span style=color:#f92672>=</span>/bin/bash postgres; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># also create the postgres user&#39;s home directory with appropriate permissions</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># see https://github.com/docker-library/postgres/issues/274</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	mkdir -p /var/lib/postgresql; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	chown -R postgres:postgres /var/lib/postgresql<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加 gosu 用于后续方便使从root降权限</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># grab gosu for easy step-down from root</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://github.com/tianon/gosu/releases</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> GOSU_VERSION 1.12<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	savedAptMark<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>apt-mark showmanual<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-get update; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-get install -y --no-install-recommends ca-certificates wget; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	rm -rf /var/lib/apt/lists/*; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	dpkgArch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dpkg --print-architecture | awk -F- <span style=color:#e6db74>&#39;{ print $NF }&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	wget -O /usr/local/bin/gosu <span style=color:#e6db74>&#34;https://github.com/tianon/gosu/releases/download/</span>$GOSU_VERSION<span style=color:#e6db74>/gosu-</span>$dpkgArch<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	wget -O /usr/local/bin/gosu.asc <span style=color:#e6db74>&#34;https://github.com/tianon/gosu/releases/download/</span>$GOSU_VERSION<span style=color:#e6db74>/gosu-</span>$dpkgArch<span style=color:#e6db74>.asc&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	export GNUPGHOME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp -d<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gpgconf --kill all; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	rm -rf <span style=color:#e6db74>&#34;</span>$GNUPGHOME<span style=color:#e6db74>&#34;</span> /usr/local/bin/gosu.asc; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-mark auto <span style=color:#e6db74>&#39;.*&#39;</span> &gt; /dev/null; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$savedAptMark<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>||</span> apt-mark manual $savedAptMark &gt; /dev/null; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant<span style=color:#f92672>=</span>false; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	chmod +x /usr/local/bin/gosu; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gosu --version; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gosu nobody true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 配置locale</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># make the &#34;en_US.UTF-8&#34; locale so postgres will be utf-8 enabled by default</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f /etc/dpkg/dpkg.cfg.d/docker <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># if this file exists, we&#39;re likely in &#34;debian:xxx-slim&#34;, and locales are thus being excluded so we need to remove that exclusion (since we need locales)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		grep -q <span style=color:#e6db74>&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		sed -ri <span style=color:#e6db74>&#39;/\/usr\/share\/locale/d&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		! grep -q <span style=color:#e6db74>&#39;/usr/share/locale&#39;</span> /etc/dpkg/dpkg.cfg.d/docker; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>fi</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-get update; apt-get install -y --no-install-recommends locales; rm -rf /var/lib/apt/lists/*; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG en_US.utf8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装必要依赖库</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-get update; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># install &#34;nss_wrapper&#34; in case we need to fake &#34;/etc/passwd&#34; and &#34;/etc/group&#34; (especially for OpenShift)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://github.com/docker-library/postgres/issues/359</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://cwrap.org/nss_wrapper.html</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		libnss-wrapper <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># install &#34;xz-utils&#34; for .sql.xz docker-entrypoint-initdb.d files</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>		xz-utils <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 配置信任的gpg key</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># pub   4096R/ACCC4CF8 2011-10-13 [expires: 2019-07-02]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#       Key fingerprint = B97B 0AFC AA1A 47F0 44F2  44A0 7FCC 7D46 ACCC 4CF8</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># uid                  PostgreSQL Debian Repository</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	key<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8&#39;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	export GNUPGHOME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp -d<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys <span style=color:#e6db74>&#34;</span>$key<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gpg --batch --export <span style=color:#e6db74>&#34;</span>$key<span style=color:#e6db74>&#34;</span> &gt; /etc/apt/trusted.gpg.d/postgres.gpg; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	command -v gpgconf &gt; /dev/null <span style=color:#f92672>&amp;&amp;</span> gpgconf --kill all; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	rm -rf <span style=color:#e6db74>&#34;</span>$GNUPGHOME<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	apt-key list<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PG_MAJOR <span style=color:#ae81ff>11</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> GOSU_VERSION 1.11<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加postgresql软件源仓库</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># see note below about &#34;*.pyc&#34; files</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	export PYTHONDONTWRITEBYTECODE<span style=color:#f92672>=</span>1; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	dpkgArch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>dpkg --print-architecture<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$dpkgArch<span style=color:#e6db74>&#34;</span> in <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		amd64 | i386 | ppc64el<span style=color:#f92672>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># arches officialy built by upstream</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>			echo <span style=color:#e6db74>&#34;deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main </span>$PG_MAJOR<span style=color:#e6db74>&#34;</span> &gt; /etc/apt/sources.list.d/pgdg.list; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>			echo <span style=color:#e6db74>&#34;apt-get update;&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>			;; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		*<span style=color:#f92672>)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e># we&#39;re on an architecture upstream doesn&#39;t officially build for</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># let&#39;s build binaries from their </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        echo <span style=color:#e6db74>&#34;deb-src http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main </span>$PG_MAJOR<span style=color:#e6db74>&#34;</span> &gt; /etc/apt/sources.list.d/pgdg.list; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        ;; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>esac</span>;<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 添加必要的工具及依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recommends unzip wget <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libreadline-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libmongoc-1.0-0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libmysql++-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libsqlite3-dev libspatialite7 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libsybdb5 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libhiredis-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    freetds-dev freetds-common libcurl4-nss-dev unixodbc-dev  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># libaio-dev - oracle_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    libaio-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*;<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=pgspider镜像构建>pgspider镜像构建<a hidden class=anchor aria-hidden=true href=#pgspider镜像构建>#</a></h2><p>对x86及arm架构，我们分别编写了对应的脚本，其中x86使用 Dockerfile-source.dockerfile 脚本构建，arm使用Dockerfile-source-arm.dockerfile脚本构建；</p><h3 id=构建命令>构建命令<a hidden class=anchor aria-hidden=true href=#构建命令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>docker build -t pgspider-postgis:$TAG -f Dockerfile-source.dockerfile ./
</span></span><span style=display:flex><span><span style=color:#75715e>## arm </span>
</span></span><span style=display:flex><span>docker buildx build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --progress plain <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      --build-arg --platform<span style=color:#f92672>=</span>linux/arm64 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -t pgspider-postgis:arm-$TAG <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -f Dockerfile-source-arm.dockerfile ./ --load
</span></span></code></pre></div><h3 id=脚本详解-2>脚本详解<a hidden class=anchor aria-hidden=true href=#脚本详解-2>#</a></h3><ul><li><p>pgspider 镜像构建的步骤较多，我们采取分步骤构建的方式使用中间构建过程来减小最终镜像的层数及大小；</p></li><li><p>另外两个平台的构建脚本大体一致，仅有少数过程有差异，我们先使用x86版本的对整体过程进行说明，后面我们会说明两个平台之间的差异；</p></li></ul><h4 id=x86-构建脚本>x86 构建脚本<a hidden class=anchor aria-hidden=true href=#x86-构建脚本>#</a></h4><blockquote><p>提示：脚本中有多个FROM段，此为Docker多阶段构建可以通过<a href=https://zhuanlan.zhihu.com/p/33795821>此文章</a>进行了解；</p></blockquote><p>主要过程如下：</p><p><strong>第一阶段：</strong></p><ol><li><p>从builder镜像开始，由于builder镜像中已经包含pg源码还有已经编好的pg及pgspider等，所以我们无需再编译这些；</p></li><li><p>编译 mysql_fdw 及 sqlite_fdw（注意，其中mysql_fdw其实可以不用了）</p></li><li><p>安装 oracle_fdw 所需要的依赖（oracle instant client）；</p></li><li><p>编译postgis，编译postgis需要先编译其依赖（mpfr，boost_1_67_0，CGAL等），这里我们将postgis的所有的依赖及其自身的安装路径都设置为 <code>/usr/local/pgspider/plugin/postgis</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis
</span></span></code></pre></div></li><li><p>编译并安装 debezium及wal2json；</p></li><li><p>使用strip对postgis目录中的所有so库进行大小优化</p></li><li><p>将预先编译好的 几个fdw的so及配置及sql文件拷贝到指定目录以安装或更新这些fdw；</p></li></ol><p><strong>第二阶段：</strong></p><ol><li>从 pgspider-base 镜像开始构建；</li><li>安装必要的依赖；</li><li>从第一阶段拷贝出oracle_instantclient的依赖；（arm版本无此步骤，因为oracle_instantclient不支持arm架构）</li><li>从第一阶段拷贝出 /usr/local/pgspider 目录，其中包含了我们之前编译的的成果；</li><li>添加各种初始化脚本，并为pg运行做必要的准备，可以参考官方dockerfile；</li><li>最后使用 EXPOSE 暴露 5432端口，使用 CMD [&ldquo;postgres&rdquo;] 默认启动pg；</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># ---</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 构建融合中心pg镜像(从源码构建）：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 1. 构建pgspider（pgspider-base镜像中包含）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 2. 添加若干fdw：mysql_fdw,oracle_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 3. 添加 postgis</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 参考：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ---</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 构建 sqlite_fdw  mysql_fdw  oracle_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#FROM pgspider-builder as build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/pgspider-builder</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## PG 主版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PG_MAJOR <span style=color:#ae81ff>11</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PG_VERSION <span style=color:#ae81ff>6</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装构建所需的依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y automake autoconf libtool pkg-config libssl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libsqlite3-dev libsybdb5 freetds-dev freetds-common <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># for oracle</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    unzip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#    libmysql++-dev</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    libmysql++-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    libspatialite7<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    postgresql-${PG_MAJOR}-python-multicorn python-pip</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 sqlite_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/sqlite_fdw<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/sqlite_fdw <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 mysql_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/mysql_fdw<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/mysql_fdw <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 Install es_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN pip install pg_es_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 oracle_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 安装oracle instantclient</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s /usr/local/instantclient_12_2 /usr/local/instantclient<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> ORACLE_HOME<span style=color:#f92672>=</span>/usr/local/instantclient<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LD_LIBRARY_PATH<span style=color:#f92672>=</span>$LD_LIBRARY_PATH:/usr/local/instantclient<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/oracle_fdw <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/oracle_fdw <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>##  POSTGIS 构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 安装依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install  -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libtool libxml2 libxml2-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libxslt1.1 libxslt1-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libjson-c-dev libgmp-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cmake libmpfr-dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 创建临时工作目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 mpfr</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/mpfr-4.0.2.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/mpfr-4.0.2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 boost</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/boost_1_67_0.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/boost_1_67_0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./bootstrap.sh -prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#f92672>&amp;&amp;</span> ./b2 <span style=color:#f92672>&amp;&amp;</span> ./b2 install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 CGAL</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/CGAL-4.11.2.tar.xz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/CGAL-4.11.2  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cmake -DCMAKE_INSTALL_PREFIX<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH . <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 SFCGAL</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/SFCGAL-1.3.5.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/SFCGAL-1.3.5 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cmake -DCMAKE_INSTALL_PREFIX<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH . <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 proj，需要先安装sqlite3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/proj-6.2.0.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/proj-6.2.0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 gdal</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/gdal-3.0.2.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/gdal-3.0.2  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        --with-proj<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 geos</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/geos-3.8.0.tar.bz2 /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/geos-3.8.0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 postgis</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/postgis-2.5.3.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/postgis-2.5.3  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 几个config命令直接配置PATH后可以找到，所以不在使用参数配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        --with-projdir<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34; /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34;  /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; echo &#34;deb http://deb.debian.org/debian stretch-backports main&#34; &gt;&gt;/etc/apt/sources.list \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libprotobuf-c-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#      postgresql-12-wal2json \</span>
</span></span><span style=display:flex><span>      protobuf-c-compiler <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加 debezium https://github.com/eulerto/wal2json</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/debezium/wal2json-wal2json_1_0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加 debezium - decoderbufs 研究院修改版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> debezium/postgres-decoderbufs.tar.gz /app/debezium/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/debezium/postgres-decoderbufs <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd proto <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> protoc-c --c_out<span style=color:#f92672>=</span>../src/proto pg_logicaldec.proto <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd .. <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e>## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> make -B -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加 debezium - decoderbufs 官方版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ADD debezium/postgres-decoderbufs-v.1.3.1.Final.tar.gz /app/debezium/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN cd /app/debezium/postgres-decoderbufs-v.1.3.1.Final \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; make -j$(nproc) &amp;&amp; make install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 对构建postgis过程中生成的文件进行优化，以减小大小</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd $PGIS_INSTALL_PATH/lib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm *.a <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> find . -type f -name <span style=color:#e6db74>&#34;lib*.so.*&#34;</span> -exec strip <span style=color:#f92672>{}</span> +<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; cd /usr/local/pgspider/plugin/proj/lib \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; rm *.a &amp;&amp; find . -type f -name &#34;lib*.so.*&#34; -exec strip {} +</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 拷贝mysql</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 拷贝zombodb</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 拷贝oracle fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary/oracle/*.so           /usr/local/pgspider/lib/postgresql/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ------ 开始构建实际发布的镜像 ------</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/pgspider-base:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jianghanghang@geostar.com.cn&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置若干ENV，指示版本信息</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># buster 上为12 ，stretch 上为 12</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ENV CDAL_VERSION 12</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> BOOST_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.67.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PG_MAJOR<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PG_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    POSTGIS_VESION<span style=color:#f92672>=</span>2.5.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装必要的依赖（TODO: 部分依赖可能不需要）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34; /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34;  /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; echo &#34;deb http://deb.debian.org/debian stretch-backports main&#34; &gt;&gt;/etc/apt/sources.list \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libcurl3-gnutls <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libexpat1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libgmp10 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libgmpxx4ldbl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libjson-c3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#75715e># buster 上为6，stretch上为4</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#      libmpfr6 \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#      libmpfr4 \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      libprotobuf-c1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libtiff5 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libxml2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#75715e># for debezium</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      postgresql-12-wal2json <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libprotobuf-c-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装oracle_fdw需要的 Oracle instantclient</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s /usr/local/instantclient_12_2 /usr/local/instantclient <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置若干运行需要的环境变量</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> ORACLE_HOME<span style=color:#f92672>=</span>/usr/local/instantclient <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PGIS_INSTALL_PATH<span style=color:#f92672>=</span>/usr/local/pgspider/plugin/postgis<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LD_LIBRARY_PATH<span style=color:#f92672>=</span>$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PATH<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 拷贝构建好的成果</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>build  /usr/local/pgspider /usr/local/pgspider<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 入口脚本添加</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> docker-entrypoint.sh /usr/local/bin/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /docker-entrypoint-initdb.d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> chmod +x /usr/local/bin/docker-entrypoint.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s usr/local/bin/docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## postgis 脚本添加</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./postgis/update-postgis.sh /usr/local/bin<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加扩展初始化脚本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## make the sample config easier to munge (and &#34;correct by default&#34;)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -ri <span style=color:#e6db74>&#34;s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = &#39;*&#39;!&#34;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   grep -F <span style=color:#e6db74>&#34;listen_addresses = &#39;*&#39;&#34;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /var/run/postgresql <span style=color:#f92672>&amp;&amp;</span> chown -R postgres:postgres /var/run/postgresql  <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>2777</span> /var/run/postgresql<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PGDATA /var/lib/postgresql/data<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary &#34;--user&#34; values)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p <span style=color:#e6db74>&#34;</span>$PGDATA<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> chown -R postgres:postgres <span style=color:#e6db74>&#34;</span>$PGDATA<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>777</span> <span style=color:#e6db74>&#34;</span>$PGDATA<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span> <span style=color:#e6db74>/var/lib/postgresql/data</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># calls &#34;Fast Shutdown mode&#34; wherein new connections are disallowed and any</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># flush tables to disk, which is the best compromise available to avoid data</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># corruption.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Users who know their applications do not keep open long-lived idle connections</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># may way to use a value of SIGTERM instead, which corresponds to &#34;Smart</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Shutdown mode&#34; in which any existing sessions are allowed to finish and the</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># server stops when all sessions are terminated.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># See https://www.postgresql.org/docs/12/server-shutdown.html for more details</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># about available PostgreSQL server shutdown signals.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># See also https://www.postgresql.org/docs/12/server-start.html for further</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># justification of this as the default value, namely that the example (and</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># shipped) systemd service files use the &#34;Fast Shutdown mode&#34; for service</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># termination.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>STOPSIGNAL</span> <span style=color:#e6db74>SIGINT</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># An additional setting that is recommended for all users regardless of this</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># value is the runtime &#34;--stop-timeout&#34; (or your orchestrator/runtime&#39;s</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># equivalent) for controlling how long to wait between sending the defined</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># The default in most runtimes (such as Docker) is 10 seconds, and the</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># documentation at https://www.postgresql.org/docs/12/server-start.html notes</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># that even 90 seconds may not be long enough in many instances.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span> <span style=color:#e6db74>5432</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;postgres&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h3 id=arm版本构建脚本>ARM版本构建脚本<a hidden class=anchor aria-hidden=true href=#arm版本构建脚本>#</a></h3><p>与x86版本不同之处在于：</p><ol><li>from的镜像不同，一个是x86版本，一个是arm版本；</li><li>arm版本不包含oracle_fdw 构建的相关步骤；</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># ---</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 构建融合中心pg镜像-armb版本(从源码构建）：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 1. 构建pgspider（pgspider-base镜像中包含）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 2. 添加若干fdw：mysql_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 3. 添加 postgis</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 参考：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ---</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 构建 sqlite_fdw  mysql_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>zh-registry.geostar.com.cn/geopanel/pgspider-builder-arm:latest</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>build</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## PG 主版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PG_MAJOR <span style=color:#ae81ff>11</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PG_VERSION <span style=color:#ae81ff>6</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装构建所需的依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y automake autoconf libtool pkg-config libssl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libsqlite3-dev libsybdb5 freetds-dev freetds-common <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># for oracle</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    unzip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#    libmysql++-dev</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    libmysql++-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    libspatialite7<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    postgresql-${PG_MAJOR}-python-multicorn python-pip</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 sqlite_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/sqlite_fdw<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/sqlite_fdw <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 mysql_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/mysql_fdw<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgresql-<span style=color:#e6db74>${</span>PG_MAJOR<span style=color:#e6db74>}</span>.<span style=color:#e6db74>${</span>PG_VERSION<span style=color:#e6db74>}</span>/contrib/mysql_fdw <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 Install es_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN pip install pg_es_fdw</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装 oracle_fdw(arm 不支持)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 安装oracle instantclient</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ENV ORACLE_HOME=/usr/local/instantclient</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; make &amp;&amp; make install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>##  POSTGIS 构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 安装依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install  -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libtool libxml2 libxml2-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libxslt1.1 libxslt1-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libjson-c-dev libgmp-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cmake libmpfr-dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 创建临时工作目录</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 mpfr</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/mpfr-4.0.2.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/mpfr-4.0.2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 boost</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/boost_1_67_0.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/boost_1_67_0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./bootstrap.sh -prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#f92672>&amp;&amp;</span> ./b2 <span style=color:#f92672>&amp;&amp;</span> ./b2 install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 CGAL</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/CGAL-4.11.2.tar.xz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/CGAL-4.11.2  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cmake -DCMAKE_INSTALL_PREFIX<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH . <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 SFCGAL</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/SFCGAL-1.3.5.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/SFCGAL-1.3.5 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cmake -DCMAKE_INSTALL_PREFIX<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH . <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 proj，需要先安装sqlite3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/proj-6.2.0.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/proj-6.2.0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 gdal</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/gdal-3.0.2.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/gdal-3.0.2  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        --with-proj<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 geos</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/geos-3.8.0.tar.bz2 /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/geos-3.8.0  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 构建 postgis</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> postgis/postgis-2.5.3.tar.gz /app/postgis/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/postgis/postgis-2.5.3  <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ./configure --prefix<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 几个config命令直接配置PATH后可以找到，所以不在使用参数配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>        --with-projdir<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34; /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34;  /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; echo &#34;deb http://deb.debian.org/debian stretch-backports main&#34; &gt;&gt;/etc/apt/sources.list \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libprotobuf-c-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#      postgresql-12-wal2json \</span>
</span></span><span style=display:flex><span>      protobuf-c-compiler <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加 debezium https://github.com/eulerto/wal2json</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/debezium/wal2json-wal2json_1_0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加 debezium - decoderbufs 研究院修改版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> debezium/postgres-decoderbufs.tar.gz /app/debezium/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /app/debezium/postgres-decoderbufs <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd proto <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> protoc-c --c_out<span style=color:#f92672>=</span>../src/proto pg_logicaldec.proto <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> cd .. <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e>## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> make -B -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span> <span style=color:#f92672>&amp;&amp;</span> make install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### 对构建postgis过程中生成的文件进行优化，以减小大小</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd $PGIS_INSTALL_PATH/lib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm *.a <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> find . -type f -name <span style=color:#e6db74>&#34;lib*.so.*&#34;</span> -exec strip <span style=color:#f92672>{}</span> +<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; cd /usr/local/pgspider/plugin/proj/lib \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; rm *.a &amp;&amp; find . -type f -name &#34;lib*.so.*&#34; -exec strip {} +</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 拷贝mysql</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary-arm/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary-arm/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary-arm/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 拷贝zombodb</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary-arm/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary-arm/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> binary-arm/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ------ 开始构建实际发布的镜像 ------</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>zh-registry.geostar.com.cn/geopanel/pgspider-base-arm:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jianghanghang@geostar.com.cn&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置若干ENV，指示版本信息</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># buster 上为12 ，stretch 上为 12</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ENV CDAL_VERSION 12</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> BOOST_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.67.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PG_MAJOR<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PG_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    POSTGIS_VESION<span style=color:#f92672>=</span>2.5.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装必要的依赖（TODO: 部分依赖可能不需要）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -ex <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34; /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#    &amp;&amp; sed -i &#34;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34;  /etc/apt/sources.list \</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; echo &#34;deb http://deb.debian.org/debian stretch-backports main&#34; &gt;&gt;/etc/apt/sources.list \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libcurl3-gnutls <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libexpat1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libgmp10 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libgmpxx4ldbl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libjson-c3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#75715e># buster 上为6，stretch上为4</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#      libmpfr6 \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#      libmpfr4 \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      libprotobuf-c1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libtiff5 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      libxml2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 安装oracle_fdw需要的 Oracle instantclient (arm版本不支持）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#COPY --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#RUN set -ex \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#    &amp;&amp; ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置若干运行需要的环境变量</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#ENV ORACLE_HOME=/usr/local/instantclient \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PGIS_INSTALL_PATH<span style=color:#f92672>=</span>/usr/local/pgspider/plugin/postgis<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LD_LIBRARY_PATH<span style=color:#f92672>=</span>$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    PATH<span style=color:#f92672>=</span>$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 拷贝构建好的成果</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>build  /usr/local/pgspider /usr/local/pgspider<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 入口脚本添加</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> docker-entrypoint.sh /usr/local/bin/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /docker-entrypoint-initdb.d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> chmod +x /usr/local/bin/docker-entrypoint.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s usr/local/bin/docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## postgis 脚本添加</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./postgis/update-postgis.sh /usr/local/bin<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 添加扩展初始化脚本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## make the sample config easier to munge (and &#34;correct by default&#34;)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -ri <span style=color:#e6db74>&#34;s!^#?(listen_addresses)\s*=\s*\S+.*!\1 = &#39;*&#39;!&#34;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   grep -F <span style=color:#e6db74>&#34;listen_addresses = &#39;*&#39;&#34;</span> /usr/local/pgspider/share/postgresql/postgresql.conf.sample<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p /var/run/postgresql <span style=color:#f92672>&amp;&amp;</span> chown -R postgres:postgres /var/run/postgresql  <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>2777</span> /var/run/postgresql<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PGDATA /var/lib/postgresql/data<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary &#34;--user&#34; values)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir -p <span style=color:#e6db74>&#34;</span>$PGDATA<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> chown -R postgres:postgres <span style=color:#e6db74>&#34;</span>$PGDATA<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>777</span> <span style=color:#e6db74>&#34;</span>$PGDATA<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span> <span style=color:#e6db74>/var/lib/postgresql/data</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># calls &#34;Fast Shutdown mode&#34; wherein new connections are disallowed and any</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># flush tables to disk, which is the best compromise available to avoid data</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># corruption.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Users who know their applications do not keep open long-lived idle connections</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># may way to use a value of SIGTERM instead, which corresponds to &#34;Smart</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Shutdown mode&#34; in which any existing sessions are allowed to finish and the</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># server stops when all sessions are terminated.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># See https://www.postgresql.org/docs/12/server-shutdown.html for more details</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># about available PostgreSQL server shutdown signals.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># See also https://www.postgresql.org/docs/12/server-start.html for further</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># justification of this as the default value, namely that the example (and</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># shipped) systemd service files use the &#34;Fast Shutdown mode&#34; for service</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># termination.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>STOPSIGNAL</span> <span style=color:#e6db74>SIGINT</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># An additional setting that is recommended for all users regardless of this</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># value is the runtime &#34;--stop-timeout&#34; (or your orchestrator/runtime&#39;s</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># equivalent) for controlling how long to wait between sending the defined</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># The default in most runtimes (such as Docker) is 10 seconds, and the</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># documentation at https://www.postgresql.org/docs/12/server-start.html notes</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># that even 90 seconds may not be long enough in many instances.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span> <span style=color:#e6db74>5432</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;postgres&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=镜像测试及使用>镜像测试及使用<a hidden class=anchor aria-hidden=true href=#镜像测试及使用>#</a></h2><blockquote><p>提示：镜像使用了pg官方的入口脚本，官方支持的配置及变量都可以使用，具体可查看<a href="https://hub.docker.com/_/postgres?tab=description&amp;page=1&amp;ordering=last_updated">官方dockerhub页面</a></p></blockquote><p>下面描述了一个简单的测试流程，详细可参考： <a href=http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/README.md#%E8%BF%90%E8%A1%8C-1>pgspider镜像运行测试</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>## 根据平台及需要使用的源，设置 `PG_IMAGE` 变量</span>
</span></span><span style=display:flex><span><span style=color:#75715e># x86 - dockerhub </span>
</span></span><span style=display:flex><span>PG_IMAGE<span style=color:#f92672>=</span>hanlyjiang/pgspider-postgis:latest
</span></span><span style=display:flex><span><span style=color:#75715e># arm - dockerhub</span>
</span></span><span style=display:flex><span>PG_IMAGE<span style=color:#f92672>=</span>hanlyjiang/pgspider-postgis-arm:latest
</span></span><span style=display:flex><span><span style=color:#75715e># x86 - 阿里云</span>
</span></span><span style=display:flex><span>PG_IMAGE<span style=color:#f92672>=</span> zh-registry.geostar.com.cn/geopanel/pgspider-postgis:latest
</span></span><span style=display:flex><span><span style=color:#75715e># arm - 阿里云</span>
</span></span><span style=display:flex><span>PG_IMAGE<span style=color:#f92672>=</span> zh-registry.geostar.com.cn/geopanel/pgspider-postgis-arm:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启动 pgspider （可以将 --rm 换成 -d 以便持续在后台运行 ）</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 通过 POSTGRES_PASSWORD 变量可以设置密码</span>
</span></span><span style=display:flex><span>docker run -it --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --name pgspider <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -p 5434:5432 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e POSTGRES_PASSWORD<span style=color:#f92672>=</span>mysecretpassword <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -v $PWD/data:/var/lib/postgresql/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    $PG_IMAGE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 启动后进入容器：</span>
</span></span><span style=display:flex><span>docker exec -it pgspider bash
</span></span><span style=display:flex><span><span style=color:#75715e>### 然后可以执行 psql 等命令</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试用，正常运行可以不用管</span>
</span></span><span style=display:flex><span>docker run -it --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --entrypoint<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --name pgspider <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e POSTGRES_PASSWORD<span style=color:#f92672>=</span>mysecretpassword <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -v $PWD/data:/var/lib/postgresql/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    pgspider-postgis:latest bash
</span></span></code></pre></div><h2 id=可优化部分>可优化部分<a hidden class=anchor aria-hidden=true href=#可优化部分>#</a></h2><p>builder镜像和base镜像的构建arm及x86两个架构的镜像构建可以合并成一条命令并使用相同的镜像名称；同时pgspider镜像也可以经过一定的更改统一成一个打包脚本；</p><h1 id=geopanel容器化-hasura即块数据api引擎镜像构建>GeoPanel容器化-hasura即块数据API引擎镜像构建<a hidden class=anchor aria-hidden=true href=#geopanel容器化-hasura即块数据api引擎镜像构建>#</a></h1><h2 id=hasura镜像构建概览>Hasura镜像构建概览<a hidden class=anchor aria-hidden=true href=#hasura镜像构建概览>#</a></h2><h3 id=hasura-是什么>hasura 是什么？<a hidden class=anchor aria-hidden=true href=#hasura-是什么>#</a></h3><p>引用<a href=%5Bhttps://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md%5D(https://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md)>hasura官方</a>的介绍</p><blockquote><p>Hasura GraphQL引擎是一个高性能的GraphQL服务器，可为您提供 <strong>Postgres上开箱即用的实时GraphQL API</strong>， 响应数据库事件的 <a href=https://github.com/hasura/graphql-engine/blob/master/event-triggers.md><strong>Webhook触发器</strong></a>，以及用于业务逻辑处理的 <a href=https://github.com/hasura/graphql-engine/blob/master/remote-schemas.md><strong>远端Schema</strong></a>。
Hasura可帮助您构建基于Postgres的GraphQL应用程序，或将使用Postgres的现有应用迁移到GraphQL上。</p></blockquote><p>Github及DockerHub地址：</p><ul><li>开源仓库Github地址：<a href=hasura/graphql-engine>hasura/graphql-engine</a></li><li>官方Dockerhub镜像地址：<a href="https://hub.docker.com/r/hasura/graphql-engine/tags?page=1&amp;ordering=last_updated">hasura/graphql-engine</a></li></ul><h3 id=我们做的修改>我们做的修改<a hidden class=anchor aria-hidden=true href=#我们做的修改>#</a></h3><p>我们使用hasura作为融合中心的块数据API引擎，针对开源版本作了如下修改/扩展：</p><ol><li>汉化了 graphl-engine console，其中包括：<ul><li>汉化 graphql-engine的console入口文件中的 <code>Loading...</code>;</li><li>console web页面的所有界面；</li></ul></li><li>根据需要扩展了几个模块，模块扩展的方式为：1）在console中添加扩展模块的web操作界面；2）提供对应的springboot服务作为后端接口提供服务；到目前为止，包括以下模块：<ul><li>token管理服务</li><li>数据库集成服务</li><li>restapi服务</li></ul></li></ol><h3 id=目标及成果>目标及成果<a hidden class=anchor aria-hidden=true href=#目标及成果>#</a></h3><p>通过官方的dockerhub可以看到，目前没有arm版本的镜像，故我们需要从头编译。同时我们希望能让hasura在arm平台上运行，最终也完成了构建流程，整体如下：</p><p><img alt=image-20210316140949364 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316140949.png></p><h3 id=hasura整体结构>hasura整体结构<a hidden class=anchor aria-hidden=true href=#hasura整体结构>#</a></h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph

graphql-engine

console

cli
</code></pre><ol><li><p>graphql-engine: graphql 引擎</p></li><li><p>console：前端界面，实际上console也会一起打包到graphql-engine的镜像里面</p></li><li><p>Hasura CLI是一个命令行工具，是管理Hasura项目和迁移的主要模式。</p></li></ol><p>实际上我们只需要前两个部分即可</p><h3 id=整体构建流程梳理>整体构建流程梳理<a hidden class=anchor aria-hidden=true href=#整体构建流程梳理>#</a></h3><h4 id=代码结构说明>代码结构说明<a hidden class=anchor aria-hidden=true href=#代码结构说明>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>graphql-engine 
</span></span><span style=display:flex><span>	|-- server
</span></span><span style=display:flex><span>		  |-- src-rsr
</span></span><span style=display:flex><span>		  		|-- console.html
</span></span><span style=display:flex><span>	|-- console
</span></span><span style=display:flex><span>		  |-- xx.html
</span></span><span style=display:flex><span>		  |-- xxxx
</span></span></code></pre></div><p>server 目录会编译出一个 graphql-engine 的二进制文件，其中会包含 <code>server/src-rsr/console.html</code> 文件作为首页的加载模板（即console.html）。</p><h4 id=graphql-engine-console>graphql-engine console<a hidden class=anchor aria-hidden=true href=#graphql-engine-console>#</a></h4><p>console为web工程，使用npm run build即可编译，非常简单。我们只需要重点关注server部分即可。现在我们重点分析这个server部分：</p><h4 id=graphql-engine-server>graphql-engine server<a hidden class=anchor aria-hidden=true href=#graphql-engine-server>#</a></h4><ul><li>graphql-engine server 使用haskell语言进行编写，使用 cabal 进行构建；</li><li>haskell是一个函数式编程语言，编译器为GHC，编译工具一般使用cabal，cabal同时也是项目的管理工具（如包管理，依赖管理）。</li></ul><p>也就是说为了编译server，我们需要GHC及cabal，那么这两个工具的arm版本现状如何了？</p><ul><li>GHC： 无arm版本现成的docker镜像，有预编译的二进制；</li><li>cabal： 无arm版本现成的docker镜像及二进制文件；</li></ul><p>为了不污染环境，并且持久化构建环境，我们准备构建一个docker的镜像，包含ghc及cabal，也就是说，我们两者都需要构建。</p><p>总结以下构建步骤：</p><ol><li>准备haskell的ARM版本编译环境（包括GHC编译器及hasura编译所需要的cabal工具）；</li><li>使用之前准备好的ARM版本编译环境编译hasura；</li><li>打包成Docker镜像；</li></ol><h4 id=整体构建流程-1>整体构建流程<a hidden class=anchor aria-hidden=true href=#整体构建流程-1>#</a></h4><p>在浏览<code>graphql-engine</code> 的仓库中ci构建的部分文件之后，我发现还需要其他一些辅助镜像，最后梳理出如下构建流程：</p><ol><li>首先，我们需要构建 <code>graphql-engine-builder</code> 的镜像，其中包括haskell的GHC编译器及cabal依赖管理工具；</li><li>然后我们使用<code>graphql-engine-builder</code>镜像对 graphql-engine 的源码进行编译，生成 graphql-engine 的二进制可执行文件及 graphql-engine 运行所需要的依赖库；</li><li>由于第二步构建过程中有很多中间成果，我需要为graphql-engine创造一个纯净的运行环境以缩小最终的运行镜像的大小，所以我们需要构建 <code>graphql-engine-packager</code> 镜像，其中包含一个精简版的根文件系统。</li><li>现在，我们将第二步中生成的graphql-engine及其依赖文件和第三步 <code>graphql-engine-packager</code> 镜像中的根文件系统合并到一个scratch镜像，然后生成 <code>graphql-engine-base</code> 的镜像，这个镜像已经包含了一个可以正常运行的 graphql-engine ，只是没有集成console资源到镜像中；</li><li>最后我们对console进行编译，生成assets资源，然后基于 <code>graphql-engine-base</code> 添加这些前端资源文件，生成我们最终需要的 <code>graphql-engine</code> 镜像；</li></ol><h2 id=graphql-engine-builder-镜像构建>graphql-engine-builder 镜像构建<a hidden class=anchor aria-hidden=true href=#graphql-engine-builder-镜像构建>#</a></h2><p>基于以下原因，我决定构建一个graphql-engine-builder的镜像：</p><ol><li>不想污染自己的主机的环境，安装一堆haskell的构建环境；</li><li>持久化编译环境，使得构建过程可以无成本迁移到任何机器；</li></ol><p>这个builder镜像包含以下内容(实际上就是haskell语言的构建环境)：</p><ul><li>GHC</li><li>cabal</li></ul><p>经过一番尝试，确定了如下Dockerfile构建脚本：</p><h3 id=x86-dockerfile><strong>X86</strong> Dockerfile<a hidden class=anchor aria-hidden=true href=#x86-dockerfile>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>#  x86 用于构建hasura的镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 构建命令 docker build -f Dockerfile -t hanlyjiang/graphql-engine-builder:latest .</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>haskell:8.10.1</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG            C.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 避免配置tzdata时出现的交互式等待界面导致构建卡住</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DEBIAN_FRONTEND noninteractive<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i <span style=color:#e6db74>&#34;s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34;</span> /etc/apt/sources.list <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   sed -i <span style=color:#e6db74>&#34;s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g&#34;</span>  /etc/apt/sources.list <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   apt-get install -y --no-install-recommends apt-utils lsb-release wget <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   echo <span style=color:#e6db74>&#34;deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main&#34;</span> &gt; /etc/apt/sources.list.d/pgdg.list <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc |  apt-key add - <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   apt-get install -y --no-install-recommends  postgresql libpq-dev <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   rm -fr /var/lib/apt/lists/* <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>   <span style=color:#75715e># 安装 upx</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>   wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>           tar -xf upx-3.96-amd64_linux.tar.xz  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>           cp upx-3.96-amd64_linux/upx /usr/bin/upx <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>           rm -fr upx-3.96-amd64_linux<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>x86版本基于 haskell官方的<code>haskell:8.10.1</code> 镜像，添加了如下动作：</p><ol><li>替换软件源为国内软件源；</li><li>安装必要的软件依赖；</li><li>添加了upx用于二进制文件优化；</li></ol><h3 id=arm-dockerfile><strong>ARM</strong> Dockerfile<a hidden class=anchor aria-hidden=true href=#arm-dockerfile>#</a></h3><p>arm版本的则需要从头构建</p><ul><li>我们使用 <code>ubuntu:18.04</code> 作为基础镜像；</li><li>首先安装了 LLVM6.0 及 GHC8.6.5 ；</li><li>使用 GHC8.6.5 构建 Cabal3.2.0.0（包括cabal-install），因为GHC8.10.1无法成功构建cabal-install 3.2；</li><li>然后安装 LLVM 9 及GHC8.10.1，用于后续编译hasura；</li><li>添加必要的依赖；</li><li>添加了upx用于二进制文件优化；</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>## Hasura graphql-engine 编译环境</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 测试发现只有在arm机器上才可能构建成功，x86 docker交叉构建失败</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build -t registry.cn-hangzhou.aliyuncs.com/geostar_private_arm/haskell-ghc8.6.5_8.10.1-cabal3.2:20200817 .</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ghc-8.6.5的安装构建需要在ubuntu18.04上（glibc2.27)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 通过如下方式确认glibc版本：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### docker run -it --rm ubuntu:18.04 bash -c &#34;find / -type f | grep libc-.*.so&#34; # 输出 /lib/x86_64-linux-gnu/libc-2.27.so</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### docker run -it --rm debian:stretch bash -c &#34;find / -type f | grep libc-.*.so&#34; # 输出 /lib/x86_64-linux-gnu/libc-2.24.so</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### docker run -it --rm debian:buster bash -c &#34;find / -type f | grep libc-.*.so&#34; # 输出 /lib/aarch64-linux-gnu/libc-2.28.so</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>### debian也可以在此页面查看：https://packages.debian.org/search?searchon=sourcenames&amp;keywords=glibc</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#FROM debian:stretch</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>ubuntu:18.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG            C.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 避免配置tzdata时出现的交互式等待界面导致构建卡住</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> DEBIAN_FRONTEND noninteractive<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 以防网络不好，切换到国内镜像源</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>     apt install -y apt-transport-https ca-certificates<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> ubuntu18.04-sources.list /etc/apt/sources.list<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 避免 hash sum mismatch 问题：</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## https://stackoverflow.com/questions/15505775/debian-apt-packages-hash-sum-mismatch</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* &amp;&amp; apt-get clean &amp;&amp; apt-get update &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 安装常用软件及GHC构建相关依赖</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y --no-install-recommends gnupg ca-certificates dirmngr curl git wget <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y --no-install-recommends zlib1g-dev libtinfo-dev libsqlite3-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                g++ netbase xz-utils libnuma-dev make openssh-client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                <span style=color:#75715e># hasura 构建需要（pg-client）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>                <span style=color:#75715e>## https://stackoverflow.com/questions/17915098/openssl-ssl-h-no-such-file-or-directory-during-installation-of-git</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>                libssl-dev libkrb5-dev <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 安装llvm 6.0（用于构建cabal）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    LLVM_VERSION<span style=color:#f92672>=</span>6.0 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># apt-get install -y software-properties-common &amp;&amp; \</span>
</span></span><span style=display:flex><span>    apt-get install -y --no-install-recommends libghc-network-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span> llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span>-dev postgresql libpq-dev <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        rm -fr /var/lib/apt/lists/* <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ln -s /usr/lib/llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span>/bin/llc /usr/local/bin/llc  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ln -s /usr/lib/llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span>/bin/opt /usr/local/bin/opt<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 安装 GHC 8.6.5（用于构建Cabal3.2.0.0）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> GHC<span style=color:#f92672>=</span>8.6.5 <span style=color:#f92672>&amp;&amp;</span> GHC_OS_DIST<span style=color:#f92672>=</span>ubuntu18.04 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e>## 下载链接类似：https://downloads.haskell.org/~ghc/8.10.1/ghc-8.10.1-aarch64-deb9-linux.tar.xz </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    wget https://downloads.haskell.org/~ghc/<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>/ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>-aarch64-<span style=color:#e6db74>${</span>GHC_OS_DIST<span style=color:#e6db74>}</span>-linux.tar.xz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    tar -xvf ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>-aarch64-<span style=color:#e6db74>${</span>GHC_OS_DIST<span style=color:#e6db74>}</span>-linux.tar.xz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cd ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./configure <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    make install <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cd ../ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>-aarch64-<span style=color:#e6db74>${</span>GHC_OS_DIST<span style=color:#e6db74>}</span>-linux.tar.xz ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span> <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 构建 Cabal 3.2.0.0 （包括 cabal-install）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git clone -b cabal-install-v3.2.0.0 https://github.com/haskell/cabal.git <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cd cabal/cabal-install <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./bootstrap.sh <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cd ../.. <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -fr cabal<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 安装 llvm 9 及其他构建所需 （postgresql libpq-dev）pg_config</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> LLVM_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y --no-install-recommends llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span> llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span>-dev postgresql libpq-dev <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 如果有旧版本的，则移除链接</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    rm /usr/local/bin/llc /usr/local/bin/opt <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ln -s /usr/lib/llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span>/bin/llc /usr/local/bin/llc <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ln -s /usr/lib/llvm-<span style=color:#e6db74>${</span>LLVM_VERSION<span style=color:#e6db74>}</span>/bin/opt /usr/local/bin/opt <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 安装ghc8.10.1 ，自带Cabal库的3.2版本</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    GHC<span style=color:#f92672>=</span>8.10.1 <span style=color:#f92672>&amp;&amp;</span> GHC_OS_DIST<span style=color:#f92672>=</span>deb9 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    wget https://downloads.haskell.org/~ghc/<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>/ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>-aarch64-<span style=color:#e6db74>${</span>GHC_OS_DIST<span style=color:#e6db74>}</span>-linux.tar.xz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    tar -xvf ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>-aarch64-<span style=color:#e6db74>${</span>GHC_OS_DIST<span style=color:#e6db74>}</span>-linux.tar.xz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cd ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ./configure <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    make install <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cd ../ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -rf ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span>-aarch64-<span style=color:#e6db74>${</span>GHC_OS_DIST<span style=color:#e6db74>}</span>-linux.tar.xz ghc-<span style=color:#e6db74>${</span>GHC<span style=color:#e6db74>}</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 安装3.96版本的upx-用于压缩优化graphql-engine二进制可执行文件（软件源中的3.94版本有压缩aarch的二进制后有问题 https://github.com/upx/upx/issues/130）</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-arm64_linux.tar.xz <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    tar -xf upx-3.96-arm64_linux.tar.xz  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp upx-3.96-arm64_linux/upx /usr/bin/upx <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rm -fr upx-3.96-arm64_linux upx-3.96-arm64_linux.tar.xz /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## stack 安装(hasura构建可不安装stack)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ARG STACK=2.1.3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ARG STACK_KEY=C5705533DA4F78D8664B5DC0575159689BEFB442</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ARG STACK_RELEASE_KEY=2C6A674E85EE3FB896AFC9B965101FF31C5C154D</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># RUN arch=`uname -m` &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     echo $arch &amp;&amp; \ </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz -o  stack.tar.gz &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz.asc -o stack.tar.gz.asc </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># RUN export GNUPGHOME=&#34;$(mktemp -d)&#34; &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_KEY} &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_RELEASE_KEY} &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     gpg --batch --trusted-key 0x575159689BEFB442 --verify stack.tar.gz.asc stack.tar.gz &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     tar -xf stack.tar.gz -C /usr/local/bin --strip-components=1 &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     /usr/local/bin/stack config set system-ghc --global true &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     /usr/local/bin/stack config set install-ghc --global false &amp;&amp; \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#     rm -rf &#34;$GNUPGHOME&#34; /var/lib/apt/lists/* /stack.tar.gz.asc /stack.tar.gz;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 设置环境变量使可以找到cabal，GHC的默认会安装到PATH中，无需额外设置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PATH /root/.cabal/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 没有指定命令的时候默认运行ghci</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;ghci&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><blockquote><p>注意：由于以上builder镜像是用于编译graphql-engine的工具镜像，而非最终的镜像，所以并未刻意对镜像大小进行优化；</p></blockquote><h2 id=graphql-engine-packager-构建>graphql-engine-packager 构建<a hidden class=anchor aria-hidden=true href=#graphql-engine-packager-构建>#</a></h2><p>packager镜像中包含一个纯净的根文件系统，可为graphql-engine server提供基础的运行环境；</p><h3 id=整体说明>整体说明<a hidden class=anchor aria-hidden=true href=#整体说明>#</a></h3><p>graphql-engine-packager的镜像构建脚本位于源码的 <code>server/packaging</code> 目录中的 <code>package.df</code> 文件中，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hasura/haskell-docker-packager:20190731</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>MAINTAINER</span> <span style=color:#e6db74>vamshi@hasura.io</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y libpq5 upx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> update-ca-certificates <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>可以看到其基于 <code>hasura/haskell-docker-packager:20190731</code> 的镜像（<a href="https://hub.docker.com/r/hasura/haskell-docker-packager/tags?page=1&amp;ordering=last_updated">DockerHub对应页面</a>），具体构建方式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>registry<span style=color:#f92672>=</span>hanlyjiang  <span style=color:#75715e># 替换成自行设置的值</span>
</span></span><span style=display:flex><span>packager_ver<span style=color:#f92672>=</span><span style=color:#ae81ff>20210316</span> <span style=color:#75715e># 替换成自行设置的值</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build -t <span style=color:#e6db74>&#39;$registry/graphql-engine-packager:$packager_ver&#39;</span> -f packaging/packager.df ./packaging/
</span></span></code></pre></div><p>从以上分析可知，我们要构建packager镜像，需要先构建<code>haskell-docker-packager</code>镜像，而对于X86版本来说，可以直接使用使用官方已经构建好的镜像，对于ARM版本来说，则需要我们从头构建；</p><h3 id=x86镜像构建>X86镜像构建<a hidden class=anchor aria-hidden=true href=#x86镜像构建>#</a></h3><p>如上所述，我们直接基于官方的 <code>hasura/haskell-docker-packager:20190731</code>并使用源码目录中的 <code>packaging/packager.df</code> 文件构建出对应的<code>graphql-engine-packager</code>镜像即可；</p><h3 id=arm>ARM<a hidden class=anchor aria-hidden=true href=#arm>#</a></h3><h4 id=haskell-docker-packager-镜像构建>haskell-docker-packager 镜像构建<a hidden class=anchor aria-hidden=true href=#haskell-docker-packager-镜像构建>#</a></h4><p>arm版本则需要我们从头构建 <code>haskell-docker-packager</code> 的镜像，基于官方的 <a href=https://github.com/hasura/haskell-docker-builder>github/hasura/haskell-docker-builder</a> 源码，我略作修改，让其可以构建出arm版本的镜像，对应的代码放置于 <a href=https://github.com/hanlyjiang/haskell-docker-builder>github/hanlyjiang/haskell-docker-builder</a> 中，执行如下命令即可构建出arm版本的 <code>haskell-docker-packager</code> 镜像：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone git@github.com:hanlyjiang/haskell-docker-builder.git 
</span></span><span style=display:flex><span>make build 
</span></span></code></pre></div><p>上述命令执行完毕后会生成一个 <code>hanlyjiang/haskell-docker-packager:当前日期</code> 的镜像。</p><h4 id=graphql-engine-packager-镜像构建>graphql-engine-packager 镜像构建<a hidden class=anchor aria-hidden=true href=#graphql-engine-packager-镜像构建>#</a></h4><p>同样的，我们在 graphql-engine的源代码的 <code>server/packaging</code> 目录中添加一个名为 <code>packaging-arm.df</code> 的文件用于构建 arm 版本的 <code>graphql-engine-packager</code> 镜像，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/haskell-docker-packager:20200814</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>MAINTAINER</span> <span style=color:#e6db74>hanlyjiang@outlook.com</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y libpq5 upx <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> update-ca-certificates <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>可通过如下命令构建arm版本镜像：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>registry<span style=color:#f92672>=</span>hanlyjiang  <span style=color:#75715e># 替换成自行设置的值</span>
</span></span><span style=display:flex><span>packager_ver<span style=color:#f92672>=</span><span style=color:#ae81ff>20210316</span> <span style=color:#75715e># 替换成自行设置的值</span>
</span></span></code></pre></div><p>构建可以在arm机器上执行，也可以在x86机器上通过buildx来交叉构建：</p><ul><li>arm 机器上执行：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker build -t <span style=color:#e6db74>&#39;$registry/graphql-engine-packager:$packager_ver&#39;</span> -f packaging/packager-arm.df ./packaging/
</span></span></code></pre></div><ul><li>非arm机器上交叉构建arm镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64 -t <span style=color:#e6db74>&#39;$registry/graphql-engine-packager:$packager_ver&#39;</span> -f packaging/packager-arm.df ./packaging/ --load
</span></span></code></pre></div><h2 id=graphql-engine-base-构建>graphql-engine-base 构建<a hidden class=anchor aria-hidden=true href=#graphql-engine-base-构建>#</a></h2><p><code>graphql-engine-base</code> 镜像包含 graphql-engine 的 server，当不包含 console 的 web 资源；</p><h3 id=x86镜像构建-1>X86镜像构建<a hidden class=anchor aria-hidden=true href=#x86镜像构建-1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>### 构建 graphql-engine 镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 编译 graphql-engine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/graphql-engine-builder:20201111</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_TAG<span style=color:#f92672>=</span>v1.3.2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_USER<span style=color:#f92672>=</span>docker-build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_PWD<span style=color:#f92672>=</span>4Kqy9Cb4FcYx2H4goiEq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine/server</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 初始化cabal的配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s cabal.project.ci cabal.project.local <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    export LANG<span style=color:#f92672>=</span>C.UTF-8 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cabal user-config update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 替换为国内源</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    sed -i <span style=color:#e6db74>&#39;s/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /root/.cabal/config  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed -i <span style=color:#e6db74>&#39;s/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g&#39;</span> /root/.cabal/config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 重新更新软件包信息(单独作为一层，以便缓存)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cabal new-update<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 编译 graphql-engine 可执行文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 我们将加载中替换为中文</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i <span style=color:#e6db74>&#39;s/Loading/加载中/g&#39;</span> src-rsr/console.html <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cabal new-build --jobs<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> build_output<span style=color:#f92672>=</span>../_build_output <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    exec_glob<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>find ./dist-newstyle/ -type f -name <span style=color:#e6db74>&#34;graphql-engine&#34;</span><span style=color:#e6db74>`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mkdir $build_output <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp <span style=color:#e6db74>&#34;</span>$exec_glob<span style=color:#e6db74>&#34;</span> $build_output/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># get-version 需要基于git仓库获取版本号</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ../scripts/get-version.sh &gt;$build_output/version.txt <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 提取基础的rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hasura/graphql-engine-packager:20190731</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>baseRootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/graphql-engine/_build_output/ /root/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /rootfs/ <span style=color:#f92672>&amp;&amp;</span> /build.sh graphql-engine | tar -x -C /rootfs/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 构建最终的rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>builder</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>bulderRootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine</span>/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pg_dump_ver<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    exec_glob<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>find server/dist-newstyle/ -type f -name <span style=color:#e6db74>&#34;graphql-engine&#34;</span><span style=color:#e6db74>`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    build_output<span style=color:#f92672>=</span>./_build_output  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    packaging_dir<span style=color:#f92672>=</span>./server/packaging/  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rootfs_dir<span style=color:#f92672>=</span>$packaging_dir/build/rootfs  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp $build_output/graphql-engine $rootfs_dir/bin <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 获取所有动态链接库</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ldd $build_output/graphql-engine | awk <span style=color:#e6db74>&#39;BEGIN{ORS=&#34;\n&#34;}$1~/^\//{print $1}$3~/^\//{print $3}&#39;</span> | xargs cp -n -L --parents -t $rootfs_dir/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 获取 pg_dump</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 优化&amp;压缩</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    strip --strip-unneeded $rootfs_dir/bin/graphql-engine <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    upx $rootfs_dir/bin/graphql-engine <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## - 不带 console-assets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>scratch</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>graphql-engine-base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG<span style=color:#f92672>=</span>C.UTF-8 LC_ALL<span style=color:#f92672>=</span>C.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;graphql-engine&#34;</span>, <span style=color:#e6db74>&#34;serve&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>执行如下命令构建：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build -t graphql-engine-base:$TAG ./ 
</span></span></code></pre></div><h3 id=arm版本镜像构建>ARM版本镜像构建<a hidden class=anchor aria-hidden=true href=#arm版本镜像构建>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>### 构建 graphql-engine 镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker buildx build --platform=linux/arm64  -f Dockerfile-base-arm.dockerfile -t graphql-engine-base:arm-20201109 ./ --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 构建准备</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker pull hanlyjiang/graphql-engine-builder:arm-latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 编译 graphql-engine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/graphql-engine-builder:arm-latest</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_TAG<span style=color:#f92672>=</span>v1.3.2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_USER<span style=color:#f92672>=</span>docker-build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_PWD<span style=color:#f92672>=</span>4Kqy9Cb4FcYx2H4goiEq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine/server</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 初始化cabal的配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s cabal.project.ci cabal.project.local <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    export LANG<span style=color:#f92672>=</span>C.UTF-8 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cabal user-config update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 替换为国内源</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    sed -i <span style=color:#e6db74>&#39;s/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /root/.cabal/config  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed -i <span style=color:#e6db74>&#39;s/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g&#39;</span> /root/.cabal/config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 重新更新软件包信息(单独作为一层，以便缓存)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## update 过程中可能自动去github下载仓库</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cabal new-update<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 编译 graphql-engine 可执行文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i <span style=color:#e6db74>&#39;s/Loading/加载中/g&#39;</span> src-rsr/console.html <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cabal new-build --jobs<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> build_output<span style=color:#f92672>=</span>../_build_output <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    exec_glob<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>find ./dist-newstyle/ -type f -name <span style=color:#e6db74>&#34;graphql-engine&#34;</span><span style=color:#e6db74>`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mkdir $build_output <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp <span style=color:#e6db74>&#34;</span>$exec_glob<span style=color:#e6db74>&#34;</span> $build_output/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># get-version 需要基于git仓库获取版本号</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ../scripts/get-version.sh &gt;$build_output/version.txt <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 提取基础的rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64  -f Dockerfile-base.dockerfile --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/graphql-engine-packager:20200814</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>baseRootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/graphql-engine/_build_output/ /root/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># build.sh 的内容就是下面的 ldd graphql-engine | awk &#39;BEGIN{ORS=&#34;\n&#34;}$1~/^\//{print $1}$3~/^\//{print $3}&#39; | xargs cp -n -L --parents -t ，用于拷贝packager镜像中graphql-engine需要的依赖库到rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /rootfs/ <span style=color:#f92672>&amp;&amp;</span> /build.sh graphql-engine | tar -x -C /rootfs/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 构建最终的rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>builder</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>bulderRootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine</span>/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pg_dump_ver<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    exec_glob<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>find server/dist-newstyle/ -type f -name <span style=color:#e6db74>&#34;graphql-engine&#34;</span><span style=color:#e6db74>`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    build_output<span style=color:#f92672>=</span>./_build_output  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    packaging_dir<span style=color:#f92672>=</span>./server/packaging/  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rootfs_dir<span style=color:#f92672>=</span>$packaging_dir/build/rootfs  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp $build_output/graphql-engine $rootfs_dir/bin <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 获取所有动态链接库</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ldd $build_output/graphql-engine | awk <span style=color:#e6db74>&#39;BEGIN{ORS=&#34;\n&#34;}$1~/^\//{print $1}$3~/^\//{print $3}&#39;</span> | xargs cp -n -L --parents -t $rootfs_dir/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 获取 pg_dump(arm builder镜像路径不一样)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cp /usr/share/postgresql-common/pg_wrapper $rootfs_dir/bin/pg_dump <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 优化&amp;压缩</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    strip --strip-unneeded $rootfs_dir/bin/graphql-engine <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    upx $rootfs_dir/bin/graphql-engine <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## - 不带 console-assets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base-arm:20201110 --target graphql-engine-base ./ --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>scratch</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>graphql-engine-base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jianghanghang@geostar.com.cn&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG<span style=color:#f92672>=</span>C.UTF-8 LC_ALL<span style=color:#f92672>=</span>C.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;graphql-engine&#34;</span>, <span style=color:#e6db74>&#34;serve&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>执行如下命令构建：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ARM机器执行</span>
</span></span><span style=display:flex><span>docker build  -t graphql-engine-base:arm-$TAG  ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># x86交叉构建</span>
</span></span><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64 -t  graphql-engine-base:arm-$TAG ./ --load
</span></span></code></pre></div><h3 id=构建脚本合并简化未验证>构建脚本合并简化（未验证）<a hidden class=anchor aria-hidden=true href=#构建脚本合并简化未验证>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>### 构建 graphql-engine 镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 编译 graphql-engine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> builder_image<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> packager_image<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>${builder_image</span><span style=color:#f92672>}</span> as builder<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_TAG<span style=color:#f92672>=</span>v1.3.2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_USER<span style=color:#f92672>=</span>docker-build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_PWD<span style=color:#f92672>=</span>4Kqy9Cb4FcYx2H4goiEq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine/server</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 初始化cabal的配置</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> ln -s cabal.project.ci cabal.project.local <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    export LANG<span style=color:#f92672>=</span>C.UTF-8 <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cabal user-config update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 替换为国内源</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    sed -i <span style=color:#e6db74>&#39;s/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g&#39;</span> /root/.cabal/config  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed -i <span style=color:#e6db74>&#39;s/mirrors.tuna.tsinghua.edu.cn\//mirrors.tuna.tsinghua.edu.cn\/hackage/g&#39;</span> /root/.cabal/config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 重新更新软件包信息(单独作为一层，以便缓存)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cabal new-update<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 编译 graphql-engine 可执行文件</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 我们将加载中替换为中文</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> sed -i <span style=color:#e6db74>&#39;s/Loading/加载中/g&#39;</span> src-rsr/console.html <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cabal new-build --jobs<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> build_output<span style=color:#f92672>=</span>../_build_output <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    exec_glob<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>find ./dist-newstyle/ -type f -name <span style=color:#e6db74>&#34;graphql-engine&#34;</span><span style=color:#e6db74>`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mkdir $build_output <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp <span style=color:#e6db74>&#34;</span>$exec_glob<span style=color:#e6db74>&#34;</span> $build_output/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># get-version 需要基于git仓库获取版本号</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ../scripts/get-version.sh &gt;$build_output/version.txt <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 提取基础的rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>${packager_image</span><span style=color:#f92672>}</span> as baseRootfs<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/graphql-engine/_build_output/ /root/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mkdir /rootfs/ <span style=color:#f92672>&amp;&amp;</span> /build.sh graphql-engine | tar -x -C /rootfs/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## 构建最终的rootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>builder</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>bulderRootfs</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine</span>/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> pg_dump_ver<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    exec_glob<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>find server/dist-newstyle/ -type f -name <span style=color:#e6db74>&#34;graphql-engine&#34;</span><span style=color:#e6db74>`</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    build_output<span style=color:#f92672>=</span>./_build_output  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    packaging_dir<span style=color:#f92672>=</span>./server/packaging/  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rootfs_dir<span style=color:#f92672>=</span>$packaging_dir/build/rootfs  <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp $build_output/graphql-engine $rootfs_dir/bin <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 获取所有动态链接库</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    ldd $build_output/graphql-engine | awk <span style=color:#e6db74>&#39;BEGIN{ORS=&#34;\n&#34;}$1~/^\//{print $1}$3~/^\//{print $3}&#39;</span> | xargs cp -n -L --parents -t $rootfs_dir/ <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 获取 pg_dump</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># 优化&amp;压缩</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    strip --strip-unneeded $rootfs_dir/bin/graphql-engine <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    upx $rootfs_dir/bin/graphql-engine <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## - 不带 console-assets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>scratch</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>graphql-engine-base</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> LANG<span style=color:#f92672>=</span>C.UTF-8 LC_ALL<span style=color:#f92672>=</span>C.UTF-8<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;graphql-engine&#34;</span>, <span style=color:#e6db74>&#34;serve&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>构建命令：</p><ul><li><p><strong>X86</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>builder_image<span style=color:#f92672>=</span>hanlyjiang/graphql-engine-builder:20201111
</span></span><span style=display:flex><span>packager_image<span style=color:#f92672>=</span>hasura/graphql-engine-packager:20190731
</span></span><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build ./ -t graphql-engine-base:$TAG --build-arg builder_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$builder_image<span style=color:#e6db74>&#34;</span> --build-arg packager_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$packager_image<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div></li><li><p><strong>ARM</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>builder_image<span style=color:#f92672>=</span>hanlyjiang/graphql-engine-builder:arm-latest
</span></span><span style=display:flex><span>packager_image<span style=color:#f92672>=</span>hanlyjiang/graphql-engine-packager:20200814
</span></span><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ARM机器执行</span>
</span></span><span style=display:flex><span>docker build  -t graphql-engine-base:arm-$TAG --build-arg builder_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$builder_image<span style=color:#e6db74>&#34;</span> --build-arg packager_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$packager_image<span style=color:#e6db74>&#34;</span> ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># x86交叉构建</span>
</span></span><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64 -t  graphql-engine-base:arm-$TAG --build-arg builder_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$builder_image<span style=color:#e6db74>&#34;</span> --build-arg packager_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$packager_image<span style=color:#e6db74>&#34;</span> ./ --load
</span></span></code></pre></div></li></ul><h2 id=graphql-engine-镜像构建>graphql-engine 镜像构建<a hidden class=anchor aria-hidden=true href=#graphql-engine-镜像构建>#</a></h2><p>graphql-engine 即是我们最终需要使用的镜像，包含graphql-engine 的server及console web资源；</p><h3 id=x86>X86<a hidden class=anchor aria-hidden=true href=#x86>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>### 构建 graphql-engine 镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker build -t graphql-engine:20201111 ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 构建 console </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/node-11-alpine-git:20201113</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>consoleBuilder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 有时console代码更新，我们直接从仓库获取最新代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY --from=builder /app/graphql-engine/console /app/console</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_TAG<span style=color:#f92672>=</span>v1.3.2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_USER<span style=color:#f92672>=</span>docker-build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_PWD<span style=color:#f92672>=</span>4Kqy9Cb4FcYx2H4goiEq
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine/console</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 单独提取install步骤便于缓存</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux ; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    npm config set sass_binary_site<span style=color:#f92672>=</span>https://npm.taobao.org/mirrors/node-sass <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    npm install --registry<span style=color:#f92672>=</span>https://registry.npm.taobao.org<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># RUN npm install</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> git pull <span style=color:#f92672>&amp;&amp;</span> npm run build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 开始构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux ; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CONSOLE_ASSETS_PATH<span style=color:#f92672>=</span>./static/assets <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    DIST_PATH<span style=color:#f92672>=</span>./static/dist <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ls -laR $DIST_PATH <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/common&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		mkdir -p $CONSOLE_ASSETS_PATH/common; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		cp -r <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>/../assets/common&#34;</span> <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>fi</span>;  <span style=color:#ae81ff>\ </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	rm -rf <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	mkdir -p <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>&#34;</span>/*.js <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned/&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cp <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>&#34;</span>/*.css <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned/&#34;</span> <span style=color:#f92672>||</span> true <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css <span style=color:#f92672>||</span> true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 构建最终镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker build --progress plain -t graphql-engine:20201110 ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jianghanghang@geostar.com.cn&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> docker-entrypoint.sh /usr/local/bin/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s usr/local/bin/docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>执行如下命令构建：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>docker build -t graphql-engine:$TAG ./
</span></span></code></pre></div><h3 id=arm-1>ARM<a hidden class=anchor aria-hidden=true href=#arm-1>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>### 构建 graphql-engine 镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 构建 console </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/node-11-alpine-git:20201113</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>consoleBuilder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 有时console代码更新，我们直接从仓库获取最新代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY --from=builder /app/graphql-engine/console /app/console</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_TAG<span style=color:#f92672>=</span>v1.3.2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_USER<span style=color:#f92672>=</span>docker-build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_PWD<span style=color:#f92672>=</span>4Kqy9Cb4FcYx2H4goiEq
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine/console</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 单独提取install步骤便于缓存</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install --registry<span style=color:#f92672>=</span>https://registry.npm.taobao.org<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm run build <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 开始构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux ; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CONSOLE_ASSETS_PATH<span style=color:#f92672>=</span>./static/assets <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    DIST_PATH<span style=color:#f92672>=</span>./static/dist <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ls -laR $DIST_PATH <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/common&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		mkdir -p $CONSOLE_ASSETS_PATH/common; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		cp -r <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>/../assets/common&#34;</span> <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>fi</span>;  <span style=color:#ae81ff>\ </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	rm -rf <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	mkdir -p <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>&#34;</span>/*.js <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned/&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cp <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>&#34;</span>/*.css <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned/&#34;</span> <span style=color:#f92672>||</span> true <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css <span style=color:#f92672>||</span> true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 构建最终镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jianghanghang@geostar.com.cn&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> docker-entrypoint.sh /usr/local/bin/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s usr/local/bin/docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>构建命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:$TAG ./
</span></span><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-$TAG ./ --load
</span></span></code></pre></div><h3 id=构建脚本简化未验证>构建脚本简化(未验证)<a hidden class=anchor aria-hidden=true href=#构建脚本简化未验证>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e>### 构建 graphql-engine 镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> base_image<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 构建 console </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>hanlyjiang/node-11-alpine-git:20201113</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>consoleBuilder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 有时console代码更新，我们直接从仓库获取最新代码</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY --from=builder /app/graphql-engine/console /app/console</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_TAG<span style=color:#f92672>=</span>v1.3.2<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_USER<span style=color:#f92672>=</span>docker-build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> GIT_PWD<span style=color:#f92672>=</span>4Kqy9Cb4FcYx2H4goiEq
</span></span><span style=display:flex><span><span style=color:#66d9ef>RUN</span> git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span> <span style=color:#e6db74>/app/graphql-engine/console</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 单独提取install步骤便于缓存</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install --registry<span style=color:#f92672>=</span>https://registry.npm.taobao.org<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm run build <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 开始构建</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -eux ; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    CONSOLE_ASSETS_PATH<span style=color:#f92672>=</span>./static/assets <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    DIST_PATH<span style=color:#f92672>=</span>./static/dist <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    ls -laR $DIST_PATH <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/common&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		mkdir -p $CONSOLE_ASSETS_PATH/common; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>		cp -r <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>/../assets/common&#34;</span> <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>&#34;</span>; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	<span style=color:#66d9ef>fi</span>;  <span style=color:#ae81ff>\ </span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>	rm -rf <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	mkdir -p <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    cp <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>&#34;</span>/*.js <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned/&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	gzip -f $CONSOLE_ASSETS_PATH/versioned/*.js <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#75715e># console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    cp <span style=color:#e6db74>&#34;</span>$DIST_PATH<span style=color:#e6db74>&#34;</span>/*.css <span style=color:#e6db74>&#34;</span>$CONSOLE_ASSETS_PATH<span style=color:#e6db74>/versioned/&#34;</span> <span style=color:#f92672>||</span> true <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css <span style=color:#f92672>||</span> true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>## -- 构建最终镜像</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>${base_image</span><span style=color:#f92672>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>LABEL</span> maintainer<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jianghanghang@geostar.com.cn&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> docker-entrypoint.sh /usr/local/bin/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /usr/local/bin/docker-entrypoint.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> ln -s usr/local/bin/docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><ul><li><p>x86构建：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>base_image<span style=color:#f92672>=</span>zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build ./ -t graphql-engine-base:$TAG --build-arg base_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$base_image<span style=color:#e6db74>&#34;</span> --build-arg 
</span></span></code></pre></div></li><li><p>arm构建</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>base_image<span style=color:#f92672>=</span>zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TAG<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date <span style=color:#e6db74>&#39;+%Y%m%d&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># arm 机器直接构建</span>
</span></span><span style=display:flex><span>docker build ./ -t graphql-engine:arm-$TAG --build-arg base_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$base_image<span style=color:#e6db74>&#34;</span> --build-arg 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># x86交叉构建</span>
</span></span><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64 -t  graphql-engine:arm-$TAG --build-arg base_image<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$base_image<span style=color:#e6db74>&#34;</span> ./ --load
</span></span></code></pre></div></li></ul><h1 id=geopanel容器化-自研服务镜像构建>GeoPanel容器化-自研服务镜像构建<a hidden class=anchor aria-hidden=true href=#geopanel容器化-自研服务镜像构建>#</a></h1><h2 id=前言-1>前言<a hidden class=anchor aria-hidden=true href=#前言-1>#</a></h2><p>所有当前已经构建的服务，都可以通过<a href=http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/README.md>gepanel-deploy 仓库中的readme</a>进行快速导航，如：</p><h2 id=blockapi-token-服务镜像构建>blockapi-token 服务镜像构建<a hidden class=anchor aria-hidden=true href=#blockapi-token-服务镜像构建>#</a></h2><p>镜像构建的相关文件目录位于 <a href=http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/tree/v1.3.2/docker/hasura-token>gitlab此路径</a>，具体构建时操作步骤如下：</p><ol><li><strong>王峰</strong>提供成品jar包；</li><li>放置到此目录执行docker buildx build 命令打包；</li></ol><p>由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：</p><ul><li><a href=http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/Dockerfile>dockerfile</a></li><li><a href=http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/README.md>打包及使用方式</a></li></ul><h2 id=blockapi-db-integrate-服务镜像构建>blockapi-db-integrate 服务镜像构建<a hidden class=anchor aria-hidden=true href=#blockapi-db-integrate-服务镜像构建>#</a></h2><p>数据库集成服务的镜像构建相关文件位于 <a href=http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev/docker>gitlab此路径</a> ，具体构建时操作步骤如下：</p><ol><li><strong>韩小乐</strong> 提供成品jar或者我们自行从<a href=http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev>源码</a>编译jar；</li><li>放置到docker构建目录使用docker buildx build命令构建；</li></ol><p>由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：</p><ul><li><a href=http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/Dockerfile>dockerfile</a></li><li><a href=http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/README.md>打包及使用方式</a></li></ul><h2 id=blockapi-restapi-服务镜像构建>blockapi-restapi 服务镜像构建<a hidden class=anchor aria-hidden=true href=#blockapi-restapi-服务镜像构建>#</a></h2><p>由于之前有完成过，在此不在叙述，可参考 <a href=http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/rest-api/-/tree/master/docker>此gitlab目录</a></p><h2 id=gpl-datacollection-服务镜像构建>gpl-datacollection 服务镜像构建<a hidden class=anchor aria-hidden=true href=#gpl-datacollection-服务镜像构建>#</a></h2><p>埋点系统服务镜像的构建文件位于 <a href=http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/tree/develop/docker>gitlab此路径</a> ，具体构建时操作步骤如下：</p><ol><li><strong>王峰</strong> 提供成品jar；</li><li>放置到docker构建目录使用 docker buildx build命令构建；</li></ol><p>由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：</p><ul><li><a href=http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/Dockerfile>dockerfile</a></li><li><a href=http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/README.md>打包及使用方式</a></li></ul><h1 id=geopanel容器化-服务编排>GeoPanel容器化-服务编排<a hidden class=anchor aria-hidden=true href=#geopanel容器化-服务编排>#</a></h1><h2 id=镜像存储及分发管理>镜像存储及分发管理<a hidden class=anchor aria-hidden=true href=#镜像存储及分发管理>#</a></h2><ol><li>harbor 为内网基于 <a href=https://goharbor.io/>harbor</a> 搭建的私有docker registry;</li><li>对于自行构建的镜像，我们只需要将镜像推送到harbor，根据配置好的自动复制规则，镜像会自动同步到阿里云私有docker镜像仓库，之后该镜像即可从阿里云镜像仓库拉取；</li><li>harbor仓库可使用域账号进行登录，按项目进行读写权限控制；</li><li>阿里云的私有镜像仓库开放一个公用的只读账号，不接受手动镜像推送；</li><li>实际部署时，可根据现场的网络情况，选择使用公司仓库/阿里云仓库在线拉取，或者使用镜像批量导出脚本批量导出镜像文件，进行离线部署；</li></ol><h2 id=geopanel服务名及变量命名约定>GeoPanel服务名及变量命名约定<a hidden class=anchor aria-hidden=true href=#geopanel服务名及变量命名约定>#</a></h2><h3 id=自有服务命名约定>自有服务命名约定<a hidden class=anchor aria-hidden=true href=#自有服务命名约定>#</a></h3><p>规范服务命名能方便标识服务之间的逻辑关系，对应的服务命名会反映到集群部署中服务的名称，服务中接口/页面的基础地址，服务相关的配置变量。</p><ul><li>服务中应包含服务所属的模块内容缩写，如块数据api引擎为blockapi；</li><li>服务的容器编排名称，镜像名称，服务的基础服务地址，服务在整个集群中的导入或导出的配置变量名称均应保持一致性；</li></ul><p>目前有如下几个主要服务单元：</p><h4 id=当前集群服务命名><strong>当前集群服务命名</strong><a hidden class=anchor aria-hidden=true href=#当前集群服务命名>#</a></h4><table><thead><tr><th>服务</th><th>命名说明</th></tr></thead><tbody><tr><td>块数据API引擎</td><td>命名为 blockapi ，包含以下服务：1. <code>blockapi</code> : 块数据api引擎服务（基础hasura graphql引擎）2. <code>blockapi-token</code>: 块数据api引擎扩展模块-token管理service 3. <code>blockapi-db-integrate</code>：块数据api引擎扩展模块-数据库集成service 4. <code>blockapi-restapi</code>: 块数据api引擎扩展模块-restapi service</td></tr><tr><td>埋点日志管理系统</td><td>命名 ： <code>gpl-data-collection</code></td></tr></tbody></table><h4 id=当前各服务接口web界面基础地址><strong>当前各服务接口/web界面基础地址：</strong><a hidden class=anchor aria-hidden=true href=#当前各服务接口web界面基础地址>#</a></h4><table><thead><tr><th>服务</th><th>基础地址</th><th>示例</th></tr></thead><tbody><tr><td>blockapi</td><td>-</td><td>保持和开源版本graphql-engine一致</td></tr><tr><td>blockapi-token</td><td>/block-api/tks</td><td>http://192.168.43.73:8881/block-api/tks</td></tr><tr><td>blockapi-db-integrate</td><td>/block-api/db-intgrs</td><td>http://192.168.43.73:8882/block-api/db-intgrs</td></tr><tr><td>blockapi-restapi</td><td>/block-api/restapi</td><td><a href=http://172.17.0.105:8884/block-api/restapi>http://172.17.0.105:8884/block-api/restapi</a></td></tr><tr><td>gpl-data-collection</td><td>/gpl-dc</td><td>http://192.168.43.73:8883/gpl-dc</td></tr></tbody></table><h3 id=通用变量说明>通用变量说明<a hidden class=anchor aria-hidden=true href=#通用变量说明>#</a></h3><h4 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h4><p>在服务部署时，我们使用环境变量来为各个服务提供需要的配置，以下通用变量用于减少服务部署时所需要的变量，大致按以下原则：</p><ul><li>相同含义的变量尽量统一为一个</li><li>有可能内部和外部用途的服务使用两个变量区分开来</li><li>变量命名需要带上服务名前缀</li></ul><blockquote><p><strong>外部URL和内部URL说明：（下方部分服务会导出内部和外部两个url的变量）</strong></p><ul><li><strong>内部URL</strong>：在docker集群内部，可以使用服务名替代IP地址访问对应的服务，一般用于服务内部之间互相访问；（如使用内部URL，在部署时可不需要修改配置）</li><li><strong>外部URL</strong>：当服务需要给客户端（如APP或浏览器）或不属于我方服务集群的其他服务调用时，需要提供外部的IP（非docker集群内部）给外部访问；</li></ul></blockquote><table><thead><tr><th style=text-align:left><strong>服务</strong></th><th style=text-align:left><strong>变量名</strong></th><th style=text-align:left>说明及示例值</th><th><strong>springboot变量名</strong></th></tr></thead><tbody><tr><td style=text-align:left>postgres</td><td style=text-align:left></td><td style=text-align:left></td><td></td></tr><tr><td style=text-align:left>zookeeper</td><td style=text-align:left></td><td style=text-align:left>暂未供外部使用，不导出变量</td><td></td></tr><tr><td style=text-align:left>kafka</td><td style=text-align:left><em>kafka 内部地址</em><code>KAFKA_INTERNAL_URL</code></td><td style=text-align:left>kafka:9092</td><td>kafka.internal_url</td></tr><tr><td style=text-align:left></td><td style=text-align:left><em>kafka 外部地址</em><code>KAFKA_EXTERNAL_URL</code></td><td style=text-align:left>192.168.43.22:9094</td><td>kafka.external_url</td></tr><tr><td style=text-align:left>redis</td><td style=text-align:left>Redis服务主机<code>REDIS_HOST</code></td><td style=text-align:left>redis</td><td>redis.host</td></tr><tr><td style=text-align:left></td><td style=text-align:left>Redis服务端口<code>REDIS_PORT</code></td><td style=text-align:left>6379</td><td>redis.port</td></tr><tr><td style=text-align:left></td><td style=text-align:left>Redis服务访问密码<code>REDIS_PASSWORD</code></td><td style=text-align:left>vsMEDgmxZdjOi7Nd</td><td>redis.password</td></tr><tr><td style=text-align:left>blockapi</td><td style=text-align:left>块数据API引擎数据库地址<code>HASURA_GRAPHQL_DATABASE_URL</code><code>BLOCKAPI_DATABASE_URL</code></td><td style=text-align:left>postgres://postgres:d8cfe3137214759a932014084ac410b9@postgres:5432/hasura</td><td>blockapi.database_url</td></tr><tr><td style=text-align:left></td><td style=text-align:left>块数据API引擎管理密钥<code>HASURA_GRAPHQL_ADMIN_SECRET</code><code>BLOCKAPI_ADMIN_SECRET</code></td><td style=text-align:left>d8cfe3137214759a932014084ac410b9两个变量含义一致，优先使用 BLOCKAPI_ADMIN_SECRET</td><td>blockapi.admin_secert</td></tr><tr><td style=text-align:left></td><td style=text-align:left>块数据API引擎内部地址<code>BLOCKAPI_INTERNAL_URL</code></td><td style=text-align:left><code>http://graphql-engine:8080</code></td><td>blockapi.internal_url</td></tr><tr><td style=text-align:left></td><td style=text-align:left>块数据API引擎的外部地址<code>BLOCKAPI_EXTERNAL_URL</code></td><td style=text-align:left><code>http://192.168.43.22:8883</code></td><td>blockapi.external_url</td></tr><tr><td style=text-align:left>blockapi-token</td><td style=text-align:left>块数据API引擎token管理服务内部接口地址<code>BLOCKAPI_TOKEN_INTERNAL_URL</code></td><td style=text-align:left>http://blockapi-token:9099/block-api/tks</td><td>blockapi.token.internal_url</td></tr><tr><td style=text-align:left></td><td style=text-align:left>块数据API引擎token管理服务外部接口地址<code>BLOCKAPI_TOKEN_EXTERNAL_URL</code></td><td style=text-align:left>http://192.168.43.73:8881/block-api/tks</td><td>blockapi.token.external_url</td></tr><tr><td style=text-align:left>blockapi-db-integrate</td><td style=text-align:left>块数据API引擎数据库集成服务外部接口地址<code>BLOCKAPI_DATABASE_INTEGRATE_EXTERNAL_URL</code></td><td style=text-align:left>http://192.168.43.73:8882/block-api/db-intgrs</td><td>blockapi.database_intergrate.external_url</td></tr><tr><td style=text-align:left>gpl-data-collection</td><td style=text-align:left>埋点系统服务地址，暂未供外部使用，但提供预定义2个变量<code>GPL_DATACOLLECTION_INTERNAL_URL</code></td><td style=text-align:left></td><td>gpl_datacollection.internal_url</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>GPL_DATACOLLECTION_EXTERNAL_URL</code></td><td style=text-align:left></td><td>gpl_datacollection.external_url</td></tr></tbody></table><h4 id=在springboot中使用变量>在springboot中使用变量<a hidden class=anchor aria-hidden=true href=#在springboot中使用变量>#</a></h4><blockquote><p>待补充</p></blockquote><h2 id=当前服务编排策略>当前服务编排策略<a hidden class=anchor aria-hidden=true href=#当前服务编排策略>#</a></h2><p>当前将所有已经容器化的服务划分为如下服务部署单元：</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

G[GeoPanel] --&gt; B

G --&gt; K

G --&gt; GPL_DC

B[blockapi] --&gt; blockapi-engine
B --&gt; postgres
B --&gt; redis
B --&gt; blockapi-token
B --&gt; blockapi-db-integrate
B --&gt; blockapi-restapi

K[kafka] --&gt; kafka
K --&gt; zookeeper

GPL_DC[gpl-datacollection] --&gt; gpl-datacollection
</code></pre><p>目前分为三块（blockapi，kafka，gpl-datacollection），每个模块分别对应一个swarm的部署yml配置，可以单独进行启动，使用相同的stack名称启动后，则可以进入一个stack中；</p><p>部署仓库地址位于<a href=http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/geopanel-deploy>gitlab上</a>。</p><h2 id=当前部署仓库细节说明>当前部署仓库细节说明<a hidden class=anchor aria-hidden=true href=#当前部署仓库细节说明>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── README.md -- 文档说明
</span></span><span style=display:flex><span>├── blockapi -- 块数据api引擎的部署配置所在目录
</span></span><span style=display:flex><span>│   ├── README.md -- 块数据api引擎的配置及启动说明文档
</span></span><span style=display:flex><span>│   ├── config.env -- 单独的配置文件，目前未使用
</span></span><span style=display:flex><span>│   ├── db-init - 数据库初始化脚本，仅做备份，目前未使用
</span></span><span style=display:flex><span>│   │   ├── 00_fdws.sh
</span></span><span style=display:flex><span>│   │   ├── 10_postgis.sh
</span></span><span style=display:flex><span>│   │   └── 20_gpl_data_collection.sql
</span></span><span style=display:flex><span>│   ├── docker-compose-arm.yml -- arm版本的部署配置文件
</span></span><span style=display:flex><span>│   ├── docker-compose.yml -- x86版本的部署配置文件
</span></span><span style=display:flex><span>│   └── redis-config -- redis 配置
</span></span><span style=display:flex><span>│       └── redis.conf
</span></span><span style=display:flex><span>├── data -- 数据挂载目录
</span></span><span style=display:flex><span>│   └── redis
</span></span><span style=display:flex><span>├── deploy.sh -- 辅助部署脚本
</span></span><span style=display:flex><span>├── env -- 全局配置目录
</span></span><span style=display:flex><span>│   └── global.env -- 全局配置，包含所有配置项目，如可能有需要使用公共配置的，服务都应该在yml中声明时引用此配置
</span></span><span style=display:flex><span>├── gpl-datacollection -- 埋点管理系统部署配置目录
</span></span><span style=display:flex><span>│   ├── README.md -- 埋点系统的配置修改及启动方式说明文档
</span></span><span style=display:flex><span>│   ├── config.env -- 埋点系统的单独的配置文件，目前未使用
</span></span><span style=display:flex><span>│   └── docker-compose.yml --埋点系统的部署启动配置文件
</span></span><span style=display:flex><span>├── kafka -- kafka的部署配置目录
</span></span><span style=display:flex><span>│   ├── README.md -- kafka服务说明，kafka验证方式说明
</span></span><span style=display:flex><span>│   └── docker-compose.yml -- 部署配置文件
</span></span></code></pre></div><p>总的来说，目前有如下结构设计：</p><ol><li>按逻辑相关性将服务进行一定的划分，一个单元的服务的部署相关文件及配置在一个部署目录中单独存储，使用一个docker-compose.yml文件来编排，可以单独启动；</li><li>使用一个 <code>env/global.env</code> 文件来存放所有需要修改的配置及全局配置/需要共享的配置-以方便部署时统一修改，每个部署单元中预留一个<code>.env</code>文件-用于存放私有配置，只是目前都没有使用；</li><li>提供了一个 <code>deploy.sh</code> 的辅助部署脚本用于简化部署步骤，但此脚本目前并不够完善；</li><li>每个部署目录提供README.md单独对当前目录中的部署单元进行说明，一般应包含配置修改说明，部署启动说明，启动成功确认方式，数据挂载情况说明，根据具体情况也可以提供简单的测试步骤；</li></ol><blockquote><p>对于各个部署单元的部署文件，不再单独说明，请参考仓库中的yml部署文件及readme</p></blockquote></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://hanlyjiang.github.io/posts/%E7%A7%BB%E5%8A%A8%E4%B8%AD%E5%BF%83%E4%BA%A4%E6%8E%A5/><span class=title>« Prev</span><br><span>移动中心交接</span>
</a><a class=next href=https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/><span class=title>Next »</span><br><span>搭建Android源码工作环境</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hanlyjiang.github.io/>清水池塘</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>