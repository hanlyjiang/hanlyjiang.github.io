<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>搭建Android源码工作环境 | 清水池塘</title><meta name=keywords content="Android,源码分析"><meta name=description content="
简单介绍系统架构、编译环境的搭建
简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式

Android系统架构
Android 系统架构如下两图所示：




应用框架。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。
Binder IPC。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。
系统服务。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。
硬件抽象层 (HAL)。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅硬件抽象层 (HAL)。
Linux 内核。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 PowerManager 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅构建内核一文。


以上部分内容来源： https://source.android.google.cn/devices/architecture?hl=zh-cn

搭建开发环境并编译源码
本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。
选择分支
可参考 source.android.google.cn 的文档 代号、标记和 Build 号 ，可以看到当前最新的版本及标记如下："><meta name=author content="野生莲藕"><link rel=canonical href=https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/><link crossorigin=anonymous href=/assets/css/stylesheet.d77462565513052a87c950bb53e36f2bd3370ba61307f161d7a360a3f34c13d5.css integrity="sha256-13RiVlUTBSqHyVC7U+NvK9M3C6YTB/Fh16Ngo/NME9U=" rel="preload stylesheet" as=style><link rel=icon href=https://hanlyjiang.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hanlyjiang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanlyjiang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hanlyjiang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hanlyjiang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/"><meta property="og:site_name" content="清水池塘"><meta property="og:title" content="搭建Android源码工作环境"><meta property="og:description" content=" 简单介绍系统架构、编译环境的搭建 简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式 Android系统架构 Android 系统架构如下两图所示：
应用框架。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。 Binder IPC。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。 系统服务。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。 硬件抽象层 (HAL)。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅硬件抽象层 (HAL)。 Linux 内核。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 PowerManager 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅构建内核一文。 以上部分内容来源： https://source.android.google.cn/devices/architecture?hl=zh-cn
搭建开发环境并编译源码 本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。
选择分支 可参考 source.android.google.cn 的文档 代号、标记和 Build 号 ，可以看到当前最新的版本及标记如下："><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-08T10:18:50+00:00"><meta property="article:modified_time" content="2021-04-08T10:18:50+00:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="源码分析"><meta name=twitter:card content="summary"><meta name=twitter:title content="搭建Android源码工作环境"><meta name=twitter:description content="
简单介绍系统架构、编译环境的搭建
简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式

Android系统架构
Android 系统架构如下两图所示：




应用框架。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。
Binder IPC。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。
系统服务。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。
硬件抽象层 (HAL)。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅硬件抽象层 (HAL)。
Linux 内核。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 PowerManager 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅构建内核一文。


以上部分内容来源： https://source.android.google.cn/devices/architecture?hl=zh-cn

搭建开发环境并编译源码
本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。
选择分支
可参考 source.android.google.cn 的文档 代号、标记和 Build 号 ，可以看到当前最新的版本及标记如下："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hanlyjiang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"搭建Android源码工作环境","item":"https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"搭建Android源码工作环境","name":"搭建Android源码工作环境","description":" 简单介绍系统架构、编译环境的搭建 简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式 Android系统架构 Android 系统架构如下两图所示：\n应用框架。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。 Binder IPC。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。 系统服务。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。 硬件抽象层 (HAL)。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅硬件抽象层 (HAL)。 Linux 内核。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 PowerManager 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅构建内核一文。 以上部分内容来源： https://source.android.google.cn/devices/architecture?hl=zh-cn\n搭建开发环境并编译源码 本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。\n选择分支 可参考 source.android.google.cn 的文档 代号、标记和 Build 号 ，可以看到当前最新的版本及标记如下：\n","keywords":["Android","源码分析"],"articleBody":" 简单介绍系统架构、编译环境的搭建 简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式 Android系统架构 Android 系统架构如下两图所示：\n应用框架。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。 Binder IPC。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。 系统服务。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。 硬件抽象层 (HAL)。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅硬件抽象层 (HAL)。 Linux 内核。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 PowerManager 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅构建内核一文。 以上部分内容来源： https://source.android.google.cn/devices/architecture?hl=zh-cn\n搭建开发环境并编译源码 本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。\n选择分支 可参考 source.android.google.cn 的文档 代号、标记和 Build 号 ，可以看到当前最新的版本及标记如下：\nBuild 标记 版本 支持的设备 安全补丁程序级别 RQ2A.210305.007 android-11.0.0_r33 Android11 – – RQ1D.210105.003 android-11.0.0_r28 Android11 Pixel 3、Pixel 3 XL、Pixel 4a (5G)、Pixel 5 2021-01-05 RQ1A.210105.003 android-11.0.0_r27 Android11 Pixel 3、Pixel 3 XL、Pixel 4、Pixel 4a (5G)、Pixel 4 XL、Pixel 5 2021-01-05 RQ1A.210105.002 android-11.0.0_r26 Android11 Pixel 3a、Pixel 3a XL、Pixel 4a 2021-01-05 参考代码仓库中的最新Tag，我们选择 android-11.0.0_r33\n搭建Android构建环境 构建环境的搭建可参考官方的 搭建构建环境 文档，以下结合实际搭建过程中遇到的问题简要进行介绍。\n构建环境要求 首先需要机器满足一些要求，一般来说，需要：\n操作系统： Linux 或者 macOS 内存： 16GB的可用RAM/交换空间 硬盘： 检出代码至少250GB可用磁盘空间，如果需要构建，则还需要150GB 从Android8.0 开始，可以使用源码中带的Dockerfile来构建一个镜像用于编译aosp源码；下面我们将分别介绍如何构建编译用的Docker镜像及直接在macOS11.2上搭建构建环境，构建时根据情况任选一种即可。\n提示：\n最新的构建要求可以参考官方文档 aosp源码构建要求\n搭建构建环境-Docker docker镜像基于ubuntu:18.04，所以ubuntu上也可以按照dockerfile中的命令配置环境\n这里假设安装了Docker，如果没有安装，可以参考Docker官方安装文档进行安装。\nmkdir docker cd docker 将如下内容保存为Dockerfile，并存储到之前建立的docker目录\nFROM ubuntu:18.04 ARG userid ARG groupid ARG username RUN apt-get update \\ \u0026\u0026 apt-get install -y git-core gnupg flex bison build-essential zip \\ curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \\ x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \\ python3 \\ \u0026\u0026 rm -rf /var/lib/apt/lists/* # 最新的AOSP源码中已经带了JDK，所以无需安装 # RUN curl -o jdk8.tgz https://android.googlesource.com/platform/prebuilts/jdk/jdk8/+archive/master.tar.gz \\ # \u0026\u0026 tar -zxf jdk8.tgz linux-x86 \\ # \u0026\u0026 mv linux-x86 /usr/lib/jvm/java-8-openjdk-amd64 \\ # \u0026\u0026 rm -rf jdk8.tgz RUN curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo \\ \u0026\u0026 chmod a+x /usr/local/bin/repo \\ \u0026\u0026 ln -s /usr/bin/python3 /usr/bin/python RUN groupadd -f -g $groupid $username || true \\ \u0026\u0026 useradd -m -u $userid -g $groupid $username \\ \u0026\u0026 echo $username \u003e/root/username \\ \u0026\u0026 echo \"export USER=\"$username \u003e\u003e/home/$username/.gitconfig COPY gitconfig /home/$username/.gitconfig RUN chown $userid:$groupid /home/$username/.gitconfig ENV HOME=/home/$username ENV USER=$username ENTRYPOINT chroot --userspec=$(cat /root/username):$(cat /root/username) / /bin/bash -i 以上dockerfile基于源码中 build/make/tools/docker/Dockerfile 修改\n构建镜像：\n# Copy your host gitconfig, or create a stripped down version $ cp ~/.gitconfig gitconfig $ docker build --build-arg userid=$(id -u) --build-arg groupid=$(id -g) --build-arg username=$(id -un) -t android-build-bionic . 使用镜像：\n可以直接使用我已经构建好的镜像： hanlyjiang/android-build-bionic，可以使用如下命令拉取并修改tag：\ndocker pull hanlyjiang/android-build-bionic\ndocker tag hanlyjiang/android-build-bionic android-build-bionic:latest\n假设aosp的源码目录位于 ～/aosp\n# 设置变量指向源码顶层目录 ANDROID_BUILD_TOP=~/aosp # 如自行构建镜像，此处 BUILD_IMAGE=android-build-bionic cd $ANDROID_BUILD_TOP # 运行容器，并将aosp源码目录挂载到容器内部的/src目录 docker run -it --rm --name aosp-builder -v $PWD:/src $BUILD_IMAGE 启动成功后就会进入容器的shell中，之后在容器中进行执行对应的编译命令即可。\ndocker使用提示：\n上面的docker run 命令中添加了 --rm 选项，在启动的交互式bash结束后就会自动移除容器。之后需要再次输入docker run命令启动容器；为了避免每次都输入如上命令启动容器，可以移除--rm 选项 我们执行构建一般需要较长时间，期间如果我们退出容器的bash，则构建任务会终止，这显然不是我们想要的，我们可以通过 ctrl+P ctrl+Q 命令告诉docker我们需要关闭容器到本机的输入输出重定向，但是并不暂停任何执行的任务。之后再使用 docker attach aosp-builder（aosp-builder是我们启动时指定的容器名称） 即可重新将容器输入输出重定向到本机终端，继续与容器内的shell交互。 搭建构建环境-macOS11.2 这里介绍下macOS（x86）编译的环境配置\n准备源码目录\n由于macOS默认的分区是不区分大小写的，但是aosp编译需要区分大小写，所以需要创建一个区分大小写的分区，这里可以有两种选择：\n1）使用另外一个磁盘（如外置的移动硬盘），然后使用磁盘工具将其抹掉为区分大小写的分区；\n2）创建一个区分大小写的磁盘映像，可通过如下命令执行\nhdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 250g ~/android.dmg.sparseimage # 定义装载卸载函数 mountAndroid() { hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android; } umountAndroid() { hdiutil detach /Volumes/android; } # 装载刚刚创建的磁盘映像到 /Volumes/android 目录，之后cd 到此目录执行即可 mountAndroid 安装 xcode 命令行工具\nxcode-select --install 设置bash\n# 可加入到～/.bash_profile 文件中 ulimit -S -n 2048 下载 10.15 SDK\n从此处下载： https://github.com/phracker/MacOSX-SDKs/releases\n下载完成后放入到此目录：/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/\n修复代码（在下载完成源码之后执行）\n编辑文件 system/core/base/cmsg.cpp\n添加一行：size_t psize = getpagesize();\nnamespace base { size_t psize = getpagesize(); ssize_t SendFileDescriptorVector(borrowed_fd sockfd, const void* data, size_t len, 将文件中所有 PAGE_SIZE 替换为 psize\n参考：\nBuilding Android 11 for PH-1 on Apple Silicon Could not find a supported mac sdk: “10.10” “10.11” “10.12” “10.13” 创建区分大小写的磁盘映像-source.android.google.cn 下载源码 安装Repo 提示： 先前构建的docker镜像中已经安装了repo，如使用镜像，可跳过此步骤\nmkdir ~/.bin PATH=~/.bin:$PATH # 这里可能需要开启代理 curl https://storage.googleapis.com/git-repo-downloads/repo \u003e ~/bin/repo chmod a+x ~/bin/repo # 验证是否安装成功 repo help 输出如下则表示安装成功：\nusage: repo COMMAND [ARGS] repo is not yet installed. Use \"repo init\" to install it here. The most commonly used repo commands are: init Install repo in the current working directory help Display detailed help on a command For access to the full online help, install repo (\"repo init\"). 获取aosp源码底包 wget https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar # 解压 tar xf aosp-latest.tar 或者直接下载：\nmkdir aosp ; cd aosp repo init -u https://android.googlesource.com/platform/manifest -b android-11.0.0_r33 然后执行代码同步命令：\nrepo sync -c -j16 repo sync 命令说明：\n通过 -c 指定只获取当前分支 通过 -j16 指定并行获取的线程数量，这里我电脑为8核，所以指定了16个线程 提示：\n代码下载完成后，我们复制一份到另外一个目录只用于浏览代码 rsync -a -H --progress aosp aosp-ro\n编译源码 首先， 我们使用 repo 启动一个工作分支\nrepo start dev_android11_r33 --all 初始化环境：\nsource build/envsetup.sh envsetup.sh 脚本会导入若干命令，可使用 hmm 查看完整的可用命令列表。\n选择目标：\nlunch aosp_x86_64-eng 输出如下：\n$ lunch aosp_x86_64-eng ============================================ PLATFORM_VERSION_CODENAME=REL PLATFORM_VERSION=11 TARGET_PRODUCT=aosp_x86_64 TARGET_BUILD_VARIANT=eng TARGET_BUILD_TYPE=release TARGET_ARCH=x86_64 TARGET_ARCH_VARIANT=x86_64 TARGET_2ND_ARCH=x86 TARGET_2ND_ARCH_VARIANT=x86_64 HOST_ARCH=x86_64 HOST_OS=darwin HOST_OS_EXTRA=Darwin-20.3.0-x86_64-11.2.3 HOST_BUILD_TYPE=release BUILD_ID=RQ2A.210305.007 OUT_DIR=out PRODUCT_SOONG_NAMESPACES=device/generic/goldfish device/generic/goldfish-opengl hardware/google/camera hardware/google/camera/devices/EmulatedCamera device/generic/goldfish device/generic/goldfish-opengl 构建：\nmake -j16 提示：构建命令可参考 官方文档-编译 Android\n构建成功后输出如下：\n[100% 119047/119047] Create system-qemu.img now removing out/target/product/generic_x86_64/system-qemu.img.qcow2 out/host/darwin-x86/bin/sgdisk --clear out/target/product/generic_x86_64/system-qemu.img #### build completed successfully (14:34:15 (hh:mm:ss)) #### 我们这里使用模拟器进行运行\nemulator 运行起来之后，查看其中的系统版本号如下：\n使用AndroidStudio调试 system_process 本小节介绍如何使用AS来调试Android Java Framework的核心进程 system_process。\n下载安装AndroidStudio 从AndroidStudio官方页面下载安装运行即可\n生成AS项目配置 总的流程如下：\n全量编译一次aosp源码 编译development/tools/idegen 生成 idegen.jar 文件； 使用development/tools/idegen/idegen.sh 生成AS项目配置 使用AndroidStudio打开生成的配置，导入源码项目 其中 idegen.sh 仅是简单的使用java执行idegen.jar，idegen.jar 会在源码根目录生成androidstudio使用的两个文件，即android.iml和android.ipr，生成过程中会读取 excluded-paths 文件，该文件中可以使用正则表达式定义过滤规则，该文件会从三个路径去读取：\ndevelopment/tools/idegen/excluded-paths vendor/google/excluded-paths 源码根目录的 excluded-paths 所以我们只需要将自己的过滤规则定义到源码根目录的 excluded-paths文件中即可。\nandroid.iml 中有三种xml配置:\n1）sourceFolder;\nexcludeFolder;\norderEntry;\nidegen.jar 在执行时会根据配置的规则自动写入这三种规则，其中sourceFolder用于指定源码目录-即as会将其作为源码导入，excludeFolder用于指定排除目录-即as压根不会去搜索任何文件，也不会对其中的文件建立索引，orderEntry 则一般用于指定依赖的jar文件；\n在idegen.jar的逻辑中：\n没有被过滤规则匹配到的目录都会尝试去其中搜寻java及jar文件，只有在其中找到了源码文件，才会被加入到sourceFolder中。 过滤规则中配置的目录，只有其中有java及jar文件时，才会被加入到excludeFolder配置中。 如果目录中找到了java文件，会去读取java文件，自动确认sourceFolder的开始路径，以保证路径能正确匹配包名，如：有个目录de vice/test/src/java/android/Test.java，其中Test.java的包为android，那么sourceFolder的路径会自动设置为de vice/test/src/java/。 修改idegen代码并编译idegen.jar 修改 development/tools/idegen 模块代码及配置\nsrc/Log.java 为了方便我们查看生成的过程，打开debug日志开关\nclass Log { static final boolean DEBUG = true; // ... } src/IntelliJ.java , 这里由于代码中书写错误，prebuilt 实际上在源码中并不存在，我们手动将其修改为 prebuilts\nsourceRootsXml.append(\"\\n\"); // 修改这一行 prebuilt --\u003e prebuilts sourceRootsXml.append(\"\\n\"); 编译生成 idegen.jar\n# 在源码根目录执行 source build/envsetup.sh cd development/tools/idegen mm -j16 成功生成后输出如下：\n[100% 228/228] Install: out/host/darwin-x86/framework/idegen.jar #### build completed successfully (05:30 (mm:ss)) #### 手动获取java文件 手动获取AIDL生成的java文件 我们通过如下命令将aidl生成的java文件拷贝到 源码根目录的idea/aidl/src目录下\ncroot mkdir -p idea/aidl/src find out/soong/.intermediates/frameworks/base/api-stubs-docs-non-updatable/android_common/gen/aidl -name \"*.srcjar\" | xargs -I {} unzip {} -d idea/aidl/src 获取生成的资源 cp -R out/soong/.intermediates/frameworks/base/core/res/framework-res/android_common/gen/aapt2/R idea/framework-res_R 编辑排除规则并生成配置 在项目根目录中添加一个 excluded-paths 文件，输入如下内容（一行作为一个匹配规则，规则的格式按Java中Pattern类的规则编写）\n# 几个根目录的规则 ^art/.* ^packages/.* ^bootable/.* ^build/.* ^cts/.* ^dalvik/.* ^developers/.* ^external/.* ^platform_testing/.* ^pdk/.* ^sdk/.* ^system/.* ^test/.* # platform-compat中有注解的类 ^tools/(?!(platform-compat)) ^development/.* ^device/.* ^prebuilts/* # 这里我们查看这两个模块，所以注释掉 #^libcore/.* #^frameworks/.* # 关于out其他的一些规则 ^out/soong/.intermediates/(?!((frameworks)|(libcore))) # ./out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_x86_64_shared/gen/aidl/android/os/BnServiceManager.h # ^out/soong/.intermediates/.* ^out/target/.* # 根据实际运行情况补充的规则 # 移除可能的jar # 如 ./frameworks/base/tools/aapt2/integration-tests/CommandTests/android-28.jar ^frameworks/base/tools/aapt2/.*\\.jar ^frameworks/base/tests ^libcore/support/src/test ^libcore/luni/src/test gradle-wrapper.jar # 对于sdk源码的隐藏，我们exclude掉，以使可以找到真正的源码 ^libcore/ojluni/annotations 生成iml文件，执行下面命令生成\ndevelopment/tools/idegen/idegen.sh 完成后根目录下即生成了android.iml,android.ipr\n导入到AndroidStudio androidstudio 配置 配置jvm选项，根据机器实际情况设置vm分配的内存策略\n-Xmx16g -Xms2g 配置 idea 属性\n# 大小写敏感（macOS） idea.case.sensitive.fs=true idea.max.intellisense.filesize=100000 导入项目到AS并配置 配置sdk主要是为了避免查看或调试代码时，AS仍然去使用SDK中配置的class，而不是我们的aosp中的java源码。\n使用AndroidStudio 打开项目根目录下 android.ipr 文件即可导入项目；\n配置项目SDK，进入项目设置，添加一个新的JDK，并删除所有依赖jar库，我们这里取名为：1.8 (No Libraries)\n配置项目SDK，进入项目设置，添加一个新的SDK，并删除所有jar库，对应的JDK选择之前创建的1.8 (No Libraries)，这里我们将SDK命名为 Android API 30 Platform-NoLib\n在Project设置中，选择项目SDK为之前设置的 Android API 30 Platform-NoLib\n进入项目设置-模块设置，将模块的SDK设置为之前设置的 Android API 30 Platform-NoLib\n附加调试器到 system_process 附加调试器到 system_process 进程 成功后的Debugger界面如下所示\n打断点测试，这里我们选择在 Binder.java 文件中添加断点，然后在模拟器中打开相机APP以触发断点逻辑。下图就表示我们到达了断点，说明我们可以通过AS来调试该进程了。\n提示：附加调试器时，如找不到设备，可参考第5小节中的 错误解决：Debug中不显示设备\n修改并更新系统模块 在调试分析过程中，可能我们需要修改一下其中内容以协助分析，可以按如下方式进行。\nFramework 构建 framework 分两块：\nJAR 部分使用命令 mmm frameworks/base/ 资源部分： mmm frameworks/base/core/res/ 安装：\n# 获取root权限 adb root adb disable-verity adb reboot adb remount # 移除旧的framework adb shell cd /system/framework/ rm framework-res.apk exit # 推入新的framework adb push out/target/product//system/framework/framework-res.apk /system/framework/ # 重启服务 adb reboot packages中app 构建 cd ~/aosp source build/envsetup.sh lunch aosp_x86_64-eng # 重新构建单个模块 (如 Dialer) mmm packages/apps/dialer/ # 生成的文件会在控制台中输出来 更新到系统 adb install -r out/target/product//system/priv-app//.apk adb reboot SystemUI 编译 cd WORKING_DIRECTORY source build/envsetup.sh # 选择设备 lunch 31 # 重新构建SystemUI mmm frameworks/base/packages/SystemUI/ 安装到系统 adb install -r out/target/product//system/priv-app/SystemUI/SystemUI.apk adb reboot 使用提示及常见错误 使用提示：项目源码浏览配置 筛选Project代码范围 点击project窗口的设置按钮，选择 “Edit Scopes”\n新建一个规则，输入名称，并在Pattern中输入过滤规则： file[android]:frameworks//*||file[android]:libcore//*\n过滤VCS配置中不必要的模块 打开VCS配置，移除frameworks和libcore之外的所有其他模块\n使用提示：导入其他模块的源码到AS 不建议直接修改 android.iml 文件，应当通过修改源码根目录自定义的 excluded-paths 文件中定义的规则来包含其他模块的源码。\n修改此文件后，重新执行 development/tools/idegen/idegen.sh 来生成最新的as项目配置。生成完成后一般as如果是打开状态，会自动更新索引，如果索引更新有问题，可关闭项目，然后重新打开。\n错误解决：macOS .DS_Store 导致打包镜像失败 编译基本完成，但是最后打包system.img文件时报错，报错内容如下：\nset_selinux_xattr: No such file or directory searching for label \"/.DS_Store\" e2fsdroid: No such file or directory while configuring the file system 10:00:38 ninja failed with: exit status 1 解决方式：删除源码目录中的所有 .DS_Store，可通过如下命令进行统一清理\nfind . -name \".DS_Store\" | xargs -I {} rm {} 说明： .DS_Store 文件为macOS中存储文件夹界面展示相关的一些信息，在Finder中查看对应目录后可能会生成\n错误解决：附加调试器时不显示设备 在附加调试器时，可能会如下图一样，模拟器已经启动了，但是附加调试器的窗口中设备列表中没有设备\n此时检查自己的项目配置中的SDK是否选择了AndroidSDK，设置成 Android SDK 即可\n错误解决：模拟器无法启动-报找不到内核版本信息 当使用 android-11.0.0_r28 版本时，编译通过后，使用emulator启动时，报出如下错误\nemulator: ERROR: Can't find 'Linux version ' string in kernel image file: /Volumes/HIKVISION/google-aosp/out/target/product/generic_x86_64/kernel-ranchu 原因是emulator版本过旧，需要使用新的emulator，执行如下命令获取新的版本：\ncd prebuilts/android-emulator # 查询可用分支，https://android.googlesource.com/platform/prebuilts/android-emulator/+refs git fetch aosp android-11.0.0_r33:refs/remotes/m/android-11.0.0_r33 # 检出分支 git co -b android-11.0.0_r33 refs/remotes/m/ android-11.0.0_r33 获取完成后再次执行 emulator 命令\nemulator -version # Android emulator version 30.3.0.0 (build_id 6946397) (CL:N/A) emulator # 启动模拟器 参考文章 参考：\n使用 Android Studio 阅读 AOSP 源码 AOSP Source Code in Android Studio (Explore only) Stackoverflow aosp-and-intellij-idea Building Android O with a Mac - Christopher Ney Building Android 11 for PH-1 on Apple Silicon Could not find a supported mac sdk: “10.10” “10.11” “10.12” “10.13” 创建区分大小写的磁盘映像-source.android.google.cn ","wordCount":"1134","inLanguage":"en","datePublished":"2021-04-08T10:18:50Z","dateModified":"2021-04-08T10:18:50Z","author":{"@type":"Person","name":"野生莲藕"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/"},"publisher":{"@type":"Organization","name":"清水池塘","logo":{"@type":"ImageObject","url":"https://hanlyjiang.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hanlyjiang.github.io/ accesskey=h title="清水池塘 (Alt + H)">清水池塘</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">搭建Android源码工作环境</h1><div class=post-meta><span title='2021-04-08 10:18:50 +0000 UTC'>April 8, 2021</span>&nbsp;·&nbsp;<span>6 min</span>&nbsp;·&nbsp;<span>1134 words</span>&nbsp;·&nbsp;<span>野生莲藕</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#android%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84 aria-label=Android系统架构>Android系统架构</a></li><li><a href=#%e6%90%ad%e5%bb%ba%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e5%b9%b6%e7%bc%96%e8%af%91%e6%ba%90%e7%a0%81 aria-label=搭建开发环境并编译源码>搭建开发环境并编译源码</a><ul><li><a href=#%e9%80%89%e6%8b%a9%e5%88%86%e6%94%af aria-label=选择分支>选择分支</a></li><li><a href=#%e6%90%ad%e5%bb%baandroid%e6%9e%84%e5%bb%ba%e7%8e%af%e5%a2%83 aria-label=搭建Android构建环境>搭建Android构建环境</a><ul><li><a href=#%e6%9e%84%e5%bb%ba%e7%8e%af%e5%a2%83%e8%a6%81%e6%b1%82 aria-label=构建环境要求>构建环境要求</a></li><li><a href=#%e6%90%ad%e5%bb%ba%e6%9e%84%e5%bb%ba%e7%8e%af%e5%a2%83-docker aria-label=搭建构建环境-Docker>搭建构建环境-Docker</a></li><li><a href=#%e6%90%ad%e5%bb%ba%e6%9e%84%e5%bb%ba%e7%8e%af%e5%a2%83-macos112 aria-label=搭建构建环境-macOS11.2>搭建构建环境-macOS11.2</a></li></ul></li><li><a href=#%e4%b8%8b%e8%bd%bd%e6%ba%90%e7%a0%81 aria-label=下载源码>下载源码</a><ul><li><a href=#%e5%ae%89%e8%a3%85repo aria-label=安装Repo>安装Repo</a></li><li><a href=#%e8%8e%b7%e5%8f%96aosp%e6%ba%90%e7%a0%81%e5%ba%95%e5%8c%85 aria-label=获取aosp源码底包>获取aosp源码底包</a></li></ul></li><li><a href=#%e7%bc%96%e8%af%91%e6%ba%90%e7%a0%81 aria-label=编译源码>编译源码</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8androidstudio%e8%b0%83%e8%af%95-system_process aria-label="使用AndroidStudio调试 system_process">使用AndroidStudio调试 system_process</a><ul><li><a href=#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85androidstudio aria-label=下载安装AndroidStudio>下载安装AndroidStudio</a></li><li><a href=#%e7%94%9f%e6%88%90as%e9%a1%b9%e7%9b%ae%e9%85%8d%e7%bd%ae aria-label=生成AS项目配置>生成AS项目配置</a><ul><li><a href=#%e4%bf%ae%e6%94%b9idegen%e4%bb%a3%e7%a0%81%e5%b9%b6%e7%bc%96%e8%af%91idegenjar aria-label=修改idegen代码并编译idegen.jar>修改idegen代码并编译idegen.jar</a></li><li><a href=#%e6%89%8b%e5%8a%a8%e8%8e%b7%e5%8f%96java%e6%96%87%e4%bb%b6 aria-label=手动获取java文件>手动获取java文件</a><ul><li><a href=#%e6%89%8b%e5%8a%a8%e8%8e%b7%e5%8f%96aidl%e7%94%9f%e6%88%90%e7%9a%84java%e6%96%87%e4%bb%b6 aria-label=手动获取AIDL生成的java文件>手动获取AIDL生成的java文件</a></li><li><a href=#%e8%8e%b7%e5%8f%96%e7%94%9f%e6%88%90%e7%9a%84%e8%b5%84%e6%ba%90 aria-label=获取生成的资源>获取生成的资源</a></li></ul></li><li><a href=#%e7%bc%96%e8%be%91%e6%8e%92%e9%99%a4%e8%a7%84%e5%88%99%e5%b9%b6%e7%94%9f%e6%88%90%e9%85%8d%e7%bd%ae aria-label=编辑排除规则并生成配置>编辑排除规则并生成配置</a></li></ul></li><li><a href=#%e5%af%bc%e5%85%a5%e5%88%b0androidstudio aria-label=导入到AndroidStudio>导入到AndroidStudio</a><ul><li><a href=#androidstudio-%e9%85%8d%e7%bd%ae aria-label="androidstudio 配置">androidstudio 配置</a></li><li><a href=#%e5%af%bc%e5%85%a5%e9%a1%b9%e7%9b%ae%e5%88%b0as%e5%b9%b6%e9%85%8d%e7%bd%ae aria-label=导入项目到AS并配置>导入项目到AS并配置</a></li><li><a href=#%e9%99%84%e5%8a%a0%e8%b0%83%e8%af%95%e5%99%a8%e5%88%b0-system_process aria-label="附加调试器到 system_process">附加调试器到 system_process</a></li></ul></li></ul></li><li><a href=#%e4%bf%ae%e6%94%b9%e5%b9%b6%e6%9b%b4%e6%96%b0%e7%b3%bb%e7%bb%9f%e6%a8%a1%e5%9d%97 aria-label=修改并更新系统模块>修改并更新系统模块</a><ul><li><a href=#framework aria-label=Framework>Framework</a></li><li><a href=#packages%e4%b8%adapp aria-label=packages中app>packages中app</a></li><li><a href=#systemui aria-label=SystemUI>SystemUI</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%8f%90%e7%a4%ba%e5%8f%8a%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af aria-label=使用提示及常见错误>使用提示及常见错误</a><ul><li><a href=#%e4%bd%bf%e7%94%a8%e6%8f%90%e7%a4%ba%e9%a1%b9%e7%9b%ae%e6%ba%90%e7%a0%81%e6%b5%8f%e8%a7%88%e9%85%8d%e7%bd%ae aria-label=使用提示：项目源码浏览配置>使用提示：项目源码浏览配置</a><ul><li><a href=#%e7%ad%9b%e9%80%89project%e4%bb%a3%e7%a0%81%e8%8c%83%e5%9b%b4 aria-label=筛选Project代码范围>筛选Project代码范围</a></li><li><a href=#%e8%bf%87%e6%bb%a4vcs%e9%85%8d%e7%bd%ae%e4%b8%ad%e4%b8%8d%e5%bf%85%e8%a6%81%e7%9a%84%e6%a8%a1%e5%9d%97 aria-label=过滤VCS配置中不必要的模块>过滤VCS配置中不必要的模块</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%8f%90%e7%a4%ba%e5%af%bc%e5%85%a5%e5%85%b6%e4%bb%96%e6%a8%a1%e5%9d%97%e7%9a%84%e6%ba%90%e7%a0%81%e5%88%b0as aria-label=使用提示：导入其他模块的源码到AS>使用提示：导入其他模块的源码到AS</a></li><li><a href=#%e9%94%99%e8%af%af%e8%a7%a3%e5%86%b3macos-ds_store-%e5%af%bc%e8%87%b4%e6%89%93%e5%8c%85%e9%95%9c%e5%83%8f%e5%a4%b1%e8%b4%a5 aria-label="错误解决：macOS .DS_Store 导致打包镜像失败">错误解决：macOS .DS_Store 导致打包镜像失败</a></li><li><a href=#%e9%94%99%e8%af%af%e8%a7%a3%e5%86%b3%e9%99%84%e5%8a%a0%e8%b0%83%e8%af%95%e5%99%a8%e6%97%b6%e4%b8%8d%e6%98%be%e7%a4%ba%e8%ae%be%e5%a4%87 aria-label=错误解决：附加调试器时不显示设备>错误解决：附加调试器时不显示设备</a></li><li><a href=#%e9%94%99%e8%af%af%e8%a7%a3%e5%86%b3%e6%a8%a1%e6%8b%9f%e5%99%a8%e6%97%a0%e6%b3%95%e5%90%af%e5%8a%a8-%e6%8a%a5%e6%89%be%e4%b8%8d%e5%88%b0%e5%86%85%e6%a0%b8%e7%89%88%e6%9c%ac%e4%bf%a1%e6%81%af aria-label=错误解决：模拟器无法启动-报找不到内核版本信息>错误解决：模拟器无法启动-报找不到内核版本信息</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0 aria-label=参考文章>参考文章</a></li></ul></div></details></div><div class=post-content><ul><li>简单介绍系统架构、编译环境的搭建</li><li>简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式</li></ul><h2 id=android系统架构>Android系统架构<a hidden class=anchor aria-hidden=true href=#android系统架构>#</a></h2><p>Android 系统架构如下两图所示：</p><p><img alt=20210401092831 loading=lazy src=https://s2.loli.net/2022/05/26/iVWSvDPlA9I4afd.png></p><p><img alt=20210401092925 loading=lazy src=https://s2.loli.net/2022/05/26/3KYlCuj5zXc9EUs.png></p><ul><li><strong>应用框架</strong>。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。</li><li><strong>Binder IPC</strong>。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。</li><li><strong>系统服务</strong>。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。</li><li><strong>硬件抽象层 (HAL)</strong>。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅<a href="https://source.android.google.cn/devices/architecture/hal?hl=zh-cn">硬件抽象层 (HAL)</a>。</li><li><strong>Linux 内核</strong>。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 <a href="https://developer.android.google.cn/reference/android/os/PowerManager.html?hl=zh-cn"><code>PowerManager</code></a> 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅<a href="https://source.android.google.cn/setup/building-kernels?hl=zh-cn">构建内核</a>一文。</li></ul><blockquote><p>以上部分内容来源： <a href="https://source.android.google.cn/devices/architecture?hl=zh-cn">https://source.android.google.cn/devices/architecture?hl=zh-cn</a></p></blockquote><h2 id=搭建开发环境并编译源码>搭建开发环境并编译源码<a hidden class=anchor aria-hidden=true href=#搭建开发环境并编译源码>#</a></h2><p>本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。</p><h3 id=选择分支>选择分支<a hidden class=anchor aria-hidden=true href=#选择分支>#</a></h3><p>可参考 source.android.google.cn 的文档 <a href=https://source.android.google.cn/setup/start/build-numbers>代号、标记和 Build 号</a> ，可以看到当前最新的版本及标记如下：</p><table><thead><tr><th style=text-align:left>Build</th><th style=text-align:left>标记</th><th style=text-align:left>版本</th><th style=text-align:left>支持的设备</th><th style=text-align:left>安全补丁程序级别</th></tr></thead><tbody><tr><td style=text-align:left>RQ2A.210305.007</td><td style=text-align:left>android-11.0.0_r33</td><td style=text-align:left>Android11</td><td style=text-align:left>&ndash;</td><td style=text-align:left>&ndash;</td></tr><tr><td style=text-align:left>RQ1D.210105.003</td><td style=text-align:left>android-11.0.0_r28</td><td style=text-align:left>Android11</td><td style=text-align:left>Pixel 3、Pixel 3 XL、Pixel 4a (5G)、Pixel 5</td><td style=text-align:left>2021-01-05</td></tr><tr><td style=text-align:left>RQ1A.210105.003</td><td style=text-align:left>android-11.0.0_r27</td><td style=text-align:left>Android11</td><td style=text-align:left>Pixel 3、Pixel 3 XL、Pixel 4、Pixel 4a (5G)、Pixel 4 XL、Pixel 5</td><td style=text-align:left>2021-01-05</td></tr><tr><td style=text-align:left>RQ1A.210105.002</td><td style=text-align:left>android-11.0.0_r26</td><td style=text-align:left>Android11</td><td style=text-align:left>Pixel 3a、Pixel 3a XL、Pixel 4a</td><td style=text-align:left>2021-01-05</td></tr></tbody></table><p>参考代码仓库中的<a href=https://android.googlesource.com/platform/bionic/+/refs/tags/android-11.0.0_r33>最新Tag</a>，我们选择 <code>android-11.0.0_r33</code></p><h3 id=搭建android构建环境>搭建Android构建环境<a hidden class=anchor aria-hidden=true href=#搭建android构建环境>#</a></h3><p>构建环境的搭建可参考官方的 <a href=https://source.android.google.cn/setup/build/initializing>搭建构建环境</a> 文档，以下结合实际搭建过程中遇到的问题简要进行介绍。</p><h4 id=构建环境要求>构建环境要求<a hidden class=anchor aria-hidden=true href=#构建环境要求>#</a></h4><p>首先需要机器满足一些<a href=https://source.android.google.cn/setup/build/requirements>要求</a>，一般来说，需要：</p><ul><li>操作系统： Linux 或者 macOS</li><li>内存： 16GB的可用RAM/交换空间</li><li>硬盘： 检出代码至少250GB可用磁盘空间，如果需要构建，则还需要150GB</li></ul><p>从Android8.0 开始，可以使用源码中带的Dockerfile来构建一个镜像用于编译aosp源码；下面我们将分别介绍如何构建编译用的Docker镜像及直接在macOS11.2上搭建构建环境，构建时根据情况任选一种即可。</p><blockquote><p>提示：</p><p>最新的构建要求可以参考官方文档 <a href=https://source.android.google.cn/setup/build/requirements>aosp源码构建要求</a></p></blockquote><h4 id=搭建构建环境-docker>搭建构建环境-Docker<a hidden class=anchor aria-hidden=true href=#搭建构建环境-docker>#</a></h4><blockquote><p>docker镜像基于ubuntu:18.04，所以ubuntu上也可以按照dockerfile中的命令配置环境</p></blockquote><p>这里假设安装了Docker，如果没有安装，可以参考<a href=https://docs.docker.com/engine/install/>Docker官方安装文档</a>进行安装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir docker
</span></span><span style=display:flex><span>cd docker
</span></span></code></pre></div><p>将如下内容保存为Dockerfile，并存储到之前建立的docker目录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>ubuntu:18.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> userid<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> groupid<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ARG</span> username<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -y git-core gnupg flex bison build-essential zip <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    python3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># 最新的AOSP源码中已经带了JDK，所以无需安装</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># RUN curl -o jdk8.tgz https://android.googlesource.com/platform/prebuilts/jdk/jdk8/+archive/master.tar.gz \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#  &amp;&amp; tar -zxf jdk8.tgz linux-x86 \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#  &amp;&amp; mv linux-x86 /usr/lib/jvm/java-8-openjdk-amd64 \</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>#  &amp;&amp; rm -rf jdk8.tgz</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> chmod a+x /usr/local/bin/repo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> ln -s /usr/bin/python3 /usr/bin/python<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> groupadd -f -g $groupid $username <span style=color:#f92672>||</span> true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> useradd -m -u $userid -g $groupid $username <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> echo $username &gt;/root/username <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;export USER=&#34;</span>$username &gt;&gt;/home/$username/.gitconfig<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> gitconfig /home/$username/.gitconfig<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chown $userid:$groupid /home/$username/.gitconfig<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> HOME<span style=color:#f92672>=</span>/home/$username<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> USER<span style=color:#f92672>=</span>$username<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> chroot --userspec<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /root/username<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>cat /root/username<span style=color:#66d9ef>)</span> / /bin/bash -i<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><blockquote><p>以上dockerfile基于源码中 <code>build/make/tools/docker/Dockerfile</code> 修改</p></blockquote><p><strong>构建镜像：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Copy your host gitconfig, or create a stripped down version</span>
</span></span><span style=display:flex><span>$ cp ~/.gitconfig gitconfig
</span></span><span style=display:flex><span>$ docker build --build-arg userid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span> --build-arg groupid<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> --build-arg username<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>id -un<span style=color:#66d9ef>)</span> -t android-build-bionic .
</span></span></code></pre></div><p><strong>使用镜像：</strong></p><blockquote><p>可以直接使用我已经构建好的镜像： <code>hanlyjiang/android-build-bionic</code>，可以使用如下命令拉取并修改tag：</p><p><code>docker pull hanlyjiang/android-build-bionic</code></p><p><code>docker tag hanlyjiang/android-build-bionic android-build-bionic:latest</code></p></blockquote><p>假设aosp的源码目录位于 ～/aosp</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 设置变量指向源码顶层目录</span>
</span></span><span style=display:flex><span>ANDROID_BUILD_TOP<span style=color:#f92672>=</span>~/aosp
</span></span><span style=display:flex><span><span style=color:#75715e># 如自行构建镜像，此处</span>
</span></span><span style=display:flex><span>BUILD_IMAGE<span style=color:#f92672>=</span>android-build-bionic
</span></span><span style=display:flex><span>cd $ANDROID_BUILD_TOP
</span></span><span style=display:flex><span><span style=color:#75715e># 运行容器，并将aosp源码目录挂载到容器内部的/src目录</span>
</span></span><span style=display:flex><span>docker run -it --rm --name aosp-builder -v $PWD:/src $BUILD_IMAGE
</span></span></code></pre></div><p>启动成功后就会进入容器的shell中，之后在容器中进行执行对应的编译命令即可。</p><blockquote><p><strong>docker使用提示：</strong></p><ol><li>上面的<code>docker run </code>命令中添加了 <code>--rm</code> 选项，在启动的交互式bash结束后就会自动移除容器。之后需要再次输入<code>docker run</code>命令启动容器；为了避免每次都输入如上命令启动容器，可以移除<code>--rm</code> 选项</li><li>我们执行构建一般需要较长时间，期间如果我们退出容器的bash，则构建任务会终止，这显然不是我们想要的，我们可以通过 <code>ctrl+P ctrl+Q</code> 命令告诉docker我们需要关闭容器到本机的输入输出重定向，但是并不暂停任何执行的任务。之后再使用 <code>docker attach aosp-builder</code>（aosp-builder是我们启动时指定的容器名称） 即可重新将容器输入输出重定向到本机终端，继续与容器内的shell交互。</li></ol></blockquote><h4 id=搭建构建环境-macos112>搭建构建环境-macOS11.2<a hidden class=anchor aria-hidden=true href=#搭建构建环境-macos112>#</a></h4><p>这里介绍下macOS（x86）编译的环境配置</p><ol><li><p>准备源码目录</p><p>由于macOS默认的分区是不区分大小写的，但是aosp编译需要区分大小写，所以需要创建一个区分大小写的分区，这里可以有两种选择：</p><p>1）使用另外一个磁盘（如外置的移动硬盘），然后使用磁盘工具将其抹掉为区分大小写的分区；</p><p>2）创建一个区分大小写的磁盘映像，可通过如下命令执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>hdiutil create -type SPARSE -fs <span style=color:#e6db74>&#39;Case-sensitive Journaled HFS+&#39;</span> -size 250g ~/android.dmg.sparseimage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定义装载卸载函数</span>
</span></span><span style=display:flex><span>mountAndroid<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android; <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>umountAndroid<span style=color:#f92672>()</span> <span style=color:#f92672>{</span> hdiutil detach /Volumes/android; <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 装载刚刚创建的磁盘映像到 /Volumes/android 目录，之后cd 到此目录执行即可</span>
</span></span><span style=display:flex><span>mountAndroid
</span></span></code></pre></div></li><li><p>安装 xcode 命令行工具</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>xcode-select --install
</span></span></code></pre></div></li><li><p>设置bash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 可加入到～/.bash_profile 文件中</span>
</span></span><span style=display:flex><span>ulimit -S -n <span style=color:#ae81ff>2048</span>
</span></span></code></pre></div></li><li><p>下载 10.15 SDK</p><p>从此处下载： <a href=https://github.com/phracker/MacOSX-SDKs/releases>https://github.com/phracker/MacOSX-SDKs/releases</a></p><p>下载完成后放入到此目录：<code>/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/</code></p></li><li><p>修复代码（在下载完成源码之后执行）</p><ul><li><p>编辑文件 <code>system/core/base/cmsg.cpp</code></p></li><li><p>添加一行：<code>size_t psize = getpagesize();</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>namespace</span> base {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>size_t psize <span style=color:#f92672>=</span> getpagesize();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssize_t SendFileDescriptorVector(borrowed_fd sockfd, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> data, size_t len,
</span></span></code></pre></div></li><li><p>将文件中所有 <strong>PAGE_SIZE</strong> 替换为 <strong>psize</strong></p></li></ul></li></ol><blockquote><p>参考：</p><ul><li><a href=https://nf4789.medium.com/building-android-11-for-ph-1-on-apple-silicon-6600436a36a0>Building Android 11 for PH-1 on Apple Silicon</a></li><li><a href=https://stackoverflow.com/questions/50760701/could-not-find-a-supported-mac-sdk-10-10-10-11-10-12-10-13>Could not find a supported mac sdk: “10.10” “10.11” “10.12” “10.13”</a></li><li><a href="https://source.android.google.cn/setup/build/initializing?hl=zh-cn#creating-a-case-sensitive-disk-image">创建区分大小写的磁盘映像-source.android.google.cn</a></li></ul></blockquote><h3 id=下载源码>下载源码<a hidden class=anchor aria-hidden=true href=#下载源码>#</a></h3><h4 id=安装repo>安装Repo<a hidden class=anchor aria-hidden=true href=#安装repo>#</a></h4><blockquote><p>提示： 先前构建的docker镜像中已经安装了repo，如使用镜像，可跳过此步骤</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir ~/.bin
</span></span><span style=display:flex><span>PATH<span style=color:#f92672>=</span>~/.bin:$PATH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这里可能需要开启代理</span>
</span></span><span style=display:flex><span>curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo
</span></span><span style=display:flex><span>chmod a+x ~/bin/repo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证是否安装成功</span>
</span></span><span style=display:flex><span>repo help
</span></span></code></pre></div><p>输出如下则表示安装成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>usage: repo COMMAND <span style=color:#f92672>[</span>ARGS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>repo is not yet installed.  Use <span style=color:#e6db74>&#34;repo init&#34;</span> to install it here.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>The most commonly used repo commands are:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  init      Install repo in the current working directory
</span></span><span style=display:flex><span>  help      Display detailed help on a command
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For access to the full online help, install repo <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;repo init&#34;</span><span style=color:#f92672>)</span>.
</span></span></code></pre></div><h4 id=获取aosp源码底包>获取aosp源码底包<a hidden class=anchor aria-hidden=true href=#获取aosp源码底包>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wget https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar
</span></span><span style=display:flex><span><span style=color:#75715e># 解压</span>
</span></span><span style=display:flex><span>tar xf aosp-latest.tar
</span></span></code></pre></div><p>或者直接下载：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir aosp ; cd aosp 
</span></span><span style=display:flex><span>repo init -u https://android.googlesource.com/platform/manifest -b android-11.0.0_r33
</span></span></code></pre></div><p>然后执行代码同步命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>repo sync -c -j16
</span></span></code></pre></div><blockquote><p>repo sync 命令说明：</p><ul><li>通过 <code>-c</code> 指定只获取当前分支</li><li>通过 <code>-j16</code> 指定并行获取的线程数量，这里我电脑为8核，所以指定了16个线程</li></ul></blockquote><blockquote><p><strong>提示：</strong></p><p>代码下载完成后，我们复制一份到另外一个目录只用于浏览代码 <code>rsync -a -H --progress aosp aosp-ro</code></p></blockquote><h3 id=编译源码>编译源码<a hidden class=anchor aria-hidden=true href=#编译源码>#</a></h3><p>首先， 我们使用 repo 启动一个工作分支</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>repo start dev_android11_r33 --all
</span></span></code></pre></div><p>初始化环境：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>source build/envsetup.sh
</span></span></code></pre></div><p><code>envsetup.sh</code> 脚本会导入若干命令，可使用 <code>hmm</code> 查看完整的可用命令列表。</p><p>选择目标：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>lunch aosp_x86_64-eng
</span></span></code></pre></div><p>输出如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ lunch aosp_x86_64-eng
</span></span><span style=display:flex><span><span style=color:#f92672>============================================</span>
</span></span><span style=display:flex><span>PLATFORM_VERSION_CODENAME<span style=color:#f92672>=</span>REL
</span></span><span style=display:flex><span>PLATFORM_VERSION<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>TARGET_PRODUCT<span style=color:#f92672>=</span>aosp_x86_64
</span></span><span style=display:flex><span>TARGET_BUILD_VARIANT<span style=color:#f92672>=</span>eng
</span></span><span style=display:flex><span>TARGET_BUILD_TYPE<span style=color:#f92672>=</span>release
</span></span><span style=display:flex><span>TARGET_ARCH<span style=color:#f92672>=</span>x86_64
</span></span><span style=display:flex><span>TARGET_ARCH_VARIANT<span style=color:#f92672>=</span>x86_64
</span></span><span style=display:flex><span>TARGET_2ND_ARCH<span style=color:#f92672>=</span>x86
</span></span><span style=display:flex><span>TARGET_2ND_ARCH_VARIANT<span style=color:#f92672>=</span>x86_64
</span></span><span style=display:flex><span>HOST_ARCH<span style=color:#f92672>=</span>x86_64
</span></span><span style=display:flex><span>HOST_OS<span style=color:#f92672>=</span>darwin
</span></span><span style=display:flex><span>HOST_OS_EXTRA<span style=color:#f92672>=</span>Darwin-20.3.0-x86_64-11.2.3
</span></span><span style=display:flex><span>HOST_BUILD_TYPE<span style=color:#f92672>=</span>release
</span></span><span style=display:flex><span>BUILD_ID<span style=color:#f92672>=</span>RQ2A.210305.007
</span></span><span style=display:flex><span>OUT_DIR<span style=color:#f92672>=</span>out
</span></span><span style=display:flex><span>PRODUCT_SOONG_NAMESPACES<span style=color:#f92672>=</span>device/generic/goldfish device/generic/goldfish-opengl hardware/google/camera hardware/google/camera/devices/EmulatedCamera device/generic/goldfish device/generic/goldfish-opengl
</span></span></code></pre></div><p>构建：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make -j16
</span></span></code></pre></div><blockquote><p>提示：构建命令可参考 <a href=https://source.android.google.cn/setup/build/building>官方文档-编译 Android</a></p></blockquote><p>构建成功后输出如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>100% 119047/119047<span style=color:#f92672>]</span> Create system-qemu.img now
</span></span><span style=display:flex><span>removing out/target/product/generic_x86_64/system-qemu.img.qcow2
</span></span><span style=display:flex><span>out/host/darwin-x86/bin/sgdisk --clear out/target/product/generic_x86_64/system-qemu.img
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#### build completed successfully (14:34:15 (hh:mm:ss)) ####</span>
</span></span></code></pre></div><p>我们这里使用模拟器进行运行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>emulator
</span></span></code></pre></div><p>运行起来之后，查看其中的系统版本号如下：</p><p><img alt=20210403135316 loading=lazy src=https://s2.loli.net/2022/05/26/ts1xnl2L35HBmeY.png></p><h2 id=使用androidstudio调试-system_process>使用AndroidStudio调试 <code>system_process</code><a hidden class=anchor aria-hidden=true href=#使用androidstudio调试-system_process>#</a></h2><p>本小节介绍如何使用AS来调试Android Java Framework的核心进程 system_process。</p><h3 id=下载安装androidstudio>下载安装AndroidStudio<a hidden class=anchor aria-hidden=true href=#下载安装androidstudio>#</a></h3><p>从<a href=https://developer.android.google.cn/studio>AndroidStudio官方页面</a>下载安装运行即可</p><h3 id=生成as项目配置>生成AS项目配置<a hidden class=anchor aria-hidden=true href=#生成as项目配置>#</a></h3><p>总的流程如下：</p><ul><li>全量编译一次aosp源码</li><li>编译<code>development/tools/idegen</code> 生成 <code>idegen.jar</code> 文件；</li><li>使用<code>development/tools/idegen/idegen.sh</code> 生成AS项目配置</li><li>使用AndroidStudio打开生成的配置，导入源码项目</li></ul><p>其中 <code>idegen.sh</code> 仅是简单的使用java执行idegen.jar，idegen.jar 会在源码根目录生成androidstudio使用的两个文件，即<code>android.iml</code>和<code>android.ipr</code>，生成过程中会读取 <code>excluded-paths</code> 文件，该文件中可以使用正则表达式定义过滤规则，该文件会从三个路径去读取：</p><ul><li><code>development/tools/idegen/excluded-paths</code></li><li><code>vendor/google/excluded-paths</code></li><li>源码根目录的 <code>excluded-paths</code></li></ul><p>所以我们只需要将自己的过滤规则定义到源码根目录的 <code>excluded-paths</code>文件中即可。</p><p><code>android.iml</code> 中有三种xml配置:</p><p>1）<code>sourceFolder</code>;</p><ol start=2><li><p><code>excludeFolder</code>;</p></li><li><p><code>orderEntry</code>;</p></li></ol><p>idegen.jar 在执行时会根据配置的规则自动写入这三种规则，其中sourceFolder用于指定源码目录-即as会将其作为源码导入，excludeFolder用于指定排除目录-即as压根不会去搜索任何文件，也不会对其中的文件建立索引，orderEntry 则一般用于指定依赖的jar文件；</p><p>在idegen.jar的逻辑中：</p><ul><li>没有被过滤规则匹配到的目录都会尝试去其中搜寻java及jar文件，只有在其中找到了源码文件，才会被加入到sourceFolder中。</li><li>过滤规则中配置的目录，只有其中有java及jar文件时，才会被加入到excludeFolder配置中。</li><li>如果目录中找到了java文件，会去读取java文件，自动确认sourceFolder的开始路径，以保证路径能正确匹配包名，如：有个目录<code>de vice/test/src/java/android/Test.java</code>，其中Test.java的包为android，那么sourceFolder的路径会自动设置为<code>de vice/test/src/java/</code>。</li></ul><h4 id=修改idegen代码并编译idegenjar>修改idegen代码并编译idegen.jar<a hidden class=anchor aria-hidden=true href=#修改idegen代码并编译idegenjar>#</a></h4><p>修改 <code>development/tools/idegen</code> 模块代码及配置</p><ol><li><p><code>src/Log.java</code> 为了方便我们查看生成的过程，打开debug日志开关</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Log</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> DEBUG <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><code>src/IntelliJ.java</code> , 这里由于代码中书写错误，prebuilt 实际上在源码中并不存在，我们手动将其修改为 <code>prebuilts</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        sourceRootsXml.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;&lt;excludeFolder url=\&#34;file://$MODULE_DIR$/out/target/product\&#34;/&gt;\n&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// 修改这一行 prebuilt --&gt; prebuilts</span>
</span></span><span style=display:flex><span>        sourceRootsXml.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;&lt;excludeFolder url=\&#34;file://$MODULE_DIR$/prebuilts\&#34;/&gt;\n&#34;</span>);
</span></span></code></pre></div></li><li><p>编译生成 idegen.jar</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 在源码根目录执行</span>
</span></span><span style=display:flex><span>source build/envsetup.sh
</span></span><span style=display:flex><span>cd development/tools/idegen
</span></span><span style=display:flex><span>mm -j16
</span></span></code></pre></div><p>成功生成后输出如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#f92672>[</span>100% 228/228<span style=color:#f92672>]</span> Install: out/host/darwin-x86/framework/idegen.jar
</span></span><span style=display:flex><span><span style=color:#75715e>#### build completed successfully (05:30 (mm:ss)) ####</span>
</span></span></code></pre></div></li></ol><h4 id=手动获取java文件>手动获取java文件<a hidden class=anchor aria-hidden=true href=#手动获取java文件>#</a></h4><h5 id=手动获取aidl生成的java文件>手动获取AIDL生成的java文件<a hidden class=anchor aria-hidden=true href=#手动获取aidl生成的java文件>#</a></h5><p>我们通过如下命令将aidl生成的java文件拷贝到 源码根目录的<code>idea/aidl/src</code>目录下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>croot
</span></span><span style=display:flex><span>mkdir -p idea/aidl/src
</span></span><span style=display:flex><span>find out/soong/.intermediates/frameworks/base/api-stubs-docs-non-updatable/android_common/gen/aidl -name <span style=color:#e6db74>&#34;*.srcjar&#34;</span> | xargs -I <span style=color:#f92672>{}</span> unzip <span style=color:#f92672>{}</span> -d idea/aidl/src
</span></span></code></pre></div><h5 id=获取生成的资源>获取生成的资源<a hidden class=anchor aria-hidden=true href=#获取生成的资源>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cp -R out/soong/.intermediates/frameworks/base/core/res/framework-res/android_common/gen/aapt2/R idea/framework-res_R
</span></span></code></pre></div><h4 id=编辑排除规则并生成配置>编辑排除规则并生成配置<a hidden class=anchor aria-hidden=true href=#编辑排除规则并生成配置>#</a></h4><ol><li><p>在项目根目录中添加一个 <code>excluded-paths</code> 文件，输入如下内容（一行作为一个匹配规则，规则的格式按Java中Pattern类的规则编写）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 几个根目录的规则</span>
</span></span><span style=display:flex><span>^art/.*
</span></span><span style=display:flex><span>^packages/.*
</span></span><span style=display:flex><span>^bootable/.*
</span></span><span style=display:flex><span>^build/.*
</span></span><span style=display:flex><span>^cts/.*
</span></span><span style=display:flex><span>^dalvik/.*
</span></span><span style=display:flex><span>^developers/.*
</span></span><span style=display:flex><span>^external/.*
</span></span><span style=display:flex><span>^platform_testing/.*
</span></span><span style=display:flex><span>^pdk/.*
</span></span><span style=display:flex><span>^sdk/.*
</span></span><span style=display:flex><span>^system/.*
</span></span><span style=display:flex><span>^test/.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># platform-compat中有注解的类</span>
</span></span><span style=display:flex><span>^tools/<span style=color:#f92672>(</span>?!<span style=color:#f92672>(</span>platform-compat<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>^development/.*
</span></span><span style=display:flex><span>^device/.*
</span></span><span style=display:flex><span>^prebuilts/*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 这里我们查看这两个模块，所以注释掉</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#^libcore/.*</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#^frameworks/.*</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 关于out其他的一些规则</span>
</span></span><span style=display:flex><span>^out/soong/.intermediates/<span style=color:#f92672>(</span>?!<span style=color:#f92672>((</span>frameworks<span style=color:#f92672>)</span>|<span style=color:#f92672>(</span>libcore<span style=color:#f92672>)))</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ./out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_x86_64_shared/gen/aidl/android/os/BnServiceManager.h</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ^out/soong/.intermediates/.*</span>
</span></span><span style=display:flex><span>^out/target/.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据实际运行情况补充的规则</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 移除可能的jar</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 如 ./frameworks/base/tools/aapt2/integration-tests/CommandTests/android-28.jar</span>
</span></span><span style=display:flex><span>^frameworks/base/tools/aapt2/.*<span style=color:#ae81ff>\.</span>jar
</span></span><span style=display:flex><span>^frameworks/base/tests
</span></span><span style=display:flex><span>^libcore/support/src/test
</span></span><span style=display:flex><span>^libcore/luni/src/test
</span></span><span style=display:flex><span>gradle-wrapper.jar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 对于sdk源码的隐藏，我们exclude掉，以使可以找到真正的源码</span>
</span></span><span style=display:flex><span>^libcore/ojluni/annotations
</span></span></code></pre></div></li><li><p>生成iml文件，执行下面命令生成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>development/tools/idegen/idegen.sh
</span></span></code></pre></div><p>完成后根目录下即生成了<code>android.iml</code>,<code>android.ipr</code></p></li></ol><h3 id=导入到androidstudio>导入到AndroidStudio<a hidden class=anchor aria-hidden=true href=#导入到androidstudio>#</a></h3><h4 id=androidstudio-配置>androidstudio 配置<a hidden class=anchor aria-hidden=true href=#androidstudio-配置>#</a></h4><ol><li><p>配置jvm选项，根据机器实际情况设置vm分配的内存策略</p><p><img alt=20210402093304 loading=lazy src=https://s2.loli.net/2022/05/26/Iubf2vnAUeSt5T9.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-Xmx16g
</span></span><span style=display:flex><span>-Xms2g
</span></span></code></pre></div></li><li><p>配置 idea 属性</p><p><img alt=20210401212321 loading=lazy src=https://s2.loli.net/2022/05/26/3YAvO65PCwjS971.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 大小写敏感（macOS）</span>
</span></span><span style=display:flex><span>idea.case.sensitive.fs<span style=color:#f92672>=</span>true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>idea.max.intellisense.filesize<span style=color:#f92672>=</span><span style=color:#ae81ff>100000</span>
</span></span></code></pre></div></li></ol><h4 id=导入项目到as并配置>导入项目到AS并配置<a hidden class=anchor aria-hidden=true href=#导入项目到as并配置>#</a></h4><p>配置sdk主要是为了避免查看或调试代码时，AS仍然去使用SDK中配置的class，而不是我们的aosp中的java源码。</p><ol><li><p>使用AndroidStudio 打开项目根目录下 <code>android.ipr</code> 文件即可导入项目；</p></li><li><p>配置项目SDK，进入项目设置，添加一个新的JDK，并删除所有依赖jar库，我们这里取名为：<code>1.8 (No Libraries)</code></p><p><img alt=20210402095209 loading=lazy src=https://s2.loli.net/2022/05/26/IW7d3v2iURTSrHx.png></p></li><li><p>配置项目SDK，进入项目设置，添加一个新的SDK，并删除所有jar库，对应的JDK选择之前创建的<code>1.8 (No Libraries)</code>，这里我们将SDK命名为 <code>Android API 30 Platform-NoLib</code></p><p><img alt=20210402095255 loading=lazy src=https://s2.loli.net/2022/05/26/zZqhWtRMxOf6j9w.png></p></li><li><p>在Project设置中，选择项目SDK为之前设置的 <code>Android API 30 Platform-NoLib</code></p><p><img alt=20210402095343 loading=lazy src=https://s2.loli.net/2022/05/26/pPBC8DeMZQH2Sm5.png></p></li><li><p>进入项目设置-模块设置，将模块的SDK设置为之前设置的 <code>Android API 30 Platform-NoLib</code></p><p><img alt=20210402095449 loading=lazy src=https://s2.loli.net/2022/05/26/q6RfQivmWCVpy1b.png></p></li></ol><h4 id=附加调试器到-system_process>附加调试器到 system_process<a hidden class=anchor aria-hidden=true href=#附加调试器到-system_process>#</a></h4><ol><li>附加调试器到 <code>system_process</code> 进程</li></ol><p><img alt=20210402093915 loading=lazy src=https://s2.loli.net/2022/05/26/BCe1wSr2mcDNIhW.png></p><p><img alt=20210402095736 loading=lazy src=https://s2.loli.net/2022/05/26/EdqxcUp4PvIwKza.png></p><ol start=2><li><p>成功后的Debugger界面如下所示</p><p><img alt=20210402100639 loading=lazy src=https://s2.loli.net/2022/05/26/UFs6MnaOcGKPdJm.png></p></li><li><p>打断点测试，这里我们选择在 <code>Binder.java</code> 文件中添加断点，然后在模拟器中打开相机APP以触发断点逻辑。下图就表示我们到达了断点，说明我们可以通过AS来调试该进程了。</p><p><img alt=20210402101258 loading=lazy src=https://s2.loli.net/2022/05/26/jK9lUkJWfr1xc34.png></p></li></ol><blockquote><p>提示：附加调试器时，如找不到设备，可参考第5小节中的 <em>错误解决：Debug中不显示设备</em></p></blockquote><h2 id=修改并更新系统模块>修改并更新系统模块<a hidden class=anchor aria-hidden=true href=#修改并更新系统模块>#</a></h2><p>在调试分析过程中，可能我们需要修改一下其中内容以协助分析，可以按如下方式进行。</p><h3 id=framework>Framework<a hidden class=anchor aria-hidden=true href=#framework>#</a></h3><p>构建 framework 分两块：</p><ol><li>JAR 部分使用命令 <code>mmm frameworks/base/</code></li><li>资源部分： <code>mmm frameworks/base/core/res/</code></li></ol><p><strong>安装：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 获取root权限</span>
</span></span><span style=display:flex><span>adb root
</span></span><span style=display:flex><span>adb disable-verity
</span></span><span style=display:flex><span>adb reboot
</span></span><span style=display:flex><span>adb remount
</span></span><span style=display:flex><span><span style=color:#75715e># 移除旧的framework</span>
</span></span><span style=display:flex><span>adb shell
</span></span><span style=display:flex><span>cd /system/framework/
</span></span><span style=display:flex><span>rm framework-res.apk
</span></span><span style=display:flex><span>exit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 推入新的framework</span>
</span></span><span style=display:flex><span>adb push out/target/product/&lt;device_targeted&gt;/system/framework/framework-res.apk /system/framework/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>adb reboot
</span></span></code></pre></div><h3 id=packages中app>packages中app<a hidden class=anchor aria-hidden=true href=#packages中app>#</a></h3><ul><li>构建</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd ~/aosp
</span></span><span style=display:flex><span>source build/envsetup.sh 
</span></span><span style=display:flex><span>lunch aosp_x86_64-eng
</span></span><span style=display:flex><span><span style=color:#75715e># 重新构建单个模块 (如 Dialer)</span>
</span></span><span style=display:flex><span>mmm packages/apps/dialer/
</span></span><span style=display:flex><span><span style=color:#75715e># 生成的文件会在控制台中输出来</span>
</span></span></code></pre></div><ul><li>更新到系统</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>adb install -r out/target/product/&lt;device_targeted&gt;/system/priv-app/&lt;app_name&gt;/&lt;app_name&gt;.apk
</span></span><span style=display:flex><span>adb reboot
</span></span></code></pre></div><h3 id=systemui>SystemUI<a hidden class=anchor aria-hidden=true href=#systemui>#</a></h3><ul><li>编译</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd WORKING_DIRECTORY
</span></span><span style=display:flex><span>source build/envsetup.sh
</span></span><span style=display:flex><span><span style=color:#75715e># 选择设备</span>
</span></span><span style=display:flex><span>lunch <span style=color:#ae81ff>31</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重新构建SystemUI</span>
</span></span><span style=display:flex><span>mmm frameworks/base/packages/SystemUI/
</span></span></code></pre></div><ul><li>安装到系统</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>adb install -r out/target/product/&lt;device_targeted&gt;/system/priv-app/SystemUI/SystemUI.apk
</span></span><span style=display:flex><span>adb reboot
</span></span></code></pre></div><h2 id=使用提示及常见错误>使用提示及常见错误<a hidden class=anchor aria-hidden=true href=#使用提示及常见错误>#</a></h2><h3 id=使用提示项目源码浏览配置>使用提示：项目源码浏览配置<a hidden class=anchor aria-hidden=true href=#使用提示项目源码浏览配置>#</a></h3><h4 id=筛选project代码范围>筛选Project代码范围<a hidden class=anchor aria-hidden=true href=#筛选project代码范围>#</a></h4><ol><li><p>点击project窗口的设置按钮，选择 “Edit Scopes”</p><p><img alt=20210402104239 loading=lazy src=https://s2.loli.net/2022/05/26/b54fWpm6liduwHo.png></p></li><li><p>新建一个规则，输入名称，并在Pattern中输入过滤规则： <code>file[android]:frameworks//*||file[android]:libcore//*</code></p><p><img alt=20210402104205 loading=lazy src=https://s2.loli.net/2022/05/26/O6ulDULrbK8nfPQ.png></p></li></ol><h4 id=过滤vcs配置中不必要的模块>过滤VCS配置中不必要的模块<a hidden class=anchor aria-hidden=true href=#过滤vcs配置中不必要的模块>#</a></h4><p>打开VCS配置，移除frameworks和libcore之外的所有其他模块</p><p><img alt=20210402105446 loading=lazy src=https://s2.loli.net/2022/05/26/4MUamSB37LQDThN.png></p><h3 id=使用提示导入其他模块的源码到as>使用提示：导入其他模块的源码到AS<a hidden class=anchor aria-hidden=true href=#使用提示导入其他模块的源码到as>#</a></h3><p>不建议直接修改 android.iml 文件，应当通过修改源码根目录自定义的 <code>excluded-paths</code> 文件中定义的规则来包含其他模块的源码。</p><p>修改此文件后，重新执行 <code>development/tools/idegen/idegen.sh</code> 来生成最新的as项目配置。生成完成后一般as如果是打开状态，会自动更新索引，如果索引更新有问题，可关闭项目，然后重新打开。</p><h3 id=错误解决macos-ds_store-导致打包镜像失败>错误解决：macOS .DS_Store 导致打包镜像失败<a hidden class=anchor aria-hidden=true href=#错误解决macos-ds_store-导致打包镜像失败>#</a></h3><p>编译基本完成，但是最后打包system.img文件时报错，报错内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>set_selinux_xattr: No such file or directory searching <span style=color:#66d9ef>for</span> label <span style=color:#e6db74>&#34;/.DS_Store&#34;</span>
</span></span><span style=display:flex><span>e2fsdroid: No such file or directory <span style=color:#66d9ef>while</span> configuring the file system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:00:38 ninja failed with: exit status <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>解决方式：删除源码目录中的所有 <code>.DS_Store</code>，可通过如下命令进行统一清理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>find . -name <span style=color:#e6db74>&#34;.DS_Store&#34;</span>  | xargs -I <span style=color:#f92672>{}</span> rm <span style=color:#f92672>{}</span> 
</span></span></code></pre></div><blockquote><p>说明： .DS_Store 文件为macOS中存储文件夹界面展示相关的一些信息，在Finder中查看对应目录后可能会生成</p></blockquote><h3 id=错误解决附加调试器时不显示设备>错误解决：附加调试器时不显示设备<a hidden class=anchor aria-hidden=true href=#错误解决附加调试器时不显示设备>#</a></h3><p>在附加调试器时，可能会如下图一样，模拟器已经启动了，但是附加调试器的窗口中设备列表中没有设备</p><p><img alt=20210402121454 loading=lazy src=https://s2.loli.net/2022/05/26/8UdS9MZ3rnAl6mi.png></p><p>此时检查自己的项目配置中的SDK是否选择了AndroidSDK，设置成 Android SDK 即可</p><p><img alt=20210402121537 loading=lazy src=https://s2.loli.net/2022/05/26/yKgSVda9RWo8Jnp.png></p><h3 id=错误解决模拟器无法启动-报找不到内核版本信息>错误解决：模拟器无法启动-报找不到内核版本信息<a hidden class=anchor aria-hidden=true href=#错误解决模拟器无法启动-报找不到内核版本信息>#</a></h3><p>当使用 <code>android-11.0.0_r28</code> 版本时，编译通过后，使用emulator启动时，报出如下错误</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>emulator: ERROR: Can<span style=color:#e6db74>&#39;t find &#39;</span>Linux version <span style=color:#960050;background-color:#1e0010>&#39;</span> string in kernel image file: /Volumes/HIKVISION/google-aosp/out/target/product/generic_x86_64/kernel-ranchu
</span></span></code></pre></div><p>原因是emulator版本过旧，需要使用新的emulator，执行如下命令获取新的版本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd prebuilts/android-emulator
</span></span><span style=display:flex><span><span style=color:#75715e># 查询可用分支，https://android.googlesource.com/platform/prebuilts/android-emulator/+refs</span>
</span></span><span style=display:flex><span>git fetch aosp android-11.0.0_r33:refs/remotes/m/android-11.0.0_r33
</span></span><span style=display:flex><span><span style=color:#75715e># 检出分支</span>
</span></span><span style=display:flex><span>git co -b android-11.0.0_r33 refs/remotes/m/
</span></span><span style=display:flex><span>android-11.0.0_r33
</span></span></code></pre></div><p>获取完成后再次执行 <code>emulator</code> 命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>emulator -version
</span></span><span style=display:flex><span><span style=color:#75715e># Android emulator version 30.3.0.0 (build_id 6946397) (CL:N/A)</span>
</span></span><span style=display:flex><span>emulator 
</span></span><span style=display:flex><span><span style=color:#75715e># 启动模拟器</span>
</span></span></code></pre></div><h2 id=参考文章>参考文章<a hidden class=anchor aria-hidden=true href=#参考文章>#</a></h2><p><strong>参考：</strong></p><ul><li><a href=https://blog.devwu.com/2019/06/23/how-to-reading-AOSP-with-Android-Studio/>使用 Android Studio 阅读 AOSP 源码</a></li><li><a href=https://param105.medium.com/aosp-source-code-in-android-studio-explore-only-1cdc3081cf51>AOSP Source Code in Android Studio (Explore only)</a></li><li><a href=https://stackoverflow.com/questions/16582112/aosp-and-intellij-idea>Stackoverflow aosp-and-intellij-idea</a></li><li><a href=https://medium.com/@christopherney/building-android-o-with-a-mac-da07e8bd94f9>Building Android O with a Mac - Christopher Ney</a></li><li><a href=https://nf4789.medium.com/building-android-11-for-ph-1-on-apple-silicon-6600436a36a0>Building Android 11 for PH-1 on Apple Silicon</a></li><li><a href=https://stackoverflow.com/questions/50760701/could-not-find-a-supported-mac-sdk-10-10-10-11-10-12-10-13>Could not find a supported mac sdk: “10.10” “10.11” “10.12” “10.13”</a></li><li><a href="https://source.android.google.cn/setup/build/initializing?hl=zh-cn#creating-a-case-sensitive-disk-image">创建区分大小写的磁盘映像-source.android.google.cn</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://hanlyjiang.github.io/tags/android/>Android</a></li><li><a href=https://hanlyjiang.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>源码分析</a></li></ul><nav class=paginav><a class=prev href=https://hanlyjiang.github.io/posts/geopanel-rong-qi-hua/><span class=title>« Prev</span><br><span>GeoPanel容器化</span>
</a><a class=next href=https://hanlyjiang.github.io/posts/gridea%E4%BD%BF%E7%94%A8%E5%B0%8F%E8%AE%B0/><span class=title>Next »</span><br><span>Gridea使用小记</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hanlyjiang.github.io/>清水池塘</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>