<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>工作交接-Gitlab相关 | 清水池塘</title><meta name=keywords content="工作"><meta name=description content="Gitlab&持续集成&效率工具
graph 
Gitlab[Gitlab&持续集成&效率工具]
Gitlab --> 服务维护
Gitlab --> Gitlab&amp;Sonar使用问题解答与解决
Gitlab --> CI[基于Gitlab CI的自动化流程]
服务维护
目前有3个服务器需要维护，上面有部署若干服务：
graph 
205[172.17.0.205]
206[172.17.0.206]
208[172.17.0.208]

205 --> gitlab
206 --> sonarqube
206 --> mattermost
208 --> yapi
208 --> confluence
208 --> gitlab-runner
208 --> 移动中心H5站点
服务的连接方式及部署的服务可以参考文档： 《Gitlab-SonarQube服务信息汇总》， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；
以下简要说明各个服务的维护方式及可能遇到的问题。
gitlab（205）

部署目录： /data/gitlab/

teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问tb的此文档目录 进行查阅；
这里我们重点强调下gitlab的重启可能遇到的问题，使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab详细可参考tb上的此文章。
sonarqube （206）

部署目录：/data/_data/sonarqube

一般只需要启动及重启，可参考   《Gitlab-SonarQube服务信息汇总》 的相关小节，主要命令如下：
# 部署    
docker stack deploy -c docker-compose.yml sonarqube

# 停止 
docker stack down sonarqube

# 重新启动
docker stack up sonarqube -c docker-compose.yml
yapi（208）

部署目录： /data/yapi-docker-deploy

# 启动命令
docker stack deploy -c docker-compose.yml yapi
# 其他维护命令基于yapi的stack执行即可
mattermost相关（206）
mattermost相关请联系段春先"><meta name=author content="野生莲藕"><link rel=canonical href=https://hanlyjiang.github.io/posts/%E5%B7%A5%E4%BD%9C%E4%BA%A4%E6%8E%A5-gitlab%E7%9B%B8%E5%85%B3/><link crossorigin=anonymous href=/assets/css/stylesheet.e3ad983e2ed74d47928d2fcfb404b2d2a87f0ad3e1c106708add8cededbe9a25.css integrity="sha256-462YPi7XTUeSjS/PtASy0qh/CtPhwQZwit2M7e2+miU=" rel="preload stylesheet" as=style><link rel=icon href=https://hanlyjiang.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hanlyjiang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanlyjiang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hanlyjiang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hanlyjiang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hanlyjiang.github.io/posts/%E5%B7%A5%E4%BD%9C%E4%BA%A4%E6%8E%A5-gitlab%E7%9B%B8%E5%85%B3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://hanlyjiang.github.io/posts/%E5%B7%A5%E4%BD%9C%E4%BA%A4%E6%8E%A5-gitlab%E7%9B%B8%E5%85%B3/"><meta property="og:site_name" content="清水池塘"><meta property="og:title" content="工作交接-Gitlab相关"><meta property="og:description" content="Gitlab&持续集成&效率工具 graph Gitlab[Gitlab&持续集成&效率工具] Gitlab --> 服务维护 Gitlab --> Gitlab&amp;Sonar使用问题解答与解决 Gitlab --> CI[基于Gitlab CI的自动化流程] 服务维护 目前有3个服务器需要维护，上面有部署若干服务：
graph 205[172.17.0.205] 206[172.17.0.206] 208[172.17.0.208] 205 --> gitlab 206 --> sonarqube 206 --> mattermost 208 --> yapi 208 --> confluence 208 --> gitlab-runner 208 --> 移动中心H5站点 服务的连接方式及部署的服务可以参考文档： 《Gitlab-SonarQube服务信息汇总》， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；
以下简要说明各个服务的维护方式及可能遇到的问题。
gitlab（205） 部署目录： /data/gitlab/ teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问tb的此文档目录 进行查阅；
这里我们重点强调下gitlab的重启可能遇到的问题，使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab详细可参考tb上的此文章。
sonarqube （206） 部署目录：/data/_data/sonarqube 一般只需要启动及重启，可参考 《Gitlab-SonarQube服务信息汇总》 的相关小节，主要命令如下：
# 部署 docker stack deploy -c docker-compose.yml sonarqube # 停止 docker stack down sonarqube # 重新启动 docker stack up sonarqube -c docker-compose.yml yapi（208） 部署目录： /data/yapi-docker-deploy # 启动命令 docker stack deploy -c docker-compose.yml yapi # 其他维护命令基于yapi的stack执行即可 mattermost相关（206） mattermost相关请联系段春先"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-08T16:48:23+00:00"><meta property="article:modified_time" content="2021-04-08T16:48:23+00:00"><meta property="article:tag" content="工作"><meta name=twitter:card content="summary"><meta name=twitter:title content="工作交接-Gitlab相关"><meta name=twitter:description content="Gitlab&持续集成&效率工具
graph 
Gitlab[Gitlab&持续集成&效率工具]
Gitlab --> 服务维护
Gitlab --> Gitlab&amp;Sonar使用问题解答与解决
Gitlab --> CI[基于Gitlab CI的自动化流程]
服务维护
目前有3个服务器需要维护，上面有部署若干服务：
graph 
205[172.17.0.205]
206[172.17.0.206]
208[172.17.0.208]

205 --> gitlab
206 --> sonarqube
206 --> mattermost
208 --> yapi
208 --> confluence
208 --> gitlab-runner
208 --> 移动中心H5站点
服务的连接方式及部署的服务可以参考文档： 《Gitlab-SonarQube服务信息汇总》， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；
以下简要说明各个服务的维护方式及可能遇到的问题。
gitlab（205）

部署目录： /data/gitlab/

teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问tb的此文档目录 进行查阅；
这里我们重点强调下gitlab的重启可能遇到的问题，使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab详细可参考tb上的此文章。
sonarqube （206）

部署目录：/data/_data/sonarqube

一般只需要启动及重启，可参考   《Gitlab-SonarQube服务信息汇总》 的相关小节，主要命令如下：
# 部署    
docker stack deploy -c docker-compose.yml sonarqube

# 停止 
docker stack down sonarqube

# 重新启动
docker stack up sonarqube -c docker-compose.yml
yapi（208）

部署目录： /data/yapi-docker-deploy

# 启动命令
docker stack deploy -c docker-compose.yml yapi
# 其他维护命令基于yapi的stack执行即可
mattermost相关（206）
mattermost相关请联系段春先"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hanlyjiang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"工作交接-Gitlab相关","item":"https://hanlyjiang.github.io/posts/%E5%B7%A5%E4%BD%9C%E4%BA%A4%E6%8E%A5-gitlab%E7%9B%B8%E5%85%B3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"工作交接-Gitlab相关","name":"工作交接-Gitlab相关","description":"Gitlab\u0026amp;持续集成\u0026amp;效率工具 graph Gitlab[Gitlab\u0026amp;持续集成\u0026amp;效率工具] Gitlab --\u0026gt; 服务维护 Gitlab --\u0026gt; Gitlab\u0026amp;Sonar使用问题解答与解决 Gitlab --\u0026gt; CI[基于Gitlab CI的自动化流程] 服务维护 目前有3个服务器需要维护，上面有部署若干服务：\ngraph 205[172.17.0.205] 206[172.17.0.206] 208[172.17.0.208] 205 --\u0026gt; gitlab 206 --\u0026gt; sonarqube 206 --\u0026gt; mattermost 208 --\u0026gt; yapi 208 --\u0026gt; confluence 208 --\u0026gt; gitlab-runner 208 --\u0026gt; 移动中心H5站点 服务的连接方式及部署的服务可以参考文档： 《Gitlab-SonarQube服务信息汇总》， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；\n以下简要说明各个服务的维护方式及可能遇到的问题。\ngitlab（205） 部署目录： /data/gitlab/ teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问tb的此文档目录 进行查阅；\n这里我们重点强调下gitlab的重启可能遇到的问题，使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab详细可参考tb上的此文章。\nsonarqube （206） 部署目录：/data/_data/sonarqube 一般只需要启动及重启，可参考 《Gitlab-SonarQube服务信息汇总》 的相关小节，主要命令如下：\n# 部署 docker stack deploy -c docker-compose.yml sonarqube # 停止 docker stack down sonarqube # 重新启动 docker stack up sonarqube -c docker-compose.yml yapi（208） 部署目录： /data/yapi-docker-deploy # 启动命令 docker stack deploy -c docker-compose.yml yapi # 其他维护命令基于yapi的stack执行即可 mattermost相关（206） mattermost相关请联系段春先\n","keywords":["工作"],"articleBody":"Gitlab\u0026持续集成\u0026效率工具 graph Gitlab[Gitlab\u0026持续集成\u0026效率工具] Gitlab --\u003e 服务维护 Gitlab --\u003e Gitlab\u0026Sonar使用问题解答与解决 Gitlab --\u003e CI[基于Gitlab CI的自动化流程] 服务维护 目前有3个服务器需要维护，上面有部署若干服务：\ngraph 205[172.17.0.205] 206[172.17.0.206] 208[172.17.0.208] 205 --\u003e gitlab 206 --\u003e sonarqube 206 --\u003e mattermost 208 --\u003e yapi 208 --\u003e confluence 208 --\u003e gitlab-runner 208 --\u003e 移动中心H5站点 服务的连接方式及部署的服务可以参考文档： 《Gitlab-SonarQube服务信息汇总》， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；\n以下简要说明各个服务的维护方式及可能遇到的问题。\ngitlab（205） 部署目录： /data/gitlab/ teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问tb的此文档目录 进行查阅；\n这里我们重点强调下gitlab的重启可能遇到的问题，使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab详细可参考tb上的此文章。\nsonarqube （206） 部署目录：/data/_data/sonarqube 一般只需要启动及重启，可参考 《Gitlab-SonarQube服务信息汇总》 的相关小节，主要命令如下：\n# 部署 docker stack deploy -c docker-compose.yml sonarqube # 停止 docker stack down sonarqube # 重新启动 docker stack up sonarqube -c docker-compose.yml yapi（208） 部署目录： /data/yapi-docker-deploy # 启动命令 docker stack deploy -c docker-compose.yml yapi # 其他维护命令基于yapi的stack执行即可 mattermost相关（206） mattermost相关请联系段春先\ngitlab-runner（208） 208上的gitlab-runner作为部门的公用runner，执行各种通用任务。\n我们在208上注册启动了两个runner，一个使用docker方式运行，一个使用二进制方式直接运行在主机上，使用的时候需要注意区分；\ndocker方式运行的runner 使用docker方式运行的runner使用geostar用户运行，用于执行通用任务，使用docker作为执行器。 相关维护操作直接对容器进行即可： 重启：docker restart gitlab-runner 扩展了命令别名，默认情况下，使用geostar用户在主机上直接执行 gitlab-runner命令时，实际上时执行 docker exec -it gitlab-runner [命令] 执行命令：docker exec -it gitlab-runner bash 二进制运行的runner 使用二进制运行的runner使用root用户运行，使用shell作为执行器，用于执行需要直接操作主机的命令，如打包docker镜像。 相关维护操作需要使用root用户完成（通过 /usr/bin/gitlab-runner 命令） 如，查看状态：sudo /usr/bin/gitlab-runner status Gitlab\u0026Sonar使用问题解答与解决 sonarqube的启动重启请参考 《Gitlab-SonarQube服务信息汇总》 中的sonar的部署方式。\n基于Gitlab CI的自动化流程相关 这里下面另外启动一个章节说明\nGitlab相关-Gitlab安装及配置 安装 我们使用docker来安装Gitlab，执行如下命令即可安装运行，完成后使用\nexport GITLAB_DATA=/data/gitlab # 设置主机的ip域名 export HOST_IP=192.168.43.62 mkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data docker run --detach \\ --hostname $HOST_IP \\ --publish 443:443 --publish 80:80 --publish 22:22 \\ --name gitlab \\ --restart always \\ --volume $GITLAB_DATA/config:/etc/gitlab \\ --volume $GITLAB_DATA/logs:/var/log/gitlab \\ --volume $GITLAB_DATA/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.9.1-ce.0 数据全部挂载在外部目录 GITLAB_DATA 中 --hostname 192.168.43.62 : 指定当前服务的IP或者域名，后续将会显示为gitlab代码仓库的克隆地址 --restart always : 设置服务自动重启 查看gitlab的可用版本：\ndockerhub/gitlab-ce gitlab release page 查看启动状态 启动期间可以使用 docker ps 查看状态，如STATUS中显示为starting则表示服务还在启动中，如显示为healthy则表示服务已正常启动，即可访问 http://192.168.43.62 访问Gitlab的web地址。\nCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 79b432f0f601 gitlab/gitlab-ce:13.0.6-ce.0 \"/assets/wrapper\" 2 months ago Up 2 weeks (healthy) 0.0.0.0:22-\u003e22/tcp, 0.0.0.0:80-\u003e80/tcp, 0.0.0.0:443-\u003e443/tcp gitlab 也可使用 docker logs -f gitlab 来查看gitlab的服务启动日志\n设置root管理员用户密码 首次打开页面后会提示设置root用户的密码，设置后务必记录好用户密码，后续将使用此用户对Gitlab进行管理\n配置LDAP 服务启动正常后，$GITLAB_DATA/config 文件夹中即生成了gitlab的配置文件，可编辑$GITLAB_DATA/config/gitlab.rb （对应容器内部 /etc/gitlab/gitlab.rb ）文件来修改gitlab配置以使用LDAP\nvim /etc/gitlab/gitlab.rb 通过? 搜索LDAP，找到如下配置端，按如下方式进行修改：\n### LDAP Settings ###! Docs: https://docs.gitlab.com/omnibus/settings/ldap.html ###! **Be careful not to break the indentation in the ldap_servers block. It is ###! in yaml format and the spaces must be retained. Using tabs will not work.** gitlab_rails['ldap_enabled'] = true gitlab_rails['ldap_servers'] = YAML.load \u003c\u003c-'EOS' main: label: '域账号' host: '172.17.0.3' port: 389 uid: 'sAMAccountName' bind_dn: 'CN=智慧城市Mattermost系统,OU=邮箱用户,DC=geostar,DC=com,DC=cn' password: '3uQ5V2LDgG' encryption: 'plain' # \"start_tls\" or \"simple_tls\" or \"plain\" verify_certificates: false smartcard_auth: false active_directory: true allow_username_or_email_login: false # 是否允许以用户名登录（邮箱也会取用户名来严重） lowercase_usernames: false block_auto_created_users: false base: 'OU=武大吉奥-域用户,DC=geostar,DC=com,DC=cn' user_filter: '' EOS 配置修改说明：\nldap_enabled 需要设置为true ldap_servers 配置AD域相关信息 label： 随便取，会显示在gitlab的登录页面 host： 域控制服务器主机地址 port： 域控制器服务端口 uid： 将域用户信息中的哪个字段作为gitlab上的登录标识（一般都是sAMAccountName） bind_dn： 用于访问域控制服务器的用户账号，用户账号的格式需要使用CN=xxx,OU=XXX,DC=XXXX 类似的格式 password： 对应的base_dn账号的密码 base： 用于登录时，会去base所定义的组里面去检索用户是否存在，如用户在这个范围内，才可以登录；如及用于公司一个部门的登录，可将base值配置到部门级别，则其他部分无法以域账号进行登录； 提示： 如无法确认 uid，bind_dn，base 等的值，可以咨询信息中心或者使用AD域访问查看软件（如：Apache Directory）连接到域账号控制器服务后，通过图形界面查看对应信息；\n修改完毕后需要保存文件后重启gitlab服务，对于docker启动的gitlab来说，可执行如下命令重启服务：\n# 其中gitlab为我们使用docker run 命令时通过--name选项指定的容器名称 docker restart gitlab 待gitlab重启完毕后，登录界面即出现域账号登录的tab入口，点击域账号tab即可使用域账号进行登录\n配置邮箱通知 公司邮箱服务器配置：\n我们使用向信息中心申请的公共的mattermost邮箱账号。\ngitlab_rails['smtp_enable'] = true gitlab_rails['smtp_address'] = \"mail.geostar.com.cn\" gitlab_rails['smtp_port'] = 25 gitlab_rails['smtp_user_name'] = \"zh-mattermost@geostar.com.cn\" gitlab_rails['smtp_password'] = \"3uQ5V2LDgG\" gitlab_rails['smtp_domain'] = \"geostar.com.cn\" gitlab_rails['smtp_authentication'] = \"login\" gitlab_rails['smtp_enable_starttls_auto'] = true gitlab_rails['smtp_tls'] = false 163邮箱配置示例：（需在163邮箱中开启SMTP服务，可参考： CSDN-如何使用163的SMTP服务发邮件？）\ngitlab_rails['smtp_enable'] = true gitlab_rails['smtp_address'] = \"smtp.163.com\" gitlab_rails['smtp_port'] = 25 gitlab_rails['smtp_user_name'] = \"colorless@163.com\" gitlab_rails['smtp_password'] = \"密码\" gitlab_rails['smtp_domain'] = \"163.com\" gitlab_rails['smtp_authentication'] = \"login\" gitlab_rails['smtp_enable_starttls_auto'] = true gitlab_rails['smtp_tls'] = false 关闭及管理员配置 赋予指定域账号管理员权限 在配置了域账号登录之后，先让需要设置为管理员的账号使用域账号登录一次gitlab，登录后gitlab即会为该用户创建关联的gitlab账号。\n然后使用root用户登录，进入\n将用户的访问类型切换为管理员：\n关闭用户注册 在配置了域账号登录之后，可以关闭用户注册，即只允许拥有域账号的人员进行登录；\nGitlab相关-安装并注册Gitlab-Runner 安装Gitlab-Runner gitlab-runner可以使用docker方式运行，也可以在主机上运行其二进制可执行文件，可按如下方式进行选择：\n执行通用的构建测试任务及与不需要直接访问主机目录的，以docker方式安装； 执行部署类任务或需要直接访问主机目录的，以二进制方式安装； 以下分别介绍上述两种安装方式。\n使用docker安装gitlab-runner 使用docker方式安装的，需先在主机上安装docker环境，可参考 Docker 官方安装文档。以下操作假设主机上已正确安装并配置了docker运行环境；\n提示：可以使用基于alpine的镜像来减小大小\n# 建立配置挂载目录 mkdir -p /data/gitlab-runner/config # 建立构建目录挂载目录 mkdir -p /data/gitlab-runner/home # 注意，这里我们使用了基于alpine的镜像来减小大小；使用 --restart 标识来自动重启 docker run -d --name gitlab-runner --restart always \\ -v /data/gitlab-runner/config:/etc/gitlab-runner \\ -v /data/gitlab-runner/home:/home/gitlab-runner \\ -v /var/run/docker.sock:/var/run/docker.sock \\ gitlab/gitlab-runner:alpine # 通过以下命令设置docker开机自启 sudo systemctl enable docker docker安装的gitlab-runner常用操作 运行命令 使用已有容器\n# 容器已经运行的情况下 # 1. 交互式执行，执行以下命令，然后输入命令 docker exec -it gitlab-runner /bin/bash # 然后执行命令 gitlab-runer --help # 2. 单次执行 docker exec gitlab-runner gitlab-runner --help 使用临时的：\ndocker run --rm -t -i gitlab/gitlab-runner:alpine --help # -it 使用交互式终端 # --rm 自动删除 重启gitlab-runner docker restart gitlab-runner 升级版本 # 获取最新 docker pull gitlab/gitlab-runner:alpine docker stop gitlab-runner \u0026\u0026 docker rm gitlab-runner docker run -d --name gitlab-runner --restart always \\ -v /var/run/docker.sock:/var/run/docker.sock \\ -v /data/gitlab-runner/config:/etc/gitlab-runner \\ -v /data/gitlab-runner/home:/home/gitlab-runner \\ gitlab/gitlab-runner:alpine 查看日志 docker logs gitlab-runner 配置 gitlab-runner 别名 在 ~/.bash_profile 或 ~/.bashrc 文件中加入如下函数配置，后续运行 gitlab-runner 命令时即可省去docker exec 命令\n# 添加 gitlab-runner 直接执行到容器 function gitlab-runner(){ docker exec -it gitlab-runner gitlab-runner $@ } 使用二进制包安装运行gitlab-runner 获取安装包安装并运行 Centos or RedHat 使用如下命令安装：\nARCH=$(arch) curl -LJO \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner$ARCH.rpm\" rpm -i gitlab-runner_$ARCH.rpm Debian or Ubuntu 使用如下命令安装\nARCH=$(arch) curl -LJO \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_$ARCH.deb\" dpkg -i gitlab-runner_$ARCH.deb Windows 安装\n请参考官方文档： https://docs.gitlab.com/runner/install/windows.html#installation\n测试是否安装成功，如能成功输出gitlab-runner的用法信息，则表示安装成功\ngitlab-runner --help 测试是否成功启动\ngitlab-runner status # 如输出 Service is running，则表示成功启动了 通过docker方式运行的runner在运行 gitlab-runner status时会输出 not running，这对于docker方式运行的runner是正常的，只有直接运行于主机上的runner需要启动对应的服务；\n安装并更新Git版本 Gitlab-CI 任务在 runner 机器上执行，会先通过git获取对应仓库的最新代码，这个获取代码的操作是通过git来完成的，所以我们需要安装git工具；\n安装Git\nsudo yum install -y git # 查看版本 git --version # centos7 上为 1.8.x，无法满足gitlab要求 升级Git版本\n某些linux发型版上git版本过低，在执行流水线时会失败，需要升级git版本，可按如下方式从源码安装最新git版本；\n下载git v2.27.0源码\n## 以下下载方式任选其一 # 可选下载方式1 - 从gitee 克隆 git clone -b v2.27.0 https://gitee.com/hanlyjiang/git.git git-2.27.0 cd git-2.27.0 \u0026\u0026 git checkout -b tag-v2.27.0 v2.27.0 # 可选下载方式2 - 从github直接下载包 curl -LJO https://github.com/git/git/archive/v2.27.0.tar.gz tar -xvf git-2.27.0.tar.gz cd git-2.27.0 编译安装\n# 安装编译依赖库 sudo yum install -y autoconf gcc openssh zlib-devel # 编译并安装 make configure ;# as yourself ./configure --prefix=/usr ;# as yourself make -j8 all ;# as yourself sudo make install ;# as root # 确认版本： git --version # git version 2.27.0 将gitlab-runner用户添加到docker用户组（可选） 如需要在该gitlab-runner的CI脚本中运行docker命令，这需要将 gitlab-runner用户添加到docker的用户组，可执行如下命令：\nsudo usermod -a -G docker gitlab-runner # 验证权限 sudo -u gitlab-runner -H docker info 修改 gitlab-runner 构建目录 如在执行ci任务时，拉取代码时报build目录权限问题，可尝试按如下方式修改指定runner的构建目录\n查找配置文件路径\ngitlab-runner list # 其中ConfigFile的值就是对应的配置文件，如： # ConfigFile=/etc/gitlab-runner/config.toml 修改 builds_dir 指向\n找对该任务对应的[[runner]] 配置段，并在该配置中添加 builds_dir 指向新的具有权限的目录，然后重启启动gitlab-runner即可；\n[[runners]] name = \"blockdataapi-engine\" url = \"http://172.17.0.205/\" token = \"Y-6zdV9zzi8xsY1rygbn\" executor = \"shell\" builds_dir = \"/data/gitlab-runner/builds\" [runners.custom_build_dir] [runners.cache] [runners.cache.s3] [runners.cache.gcs] 注册 Runner 到 Gitlab 这里我们将runner注册为群组的Runner，群组runner可以在群组中共享，所有子群组和项目都可以使用该Runner。也可以将Runner注册到指定项目仓库上，操作上只有获取gitlab-runner注册信息时不一样；\n获取gitlab-runner注册信息 如需注册到具体项目，在项目的设置在进入对应的CI/CD设置即可，后续操作流程一致；\n在群组的设置中打开 CI/CD 设置\n展开 Runner 栏位\n这里我们选择通过手动设置group runner的方式来注册，可以获取到以下信息：\n注册runner 以docker方式运行的gitlab-runner可按如下方式进入交互环境，直接二进制运行的无需此操作；\n在gitlab-runner 的机器上执行注册命令，将runner注册到gitlab，为了方便操作，我们使用以下命令进入gitlab-runner容器shell环境：\ndocker exec -it gitlab-runner /bin/bash 执行完成后出现如下交互窗口\nbash-4.4# docker方式运行的runner需在此bash中执行命令，主机之间运行的runner直接在shell中执行即可。\n执行register命令进行注册 gitlab-runner register # url： http://172.17.0.205/ # token cEJ611JDeCWSMyu7WXWi # description - 用于辨识该注册所属的群组或项目，可以设置为方便区分的字符串 sonarqube-runner # ci-tag - 标签用于后续CI配置中选择此执行器，后期可以通过gitlab界面更改 sonarqube,common-build # executor - 后续CI任务的执行方式，docker方式运行的请选择docker docker # default image - CI配置中未指定镜像时默认使用的镜像 busybox:1.31.1 以下为一个注册过程的交互示例：\nbash-4.4# gitlab-runner register Runtime platform arch=amd64 os=linux pid=205 revision=05161b14 version=12.4.1 Running in system-mode. Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/): http://172.17.0.205/ Please enter the gitlab-ci token for this runner: cEJ611JDeCWSMyu7WXWi Please enter the gitlab-ci description for this runner: [e0311b0ce34b]: sonarqube-runner Please enter the gitlab-ci tags for this runner (comma separated): sonarqube,common-build Registering runner... succeeded runner=cEJ611JD Please enter the executor: virtualbox, docker+machine, docker-ssh+machine, custom, docker-ssh, parallels, kubernetes, docker, shell, ssh: docker Please enter the default Docker image (e.g. ruby:2.6): busybox:1.31.1 Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded! 注册后确认 完成后在刚才的页面可以看到； 取消注册 使用 list 命令查看当前注册的token及url\ngitlab-runner list # 输出类似 Runtime platform arch=amd64 os=linux pid=23 revision=05161b14 version=12.4.1 Listing configured runners ConfigFile=/etc/gitlab-runner/config.toml sonarqube-runner Executor=docker Token=wNwxjEztRpKxYDyK1zVd URL=http://172.17.0.205/ 使用list命令输出的token机url作为参数 使用unregister命令取消注册\ngitlab-runner unregister -t 7KM7ftthLAYeJdsB3Tbk -u http://172.17.0.205/ 了解更多 DOCKER 方式安装gitlab-runner Linux安装gitlab-runner-Gitlab官方文档 使用Docker运行Gitlab-Runner-Gitlab官方文档 注册Runner-Gitlab官方文档 Gitlab-Runner alpine Dockerfile Windows上注册Runner 如何在docker执行器中构建Docker镜像？ Gitlab相关-GitlabCI\u0026CD自动化 可先阅读文档：\nGitlab\u0026Mattermost\u0026Sonarqube介绍-无批注.pdf（本地文件） Gitlab协作工具使用指引 关键点总结：\n主要概念：Gitlab，gitlab-ci.yml，runner，流水线，job\nGitlab 提供代码托管，提供ci/cd能力 Gitlab-CI从 项目源码中的gitlab-ci.yml文件中读取CI流程，然后执行，我们在此文件中定义流水线及任务 Runner是一个具体的机器，用于执行任务 Runner执行器：\nshell：执行与机器相关的任务，需要使用主机命令的，如docker打包，部署 docker： 使用容器执行通用的构建任务 注册流程参考：《2019/11/19-GitlabRunner配置-共享》 Gitlab-ci配置参考： http://172.17.0.205/help/ci/yaml/README.md\nGitlab-ci重要配置 - job\n定义要执行的任务，使用script定义具体要执行的命令 Gitlab-ci重要概念 - 阶段 - 定义执行顺序\n顶层的stage定义流水线的阶段，job下的stage确定该job的归属，按顶层的stage定义的顺序执行job Gitlab-ci重要概念 - 变量 - 用于参数化构建流程\n预定义变量：http://172.17.0.205/help/ci/variables/predefined_variables.md Gitlab Web界面配置变量，支持在群组及项目级别分别配置，项目级别的优先级较高 gitlab-ci.yml 中配置变量，yml中配置的变量会被web界面中配置的覆盖 Gitlab-ci重要配置 - 归档\n用于将成果归档，可供下载 用于将成果在不同的阶段的job中传递（Gitlab自动完成） 使用时指定要归档的文件相对于CI_PROJECT_DIR的路径即可 特别注意要限制归档可以存储的时间，避免无用的归档文件占据gitlab磁盘空间 Gitlab-ci重要配置 - 规则（only，except，rule）\nonly/expect\n提交相关：\nbranches - 所有分支 tags - 所有标签 pushes - 推送 merge_requests - 提起合并请求 external_pull_requests - 外部合并请求（基本用不到） 其他：\napi - 调用gitlab api触发 external - 未了解 pipelines - 未了解 schedules ： 定时器（gitlabCI/CD设置页面设置） triggers：- 未了解 web： 界面手动触发 chat - 用不到 rules\n参考使用规则定义 http://172.17.0.205/help/ci/yaml/README.md#rules 参考示例 GeoSocial自动部署 CI/CD配置示例\nVuePress Web项目CI自动构建及部署 Android Android项目CI自动打包-洪山管理通 Android项目自动打包-移动中心APP springboot: springboot gradle自动打包-GeoRobox3.0-后台 springboot-gradle打包示例-自动打包-多环境部署 sonar代码检查： 使用帮助-Sonar检查通用模板配置 C#代码检查示例项目 移动中心Android代码检查 Gitlab相关-使用提示 CI脚本中变量含有特殊字符时的处理 对于变量中有$的，可以使用两个 $ 来进行转义，如：\nrobot$$gitlab 如何检查CI配置？ 注意： CI规则的检查是和项目相关的，只能在对应的项目中进行检查\n检查CI配置是否合规，可在项目的CI/CD界面，点击CI配置检查（CI lint），然后粘贴自己的配置到输入框中执行检查\nDocker Runner的构建加速（配置数据卷） Docker的Runner非常适合用于作为通用的构建机器，以执行各种不同类型的语言及不同打包工具的编译任务，比方说gradle,maven，npm等等。\n一般来说，我们的项目都会使用很多第三方的依赖，而且这些依赖只是在构建需要时从网络上获取，然后构建工具会将这些包缓存在某个目录中，如：\ngradle 一般放置在 ~/.gradle 目录中，同时也会存储 gradle 的各种版本； mvn 一般放置于 ~/.m2 目录中； 使用容器构建时，这些缓存目录都位于容器内部，也就是每次都需要重新下载，非常浪费时间。所以我们需要能让这些目录可以自动挂载到执行的容器中，gitlab-runner提供了这种能力，具体配置方式参考如下：\n找到gitlab-runner的配置文件，可通过如下命令查找，查看其中的ConfigFile指向的目录\n$ sudo /usr/bin/gitlab-runner list Runtime platform arch=amd64 os=linux pid=15738 revision=05161b14 version=12.4.1 Listing configured runners ConfigFile=/etc/gitlab-runner/config.toml blockdataapi-engine Executor=shell Token=Y-6zdV9zzi8xsY1rygbn URL=http://172.17.0.205/ 产品开发部 Executor=shell Token=vdxuftxm6EL_fVgAS7Td URL=http://172.17.0.205/ 移动中心-部署 Executor=shell Token=zx2vFV3x4S19n5mJDjD_ URL=http://172.17.0.205/ localhost Executor=shell Token=3xHHCWiysKqf4kWdnA_e URL=http://172.17.0.205/ 注意：如果是通过gitlab运行的gitlab-runner，则在挂载的config目录\n找到对应的Runner配置段，可通过name进行区分\n[[runners]] name = \"sonarqube-runner\" url = \"http://172.17.0.205/\" token = \"wNwxjEztRpKxYDyK1zVd\" executor = \"docker\" [runners.custom_build_dir] [runners.docker] tls_verify = false image = \"busybox:1.31.1\" privileged = false disable_entrypoint_overwrite = false oom_kill_disable = false disable_cache = false shm_size = 0 [runners.cache] [runners.cache.s3] [runners.cache.gcs] 在 [runners.docker] 配置中添加volumes配置，示例如下，写法于通过docker挂载命名卷一致\n[[runners]] name = \"sonarqube-runner\" url = \"http://172.17.0.205/\" token = \"wNwxjEztRpKxYDyK1zVd\" executor = \"docker\" [runners.custom_build_dir] [runners.docker] tls_verify = false image = \"busybox:1.31.1\" privileged = false disable_entrypoint_overwrite = false oom_kill_disable = false disable_cache = false volumes = [\"/cache\", \"maven:/root/.m2\", \"gradle_gradle:/home/gradle/.gradle\", \"nginx_static:/work/html\", \"android_build_tools:/android-sdk/build-tools\", \"android_platforms:/android-sdk/platforms\", \"android_extras:/android-sdk/extras\"] shm_size = 0 [runners.cache] [runners.cache.s3] [runners.cache.gcs] 提示：修改后直接保存，无需重新启动gitlab-runner，下次对应的任务跑到这个runner上时，即会自动生效\n这里解释下几个卷的配置：\n\"maven:/root/.m2\": 一般的maven的镜像的缓存配置目录在/root/.m2 \"gradle_gradle:/home/gradle/.gradle\": 一般的gradle镜像的缓存目录 /home/gradle/.gradle \"nginx_static:/work/html\": 为我们通过docker启动的一个nginx服务，启动时挂载了 nginx_static 到/work/html，在ci任务中，我们可在容器中将web资源拷贝到执行任务的容器内部的/work/html目录即可将web资源发布到该runner上启动的nginx服务中 另外两个都是自行构建的android构建镜像的缓存目录。 使用cache-缓存加速构建 可使用gitlab的cache关键字缓存构建的依赖下载文件\ncache: key: \"$CI_COMMIT_REF_SLUG\" paths: - node_modules/ stages: - test - build - deploy build: stage: build image: node:11-alpine script: # - npm install --registry=https://registry.npm.taobao.org - npm install - npm run build:prod artifacts: expire_in: 1 hours name: \"$CI_PROJECT_NAME--$CI_COMMIT_REF_NAME--$CI_COMMIT_SHORT_SHA--$CI_JOB_NAME--$CI_JOB_ID\" paths: - dist/ tags: - common-build only: - branches - web 之后在任务开始时，会加载缓存：\n在任务完成后，会保存缓存：\n配置前后的构建时间差距如下：（第一次需要3分钟，第二次只需要1分钟）\n参考：\nCache dependencies in GitLab CI/CD gitlab-ci.yaml - cache Gitlab相关-升级记录（12.10.0-13.0.6） 考虑到后续可能需要对gitlab进行升级，这里将之前的一次升级记录贴出，供后续升级作为参考。\n升级需要选择无人使用的时段，并提前通知。\n升级准备工作 确定升级路线 现有版本：12.10.0 当下目标版本：13.0.6 结合 Gitlab升级路线建议 确定如下升级路线： 12.10.0 -\u003e 13.0.0 -\u003e 13.0.6 由于我们跨大版本升级了（12-13），所以引入了 13.0.0 的中间升级路径 获取最新版本信息 查看 gitlab release页面 信息 查看 gitlab docker hub 获取gitlab-ce docker镜像版本TAG： 13.0.0: gitlab/gitlab-ce:13.0.0-ce.0 13.0.6: gitlab/gitlab-ce:13.0.6-ce.0 查看升级注意事项 升级流程： https://docs.gitlab.com/omnibus/docker/README.html#update 版本升级建议路线：https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations 备份 备份有两种方式，备份的数据量不相同：\n对docker挂载的gitlab数据目录整体备份 使用 gitlab的 gitlab-backup create 命令创建备份，可包含所有git仓库，包括wiki及权限信息。 建议对挂载的gitlab数据目录进行一次整体备份，目前暂不清楚gitlab-backup create命令创建的备份是否包含ci相关内容。\n以下对gitalb-backup 命令执行备份进行简要介绍。数据目录的备份方式直接对目录进行操作即可。\n进入到gitlab部署机器，执行如下命令：\ndocker exec -t gitlab-backup create # 如果docker容器的名称是gitlab，则可以执行如下命令，备份完成后位于gitlab的数据目录，如：/data/gitlab/data/backups/ docker exec -t $(docker ps | grep gitlab | awk '{print $1}') gitlab-backup create # 备份配置目录 sudo tar -cvf /data/gitlab/data/backups/1592710400_2020_06_21_12.10.0_gitlab_config_backup.tar /data/gitlab/config 执行升级： 进入到gitlab部署机器 ssh -p 10022 geostar@172.17.0.205 获取Gitlab中间版本镜像及最终版本镜像 docker pull gitlab/gitlab-ce:13.0.0-ce.0 docker pull gitlab/gitlab-ce:13.0.6-ce.0 停止并移除现有服务 sudo docker stop gitlab sudo docker rm gitlab 进行升级，使用 13.0.0 的镜像运行gitlab，gitlab会自动处理数据升级流程 sudo docker run --detach \\ --hostname 172.17.0.205 \\ --publish 443:443 --publish 80:80 --publish 22:22 \\ --name gitlab \\ --restart always \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.0.0-ce.0 待 13.0.0 升级完毕之后，升级到 13.0.6，使用 13.0.6 的镜像运行gitlab sudo docker stop gitlab sudo docker rm gitlab sudo docker run --detach \\ --hostname 172.17.0.205 \\ --publish 443:443 --publish 80:80 --publish 22:22 \\ --name gitlab \\ --restart always \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.0.6-ce.0 确认升级成功 登录管理员账号，进入管理中心-仪表盘，查看gitlab版本：\n","wordCount":"1480","inLanguage":"en","datePublished":"2021-04-08T16:48:23Z","dateModified":"2021-04-08T16:48:23Z","author":{"@type":"Person","name":"野生莲藕"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanlyjiang.github.io/posts/%E5%B7%A5%E4%BD%9C%E4%BA%A4%E6%8E%A5-gitlab%E7%9B%B8%E5%85%B3/"},"publisher":{"@type":"Organization","name":"清水池塘","logo":{"@type":"ImageObject","url":"https://hanlyjiang.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hanlyjiang.github.io/ accesskey=h title="清水池塘 (Alt + H)">清水池塘</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hanlyjiang.github.io/ title=首页><span><i class='fas fa-home'></i>首页</span></a></li><li><a href=https://hanlyjiang.github.io/archives/ title=归档><span><i class='fas fa-tags'></i>归档</span></a></li><li><a href=https://hanlyjiang.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://hanlyjiang.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hanlyjiang.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://hanlyjiang.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">工作交接-Gitlab相关</h1><div class=post-meta><span title='2021-04-08 16:48:23 +0000 UTC'>April 8, 2021</span>&nbsp;·&nbsp;<span>7 min</span>&nbsp;·&nbsp;<span>1480 words</span>&nbsp;·&nbsp;<span>野生莲藕</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#gitlab%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e6%95%88%e7%8e%87%e5%b7%a5%e5%85%b7 aria-label=Gitlab&持续集成&效率工具>Gitlab&持续集成&效率工具</a><ul><li><a href=#%e6%9c%8d%e5%8a%a1%e7%bb%b4%e6%8a%a4 aria-label=服务维护>服务维护</a><ul><li><a href=#gitlab205 aria-label=gitlab（205）>gitlab（205）</a></li><li><a href=#sonarqube-206 aria-label="sonarqube （206）">sonarqube （206）</a></li><li><a href=#yapi208 aria-label=yapi（208）>yapi（208）</a></li><li><a href=#mattermost%e7%9b%b8%e5%85%b3206 aria-label=mattermost相关（206）>mattermost相关（206）</a></li><li><a href=#gitlab-runner208 aria-label=gitlab-runner（208）>gitlab-runner（208）</a><ul><li><a href=#docker%e6%96%b9%e5%bc%8f%e8%bf%90%e8%a1%8c%e7%9a%84runner aria-label=docker方式运行的runner>docker方式运行的runner</a></li><li><a href=#%e4%ba%8c%e8%bf%9b%e5%88%b6%e8%bf%90%e8%a1%8c%e7%9a%84runner aria-label=二进制运行的runner>二进制运行的runner</a></li></ul></li></ul></li><li><a href=#gitlabsonar%e4%bd%bf%e7%94%a8%e9%97%ae%e9%a2%98%e8%a7%a3%e7%ad%94%e4%b8%8e%e8%a7%a3%e5%86%b3 aria-label=Gitlab&amp;Sonar使用问题解答与解决>Gitlab&amp;Sonar使用问题解答与解决</a></li><li><a href=#%e5%9f%ba%e4%ba%8egitlab-ci%e7%9a%84%e8%87%aa%e5%8a%a8%e5%8c%96%e6%b5%81%e7%a8%8b%e7%9b%b8%e5%85%b3 aria-label="基于Gitlab CI的自动化流程相关">基于Gitlab CI的自动化流程相关</a></li></ul></li><li><a href=#gitlab%e7%9b%b8%e5%85%b3-gitlab%e5%ae%89%e8%a3%85%e5%8f%8a%e9%85%8d%e7%bd%ae aria-label=Gitlab相关-Gitlab安装及配置>Gitlab相关-Gitlab安装及配置</a><ul><li><a href=#%e5%ae%89%e8%a3%85 aria-label=安装>安装</a><ul><li><a href=#%e6%9f%a5%e7%9c%8b%e5%90%af%e5%8a%a8%e7%8a%b6%e6%80%81 aria-label=查看启动状态>查看启动状态</a></li><li><a href=#%e8%ae%be%e7%bd%aeroot%e7%ae%a1%e7%90%86%e5%91%98%e7%94%a8%e6%88%b7%e5%af%86%e7%a0%81 aria-label=设置root管理员用户密码>设置root管理员用户密码</a></li></ul></li><li><a href=#%e9%85%8d%e7%bd%aeldap aria-label=配置LDAP>配置LDAP</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e9%82%ae%e7%ae%b1%e9%80%9a%e7%9f%a5 aria-label=配置邮箱通知>配置邮箱通知</a></li><li><a href=#%e5%85%b3%e9%97%ad%e5%8f%8a%e7%ae%a1%e7%90%86%e5%91%98%e9%85%8d%e7%bd%ae aria-label=关闭及管理员配置>关闭及管理员配置</a><ul><li><a href=#%e8%b5%8b%e4%ba%88%e6%8c%87%e5%ae%9a%e5%9f%9f%e8%b4%a6%e5%8f%b7%e7%ae%a1%e7%90%86%e5%91%98%e6%9d%83%e9%99%90 aria-label=赋予指定域账号管理员权限>赋予指定域账号管理员权限</a></li><li><a href=#%e5%85%b3%e9%97%ad%e7%94%a8%e6%88%b7%e6%b3%a8%e5%86%8c aria-label=关闭用户注册>关闭用户注册</a></li></ul></li></ul></li><li><a href=#gitlab%e7%9b%b8%e5%85%b3-%e5%ae%89%e8%a3%85%e5%b9%b6%e6%b3%a8%e5%86%8cgitlab-runner aria-label=Gitlab相关-安装并注册Gitlab-Runner>Gitlab相关-安装并注册Gitlab-Runner</a><ul><li><a href=#%e5%ae%89%e8%a3%85gitlab-runner aria-label=安装Gitlab-Runner>安装Gitlab-Runner</a><ul><li><a href=#%e4%bd%bf%e7%94%a8docker%e5%ae%89%e8%a3%85gitlab-runner aria-label=使用docker安装gitlab-runner>使用docker安装gitlab-runner</a></li><li><a href=#docker%e5%ae%89%e8%a3%85%e7%9a%84gitlab-runner%e5%b8%b8%e7%94%a8%e6%93%8d%e4%bd%9c aria-label=docker安装的gitlab-runner常用操作>docker安装的gitlab-runner常用操作</a><ul><li><a href=#%e8%bf%90%e8%a1%8c%e5%91%bd%e4%bb%a4 aria-label=运行命令>运行命令</a></li><li><a href=#%e9%87%8d%e5%90%afgitlab-runner aria-label=重启gitlab-runner>重启gitlab-runner</a></li><li><a href=#%e5%8d%87%e7%ba%a7%e7%89%88%e6%9c%ac aria-label=升级版本>升级版本</a></li><li><a href=#%e6%9f%a5%e7%9c%8b%e6%97%a5%e5%bf%97 aria-label=查看日志>查看日志</a></li><li><a href=#%e9%85%8d%e7%bd%ae-gitlab-runner-%e5%88%ab%e5%90%8d aria-label="配置 gitlab-runner 别名">配置 gitlab-runner 别名</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85%e5%ae%89%e8%a3%85%e8%bf%90%e8%a1%8cgitlab-runner aria-label=使用二进制包安装运行gitlab-runner>使用二进制包安装运行gitlab-runner</a><ul><li><a href=#%e8%8e%b7%e5%8f%96%e5%ae%89%e8%a3%85%e5%8c%85%e5%ae%89%e8%a3%85%e5%b9%b6%e8%bf%90%e8%a1%8c aria-label=获取安装包安装并运行>获取安装包安装并运行</a></li><li><a href=#%e5%ae%89%e8%a3%85%e5%b9%b6%e6%9b%b4%e6%96%b0git%e7%89%88%e6%9c%ac aria-label=安装并更新Git版本>安装并更新Git版本</a></li><li><a href=#%e5%b0%86gitlab-runner%e7%94%a8%e6%88%b7%e6%b7%bb%e5%8a%a0%e5%88%b0docker%e7%94%a8%e6%88%b7%e7%bb%84%e5%8f%af%e9%80%89 aria-label=将gitlab-runner用户添加到docker用户组（可选）>将gitlab-runner用户添加到docker用户组（可选）</a></li><li><a href=#%e4%bf%ae%e6%94%b9-gitlab-runner-%e6%9e%84%e5%bb%ba%e7%9b%ae%e5%bd%95 aria-label="修改 gitlab-runner 构建目录">修改 gitlab-runner 构建目录</a></li></ul></li></ul></li><li><a href=#%e6%b3%a8%e5%86%8c-runner-%e5%88%b0-gitlab aria-label="注册 Runner 到 Gitlab">注册 Runner 到 Gitlab</a><ul><li><a href=#%e8%8e%b7%e5%8f%96gitlab-runner%e6%b3%a8%e5%86%8c%e4%bf%a1%e6%81%af aria-label=获取gitlab-runner注册信息>获取gitlab-runner注册信息</a></li><li><a href=#%e6%b3%a8%e5%86%8crunner aria-label=注册runner>注册runner</a></li><li><a href=#%e6%89%a7%e8%a1%8cregister%e5%91%bd%e4%bb%a4%e8%bf%9b%e8%a1%8c%e6%b3%a8%e5%86%8c aria-label=执行register命令进行注册>执行register命令进行注册</a></li><li><a href=#%e6%b3%a8%e5%86%8c%e5%90%8e%e7%a1%ae%e8%ae%a4 aria-label=注册后确认>注册后确认</a></li><li><a href=#%e5%8f%96%e6%b6%88%e6%b3%a8%e5%86%8c aria-label=取消注册>取消注册</a></li></ul></li><li><a href=#%e4%ba%86%e8%a7%a3%e6%9b%b4%e5%a4%9a aria-label=了解更多>了解更多</a></li></ul></li><li><a href=#gitlab%e7%9b%b8%e5%85%b3-gitlabcicd%e8%87%aa%e5%8a%a8%e5%8c%96 aria-label=Gitlab相关-GitlabCI&amp;CD自动化>Gitlab相关-GitlabCI&amp;CD自动化</a></li><li><a href=#gitlab%e7%9b%b8%e5%85%b3-%e4%bd%bf%e7%94%a8%e6%8f%90%e7%a4%ba aria-label=Gitlab相关-使用提示>Gitlab相关-使用提示</a><ul><li><a href=#ci%e8%84%9a%e6%9c%ac%e4%b8%ad%e5%8f%98%e9%87%8f%e5%90%ab%e6%9c%89%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e6%97%b6%e7%9a%84%e5%a4%84%e7%90%86 aria-label=CI脚本中变量含有特殊字符时的处理>CI脚本中变量含有特殊字符时的处理</a></li><li><a href=#%e5%a6%82%e4%bd%95%e6%a3%80%e6%9f%a5ci%e9%85%8d%e7%bd%ae aria-label=如何检查CI配置？>如何检查CI配置？</a></li><li><a href=#docker-runner%e7%9a%84%e6%9e%84%e5%bb%ba%e5%8a%a0%e9%80%9f%e9%85%8d%e7%bd%ae%e6%95%b0%e6%8d%ae%e5%8d%b7 aria-label="Docker Runner的构建加速（配置数据卷）">Docker Runner的构建加速（配置数据卷）</a></li><li><a href=#%e4%bd%bf%e7%94%a8cache-%e7%bc%93%e5%ad%98%e5%8a%a0%e9%80%9f%e6%9e%84%e5%bb%ba aria-label=使用cache-缓存加速构建>使用cache-缓存加速构建</a></li></ul></li><li><a href=#gitlab%e7%9b%b8%e5%85%b3-%e5%8d%87%e7%ba%a7%e8%ae%b0%e5%bd%9512100-1306 aria-label=Gitlab相关-升级记录（12.10.0-13.0.6）>Gitlab相关-升级记录（12.10.0-13.0.6）</a><ul><li><a href=#%e5%8d%87%e7%ba%a7%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label=升级准备工作>升级准备工作</a><ul><li><a href=#%e7%a1%ae%e5%ae%9a%e5%8d%87%e7%ba%a7%e8%b7%af%e7%ba%bf aria-label=确定升级路线>确定升级路线</a></li><li><a href=#%e8%8e%b7%e5%8f%96%e6%9c%80%e6%96%b0%e7%89%88%e6%9c%ac%e4%bf%a1%e6%81%af aria-label=获取最新版本信息>获取最新版本信息</a></li></ul></li><li><a href=#%e5%a4%87%e4%bb%bd aria-label=备份>备份</a></li><li><a href=#%e6%89%a7%e8%a1%8c%e5%8d%87%e7%ba%a7 aria-label=执行升级：>执行升级：</a></li><li><a href=#%e7%a1%ae%e8%ae%a4%e5%8d%87%e7%ba%a7%e6%88%90%e5%8a%9f aria-label=确认升级成功>确认升级成功</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=gitlab持续集成效率工具>Gitlab&持续集成&效率工具<a hidden class=anchor aria-hidden=true href=#gitlab持续集成效率工具>#</a></h1><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph 
Gitlab[Gitlab&amp;持续集成&amp;效率工具]
Gitlab --&gt; 服务维护
Gitlab --&gt; Gitlab&amp;Sonar使用问题解答与解决
Gitlab --&gt; CI[基于Gitlab CI的自动化流程]
</code></pre><h2 id=服务维护>服务维护<a hidden class=anchor aria-hidden=true href=#服务维护>#</a></h2><p>目前有3个服务器需要维护，上面有部署若干服务：</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph 
205[172.17.0.205]
206[172.17.0.206]
208[172.17.0.208]

205 --&gt; gitlab
206 --&gt; sonarqube
206 --&gt; mattermost
208 --&gt; yapi
208 --&gt; confluence
208 --&gt; gitlab-runner
208 --&gt; 移动中心H5站点
</code></pre><p>服务的连接方式及部署的服务可以参考文档： <a href=https://shimo.im/docs/REkKVZppmPcjFQqx/>《Gitlab-SonarQube服务信息汇总》</a>， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；</p><p>以下简要说明各个服务的维护方式及可能遇到的问题。</p><h3 id=gitlab205>gitlab（205）<a hidden class=anchor aria-hidden=true href=#gitlab205>#</a></h3><ul><li>部署目录： <code>/data/gitlab/</code></li></ul><p>teambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问<a href=https://thoughts.teambition.com/workspaces/5e8da16aaf7af5001a4c7222/folders/5ee970c5b7ad5400012b51ac>tb的此文档目录</a> 进行查阅；</p><p>这里我们重点强调下gitlab的重启可能遇到的问题，<strong>使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab</strong>详细可参考<a href=https://thoughts.teambition.com/workspaces/5e8da16aaf7af5001a4c7222/docs/5f4c5eaf77f66f00010659ae>tb上的此文章</a>。</p><h3 id=sonarqube-206>sonarqube （206）<a hidden class=anchor aria-hidden=true href=#sonarqube-206>#</a></h3><ul><li>部署目录：<code>/data/_data/sonarqube</code></li></ul><p>一般只需要启动及重启，可参考 <a href=https://shimo.im/docs/REkKVZppmPcjFQqx/>《Gitlab-SonarQube服务信息汇总》</a> 的相关小节，主要命令如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 部署    </span>
</span></span><span style=display:flex><span>docker stack deploy -c docker-compose.yml sonarqube
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止 </span>
</span></span><span style=display:flex><span>docker stack down sonarqube
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重新启动</span>
</span></span><span style=display:flex><span>docker stack up sonarqube -c docker-compose.yml
</span></span></code></pre></div><h3 id=yapi208>yapi（208）<a hidden class=anchor aria-hidden=true href=#yapi208>#</a></h3><ul><li>部署目录： <code>/data/yapi-docker-deploy</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 启动命令</span>
</span></span><span style=display:flex><span>docker stack deploy -c docker-compose.yml yapi
</span></span><span style=display:flex><span><span style=color:#75715e># 其他维护命令基于yapi的stack执行即可</span>
</span></span></code></pre></div><h3 id=mattermost相关206>mattermost相关（206）<a hidden class=anchor aria-hidden=true href=#mattermost相关206>#</a></h3><p>mattermost相关请联系段春先</p><h3 id=gitlab-runner208>gitlab-runner（208）<a hidden class=anchor aria-hidden=true href=#gitlab-runner208>#</a></h3><p>208上的gitlab-runner作为部门的公用runner，执行各种通用任务。</p><p>我们在208上注册启动了两个runner，一个使用docker方式运行，一个使用二进制方式直接运行在主机上，使用的时候需要注意区分；</p><h4 id=docker方式运行的runner>docker方式运行的runner<a hidden class=anchor aria-hidden=true href=#docker方式运行的runner>#</a></h4><ul><li>使用docker方式运行的runner使用geostar用户运行，用于执行通用任务，使用docker作为执行器。</li><li>相关维护操作直接对容器进行即可：<ul><li>重启：<code>docker restart gitlab-runner</code></li><li>扩展了命令别名，默认情况下，使用geostar用户在主机上直接执行 gitlab-runner命令时，实际上时执行 <code>docker exec -it gitlab-runner [命令]</code></li><li>执行命令：<code>docker exec -it gitlab-runner bash</code></li></ul></li></ul><h4 id=二进制运行的runner>二进制运行的runner<a hidden class=anchor aria-hidden=true href=#二进制运行的runner>#</a></h4><ul><li>使用二进制运行的runner使用root用户运行，使用shell作为执行器，用于执行需要直接操作主机的命令，如打包docker镜像。</li><li>相关维护操作需要使用root用户完成（通过 /usr/bin/gitlab-runner 命令）<ul><li>如，查看状态：<code>sudo /usr/bin/gitlab-runner status</code></li></ul></li></ul><h2 id=gitlabsonar使用问题解答与解决>Gitlab&amp;Sonar使用问题解答与解决<a hidden class=anchor aria-hidden=true href=#gitlabsonar使用问题解答与解决>#</a></h2><p>sonarqube的启动重启请参考 <a href=https://shimo.im/docs/REkKVZppmPcjFQqx/>《Gitlab-SonarQube服务信息汇总》</a> 中的sonar的部署方式。</p><h2 id=基于gitlab-ci的自动化流程相关>基于Gitlab CI的自动化流程相关<a hidden class=anchor aria-hidden=true href=#基于gitlab-ci的自动化流程相关>#</a></h2><p>这里下面另外启动一个章节说明</p><h1 id=gitlab相关-gitlab安装及配置>Gitlab相关-Gitlab安装及配置<a hidden class=anchor aria-hidden=true href=#gitlab相关-gitlab安装及配置>#</a></h1><h2 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h2><p>我们使用docker来安装Gitlab，执行如下命令即可安装运行，完成后使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export GITLAB_DATA<span style=color:#f92672>=</span>/data/gitlab
</span></span><span style=display:flex><span><span style=color:#75715e># 设置主机的ip域名</span>
</span></span><span style=display:flex><span>export HOST_IP<span style=color:#f92672>=</span>192.168.43.62
</span></span><span style=display:flex><span>mkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data
</span></span><span style=display:flex><span>docker run --detach <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --hostname $HOST_IP <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --publish 443:443 --publish 80:80 --publish 22:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume $GITLAB_DATA/config:/etc/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume $GITLAB_DATA/logs:/var/log/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume $GITLAB_DATA/data:/var/opt/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        gitlab/gitlab-ce:13.9.1-ce.0
</span></span></code></pre></div><blockquote><ul><li>数据全部挂载在外部目录 GITLAB_DATA 中</li><li><code>--hostname 192.168.43.62</code> : 指定当前服务的IP或者域名，后续将会显示为gitlab代码仓库的克隆地址</li><li><code>--restart always</code> : 设置服务自动重启</li></ul></blockquote><blockquote><p>查看gitlab的可用版本：</p><ul><li><a href=dockerhub/gitlab-ce>dockerhub/gitlab-ce</a></li><li><a href=https://about.gitlab.com/releases/categories/releases/>gitlab release page</a></li></ul></blockquote><h3 id=查看启动状态><strong>查看启动状态</strong><a hidden class=anchor aria-hidden=true href=#查看启动状态>#</a></h3><p>启动期间可以使用 <code>docker ps</code> 查看状态，如STATUS中显示为<code>starting</code>则表示服务还在启动中，如显示为<code>healthy</code>则表示服务已正常启动，即可访问 http://192.168.43.62 访问Gitlab的web地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS                 PORTS                                                          NAMES
</span></span><span style=display:flex><span>79b432f0f601        gitlab/gitlab-ce:13.0.6-ce.0   <span style=color:#e6db74>&#34;/assets/wrapper&#34;</span>   <span style=color:#ae81ff>2</span> months ago        Up <span style=color:#ae81ff>2</span> weeks <span style=color:#f92672>(</span>healthy<span style=color:#f92672>)</span>   0.0.0.0:22-&gt;22/tcp, 0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   gitlab
</span></span></code></pre></div><p>也可使用 <code>docker logs -f gitlab</code> 来查看gitlab的服务启动日志</p><h3 id=设置root管理员用户密码>设置root管理员用户密码<a hidden class=anchor aria-hidden=true href=#设置root管理员用户密码>#</a></h3><p>首次打开页面后会提示设置root用户的密码，设置后务必记录好用户密码，后续将使用此用户对Gitlab进行管理</p><h2 id=配置ldap>配置LDAP<a hidden class=anchor aria-hidden=true href=#配置ldap>#</a></h2><p>服务启动正常后，<code>$GITLAB_DATA/config</code> 文件夹中即生成了gitlab的配置文件，可编辑<code>$GITLAB_DATA/config/gitlab.rb</code> （对应容器内部 <code>/etc/gitlab/gitlab.rb</code> ）文件来修改gitlab配置以使用LDAP</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vim /etc/gitlab/gitlab.rb
</span></span></code></pre></div><p>通过<code>?</code> 搜索<code>LDAP</code>，找到如下配置端，按如下方式进行修改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#75715e>### LDAP Settings</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###! Docs: https://docs.gitlab.com/omnibus/settings/ldap.html</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###! **Be careful not to break the indentation in the ldap_servers block. It is</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###!   in yaml format and the spaces must be retained. Using tabs will not work.**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;ldap_enabled&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;ldap_servers&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>YAML</span><span style=color:#f92672>.</span>load <span style=color:#e6db74>&lt;&lt;-&#39;EOS&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span>   <span style=color:#e6db74>main</span>:
</span></span><span style=display:flex><span>     <span style=color:#e6db74>label</span>: <span style=color:#e6db74>&#39;域账号&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>host</span>: <span style=color:#e6db74>&#39;172.17.0.3&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>port</span>: <span style=color:#ae81ff>389</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>uid</span>: <span style=color:#e6db74>&#39;sAMAccountName&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>bind_dn</span>: <span style=color:#e6db74>&#39;CN=智慧城市Mattermost系统,OU=邮箱用户,DC=geostar,DC=com,DC=cn&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>password</span>: <span style=color:#e6db74>&#39;3uQ5V2LDgG&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>encryption</span>: <span style=color:#e6db74>&#39;plain&#39;</span> <span style=color:#75715e># &#34;start_tls&#34; or &#34;simple_tls&#34; or &#34;plain&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>verify_certificates</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>smartcard_auth</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>active_directory</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>allow_username_or_email_login</span>: <span style=color:#66d9ef>false</span> <span style=color:#75715e># 是否允许以用户名登录（邮箱也会取用户名来严重）</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>lowercase_usernames</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>block_auto_created_users</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>base</span>: <span style=color:#e6db74>&#39;OU=武大吉奥-域用户,DC=geostar,DC=com,DC=cn&#39;</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>user_filter</span>: <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>EOS</span>
</span></span></code></pre></div><blockquote><p>配置修改说明：</p><ul><li><code>ldap_enabled</code> 需要设置为true</li><li><code>ldap_servers</code> 配置AD域相关信息<ul><li>label： 随便取，会显示在gitlab的登录页面</li><li>host： 域控制服务器主机地址</li><li>port： 域控制器服务端口</li><li>uid： 将域用户信息中的哪个字段作为gitlab上的登录标识（一般都是sAMAccountName）</li><li>bind_dn： 用于访问域控制服务器的用户账号，用户账号的格式需要使用<code>CN=xxx,OU=XXX,DC=XXXX</code> 类似的格式</li><li>password： 对应的base_dn账号的密码</li><li>base： 用于登录时，会去base所定义的组里面去检索用户是否存在，如用户在这个范围内，才可以登录；如及用于公司一个部门的登录，可将base值配置到部门级别，则其他部分无法以域账号进行登录；</li></ul></li></ul><p>提示： 如无法确认 uid，bind_dn，base 等的值，可以咨询信息中心或者使用AD域访问查看软件（如：<a href=http://directory.apache.org/>Apache Directory</a>）连接到域账号控制器服务后，通过图形界面查看对应信息；</p></blockquote><p>修改完毕后需要保存文件后重启gitlab服务，对于docker启动的gitlab来说，可执行如下命令重启服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 其中gitlab为我们使用docker run 命令时通过--name选项指定的容器名称</span>
</span></span><span style=display:flex><span>docker restart gitlab 
</span></span></code></pre></div><p>待gitlab重启完毕后，登录界面即出现域账号登录的tab入口，点击域账号tab即可使用域账号进行登录</p><h2 id=配置邮箱通知>配置邮箱通知<a hidden class=anchor aria-hidden=true href=#配置邮箱通知>#</a></h2><p>公司邮箱服务器配置：</p><p>我们使用向信息中心申请的公共的mattermost邮箱账号。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_enable&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_address&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mail.geostar.com.cn&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_port&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_user_name&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;zh-mattermost@geostar.com.cn&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_password&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3uQ5V2LDgG&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_domain&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;geostar.com.cn&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_authentication&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;login&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_enable_starttls_auto&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_tls&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>163邮箱配置示例：（需在163邮箱中开启SMTP服务，可参考： <a href=https://blog.csdn.net/liuyuinsdu/article/details/113878840>CSDN-如何使用163的SMTP服务发邮件？</a>）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_enable&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_address&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;smtp.163.com&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_port&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>25</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_user_name&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;colorless@163.com&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_password&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;密码&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_domain&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;163.com&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_authentication&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;login&#34;</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_enable_starttls_auto&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>gitlab_rails<span style=color:#f92672>[</span><span style=color:#e6db74>&#39;smtp_tls&#39;</span><span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><h2 id=关闭及管理员配置>关闭及管理员配置<a hidden class=anchor aria-hidden=true href=#关闭及管理员配置>#</a></h2><h3 id=赋予指定域账号管理员权限>赋予指定域账号管理员权限<a hidden class=anchor aria-hidden=true href=#赋予指定域账号管理员权限>#</a></h3><p>在配置了域账号登录之后，先让需要设置为管理员的账号使用域账号登录一次gitlab，登录后gitlab即会为该用户创建关联的gitlab账号。</p><p>然后使用root用户登录，进入</p><p>将用户的访问类型切换为管理员：</p><h3 id=关闭用户注册>关闭用户注册<a hidden class=anchor aria-hidden=true href=#关闭用户注册>#</a></h3><p>在配置了域账号登录之后，可以关闭用户注册，即只允许拥有域账号的人员进行登录；</p><h1 id=gitlab相关-安装并注册gitlab-runner>Gitlab相关-安装并注册Gitlab-Runner<a hidden class=anchor aria-hidden=true href=#gitlab相关-安装并注册gitlab-runner>#</a></h1><h2 id=安装gitlab-runner>安装Gitlab-Runner<a hidden class=anchor aria-hidden=true href=#安装gitlab-runner>#</a></h2><p>gitlab-runner可以使用docker方式运行，也可以在主机上运行其二进制可执行文件，可按如下方式进行选择：</p><ul><li>执行通用的构建测试任务及与不需要直接访问主机目录的，以docker方式安装；</li><li>执行部署类任务或需要直接访问主机目录的，以二进制方式安装；</li></ul><p>以下分别介绍上述两种安装方式。</p><h3 id=使用docker安装gitlab-runner>使用docker安装gitlab-runner<a hidden class=anchor aria-hidden=true href=#使用docker安装gitlab-runner>#</a></h3><p>使用docker方式安装的，需先在主机上安装docker环境，可参考 Docker 官方安装文档。以下操作假设主机上已正确安装并配置了docker运行环境；</p><blockquote><p>提示：可以使用基于alpine的镜像来减小大小</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 建立配置挂载目录</span>
</span></span><span style=display:flex><span>mkdir -p /data/gitlab-runner/config
</span></span><span style=display:flex><span><span style=color:#75715e># 建立构建目录挂载目录</span>
</span></span><span style=display:flex><span>mkdir -p /data/gitlab-runner/home
</span></span><span style=display:flex><span><span style=color:#75715e># 注意，这里我们使用了基于alpine的镜像来减小大小；使用 --restart 标识来自动重启</span>
</span></span><span style=display:flex><span>docker run -d --name gitlab-runner --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /data/gitlab-runner/config:/etc/gitlab-runner <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /data/gitlab-runner/home:/home/gitlab-runner <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /var/run/docker.sock:/var/run/docker.sock <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  gitlab/gitlab-runner:alpine
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e># 通过以下命令设置docker开机自启</span>
</span></span><span style=display:flex><span>sudo systemctl enable docker
</span></span></code></pre></div><h3 id=docker安装的gitlab-runner常用操作>docker安装的gitlab-runner常用操作<a hidden class=anchor aria-hidden=true href=#docker安装的gitlab-runner常用操作>#</a></h3><h4 id=运行命令>运行命令<a hidden class=anchor aria-hidden=true href=#运行命令>#</a></h4><p>使用已有容器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 容器已经运行的情况下</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 交互式执行，执行以下命令，然后输入命令</span>
</span></span><span style=display:flex><span>docker exec -it gitlab-runner /bin/bash
</span></span><span style=display:flex><span><span style=color:#75715e># 然后执行命令</span>
</span></span><span style=display:flex><span>gitlab-runer --help
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 单次执行</span>
</span></span><span style=display:flex><span>docker exec gitlab-runner gitlab-runner --help
</span></span></code></pre></div><p>使用临时的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -t -i gitlab/gitlab-runner:alpine --help
</span></span><span style=display:flex><span><span style=color:#75715e># -it 使用交互式终端</span>
</span></span><span style=display:flex><span><span style=color:#75715e># --rm 自动删除</span>
</span></span></code></pre></div><h4 id=重启gitlab-runner>重启gitlab-runner<a hidden class=anchor aria-hidden=true href=#重启gitlab-runner>#</a></h4><pre tabindex=0><code>docker restart gitlab-runner
</code></pre><h4 id=升级版本>升级版本<a hidden class=anchor aria-hidden=true href=#升级版本>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 获取最新</span>
</span></span><span style=display:flex><span>docker pull gitlab/gitlab-runner:alpine
</span></span><span style=display:flex><span>docker stop gitlab-runner <span style=color:#f92672>&amp;&amp;</span> docker rm gitlab-runner
</span></span><span style=display:flex><span>docker run -d --name gitlab-runner --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /var/run/docker.sock:/var/run/docker.sock <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /data/gitlab-runner/config:/etc/gitlab-runner <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /data/gitlab-runner/home:/home/gitlab-runner <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  gitlab/gitlab-runner:alpine
</span></span></code></pre></div><h4 id=查看日志>查看日志<a hidden class=anchor aria-hidden=true href=#查看日志>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker logs gitlab-runner
</span></span></code></pre></div><h4 id=配置-gitlab-runner-别名>配置 gitlab-runner 别名<a hidden class=anchor aria-hidden=true href=#配置-gitlab-runner-别名>#</a></h4><p>在 <code>~/.bash_profile</code> 或 <code>~/.bashrc</code> 文件中加入如下函数配置，后续运行 gitlab-runner 命令时即可省去docker exec 命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 添加 gitlab-runner 直接执行到容器</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> gitlab-runner<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    docker exec -it gitlab-runner gitlab-runner $@
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=使用二进制包安装运行gitlab-runner>使用二进制包安装运行gitlab-runner<a hidden class=anchor aria-hidden=true href=#使用二进制包安装运行gitlab-runner>#</a></h3><h4 id=获取安装包安装并运行>获取安装包安装并运行<a hidden class=anchor aria-hidden=true href=#获取安装包安装并运行>#</a></h4><ul><li><p>Centos or RedHat 使用如下命令安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ARCH<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>arch<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -LJO <span style=color:#e6db74>&#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner</span>$ARCH<span style=color:#e6db74>.rpm&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rpm -i gitlab-runner_$ARCH.rpm
</span></span></code></pre></div></li><li><p>Debian or Ubuntu 使用如下命令安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ARCH<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>arch<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -LJO <span style=color:#e6db74>&#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_</span>$ARCH<span style=color:#e6db74>.deb&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dpkg -i gitlab-runner_$ARCH.deb
</span></span></code></pre></div></li><li><p>Windows 安装</p><p>请参考官方文档： <a href=https://docs.gitlab.com/runner/install/windows.html#installation>https://docs.gitlab.com/runner/install/windows.html#installation</a></p></li><li><p>测试是否安装成功，如能成功输出gitlab-runner的用法信息，则表示安装成功</p><pre tabindex=0><code>gitlab-runner --help
</code></pre></li><li><p>测试是否成功启动</p><pre tabindex=0><code>gitlab-runner status
# 如输出 Service is running，则表示成功启动了
</code></pre><blockquote><p>通过docker方式运行的runner在运行 <code>gitlab-runner status</code>时会输出 <code>not running</code>，这对于docker方式运行的runner是正常的，只有直接运行于主机上的runner需要启动对应的服务；</p></blockquote></li></ul><h4 id=安装并更新git版本>安装并更新Git版本<a hidden class=anchor aria-hidden=true href=#安装并更新git版本>#</a></h4><p>Gitlab-CI 任务在 runner 机器上执行，会先通过git获取对应仓库的最新代码，这个获取代码的操作是通过git来完成的，所以我们需要安装git工具；</p><ul><li><p><strong>安装Git</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo yum install -y git
</span></span><span style=display:flex><span> <span style=color:#75715e># 查看版本</span>
</span></span><span style=display:flex><span>git --version
</span></span><span style=display:flex><span><span style=color:#75715e># centos7 上为 1.8.x，无法满足gitlab要求</span>
</span></span></code></pre></div></li><li><p><strong>升级Git版本</strong></p><p>某些linux发型版上git版本过低，在执行流水线时会失败，需要升级git版本，可按如下方式从源码安装最新git版本；</p><ul><li><p>下载git v2.27.0源码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>## 以下下载方式任选其一</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 可选下载方式1 - 从gitee 克隆</span>
</span></span><span style=display:flex><span>git clone -b v2.27.0 https://gitee.com/hanlyjiang/git.git git-2.27.0
</span></span><span style=display:flex><span>cd git-2.27.0 <span style=color:#f92672>&amp;&amp;</span> git checkout -b tag-v2.27.0 v2.27.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 可选下载方式2 - 从github直接下载包</span>
</span></span><span style=display:flex><span>curl -LJO https://github.com/git/git/archive/v2.27.0.tar.gz
</span></span><span style=display:flex><span>tar -xvf git-2.27.0.tar.gz 
</span></span><span style=display:flex><span>cd git-2.27.0
</span></span></code></pre></div></li><li><p>编译安装</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 安装编译依赖库</span>
</span></span><span style=display:flex><span>sudo yum install  -y autoconf gcc openssh zlib-devel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 编译并安装</span>
</span></span><span style=display:flex><span>make configure ;<span style=color:#75715e># as yourself</span>
</span></span><span style=display:flex><span>./configure --prefix<span style=color:#f92672>=</span>/usr ;<span style=color:#75715e># as yourself</span>
</span></span><span style=display:flex><span>make -j8 all ;<span style=color:#75715e># as yourself</span>
</span></span><span style=display:flex><span>sudo make install ;<span style=color:#75715e># as root</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 确认版本：</span>
</span></span><span style=display:flex><span>git --version
</span></span><span style=display:flex><span><span style=color:#75715e># git version 2.27.0</span>
</span></span></code></pre></div></li></ul></li></ul><h4 id=将gitlab-runner用户添加到docker用户组可选>将gitlab-runner用户添加到docker用户组（可选）<a hidden class=anchor aria-hidden=true href=#将gitlab-runner用户添加到docker用户组可选>#</a></h4><p>如需要在该gitlab-runner的CI脚本中运行docker命令，这需要将 gitlab-runner用户添加到docker的用户组，可执行如下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo usermod -a -G docker gitlab-runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 验证权限</span>
</span></span><span style=display:flex><span>sudo -u gitlab-runner -H docker info
</span></span></code></pre></div><h4 id=修改-gitlab-runner-构建目录>修改 gitlab-runner 构建目录<a hidden class=anchor aria-hidden=true href=#修改-gitlab-runner-构建目录>#</a></h4><p>如在执行ci任务时，拉取代码时报build目录权限问题，可尝试按如下方式修改指定runner的构建目录</p><ol><li><p>查找配置文件路径</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gitlab-runner list 
</span></span><span style=display:flex><span><span style=color:#75715e># 其中ConfigFile的值就是对应的配置文件，如：</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ConfigFile=/etc/gitlab-runner/config.toml</span>
</span></span></code></pre></div></li><li><p>修改 <code>builds_dir</code> 指向</p><p>找对该任务对应的<code>[[runner]]</code> 配置段，并在该配置中添加 <code>builds_dir</code> 指向新的具有权限的目录，然后重启启动gitlab-runner即可；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[[<span style=color:#ae81ff>runners]]</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>name = &#34;blockdataapi-engine&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>url = &#34;http://172.17.0.205/&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>token = &#34;Y-6zdV9zzi8xsY1rygbn&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>executor = &#34;shell&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>builds_dir = &#34;/data/gitlab-runner/builds&#34;</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.custom_build_dir]</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.cache]</span>
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>runners.cache.s3]</span>
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>runners.cache.gcs]</span>
</span></span></code></pre></div></li></ol><h2 id=注册-runner-到-gitlab>注册 Runner 到 Gitlab<a hidden class=anchor aria-hidden=true href=#注册-runner-到-gitlab>#</a></h2><p>这里我们将runner注册为群组的Runner，群组runner可以在群组中共享，所有子群组和项目都可以使用该Runner。也可以将Runner注册到指定项目仓库上，操作上只有获取gitlab-runner注册信息时不一样；</p><h3 id=获取gitlab-runner注册信息>获取gitlab-runner注册信息<a hidden class=anchor aria-hidden=true href=#获取gitlab-runner注册信息>#</a></h3><blockquote><p>如需注册到具体项目，在项目的设置在进入对应的CI/CD设置即可，后续操作流程一致；</p></blockquote><p>在群组的设置中打开 CI/CD 设置</p><p><img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180602.png!thumbnail></p><p>展开 Runner 栏位</p><p><img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180606.png!thumbnail></p><p>这里我们选择通过手动设置group runner的方式来注册，可以获取到以下信息：</p><p><img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180610.png!thumbnail></p><h3 id=注册runner>注册runner<a hidden class=anchor aria-hidden=true href=#注册runner>#</a></h3><p>以docker方式运行的gitlab-runner可按如下方式进入交互环境，<strong>直接二进制运行的无需此操作</strong>；</p><p>在gitlab-runner 的机器上执行注册命令，将runner注册到gitlab，为了方便操作，我们使用以下命令进入gitlab-runner容器shell环境：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker exec -it gitlab-runner /bin/bash
</span></span></code></pre></div><p>执行完成后出现如下交互窗口</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bash-4.4#
</span></span></code></pre></div><p>docker方式运行的runner需在此bash中执行命令，主机之间运行的runner直接在shell中执行即可。</p><h3 id=执行register命令进行注册>执行register命令进行注册<a hidden class=anchor aria-hidden=true href=#执行register命令进行注册>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gitlab-runner register 
</span></span><span style=display:flex><span><span style=color:#75715e># url：</span>
</span></span><span style=display:flex><span>http://172.17.0.205/
</span></span><span style=display:flex><span><span style=color:#75715e># token</span>
</span></span><span style=display:flex><span>cEJ611JDeCWSMyu7WXWi
</span></span><span style=display:flex><span><span style=color:#75715e># description - 用于辨识该注册所属的群组或项目，可以设置为方便区分的字符串</span>
</span></span><span style=display:flex><span>sonarqube-runner
</span></span><span style=display:flex><span><span style=color:#75715e># ci-tag - 标签用于后续CI配置中选择此执行器，后期可以通过gitlab界面更改</span>
</span></span><span style=display:flex><span>sonarqube,common-build
</span></span><span style=display:flex><span><span style=color:#75715e># executor - 后续CI任务的执行方式，docker方式运行的请选择docker</span>
</span></span><span style=display:flex><span>docker
</span></span><span style=display:flex><span><span style=color:#75715e># default image - CI配置中未指定镜像时默认使用的镜像</span>
</span></span><span style=display:flex><span>busybox:1.31.1
</span></span></code></pre></div><p>以下为一个注册过程的交互示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>bash-4.4# gitlab-runner register 
</span></span><span style=display:flex><span>Runtime platform                                    arch<span style=color:#f92672>=</span>amd64 os<span style=color:#f92672>=</span>linux pid<span style=color:#f92672>=</span><span style=color:#ae81ff>205</span> revision<span style=color:#f92672>=</span>05161b14 version<span style=color:#f92672>=</span>12.4.1
</span></span><span style=display:flex><span>Running in system-mode.                            
</span></span><span style=display:flex><span>                                                   
</span></span><span style=display:flex><span>Please enter the gitlab-ci coordinator URL <span style=color:#f92672>(</span>e.g. https://gitlab.com/<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>http://172.17.0.205/
</span></span><span style=display:flex><span>Please enter the gitlab-ci token <span style=color:#66d9ef>for</span> this runner:
</span></span><span style=display:flex><span>cEJ611JDeCWSMyu7WXWi
</span></span><span style=display:flex><span>Please enter the gitlab-ci description <span style=color:#66d9ef>for</span> this runner:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>e0311b0ce34b<span style=color:#f92672>]</span>: sonarqube-runner
</span></span><span style=display:flex><span>Please enter the gitlab-ci tags <span style=color:#66d9ef>for</span> this runner <span style=color:#f92672>(</span>comma separated<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>sonarqube,common-build
</span></span><span style=display:flex><span>Registering runner... succeeded                     runner<span style=color:#f92672>=</span>cEJ611JD
</span></span><span style=display:flex><span>Please enter the executor: virtualbox, docker+machine, docker-ssh+machine, custom, docker-ssh, parallels, kubernetes, docker, shell, ssh:
</span></span><span style=display:flex><span>docker
</span></span><span style=display:flex><span>Please enter the default Docker image <span style=color:#f92672>(</span>e.g. ruby:2.6<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>busybox:1.31.1
</span></span><span style=display:flex><span>Runner registered successfully. Feel free to start it, but <span style=color:#66d9ef>if</span> it<span style=color:#960050;background-color:#1e0010>&#39;</span>s running already the config should be automatically reloaded!
</span></span></code></pre></div><h3 id=注册后确认>注册后确认<a hidden class=anchor aria-hidden=true href=#注册后确认>#</a></h3><p>完成后在刚才的页面可以看到；
<img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180615.png></p><h3 id=取消注册>取消注册<a hidden class=anchor aria-hidden=true href=#取消注册>#</a></h3><p>使用 list 命令查看当前注册的token及url</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gitlab-runner list
</span></span><span style=display:flex><span><span style=color:#75715e># 输出类似</span>
</span></span><span style=display:flex><span>Runtime platform                                    arch<span style=color:#f92672>=</span>amd64 os<span style=color:#f92672>=</span>linux pid<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span> revision<span style=color:#f92672>=</span>05161b14 version<span style=color:#f92672>=</span>12.4.1
</span></span><span style=display:flex><span>Listing configured runners                          ConfigFile<span style=color:#f92672>=</span>/etc/gitlab-runner/config.toml
</span></span><span style=display:flex><span>sonarqube-runner                                    Executor<span style=color:#f92672>=</span>docker Token<span style=color:#f92672>=</span>wNwxjEztRpKxYDyK1zVd URL<span style=color:#f92672>=</span>http://172.17.0.205/
</span></span></code></pre></div><p>使用list命令输出的token机url作为参数 使用unregister命令取消注册</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>gitlab-runner unregister -t 7KM7ftthLAYeJdsB3Tbk -u http://172.17.0.205/
</span></span></code></pre></div><h2 id=了解更多>了解更多<a hidden class=anchor aria-hidden=true href=#了解更多>#</a></h2><ul><li><a href=https://docs.gitlab.com/runner/install/docker.html>DOCKER 方式安装gitlab-runner</a></li><li><a href=https://docs.gitlab.com/runner/install/linux-manually.html>Linux安装gitlab-runner-Gitlab官方文档</a></li><li><a href=https://docs.gitlab.com/runner/install/docker.html>使用Docker运行Gitlab-Runner-Gitlab官方文档</a></li><li><a href=https://docs.gitlab.com/runner/register/index.html>注册Runner-Gitlab官方文档</a></li><li><a href=https://gitlab.com/gitlab-org/gitlab-runner/blob/master/dockerfiles/alpine/Dockerfile>Gitlab-Runner alpine Dockerfile</a></li><li><a href=https://docs.gitlab.com/runner/install/windows.html>Windows上注册Runner</a></li><li><a href=http://github.com/help/ci/docker/using_docker_build.md>如何在docker执行器中构建Docker镜像？</a></li></ul><h1 id=gitlab相关-gitlabcicd自动化>Gitlab相关-GitlabCI&amp;CD自动化<a hidden class=anchor aria-hidden=true href=#gitlab相关-gitlabcicd自动化>#</a></h1><p><strong>可先阅读文档：</strong></p><ul><li>Gitlab&amp;Mattermost&amp;Sonarqube介绍-无批注.pdf（本地文件）</li><li><a href=http://172.17.0.205/Public-Share/gitlab-usage>Gitlab协作工具使用指引</a></li></ul><p><strong>关键点总结：</strong></p><ul><li><p>主要概念：Gitlab，gitlab-ci.yml，runner，流水线，job</p><ul><li>Gitlab 提供代码托管，提供ci/cd能力</li><li>Gitlab-CI从 项目源码中的gitlab-ci.yml文件中读取CI流程，然后执行，我们在此文件中定义流水线及任务</li><li>Runner是一个具体的机器，用于执行任务</li></ul></li><li><p>Runner执行器：</p><ul><li>shell：执行与机器相关的任务，需要使用主机命令的，如docker打包，部署</li><li>docker： 使用容器执行通用的构建任务</li><li>注册流程参考：<a href=https://shimo.im/docs/PVAPV289P6tmFVql/>《2019/11/19-GitlabRunner配置-共享》</a></li></ul></li><li><p>Gitlab-ci配置参考： http://172.17.0.205/help/ci/yaml/README.md</p></li><li><p>Gitlab-ci重要配置 - <strong>job</strong></p><ul><li>定义要执行的任务，使用script定义具体要执行的命令</li></ul></li><li><p>Gitlab-ci重要概念 - 阶段 - 定义执行顺序</p><ul><li>顶层的stage定义流水线的阶段，job下的stage确定该job的归属，按顶层的stage定义的顺序执行job</li></ul></li><li><p>Gitlab-ci重要概念 - <strong>变量</strong> - 用于参数化构建流程</p><ul><li>预定义变量：http://172.17.0.205/help/ci/variables/predefined_variables.md</li><li>Gitlab Web界面配置变量，支持在群组及项目级别分别配置，项目级别的优先级较高</li><li>gitlab-ci.yml 中配置变量，yml中配置的变量会被web界面中配置的覆盖</li></ul></li><li><p>Gitlab-ci重要配置 - 归档</p><ul><li>用于将成果归档，可供下载</li><li>用于将成果在不同的阶段的job中传递（Gitlab自动完成）</li><li>使用时指定要归档的文件相对于CI_PROJECT_DIR的路径即可</li><li><strong>特别注意</strong>要限制归档可以存储的时间，避免无用的归档文件占据gitlab磁盘空间</li></ul></li><li><p>Gitlab-ci重要配置 - 规则（only，except，rule）</p><ul><li><p><strong>only/expect</strong></p></li><li><ul><li><p>提交相关：</p></li><li><ul><li>branches - 所有分支</li><li>tags - 所有标签</li><li>pushes - 推送</li><li>merge_requests - 提起合并请求</li><li>external_pull_requests - 外部合并请求（基本用不到）</li></ul></li></ul></li><li><ul><li><p>其他：</p></li><li><ul><li>api - 调用gitlab api触发</li><li>external - 未了解</li><li>pipelines - 未了解</li><li><strong>schedules</strong> ： 定时器（gitlabCI/CD设置页面设置）</li><li>triggers：- 未了解</li><li><strong>web</strong>： 界面手动触发</li><li>chat - 用不到</li></ul></li></ul></li><li><p>rules</p><ul><li>参考使用规则定义 http://172.17.0.205/help/ci/yaml/README.md#rules</li><li>参考示例 <a href=http://172.17.0.205/geosocial-pc/auto-build-deploy/front-auto-deploy/-/blob/master/.gitlab-ci.yml>GeoSocial自动部署</a></li></ul></li></ul></li></ul><p><strong>CI/CD配置示例</strong></p><ul><li><a href=http://172.17.0.205/Development/Mobile/geopanel/h5-sdk-api-document/-/blob/master/.gitlab-ci.yml>VuePress Web项目CI自动构建及部署</a></li><li>Android<ul><li><a href=http://172.17.0.205/Development/Mobile/support/cgt-sgt/hongshan-sgt/-/blob/master/.gitlab-ci.yml>Android项目CI自动打包-洪山管理通</a></li><li><a href=http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/.gitlab-ci.yml>Android项目自动打包-移动中心APP</a></li></ul></li><li>springboot:<ul><li><a href=http://172.17.0.205/Development/Mobile/georobox_3_0/georobox-mobile-server/-/blob/master/.gitlab-ci.yml>springboot gradle自动打包-GeoRobox3.0-后台</a></li><li><a href=http://172.17.0.205/Public-Share/gitlab-ci-examples/springboot-gradle/-/blob/gitlab-ci/.gitlab-ci.yml>springboot-gradle打包示例-自动打包-多环境部署</a></li></ul></li><li>sonar代码检查：<ul><li><a href=http://172.17.0.205/Public-Share/gitlab-usage/-/wikis/%E4%BD%BF%E7%94%A8Gitlab/%E4%BD%BF%E7%94%A8gitlab-ci%E8%BF%9B%E8%A1%8Csonar%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5#331-%E9%80%9A%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E9%99%A4msbuild%E4%B9%8B%E5%A4%96%E7%9A%84%E9%A1%B9%E7%9B%AE>使用帮助-Sonar检查通用模板配置</a></li><li><a href=http://172.17.0.205/Public-Share/gitlab-ci-examples/donet-sonar-scanner-sample-project/-/blob/master/.gitlab-ci.yml>C#代码检查示例项目</a></li><li><a href=http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/.gitlab-ci.yml>移动中心Android代码检查</a></li></ul></li></ul><h1 id=gitlab相关-使用提示>Gitlab相关-使用提示<a hidden class=anchor aria-hidden=true href=#gitlab相关-使用提示>#</a></h1><h2 id=ci脚本中变量含有特殊字符时的处理>CI脚本中变量含有特殊字符时的处理<a hidden class=anchor aria-hidden=true href=#ci脚本中变量含有特殊字符时的处理>#</a></h2><p>对于变量中有<code>$</code>的，可以使用两个 <code>$</code> 来进行转义，如：</p><pre tabindex=0><code>robot$$gitlab
</code></pre><h2 id=如何检查ci配置>如何检查CI配置？<a hidden class=anchor aria-hidden=true href=#如何检查ci配置>#</a></h2><blockquote><p>注意： CI规则的检查是和项目相关的，只能在对应的项目中进行检查</p></blockquote><p>检查CI配置是否合规，可在项目的CI/CD界面，点击<code>CI配置检查（CI lint）</code>，然后粘贴自己的配置到输入框中执行检查</p><h2 id=docker-runner的构建加速配置数据卷>Docker Runner的构建加速（配置数据卷）<a hidden class=anchor aria-hidden=true href=#docker-runner的构建加速配置数据卷>#</a></h2><p>Docker的Runner非常适合用于作为通用的构建机器，以执行各种不同类型的语言及不同打包工具的编译任务，比方说gradle,maven，npm等等。</p><p>一般来说，我们的项目都会使用很多第三方的依赖，而且这些依赖只是在构建需要时从网络上获取，然后构建工具会将这些包缓存在某个目录中，如：</p><ul><li>gradle 一般放置在 <code>~/.gradle</code> 目录中，同时也会存储 gradle 的各种版本；</li><li>mvn 一般放置于 <code>~/.m2</code> 目录中；</li></ul><p>使用容器构建时，这些缓存目录都位于容器内部，也就是每次都需要重新下载，非常浪费时间。所以我们需要能让这些目录可以自动挂载到执行的容器中，gitlab-runner提供了这种能力，具体配置方式参考如下：</p><ol><li><p>找到gitlab-runner的配置文件，可通过如下命令查找，查看其中的ConfigFile指向的目录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ sudo /usr/bin/gitlab-runner list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Runtime platform                                    arch<span style=color:#f92672>=</span>amd64 os<span style=color:#f92672>=</span>linux pid<span style=color:#f92672>=</span><span style=color:#ae81ff>15738</span> revision<span style=color:#f92672>=</span>05161b14 version<span style=color:#f92672>=</span>12.4.1
</span></span><span style=display:flex><span>Listing configured runners                          ConfigFile<span style=color:#f92672>=</span>/etc/gitlab-runner/config.toml
</span></span><span style=display:flex><span>blockdataapi-engine                                 Executor<span style=color:#f92672>=</span>shell Token<span style=color:#f92672>=</span>Y-6zdV9zzi8xsY1rygbn URL<span style=color:#f92672>=</span>http://172.17.0.205/
</span></span><span style=display:flex><span>产品开发部                                               Executor<span style=color:#f92672>=</span>shell Token<span style=color:#f92672>=</span>vdxuftxm6EL_fVgAS7Td URL<span style=color:#f92672>=</span>http://172.17.0.205/
</span></span><span style=display:flex><span>移动中心-部署                                             Executor<span style=color:#f92672>=</span>shell Token<span style=color:#f92672>=</span>zx2vFV3x4S19n5mJDjD_ URL<span style=color:#f92672>=</span>http://172.17.0.205/
</span></span><span style=display:flex><span>localhost                                           Executor<span style=color:#f92672>=</span>shell Token<span style=color:#f92672>=</span>3xHHCWiysKqf4kWdnA_e URL<span style=color:#f92672>=</span>http://172.17.0.205/
</span></span></code></pre></div><blockquote><p>注意：如果是通过gitlab运行的gitlab-runner，则在挂载的config目录</p></blockquote></li><li><p>找到对应的Runner配置段，可通过name进行区分</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[[<span style=color:#ae81ff>runners]]</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>name = &#34;sonarqube-runner&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>url = &#34;http://172.17.0.205/&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>token = &#34;wNwxjEztRpKxYDyK1zVd&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>executor = &#34;docker&#34;</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.custom_build_dir]</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.docker]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>tls_verify = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>image = &#34;busybox:1.31.1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>privileged = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>disable_entrypoint_overwrite = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>oom_kill_disable = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>disable_cache = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>shm_size = 0</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.cache]</span>
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>runners.cache.s3]</span>
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>runners.cache.gcs]</span>
</span></span></code></pre></div></li><li><p>在 <code>[runners.docker]</code> 配置中添加<code>volumes</code>配置，示例如下，写法于通过docker挂载命名卷一致</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>[[<span style=color:#ae81ff>runners]]</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>name = &#34;sonarqube-runner&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>url = &#34;http://172.17.0.205/&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>token = &#34;wNwxjEztRpKxYDyK1zVd&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>executor = &#34;docker&#34;</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.custom_build_dir]</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.docker]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>tls_verify = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>image = &#34;busybox:1.31.1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>privileged = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>disable_entrypoint_overwrite = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>oom_kill_disable = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>disable_cache = false</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>volumes = [&#34;/cache&#34;, &#34;maven:/root/.m2&#34;, &#34;gradle_gradle:/home/gradle/.gradle&#34;, &#34;nginx_static:/work/html&#34;, &#34;android_build_tools:/android-sdk/build-tools&#34;, &#34;android_platforms:/android-sdk/platforms&#34;, &#34;android_extras:/android-sdk/extras&#34;]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>shm_size = 0</span>
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>runners.cache]</span>
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>runners.cache.s3]</span>
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>runners.cache.gcs]</span>
</span></span></code></pre></div><blockquote><p>提示：修改后直接保存，无需重新启动gitlab-runner，下次对应的任务跑到这个runner上时，即会自动生效</p></blockquote><blockquote><p>这里解释下几个卷的配置：</p><ul><li><code>"maven:/root/.m2"</code>: 一般的maven的镜像的缓存配置目录在<code>/root/.m2</code></li><li><code>"gradle_gradle:/home/gradle/.gradle"</code>: 一般的gradle镜像的缓存目录 <code>/home/gradle/.gradle</code></li><li><code>"nginx_static:/work/html"</code>: 为我们通过docker启动的一个nginx服务，启动时挂载了 nginx_static 到/work/html，在ci任务中，我们可在容器中将web资源拷贝到执行任务的容器内部的/work/html目录即可将web资源发布到该runner上启动的nginx服务中</li><li>另外两个都是自行构建的android构建镜像的缓存目录。</li></ul></blockquote></li></ol><h2 id=使用cache-缓存加速构建>使用cache-缓存加速构建<a hidden class=anchor aria-hidden=true href=#使用cache-缓存加速构建>#</a></h2><p>可使用gitlab的cache关键字缓存构建的依赖下载文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>cache</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;$CI_COMMIT_REF_SLUG&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>node_modules/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>node:11-alpine</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># - npm install --registry=https://registry.npm.taobao.org</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install </span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm run build:prod</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifacts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>expire_in</span>: <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>hours</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;$CI_PROJECT_NAME--$CI_COMMIT_REF_NAME--$CI_COMMIT_SHORT_SHA--$CI_JOB_NAME--$CI_JOB_ID&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>dist/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>common-build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>branches</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>web</span>
</span></span></code></pre></div><p>之后在任务开始时，会加载缓存：</p><p><img alt=image-20210401153959401 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210406143904.png></p><p>在任务完成后，会保存缓存：</p><p><img alt=image-20210401154038947 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401154039.png></p><p>配置前后的构建时间差距如下：（第一次需要3分钟，第二次只需要1分钟）</p><p><img alt=image-20210401154401344 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401154404.png></p><blockquote><p>参考：</p><ul><li><a href=https://docs.gitlab.com/ee/ci/caching/index.html>Cache dependencies in GitLab CI/CD</a></li><li><a href=https://docs.gitlab.com/ee/ci/yaml/README.html#cache>gitlab-ci.yaml - cache</a></li></ul></blockquote><h1 id=gitlab相关-升级记录12100-1306>Gitlab相关-升级记录（12.10.0-13.0.6）<a hidden class=anchor aria-hidden=true href=#gitlab相关-升级记录12100-1306>#</a></h1><p>考虑到后续可能需要对gitlab进行升级，这里将之前的一次升级记录贴出，供后续升级作为参考。</p><blockquote><p>升级需要选择无人使用的时段，并提前通知。</p></blockquote><h2 id=升级准备工作>升级准备工作<a hidden class=anchor aria-hidden=true href=#升级准备工作>#</a></h2><h3 id=确定升级路线><strong>确定升级路线</strong><a hidden class=anchor aria-hidden=true href=#确定升级路线>#</a></h3><ul><li>现有版本：12.10.0</li><li>当下目标版本：13.0.6</li><li>结合 <a href=https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations>Gitlab升级路线建议</a> 确定如下升级路线：<ul><li>12.10.0 -> 13.0.0 -> 13.0.6</li><li>由于我们跨大版本升级了（12-13），所以引入了 13.0.0 的中间升级路径</li></ul></li></ul><h3 id=获取最新版本信息><strong>获取最新版本信息</strong><a hidden class=anchor aria-hidden=true href=#获取最新版本信息>#</a></h3><ul><li>查看 gitlab release页面 信息</li><li>查看 gitlab docker hub 获取gitlab-ce docker镜像版本TAG：</li><li>13.0.0: <code>gitlab/gitlab-ce:13.0.0-ce.0</code></li><li>13.0.6: <code>gitlab/gitlab-ce:13.0.6-ce.0</code></li><li>查看升级注意事项</li><li>升级流程： <a href=https://docs.gitlab.com/omnibus/docker/README.html#update>https://docs.gitlab.com/omnibus/docker/README.html#update</a></li><li>版本升级建议路线：https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations</li></ul><h2 id=备份>备份<a hidden class=anchor aria-hidden=true href=#备份>#</a></h2><p>备份有两种方式，备份的数据量不相同：</p><ul><li>对docker挂载的gitlab数据目录整体备份</li><li>使用 gitlab的 <code>gitlab-backup create</code> 命令创建备份，可包含所有git仓库，包括wiki及权限信息。</li></ul><blockquote><p>建议对挂载的gitlab数据目录进行一次整体备份，目前暂不清楚gitlab-backup create命令创建的备份是否包含ci相关内容。</p></blockquote><p>以下对gitalb-backup 命令执行备份进行简要介绍。数据目录的备份方式直接对目录进行操作即可。</p><p>进入到gitlab部署机器，执行如下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker exec -t &lt;container name&gt; gitlab-backup create
</span></span><span style=display:flex><span><span style=color:#75715e># 如果docker容器的名称是gitlab，则可以执行如下命令，备份完成后位于gitlab的数据目录，如：/data/gitlab/data/backups/</span>
</span></span><span style=display:flex><span>docker exec -t <span style=color:#66d9ef>$(</span>docker ps | grep gitlab | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span> gitlab-backup create
</span></span><span style=display:flex><span><span style=color:#75715e># 备份配置目录</span>
</span></span><span style=display:flex><span>sudo tar -cvf /data/gitlab/data/backups/1592710400_2020_06_21_12.10.0_gitlab_config_backup.tar /data/gitlab/config 
</span></span></code></pre></div><h2 id=执行升级>执行升级：<a hidden class=anchor aria-hidden=true href=#执行升级>#</a></h2><ul><li>进入到gitlab部署机器</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh -p <span style=color:#ae81ff>10022</span> geostar@172.17.0.205
</span></span></code></pre></div><ul><li>获取Gitlab中间版本镜像及最终版本镜像</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker pull gitlab/gitlab-ce:13.0.0-ce.0
</span></span><span style=display:flex><span>docker pull gitlab/gitlab-ce:13.0.6-ce.0
</span></span></code></pre></div><ul><li>停止并移除现有服务</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo docker stop gitlab 
</span></span><span style=display:flex><span>sudo docker rm gitlab 
</span></span></code></pre></div><ul><li>进行升级，使用 13.0.0 的镜像运行gitlab，gitlab会自动处理数据升级流程</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>    sudo docker run --detach <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --hostname 172.17.0.205 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --publish 443:443 --publish 80:80 --publish 22:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume /data/gitlab/config:/etc/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume /data/gitlab/logs:/var/log/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume /data/gitlab/data:/var/opt/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        gitlab/gitlab-ce:13.0.0-ce.0
</span></span></code></pre></div><ul><li>待 13.0.0 升级完毕之后，升级到 13.0.6，使用 13.0.6 的镜像运行gitlab</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>      sudo docker stop gitlab 
</span></span><span style=display:flex><span>      sudo docker rm gitlab 
</span></span><span style=display:flex><span>      sudo docker run --detach <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --hostname 172.17.0.205 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --publish 443:443 --publish 80:80 --publish 22:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume /data/gitlab/config:/etc/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume /data/gitlab/logs:/var/log/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --volume /data/gitlab/data:/var/opt/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        gitlab/gitlab-ce:13.0.6-ce.0
</span></span></code></pre></div><h2 id=确认升级成功>确认升级成功<a hidden class=anchor aria-hidden=true href=#确认升级成功>#</a></h2><p>登录管理员账号，进入管理中心-仪表盘，查看gitlab版本：</p><p><img alt=image-20210302165417697 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302165417.png></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://hanlyjiang.github.io/tags/%E5%B7%A5%E4%BD%9C/>工作</a></li></ul><nav class=paginav><a class=prev href=https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/><span class=title>« Prev</span><br><span>Android bindService流程</span>
</a><a class=next href=https://hanlyjiang.github.io/posts/%E7%A7%BB%E5%8A%A8%E4%B8%AD%E5%BF%83%E4%BA%A4%E6%8E%A5/><span class=title>Next »</span><br><span>移动中心交接</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hanlyjiang.github.io/>清水池塘</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>