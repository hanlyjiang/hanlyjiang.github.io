<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Docker构建Arm架构镜像-通用步骤 | 清水池塘</title><meta name=keywords content="Docker"><meta name=description content="介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。
前言
现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。
测试机信息

  
      
          CPU
          FT-1500A 4核 arm64
      
  
  
      
          内存
          8G
      
      
          OS
          麒麟V10
      
      
          包管理器
          apt
      
  

ARM机器上安装Docker

Docker官方文档

Docker支持如下系统及架构

国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。
查看系统信息
geostar@geostar-ft1500a:~$ cat /proc/version
Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源
添加软件源

参考：
https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/
https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/

添加清华镜像软件源（arm架构）
# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
更新："><meta name=author content="野生莲藕"><link rel=canonical href=https://hanlyjiang.github.io/posts/docker-arm%E6%9E%B6%E6%9E%84%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E9%80%9A%E7%94%A8%E6%AD%A5%E9%AA%A4/><link crossorigin=anonymous href=/assets/css/stylesheet.e3ad983e2ed74d47928d2fcfb404b2d2a87f0ad3e1c106708add8cededbe9a25.css integrity="sha256-462YPi7XTUeSjS/PtASy0qh/CtPhwQZwit2M7e2+miU=" rel="preload stylesheet" as=style><link rel=icon href=https://hanlyjiang.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hanlyjiang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanlyjiang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hanlyjiang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hanlyjiang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hanlyjiang.github.io/posts/docker-arm%E6%9E%B6%E6%9E%84%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E9%80%9A%E7%94%A8%E6%AD%A5%E9%AA%A4/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://hanlyjiang.github.io/posts/docker-arm%E6%9E%B6%E6%9E%84%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E9%80%9A%E7%94%A8%E6%AD%A5%E9%AA%A4/"><meta property="og:site_name" content="清水池塘"><meta property="og:title" content="Docker构建Arm架构镜像-通用步骤"><meta property="og:description" content="介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。
前言 现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。
测试机信息 CPU FT-1500A 4核 arm64 内存 8G OS 麒麟V10 包管理器 apt ARM机器上安装Docker Docker官方文档
Docker支持如下系统及架构
国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。
查看系统信息 geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源
添加软件源 参考： https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/
添加清华镜像软件源（arm架构）
# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释 deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse 更新："><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-08-19T17:20:59+00:00"><meta property="article:modified_time" content="2020-08-19T17:20:59+00:00"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker构建Arm架构镜像-通用步骤"><meta name=twitter:description content="介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。
前言
现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。
测试机信息

  
      
          CPU
          FT-1500A 4核 arm64
      
  
  
      
          内存
          8G
      
      
          OS
          麒麟V10
      
      
          包管理器
          apt
      
  

ARM机器上安装Docker

Docker官方文档

Docker支持如下系统及架构

国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。
查看系统信息
geostar@geostar-ft1500a:~$ cat /proc/version
Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源
添加软件源

参考：
https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/
https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/

添加清华镜像软件源（arm架构）
# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
更新："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hanlyjiang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Docker构建Arm架构镜像-通用步骤","item":"https://hanlyjiang.github.io/posts/docker-arm%E6%9E%B6%E6%9E%84%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E9%80%9A%E7%94%A8%E6%AD%A5%E9%AA%A4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Docker构建Arm架构镜像-通用步骤","name":"Docker构建Arm架构镜像-通用步骤","description":"介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。\n前言 现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。\n测试机信息 CPU FT-1500A 4核 arm64 内存 8G OS 麒麟V10 包管理器 apt ARM机器上安装Docker Docker官方文档\nDocker支持如下系统及架构\n国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。\n查看系统信息 geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源\n添加软件源 参考： https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/\n添加清华镜像软件源（arm架构）\n# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释 deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse 更新：\n","keywords":["Docker"],"articleBody":"介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。\n前言 现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。\n测试机信息 CPU FT-1500A 4核 arm64 内存 8G OS 麒麟V10 包管理器 apt ARM机器上安装Docker Docker官方文档\nDocker支持如下系统及架构\n国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按官方文档- Install Docker Engine on Ubuntu进行安装。\n查看系统信息 geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源\n添加软件源 参考： https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/\n添加清华镜像软件源（arm架构）\n# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释 deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse 更新：\nsudo apt-get install apt-transport-https sudo apt-get clean sudo apt-get update 安装Docker # 卸载旧版本docker sudo apt-get remove docker docker-engine docker.io containerd runc sudo apt-get update sudo apt-get install \\ apt-transport-https \\ ca-certificates \\ curl \\ gnupg-agent \\ software-properties-common curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A E2D8 8D81 803C 0EBF CD88) sudo apt-key fingerprint 0EBFCD88 编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存\n# https://docs.docker.com/engine/install/ubuntu/ deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable 安装 docker\nsudo apt-get update # 安装Docker sudo apt-get install docker-ce docker-ce-cli containerd.io # 安装成功，查看版本 docker --version Docker version 19.03.12, build 48a6621 在Dockerhub上查找已有的arm镜像 实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以postgres为例，在dockerhub上可以看到\n在具体的tag中也可以看到版本的镜像是否支持arm架构\n但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。\nARM版本镜像构建（非ARM机器上执行） 参考： -https://github.com/docker/cli/blob/master/experimental/README.md -跨平台构建 Docker 镜像新姿势，x86、arm 一把梭\n构建ARM镜像的两种方式 对于构建镜像的ARM版本，有如下两种方式：\n在ARM机器上使用 docker build 进行构建； 在X86/AMD64 的机器上使用 docker buildx 进行交叉构建； 实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；\n关于第二种构建方式，可先阅读跨平台构建 Docker 镜像新姿势，x86、arm 一把梭进行了解，以下简要介绍使用buildx交叉构建的方式；\n⚠️注意：\n交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；\n实际测试发现，使用qemu方式在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；\n上面第二点按如下方式测试：\ndocker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch 可正常输出； docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version 则会卡住，且需要使用docker stop停止容器才可以退出容器； 启用试验性功能 参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features 注意：buildx 仅支持 docker19.03 及以上docker版本\n如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：\n编辑 /etc/docker/daemon.json 添加： { \"experimental\": true } 编辑 ～/.docker/config.json 添加： \"experimental\" : \"enabled\" 重启Docker使生效： sudo systemctl daemon-reload sudo systemctl restart docker 确认是否开启： docker version -f’{{.Server.Experimental}}' 如果输出true，则表示开启成功 使用buildx构建 buildx 的详细使用可参考：Docker官方文档-Reference-buildx 创建 buildx 构建器 使用 docker buildx ls 命令查看现有的构建器\ndocker buildx ls 创建并构建器：\n# 下面的创建命令任选一条符合情况的即可 # 1. 不指定任何参数创建 docker buildx create --use --name multiarch-builder # 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令 docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder # 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder buildx-config.toml 配置文件写法类似：\n# https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md # registry configures a new Docker register used for cache import or output. [registry.\"zh-registry.geostar.com.cn\"] mirrors = [\"zh-registry.geostar.com.cn\"] http = true insecure = true 启用构建器\n# 初始化并激活 docker buildx inspect multiarch-builder --bootstrap 确认成功\n# 使用 docker buildx ls 查看 docker buildx ls 修改Dockerfile 对 Dockerfile 的修改，大致需要进行如下操作：\n确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译； 确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件 ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz\n此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：\nADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz\n当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；\n提示：\n怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 file {可执行文件路径} 来查看，\n如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-x86_64\u0026arm64e：\nfile $(which git) /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e] /usr/bin/git (for architecture x86_64):\tMach-O 64-bit executable x86_64 /usr/bin/git (for architecture arm64e):\tMach-O 64-bit executable arm64e 下面的命令则对一个so文件执行了file，可以看到其中的架构信息 ARM aarch64：\nfile /lib/aarch64-linux-gnu/libpthread-2.23.so /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped docker buildx 构建arm64镜像的命令 使用 –platform来指定架构，使用 --push 或 --load 来指定构建完毕后的动作。\ndocker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push 提示：当指定多个架构时，只能使用 –push 推送到远程仓库，无法 –load，推送成功后再通过 docker pull –platform 来拉取指定架构的镜像\n检查构建成果 通过 docker buildx imagetools inspect 命令查看镜像信息，看是否有对应的arm架构信息； 实际运行镜像，确认运行正常；（在arm机器上执行） 提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。\n在x86上运行arm镜像 可参考 github/qemu-user-static ,简要描述如下：\n执行如下命令安装：\ndocker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n之后即可运行arm版本的镜像，如：\ndocker run --rm -t arm64v8/fedora uname -m ","wordCount":"530","inLanguage":"en","datePublished":"2020-08-19T17:20:59Z","dateModified":"2020-08-19T17:20:59Z","author":{"@type":"Person","name":"野生莲藕"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanlyjiang.github.io/posts/docker-arm%E6%9E%B6%E6%9E%84%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E9%80%9A%E7%94%A8%E6%AD%A5%E9%AA%A4/"},"publisher":{"@type":"Organization","name":"清水池塘","logo":{"@type":"ImageObject","url":"https://hanlyjiang.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hanlyjiang.github.io/ accesskey=h title="清水池塘 (Alt + H)">清水池塘</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hanlyjiang.github.io/ title=首页><span>首页</span></a></li><li><a href=https://hanlyjiang.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://hanlyjiang.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://hanlyjiang.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hanlyjiang.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://hanlyjiang.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Docker构建Arm架构镜像-通用步骤</h1><div class=post-meta><span title='2020-08-19 17:20:59 +0000 UTC'>August 19, 2020</span>&nbsp;·&nbsp;<span>3 min</span>&nbsp;·&nbsp;<span>530 words</span>&nbsp;·&nbsp;<span>野生莲藕</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e6%b5%8b%e8%af%95%e6%9c%ba%e4%bf%a1%e6%81%af aria-label=测试机信息>测试机信息</a></li><li><a href=#arm%e6%9c%ba%e5%99%a8%e4%b8%8a%e5%ae%89%e8%a3%85docker aria-label=ARM机器上安装Docker>ARM机器上安装Docker</a><ul><li><a href=#%e6%9f%a5%e7%9c%8b%e7%b3%bb%e7%bb%9f%e4%bf%a1%e6%81%af aria-label=查看系统信息>查看系统信息</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e8%bd%af%e4%bb%b6%e6%ba%90 aria-label=添加软件源>添加软件源</a></li><li><a href=#%e5%ae%89%e8%a3%85docker aria-label=安装Docker>安装Docker</a></li></ul></li><li><a href=#%e5%9c%a8dockerhub%e4%b8%8a%e6%9f%a5%e6%89%be%e5%b7%b2%e6%9c%89%e7%9a%84arm%e9%95%9c%e5%83%8f aria-label=在Dockerhub上查找已有的arm镜像>在Dockerhub上查找已有的arm镜像</a></li><li><a href=#arm%e7%89%88%e6%9c%ac%e9%95%9c%e5%83%8f%e6%9e%84%e5%bb%ba%e9%9d%9earm%e6%9c%ba%e5%99%a8%e4%b8%8a%e6%89%a7%e8%a1%8c aria-label=ARM版本镜像构建（非ARM机器上执行）>ARM版本镜像构建（非ARM机器上执行）</a><ul><li><a href=#%e6%9e%84%e5%bb%baarm%e9%95%9c%e5%83%8f%e7%9a%84%e4%b8%a4%e7%a7%8d%e6%96%b9%e5%bc%8f aria-label=构建ARM镜像的两种方式>构建ARM镜像的两种方式</a></li><li><a href=#%e5%90%af%e7%94%a8%e8%af%95%e9%aa%8c%e6%80%a7%e5%8a%9f%e8%83%bd aria-label=启用试验性功能>启用试验性功能</a></li><li><a href=#%e4%bd%bf%e7%94%a8buildx%e6%9e%84%e5%bb%ba aria-label=使用buildx构建>使用buildx构建</a><ul><li><a href=#%e5%88%9b%e5%bb%ba-buildx-%e6%9e%84%e5%bb%ba%e5%99%a8 aria-label="创建 buildx 构建器">创建 buildx 构建器</a></li></ul></li><li><a href=#%e4%bf%ae%e6%94%b9dockerfile aria-label=修改Dockerfile>修改Dockerfile</a></li><li><a href=#docker-buildx-%e6%9e%84%e5%bb%baarm64%e9%95%9c%e5%83%8f%e7%9a%84%e5%91%bd%e4%bb%a4 aria-label="docker buildx 构建arm64镜像的命令">docker buildx 构建arm64镜像的命令</a></li><li><a href=#%e6%a3%80%e6%9f%a5%e6%9e%84%e5%bb%ba%e6%88%90%e6%9e%9c aria-label=检查构建成果>检查构建成果</a></li></ul></li><li><a href=#%e5%9c%a8x86%e4%b8%8a%e8%bf%90%e8%a1%8carm%e9%95%9c%e5%83%8f aria-label=在x86上运行arm镜像>在x86上运行arm镜像</a></li></ul></div></details></div><div class=post-content><p>介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。</p><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。</p><h2 id=测试机信息>测试机信息<a hidden class=anchor aria-hidden=true href=#测试机信息>#</a></h2><table><thead><tr><th style=text-align:left>CPU</th><th style=text-align:left>FT-1500A 4核 arm64</th></tr></thead><tbody><tr><td style=text-align:left>内存</td><td style=text-align:left>8G</td></tr><tr><td style=text-align:left>OS</td><td style=text-align:left>麒麟V10</td></tr><tr><td style=text-align:left>包管理器</td><td style=text-align:left>apt</td></tr></tbody></table><h2 id=arm机器上安装docker>ARM机器上安装Docker<a hidden class=anchor aria-hidden=true href=#arm机器上安装docker>#</a></h2><blockquote><p><a href="https://docs.docker.com/engine/install/?fileGuid=0l3NVKX0BgflYN3R">Docker官方文档</a></p></blockquote><p>Docker支持如下系统及架构</p><p><img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172838.png!thumbnail></p><p>国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按<a href="https://docs.docker.com/engine/install/ubuntu/?fileGuid=0l3NVKX0BgflYN3R">官方文档- Install Docker Engine on Ubuntu</a>进行安装。</p><h3 id=查看系统信息>查看系统信息<a hidden class=anchor aria-hidden=true href=#查看系统信息>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>geostar@geostar-ft1500a:~$ cat /proc/version
</span></span><span style=display:flex><span>Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020
</span></span></code></pre></div><p>这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源</p><h3 id=添加软件源>添加软件源<a hidden class=anchor aria-hidden=true href=#添加软件源>#</a></h3><blockquote><p>参考：
<a href=https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/>https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/</a>
<a href=https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/>https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/</a></p></blockquote><p>添加清华镜像软件源（arm架构）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
</span></span></code></pre></div><p>更新：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>sudo apt-get install apt-transport-https
</span></span><span style=display:flex><span>sudo apt-get clean
</span></span><span style=display:flex><span>sudo apt-get update
</span></span></code></pre></div><h3 id=安装docker>安装Docker<a hidden class=anchor aria-hidden=true href=#安装docker>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># 卸载旧版本docker
</span></span><span style=display:flex><span>sudo apt-get remove docker docker-engine docker.io containerd runc
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install \
</span></span><span style=display:flex><span>    apt-transport-https \
</span></span><span style=display:flex><span>    ca-certificates \
</span></span><span style=display:flex><span>    curl \
</span></span><span style=display:flex><span>    gnupg-agent \
</span></span><span style=display:flex><span>    software-properties-common
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
</span></span><span style=display:flex><span># 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88)
</span></span><span style=display:flex><span>sudo apt-key fingerprint 0EBFCD88
</span></span></code></pre></div><p>编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># https://docs.docker.com/engine/install/ubuntu/
</span></span><span style=display:flex><span>deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable
</span></span></code></pre></div><p>安装 docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span># 安装Docker
</span></span><span style=display:flex><span>sudo apt-get install docker-ce docker-ce-cli containerd.io
</span></span><span style=display:flex><span># 安装成功，查看版本
</span></span><span style=display:flex><span>docker --version
</span></span><span style=display:flex><span>Docker version 19.03.12, build 48a6621
</span></span></code></pre></div><h2 id=在dockerhub上查找已有的arm镜像>在Dockerhub上查找已有的arm镜像<a hidden class=anchor aria-hidden=true href=#在dockerhub上查找已有的arm镜像>#</a></h2><p>实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以<a href="https://hub.docker.com/_/postgres?fileGuid=0l3NVKX0BgflYN3R">postgres</a>为例，在dockerhub上可以看到</p><p><img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172847.png!thumbnail></p><p>在具体的tag中也可以看到版本的镜像是否支持arm架构</p><p><img alt=图片 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172851.png!thumbnail></p><p>但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。</p><h2 id=arm版本镜像构建非arm机器上执行>ARM版本镜像构建（非ARM机器上执行）<a hidden class=anchor aria-hidden=true href=#arm版本镜像构建非arm机器上执行>#</a></h2><blockquote><p>参考：
-<a href="https://github.com/docker/cli/blob/master/experimental/README.md?fileGuid=0l3NVKX0BgflYN3R">https://github.com/docker/cli/blob/master/experimental/README.md</a>
-<a href="https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R">跨平台构建 Docker 镜像新姿势，x86、arm 一把梭</a></p></blockquote><h3 id=构建arm镜像的两种方式>构建ARM镜像的两种方式<a hidden class=anchor aria-hidden=true href=#构建arm镜像的两种方式>#</a></h3><p>对于构建镜像的ARM版本，有如下两种方式：</p><ol><li>在ARM机器上使用 docker build 进行构建；</li><li>在X86/AMD64 的机器上使用 docker buildx 进行交叉构建；</li></ol><p>实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；</p><p>关于第二种构建方式，可先阅读<a href="https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R">跨平台构建 Docker 镜像新姿势，x86、arm 一把梭</a>进行了解，以下简要介绍使用buildx交叉构建的方式；</p><blockquote><p><strong>⚠️注意：</strong></p><ol><li><p>交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；</p></li><li><p>实际测试发现，使用<a href=https://github.com/multiarch/qemu-user-static>qemu方式</a>在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；</p><p>上面第二点按如下方式测试：</p><ul><li><code>docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch</code> 可正常输出；</li><li><code>docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version</code> 则会<strong>卡住</strong>，且需要使用<code>docker stop</code>停止容器才可以退出容器；</li></ul></li></ol></blockquote><h3 id=启用试验性功能>启用试验性功能<a hidden class=anchor aria-hidden=true href=#启用试验性功能>#</a></h3><blockquote><p>参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features
注意：buildx 仅支持 docker19.03 及以上docker版本</p></blockquote><p>如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：</p><ul><li>编辑 /etc/docker/daemon.json</li><li>添加：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;experimental&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>编辑 ～/.docker/config.json 添加：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;experimental&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;enabled&#34;</span>
</span></span></code></pre></div><ul><li>重启Docker使生效：<ul><li>sudo systemctl daemon-reload</li><li>sudo systemctl restart docker</li></ul></li><li>确认是否开启：<ul><li>docker version -f&rsquo;{{.Server.Experimental}}'</li><li>如果输出true，则表示开启成功</li></ul></li></ul><h3 id=使用buildx构建>使用buildx构建<a hidden class=anchor aria-hidden=true href=#使用buildx构建>#</a></h3><p>buildx 的详细使用可参考：<a href="https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R">Docker官方文档-Reference-buildx</a></p><h4 id=创建-buildx-构建器>创建 buildx 构建器<a hidden class=anchor aria-hidden=true href=#创建-buildx-构建器>#</a></h4><p>使用 docker buildx ls 命令查看现有的构建器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker buildx ls
</span></span></code></pre></div><p>创建并构建器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 下面的创建命令任选一条符合情况的即可</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 不指定任何参数创建</span>
</span></span><span style=display:flex><span>docker buildx create --use --name multiarch-builder
</span></span><span style=display:flex><span><span style=color:#75715e># 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令</span>
</span></span><span style=display:flex><span>docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 </span>
</span></span><span style=display:flex><span>docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network<span style=color:#f92672>=</span>host --config<span style=color:#f92672>=</span>/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder 
</span></span></code></pre></div><p>buildx-config.toml 配置文件写法类似：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md
</span></span><span style=display:flex><span># registry configures a new Docker register used for cache import or output.
</span></span><span style=display:flex><span>[registry.&#34;zh-registry.geostar.com.cn&#34;]
</span></span><span style=display:flex><span>  mirrors = [&#34;zh-registry.geostar.com.cn&#34;]
</span></span><span style=display:flex><span>  http = true
</span></span><span style=display:flex><span>  insecure = true
</span></span></code></pre></div><p><strong>启用构建器</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 初始化并激活</span>
</span></span><span style=display:flex><span>docker buildx inspect multiarch-builder --bootstrap
</span></span></code></pre></div><p><strong>确认成功</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span># 使用 docker buildx ls 查看
</span></span><span style=display:flex><span>docker buildx ls 
</span></span></code></pre></div><h3 id=修改dockerfile>修改Dockerfile<a hidden class=anchor aria-hidden=true href=#修改dockerfile>#</a></h3><p>对 Dockerfile 的修改，大致需要进行如下操作：</p><ol><li>确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译；</li><li>确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件</li></ol><p><code>ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz</code></p><p>此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：</p><p><code>ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz</code></p><p>当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；</p><blockquote><p><strong>提示：</strong></p><p>怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 <code>file {可执行文件路径}</code> 来查看，</p><p>如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-<code>x86_64&amp;arm64e</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>file <span style=color:#66d9ef>$(</span>which git<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>/usr/bin/git: Mach-O universal binary with <span style=color:#ae81ff>2</span> architectures: <span style=color:#f92672>[</span>x86_64:Mach-O 64-bit executable x86_64<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>arm64e:Mach-O 64-bit executable arm64e<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>/usr/bin/git <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> architecture x86_64<span style=color:#f92672>)</span>:	Mach-O 64-bit executable x86_64
</span></span><span style=display:flex><span>/usr/bin/git <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> architecture arm64e<span style=color:#f92672>)</span>:	Mach-O 64-bit executable arm64e
</span></span></code></pre></div><p>下面的命令则对一个so文件执行了file，可以看到其中的架构信息 <code>ARM aarch64</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>file /lib/aarch64-linux-gnu/libpthread-2.23.so
</span></span><span style=display:flex><span>/lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>GNU/Linux<span style=color:#f92672>)</span>, dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID<span style=color:#f92672>[</span>sha1<span style=color:#f92672>]=</span>880365ebb22114e4c10108b73243144d5fa315dc, <span style=color:#66d9ef>for</span> GNU/Linux 3.7.0, not stripped
</span></span></code></pre></div></blockquote><h3 id=docker-buildx-构建arm64镜像的命令>docker buildx 构建arm64镜像的命令<a hidden class=anchor aria-hidden=true href=#docker-buildx-构建arm64镜像的命令>#</a></h3><p>使用 &ndash;platform来指定架构，使用 <code>--push</code> 或 <code>--load</code> 来指定构建完毕后的动作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker buildx build --platform<span style=color:#f92672>=</span>linux/arm64,linux/amd64 -t xxxx:tag . --push 
</span></span></code></pre></div><blockquote><p>提示：当指定多个架构时，只能使用 &ndash;push 推送到远程仓库，无法 &ndash;load，推送成功后再通过 docker pull &ndash;platform 来拉取指定架构的镜像</p></blockquote><h3 id=检查构建成果>检查构建成果<a hidden class=anchor aria-hidden=true href=#检查构建成果>#</a></h3><ol><li>通过 <code>docker buildx imagetools inspect</code> 命令查看镜像信息，看是否有对应的arm架构信息；</li><li>实际运行镜像，确认运行正常；（在arm机器上执行）</li></ol><blockquote><p>提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。</p></blockquote><h2 id=在x86上运行arm镜像>在x86上运行arm镜像<a hidden class=anchor aria-hidden=true href=#在x86上运行arm镜像>#</a></h2><p>可参考 <a href=https://github.com/multiarch/qemu-user-static>github/qemu-user-static</a> ,简要描述如下：</p><ul><li><p>执行如下命令安装：</p><p><code>docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</code></p></li><li><p>之后即可运行arm版本的镜像，如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run --rm -t arm64v8/fedora uname -m
</span></span></code></pre></div></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://hanlyjiang.github.io/tags/docker/>Docker</a></li></ul><nav class=paginav><a class=prev href=https://hanlyjiang.github.io/posts/%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAandroid-gradle%E6%8F%92%E4%BB%B6/><span class=title>« Prev</span><br><span>编写一个Android Gradle插件</span>
</a><a class=next href=https://hanlyjiang.github.io/posts/gitlab-%E5%AE%89%E8%A3%85%E5%B9%B6%E6%B3%A8%E5%86%8Cgitlab-runner/><span class=title>Next »</span><br><span>Gitlab-Runner安装并注册</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hanlyjiang.github.io/>清水池塘</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>