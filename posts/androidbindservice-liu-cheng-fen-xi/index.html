<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Android bindService流程 | 清水池塘</title><meta name=keywords content="Android,源码分析"><meta name=description content="本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；"><meta name=author content="野生莲藕"><link rel=canonical href=https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/><link crossorigin=anonymous href=/assets/css/stylesheet.0ddbb411bed5280eeba0e4a55c287e6addf14dc6eb09c604363a7ce5c4d40c1c.css integrity="sha256-Ddu0Eb7VKA7roOSlXCh+at3xTcbrCcYENjp85cTUDBw=" rel="preload stylesheet" as=style><link rel=icon href=https://hanlyjiang.github.io/img/home.png><link rel=icon type=image/png sizes=16x16 href=https://hanlyjiang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanlyjiang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hanlyjiang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hanlyjiang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/"><meta property="og:site_name" content="清水池塘"><meta property="og:title" content="Android bindService流程"><meta property="og:description" content="本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-12T10:18:50+00:00"><meta property="article:modified_time" content="2021-04-12T10:18:50+00:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="源码分析"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android bindService流程"><meta name=twitter:description content="本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hanlyjiang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Android bindService流程","item":"https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Android bindService流程","name":"Android bindService流程","description":"本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；\n","keywords":["Android","源码分析"],"articleBody":"本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；\n预先知识：\nBinder通信机制 整体分析与总结 主线地图与问题提出 我们从bindService一路跟踪，初步绘制了如下的调用序列图，我们可以以下面的图作为一个主线地图，避免走失，然后根据具体问题进行细节分析。\nContext.bindService frameworks/base/core/java/android/content/Context.java ContextImpl.bindService frameworks/base/core/java/android/app/ContextImpl.java ContextImpl.bindServiceCommon frameworks/base/core/java/android/app/ContextImpl.java IActivityManager.bindIsolatedService android/app/IActivityManager.java ActivityManagerService.bindIsolatedService com/android/server/am/ActivityManagerService.java ActiveServices.bindServiceLocked com/android/server/am/ActiveServices.java IApplicationThread.scheduleBindService android/app/IApplicationThread.java Binder.transact binder Binder. transact binder Binder. transact binder ApplicationThread.scheduleBindService frameworks/base/core/java/android/app/ActivityThread.java ActivityThread#handleBindService frameworks/base/core/java/android/app/ActivityThread.java IBinder = Service.onBinder() 自定义的Service实现类 IActivityManager#publishService android/app/IActivityManager.java ActivityManagerService#publishService android/app/IActivityManager.java ActiveServices#publishServiceLocked com/android/server/am/ActiveServices.java IServiceConnection#connected - ActiveServices.requestServiceBindingLocked com/android/server/am/ActiveServices.java APP-client APP进程 AMS-server system_process AMS-server system_process APP:server APP Service进程 1 2 从上图中，我们提出如下问题：\nbindServiceCommon到IActivityManager的调用中，是如何获取到ActivityManagerService的？ AMS中如何获取ApplicationThread并与之通讯？ ApplicatoinThread的用途？ApplicationThread运行的进程是哪个？ 进程如何启动-即AMS如何创建APP:server进程？ Service如何启动？ Service如何绑定？ ServiceConnection 的回调方法何时使用？ 问题解答汇总 我们将相关问题的结论提前到此小节，便于后续从比较抽象的层次上来进行复习及预览；\nAPP进程如何获取AMS？ APP进程中通过 ServiceManager.getService(Context.ACTIVITY_SERVICE) 获取的ActivityManagerService的客户端操作代理对象（Proxy）。\n该对象位于APP进程中，可以使用此对象（通过Binder进程间通信）来要求（位于system_process中）的ActivityManagerService进行对应的服务操作；\nAMS如何获取ApplicationThread？ APP进程在binderSerice时，将自己进程中的ApplicationThread取出，通过Binder机制传递给AMS进程，传递过程中会转换成一个Proxy对象；\nActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); 服务如何绑定？服务如何启动？进程如何启动？ 进程启动： 在独立的进程中运行的服务需要先将进程启动，进程的启动是通过APP进程，请求系统进程中的AMS来执行，通过AMS的startProcessLocked方法启动进程，最终会通过socket接口请求zygote进程来启动进程。 在启动时会指定java的入口点为ActivityThread，即进程启动后会运行ActivityThread的main方法； AMS中会记录启动的进程记录（ProcessRecord），对应的ProcessRecord中会记录进程对应的ApplicationThread； 服务启动： 服务的启动需要请求AMS来完成 启动时需要先通过PID获取要启动到的ProcessRecord，通过ProcessRecord中记录的ApplicationThread来与对应的进程通信。 AMS通过ApplicationThread来通知对应的进程创建服务，ApplicationThread作为通信的接口，实际上最终会通过ActivityThread的handleCreateService来创建服务的实例； 服务创建时，是在APP进程（可能是独立的进程）中进行的，需要通过类加载器加载对应的Service的类，同时构造相应的上下文及资源对象等，然后构造对应的实例； 服务创建成功后，会记录到ActivityThread的一个Service列表中，以便后续管理； 服务绑定： 服务绑定先在APP进程中，通过AMS代理对象发起请求，由AMS来安排bind（ActivityManagerService.bindIsolatedService）; 然后具体的绑定动作还是通过IApplicationThread安排到APP的Service进程中，最终执行的ActivityThread#handleBindService; 在APP进程中，会将Service取出，然后调用其onBind方法来获取IBinder远程操作对象； 之后再通过AMS调用 ActivityManagerService#publishService 来通知绑定成功的通知到对应的需要绑定服务的APP进程； publishService中会调用ServiceConnection的onServiceConnected方法通知服务连接了； 整体流程总结 待补充\n详细分析解答问题 APP进程中如何获取AMS？ 说明：\n第一次先逐项查看各个小节，最后再看此处的总结；\n后续直接查看总结来快速获取结论；\n==总结：==\nAPP进程中通过 ServiceManager.getService(Context.ACTIVITY_SERVICE) 获取的ActivityManagerService的客户端操作代理对象（Proxy）。 该对象位于APP进程中，可以使用此对象（通过Binder进程间通信）来要求（位于system_process中）的ActivityManagerService进行对应的服务操作； 具体查看如下代码：\nContextImpl.bindServiceCommon 我们看 ContextImpl.bindServiceCommon 方法的实现，可以看到是调用了 ActivityManager.getService() 获取的；\nframeworks/base/core/java/android/app/ContextImpl.java:\nprivate boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. IServiceConnection sd; if (executor != null) { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags); } else { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags); } // int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); } ActivityManager.getService() 如下代码，getService实际上是从ServiceManager获取一个ActivityService的Binder远程服务接口对象，并且这个会被设置为单例模式；\nframeworks/base/core/java/android/app/ActivityManager.java:\nprivate static final Singleton\u003cIActivityManager\u003e IActivityManagerSingleton = new Singleton\u003cIActivityManager\u003e() { @Override protected IActivityManager create() { // 直接通过 ServiceManager.getService 获取一个IBinder对象 final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE); final IActivityManager am = IActivityManager.Stub.asInterface(b); return am; } }; public static IActivityManager getService() { // 直接从IActivityManagerSingleton获取实例 return IActivityManagerSingleton.get(); } AMS如何获取到 ApplicatoinThread？ 首先，AMS实际上位于系统进程（system_process)，而ApplicationThread则位于我们的APP进程，那么为什么需要这个跨进程的操作呢？\nService的创建需要经过系统的管理，比方说鉴权及其他管理需要； 而开发者定义的Service的实例的创建逻辑也还是需要开发者来实现，Service对应的类也应该只加载在开发者自己的进程之中，Service使用方实际上还是开发者自己，所以服务的真实实例的创建过程要在应用的进程中； 那么，系统进程（中的AMS）如何获取ApplicationThread呢？\nApplicationThread的来源？ 查看 ContextImpl.bindServiceCommon 的代码，可以看到，是在调用AMS的bindService方法时，将自己进程中的ApplicationThread及ActivityToken取出传递给了AMS服务；\n// frameworks/base/core/java/android/app/ContextImpl.java final @NonNull ActivityThread mMainThread; private final @Nullable IBinder mToken; public IBinder getActivityToken() { return mToken; } private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. IServiceConnection sd; try { service.prepareToLeaveProcess(this); // 调用时传递了ApplicationThread和IBinder int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); if (res \u003c 0) { throw new SecurityException( \"Not allowed to bind to service \" + service); } return res != 0; } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } 实际上，上面的mMainThread.getApplicationThread()取出的是我们的APP进程中的ApplicationThread的服务端对象，然后经过IActivityManager进行binder传输（transact）前，会将其转换为一个Proxy代理对象，用于在AMS中请求我们进程的ApplicationThread来提供服务；\n// android.app.IActivityManager.Stub#TRANSACTION_bindIsolatedService case TRANSACTION_bindIsolatedService: { data.enforceInterface(descriptor); android.app.IApplicationThread _arg0; // 这里将IApplicationThread的服务对象转换成一个Proxy代理对象 _arg0 = android.app.IApplicationThread.Stub.asInterface(data.readStrongBinder()); android.os.IBinder _arg1; _arg1 = data.readStrongBinder(); android.content.Intent _arg2; if ((0!=data.readInt())) { _arg2 = android.content.Intent.CREATOR.createFromParcel(data); } else { _arg2 = null; } java.lang.String _arg3; _arg3 = data.readString(); android.app.IServiceConnection _arg4; // 同理，这里将IServiceConnection的服务对象也转换成一个Proxy代理对象 _arg4 = android.app.IServiceConnection.Stub.asInterface(data.readStrongBinder()); int _arg5; _arg5 = data.readInt(); java.lang.String _arg6; _arg6 = data.readString(); java.lang.String _arg7; _arg7 = data.readString(); int _arg8; _arg8 = data.readInt(); int _result = this.bindIsolatedService(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8); reply.writeNoException(); reply.writeInt(_result); return true; } // android.app.IApplicationThread.Stub /** Local-side IPC implementation stub class. */ public static abstract class Stub extends android.os.Binder implements android.app.IApplicationThread { private static final java.lang.String DESCRIPTOR = \"android.app.IApplicationThread\"; /** Construct the stub at attach it to the interface. */ public Stub() { this.attachInterface(this, DESCRIPTOR); } /** * Cast an IBinder object into an android.app.IApplicationThread interface, * generating a proxy if needed. */ public static android.app.IApplicationThread asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof android.app.IApplicationThread))) { return ((android.app.IApplicationThread)iin); } // 这里构造成了Proxy return new android.app.IApplicationThread.Stub.Proxy(obj); } } 这里我们暂不考虑ApplicationThread由何处而来，每个进程中都对应一个ActivityThread，ActivityThread中有一个ApplicationThread对象。\nApplicationThread在bind流程中的使用 我们发现，最终是使用 ApplicationThread的 requestServiceBindingLocked 方法来绑定服务的（r.app.thread.scheduleBindService），我们先梳理一下ServiceRecord类同ApplicationThread的关系；\n// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java // com.android.server.am.ActiveServices#requestServiceBindingLocked private final boolean requestServiceBindingLocked(ServiceRecord r, IntentBindRecord i, boolean execInFg, boolean rebind) throws TransactionTooLargeException { if (r.app == null || r.app.thread == null) { // If service is not currently running, can't yet bind. return false; } // 调用ApplicationThread的绑定方法来进行绑定 r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind, r.app.getReportedProcState()); return true; } // frameworks/base/services/core/java/com/android/server/am/ServiceRecord.java ProcessRecord app; // where this service is running or null. // frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java IApplicationThread thread; // the actual proc... may be null only if // 'persistent' is true (in which case we // are in the process of launching the app) 其中 ServiceRecord.app 的类型为 ProcessRecord ，ServiceRecord.app.thread 的类型为 IApplicationThread，我们梳理下对应的几个类的关系，如下图：\nServiceRecord app:ProcessRecord isolatedProc: ProcessRecord + setProcess(ProcessRecord) IApplicationThread + scheduleBindService(IBinder, Intent, boolean rebind, int processState) + scheduleCreateService(IBinder, ServiceInfo info,… ) + bindApplication(…) IApplicationThread.Stub ApplicationThread ProcessRecord thread:IApplicationThread pid: int ActivityThread mAppThread:ApplicationThread 现在我们看下 ServiceRecord 是何时构造的，首先，根据方法的调用层次，我们可以看到：\nActiveServices.bindServiceLocked 方法中，参数中没有ServiceRecord，有的是IApplicationThread及一个IBinder。 ActiveServices.requestServiceBindingLocked 方法中，则变成了ServiceRecord类型。 提示：上述调用层次可以在IDEA中选中ActiveServices.requestServiceBindingLocked方法，然后通过“Navigate｜Call Hierarchy”（快捷键为==ctrl+opt+H==）弹出。\n所以，接下来我们看下 ActiveServices.bindServiceLocked 方法如何将ApplicationThread存入到ServiceRecord对象中。\nActiveServices.bindServiceLocked int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { final int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); // 这里获取了 ProcessRecord final ProcessRecord callerApp = mAm.getRecordForAppLocked(caller); final boolean callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND; final boolean isBindExternal = (flags \u0026 Context.BIND_EXTERNAL_SERVICE) != 0; final boolean allowInstant = (flags \u0026 Context.BIND_ALLOW_INSTANT) != 0; // 将IApplicationThread及IBinder放入到ServiceRecord中的过程在retrieveServiceLocked中 ServiceLookupResult res = retrieveServiceLocked(service, instanceName, resolvedType, callingPackage, callingPid, callingUid, userId, true, callerFg, isBindExternal, allowInstant); // 此处获取ServiceRecord，故在上面 ServiceRecord s = res.record; if (s.app != null \u0026\u0026 b.intent.received) { requestServiceBindingLocked(s, b.intent, callerFg, true); } else if (!b.intent.requested) { requestServiceBindingLocked(s, b.intent, callerFg, false); } return 1; } 到这里，我们可以发现ServiceRecord是通过retrieveServiceLocked方法获取到的ServiceLookupResult获取到的。\n==粗略看了下这个retrieveServiceLocked方法，其中逻辑比较多，我们这里转换下思路，直接查找 ServiceRecord.app 的赋值操作==。\nServiceRecord.app 的赋值 我们可以找到ServiceRecord.app（ProcessRecord）的赋值操作的调用方法为：com.android.server.am.ActiveServices#realStartServiceLocked\nprivate final void realStartServiceLocked(ServiceRecord r, ProcessRecord app, boolean execInFg) throws RemoteException { if (app.thread == null) { throw new RemoteException(); } // 在此处赋值 r.setProcess(app); // ... } 查看 realStartServiceLocked 的调用序列：\n也就是又回到了我们的 bindServiceLocked 方法，其中有一段逻辑是，如果需要创建服务，就执行 bringUpServiceLocked 方法。\n// com.android.server.am.ActiveServices#bindServiceLocked int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { // ... if ((flags\u0026Context.BIND_AUTO_CREATE) != 0) { s.lastActivity = SystemClock.uptimeMillis(); if (bringUpServiceLocked(s, service.getFlags(), callerFg, false, permissionsReviewRequired) != null) { return 0; } } // ... } 也就是说，在绑定服务的时候，如果服务没有创建，就先使用bringUpServiceLocked-realStartServiceLocked 进行创建，创建过程中会将ServiceRecord中的app赋值，然后存储起来；\n提示：我们可以通过如下IDEA操作来查找赋值操作\n选中成员（这里是 app）；\n==Ctrl+B== 或者 ==Command+鼠标单击==，弹出使用列表弹窗；\n然后在弹窗中设置仅查看write访问操作的；然后我们可以找到对应的赋值代码行；\n通过勾选其中的方法图标，我们可以显示赋值的代码行所在的方法（这里是setProcess）；\n然后我们继续在方法上执行上述操作，可以获取到更加上一步的赋值调用在哪；\n服务如何绑定？服务如何启动？进程如何启动？ bringUpServiceLocked(ServiceRecord r,…) 第一个参数为ServiceRecord，其中的app属性可存储一个进程记录； 如传入的ServiceRecord参数中表明服务已经启动过，r.app(ProcessRecord) 不为null，且r.app.thread(IApplicationThread)也不为null，则不创建，直接更新参数； 结下来，则分为两种情况，1）服务为声明单独的进程，则可直接在当前进程中启动；2）服务声明了单独的进程，则需要先启动进程，然后再启动服务； 非单独进程： 进程记录获取：通过AMS直接查询，并未创建，因为进程已经存在了，具体代码为 app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false) 服务启动：使用 realStartServiceLocked(r, app, execInFg); 方法启动 单独进程： 进程记录获取： 通过AMS.mAm.startProcessLocked 方法启动一个新的进程； app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags, hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false) 服务启动：未在此方法中直接调用 realStartServiceLocked 这里我们可以看到，在单独进程的服务启动流程中，并没有即时调用realStartServiceLocked来启动服务，那么这里就又个问题，独立进程情况下服务何时启动？\n单独进程服务启动： 将待启动的服务加入到mPendingServices(ArrayList)，在启动进程后再从此列表中读取需要启动的服务，然后启动； 总结：\n进程记录如何获取？\n通过AMS的 startProcessLocked 方法创建（非独立进程的也应该是通过此方法创建，只是创建时机不是这里） 服务如何启动？\n通过 realStartServiceLocked 方法启动（独立进程的应该也是此方法启动，会等到进程启动之后再启动）\nrealStartServiceLocked 中通过 IApplicationThread 执行 scheduleCreateService 来启动服务，最终调用 android.app.ActivityThread.ApplicationThread#scheduleCreateService来启动；\n进程创建 问题：\n进程何时创建？- 已解决 ApplicationThread（代理）对象何时设置到ProcessRecord中? - 已解决 ActivityThread#main的入口点中，如何获取之前的结果？ - 已解决 下面为创建进程的调用序列，注意如下序列中只是创建了一个ProcessRecord的对象，对应于Linux上的进程创建我们再起文章进行分析，对于我们的Service来说，拿到ProcessRecord对象即可供我们来创建服务；\nActivityManagerService#startProcessLocked com/android/server/am/ActivityManagerService.java ActivityManagerService#startProcessLocked startProcessLocked(hostingRecord, entryPoint) 带入口点 ProcessList#startProcess 带入口类 android.app.ActivityThread handleProcessStartedLocked 记录ProcessRecord（通过PID） android.os.ZygoteProcess#startViaZygote 带入口类 android.app.ActivityThread ZygoteProcess#zygoteSendArgsAndGetResult 带入口类 android.app.ActivityThread zygote zygote创建新的进程 ActivityThread#main() 进程创建后执行入口函数 ActivityThread#attach module ProcessList#startProcessLocked() com/android/server/am/ProcessList.java ProcessList#newProcessRecordLocked com/android/server/am/ProcessList.java ProcessList#newProcessRecordLocked new ProcessRecord(ams, info, proc, uid) ActiveServices#bringUpServiceLocked com/android/server/am/ActiveServices.java 创建进程 socket IActivityManager#attachApplication module ActivityManagerService#attachApplication module ActivityManagerService#attachApplicationLocked 获取之前缓存的ProcessRecord(app) ProcessRecord#makeActive app.makeActive(thread, mProcessStats) ; thread = _thread; transact binder 进程创建的执行位于AMS所在的系统进程之中； （AMS进程）首先，构建一个ProcessRecord记录，并将其记录到AMS中； （AMS进程）AMS通过socket通信，通知zygote来创建一个新的进程，同时指定入口点为 android.app.ActivityThread ; （APP进程）新的进程启动后，执行ActivityThread中的方法，通知AMS来执行attachApplication； （AMS进程）AMS中，通过PID获取之前存储的ProcessRecord，然后将ApplicationThread（代理对象）赋值给ProcessRecord的成员变量thread； 支持完成了关联； 构造ProcessRecord实例 com.android.server.am.ProcessList#startProcessLocked，简化下来就两句：\n构造ProcessRecord对象： app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord) 启动进程：startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride) // com.android.server.am.ProcessList#newProcessRecordLocked // frameworks/base/services/core/java/com/android/server/am/ProcessList.java final ProcessRecord startProcessLocked(String processName, ApplicationInfo info, boolean knownToBeDead, int intentFlags, HostingRecord hostingRecord, int zygotePolicyFlags, boolean allowWhileBooting, boolean isolated, int isolatedUid, boolean keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) { long startTime = SystemClock.uptimeMillis(); ProcessRecord app; if (app == null) { // 构造ProcessRecord对象 app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord); app.crashHandler = crashHandler; app.isolatedEntryPoint = entryPoint; app.isolatedEntryPointArgs = entryPointArgs; } else { // If this is a new package in the process, add the package to the list app.addPackage(info.packageName, info.longVersionCode, mService.mProcessStats); } // 启动进程 final boolean success = startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride); checkSlow(startTime, \"startProcess: done starting proc!\"); return success ? app : null; } 启动进程 startProcessLocked: 启动了一个进程，并指定了入口点为 ==android.app.ActivityThread==，也就是进程启动后将会执行 ==android.app.ActivityThread==的main方法。\n// frameworks/base/services/core/java/com/android/server/am/ProcessList.java // com.android.server.am.ProcessList#startProcessLocked(com.android.server.am.ProcessRecord, com.android.server.am.HostingRecord, int, boolean, boolean, boolean, java.lang.String) boolean startProcessLocked(ProcessRecord app, HostingRecord hostingRecord, int zygotePolicyFlags, boolean disableHiddenApiChecks, boolean disableTestApiChecks, boolean mountExtStorageFull, String abiOverride) { if (app.pendingStart) { return true; } long startTime = SystemClock.uptimeMillis(); try { try { final int userId = UserHandle.getUserId(app.uid); AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId); } catch (RemoteException e) { throw e.rethrowAsRuntimeException(); } int uid = app.uid; int[] gids = null; // ... app.mountMode = mountExternal; app.gids = gids; app.setRequiredAbi(requiredAbi); app.instructionSet = instructionSet; final String seInfo = app.info.seInfo + (TextUtils.isEmpty(app.info.seInfoUser) ? \"\" : app.info.seInfoUser); // Start the process. It will either succeed and return a result containing // the PID of the new process, or else throw a RuntimeException. // 指定入口点为ActivityThread，启动进程 final String entryPoint = \"android.app.ActivityThread\"; return startProcessLocked(hostingRecord, entryPoint, app, uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith, startTime); } catch (RuntimeException e) { return false; } } boolean startProcessLocked(HostingRecord hostingRecord, String entryPoint, ProcessRecord app, int uid, int[] gids, int runtimeFlags, int zygotePolicyFlags, int mountExternal, String seInfo, String requiredAbi, String instructionSet, String invokeWith, long startTime) { app.pendingStart = true; app.killedByAm = false; app.removed = false; app.killed = false; final long startSeq = app.startSeq = ++mProcStartSeqCounter; app.setStartParams(uid, hostingRecord, seInfo, startTime); app.setUsingWrapper(invokeWith != null || Zygote.getWrapProperty(app.processName) != null); mPendingStarts.put(startSeq, app); if (mService.mConstants.FLAG_PROCESS_START_ASYNC) { return true; } else { try { // 启动进程，并传入entrypoint final Process.ProcessStartResult startResult = startProcess(hostingRecord, entryPoint, app, uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith, startTime); // 做启动后的操作 handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper, startSeq, false); } catch (RuntimeException e) { } return app.pid \u003e 0; } } 这里我们省略其他更加底层的步骤的分析，我们只需要知道到了这里之后，会启动一个进程，进程启动后会执行 ==android.app.ActivityThread#main== 方法；\n记录进程记录到AMS ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)\n==这个地方有个关键的代码将之前创建的进程记录存储到了AMS的进程记录表中。==\n// com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean) // frameworks/base/services/core/java/com/android/server/am/ProcessList.java ActivityManagerService mService = null; boolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper, long expectedStartSeq, boolean procAttached) { // 将ProcessRecord 存储到AMS中 mService.addPidLocked(app); } // frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java void addPidLocked(ProcessRecord app) { synchronized (mPidsSelfLocked) { // 将进程记录添加到一个记录表中 mPidsSelfLocked.doAddInternal(app); } synchronized (sActiveProcessInfoSelfLocked) { if (app.processInfo != null) { sActiveProcessInfoSelfLocked.put(app.pid, app.processInfo); } else { sActiveProcessInfoSelfLocked.remove(app.pid); } } mAtmInternal.onProcessMapped(app.pid, app.getWindowProcessController()); } // 完整代码 // com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean) // frameworks/base/services/core/java/com/android/server/am/ProcessList.java boolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper, long expectedStartSeq, boolean procAttached) { mPendingStarts.remove(expectedStartSeq); final String reason = isProcStartValidLocked(app, expectedStartSeq); if (reason != null) { Slog.w(TAG_PROCESSES, app + \" start not valid, killing pid=\" + pid + \", \" + reason); app.pendingStart = false; killProcessQuiet(pid); Process.killProcessGroup(app.uid, app.pid); noteAppKill(app, ApplicationExitInfo.REASON_OTHER, ApplicationExitInfo.SUBREASON_INVALID_START, reason); return false; } mService.mBatteryStatsService.noteProcessStart(app.processName, app.info.uid); checkSlow(app.startTime, \"startProcess: done updating battery stats\"); EventLog.writeEvent(EventLogTags.AM_PROC_START, UserHandle.getUserId(app.startUid), pid, app.startUid, app.processName, app.hostingRecord.getType(), app.hostingRecord.getName() != null ? app.hostingRecord.getName() : \"\"); try { AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid, app.seInfo, app.info.sourceDir, pid); } catch (RemoteException ex) { // Ignore } Watchdog.getInstance().processStarted(app.processName, pid); checkSlow(app.startTime, \"startProcess: building log message\"); StringBuilder buf = mStringBuilder; buf.setLength(0); buf.append(\"Start proc \"); buf.append(pid); buf.append(':'); buf.append(app.processName); buf.append('/'); UserHandle.formatUid(buf, app.startUid); if (app.isolatedEntryPoint != null) { buf.append(\" [\"); buf.append(app.isolatedEntryPoint); buf.append(\"]\"); } buf.append(\" for \"); buf.append(app.hostingRecord.getType()); if (app.hostingRecord.getName() != null) { buf.append(\" \"); buf.append(app.hostingRecord.getName()); } mService.reportUidInfoMessageLocked(TAG, buf.toString(), app.startUid); app.setPid(pid); app.setUsingWrapper(usingWrapper); app.pendingStart = false; checkSlow(app.startTime, \"startProcess: starting to update pids map\"); ProcessRecord oldApp; synchronized (mService.mPidsSelfLocked) { oldApp = mService.mPidsSelfLocked.get(pid); } // If there is already an app occupying that pid that hasn't been cleaned up if (oldApp != null \u0026\u0026 !app.isolated) { // Clean up anything relating to this pid first Slog.wtf(TAG, \"handleProcessStartedLocked process:\" + app.processName + \" startSeq:\" + app.startSeq + \" pid:\" + pid + \" belongs to another existing app:\" + oldApp.processName + \" startSeq:\" + oldApp.startSeq); mService.cleanUpApplicationRecordLocked(oldApp, false, false, -1, true /*replacingPid*/); } // 注意这里 mService.addPidLocked(app); synchronized (mService.mPidsSelfLocked) { if (!procAttached) { Message msg = mService.mHandler.obtainMessage(PROC_START_TIMEOUT_MSG); msg.obj = app; mService.mHandler.sendMessageDelayed(msg, usingWrapper ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT); } } checkSlow(app.startTime, \"startProcess: done updating pids map\"); return true; } 写入thread值到ProcessRecord 从上面的流程中，我们发现构造出来的ProcessRecord的thread（ApplicationThread）成员变量还是没有被赋值，那么这个thread何时被赋值呢？\n查找ProcessRecord中thread赋值的入口：\n通过查找thread成员的赋值写入方法，可以确定起始点是，com.android.server.am.ProcessRecord#makeActive ，接下来查看调用这个方法的列表：\n这里我们显然选择 com.android.server.am.ActivityManagerService#attachApplicationLocked\nandroid.app.ActivityThread#attach\n这里我们遇到两个选择：\n显然，应该选择第二个：android.app.ActivityThread#main\n这里我们却无法直接通过IDEA的调用层次功能找到任何调用方法，说明可能是通过反射来调用的，所以直接通过全局字符串搜索==android.app.ActivityThread==，可以找到在 ProcessList.startProcessLocked 中调用的。\n通过上面的分析，这里我们从ActivityThread的main函数开始。\nActivityThread#main public static void main(String[] args) { Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"ActivityThreadMain\"); // Install selective syscall interception AndroidOs.install(); // CloseGuard defaults to true and can be quite spammy. We // disable it here, but selectively enable it later (via // StrictMode) on debug builds, but using DropBox, not logs. CloseGuard.setEnabled(false); Environment.initForCurrentUser(); // Make sure TrustedCertificateStore looks in the right place for CA certificates final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId()); TrustedCertificateStore.setDefaultUserDirectory(configDir); // Call per-process mainline module initialization. initializeMainlineModules(); Process.setArgV0(\"\"); Looper.prepareMainLooper(); // Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line. // It will be in the format \"seq=114\" long startSeq = 0; if (args != null) { for (int i = args.length - 1; i \u003e= 0; --i) { if (args[i] != null \u0026\u0026 args[i].startsWith(PROC_START_SEQ_IDENT)) { startSeq = Long.parseLong( args[i].substring(PROC_START_SEQ_IDENT.length())); } } } // 直接构造一个ActivityThread对象 ActivityThread thread = new ActivityThread(); // 执行attach方法 thread.attach(false, startSeq); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } if (false) { Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, \"ActivityThread\")); } // End of event ActivityThreadMain. Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); Looper.loop(); throw new RuntimeException(\"Main thread loop unexpectedly exited\"); } ActivityThread#attach private void attach(boolean system, long startSeq) { sCurrentActivityThread = this; mSystemThread = system; if (!system) { android.ddm.DdmHandleAppName.setAppName(\"\", UserHandle.myUserId()); // 将当前ApplicationThread的Binder对象保存为一个静态成员 RuntimeInit.setApplicationObject(mAppThread.asBinder()); // 获取AMS final IActivityManager mgr = ActivityManager.getService(); try { // 通知AMS来 attachApplication mgr.attachApplication(mAppThread, startSeq); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } else { } } ActivityManagerService#attachApplication \u0026 attachApplicationLocked @Override public final void attachApplication(IApplicationThread thread, long startSeq) { if (thread == null) { throw new SecurityException(\"Invalid application interface\"); } synchronized (this) { int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid, callingUid, startSeq); Binder.restoreCallingIdentity(origId); } } 上面的方法只是调用了 attachApplicationLocked：\n==有个关键的步骤是，从 AMS的进程记录表中根据PID取出一个 ProcessRecord: app = mPidsSelfLocked.get(pid)==\nprivate boolean attachApplicationLocked(@NonNull IApplicationThread thread, int pid, int callingUid, long startSeq) { // Find the application record that is being attached... either via // the pid if we are running in multiple processes, or just pull the // next app record if we are emulating process with anonymous threads. ProcessRecord app; long startTime = SystemClock.uptimeMillis(); long bindApplicationTimeMillis; if (pid != MY_PID \u0026\u0026 pid \u003e= 0) { synchronized (mPidsSelfLocked) { // 从进程记录中获取 app = mPidsSelfLocked.get(pid); } } // Make app active after binding application or client may be running requests (e.g // starting activities) before it is ready. // 关联thread到app（ProcessRecord） app.makeActive(thread, mProcessStats); return true; } 经过上面的步骤，即完成了ProcessRecord到进程的ApplicationThread的关联。\n启动服务 从AMS中调用ApplicationThread的方法来在Service自己应该所属的进程中创建Service对象的实例。\nActivityThread#main() 进程创建后执行入口函数 独立进程的Service 启动进程 ActivityThread#attach - IApplicationThread#scheduleCreateService android/app/IApplicationThread.java transact binder transact binder ApplicationThread#scheduleCreateService android/app/ActivityThread.java ActivityThread#handleCreateService android/app/ActivityThread.java IActivityManager#serviceDoneExecuting android/app/ActivityThread.java ActivityManagerService#serviceDoneExecuting android/app/ActivityThread.java ActiveServices#bringUpServiceLocked com/android/server/am/ActiveServices.java ActiveServices#realStartServiceLocked com/android/server/am/ActiveServices.java 启动服务 IActivityManager#attachApplication - ActivityManagerService#attachApplication - ActivityManagerService#attachApplicationLocked 获取之前存储的 mPendingServices - 待启动的服务列表 transact binder ActiveServices#bringUpServiceLocked // com.android.server.am.ActiveServices#bringUpServiceLocked // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java private String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg, boolean whileRestarting, boolean permissionsReviewRequired) throws TransactionTooLargeException { // 已经存在进程记录，并且进程记录中的IApplicationThread已经存在，则不创建服务，仅发送参数 if (r.app != null \u0026\u0026 r.app.thread != null) { sendServiceArgsLocked(r, execInFg, false); return null; } final boolean isolated = (r.serviceInfo.flags\u0026ServiceInfo.FLAG_ISOLATED_PROCESS) != 0; final String procName = r.processName; HostingRecord hostingRecord = new HostingRecord(\"service\", r.instanceName); ProcessRecord app; // 非独立的进程，则直接获取当前启动进程的进程信息 if (!isolated) { app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false); if (app != null \u0026\u0026 app.thread != null) { try { app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats); // 非独立进程中，直接启动服务 realStartServiceLocked(r, app, execInFg); // 调用启动方法后直接返回 return null; } catch (TransactionTooLargeException e) { throw e; } catch (RemoteException e) { Slog.w(TAG, \"Exception when starting service \" + r.shortInstanceName, e); } // If a dead object exception was thrown -- fall through to // restart the application. } } else { // 独立进程则先尝试使用之前保存的 app = r.isolatedProc; } // 之前没有启动对应的进程，则开始创建，启动了，则无需进行赋值操作，因为ServiceRecord中已经有了 if (app == null \u0026\u0026 !permissionsReviewRequired) { if ((app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags, hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false)) == null) { String msg = \"Unable to launch app \" + r.appInfo.packageName + \"/\" + r.appInfo.uid + \" for service \" + r.intent.getIntent() + \": process is bad\"; Slog.w(TAG, msg); bringDownServiceLocked(r); // 进程启动失败，返回错误消息 return msg; } if (isolated) { // 独立进程，缓存进程信息到传入的ServiceRecord参数中，以便后续直接使用 r.isolatedProc = app; } } // 将服务记录加入的mPendingServices中，由于非独立进程创建后已经直接返回，所以这里适用于独立进程的 if (!mPendingServices.contains(r)) { mPendingServices.add(r); } // 创建成功或者之前已经又了缓存，则返回null return null; } 独立进程何时启动服务？ 一般来说，封装较好的代码会保证入口统一，如果非独立进程情况下服务的启动使用的是 realStartServiceLocked 方法来启动服务，那么独立进程情况下，服务的启动也应该使用此方法，所以我们查看 realStartServiceLocked 方法的调用层次，如下：\n图片版本:\n详细调用序列:\nActiveServices.attachApplicationLocked(ProcessRecord, String) (com.android.server.am) ActivityManagerService.attachApplicationLocked(IApplicationThread, int, int, long) (com.android.server.am) ActivityManagerService.attachApplication(IApplicationThread, long) (com.android.server.am) ActiveServices.bringUpServiceLocked(ServiceRecord, int, boolean, boolean, boolean) (com.android.server.am) ActiveServices.startServiceInnerLocked(ServiceMap, Intent, ServiceRecord, boolean, boolean) (com.android.server.am) ActiveServices.bindServiceLocked(IApplicationThread, IBinder, Intent, String, IServiceConnection, int, String, …) (com.android.server.am) ActiveServices.performServiceRestartLocked(ServiceRecord) (com.android.server.am) 也就是调用了 ActiveServices.attachApplicationLocked ,最终是通过AMS的ActivityManagerService.attachApplication来触发的;也就是只要找到mAm.startProcessLocked到ActivityManagerService.attachApplication的调用序列即可证明此猜想;\n我们可以找到如下调用序列，即最终实际上是从ActivityThread的main函数进入的，所以做出以下猜想：进程启动后，创建ActivityThread时，如果有需要创建的服务，就启动服务；\n我们再看attachApplicationLocked 的逻辑，可以发现，会检查mPendingServices中是否有待启动的服务，然后逐一处理，如果有需要启动的服务，则会调用realStartServiceLocked(sr, proc, sr.createdFromFg)来启动服务。\n// com.android.server.am.ActiveServices#attachApplicationLocked // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java boolean attachApplicationLocked(ProcessRecord proc, String processName) throws RemoteException { boolean didSomething = false; // Collect any services that are waiting for this process to come up. if (mPendingServices.size() \u003e 0) { ServiceRecord sr = null; try { for (int i=0; i\u003cmPendingServices.size(); i++) { sr = mPendingServices.get(i); // 排除非独立Service if (proc != sr.isolatedProc \u0026\u0026 (proc.uid != sr.appInfo.uid || !processName.equals(sr.processName))) { continue; } mPendingServices.remove(i); i--; proc.addPackage(sr.appInfo.packageName, sr.appInfo.longVersionCode, mAm.mProcessStats); // 启动服务 realStartServiceLocked(sr, proc, sr.createdFromFg); } } catch (RemoteException e) { Slog.w(TAG, \"Exception in new application when starting service \" + sr.shortInstanceName, e); throw e; } } } ActivityThread#handleCreateService 这里我们省略bringUpServiceLocked方法及下方的几个中间步骤，直接查看android.app.ActivityThread#handleCreateService方法：\n通过ClassLoader加载并实例化了对应的Service对象； 将Service存储到ActivityThread中的一个ArrayMap中； // android/app/ActivityThread.java // android.app.ActivityThread#handleCreateService final ArrayMap\u003cIBinder, Service\u003e mServices = new ArrayMap\u003c\u003e(); private void handleCreateService(CreateServiceData data) { // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); LoadedApk packageInfo = getPackageInfoNoCheck( data.info.applicationInfo, data.compatInfo); Service service = null; try { if (localLOGV) Slog.v(TAG, \"Creating service \" + data.info.name); ContextImpl context = ContextImpl.createAppContext(this, packageInfo); Application app = packageInfo.makeApplication(false, mInstrumentation); java.lang.ClassLoader cl = packageInfo.getClassLoader(); // 创建对应的Service实例 service = packageInfo.getAppFactory() .instantiateService(cl, data.info.name, data.intent); // Service resources must be initialized with the same loaders as the application // context. context.getResources().addLoaders( app.getResources().getLoaders().toArray(new ResourcesLoader[0])); context.setOuterContext(service); service.attach(context, this, data.info.name, data.token, app, ActivityManager.getService()); service.onCreate(); mServices.put(data.token, service); try { ActivityManager.getService().serviceDoneExecuting( data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } catch (Exception e) { if (!mInstrumentation.onException(service, e)) { throw new RuntimeException( \"Unable to create service \" + data.info.name + \": \" + e.toString(), e); } } } 绑定服务 ActivityManagerService.bindIsolatedService com/android/server/am/ActivityManagerService.java ActiveServices.bindServiceLocked com/android/server/am/ActiveServices.java IApplicationThread.scheduleBindService android/app/IApplicationThread.java Binder.transact binder Binder. transact binder ApplicationThread.scheduleBindService frameworks/base/core/java/android/app/ActivityThread.java ActivityThread#handleBindService frameworks/base/core/java/android/app/ActivityThread.java IBinder = Service.onBinder() 自定义的Service实现类 IActivityManager#publishService android/app/IActivityManager.java ActivityManagerService#publishService android/app/IActivityManager.java ActiveServices#publishServiceLocked com/android/server/am/ActiveServices.java IServiceConnection#connected - ActiveServices.requestServiceBindingLocked com/android/server/am/ActiveServices.java 我们的问题是：\n绑定服务时，传入的ServiceConnection对象，如何被调用来通知？ 还做了些什么？ 连接对象去哪里了？ 查看ContextImpl.bindServiceCommon方法可以看到，传入了参数 ServiceConnection conn，然后方法中这个conn放入到了一个 ServiceDispatcher 中.\nIServiceConnection 包含两个接口： connected(): 连接到服务 asBinder()： 服务转Binder 这里会将我们自行编写的ServiceConnection对象构造出一个ServiceDispatcher对象，然后将ServiceDispatcher提供一个IServiceconnection接口（ServiceDispatcher$InnerConnection类），用于提供服务； 这个ServiceDispatcher$InnerConnection类的connect方法会调用sd的connect方法，最终会调用我们提供的ServiceConnection的回调方法：mConnection.onServiceConnected(name, service) 也就是说，使用sd.connect()就可以触发我们的连接对象的onServiceConnected回调方法；\nfinal @NonNull LoadedApk mPackageInfo; private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. // 这个IServiceConnection 实际上就是持有ServiceDispatcher的弱引用对象，然后将ServiceDispatcher的少量方法暴露出去 IServiceConnection sd; if (mPackageInfo != null) { if (executor != null) { // mPackageInfo 是一个 LoadedApk 对象 sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags); } else { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags); } } else { } int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), // 调用AMS的服务式这里传入了sd sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); //... } // com.android.server.am.ActiveServices#bindServiceLocked AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp); ConnectionRecord c = new ConnectionRecord(b, activity, connection, flags, clientLabel, clientIntent, callerApp.uid, callerApp.processName, callingPackage); // 提供 IBinder IBinder binder = connection.asBinder(); s.addConnection(binder, c); b.connections.add(c); ServiceDispatcher类位于 android.app.LoadedApk.ServiceDispatcher：\n// frameworks/base/core/java/android/app/LoadedApk.java public final IServiceConnection getServiceDispatcher(ServiceConnection c, Context context, Executor executor, int flags) { return getServiceDispatcherCommon(c, context, null, executor, flags); } private IServiceConnection getServiceDispatcherCommon(ServiceConnection c, Context context, Handler handler, Executor executor, int flags) { synchronized (mServices) { LoadedApk.ServiceDispatcher sd = null; ArrayMap\u003cServiceConnection, LoadedApk.ServiceDispatcher\u003e map = mServices.get(context); if (map != null) { if (DEBUG) Slog.d(TAG, \"Returning existing dispatcher \" + sd + \" for conn \" + c); sd = map.get(c); } if (sd == null) { if (executor != null) { sd = new ServiceDispatcher(c, context, executor, flags); } else { sd = new ServiceDispatcher(c, context, handler, flags); } if (DEBUG) Slog.d(TAG, \"Creating new dispatcher \" + sd + \" for conn \" + c); if (map == null) { map = new ArrayMap\u003c\u003e(); mServices.put(context, map); } map.put(c, sd); } else { sd.validate(context, handler, executor); } return sd.getIServiceConnection(); } } static final class ServiceDispatcher { private final ServiceDispatcher.InnerConnection mIServiceConnection; @UnsupportedAppUsage private final ServiceConnection mConnection; @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023) private final Context mContext; private final Handler mActivityThread; private final Executor mActivityExecutor; private final ServiceConnectionLeaked mLocation; private final int mFlags; private static class InnerConnection extends IServiceConnection.Stub { @UnsupportedAppUsage final WeakReference\u003cLoadedApk.ServiceDispatcher\u003e mDispatcher; InnerConnection(LoadedApk.ServiceDispatcher sd) { mDispatcher = new WeakReference\u003cLoadedApk.ServiceDispatcher\u003e(sd); } public void connected(ComponentName name, IBinder service, boolean dead) throws RemoteException { LoadedApk.ServiceDispatcher sd = mDispatcher.get(); if (sd != null) { sd.connected(name, service, dead); } } } @UnsupportedAppUsage ServiceDispatcher(ServiceConnection conn, Context context, Handler activityThread, int flags) { mIServiceConnection = new InnerConnection(this); mConnection = conn; mContext = context; mActivityThread = activityThread; mActivityExecutor = null; mLocation = new ServiceConnectionLeaked(null); mLocation.fillInStackTrace(); mFlags = flags; } ServiceConnection getServiceConnection() { return mConnection; } // SD中提供了connected方法 public void connected(ComponentName name, IBinder service, boolean dead) { if (mActivityExecutor != null) { mActivityExecutor.execute(new RunConnection(name, service, 0, dead)); } else if (mActivityThread != null) { mActivityThread.post(new RunConnection(name, service, 0, dead)); } else { doConnected(name, service, dead); } } public void doConnected(ComponentName name, IBinder service, boolean dead) { ServiceDispatcher.ConnectionInfo old; ServiceDispatcher.ConnectionInfo info; synchronized (this) { if (mForgotten) { // We unbound before receiving the connection; ignore // any connection received. return; } old = mActiveConnections.get(name); if (old != null \u0026\u0026 old.binder == service) { // Huh, already have this one. Oh well! return; } if (service != null) { // A new service is being connected... set it all up. info = new ConnectionInfo(); info.binder = service; info.deathMonitor = new DeathMonitor(name, service); try { service.linkToDeath(info.deathMonitor, 0); mActiveConnections.put(name, info); } catch (RemoteException e) { // This service was dead before we got it... just // don't do anything with it. mActiveConnections.remove(name); return; } } else { // The named service is being disconnected... clean up. mActiveConnections.remove(name); } if (old != null) { old.binder.unlinkToDeath(old.deathMonitor, 0); } } // If there was an old service, it is now disconnected. if (old != null) { mConnection.onServiceDisconnected(name); } if (dead) { mConnection.onBindingDied(name); } // If there is a new viable service, it is now connected. if (service != null) { mConnection.onServiceConnected(name, service); } else { // The binding machinery worked, but the remote returned null from onBind(). mConnection.onNullBinding(name); } } } IServiceConnection说明 服务绑定时，IServiceConnection的用途？如何实现在APP的Activity进程中调用ServiceConnection的onServiceConnected方法？\nIServiceConnect的服务端位于APP进程中，在ContextImpl的binderServiceCommon方法中初始化，也就是LoadApk类中的ServiceDispatcher类。 传递给AMS的实际上是一个Binder的远程代理对象； // android.app.IActivityManager.Stub#TRANSACTION_bindService // android/app/IActivityManager.java case TRANSACTION_bindService: { data.enforceInterface(descriptor); android.app.IApplicationThread _arg0; _arg0 = android.app.IApplicationThread.Stub.asInterface(data.readStrongBinder()); android.os.IBinder _arg1; _arg1 = data.readStrongBinder(); android.content.Intent _arg2; if ((0!=data.readInt())) { _arg2 = android.content.Intent.CREATOR.createFromParcel(data); } else { _arg2 = null; } java.lang.String _arg3; _arg3 = data.readString(); android.app.IServiceConnection _arg4; // 这里可以看到，是在这个地方见IServiceConnection的服务端对象转换成客户端代理对象的 _arg4 = android.app.IServiceConnection.Stub.asInterface(data.readStrongBinder()); int _arg5; _arg5 = data.readInt(); java.lang.String _arg6; _arg6 = data.readString(); int _arg7; _arg7 = data.readInt(); int _result = this.bindService(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7); reply.writeNoException(); reply.writeInt(_result); return true; } asInterface 中： new android.app.IServiceConnection.Stub.Proxy(obj) 即是将Stub转换为Proxy对象；\n/** Local-side IPC implementation stub class. */ public static abstract class Stub extends android.os.Binder implements android.app.IServiceConnection { private static final java.lang.String DESCRIPTOR = \"android.app.IServiceConnection\"; /** Construct the stub at attach it to the interface. */ public Stub() { this.attachInterface(this, DESCRIPTOR); } /** * Cast an IBinder object into an android.app.IServiceConnection interface, * generating a proxy if needed. */ public static android.app.IServiceConnection asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof android.app.IServiceConnection))) { return ((android.app.IServiceConnection)iin); } return new android.app.IServiceConnection.Stub.Proxy(obj); } } 也就是说，ActivityManagerService.bindService方法中的IServiceConnection参数实际上是一个Proxy对象；\n// 这里的Connection是一个代理对象 public int bindService(IApplicationThread caller, IBinder token, Intent service, String resolvedType, IServiceConnection connection, int flags, String callingPackage, int userId) throws TransactionTooLargeException { return bindIsolatedService(caller, token, service, resolvedType, connection, flags, null, callingPackage, userId); } ActivityThread#handleBindService 实际上就做了两件事情\n// android.app.ActivityThread#handleBindService // frameworks/base/core/java/android/app/ActivityThread.java private void handleBindService(BindServiceData data) { // 获取之前创建的服务 Service s = mServices.get(data.token); if (s != null) { // 找不到之前创建的服务，则什么都不做 try { data.intent.setExtrasClassLoader(s.getClassLoader()); data.intent.prepareToEnterProcess(); try { if (!data.rebind) { // 调用Service的onBind接口获取IBinder对象 IBinder binder = s.onBind(data.intent); // 通知AMS来publicService ActivityManager.getService().publishService( data.token, data.intent, binder); } else { s.onRebind(data.intent); ActivityManager.getService().serviceDoneExecuting( data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0); } } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } catch (Exception e) { } } } ActivityManagerService#publishService // com.android.server.am.ActivityManagerService#publishService // frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java public void publishService(IBinder token, Intent intent, IBinder service) { // Refuse possible leaked file descriptors if (intent != null \u0026\u0026 intent.hasFileDescriptors() == true) { throw new IllegalArgumentException(\"File descriptors passed in Intent\"); } synchronized(this) { if (!(token instanceof ServiceRecord)) { throw new IllegalArgumentException(\"Invalid service token\"); } // com.android.server.am.ActiveServices#publishServiceLocked mServices.publishServiceLocked((ServiceRecord)token, intent, service); } } ActiveServices#publishServiceLocked 下面我们可以看到，在publishServiceLocked方法中，取出了一个连接记录列表，然后循环的调用了其中的IServiceConnection的connected方法，也就是会调用到我们自行定义的ServiceConnnection对象的connected方法。\n不过我们有个问题，就是这个ConnectionRecord对象是何时构造的？\n// com.android.server.am.ConnectionRecord // frameworks/base/services/core/java/com/android/server/am/ConnectionRecord.java final class ConnectionRecord { final AppBindRecord binding; // The application/service binding. final ActivityServiceConnectionsHolder\u003cConnectionRecord\u003e activity; // If non-null, the owning activity. final IServiceConnection conn; // The client connection. } // com.android.server.am.ActiveServices#publishServiceLocked // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java void publishServiceLocked(ServiceRecord r, Intent intent, IBinder service) { final long origId = Binder.clearCallingIdentity(); try { // 如果服务记录为null，就什么都不做 if (r != null) { Intent.FilterComparison filter = new Intent.FilterComparison(intent); IntentBindRecord b = r.bindings.get(filter); if (b != null \u0026\u0026 !b.received) { b.binder = service; b.requested = true; b.received = true; // 取出连接记录ConnectionRecord ArrayMap\u003cIBinder, ArrayList\u003cConnectionRecord\u003e\u003e connections = r.getConnections(); for (int conni = connections.size() - 1; conni \u003e= 0; conni--) { ArrayList\u003cConnectionRecord\u003e clist = connections.valueAt(conni); for (int i = 0; i \u003c clist.size(); i++) { ConnectionRecord c = clist.get(i); try { // 调用IServiceConnection的connected方法 c.conn.connected(r.name, service, false); } catch (Exception e) { } } } } serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), false); } } finally { } } 构造 ConnectionRecord - bindServiceLocked 实际上这个构建ConnectRecord的过程位于bindServiceLocked方法中。\nint bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { final int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); ActivityServiceConnectionsHolder\u003cConnectionRecord\u003e activity = null; if (token != null) { activity = mAm.mAtmInternal.getServiceConnectionsHolder(token); if (activity == null) { Slog.w(TAG, \"Binding with unknown activity: \" + token); return 0; } } ServiceLookupResult res = retrieveServiceLocked(service, instanceName, resolvedType, callingPackage, callingPid, callingUid, userId, true, callerFg, isBindExternal, allowInstant); ServiceRecord s = res.record; try { AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp); // 构造连接记录对象 ConnectionRecord c = new ConnectionRecord(b, activity, connection, flags, clientLabel, clientIntent, callerApp.uid, callerApp.processName, callingPackage); IBinder binder = connection.asBinder(); // 添加到ServiceRecord对象中 s.addConnection(binder, c); b.connections.add(c); if (activity != null) { activity.addConnection(c); } b.client.connections.add(c); c.startAssociationIfNeeded(); } finally { } return 1; } 部分方法的源码 ContextImpl.bindService bindService : (frameworks/base/core/java/android/app/ContextImpl.java)\n@Override public boolean bindService(Intent service, ServiceConnection conn, int flags) { warnIfCallingFromSystemProcess(); return bindServiceCommon(service, conn, flags, null, mMainThread.getHandler(), null, getUser()); } @Override public boolean bindService( Intent service, int flags, Executor executor, ServiceConnection conn) { warnIfCallingFromSystemProcess(); return bindServiceCommon(service, conn, flags, null, null, executor, getUser()); } ContextImpl.bindServiceCommon bindServiceCommon: (frameworks/base/core/java/android/app/ContextImpl.java)\nprivate boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. IServiceConnection sd; if (conn == null) { throw new IllegalArgumentException(\"connection is null\"); } if (handler != null \u0026\u0026 executor != null) { throw new IllegalArgumentException(\"Handler and Executor both supplied\"); } if (mPackageInfo != null) { if (executor != null) { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags); } else { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags); } } else { throw new RuntimeException(\"Not supported in system context\"); } validateServiceIntent(service); try { // WindowContext构造函数中的 WindowTokenClient IBinder token = getActivityToken(); if (token == null \u0026\u0026 (flags\u0026BIND_AUTO_CREATE) == 0 \u0026\u0026 mPackageInfo != null \u0026\u0026 mPackageInfo.getApplicationInfo().targetSdkVersion \u003c android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) { flags |= BIND_WAIVE_PRIORITY; } service.prepareToLeaveProcess(this); int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); if (res \u003c 0) { throw new SecurityException( \"Not allowed to bind to service \" + service); } return res != 0; } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } ActivityManagerService.bindIsolatedService 从这里开始，实际上位于AMS的Server端了，即我们的Activity所在的进程发送了一个启动服务的IPC请求给AMS（sysmte_server进程中）。\nActivityManagerService.java : (frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java)\npublic int bindIsolatedService(IApplicationThread caller, IBinder token, Intent service, String resolvedType, IServiceConnection connection, int flags, String instanceName, String callingPackage, int userId) throws TransactionTooLargeException { // .... synchronized(this) { // 调用Binder接口 return mServices.bindServiceLocked(caller, token, service, resolvedType, connection, flags, instanceName, callingPackage, userId); } } ActiveServices.bindServiceLocked ActiveServices.bindServiceLocked: (frameworks/base/services/core/java/com/android/server/am/ActiveServices.java)\n这个方法有点长，我们截取重要部分\nint bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { // 获取调用方的权限 final int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); final ProcessRecord callerApp = mAm.getRecordForAppLocked(caller); if (callerApp == null) { throw new SecurityException( \"Unable to find app for caller \" + caller + \" (pid=\" + callingPid + \") when binding service \" + service); } ActivityServiceConnectionsHolder\u003cConnectionRecord\u003e activity = null; if (token != null) { activity = mAm.mAtmInternal.getServiceConnectionsHolder(token); if (activity == null) { Slog.w(TAG, \"Binding with unknown activity: \" + token); return 0; } } int clientLabel = 0; PendingIntent clientIntent = null; final boolean isCallerSystem = callerApp.info.uid == Process.SYSTEM_UID; final boolean callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND; final boolean isBindExternal = (flags \u0026 Context.BIND_EXTERNAL_SERVICE) != 0; final boolean allowInstant = (flags \u0026 Context.BIND_ALLOW_INSTANT) != 0; ServiceLookupResult res = retrieveServiceLocked(service, instanceName, resolvedType, callingPackage, callingPid, callingUid, userId, true, callerFg, isBindExternal, allowInstant); if (res == null) { return 0; } if (res.record == null) { return -1; } ServiceRecord s = res.record; try { if (unscheduleServiceRestartLocked(s, callerApp.info.uid, false)) { if (DEBUG_SERVICE) Slog.v(TAG_SERVICE, \"BIND SERVICE WHILE RESTART PENDING: \" + s); } if ((flags\u0026Context.BIND_AUTO_CREATE) != 0) { s.lastActivity = SystemClock.uptimeMillis(); if (!s.hasAutoCreateConnections()) { // This is the first binding, let the tracker know. ServiceState stracker = s.getTracker(); if (stracker != null) { stracker.setBound(true, mAm.mProcessStats.getMemFactorLocked(), s.lastActivity); } } } if ((flags \u0026 Context.BIND_RESTRICT_ASSOCIATIONS) != 0) { mAm.requireAllowedAssociationsLocked(s.appInfo.packageName); } mAm.startAssociationLocked(callerApp.uid, callerApp.processName, callerApp.getCurProcState(), s.appInfo.uid, s.appInfo.longVersionCode, s.instanceName, s.processName); // Once the apps have become associated, if one of them is caller is ephemeral // the target app should now be able to see the calling app mAm.grantImplicitAccess(callerApp.userId, service, callerApp.uid, UserHandle.getAppId(s.appInfo.uid)); AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp); ConnectionRecord c = new ConnectionRecord(b, activity, connection, flags, clientLabel, clientIntent, callerApp.uid, callerApp.processName, callingPackage); IBinder binder = connection.asBinder(); s.addConnection(binder, c); b.connections.add(c); if (activity != null) { activity.addConnection(c); } b.client.connections.add(c); if (s.app != null) { updateServiceClientActivitiesLocked(s.app, c, true); } ArrayList\u003cConnectionRecord\u003e clist = mServiceConnections.get(binder); if (clist == null) { clist = new ArrayList\u003c\u003e(); mServiceConnections.put(binder, clist); } clist.add(c); if ((flags\u0026Context.BIND_AUTO_CREATE) != 0) { s.lastActivity = SystemClock.uptimeMillis(); if (bringUpServiceLocked(s, service.getFlags(), callerFg, false, permissionsReviewRequired) != null) { return 0; } } if (s.app != null \u0026\u0026 b.intent.received) { // Service is already running, so we can immediately // publish the connection. try { c.conn.connected(s.name, b.intent.binder, false); } catch (Exception e) { Slog.w(TAG, \"Failure sending service \" + s.shortInstanceName + \" to connection \" + c.conn.asBinder() + \" (in \" + c.binding.client.processName + \")\", e); } } else if (!b.intent.requested) { requestServiceBindingLocked(s, b.intent, callerFg, false); } } finally { } return 1; } ActiveServices.realStartServiceLocked /** * Note the name of this method should not be confused with the started services concept. * The \"start\" here means bring up the instance in the client, and this method is called * from bindService() as well. */ private final void realStartServiceLocked(ServiceRecord r, ProcessRecord app, boolean execInFg) throws RemoteException { if (app.thread == null) { throw new RemoteException(); } r.setProcess(app); r.restartTime = r.lastActivity = SystemClock.uptimeMillis(); // 创建服务 final boolean newService = app.startService(r); bumpServiceExecutingLocked(r, execInFg, \"create\"); mAm.updateLruProcessLocked(app, false, null); updateServiceForegroundLocked(r.app, /* oomAdj= */ false); mAm.updateOomAdjLocked(app, OomAdjuster.OOM_ADJ_REASON_START_SERVICE); boolean created = false; try { app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE); // 创建服务 app.thread.scheduleCreateService(r, r.serviceInfo, mAm.compatibilityInfoForPackage(r.serviceInfo.applicationInfo), app.getReportedProcState()); r.postNotification(); created = true; } catch (DeadObjectException e) { Slog.w(TAG, \"Application dead when creating service \" + r); mAm.appDiedLocked(app, \"Died when creating service\"); throw e; } finally { // } // 绑定服务 requestServiceBindingsLocked(r, execInFg); updateServiceClientActivitiesLocked(app, null, true); if (newService \u0026\u0026 created) { app.addBoundClientUidsOfNewService(r); } // If the service is in the started state, and there are no // pending arguments, then fake up one so its onStartCommand() will // be called. if (r.startRequested \u0026\u0026 r.callStart \u0026\u0026 r.pendingStarts.size() == 0) { r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(), null, null, 0)); } sendServiceArgsLocked(r, execInFg, true); } ","wordCount":"13807","inLanguage":"zh-cn","datePublished":"2021-04-12T10:18:50Z","dateModified":"2021-04-12T10:18:50Z","author":{"@type":"Person","name":"野生莲藕"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/"},"publisher":{"@type":"Organization","name":"清水池塘","logo":{"@type":"ImageObject","url":"https://hanlyjiang.github.io/img/home.png"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hanlyjiang.github.io/ accesskey=h title="清水池塘 (Alt + H)"><img src=https://hanlyjiang.github.io/img/home.png alt aria-label=logo height=35>清水池塘</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hanlyjiang.github.io/ title=首页><span><i class='fas fa-home'></i>首页</span></a></li><li><a href=https://hanlyjiang.github.io/archives/ title=归档><span><i class='fas fa-tags'></i>归档</span></a></li><li><a href=https://hanlyjiang.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://hanlyjiang.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hanlyjiang.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://hanlyjiang.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Android bindService流程</h1><div class=post-meta><span title='2021-04-12 10:18:50 +0000 UTC'>2021年4月12日</span>&nbsp;·&nbsp;<span>28 分钟</span>&nbsp;·&nbsp;<span>野生莲藕</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e6%95%b4%e4%bd%93%e5%88%86%e6%9e%90%e4%b8%8e%e6%80%bb%e7%bb%93 aria-label=整体分析与总结>整体分析与总结</a><ul><li><a href=#%e4%b8%bb%e7%ba%bf%e5%9c%b0%e5%9b%be%e4%b8%8e%e9%97%ae%e9%a2%98%e6%8f%90%e5%87%ba aria-label=主线地图与问题提出>主线地图与问题提出</a></li><li><a href=#%e9%97%ae%e9%a2%98%e8%a7%a3%e7%ad%94%e6%b1%87%e6%80%bb aria-label=问题解答汇总>问题解答汇总</a><ul><li><a href=#app%e8%bf%9b%e7%a8%8b%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96ams aria-label=APP进程如何获取AMS？>APP进程如何获取AMS？</a></li><li><a href=#ams%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96applicationthread aria-label=AMS如何获取ApplicationThread？>AMS如何获取ApplicationThread？</a></li><li><a href=#%e6%9c%8d%e5%8a%a1%e5%a6%82%e4%bd%95%e7%bb%91%e5%ae%9a%e6%9c%8d%e5%8a%a1%e5%a6%82%e4%bd%95%e5%90%af%e5%8a%a8%e8%bf%9b%e7%a8%8b%e5%a6%82%e4%bd%95%e5%90%af%e5%8a%a8 aria-label=服务如何绑定？服务如何启动？进程如何启动？>服务如何绑定？服务如何启动？进程如何启动？</a></li></ul></li><li><a href=#%e6%95%b4%e4%bd%93%e6%b5%81%e7%a8%8b%e6%80%bb%e7%bb%93 aria-label=整体流程总结>整体流程总结</a></li></ul></li><li><a href=#%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90%e8%a7%a3%e7%ad%94%e9%97%ae%e9%a2%98 aria-label=详细分析解答问题>详细分析解答问题</a><ul><li><a href=#app%e8%bf%9b%e7%a8%8b%e4%b8%ad%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96ams aria-label=APP进程中如何获取AMS？>APP进程中如何获取AMS？</a><ul><li><a href=#contextimplbindservicecommon aria-label=ContextImpl.bindServiceCommon>ContextImpl.bindServiceCommon</a></li><li><a href=#activitymanagergetservice aria-label=ActivityManager.getService()>ActivityManager.getService()</a></li></ul></li><li><a href=#ams%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96%e5%88%b0-applicatointhread aria-label="AMS如何获取到 ApplicatoinThread？">AMS如何获取到 ApplicatoinThread？</a><ul><li><a href=#applicationthread%e7%9a%84%e6%9d%a5%e6%ba%90 aria-label=ApplicationThread的来源？>ApplicationThread的来源？</a></li><li><a href=#applicationthread%e5%9c%a8bind%e6%b5%81%e7%a8%8b%e4%b8%ad%e7%9a%84%e4%bd%bf%e7%94%a8 aria-label=ApplicationThread在bind流程中的使用>ApplicationThread在bind流程中的使用</a><ul><li><a href=#activeservicesbindservicelocked aria-label=ActiveServices.bindServiceLocked>ActiveServices.bindServiceLocked</a></li><li><a href=#servicerecordapp-%e7%9a%84%e8%b5%8b%e5%80%bc aria-label="ServiceRecord.app 的赋值">ServiceRecord.app 的赋值</a></li></ul></li></ul></li><li><a href=#%e6%9c%8d%e5%8a%a1%e5%a6%82%e4%bd%95%e7%bb%91%e5%ae%9a%e6%9c%8d%e5%8a%a1%e5%a6%82%e4%bd%95%e5%90%af%e5%8a%a8%e8%bf%9b%e7%a8%8b%e5%a6%82%e4%bd%95%e5%90%af%e5%8a%a8-1 aria-label=服务如何绑定？服务如何启动？进程如何启动？>服务如何绑定？服务如何启动？进程如何启动？</a></li><li><a href=#%e8%bf%9b%e7%a8%8b%e5%88%9b%e5%bb%ba aria-label=进程创建>进程创建</a><ul><li><a href=#%e6%9e%84%e9%80%a0processrecord%e5%ae%9e%e4%be%8b aria-label=构造ProcessRecord实例>构造ProcessRecord实例</a></li><li><a href=#%e5%90%af%e5%8a%a8%e8%bf%9b%e7%a8%8b aria-label=启动进程>启动进程</a></li><li><a href=#%e8%ae%b0%e5%bd%95%e8%bf%9b%e7%a8%8b%e8%ae%b0%e5%bd%95%e5%88%b0ams aria-label=记录进程记录到AMS>记录进程记录到AMS</a></li><li><a href=#%e5%86%99%e5%85%a5thread%e5%80%bc%e5%88%b0processrecord aria-label=写入thread值到ProcessRecord>写入thread值到ProcessRecord</a><ul><li><a href=#activitythreadmain aria-label=ActivityThread#main>ActivityThread#main</a></li><li><a href=#activitythreadattach aria-label=ActivityThread#attach>ActivityThread#attach</a></li><li><a href=#activitymanagerserviceattachapplication--attachapplicationlocked aria-label="ActivityManagerService#attachApplication & attachApplicationLocked">ActivityManagerService#attachApplication & attachApplicationLocked</a></li></ul></li></ul></li><li><a href=#%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1 aria-label=启动服务>启动服务</a><ul><li><a href=#activeservicesbringupservicelocked aria-label=ActiveServices#bringUpServiceLocked>ActiveServices#bringUpServiceLocked</a></li><li><a href=#%e7%8b%ac%e7%ab%8b%e8%bf%9b%e7%a8%8b%e4%bd%95%e6%97%b6%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1 aria-label=独立进程何时启动服务？>独立进程何时启动服务？</a></li><li><a href=#activitythreadhandlecreateservice aria-label=ActivityThread#handleCreateService>ActivityThread#handleCreateService</a></li></ul></li><li><a href=#%e7%bb%91%e5%ae%9a%e6%9c%8d%e5%8a%a1 aria-label=绑定服务>绑定服务</a><ul><li><a href=#%e8%bf%9e%e6%8e%a5%e5%af%b9%e8%b1%a1%e5%8e%bb%e5%93%aa%e9%87%8c%e4%ba%86 aria-label=连接对象去哪里了？>连接对象去哪里了？</a></li><li><a href=#iserviceconnection%e8%af%b4%e6%98%8e aria-label=IServiceConnection说明>IServiceConnection说明</a></li><li><a href=#activitythreadhandlebindservice aria-label=ActivityThread#handleBindService>ActivityThread#handleBindService</a></li><li><a href=#activitymanagerservicepublishservice aria-label=ActivityManagerService#publishService>ActivityManagerService#publishService</a></li><li><a href=#activeservicespublishservicelocked aria-label=ActiveServices#publishServiceLocked>ActiveServices#publishServiceLocked</a></li><li><a href=#%e6%9e%84%e9%80%a0-connectionrecord---bindservicelocked aria-label="构造 ConnectionRecord - bindServiceLocked">构造 ConnectionRecord - bindServiceLocked</a></li></ul></li></ul></li><li><a href=#%e9%83%a8%e5%88%86%e6%96%b9%e6%b3%95%e7%9a%84%e6%ba%90%e7%a0%81 aria-label=部分方法的源码>部分方法的源码</a><ul><li><a href=#contextimplbindservice aria-label=ContextImpl.bindService>ContextImpl.bindService</a></li><li><a href=#contextimplbindservicecommon-1 aria-label=ContextImpl.bindServiceCommon>ContextImpl.bindServiceCommon</a></li><li><a href=#activitymanagerservicebindisolatedservice aria-label=ActivityManagerService.bindIsolatedService>ActivityManagerService.bindIsolatedService</a></li><li><a href=#activeservicesbindservicelocked-1 aria-label=ActiveServices.bindServiceLocked>ActiveServices.bindServiceLocked</a></li><li><a href=#activeservicesrealstartservicelocked aria-label=ActiveServices.realStartServiceLocked>ActiveServices.realStartServiceLocked</a></li></ul></li></ul></div></details></div><div class=post-content><p>本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；</p><p><strong>预先知识：</strong></p><ul><li>Binder通信机制</li></ul><h2 id=整体分析与总结>整体分析与总结<a hidden class=anchor aria-hidden=true href=#整体分析与总结>#</a></h2><h3 id=主线地图与问题提出>主线地图与问题提出<a hidden class=anchor aria-hidden=true href=#主线地图与问题提出>#</a></h3><p>我们从bindService一路跟踪，初步绘制了如下的调用序列图，我们可以以下面的图作为一个主线地图，避免走失，然后根据具体问题进行细节分析。</p><svg width="812" height="553" viewBox="0 0 812 553" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Android源码分析" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="bindService流程分析-加入启动流程" transform="translate(-94.000000, -222.000000)"><g id="架构图/模块-源码" transform="translate(125.000000, 273.000000)"><rect id="矩形" stroke="#979797" stroke-width=".870292887" fill="#E4E4E4" x=".435146444" y=".435146444" width="298.528768" height="33.1297071" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="87.4814217" y="14">Context.bindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="33.3413714" y="30.122449">frameworks/base/core/java/android/content/Context.java</tspan></text></g><g id="架构图/模块-源码备份" transform="translate(125.000000, 322.000000)"><rect id="矩形" stroke="#979797" stroke-width=".870292887" fill="#E4E4E4" x=".435146444" y=".435146444" width="298.528768" height="33.1297071" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="73.439246" y="14">ContextImpl.bindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="32.0315806" y="30.122449">frameworks/base/core/java/android/app/ContextImpl.java</tspan></text></g><g id="架构图/模块-源码备份-2" transform="translate(125.000000, 373.000000)"><rect id="矩形" stroke="#979797" stroke-width=".870292887" fill="#E4E4E4" x=".435146444" y=".435146444" width="298.528768" height="33.1297071" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="45.7569699" y="14">ContextImpl.bindServiceCommon</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="32.0315806" y="30.122449">frameworks/base/core/java/android/app/ContextImpl.java</tspan></text></g><g id="架构图/模块-源码备份-3" transform="translate(125.000000, 422.000000)"><rect id="矩形" stroke="#979797" stroke-width=".870292887" fill="#E4E4E4" x=".435146444" y=".435146444" width="298.528768" height="33.1297071" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="35.1872627" y="14">IActivityManager.bindIsolatedService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="80.4068108" y="30.122449">android/app/IActivityManager.java</tspan></text></g><g id="架构图/模块-源码备份-4" transform="translate(523.000000, 273.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="14.2367021" y="14">ActivityManagerService.bindIsolatedService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="44.0851371" y="30.122449">com/android/server/am/ActivityManagerService.java</tspan></text></g><g id="架构图/模块-源码备份-5" transform="translate(523.000000, 322.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="45.2025933" y="14">ActiveServices.bindServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><g id="架构图/模块-源码备份-16" transform="translate(523.000000, 422.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="25.0439991" y="14">IApplicationThread.scheduleBindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="75.1632961" y="30.122449">android/app/IApplicationThread.java</tspan></text></g><g id="架构图/模块-源码备份-17" transform="translate(523.000000, 482.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="102.802928" y="14">Binder.transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="136.553756" y="30.122449">binder</tspan></text></g><g id="架构图/模块-源码备份-18" transform="translate(440.000000, 273.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="63.3004695" height="182" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="10.224946" y="14">Binder.</tspan><tspan x="6.77075357" y="32">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="19.0044607" y="118.306122">binder</tspan></text></g><g id="架构图/模块-源码备份-18" transform="translate(440.000000, 537.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="63.3004695" height="182" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="10.224946" y="14">Binder.</tspan><tspan x="6.77075357" y="32">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="19.0044607" y="118.306122">binder</tspan></text></g><g id="架构图/模块-源码备份-10" transform="translate(522.000000, 537.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="27.1213883" y="14">ApplicationThread.scheduleBindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="28.0238818" y="30.122449">frameworks/base/core/java/android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-12" transform="translate(522.000000, 587.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="43.344518" y="14">ActivityThread#handleBindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="28.0238818" y="30.122449">frameworks/base/core/java/android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-19" transform="translate(522.000000, 637.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="63.1680494" y="14">IBinder = Service.onBinder()</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="104.313756" y="30.122449">自定义的Service实现类</tspan></text></g><g id="架构图/模块-源码备份-20" transform="translate(522.000000, 686.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="48.7055222" y="14">IActivityManager#publishService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="80.4068108" y="30.122449">android/app/IActivityManager.java</tspan></text></g><g id="架构图/模块-源码备份-21" transform="translate(125.000000, 537.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="28.303246" y="14">ActivityManagerService#publishService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="80.4068108" y="30.122449">android/app/IActivityManager.java</tspan></text></g><g id="架构图/模块-源码备份-23" transform="translate(125.000000, 587.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="34.5841498" y="14">ActiveServices#publishServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><g id="架构图/模块-源码备份-51" transform="translate(125.000000, 638.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="54.5477983" y="14">IServiceConnection#connected</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="148.202627" y="30.122449">-</tspan></text></g><g id="架构图/模块-源码备份-8" transform="translate(523.000000, 373.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="12.0131038" y="14">ActiveServices.requestServiceBindingLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><g id="架构图/模块-源码备份-13" transform="translate(347.000000, 222.000000)"><rect id="矩形" stroke="#979797" stroke-width=".870292887" fill="#E4E4E4" x=".435146444" y=".435146444" width="74.4818198" height="33.1297071" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="5.9181986" y="14">APP-client</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="20.8532948" y="30.122449">APP进程</tspan></text></g><g id="架构图/模块-源码备份-14" transform="translate(830.000000, 222.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="74.3521127" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="2.77470069" y="14">AMS-server</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="5.78852492" y="30.122449">system_process</tspan></text></g><g id="架构图/模块-源码备份-14" transform="translate(347.000000, 740.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="74.3521127" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="2.77470069" y="14">AMS-server</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="5.78852492" y="30.122449">system_process</tspan></text></g><g id="架构图/模块-源码备份-15" transform="translate(830.000000, 741.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="74.3521127" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="4.04184714" y="14">APP:server</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="5.24894333" y="30.122449">APP Service进程</tspan></text></g><path id="直线-16" d="M811.41934 230.797071C811.613811 230.797071 811.805612 230.843224 811.979552 230.931875l18.49438 9.425906C831.092725 240.673158 831.343541 241.440147 831.034144 242.0709 830.912931 242.318011 830.716358 242.518383 830.473932 242.641939l-18.49438 9.425906C811.360759 252.383221 810.608312 252.127558 810.298915 251.496806 810.211945 251.319504 810.166667 251.123996 810.166667 250.925766L810.166 243.24 423 243.240586C422.038701 243.240586 421.259414 242.461299 421.259414 241.5 421.259414 240.586766 421.962721 239.837798 422.857245 239.765184L423 239.759414 810.166 239.759 810.166667 232.073954C810.166667 231.412826 810.659593 230.869053 811.291261 230.803664z" fill-opacity=".56105479" fill="#C9C9C9" fill-rule="nonzero"/><path id="直线-16备份-2" d="M441.58066 746.797071C442.272493 746.797071 442.833333 747.368751 442.833333 748.073954L442.833 755.759 830 755.759414C830.961299 755.759414 831.740586 756.538701 831.740586 757.5 831.740586 758.413234 831.037279 759.162202 830.142755 759.234816L830 759.240586 442.833 759.24 442.833333 766.925766C442.833333 767.074439 442.807864 767.22158 442.758439 767.360657L442.701085 767.496806C442.391688 768.127558 441.639241 768.383221 441.020448 768.067845L422.526068 758.641939C422.283642 758.518383 422.087069 758.318011 421.965856 758.0709 421.656459 757.440147 421.907275 756.673158 422.526068 756.357781L441.020448 746.931875C441.194388 746.843224 441.386189 746.797071 441.58066 746.797071z" fill-opacity=".56105479" fill="#C9C9C9" fill-rule="nonzero"/><path id="直线-16备份" d="M871.5 255.259414C872.413234 255.259414 873.162202 255.962721 873.234816 256.857245L873.240586 257 873.24 721.166 880.926046 721.166667C881.587174 721.166667 882.130947 721.659593 882.196336 722.291261L882.202929 722.41934C882.202929 722.613811 882.156776 722.805612 882.068125 722.979552L872.642219 741.473932C872.326842 742.092725 871.559853 742.343541 870.9291 742.034144 870.681989 741.912931 870.481617 741.716358 870.358061 741.473932L860.932155 722.979552C860.616779 722.360759 860.872442 721.608312 861.503194 721.298915 861.680496 721.211945 861.876004 721.166667 862.074234 721.166667L869.759 721.166 869.759414 257C869.759414 256.038701 870.538701 255.259414 871.5 255.259414z" fill-opacity=".56105479" fill="#C9C9C9" fill-rule="nonzero"/><path id="直线" d="M272.935146 307.012222 272.935 315.997 276.675732 315.997076 272.5 323.997076l-4.17573199999998-8L272.064 315.997 272.064854 307.012222H272.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-2" d="M272.935146 356.012222 272.935 364.997 276.675732 364.997076 272.5 372.997076l-4.17573199999998-8L272.064 364.997 272.064854 356.012222H272.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-3" d="M272.935146 405.012222 272.935 413.997 276.675732 413.997076 272.5 421.997076l-4.17573199999998-8L272.064 413.997 272.064854 405.012222H272.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-17" d="M433.019444 433.324268 441.019444 437.5l-8 4.17573199999998L433.019 437.935 423.989854 437.935146V437.064854L433.019 437.064 433.019444 433.324268z" fill="#979797" fill-rule="nonzero"/><path id="直线-4" d="M516.989899 284.324268 524.989899 288.5l-8 4.17573199999998L516.989 288.935 505.019399 288.935146V288.064854L516.989 288.064 516.989899 284.324268z" fill="#979797" fill-rule="nonzero"/><path id="直线-5" d="M671.935146 307.012222 671.935 315.997 675.675732 315.997076 671.5 323.997076l-4.17573200000004-8L671.064 315.997 671.064854 307.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-6" d="M671.935146 356.012222 671.935 364.997 675.675732 364.997076 671.5 372.997076l-4.17573200000004-8L671.064 364.997 671.064854 356.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-7" d="M671.935146 405.012222 671.935 413.997 675.675732 413.997076 671.5 421.997076l-4.17573200000004-8L671.064 413.997 671.064854 405.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-8" d="M671.935146 454.998187 671.935 473.011 675.675732 473.011111 671.5 481.011111l-4.17573200000004-8L671.064 473.011 671.064854 454.998187H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-9" d="M671.935146 514.990779 671.935 530.018 675.675732 530.018519 671.5 538.018519l-4.17573200000004-8L671.064 530.018 671.064854 514.990779H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-10" d="M671.935146 571.012222 671.935 579.997 675.675732 579.997076 671.5 587.997076l-4.17573200000004-8L671.064 579.997 671.064854 571.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-18" d="M671.935146 621.012222 671.935 629.997 675.675732 629.997076 671.5 637.997076l-4.17573200000004-8L671.064 629.997 671.064854 621.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-11" d="M671.935146 671.012222 671.935 679.997 675.675732 679.997076 671.5 687.997076l-4.17573200000004-8L671.064 679.997 671.064854 671.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-19" d="M511.984127 699.324268 511.984 703.064 522.006575 703.064854V703.935146L511.984 703.935 511.984127 707.675732 503.984127 703.5l8-4.17573200000004z" fill="#979797" fill-rule="nonzero"/><path id="直线-20" d="M431.980556 550.324268 431.98 554.064 441.010146 554.064854V554.935146L431.98 554.935 431.980556 558.675732 423.980556 554.5l8-4.17573200000004z" fill="#979797" fill-rule="nonzero"/><path id="直线-12" d="M272.935146 571.012222 272.935 579.997 276.675732 579.997076 272.5 587.997076l-4.17573199999998-8L272.064 579.997 272.064854 571.012222H272.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-12备份" d="M272.935146 621.012222 272.935 629.997 276.675732 629.997076 272.5 637.997076l-4.17573199999998-8L272.064 629.997 272.064854 621.012222H272.935146z" fill="#979797" fill-rule="nonzero"/><g id="序号" transform="translate(94.000000, 400.000000)"><circle id="椭圆形" stroke="#888" stroke-width="1.3" fill-opacity=".5" fill="#E4E4E4" cx="13" cy="13" r="12.35"/><text id="1" font-family="NotoSansCJKsc-Black, Noto Sans CJK SC" font-size="13" font-weight="800" letter-spacing=".143000009" fill="#020202" fill-opacity=".88378138"><tspan x="8.97" y="17.6">1</tspan></text></g><g id="序号备份" transform="translate(825.000000, 400.000000)"><circle id="椭圆形" stroke="#888" stroke-width="1.3" fill-opacity=".5" fill="#E4E4E4" cx="13" cy="13" r="12.35"/><text id="2" font-family="NotoSansCJKsc-Black, Noto Sans CJK SC" font-size="13" font-weight="800" letter-spacing=".143000009" fill="#020202" fill-opacity=".88378138"><tspan x="8.97" y="17.6">2</tspan></text></g></g></g></svg><p>从上图中，我们提出如下问题：</p><ol><li>bindServiceCommon到IActivityManager的调用中，是如何获取到ActivityManagerService的？</li><li>AMS中如何获取ApplicationThread并与之通讯？<ul><li>ApplicatoinThread的用途？ApplicationThread运行的进程是哪个？</li></ul></li><li>进程如何启动-即AMS如何创建APP:server进程？</li><li>Service如何启动？</li><li>Service如何绑定？<ul><li>ServiceConnection 的回调方法何时使用？</li></ul></li></ol><h3 id=问题解答汇总>问题解答汇总<a hidden class=anchor aria-hidden=true href=#问题解答汇总>#</a></h3><p>我们将相关问题的结论提前到此小节，便于后续从比较抽象的层次上来进行复习及预览；</p><h4 id=app进程如何获取ams>APP进程如何获取AMS？<a hidden class=anchor aria-hidden=true href=#app进程如何获取ams>#</a></h4><ul><li><p>APP进程中通过 <code>ServiceManager.getService(Context.ACTIVITY_SERVICE)</code> 获取的ActivityManagerService的客户端操作代理对象（Proxy）。</p><blockquote><p>该对象位于APP进程中，可以使用此对象（通过Binder进程间通信）来要求（位于system_process中）的ActivityManagerService进行对应的服务操作；</p></blockquote></li></ul><h4 id=ams如何获取applicationthread>AMS如何获取ApplicationThread？<a hidden class=anchor aria-hidden=true href=#ams如何获取applicationthread>#</a></h4><ul><li><p>APP进程在binderSerice时，将自己进程中的ApplicationThread取出，通过Binder机制传递给AMS进程，传递过程中会转换成一个Proxy对象；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>bindIsolatedService</span>(
</span></span><span style=display:flex><span>            mMainThread.<span style=color:#a6e22e>getApplicationThread</span>(), getActivityToken(), service,
</span></span><span style=display:flex><span>            service.<span style=color:#a6e22e>resolveTypeIfNeeded</span>(getContentResolver()),
</span></span><span style=display:flex><span>            sd, flags, instanceName, getOpPackageName(), user.<span style=color:#a6e22e>getIdentifier</span>());
</span></span></code></pre></div></li></ul><h4 id=服务如何绑定服务如何启动进程如何启动>服务如何绑定？服务如何启动？进程如何启动？<a hidden class=anchor aria-hidden=true href=#服务如何绑定服务如何启动进程如何启动>#</a></h4><ul><li><strong>进程启动</strong>：<ul><li>在独立的进程中运行的服务需要先将进程启动，进程的启动是通过APP进程，请求系统进程中的AMS来执行，通过AMS的<code>startProcessLocked</code>方法启动进程，最终会通过socket接口请求zygote进程来启动进程。</li><li>在启动时会指定java的入口点为ActivityThread，即进程启动后会运行ActivityThread的main方法；</li><li>AMS中会记录启动的进程记录（ProcessRecord），对应的ProcessRecord中会记录进程对应的ApplicationThread；</li></ul></li><li><strong>服务启动</strong>：<ul><li>服务的启动需要请求AMS来完成</li><li>启动时需要先通过PID获取要启动到的ProcessRecord，通过ProcessRecord中记录的ApplicationThread来与对应的进程通信。</li><li>AMS通过ApplicationThread来通知对应的进程创建服务，ApplicationThread作为通信的接口，实际上最终会通过ActivityThread的handleCreateService来创建服务的实例；</li><li>服务创建时，是在APP进程（可能是独立的进程）中进行的，需要通过类加载器加载对应的Service的类，同时构造相应的上下文及资源对象等，然后构造对应的实例；</li><li>服务创建成功后，会记录到ActivityThread的一个Service列表中，以便后续管理；</li></ul></li><li><strong>服务绑定</strong>：<ul><li>服务绑定先在APP进程中，通过AMS代理对象发起请求，由AMS来安排bind（<strong>ActivityManagerService.bindIsolatedService</strong>）;</li><li>然后具体的绑定动作还是通过IApplicationThread安排到APP的Service进程中，最终执行的<code>ActivityThread#handleBindService</code>;</li><li>在APP进程中，会将Service取出，然后调用其onBind方法来获取IBinder远程操作对象；</li><li>之后再通过AMS调用 <code>ActivityManagerService#publishService</code> 来通知绑定成功的通知到对应的需要绑定服务的APP进程；</li><li>publishService中会调用ServiceConnection的onServiceConnected方法通知服务连接了；</li></ul></li></ul><h3 id=整体流程总结>整体流程总结<a hidden class=anchor aria-hidden=true href=#整体流程总结>#</a></h3><blockquote><p>待补充</p></blockquote><h2 id=详细分析解答问题>详细分析解答问题<a hidden class=anchor aria-hidden=true href=#详细分析解答问题>#</a></h2><h3 id=app进程中如何获取ams>APP进程中如何获取AMS？<a hidden class=anchor aria-hidden=true href=#app进程中如何获取ams>#</a></h3><blockquote><p>说明：</p><ul><li><p>第一次先逐项查看各个小节，最后再看此处的总结；</p></li><li><p>后续直接查看总结来快速获取结论；</p></li></ul></blockquote><p>==总结：==</p><ul><li>APP进程中通过 <code>ServiceManager.getService(Context.ACTIVITY_SERVICE)</code> 获取的<code>ActivityManagerService</code>的客户端操作代理对象（Proxy）。</li><li>该对象位于APP进程中，可以使用此对象（通过Binder进程间通信）来要求（位于<code>system_process</code>中）的<code>ActivityManagerService</code>进行对应的服务操作；</li></ul><p>具体查看如下代码：</p><h4 id=contextimplbindservicecommon>ContextImpl.bindServiceCommon<a hidden class=anchor aria-hidden=true href=#contextimplbindservicecommon>#</a></h4><p>我们看 <code>ContextImpl.bindServiceCommon</code> 方法的实现，可以看到是调用了 <code>ActivityManager.getService()</code> 获取的；</p><p><code>frameworks/base/core/java/android/app/ContextImpl.java</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>bindServiceCommon</span>(Intent service, ServiceConnection conn, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, Handler handler, Executor executor, UserHandle user) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span>
</span></span><span style=display:flex><span>        IServiceConnection sd;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (executor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            sd <span style=color:#f92672>=</span> mPackageInfo.<span style=color:#a6e22e>getServiceDispatcher</span>(conn, getOuterContext(), executor, flags);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            sd <span style=color:#f92672>=</span> mPackageInfo.<span style=color:#a6e22e>getServiceDispatcher</span>(conn, getOuterContext(), handler, flags);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	    <span style=color:#75715e>//</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>bindIsolatedService</span>(
</span></span><span style=display:flex><span>            mMainThread.<span style=color:#a6e22e>getApplicationThread</span>(), getActivityToken(), service,
</span></span><span style=display:flex><span>            service.<span style=color:#a6e22e>resolveTypeIfNeeded</span>(getContentResolver()),
</span></span><span style=display:flex><span>            sd, flags, instanceName, getOpPackageName(), user.<span style=color:#a6e22e>getIdentifier</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=activitymanagergetservice><code>ActivityManager.getService()</code><a hidden class=anchor aria-hidden=true href=#activitymanagergetservice>#</a></h4><p>如下代码，getService实际上是从ServiceManager获取一个ActivityService的Binder远程服务接口对象，并且这个会被设置为单例模式；</p><p><code>frameworks/base/core/java/android/app/ActivityManager.java</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Singleton<span style=color:#f92672>&lt;</span>IActivityManager<span style=color:#f92672>&gt;</span> IActivityManagerSingleton <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> Singleton<span style=color:#f92672>&lt;</span>IActivityManager<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> IActivityManager <span style=color:#a6e22e>create</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 直接通过 ServiceManager.getService 获取一个IBinder对象</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> IBinder b <span style=color:#f92672>=</span> ServiceManager.<span style=color:#a6e22e>getService</span>(Context.<span style=color:#a6e22e>ACTIVITY_SERVICE</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> IActivityManager am <span style=color:#f92672>=</span> IActivityManager.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(b);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> am;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IActivityManager <span style=color:#a6e22e>getService</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 直接从IActivityManagerSingleton获取实例</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> IActivityManagerSingleton.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ams如何获取到-applicatointhread>AMS如何获取到 ApplicatoinThread？<a hidden class=anchor aria-hidden=true href=#ams如何获取到-applicatointhread>#</a></h3><p>首先，AMS实际上位于系统进程（system_process)，而ApplicationThread则位于我们的APP进程，那么为什么需要这个跨进程的操作呢？</p><ul><li>Service的创建需要经过系统的管理，比方说鉴权及其他管理需要；</li><li>而开发者定义的Service的实例的创建逻辑也还是需要开发者来实现，Service对应的类也应该只加载在开发者自己的进程之中，Service使用方实际上还是开发者自己，所以服务的真实实例的创建过程要在应用的进程中；</li></ul><p>那么，系统进程（中的AMS）如何获取ApplicationThread呢？</p><h4 id=applicationthread的来源>ApplicationThread的来源？<a hidden class=anchor aria-hidden=true href=#applicationthread的来源>#</a></h4><p>查看 <strong>ContextImpl.bindServiceCommon</strong> 的代码，可以看到，是在调用AMS的bindService方法时，将自己进程中的<code>ApplicationThread</code>及<code>ActivityToken</code>取出传递给了AMS服务；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// frameworks/base/core/java/android/app/ContextImpl.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@NonNull</span> ActivityThread mMainThread;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@Nullable</span> IBinder mToken;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> IBinder <span style=color:#a6e22e>getActivityToken</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> mToken;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>bindServiceCommon</span>(Intent service, ServiceConnection conn, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, Handler handler, Executor executor, UserHandle user) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span>
</span></span><span style=display:flex><span>        IServiceConnection sd;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            service.<span style=color:#a6e22e>prepareToLeaveProcess</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用时传递了ApplicationThread和IBinder</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>bindIsolatedService</span>(
</span></span><span style=display:flex><span>                mMainThread.<span style=color:#a6e22e>getApplicationThread</span>(), getActivityToken(), service,
</span></span><span style=display:flex><span>                service.<span style=color:#a6e22e>resolveTypeIfNeeded</span>(getContentResolver()),
</span></span><span style=display:flex><span>                sd, flags, instanceName, getOpPackageName(), user.<span style=color:#a6e22e>getIdentifier</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>&lt;</span> 0) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> SecurityException(
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;Not allowed to bind to service &#34;</span> <span style=color:#f92672>+</span> service);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> res <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> e.<span style=color:#a6e22e>rethrowFromSystemServer</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>实际上，上面的<code>mMainThread.getApplicationThread()</code>取出的是我们的APP进程中的ApplicationThread的服务端对象，然后经过IActivityManager进行binder传输（transact）前，会将其转换为一个Proxy代理对象，用于在AMS中请求我们进程的ApplicationThread来提供服务；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// android.app.IActivityManager.Stub#TRANSACTION_bindIsolatedService </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> TRANSACTION_bindIsolatedService:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          data.<span style=color:#a6e22e>enforceInterface</span>(descriptor);
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span> _arg0;
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 这里将IApplicationThread的服务对象转换成一个Proxy代理对象</span>
</span></span><span style=display:flex><span>          _arg0 <span style=color:#f92672>=</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span>.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(data.<span style=color:#a6e22e>readStrongBinder</span>());
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IBinder</span> _arg1;
</span></span><span style=display:flex><span>          _arg1 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readStrongBinder</span>();
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>Intent</span> _arg2;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> ((0<span style=color:#f92672>!=</span>data.<span style=color:#a6e22e>readInt</span>())) {
</span></span><span style=display:flex><span>            _arg2 <span style=color:#f92672>=</span> android.<span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>Intent</span>.<span style=color:#a6e22e>CREATOR</span>.<span style=color:#a6e22e>createFromParcel</span>(data);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            _arg2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> _arg3;
</span></span><span style=display:flex><span>          _arg3 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readString</span>();
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span> _arg4;
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 同理，这里将IServiceConnection的服务对象也转换成一个Proxy代理对象</span>
</span></span><span style=display:flex><span>          _arg4 <span style=color:#f92672>=</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span>.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(data.<span style=color:#a6e22e>readStrongBinder</span>());
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>int</span> _arg5;
</span></span><span style=display:flex><span>          _arg5 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>          java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> _arg6;
</span></span><span style=display:flex><span>          _arg6 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readString</span>();
</span></span><span style=display:flex><span>          java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> _arg7;
</span></span><span style=display:flex><span>          _arg7 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readString</span>();
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>int</span> _arg8;
</span></span><span style=display:flex><span>          _arg8 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>int</span> _result <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bindIsolatedService</span>(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8);
</span></span><span style=display:flex><span>          reply.<span style=color:#a6e22e>writeNoException</span>();
</span></span><span style=display:flex><span>          reply.<span style=color:#a6e22e>writeInt</span>(_result);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#75715e>// android.app.IApplicationThread.Stub</span>
</span></span><span style=display:flex><span> <span style=color:#75715e>/** Local-side IPC implementation stub class. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stub</span> <span style=color:#66d9ef>extends</span> android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Binder</span> <span style=color:#66d9ef>implements</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> DESCRIPTOR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;android.app.IApplicationThread&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Construct the stub at attach it to the interface. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Stub</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attachInterface</span>(<span style=color:#66d9ef>this</span>, DESCRIPTOR);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Cast an IBinder object into an android.app.IApplicationThread interface,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * generating a proxy if needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span> <span style=color:#a6e22e>asInterface</span>(android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IBinder</span> obj)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ((obj<span style=color:#f92672>==</span><span style=color:#66d9ef>null</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IInterface</span> iin <span style=color:#f92672>=</span> obj.<span style=color:#a6e22e>queryLocalInterface</span>(DESCRIPTOR);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (((iin<span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span>)<span style=color:#f92672>&amp;&amp;</span>(iin <span style=color:#66d9ef>instanceof</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span>))) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ((android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span>)iin);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#75715e>// 这里构造成了Proxy</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span>.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>Proxy</span>(obj);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><blockquote><p>这里我们暂不考虑ApplicationThread由何处而来，每个进程中都对应一个ActivityThread，ActivityThread中有一个ApplicationThread对象。</p></blockquote><h4 id=applicationthread在bind流程中的使用>ApplicationThread在bind流程中的使用<a hidden class=anchor aria-hidden=true href=#applicationthread在bind流程中的使用>#</a></h4><p>我们发现，最终是使用 <code>ApplicationThread</code>的 <code>requestServiceBindingLocked</code> 方法来绑定服务的（<code>r.app.thread.scheduleBindService</code>），我们先梳理一下ServiceRecord类同ApplicationThread的关系；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActiveServices#requestServiceBindingLocked</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>requestServiceBindingLocked</span>(ServiceRecord r, IntentBindRecord i,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> execInFg, <span style=color:#66d9ef>boolean</span> rebind) <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (r.<span style=color:#a6e22e>app</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> r.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>thread</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// If service is not currently running, can&#39;t yet bind.</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 调用ApplicationThread的绑定方法来进行绑定</span>
</span></span><span style=display:flex><span>        r.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>thread</span>.<span style=color:#a6e22e>scheduleBindService</span>(r, i.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>getIntent</span>(), rebind,
</span></span><span style=display:flex><span>                                         r.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>getReportedProcState</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ServiceRecord.java</span>
</span></span><span style=display:flex><span>ProcessRecord app;          <span style=color:#75715e>// where this service is running or null.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java</span>
</span></span><span style=display:flex><span>IApplicationThread thread;  <span style=color:#75715e>// the actual proc...  may be null only if</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// &#39;persistent&#39; is true (in which case we</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>// are in the process of launching the app)</span>
</span></span></code></pre></div><p>其中 <code>ServiceRecord.app</code> 的类型为 <code>ProcessRecord</code> ，<code>ServiceRecord.app.thread</code> 的类型为 <code>IApplicationThread</code>，我们梳理下对应的几个类的关系，如下图：</p><svg width="772" height="493" viewBox="0 0 772 493" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Android源码分析" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="ServiceRecord类图" transform="translate(-31.000000, -33.000000)"><g id="UML/类图/类模块" transform="translate(32.000000, 34.000000)"><g id="名称" transform="translate(-0.284133, 0.000000)"><path d="M214.320588-.5C215.563229-.5 216.688229.00367965644 217.502569.818019485 218.316909 1.63235931 218.820588 2.75735931 218.820588 4V27.4753086H-.179411765V4c0-1.24264069.503679657-2.36764069 1.318019485-3.181980515C1.95294755.00367965644 3.07794755-.5 4.32058824-.5z" id="标题" stroke="#979797" fill="#F4F4F4"/><text id="Class-Name" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="60.4815882" y="16">ServiceRecord</tspan></text></g><g id="属性" transform="translate(0.036455, 26.975309)"><rect stroke="#979797" fill="#F6FFDF" x="-.5" y="-.5" width="219" height="45.0123457"/><text id="Properties" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="6" y="17">app:ProcessRecord</tspan><tspan x="6" y="37">isolatedProc: ProcessRecord</tspan></text></g><g id="方法" transform="translate(0.036455, 70.987654)"><path d="M218.5-.5V40.0123457C218.5 41.2549864 217.99632 42.3799864 217.181981 43.1943262 216.367641 44.008666 215.242641 44.5123457 214 44.5123457H4C2.75735931 44.5123457 1.63235931 44.008666.818019485 43.1943262.00367965644 42.3799864-.5 41.2549864-.5 40.0123457V-.5h219z" stroke="#979797" fill="#FFDFDF"/><text id="Methods" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="5" y="16">+ setProcess(ProcessRecord)</tspan></text></g></g><g id="UML/类图/类模块备份-3" transform="translate(310.000000, 34.000000)"><g id="名称" transform="translate(-0.639952, 0.000000)"><path d="M487.722059-.5C488.9647-.5 490.0897.00367965644 490.904039.818019485 491.718379 1.63235931 492.222059 2.75735931 492.222059 4V39.9074074H.222058824V4c0-1.24264069.503679656-2.36764069 1.318019486-3.181980515C2.35441814.00367965644 3.47941814-.5 4.72205882-.5z" id="标题" stroke="#979797" fill="#F4F4F4"/><text id="Class-Name" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="181.017059" y="16">IApplicationThread</tspan></text></g><g id="属性" transform="translate(0.082107, 39.407407)"><rect stroke="#979797" fill="#F6FFDF" x="-.5" y="-.5" width="492" height="65.2962963"/><text id="Properties" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g><g id="方法" transform="translate(0.082107, 103.703704)"><path d="M491.5-.5V60.2962963C491.5 61.538937 490.99632 62.663937 490.181981 63.4782768 489.367641 64.2926166 488.242641 64.7962963 487 64.7962963H4C2.75735931 64.7962963 1.63235931 64.2926166.818019485 63.4782768.00367965644 62.663937-.5 61.538937-.5 60.2962963V-.5h492z" stroke="#979797" fill="#FFDFDF"/><text id="Methods" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="5" y="16">+ scheduleBindService(IBinder, Intent, boolean rebind, int processState)</tspan><tspan x="5" y="36">+ scheduleCreateService(IBinder, ServiceInfo info,… )</tspan><tspan x="5" y="56">+ bindApplication(…)</tspan></text></g></g><g id="UML/类图/类模块备份-4" transform="translate(310.000000, 264.000000)"><g id="名称" transform="translate(-0.311504, 0.000000)"><path d="M235.351471-.5C236.594111-.5 237.719111.00367965644 238.533451.818019485 239.347791 1.63235931 239.851471 2.75735931 239.851471 4V25.3641975H-.148529412V4c0-1.24264069.503679657-2.36764069 1.318019482-3.181980515C1.9838299.00367965644 3.1088299-.5 4.35147059-.5z" id="标题" stroke="#979797" fill="#F4F4F4"/><text id="Class-Name" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="36.6004705" y="16">IApplicationThread.Stub</tspan></text></g><g id="属性" transform="translate(0.039967, 24.864198)"><rect stroke="#979797" fill="#F6FFDF" x="-.5" y="-.5" width="240" height="41.5679012"/><text id="Properties" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g><g id="方法" transform="translate(0.039967, 65.432099)"><path d="M239.5-.5V36.5679012C239.5 37.8105419 238.99632 38.9355419 238.181981 39.7498817 237.367641 40.5642216 236.242641 41.0679012 235 41.0679012H4c-1.24264069.0-2.36764069-.503679599999998-3.181980515-1.3180195C.00367965644 38.9355419-.5 37.8105419-.5 36.5679012V-.5h240z" stroke="#979797" fill="#FFDFDF"/><text id="Methods" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g></g><g id="UML/类图/类模块备份-5" transform="translate(310.000000, 419.000000)"><g id="名称" transform="translate(-0.311504, 0.000000)"><path d="M235.351471-.5C236.594111-.5 237.719111.00367965644 238.533451.818019485 239.347791 1.63235931 239.851471 2.75735931 239.851471 4V25.3641975H-.148529412V4c0-1.24264069.503679657-2.36764069 1.318019482-3.181980515C1.9838299.00367965644 3.1088299-.5 4.35147059-.5z" id="标题" stroke="#979797" fill="#F4F4F4"/><text id="Class-Name" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="56.8864705" y="16">ApplicationThread</tspan></text></g><g id="属性" transform="translate(0.039967, 24.864198)"><rect stroke="#979797" fill="#F6FFDF" x="-.5" y="-.5" width="240" height="41.5679012"/><text id="Properties" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g><g id="方法" transform="translate(0.039967, 65.432099)"><path d="M239.5-.5V36.5679012C239.5 37.8105419 238.99632 38.9355419 238.181981 39.7498817 237.367641 40.5642216 236.242641 41.0679012 235 41.0679012H4c-1.24264069.0-2.36764069-.503679599999998-3.181980515-1.3180195C.00367965644 38.9355419-.5 37.8105419-.5 36.5679012V-.5h240z" stroke="#979797" fill="#FFDFDF"/><text id="Methods" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g></g><g id="UML/类图/类模块备份" transform="translate(32.000000, 183.000000)"><g id="名称" transform="translate(-0.284133, 0.000000)"><path d="M214.320588-.5C215.563229-.5 216.688229.00367965644 217.502569.818019485 218.316909 1.63235931 218.820588 2.75735931 218.820588 4V27.4753086H-.179411765V4c0-1.24264069.503679657-2.36764069 1.318019485-3.181980515C1.95294755.00367965644 3.07794755-.5 4.32058824-.5z" id="标题" stroke="#979797" fill="#F4F4F4"/><text id="Class-Name" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="59.2005882" y="16">ProcessRecord</tspan></text></g><g id="属性" transform="translate(0.036455, 26.975309)"><rect stroke="#979797" fill="#F6FFDF" x="-.5" y="-.5" width="219" height="45.0123457"/><text id="Properties" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="6" y="17">thread:IApplicationThread</tspan><tspan x="6" y="37">pid: int</tspan></text></g><g id="方法" transform="translate(0.036455, 70.987654)"><path d="M218.5-.5V40.0123457C218.5 41.2549864 217.99632 42.3799864 217.181981 43.1943262 216.367641 44.008666 215.242641 44.5123457 214 44.5123457H4C2.75735931 44.5123457 1.63235931 44.008666.818019485 43.1943262.00367965644 42.3799864-.5 41.2549864-.5 40.0123457V-.5h219z" stroke="#979797" fill="#FFDFDF"/><text id="Methods" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g></g><g id="UML/类图/类模块备份-2" transform="translate(32.000000, 332.000000)"><g id="名称" transform="translate(-0.284133, 0.000000)"><path d="M214.320588-.5C215.563229-.5 216.688229.00367965644 217.502569.818019485 218.316909 1.63235931 218.820588 2.75735931 218.820588 4V27.4753086H-.179411765V4c0-1.24264069.503679657-2.36764069 1.318019485-3.181980515C1.95294755.00367965644 3.07794755-.5 4.32058824-.5z" id="标题" stroke="#979797" fill="#F4F4F4"/><text id="Class-Name" font-family="NotoSansCJKsc-Medium, Noto Sans CJK SC" font-size="14" font-weight="400" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="59.6275882" y="16">ActivityThread</tspan></text></g><g id="属性" transform="translate(0.036455, 26.975309)"><rect stroke="#979797" fill="#F6FFDF" x="-.5" y="-.5" width="219" height="45.0123457"/><text id="Properties" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005" fill="#020202" fill-opacity=".88378138"><tspan x="6" y="17">mAppThread:ApplicationThread</tspan></text></g><g id="方法" transform="translate(0.036455, 70.987654)"><path d="M218.5-.5V40.0123457C218.5 41.2549864 217.99632 42.3799864 217.181981 43.1943262 216.367641 44.008666 215.242641 44.5123457 214 44.5123457H4C2.75735931 44.5123457 1.63235931 44.008666.818019485 43.1943262.00367965644 42.3799864-.5 41.2549864-.5 40.0123457V-.5h219z" stroke="#979797" fill="#FFDFDF"/><text id="Methods" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="14" font-weight="300" letter-spacing=".154000005"/></g></g><g id="UML/类图/线条/聚合" transform="translate(132.000000, 149.000000)"><path id="直线-24" d="M4.01066824 9.66098325 5.01044532 9.68209681 4.99988854 10.1819853 4.65783637 26.3789701 4.529 32.448l3.69783349-6.2579751L8.4811105 25.7595099l.86103009.508554L9.08786358 26.6985789 4.41995827 34.6017846 3.96791026 35.3671447 3.54857702 34.5833825-.781511421 26.4901549-1.01738637 26.0492887-.135653962 25.5775388.100220985 26.018405 3.529 32.428l.12905929-6.0701435.34205217-16.1969847L4.01066824 9.66098325z" fill="#979797" fill-rule="nonzero"/><path d="M4.5065476.824414956 8.13197663 5.5 4.5065476 10.175585.998600008 5.5 4.5065476.824414956z" id="多边形" stroke="#979797"/></g><g id="编组" transform="translate(277.500000, 162.500000)" fill="#979797"><g id="UML/类图/线条/组合" transform="translate(2.500000, 29.500000) rotate(-90.000000) translate(-2.500000, -29.500000)"><path id="直线-24" d="M2.00288144 9.84713507 3.00286493 9.85288144 2.99999174 10.3528732 2.76527988 51.1974318 2.73 57.282l3.60087375-6.3147594L6.57850452 50.5328687 7.44724844 51.0281302 7.19961767 51.4625022 2.653721 59.4365114 2.21348852 60.2087282 1.78215985 59.431503-2.67179488 51.4057764-2.91441726 50.9685872-2.04003889 50.4833425-1.79741651 50.9205317 1.73 57.276 1.76529639 51.1916854l.23471187-40.8445586L2.00288144 9.84713507z" fill-rule="nonzero"/><polygon id="多边形" stroke="#979797" points="2.46928974 0 6.73396667 5.5 2.46928974 11 -1.65719103 5.5"/></g></g><g id="编组" transform="translate(278.500000, 402.500000)" fill="#979797"><g id="UML/类图/线条/组合" transform="translate(2.500000, 29.500000) rotate(-90.000000) translate(-2.500000, -29.500000)"><path id="直线-24" d="M2.00288144 9.84713507 3.00286493 9.85288144 2.99999174 10.3528732 2.76527988 51.1974318 2.73 57.282l3.60087375-6.3147594L6.57850452 50.5328687 7.44724844 51.0281302 7.19961767 51.4625022 2.653721 59.4365114 2.21348852 60.2087282 1.78215985 59.431503-2.67179488 51.4057764-2.91441726 50.9685872-2.04003889 50.4833425-1.79741651 50.9205317 1.73 57.276 1.76529639 51.1916854l.23471187-40.8445586L2.00288144 9.84713507z" fill-rule="nonzero"/><polygon id="多边形" stroke="#979797" points="2.46928974 0 6.73396667 5.5 2.46928974 11 -1.65719103 5.5"/></g></g><g id="UML/类图/线条/实现" transform="translate(425.000000, 202.000000)" stroke="#979797"><line x1="4.5" y1="61.6653117" x2="4.5" y2="7.44579946" id="直线-24" stroke-linecap="square" stroke-dasharray="2"/><path d="M4.5.218033989 7.69098301 6.6H1.30901699L4.5.218033989z" id="三角形"/></g><g id="UML/类图/线条/继承" transform="translate(430.000000, 370.000000)" stroke="#979797"><line x1="4.5" y1="48.7469136" x2="4.5" y2="8" id="直线-24" stroke-linecap="square"/><path d="M4.5 1.11803399 7.69098301 7.5H1.30901699L4.5 1.11803399z" id="三角形"/></g></g></g></svg><p>现在我们看下 ServiceRecord 是何时构造的，首先，根据方法的调用层次，我们可以看到：</p><ul><li><code>ActiveServices.bindServiceLocked</code> 方法中，参数中没有ServiceRecord，有的是IApplicationThread及一个IBinder。</li><li><code>ActiveServices.requestServiceBindingLocked</code> 方法中，则变成了ServiceRecord类型。</li></ul><p><img alt=image-20210410215833909 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410215833.png></p><blockquote><p>提示：上述调用层次可以在IDEA中选中<code>ActiveServices.requestServiceBindingLocked</code>方法，然后通过“<strong>Navigate｜Call Hierarchy</strong>”（快捷键为==ctrl+opt+H==）弹出。</p></blockquote><p>所以，接下来我们看下 <code>ActiveServices.bindServiceLocked</code> 方法如何将<code>ApplicationThread</code>存入到<code>ServiceRecord</code>对象中。</p><h5 id=activeservicesbindservicelocked>ActiveServices.bindServiceLocked<a hidden class=anchor aria-hidden=true href=#activeservicesbindservicelocked>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>bindServiceLocked</span>(IApplicationThread caller, IBinder token, Intent service,
</span></span><span style=display:flex><span>            String resolvedType, <span style=color:#66d9ef>final</span> IServiceConnection connection, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, String callingPackage, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> userId)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingPid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingPid</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingUid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingUid</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里获取了 ProcessRecord</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ProcessRecord callerApp <span style=color:#f92672>=</span> mAm.<span style=color:#a6e22e>getRecordForAppLocked</span>(caller);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> callerFg <span style=color:#f92672>=</span> callerApp.<span style=color:#a6e22e>setSchedGroup</span> <span style=color:#f92672>!=</span> ProcessList.<span style=color:#a6e22e>SCHED_GROUP_BACKGROUND</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isBindExternal <span style=color:#f92672>=</span> (flags <span style=color:#f92672>&amp;</span> Context.<span style=color:#a6e22e>BIND_EXTERNAL_SERVICE</span>) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> allowInstant <span style=color:#f92672>=</span> (flags <span style=color:#f92672>&amp;</span> Context.<span style=color:#a6e22e>BIND_ALLOW_INSTANT</span>) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将IApplicationThread及IBinder放入到ServiceRecord中的过程在retrieveServiceLocked中</span>
</span></span><span style=display:flex><span>        ServiceLookupResult res <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            retrieveServiceLocked(service, instanceName, resolvedType, callingPackage,
</span></span><span style=display:flex><span>                    callingPid, callingUid, userId, <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                    callerFg, isBindExternal, allowInstant);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 此处获取ServiceRecord，故在上面</span>
</span></span><span style=display:flex><span>        ServiceRecord s <span style=color:#f92672>=</span> res.<span style=color:#a6e22e>record</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (s.<span style=color:#a6e22e>app</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> b.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>received</span>) {
</span></span><span style=display:flex><span>            requestServiceBindingLocked(s, b.<span style=color:#a6e22e>intent</span>, callerFg, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>b.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>requested</span>) {
</span></span><span style=display:flex><span>            requestServiceBindingLocked(s, b.<span style=color:#a6e22e>intent</span>, callerFg, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 1;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>到这里，我们可以发现ServiceRecord是通过<code>retrieveServiceLocked</code>方法获取到的<code>ServiceLookupResult</code>获取到的。</p><p>==粗略看了下这个<code>retrieveServiceLocked</code>方法，其中逻辑比较多，我们这里转换下思路，直接查找 <code>ServiceRecord.app</code> 的赋值操作==。</p><h5 id=servicerecordapp-的赋值><code>ServiceRecord.app</code> 的赋值<a hidden class=anchor aria-hidden=true href=#servicerecordapp-的赋值>#</a></h5><p>我们可以找到ServiceRecord.app（ProcessRecord）的赋值操作的调用方法为：<code>com.android.server.am.ActiveServices#realStartServiceLocked</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>realStartServiceLocked</span>(ServiceRecord r,
</span></span><span style=display:flex><span>            ProcessRecord app, <span style=color:#66d9ef>boolean</span> execInFg) <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app.<span style=color:#a6e22e>thread</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemoteException();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    	<span style=color:#75715e>// 在此处赋值</span>
</span></span><span style=display:flex><span>        r.<span style=color:#a6e22e>setProcess</span>(app);
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>查看 <code>realStartServiceLocked</code> 的调用序列：</p><img src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410224824.png alt=image-20210410224824691 style=zoom:50%><p>也就是又回到了我们的 <code>bindServiceLocked</code> 方法，其中有一段逻辑是，如果需要创建服务，就执行 <code>bringUpServiceLocked</code> 方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActiveServices#bindServiceLocked   </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>bindServiceLocked</span>(IApplicationThread caller, IBinder token, Intent service,
</span></span><span style=display:flex><span>            String resolvedType, <span style=color:#66d9ef>final</span> IServiceConnection connection, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, String callingPackage, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> userId)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> TransactionTooLargeException {   
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... </span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> ((flags<span style=color:#f92672>&amp;</span>Context.<span style=color:#a6e22e>BIND_AUTO_CREATE</span>) <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>                s.<span style=color:#a6e22e>lastActivity</span> <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (bringUpServiceLocked(s, service.<span style=color:#a6e22e>getFlags</span>(), callerFg, <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>                        permissionsReviewRequired) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... </span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>也就是说，在绑定服务的时候，如果服务没有创建，就先使用<code>bringUpServiceLocked</code>-<code>realStartServiceLocked</code> 进行创建，创建过程中会将ServiceRecord中的app赋值，然后存储起来；</p><blockquote><p>提示：我们可以通过如下IDEA操作来查找赋值操作</p><ol><li><p>选中成员（这里是 app）；</p></li><li><p>==Ctrl+B== 或者 ==Command+鼠标单击==，弹出使用列表弹窗；</p></li><li><p>然后在弹窗中设置仅查看write访问操作的；然后我们可以找到对应的赋值代码行；</p><img src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410223230.png alt=image-20210410223230694 style=zoom:50%></li><li><p>通过勾选其中的方法图标，我们可以显示赋值的代码行所在的方法（这里是setProcess）；</p><img src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410223820.png alt=image-20210410223820657 style=zoom:50%></li><li><p>然后我们继续在方法上执行上述操作，可以获取到更加上一步的赋值调用在哪；</p><img src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410224023.png alt=image-20210410224023641 style=zoom:50%></li></ol></blockquote><h3 id=服务如何绑定服务如何启动进程如何启动-1>服务如何绑定？服务如何启动？进程如何启动？<a hidden class=anchor aria-hidden=true href=#服务如何绑定服务如何启动进程如何启动-1>#</a></h3><ol><li><strong>bringUpServiceLocked(ServiceRecord r,&mldr;)</strong> 第一个参数为ServiceRecord，其中的app属性可存储一个进程记录；</li><li>如传入的ServiceRecord参数中表明服务已经启动过，<code>r.app(ProcessRecord)</code> 不为null，且<code>r.app.thread(IApplicationThread)</code>也不为null，则不创建，直接更新参数；</li><li>结下来，则分为两种情况，1）服务为声明单独的进程，则可直接在当前进程中启动；2）服务声明了单独的进程，则需要先启动进程，然后再启动服务；</li><li><strong>非单独进程</strong>：<ul><li>进程记录获取：通过AMS直接查询，并未创建，因为进程已经存在了，具体代码为 <code>app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false)</code></li><li>服务启动：使用 <code>realStartServiceLocked(r, app, execInFg);</code> 方法启动</li></ul></li><li><strong>单独进程</strong>：<ul><li>进程记录获取： 通过AMS.mAm.startProcessLocked 方法启动一个新的进程；<ul><li><code>app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags, hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false)</code></li></ul></li><li>服务启动：未在此方法中直接调用 <code>realStartServiceLocked</code></li></ul></li></ol><p>这里我们可以看到，在<strong>单独进程</strong>的服务启动流程中，并没有即时调用<code>realStartServiceLocked</code>来启动服务，那么这里就又个问题，独立进程情况下服务何时启动？</p><ol start=6><li><strong>单独进程服务启动：</strong> 将待启动的服务加入到<code>mPendingServices(ArrayList&lt;ServiceRecord>)</code>，在启动进程后再从此列表中读取需要启动的服务，然后启动；</li></ol><p><strong>总结：</strong></p><ol><li><p>进程记录如何获取？</p><ul><li>通过AMS的 <code>startProcessLocked</code> 方法创建（非独立进程的也应该是通过此方法创建，只是创建时机不是这里）</li></ul></li><li><p>服务如何启动？</p><ul><li><p>通过 <code>realStartServiceLocked</code> 方法启动（独立进程的应该也是此方法启动，会等到进程启动之后再启动）</p></li><li><blockquote><p><code>realStartServiceLocked</code> 中通过 <code>IApplicationThread</code> 执行 <code>scheduleCreateService</code> 来启动服务，最终调用 <code>android.app.ActivityThread.ApplicationThread#scheduleCreateService</code>来启动；</p></blockquote></li></ul></li></ol><h3 id=进程创建>进程创建<a hidden class=anchor aria-hidden=true href=#进程创建>#</a></h3><blockquote><p>问题：</p><ol><li>进程何时创建？- 已解决</li><li>ApplicationThread（代理）对象何时设置到ProcessRecord中? - 已解决</li><li>ActivityThread#main的入口点中，如何获取之前的结果？ - 已解决</li></ol></blockquote><p>下面为创建进程的调用序列，注意如下序列中只是创建了一个ProcessRecord的对象，对应于Linux上的进程创建我们再起文章进行分析，对于我们的Service来说，拿到ProcessRecord对象即可供我们来创建服务；</p><svg width="684" height="748" viewBox="0 0 684 748" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Android源码分析" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="bindService流程分析-加入启动流程" transform="translate(-923.000000, -331.000000)"><g id="架构图/模块-源码备份-25" transform="translate(925.000000, 417.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="13.8711791" y="14">ActivityManagerService#startProcessLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="44.0851371" y="30.122449">com/android/server/am/ActivityManagerService.java</tspan></text></g><g id="架构图/模块-源码备份-37" transform="translate(1254.000000, 417.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="13.8711791" y="14">ActivityManagerService#startProcessLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="37.0705764" y="30.122449">startProcessLocked(hostingRecord, entryPoint) 带入口点</tspan></text></g><g id="架构图/模块-源码备份-38" transform="translate(1232.000000, 473.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="173.816901" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="11.1847185" y="14">ProcessList#startProcess</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="14.2951452" y="30.122449">带入口类 android.app.ActivityThread</tspan></text></g><g id="架构图/模块-源码备份-49" transform="translate(1423.000000, 473.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="182.859155" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="2.72977831" y="14">handleProcessStartedLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="29.1292427" y="30.122449">记录ProcessRecord（通过PID）</tspan></text></g><g id="架构图/模块-源码备份-39" transform="translate(1254.000000, 529.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="22.2538402" y="14">android.os.ZygoteProcess#startViaZygote</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="76.586225" y="30.122449">带入口类 android.app.ActivityThread</tspan></text></g><g id="架构图/模块-源码备份-40" transform="translate(1254.000000, 585.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="11.0871121" y="14">ZygoteProcess#zygoteSendArgsAndGetResult</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="76.586225" y="30.122449">带入口类 android.app.ActivityThread</tspan></text></g><g id="架构图/模块-源码备份-41" transform="translate(1254.000000, 647.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="129.589673" y="14">zygote</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="110.270911" y="30.122449">zygote创建新的进程</tspan></text></g><g id="架构图/模块-源码备份-42" transform="translate(1254.000000, 703.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="80.8715473" y="14">ActivityThread#main()</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="101.306895" y="30.122449">进程创建后执行入口函数</tspan></text></g><g id="架构图/模块-源码备份-44" transform="translate(1254.000000, 758.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="81.6756979" y="14">ActivityThread#attach</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="134.190911" y="30.122449">module</tspan></text></g><g id="架构图/模块-源码备份-26" transform="translate(925.000000, 477.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="46.9144594" y="14">ProcessList#startProcessLocked()</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="67.9050534" y="30.122449">com/android/server/am/ProcessList.java</tspan></text></g><g id="架构图/模块-源码备份-11" transform="translate(923.000000, 532.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="31.8488192" y="14">ProcessList#newProcessRecordLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="67.9050534" y="30.122449">com/android/server/am/ProcessList.java</tspan></text></g><g id="架构图/模块-源码备份-27" transform="translate(923.000000, 582.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="31.8488192" y="14">ProcessList#newProcessRecordLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="69.8066434" y="30.122449">new ProcessRecord(ams, info, proc, uid)</tspan></text></g><g id="架构图/模块-源码备份-9" transform="translate(923.000000, 368.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="32.543313" y="14">ActiveServices#bringUpServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><path id="直线-7备份" d="M1073.93515 400.012222 1073.935 408.997 1077.67573 408.997076 1073.5 416.997076l-4.17572999999993-8L1073.064 408.997 1073.06485 400.012222H1073.93515z" fill="#979797" fill-rule="nonzero"/><path id="直线-8备份" d="M1073.93515 449.998187 1073.935 468.011 1077.67573 468.011111 1073.5 476.011111l-4.17572999999993-8L1073.064 468.011 1073.06485 449.998187H1073.93515z" fill="#979797" fill-rule="nonzero"/><path id="直线-9备份" d="M1073.93515 508.990779 1073.935 524.018 1077.67573 524.018519 1073.5 532.018519l-4.17572999999993-8L1073.064 524.018 1073.06485 508.990779H1073.93515z" fill="#979797" fill-rule="nonzero"/><path id="直线-10备份" d="M1073.93515 565.012222 1073.935 573.997 1077.67573 573.997076 1073.5 581.997076l-4.17572999999993-8L1073.064 573.997 1073.06485 565.012222H1073.93515z" fill="#979797" fill-rule="nonzero"/><text id="创建进程" font-family="NotoSansCJKsc-Black, Noto Sans CJK SC" font-size="18.2" font-weight="800" letter-spacing=".200199999" fill="#020202" fill-opacity=".88378138"><tspan x="1223.1996" y="347">创建进程</tspan></text><line x1="1222.66" y1="434.5" x2="1254.34" y2="434.5" id="直线-23" stroke="#979797" stroke-width="1.3" stroke-linecap="square"/><path id="直线-13" d="M1353.15 450.007895V463.953L1357.75 463.953216l-5.25 11-5.25-11L1351.85 463.953V450.007895H1353.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-14" d="M1372.15 505.988889V517.972L1376.75 517.972222l-5.25 11-5.25-11L1370.85 517.972V505.988889H1372.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-14备份" d="M1505.15 449.988889V461.972L1509.75 461.972222l-5.25 11-5.25-11L1503.85 461.972V449.988889H1505.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-15" d="M1403.15 562.988889V574.972L1407.75 574.972222l-5.25 11-5.25-11L1401.85 574.972V562.988889H1403.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-24" d="M1403.15 619.002174V637.958L1407.75 637.958937l-5.25 11-5.25-11L1401.85 637.958V619.002174H1403.15z" fill="#979797" fill-rule="nonzero"/><text id="socket" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="10.4" font-weight="300" letter-spacing=".114399999" fill="#020202" fill-opacity=".88378138"><tspan x="1406.4208" y="634">socket</tspan></text><path id="直线-25" d="M1403.15 680.988889V692.972L1407.75 692.972222l-5.25 11-5.25-11L1401.85 692.972V680.988889H1403.15z" fill="#979797" fill-rule="nonzero"/><line x1="1572.5" y1="503.649733" x2="1572.5" y2="988.350267" id="直线-26" stroke="#979797" stroke-width="1.3" stroke-linecap="square" stroke-dasharray="3.9"/><g id="架构图/模块-源码备份-45" transform="translate(1254.000000, 816.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="39.6222753" y="14">IActivityManager#attachApplication</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="134.190911" y="30.122449">module</tspan></text></g><path id="直线-27" d="M1403.15 735.988889V747.972L1407.75 747.972222l-5.25 11-5.25-11L1401.85 747.972V735.988889H1403.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-28" d="M1403.15 792v14.961L1407.75 806.961111l-5.25 11-5.25-11L1401.85 806.961V792H1403.15z" fill="#979797" fill-rule="nonzero"/><g id="架构图/模块-源码备份-46" transform="translate(1254.000000, 929.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="19.2199992" y="14">ActivityManagerService#attachApplication</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="134.190911" y="30.122449">module</tspan></text></g><g id="架构图/模块-源码备份-47" transform="translate(1218.000000, 989.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="368.7277" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="32.5625946" y="14">ActivityManagerService#attachApplicationLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="113.952385" y="30.122449">获取之前缓存的ProcessRecord(app)</tspan></text></g><g id="架构图/模块-源码备份-50" transform="translate(1218.000000, 1045.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="368.7277" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="100.665624" y="14">ProcessRecord#makeActive</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="67.8834312" y="30.122449">app.makeActive(thread, mProcessStats) ; thread = _thread;</tspan></text></g><g id="架构图/模块-源码备份-36" transform="translate(1254.000000, 870.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="124.320049" y="14">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="136.553756" y="30.122449">binder</tspan></text></g><path id="直线-29" d="M1403.15 848.997059V859.964L1407.75 859.964052l-5.25 11-5.25-11L1401.85 859.964V848.997059H1403.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-30" d="M1403.15 902.992857V918.968L1407.75 918.968254l-5.25 11-5.25-11L1401.85 918.968V902.992857H1403.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-31" d="M1403.15 962.992857V978.968L1407.75 978.968254l-5.25 11-5.25-11L1401.85 978.968V962.992857H1403.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-32" d="M1403.15 1022.98889V1034.972L1407.75 1034.97222l-5.25 11-5.25-11L1401.85 1034.972v-11.98311H1403.15z" fill="#979797" fill-rule="nonzero"/></g></g></svg><ul><li>进程创建的执行位于AMS所在的系统进程之中；</li><li>（AMS进程）首先，构建一个ProcessRecord记录，并将其记录到AMS中；</li><li>（AMS进程）AMS通过socket通信，通知zygote来创建一个新的进程，同时指定入口点为 <code>android.app.ActivityThread</code> ;</li><li>（APP进程）新的进程启动后，执行ActivityThread中的方法，通知AMS来执行attachApplication；</li><li>（AMS进程）AMS中，通过PID获取之前存储的ProcessRecord，然后将ApplicationThread（代理对象）赋值给ProcessRecord的成员变量thread；</li><li>支持完成了关联；</li></ul><h4 id=构造processrecord实例>构造ProcessRecord实例<a hidden class=anchor aria-hidden=true href=#构造processrecord实例>#</a></h4><p><code>com.android.server.am.ProcessList#startProcessLocked</code>，简化下来就两句：</p><ul><li>构造ProcessRecord对象： <code>app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord)</code></li><li>启动进程：<code>startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride)</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ProcessList#newProcessRecordLocked</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> ProcessRecord <span style=color:#a6e22e>startProcessLocked</span>(String processName, ApplicationInfo info,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> knownToBeDead, <span style=color:#66d9ef>int</span> intentFlags, HostingRecord hostingRecord,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> zygotePolicyFlags, <span style=color:#66d9ef>boolean</span> allowWhileBooting, <span style=color:#66d9ef>boolean</span> isolated, <span style=color:#66d9ef>int</span> isolatedUid,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> keepIfLarge, String abiOverride, String entryPoint, String<span style=color:#f92672>[]</span> entryPointArgs,
</span></span><span style=display:flex><span>            Runnable crashHandler) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>        ProcessRecord app;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 构造ProcessRecord对象</span>
</span></span><span style=display:flex><span>            app <span style=color:#f92672>=</span> newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord);
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>crashHandler</span> <span style=color:#f92672>=</span> crashHandler;
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>isolatedEntryPoint</span> <span style=color:#f92672>=</span> entryPoint;
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>isolatedEntryPointArgs</span> <span style=color:#f92672>=</span> entryPointArgs;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// If this is a new package in the process, add the package to the list</span>
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>addPackage</span>(info.<span style=color:#a6e22e>packageName</span>, info.<span style=color:#a6e22e>longVersionCode</span>, mService.<span style=color:#a6e22e>mProcessStats</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 启动进程</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> success <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride);
</span></span><span style=display:flex><span>        checkSlow(startTime, <span style=color:#e6db74>&#34;startProcess: done starting proc!&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> success <span style=color:#f92672>?</span> app : <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h4 id=启动进程>启动进程<a hidden class=anchor aria-hidden=true href=#启动进程>#</a></h4><p><code>startProcessLocked</code>: 启动了一个进程，并指定了入口点为 ==android.app.ActivityThread==，也就是进程启动后将会执行 ==android.app.ActivityThread==的main方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ProcessList#startProcessLocked(com.android.server.am.ProcessRecord, com.android.server.am.HostingRecord, int, boolean, boolean, boolean, java.lang.String)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startProcessLocked</span>(ProcessRecord app, HostingRecord hostingRecord,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> zygotePolicyFlags, <span style=color:#66d9ef>boolean</span> disableHiddenApiChecks, <span style=color:#66d9ef>boolean</span> disableTestApiChecks,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> mountExtStorageFull, String abiOverride) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app.<span style=color:#a6e22e>pendingStart</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> userId <span style=color:#f92672>=</span> UserHandle.<span style=color:#a6e22e>getUserId</span>(app.<span style=color:#a6e22e>uid</span>);
</span></span><span style=display:flex><span>                AppGlobals.<span style=color:#a6e22e>getPackageManager</span>().<span style=color:#a6e22e>checkPackageStartable</span>(app.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>packageName</span>, userId);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e.<span style=color:#a6e22e>rethrowAsRuntimeException</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> uid <span style=color:#f92672>=</span> app.<span style=color:#a6e22e>uid</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> gids <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ... </span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>mountMode</span> <span style=color:#f92672>=</span> mountExternal;
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>gids</span> <span style=color:#f92672>=</span> gids;
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>setRequiredAbi</span>(requiredAbi);
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>instructionSet</span> <span style=color:#f92672>=</span> instructionSet;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> String seInfo <span style=color:#f92672>=</span> app.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>seInfo</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> (TextUtils.<span style=color:#a6e22e>isEmpty</span>(app.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>seInfoUser</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;&#34;</span> : app.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>seInfoUser</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Start the process.  It will either succeed and return a result containing</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// the PID of the new process, or else throw a RuntimeException.</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 指定入口点为ActivityThread，启动进程</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> String entryPoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;android.app.ActivityThread&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> startProcessLocked(hostingRecord, entryPoint, app, uid, gids,
</span></span><span style=display:flex><span>                    runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi,
</span></span><span style=display:flex><span>                    instructionSet, invokeWith, startTime);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (RuntimeException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>startProcessLocked</span>(HostingRecord hostingRecord, String entryPoint, ProcessRecord app,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> uid, <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> gids, <span style=color:#66d9ef>int</span> runtimeFlags, <span style=color:#66d9ef>int</span> zygotePolicyFlags, <span style=color:#66d9ef>int</span> mountExternal,
</span></span><span style=display:flex><span>            String seInfo, String requiredAbi, String instructionSet, String invokeWith,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>long</span> startTime) {
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>pendingStart</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>killedByAm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>removed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>killed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> startSeq <span style=color:#f92672>=</span> app.<span style=color:#a6e22e>startSeq</span> <span style=color:#f92672>=</span> <span style=color:#f92672>++</span>mProcStartSeqCounter;
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>setStartParams</span>(uid, hostingRecord, seInfo, startTime);
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>setUsingWrapper</span>(invokeWith <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>||</span> Zygote.<span style=color:#a6e22e>getWrapProperty</span>(app.<span style=color:#a6e22e>processName</span>) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        mPendingStarts.<span style=color:#a6e22e>put</span>(startSeq, app);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mService.<span style=color:#a6e22e>mConstants</span>.<span style=color:#a6e22e>FLAG_PROCESS_START_ASYNC</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 启动进程，并传入entrypoint</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> Process.<span style=color:#a6e22e>ProcessStartResult</span> startResult <span style=color:#f92672>=</span> startProcess(hostingRecord,
</span></span><span style=display:flex><span>                        entryPoint, app,
</span></span><span style=display:flex><span>                        uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo,
</span></span><span style=display:flex><span>                        requiredAbi, instructionSet, invokeWith, startTime);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 做启动后的操作</span>
</span></span><span style=display:flex><span>                handleProcessStartedLocked(app, startResult.<span style=color:#a6e22e>pid</span>, startResult.<span style=color:#a6e22e>usingWrapper</span>,
</span></span><span style=display:flex><span>                        startSeq, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (RuntimeException e) {
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> app.<span style=color:#a6e22e>pid</span> <span style=color:#f92672>&gt;</span> 0;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>这里我们省略其他更加底层的步骤的分析，我们只需要知道到了这里之后，会启动一个进程，进程启动后会执行 ==android.app.ActivityThread#main== 方法；</p><h4 id=记录进程记录到ams>记录进程记录到AMS<a hidden class=anchor aria-hidden=true href=#记录进程记录到ams>#</a></h4><p><code>ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)</code></p><p>==这个地方有个关键的代码将之前创建的进程记录存储到了AMS的进程记录表中。==</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span>
</span></span><span style=display:flex><span>ActivityManagerService mService <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>handleProcessStartedLocked</span>(ProcessRecord app, <span style=color:#66d9ef>int</span> pid, <span style=color:#66d9ef>boolean</span> usingWrapper,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>long</span> expectedStartSeq, <span style=color:#66d9ef>boolean</span> procAttached) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将ProcessRecord 存储到AMS中</span>
</span></span><span style=display:flex><span>    mService.<span style=color:#a6e22e>addPidLocked</span>(app);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addPidLocked</span>(ProcessRecord app) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> (mPidsSelfLocked) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将进程记录添加到一个记录表中</span>
</span></span><span style=display:flex><span>        mPidsSelfLocked.<span style=color:#a6e22e>doAddInternal</span>(app);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> (sActiveProcessInfoSelfLocked) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app.<span style=color:#a6e22e>processInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            sActiveProcessInfoSelfLocked.<span style=color:#a6e22e>put</span>(app.<span style=color:#a6e22e>pid</span>, app.<span style=color:#a6e22e>processInfo</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            sActiveProcessInfoSelfLocked.<span style=color:#a6e22e>remove</span>(app.<span style=color:#a6e22e>pid</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    mAtmInternal.<span style=color:#a6e22e>onProcessMapped</span>(app.<span style=color:#a6e22e>pid</span>, app.<span style=color:#a6e22e>getWindowProcessController</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 完整代码</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>handleProcessStartedLocked</span>(ProcessRecord app, <span style=color:#66d9ef>int</span> pid, <span style=color:#66d9ef>boolean</span> usingWrapper,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>long</span> expectedStartSeq, <span style=color:#66d9ef>boolean</span> procAttached) {
</span></span><span style=display:flex><span>        mPendingStarts.<span style=color:#a6e22e>remove</span>(expectedStartSeq);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String reason <span style=color:#f92672>=</span> isProcStartValidLocked(app, expectedStartSeq);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (reason <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            Slog.<span style=color:#a6e22e>w</span>(TAG_PROCESSES, app <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; start not valid, killing pid=&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                    pid
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, &#34;</span> <span style=color:#f92672>+</span> reason);
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>pendingStart</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>            killProcessQuiet(pid);
</span></span><span style=display:flex><span>            Process.<span style=color:#a6e22e>killProcessGroup</span>(app.<span style=color:#a6e22e>uid</span>, app.<span style=color:#a6e22e>pid</span>);
</span></span><span style=display:flex><span>            noteAppKill(app, ApplicationExitInfo.<span style=color:#a6e22e>REASON_OTHER</span>,
</span></span><span style=display:flex><span>                    ApplicationExitInfo.<span style=color:#a6e22e>SUBREASON_INVALID_START</span>, reason);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        mService.<span style=color:#a6e22e>mBatteryStatsService</span>.<span style=color:#a6e22e>noteProcessStart</span>(app.<span style=color:#a6e22e>processName</span>, app.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>uid</span>);
</span></span><span style=display:flex><span>        checkSlow(app.<span style=color:#a6e22e>startTime</span>, <span style=color:#e6db74>&#34;startProcess: done updating battery stats&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        EventLog.<span style=color:#a6e22e>writeEvent</span>(EventLogTags.<span style=color:#a6e22e>AM_PROC_START</span>,
</span></span><span style=display:flex><span>                UserHandle.<span style=color:#a6e22e>getUserId</span>(app.<span style=color:#a6e22e>startUid</span>), pid, app.<span style=color:#a6e22e>startUid</span>,
</span></span><span style=display:flex><span>                app.<span style=color:#a6e22e>processName</span>, app.<span style=color:#a6e22e>hostingRecord</span>.<span style=color:#a6e22e>getType</span>(),
</span></span><span style=display:flex><span>                app.<span style=color:#a6e22e>hostingRecord</span>.<span style=color:#a6e22e>getName</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> app.<span style=color:#a6e22e>hostingRecord</span>.<span style=color:#a6e22e>getName</span>() : <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            AppGlobals.<span style=color:#a6e22e>getPackageManager</span>().<span style=color:#a6e22e>logAppProcessStartIfNeeded</span>(app.<span style=color:#a6e22e>processName</span>, app.<span style=color:#a6e22e>uid</span>,
</span></span><span style=display:flex><span>                    app.<span style=color:#a6e22e>seInfo</span>, app.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>sourceDir</span>, pid);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (RemoteException ex) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Ignore</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Watchdog.<span style=color:#a6e22e>getInstance</span>().<span style=color:#a6e22e>processStarted</span>(app.<span style=color:#a6e22e>processName</span>, pid);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        checkSlow(app.<span style=color:#a6e22e>startTime</span>, <span style=color:#e6db74>&#34;startProcess: building log message&#34;</span>);
</span></span><span style=display:flex><span>        StringBuilder buf <span style=color:#f92672>=</span> mStringBuilder;
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>setLength</span>(0);
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;Start proc &#34;</span>);
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(pid);
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#39;:&#39;</span>);
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(app.<span style=color:#a6e22e>processName</span>);
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#39;/&#39;</span>);
</span></span><span style=display:flex><span>        UserHandle.<span style=color:#a6e22e>formatUid</span>(buf, app.<span style=color:#a6e22e>startUid</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app.<span style=color:#a6e22e>isolatedEntryPoint</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34; [&#34;</span>);
</span></span><span style=display:flex><span>            buf.<span style=color:#a6e22e>append</span>(app.<span style=color:#a6e22e>isolatedEntryPoint</span>);
</span></span><span style=display:flex><span>            buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34;]&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34; for &#34;</span>);
</span></span><span style=display:flex><span>        buf.<span style=color:#a6e22e>append</span>(app.<span style=color:#a6e22e>hostingRecord</span>.<span style=color:#a6e22e>getType</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app.<span style=color:#a6e22e>hostingRecord</span>.<span style=color:#a6e22e>getName</span>() <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            buf.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#34; &#34;</span>);
</span></span><span style=display:flex><span>            buf.<span style=color:#a6e22e>append</span>(app.<span style=color:#a6e22e>hostingRecord</span>.<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        mService.<span style=color:#a6e22e>reportUidInfoMessageLocked</span>(TAG, buf.<span style=color:#a6e22e>toString</span>(), app.<span style=color:#a6e22e>startUid</span>);
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>setPid</span>(pid);
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>setUsingWrapper</span>(usingWrapper);
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>pendingStart</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        checkSlow(app.<span style=color:#a6e22e>startTime</span>, <span style=color:#e6db74>&#34;startProcess: starting to update pids map&#34;</span>);
</span></span><span style=display:flex><span>        ProcessRecord oldApp;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> (mService.<span style=color:#a6e22e>mPidsSelfLocked</span>) {
</span></span><span style=display:flex><span>            oldApp <span style=color:#f92672>=</span> mService.<span style=color:#a6e22e>mPidsSelfLocked</span>.<span style=color:#a6e22e>get</span>(pid);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If there is already an app occupying that pid that hasn&#39;t been cleaned up</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (oldApp <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>app.<span style=color:#a6e22e>isolated</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Clean up anything relating to this pid first</span>
</span></span><span style=display:flex><span>            Slog.<span style=color:#a6e22e>wtf</span>(TAG, <span style=color:#e6db74>&#34;handleProcessStartedLocked process:&#34;</span> <span style=color:#f92672>+</span> app.<span style=color:#a6e22e>processName</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; startSeq:&#34;</span> <span style=color:#f92672>+</span> app.<span style=color:#a6e22e>startSeq</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; pid:&#34;</span> <span style=color:#f92672>+</span> pid
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; belongs to another existing app:&#34;</span> <span style=color:#f92672>+</span> oldApp.<span style=color:#a6e22e>processName</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; startSeq:&#34;</span> <span style=color:#f92672>+</span> oldApp.<span style=color:#a6e22e>startSeq</span>);
</span></span><span style=display:flex><span>            mService.<span style=color:#a6e22e>cleanUpApplicationRecordLocked</span>(oldApp, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#f92672>-</span>1,
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>true</span> <span style=color:#75715e>/*replacingPid*/</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注意这里 </span>
</span></span><span style=display:flex><span>        mService.<span style=color:#a6e22e>addPidLocked</span>(app);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> (mService.<span style=color:#a6e22e>mPidsSelfLocked</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>procAttached) {
</span></span><span style=display:flex><span>                Message msg <span style=color:#f92672>=</span> mService.<span style=color:#a6e22e>mHandler</span>.<span style=color:#a6e22e>obtainMessage</span>(PROC_START_TIMEOUT_MSG);
</span></span><span style=display:flex><span>                msg.<span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> app;
</span></span><span style=display:flex><span>                mService.<span style=color:#a6e22e>mHandler</span>.<span style=color:#a6e22e>sendMessageDelayed</span>(msg, usingWrapper
</span></span><span style=display:flex><span>                        <span style=color:#f92672>?</span> PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        checkSlow(app.<span style=color:#a6e22e>startTime</span>, <span style=color:#e6db74>&#34;startProcess: done updating pids map&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h4 id=写入thread值到processrecord>写入thread值到ProcessRecord<a hidden class=anchor aria-hidden=true href=#写入thread值到processrecord>#</a></h4><p>从上面的流程中，我们发现构造出来的ProcessRecord的thread（ApplicationThread）成员变量还是没有被赋值，那么这个thread何时被赋值呢？</p><blockquote><p>查找<code>ProcessRecord</code>中<code>thread</code>赋值的入口：</p><ol><li><p>通过查找<code>thread</code>成员的赋值写入方法，可以确定起始点是，<code>com.android.server.am.ProcessRecord#makeActive</code> ，接下来查看调用这个方法的列表：</p></li><li><p><img alt=image-20210411172323572 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411172323.png></p></li><li><p>这里我们显然选择 <code>com.android.server.am.ActivityManagerService#attachApplicationLocked</code></p></li><li><p><code>android.app.ActivityThread#attach</code></p></li><li><p>这里我们遇到两个选择：</p><img src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411172524.png alt=image-20210411172524831 style=zoom:50%></li><li><p>显然，应该选择第二个：<code>android.app.ActivityThread#main</code></p></li><li><p>这里我们却无法直接通过IDEA的调用层次功能找到任何调用方法，说明可能是通过反射来调用的，所以直接通过全局字符串搜索==android.app.ActivityThread==，可以找到在 <code>ProcessList.startProcessLocked</code> 中调用的。</p></li></ol></blockquote><p>通过上面的分析，这里我们从ActivityThread的main函数开始。</p><h5 id=activitythreadmain>ActivityThread#main<a hidden class=anchor aria-hidden=true href=#activitythreadmain>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        Trace.<span style=color:#a6e22e>traceBegin</span>(Trace.<span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span>, <span style=color:#e6db74>&#34;ActivityThreadMain&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Install selective syscall interception</span>
</span></span><span style=display:flex><span>        AndroidOs.<span style=color:#a6e22e>install</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// CloseGuard defaults to true and can be quite spammy.  We</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// disable it here, but selectively enable it later (via</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// StrictMode) on debug builds, but using DropBox, not logs.</span>
</span></span><span style=display:flex><span>        CloseGuard.<span style=color:#a6e22e>setEnabled</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Environment.<span style=color:#a6e22e>initForCurrentUser</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Make sure TrustedCertificateStore looks in the right place for CA certificates</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> File configDir <span style=color:#f92672>=</span> Environment.<span style=color:#a6e22e>getUserConfigDirectory</span>(UserHandle.<span style=color:#a6e22e>myUserId</span>());
</span></span><span style=display:flex><span>        TrustedCertificateStore.<span style=color:#a6e22e>setDefaultUserDirectory</span>(configDir);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Call per-process mainline module initialization.</span>
</span></span><span style=display:flex><span>        initializeMainlineModules();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Process.<span style=color:#a6e22e>setArgV0</span>(<span style=color:#e6db74>&#34;&lt;pre-initialized&gt;&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Looper.<span style=color:#a6e22e>prepareMainLooper</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// It will be in the format &#34;seq=114&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> startSeq <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (args <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> args.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1; i <span style=color:#f92672>&gt;=</span> 0; <span style=color:#f92672>--</span>i) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>.<span style=color:#a6e22e>startsWith</span>(PROC_START_SEQ_IDENT)) {
</span></span><span style=display:flex><span>                    startSeq <span style=color:#f92672>=</span> Long.<span style=color:#a6e22e>parseLong</span>(
</span></span><span style=display:flex><span>                            args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>.<span style=color:#a6e22e>substring</span>(PROC_START_SEQ_IDENT.<span style=color:#a6e22e>length</span>()));
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 直接构造一个ActivityThread对象</span>
</span></span><span style=display:flex><span>        ActivityThread thread <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ActivityThread();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行attach方法</span>
</span></span><span style=display:flex><span>        thread.<span style=color:#a6e22e>attach</span>(<span style=color:#66d9ef>false</span>, startSeq);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (sMainThreadHandler <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            sMainThreadHandler <span style=color:#f92672>=</span> thread.<span style=color:#a6e22e>getHandler</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>            Looper.<span style=color:#a6e22e>myLooper</span>().<span style=color:#a6e22e>setMessageLogging</span>(<span style=color:#66d9ef>new</span>
</span></span><span style=display:flex><span>                    LogPrinter(Log.<span style=color:#a6e22e>DEBUG</span>, <span style=color:#e6db74>&#34;ActivityThread&#34;</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// End of event ActivityThreadMain.</span>
</span></span><span style=display:flex><span>        Trace.<span style=color:#a6e22e>traceEnd</span>(Trace.<span style=color:#a6e22e>TRACE_TAG_ACTIVITY_MANAGER</span>);
</span></span><span style=display:flex><span>        Looper.<span style=color:#a6e22e>loop</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;Main thread loop unexpectedly exited&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h5 id=activitythreadattach>ActivityThread#attach<a hidden class=anchor aria-hidden=true href=#activitythreadattach>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attach</span>(<span style=color:#66d9ef>boolean</span> system, <span style=color:#66d9ef>long</span> startSeq) {
</span></span><span style=display:flex><span>        sCurrentActivityThread <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>        mSystemThread <span style=color:#f92672>=</span> system;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>system) {
</span></span><span style=display:flex><span>            android.<span style=color:#a6e22e>ddm</span>.<span style=color:#a6e22e>DdmHandleAppName</span>.<span style=color:#a6e22e>setAppName</span>(<span style=color:#e6db74>&#34;&lt;pre-initialized&gt;&#34;</span>,
</span></span><span style=display:flex><span>                                                    UserHandle.<span style=color:#a6e22e>myUserId</span>());
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 将当前ApplicationThread的Binder对象保存为一个静态成员</span>
</span></span><span style=display:flex><span>            RuntimeInit.<span style=color:#a6e22e>setApplicationObject</span>(mAppThread.<span style=color:#a6e22e>asBinder</span>());
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取AMS</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> IActivityManager mgr <span style=color:#f92672>=</span> ActivityManager.<span style=color:#a6e22e>getService</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 通知AMS来 attachApplication</span>
</span></span><span style=display:flex><span>                mgr.<span style=color:#a6e22e>attachApplication</span>(mAppThread, startSeq);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (RemoteException ex) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> ex.<span style=color:#a6e22e>rethrowFromSystemServer</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=activitymanagerserviceattachapplication--attachapplicationlocked><strong>ActivityManagerService#attachApplication</strong> & attachApplicationLocked<a hidden class=anchor aria-hidden=true href=#activitymanagerserviceattachapplication--attachapplicationlocked>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>attachApplication</span>(IApplicationThread thread, <span style=color:#66d9ef>long</span> startSeq) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (thread <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> SecurityException(<span style=color:#e6db74>&#34;Invalid application interface&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> (<span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> callingPid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingPid</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingUid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingUid</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> origId <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>clearCallingIdentity</span>();
</span></span><span style=display:flex><span>            attachApplicationLocked(thread, callingPid, callingUid, startSeq);
</span></span><span style=display:flex><span>            Binder.<span style=color:#a6e22e>restoreCallingIdentity</span>(origId);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>上面的方法只是调用了 attachApplicationLocked：</p><p>==有个关键的步骤是，从 AMS的进程记录表中根据PID取出一个 ProcessRecord: <code>app = mPidsSelfLocked.get(pid)</code>==</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>attachApplicationLocked</span>(<span style=color:#a6e22e>@NonNull</span> IApplicationThread thread,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> pid, <span style=color:#66d9ef>int</span> callingUid, <span style=color:#66d9ef>long</span> startSeq) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find the application record that is being attached...  either via</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// the pid if we are running in multiple processes, or just pull the</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// next app record if we are emulating process with anonymous threads.</span>
</span></span><span style=display:flex><span>        ProcessRecord app;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> startTime <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> bindApplicationTimeMillis;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pid <span style=color:#f92672>!=</span> MY_PID <span style=color:#f92672>&amp;&amp;</span> pid <span style=color:#f92672>&gt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>synchronized</span> (mPidsSelfLocked) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 从进程记录中获取</span>
</span></span><span style=display:flex><span>                app <span style=color:#f92672>=</span> mPidsSelfLocked.<span style=color:#a6e22e>get</span>(pid);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Make app active after binding application or client may be running requests (e.g</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// starting activities) before it is ready.</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 关联thread到app（ProcessRecord）</span>
</span></span><span style=display:flex><span>        app.<span style=color:#a6e22e>makeActive</span>(thread, mProcessStats);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>经过上面的步骤，即完成了ProcessRecord到进程的ApplicationThread的关联。</p><h3 id=启动服务>启动服务<a hidden class=anchor aria-hidden=true href=#启动服务>#</a></h3><p>从AMS中调用ApplicationThread的方法来在Service自己应该所属的进程中创建Service对象的实例。</p><svg width="723" height="508" viewBox="0 0 723 508" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Android源码分析" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="bindService流程分析-加入启动流程" transform="translate(-1687.000000, -331.000000)"><g id="架构图/模块-源码备份-42" transform="translate(2075.000000, 429.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="80.8715473" y="14">ActivityThread#main()</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="101.306895" y="30.122449">进程创建后执行入口函数</tspan></text></g><g id="架构图/模块-源码备份-57" transform="translate(2075.000000, 370.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="96.4245514" y="14">独立进程的Service</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="132.102208" y="30.122449">启动进程</tspan></text></g><g id="架构图/模块-源码备份-53" transform="translate(2075.000000, 483.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="81.6756979" y="14">ActivityThread#attach</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="148.202627" y="30.122449">-</tspan></text></g><g id="架构图/模块-源码备份-28" transform="translate(1688.000000, 476.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="17.7639992" y="14">IApplicationThread#scheduleCreateService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="75.1632961" y="30.122449">android/app/IApplicationThread.java</tspan></text></g><g id="架构图/模块-源码备份-36" transform="translate(1688.000000, 535.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="124.320049" y="14">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="136.553756" y="30.122449">binder</tspan></text></g><g id="架构图/模块-源码备份-36" transform="translate(1687.000000, 750.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="124.320049" y="14">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="136.553756" y="30.122449">binder</tspan></text></g><g id="架构图/模块-源码备份-30" transform="translate(1687.000000, 590.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="19.8413883" y="14">ApplicationThread#scheduleCreateService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="84.8453045" y="30.122449">android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-31" transform="translate(1687.000000, 641.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="37.6728192" y="14">ActivityThread#handleCreateService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="84.8453045" y="30.122449">android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-33" transform="translate(1688.000000, 695.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="26.5913799" y="14">IActivityManager#serviceDoneExecuting</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="84.8453045" y="30.122449">android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-34" transform="translate(1687.000000, 805.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="6.18910375" y="14">ActivityManagerService#serviceDoneExecuting</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="84.8453045" y="30.122449">android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-9" transform="translate(1688.000000, 373.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="32.543313" y="14">ActiveServices#bringUpServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><g id="架构图/模块-源码备份-43" transform="translate(1687.000000, 422.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="30.4598318" y="14">ActiveServices#realStartServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><path id="直线-7备份-2" d="M1837.93515 405.012222 1837.935 413.997 1841.67573 413.997076 1837.5 421.997076l-4.17572999999993-8L1837.064 413.997 1837.06485 405.012222H1837.93515z" fill="#979797" fill-rule="nonzero"/><path id="直线-8备份-2" d="M1836.93515 507.998187 1836.935 526.011 1840.67573 526.011111 1836.5 534.011111l-4.17572999999993-8L1836.064 526.011 1836.06485 507.998187H1836.93515z" fill="#979797" fill-rule="nonzero"/><path id="直线-9备份-2" d="M1836.93515 567.990779 1836.935 583.018 1840.67573 583.018519 1836.5 591.018519l-4.17572999999993-8L1836.064 583.018 1836.06485 567.990779H1836.93515z" fill="#979797" fill-rule="nonzero"/><path id="直线-10备份-2" d="M1836.93515 624.012222 1836.935 632.997 1840.67573 632.997076 1836.5 640.997076l-4.17572999999993-8L1836.064 632.997 1836.06485 624.012222H1836.93515z" fill="#979797" fill-rule="nonzero"/><text id="启动服务" font-family="NotoSansCJKsc-Black, Noto Sans CJK SC" font-size="18.2" font-weight="800" letter-spacing=".200199999" fill="#020202" fill-opacity=".88378138"><tspan x="1802.1996" y="347">启动服务</tspan></text><path id="直线-22" d="M1836.15 674.997059V685.964L1840.75 685.964052l-5.25 11-5.25-11L1834.85 685.964V674.997059H1836.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-22备份" d="M1836.15 728.997059V739.964L1840.75 739.964052l-5.25 11-5.25-11L1834.85 739.964V728.997059H1836.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-22备份-2" d="M1836.15 783.997059V794.964L1840.75 794.964052l-5.25 11-5.25-11L1834.85 794.964V783.997059H1836.15z" fill="#979797" fill-rule="nonzero"/><g id="架构图/模块-源码备份-54" transform="translate(2075.000000, 542.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="39.6222753" y="14">IActivityManager#attachApplication</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="148.202627" y="30.122449">-</tspan></text></g><path id="直线-27备份" d="M2224.15 460.988889V472.972L2228.75 472.972222l-5.25 11-5.25-11L2222.85 472.972V460.988889H2224.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-28备份" d="M2224.15 517v14.961L2228.75 531.961111l-5.25 11-5.25-11L2222.85 531.961V517H2224.15z" fill="#979797" fill-rule="nonzero"/><g id="架构图/模块-源码备份-55" transform="translate(2075.000000, 655.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="19.2199992" y="14">ActivityManagerService#attachApplication</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="148.202627" y="30.122449">-</tspan></text></g><g id="架构图/模块-源码备份-48" transform="translate(2040.000000, 711.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="368.7277" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="32.5625946" y="14">ActivityManagerService#attachApplicationLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="77.2564856" y="30.122449">获取之前存储的 mPendingServices - 待启动的服务列表</tspan></text></g><g id="架构图/模块-源码备份-36" transform="translate(2075.000000, 595.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="124.320049" y="14">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="136.553756" y="30.122449">binder</tspan></text></g><path id="直线-29备份" d="M2224.15 573.997059V584.964L2228.75 584.964052l-5.25 11-5.25-11L2222.85 584.964V573.997059H2224.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-30备份" d="M2224.15 628.992857V644.968L2228.75 644.968254l-5.25 11-5.25-11L2222.85 644.968V628.992857H2224.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-33" d="M1838.15 454.997059V465.964L1842.75 465.964052l-5.25 11-5.25-11L1836.85 465.964V454.997059H1838.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-34" d="M2224.15 688.997059V699.964L2228.75 699.964052l-5.25 11-5.25-11L2222.85 699.964V688.997059H2224.15z" fill="#979797" fill-rule="nonzero"/><path id="直线-35" d="M1996.38889 444.25l-11-5.25 11-5.25L1996.388 438.35H2024.46863L2024.468 727.35h16.182V728.65H2023.16863L2023.168 439.65h-26.78L1996.38889 444.25z" fill="#979797" fill-rule="nonzero"/><path id="直线-36" d="M2224.15 403v14.961L2228.75 417.961111l-5.25 11-5.25-11L2222.85 417.961V403H2224.15z" fill="#979797" fill-rule="nonzero"/></g></g></svg><h4 id=activeservicesbringupservicelocked>ActiveServices#bringUpServiceLocked<a hidden class=anchor aria-hidden=true href=#activeservicesbringupservicelocked>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActiveServices#bringUpServiceLocked</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>bringUpServiceLocked</span>(ServiceRecord r, <span style=color:#66d9ef>int</span> intentFlags, <span style=color:#66d9ef>boolean</span> execInFg,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> whileRestarting, <span style=color:#66d9ef>boolean</span> permissionsReviewRequired)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 已经存在进程记录，并且进程记录中的IApplicationThread已经存在，则不创建服务，仅发送参数</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (r.<span style=color:#a6e22e>app</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> r.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>thread</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            sendServiceArgsLocked(r, execInFg, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isolated <span style=color:#f92672>=</span> (r.<span style=color:#a6e22e>serviceInfo</span>.<span style=color:#a6e22e>flags</span><span style=color:#f92672>&amp;</span>ServiceInfo.<span style=color:#a6e22e>FLAG_ISOLATED_PROCESS</span>) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String procName <span style=color:#f92672>=</span> r.<span style=color:#a6e22e>processName</span>;
</span></span><span style=display:flex><span>        HostingRecord hostingRecord <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HostingRecord(<span style=color:#e6db74>&#34;service&#34;</span>, r.<span style=color:#a6e22e>instanceName</span>);
</span></span><span style=display:flex><span>        ProcessRecord app;
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 非独立的进程，则直接获取当前启动进程的进程信息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isolated) {
</span></span><span style=display:flex><span>            app <span style=color:#f92672>=</span> mAm.<span style=color:#a6e22e>getProcessRecordLocked</span>(procName, r.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>uid</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> (app <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> app.<span style=color:#a6e22e>thread</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    app.<span style=color:#a6e22e>addPackage</span>(r.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>packageName</span>, r.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>longVersionCode</span>, mAm.<span style=color:#a6e22e>mProcessStats</span>);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 非独立进程中，直接启动服务</span>
</span></span><span style=display:flex><span>                    realStartServiceLocked(r, app, execInFg);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 调用启动方法后直接返回</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (TransactionTooLargeException e) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> e;
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>                    Slog.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;Exception when starting service &#34;</span> <span style=color:#f92672>+</span> r.<span style=color:#a6e22e>shortInstanceName</span>, e);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// If a dead object exception was thrown -- fall through to</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// restart the application.</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 独立进程则先尝试使用之前保存的</span>
</span></span><span style=display:flex><span>            app <span style=color:#f92672>=</span> r.<span style=color:#a6e22e>isolatedProc</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 之前没有启动对应的进程，则开始创建，启动了，则无需进行赋值操作，因为ServiceRecord中已经有了</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>permissionsReviewRequired) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((app<span style=color:#f92672>=</span>mAm.<span style=color:#a6e22e>startProcessLocked</span>(procName, r.<span style=color:#a6e22e>appInfo</span>, <span style=color:#66d9ef>true</span>, intentFlags,
</span></span><span style=display:flex><span>                    hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, <span style=color:#66d9ef>false</span>, isolated, <span style=color:#66d9ef>false</span>)) <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Unable to launch app &#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> r.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>packageName</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> r.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>uid</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for service &#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> r.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>getIntent</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;: process is bad&#34;</span>;
</span></span><span style=display:flex><span>                Slog.<span style=color:#a6e22e>w</span>(TAG, msg);
</span></span><span style=display:flex><span>                bringDownServiceLocked(r);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 进程启动失败，返回错误消息</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> msg;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (isolated) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 独立进程，缓存进程信息到传入的ServiceRecord参数中，以便后续直接使用</span>
</span></span><span style=display:flex><span>                r.<span style=color:#a6e22e>isolatedProc</span> <span style=color:#f92672>=</span> app;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将服务记录加入的mPendingServices中，由于非独立进程创建后已经直接返回，所以这里适用于独立进程的</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>mPendingServices.<span style=color:#a6e22e>contains</span>(r)) {
</span></span><span style=display:flex><span>            mPendingServices.<span style=color:#a6e22e>add</span>(r);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 创建成功或者之前已经又了缓存，则返回null</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h4 id=独立进程何时启动服务>独立进程何时启动服务？<a hidden class=anchor aria-hidden=true href=#独立进程何时启动服务>#</a></h4><ul><li><p>一般来说，封装较好的代码会保证入口统一，如果非独立进程情况下服务的启动使用的是 <code>realStartServiceLocked</code> 方法来启动服务，那么独立进程情况下，服务的启动也应该使用此方法，所以我们查看 <code>realStartServiceLocked</code> 方法的调用层次，如下：</p><p><strong>图片版本:</strong></p><p><img alt=image-20210411112439961 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411112440.png></p><p><strong>详细调用序列:</strong></p><ul><li><code>ActiveServices.attachApplicationLocked</code>(ProcessRecord, String) (com.android.server.am)<ul><li>ActivityManagerService.attachApplicationLocked(IApplicationThread, int, int, long) (com.android.server.am)<ul><li>ActivityManagerService.attachApplication(IApplicationThread, long) (com.android.server.am)</li></ul></li></ul></li><li><code>ActiveServices.bringUpServiceLocked</code>(ServiceRecord, int, boolean, boolean, boolean) (com.android.server.am)<ul><li>ActiveServices.startServiceInnerLocked(ServiceMap, Intent, ServiceRecord, boolean, boolean) (com.android.server.am)</li><li>ActiveServices.bindServiceLocked(IApplicationThread, IBinder, Intent, String, IServiceConnection, int, String, &mldr;) (com.android.server.am)</li><li>ActiveServices.performServiceRestartLocked(ServiceRecord) (com.android.server.am)</li></ul></li></ul><p>也就是调用了 <code>ActiveServices.attachApplicationLocked</code> ,最终是通过AMS的<code>ActivityManagerService.attachApplication</code>来触发的;也就是只要找到<code>mAm.startProcessLocked</code>到<code>ActivityManagerService.attachApplication</code>的调用序列即可证明此猜想;</p><p>我们可以找到如下调用序列，即最终实际上是从ActivityThread的main函数进入的，所以做出以下猜想：<strong>进程启动后，创建ActivityThread时，如果有需要创建的服务，就启动服务；</strong></p><img src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411114715.png alt=image-20210411114715216 style=zoom:50%><p>我们再看<code>attachApplicationLocked</code> 的逻辑，可以发现，会检查<code>mPendingServices</code>中是否有待启动的服务，然后逐一处理，如果有需要启动的服务，则会调用<code>realStartServiceLocked(sr, proc, sr.createdFromFg)</code>来启动服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActiveServices#attachApplicationLocked</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>attachApplicationLocked</span>(ProcessRecord proc, String processName)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> didSomething <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Collect any services that are waiting for this process to come up.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mPendingServices.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>&gt;</span> 0) {
</span></span><span style=display:flex><span>            ServiceRecord sr <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span>0; i<span style=color:#f92672>&lt;</span>mPendingServices.<span style=color:#a6e22e>size</span>(); i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                    sr <span style=color:#f92672>=</span> mPendingServices.<span style=color:#a6e22e>get</span>(i);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 排除非独立Service</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (proc <span style=color:#f92672>!=</span> sr.<span style=color:#a6e22e>isolatedProc</span> <span style=color:#f92672>&amp;&amp;</span> (proc.<span style=color:#a6e22e>uid</span> <span style=color:#f92672>!=</span> sr.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>uid</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>processName.<span style=color:#a6e22e>equals</span>(sr.<span style=color:#a6e22e>processName</span>))) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    mPendingServices.<span style=color:#a6e22e>remove</span>(i);
</span></span><span style=display:flex><span>                    i<span style=color:#f92672>--</span>;
</span></span><span style=display:flex><span>                    proc.<span style=color:#a6e22e>addPackage</span>(sr.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>packageName</span>, sr.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>longVersionCode</span>,
</span></span><span style=display:flex><span>                            mAm.<span style=color:#a6e22e>mProcessStats</span>);
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 启动服务</span>
</span></span><span style=display:flex><span>                    realStartServiceLocked(sr, proc, sr.<span style=color:#a6e22e>createdFromFg</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>                Slog.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;Exception in new application when starting service &#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> sr.<span style=color:#a6e22e>shortInstanceName</span>, e);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><h4 id=activitythreadhandlecreateservice>ActivityThread#handleCreateService<a hidden class=anchor aria-hidden=true href=#activitythreadhandlecreateservice>#</a></h4><p>这里我们省略<code>bringUpServiceLocked</code>方法及下方的几个中间步骤，直接查看<code>android.app.ActivityThread#handleCreateService</code>方法：</p><ol><li>通过ClassLoader加载并实例化了对应的Service对象；</li><li>将Service存储到ActivityThread中的一个ArrayMap中；</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// android/app/ActivityThread.java</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// android.app.ActivityThread#handleCreateService</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> ArrayMap<span style=color:#f92672>&lt;</span>IBinder, Service<span style=color:#f92672>&gt;</span> mServices <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleCreateService</span>(CreateServiceData data) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If we are getting ready to gc after going to the background, well</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// we are back active so skip it.</span>
</span></span><span style=display:flex><span>        unscheduleGcIdler();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        LoadedApk packageInfo <span style=color:#f92672>=</span> getPackageInfoNoCheck(
</span></span><span style=display:flex><span>                data.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>applicationInfo</span>, data.<span style=color:#a6e22e>compatInfo</span>);
</span></span><span style=display:flex><span>        Service service <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (localLOGV) Slog.<span style=color:#a6e22e>v</span>(TAG, <span style=color:#e6db74>&#34;Creating service &#34;</span> <span style=color:#f92672>+</span> data.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ContextImpl context <span style=color:#f92672>=</span> ContextImpl.<span style=color:#a6e22e>createAppContext</span>(<span style=color:#66d9ef>this</span>, packageInfo);
</span></span><span style=display:flex><span>            Application app <span style=color:#f92672>=</span> packageInfo.<span style=color:#a6e22e>makeApplication</span>(<span style=color:#66d9ef>false</span>, mInstrumentation);
</span></span><span style=display:flex><span>            java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>ClassLoader</span> cl <span style=color:#f92672>=</span> packageInfo.<span style=color:#a6e22e>getClassLoader</span>();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 创建对应的Service实例</span>
</span></span><span style=display:flex><span>            service <span style=color:#f92672>=</span> packageInfo.<span style=color:#a6e22e>getAppFactory</span>()
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>instantiateService</span>(cl, data.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>name</span>, data.<span style=color:#a6e22e>intent</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Service resources must be initialized with the same loaders as the application</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// context.</span>
</span></span><span style=display:flex><span>            context.<span style=color:#a6e22e>getResources</span>().<span style=color:#a6e22e>addLoaders</span>(
</span></span><span style=display:flex><span>                    app.<span style=color:#a6e22e>getResources</span>().<span style=color:#a6e22e>getLoaders</span>().<span style=color:#a6e22e>toArray</span>(<span style=color:#66d9ef>new</span> ResourcesLoader<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            context.<span style=color:#a6e22e>setOuterContext</span>(service);
</span></span><span style=display:flex><span>            service.<span style=color:#a6e22e>attach</span>(context, <span style=color:#66d9ef>this</span>, data.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>name</span>, data.<span style=color:#a6e22e>token</span>, app,
</span></span><span style=display:flex><span>                    ActivityManager.<span style=color:#a6e22e>getService</span>());
</span></span><span style=display:flex><span>            service.<span style=color:#a6e22e>onCreate</span>();
</span></span><span style=display:flex><span>            mServices.<span style=color:#a6e22e>put</span>(data.<span style=color:#a6e22e>token</span>, service);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>serviceDoneExecuting</span>(
</span></span><span style=display:flex><span>                        data.<span style=color:#a6e22e>token</span>, SERVICE_DONE_EXECUTING_ANON, 0, 0);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e.<span style=color:#a6e22e>rethrowFromSystemServer</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>mInstrumentation.<span style=color:#a6e22e>onException</span>(service, e)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Unable to create service &#34;</span> <span style=color:#f92672>+</span> data.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;: &#34;</span> <span style=color:#f92672>+</span> e.<span style=color:#a6e22e>toString</span>(), e);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=绑定服务>绑定服务<a hidden class=anchor aria-hidden=true href=#绑定服务>#</a></h3><svg width="698" height="447" viewBox="0 0 698 447" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Android源码分析" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="bindService流程分析-加入启动流程" transform="translate(-125.000000, -273.000000)"><g id="架构图/模块-源码备份-4" transform="translate(523.000000, 273.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="14.2367021" y="14">ActivityManagerService.bindIsolatedService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="44.0851371" y="30.122449">com/android/server/am/ActivityManagerService.java</tspan></text></g><g id="架构图/模块-源码备份-5" transform="translate(523.000000, 322.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="45.2025933" y="14">ActiveServices.bindServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><g id="架构图/模块-源码备份-16" transform="translate(523.000000, 422.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="25.0439991" y="14">IApplicationThread.scheduleBindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="75.1632961" y="30.122449">android/app/IApplicationThread.java</tspan></text></g><g id="架构图/模块-源码备份-17" transform="translate(523.000000, 482.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="102.802928" y="14">Binder.transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="136.553756" y="30.122449">binder</tspan></text></g><g id="架构图/模块-源码备份-18" transform="translate(440.000000, 537.000000)"><rect id="矩形" stroke="#979797" fill="#FFED99" x=".5" y=".5" width="63.3004695" height="182" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="10.224946" y="14">Binder.</tspan><tspan x="6.77075357" y="32">transact</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="19.0044607" y="118.306122">binder</tspan></text></g><g id="架构图/模块-源码备份-10" transform="translate(522.000000, 537.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="27.1213883" y="14">ApplicationThread.scheduleBindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="28.0238818" y="30.122449">frameworks/base/core/java/android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-12" transform="translate(522.000000, 587.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="43.344518" y="14">ActivityThread#handleBindService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="28.0238818" y="30.122449">frameworks/base/core/java/android/app/ActivityThread.java</tspan></text></g><g id="架构图/模块-源码备份-19" transform="translate(522.000000, 637.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="63.1680494" y="14">IBinder = Service.onBinder()</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="104.313756" y="30.122449">自定义的Service实现类</tspan></text></g><g id="架构图/模块-源码备份-20" transform="translate(522.000000, 686.000000)"><rect id="矩形" stroke="#979797" fill="#FFBBA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="48.7055222" y="14">IActivityManager#publishService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="80.4068108" y="30.122449">android/app/IActivityManager.java</tspan></text></g><g id="架构图/模块-源码备份-21" transform="translate(125.000000, 537.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="28.303246" y="14">ActivityManagerService#publishService</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="80.4068108" y="30.122449">android/app/IActivityManager.java</tspan></text></g><g id="架构图/模块-源码备份-23" transform="translate(125.000000, 587.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="34.5841498" y="14">ActiveServices#publishServiceLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><g id="架构图/模块-源码备份-51" transform="translate(125.000000, 638.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="54.5477983" y="14">IServiceConnection#connected</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="148.202627" y="30.122449">-</tspan></text></g><g id="架构图/模块-源码备份-8" transform="translate(523.000000, 373.000000)"><rect id="矩形" stroke="#979797" fill="#D5FFA2" x=".5" y=".5" width="298.399061" height="33" rx="6.9623431"/><text id="方法过程" font-family="NotoSansCJKsc-Bold, Noto Sans CJK SC" font-size="12.1841004" font-weight="bold" letter-spacing=".134025104" fill="#151515" fill-opacity=".88378138"><tspan x="12.0131038" y="14">ActiveServices.requestServiceBindingLocked</tspan></text><text id="代码地址" font-family="NotoSansCJKsc-Light, Noto Sans CJK SC" font-size="8.70292887" font-weight="300" letter-spacing=".0957322235" fill="#151515" fill-opacity=".88378138"><tspan x="62.0131706" y="30.122449">com/android/server/am/ActiveServices.java</tspan></text></g><path id="直线-5" d="M671.935146 307.012222 671.935 315.997 675.675732 315.997076 671.5 323.997076l-4.17573200000004-8L671.064 315.997 671.064854 307.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-6" d="M671.935146 356.012222 671.935 364.997 675.675732 364.997076 671.5 372.997076l-4.17573200000004-8L671.064 364.997 671.064854 356.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-7" d="M671.935146 405.012222 671.935 413.997 675.675732 413.997076 671.5 421.997076l-4.17573200000004-8L671.064 413.997 671.064854 405.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-8" d="M671.935146 454.998187 671.935 473.011 675.675732 473.011111 671.5 481.011111l-4.17573200000004-8L671.064 473.011 671.064854 454.998187H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-9" d="M671.935146 514.990779 671.935 530.018 675.675732 530.018519 671.5 538.018519l-4.17573200000004-8L671.064 530.018 671.064854 514.990779H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-10" d="M671.935146 571.012222 671.935 579.997 675.675732 579.997076 671.5 587.997076l-4.17573200000004-8L671.064 579.997 671.064854 571.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-18" d="M671.935146 621.012222 671.935 629.997 675.675732 629.997076 671.5 637.997076l-4.17573200000004-8L671.064 629.997 671.064854 621.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-11" d="M671.935146 671.012222 671.935 679.997 675.675732 679.997076 671.5 687.997076l-4.17573200000004-8L671.064 679.997 671.064854 671.012222H671.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-19" d="M511.984127 699.324268 511.984 703.064 522.006575 703.064854V703.935146L511.984 703.935 511.984127 707.675732 503.984127 703.5l8-4.17573200000004z" fill="#979797" fill-rule="nonzero"/><path id="直线-20" d="M431.980556 550.324268 431.98 554.064 441.010146 554.064854V554.935146L431.98 554.935 431.980556 558.675732 423.980556 554.5l8-4.17573200000004z" fill="#979797" fill-rule="nonzero"/><path id="直线-12" d="M272.935146 571.012222 272.935 579.997 276.675732 579.997076 272.5 587.997076l-4.17573199999998-8L272.064 579.997 272.064854 571.012222H272.935146z" fill="#979797" fill-rule="nonzero"/><path id="直线-12备份" d="M272.935146 621.012222 272.935 629.997 276.675732 629.997076 272.5 637.997076l-4.17573199999998-8L272.064 629.997 272.064854 621.012222H272.935146z" fill="#979797" fill-rule="nonzero"/></g></g></svg><p>我们的问题是：</p><ol><li>绑定服务时，传入的ServiceConnection对象，如何被调用来通知？</li><li>还做了些什么？</li></ol><h4 id=连接对象去哪里了>连接对象去哪里了？<a hidden class=anchor aria-hidden=true href=#连接对象去哪里了>#</a></h4><p>查看<code>ContextImpl.bindServiceCommon</code>方法可以看到，传入了参数 <code>ServiceConnection conn</code>，然后方法中这个conn放入到了一个 <code>ServiceDispatcher</code> 中.</p><ul><li>IServiceConnection 包含两个接口：<ul><li>connected(): 连接到服务</li><li>asBinder()： 服务转Binder</li></ul></li><li>这里会将我们自行编写的ServiceConnection对象构造出一个ServiceDispatcher对象，然后将ServiceDispatcher提供一个IServiceconnection接口（<code>ServiceDispatcher$InnerConnection</code>类），用于提供服务；</li><li>这个<code>ServiceDispatcher$InnerConnection</code>类的connect方法会调用sd的connect方法，最终会调用我们提供的ServiceConnection的回调方法：<code>mConnection.onServiceConnected(name, service)</code></li></ul><p>也就是说，使用<code>sd.connect()</code>就可以触发我们的连接对象的<code>onServiceConnected</code>回调方法；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#a6e22e>@NonNull</span> LoadedApk mPackageInfo;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>bindServiceCommon</span>(Intent service, ServiceConnection conn, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, Handler handler, Executor executor, UserHandle user) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 这个IServiceConnection 实际上就是持有ServiceDispatcher的弱引用对象，然后将ServiceDispatcher的少量方法暴露出去</span>
</span></span><span style=display:flex><span>        IServiceConnection sd;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mPackageInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (executor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// mPackageInfo 是一个 LoadedApk 对象</span>
</span></span><span style=display:flex><span>                sd <span style=color:#f92672>=</span> mPackageInfo.<span style=color:#a6e22e>getServiceDispatcher</span>(conn, getOuterContext(), executor, flags);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                sd <span style=color:#f92672>=</span> mPackageInfo.<span style=color:#a6e22e>getServiceDispatcher</span>(conn, getOuterContext(), handler, flags);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>bindIsolatedService</span>(
</span></span><span style=display:flex><span>                mMainThread.<span style=color:#a6e22e>getApplicationThread</span>(), getActivityToken(), service,
</span></span><span style=display:flex><span>                service.<span style=color:#a6e22e>resolveTypeIfNeeded</span>(getContentResolver()),
</span></span><span style=display:flex><span>	            <span style=color:#75715e>// 调用AMS的服务式这里传入了sd</span>
</span></span><span style=display:flex><span>                sd, flags, instanceName, getOpPackageName(), user.<span style=color:#a6e22e>getIdentifier</span>());
</span></span><span style=display:flex><span>        <span style=color:#75715e>//... </span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActiveServices#bindServiceLocked</span>
</span></span><span style=display:flex><span>AppBindRecord b <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>retrieveAppBindingLocked</span>(service, callerApp);
</span></span><span style=display:flex><span>            ConnectionRecord c <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionRecord(b, activity,
</span></span><span style=display:flex><span>                    connection, flags, clientLabel, clientIntent,
</span></span><span style=display:flex><span>                    callerApp.<span style=color:#a6e22e>uid</span>, callerApp.<span style=color:#a6e22e>processName</span>, callingPackage);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 提供 IBinder </span>
</span></span><span style=display:flex><span>            IBinder binder <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>asBinder</span>();
</span></span><span style=display:flex><span>            s.<span style=color:#a6e22e>addConnection</span>(binder, c);
</span></span><span style=display:flex><span>            b.<span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>add</span>(c);
</span></span></code></pre></div><p>ServiceDispatcher类位于 <code>android.app.LoadedApk.ServiceDispatcher</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// frameworks/base/core/java/android/app/LoadedApk.java</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> IServiceConnection <span style=color:#a6e22e>getServiceDispatcher</span>(ServiceConnection c,
</span></span><span style=display:flex><span>            Context context, Executor executor, <span style=color:#66d9ef>int</span> flags) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> getServiceDispatcherCommon(c, context, <span style=color:#66d9ef>null</span>, executor, flags);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> IServiceConnection <span style=color:#a6e22e>getServiceDispatcherCommon</span>(ServiceConnection c,
</span></span><span style=display:flex><span>            Context context, Handler handler, Executor executor, <span style=color:#66d9ef>int</span> flags) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> (mServices) {
</span></span><span style=display:flex><span>            LoadedApk.<span style=color:#a6e22e>ServiceDispatcher</span> sd <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            ArrayMap<span style=color:#f92672>&lt;</span>ServiceConnection, LoadedApk.<span style=color:#a6e22e>ServiceDispatcher</span><span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span> mServices.<span style=color:#a6e22e>get</span>(context);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (map <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (DEBUG) Slog.<span style=color:#a6e22e>d</span>(TAG, <span style=color:#e6db74>&#34;Returning existing dispatcher &#34;</span> <span style=color:#f92672>+</span> sd <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for conn &#34;</span> <span style=color:#f92672>+</span> c);
</span></span><span style=display:flex><span>                sd <span style=color:#f92672>=</span> map.<span style=color:#a6e22e>get</span>(c);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sd <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (executor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    sd <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServiceDispatcher(c, context, executor, flags);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    sd <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServiceDispatcher(c, context, handler, flags);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (DEBUG) Slog.<span style=color:#a6e22e>d</span>(TAG, <span style=color:#e6db74>&#34;Creating new dispatcher &#34;</span> <span style=color:#f92672>+</span> sd <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; for conn &#34;</span> <span style=color:#f92672>+</span> c);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (map <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>                    mServices.<span style=color:#a6e22e>put</span>(context, map);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                map.<span style=color:#a6e22e>put</span>(c, sd);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                sd.<span style=color:#a6e22e>validate</span>(context, handler, executor);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> sd.<span style=color:#a6e22e>getIServiceConnection</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceDispatcher</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ServiceDispatcher.<span style=color:#a6e22e>InnerConnection</span> mIServiceConnection;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ServiceConnection mConnection;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@UnsupportedAppUsage</span>(maxTargetSdk <span style=color:#f92672>=</span> Build.<span style=color:#a6e22e>VERSION_CODES</span>.<span style=color:#a6e22e>P</span>, trackingBug <span style=color:#f92672>=</span> 115609023)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Context mContext;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Handler mActivityThread;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Executor mActivityExecutor;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ServiceConnectionLeaked mLocation;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> mFlags;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InnerConnection</span> <span style=color:#66d9ef>extends</span> IServiceConnection.<span style=color:#a6e22e>Stub</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> WeakReference<span style=color:#f92672>&lt;</span>LoadedApk.<span style=color:#a6e22e>ServiceDispatcher</span><span style=color:#f92672>&gt;</span> mDispatcher;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        InnerConnection(LoadedApk.<span style=color:#a6e22e>ServiceDispatcher</span> sd) {
</span></span><span style=display:flex><span>            mDispatcher <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WeakReference<span style=color:#f92672>&lt;</span>LoadedApk.<span style=color:#a6e22e>ServiceDispatcher</span><span style=color:#f92672>&gt;</span>(sd);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connected</span>(ComponentName name, IBinder service, <span style=color:#66d9ef>boolean</span> dead)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>            LoadedApk.<span style=color:#a6e22e>ServiceDispatcher</span> sd <span style=color:#f92672>=</span> mDispatcher.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sd <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                sd.<span style=color:#a6e22e>connected</span>(name, service, dead);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@UnsupportedAppUsage</span>
</span></span><span style=display:flex><span>    ServiceDispatcher(ServiceConnection conn,
</span></span><span style=display:flex><span>                      Context context, Handler activityThread, <span style=color:#66d9ef>int</span> flags) {
</span></span><span style=display:flex><span>        mIServiceConnection <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> InnerConnection(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>        mConnection <span style=color:#f92672>=</span> conn;
</span></span><span style=display:flex><span>        mContext <span style=color:#f92672>=</span> context;
</span></span><span style=display:flex><span>        mActivityThread <span style=color:#f92672>=</span> activityThread;
</span></span><span style=display:flex><span>        mActivityExecutor <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        mLocation <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServiceConnectionLeaked(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        mLocation.<span style=color:#a6e22e>fillInStackTrace</span>();
</span></span><span style=display:flex><span>        mFlags <span style=color:#f92672>=</span> flags;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ServiceConnection <span style=color:#a6e22e>getServiceConnection</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> mConnection;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SD中提供了connected方法</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>connected</span>(ComponentName name, IBinder service, <span style=color:#66d9ef>boolean</span> dead) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mActivityExecutor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            mActivityExecutor.<span style=color:#a6e22e>execute</span>(<span style=color:#66d9ef>new</span> RunConnection(name, service, 0, dead));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (mActivityThread <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            mActivityThread.<span style=color:#a6e22e>post</span>(<span style=color:#66d9ef>new</span> RunConnection(name, service, 0, dead));
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            doConnected(name, service, dead);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doConnected</span>(ComponentName name, IBinder service, <span style=color:#66d9ef>boolean</span> dead) {
</span></span><span style=display:flex><span>        ServiceDispatcher.<span style=color:#a6e22e>ConnectionInfo</span> old;
</span></span><span style=display:flex><span>        ServiceDispatcher.<span style=color:#a6e22e>ConnectionInfo</span> info;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> (<span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mForgotten) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// We unbound before receiving the connection; ignore</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// any connection received.</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            old <span style=color:#f92672>=</span> mActiveConnections.<span style=color:#a6e22e>get</span>(name);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (old <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> old.<span style=color:#a6e22e>binder</span> <span style=color:#f92672>==</span> service) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Huh, already have this one.  Oh well!</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (service <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// A new service is being connected... set it all up.</span>
</span></span><span style=display:flex><span>                info <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionInfo();
</span></span><span style=display:flex><span>                info.<span style=color:#a6e22e>binder</span> <span style=color:#f92672>=</span> service;
</span></span><span style=display:flex><span>                info.<span style=color:#a6e22e>deathMonitor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DeathMonitor(name, service);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    service.<span style=color:#a6e22e>linkToDeath</span>(info.<span style=color:#a6e22e>deathMonitor</span>, 0);
</span></span><span style=display:flex><span>                    mActiveConnections.<span style=color:#a6e22e>put</span>(name, info);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// This service was dead before we got it...  just</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// don&#39;t do anything with it.</span>
</span></span><span style=display:flex><span>                    mActiveConnections.<span style=color:#a6e22e>remove</span>(name);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// The named service is being disconnected... clean up.</span>
</span></span><span style=display:flex><span>                mActiveConnections.<span style=color:#a6e22e>remove</span>(name);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (old <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                old.<span style=color:#a6e22e>binder</span>.<span style=color:#a6e22e>unlinkToDeath</span>(old.<span style=color:#a6e22e>deathMonitor</span>, 0);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If there was an old service, it is now disconnected.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (old <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            mConnection.<span style=color:#a6e22e>onServiceDisconnected</span>(name);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (dead) {
</span></span><span style=display:flex><span>            mConnection.<span style=color:#a6e22e>onBindingDied</span>(name);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If there is a new viable service, it is now connected.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (service <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            mConnection.<span style=color:#a6e22e>onServiceConnected</span>(name, service);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// The binding machinery worked, but the remote returned null from onBind().</span>
</span></span><span style=display:flex><span>            mConnection.<span style=color:#a6e22e>onNullBinding</span>(name);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=iserviceconnection说明>IServiceConnection说明<a hidden class=anchor aria-hidden=true href=#iserviceconnection说明>#</a></h4><blockquote><p>服务绑定时，IServiceConnection的用途？如何实现在APP的Activity进程中调用ServiceConnection的onServiceConnected方法？</p></blockquote><ul><li>IServiceConnect的服务端位于APP进程中，在ContextImpl的binderServiceCommon方法中初始化，也就是LoadApk类中的ServiceDispatcher类。</li><li>传递给AMS的实际上是一个Binder的远程代理对象；</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// android.app.IActivityManager.Stub#TRANSACTION_bindService</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// android/app/IActivityManager.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> TRANSACTION_bindService:
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>          data.<span style=color:#a6e22e>enforceInterface</span>(descriptor);
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span> _arg0;
</span></span><span style=display:flex><span>          _arg0 <span style=color:#f92672>=</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IApplicationThread</span>.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(data.<span style=color:#a6e22e>readStrongBinder</span>());
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IBinder</span> _arg1;
</span></span><span style=display:flex><span>          _arg1 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readStrongBinder</span>();
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>Intent</span> _arg2;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> ((0<span style=color:#f92672>!=</span>data.<span style=color:#a6e22e>readInt</span>())) {
</span></span><span style=display:flex><span>            _arg2 <span style=color:#f92672>=</span> android.<span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>Intent</span>.<span style=color:#a6e22e>CREATOR</span>.<span style=color:#a6e22e>createFromParcel</span>(data);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            _arg2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> _arg3;
</span></span><span style=display:flex><span>          _arg3 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readString</span>();
</span></span><span style=display:flex><span>          android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span> _arg4;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 这里可以看到，是在这个地方见IServiceConnection的服务端对象转换成客户端代理对象的</span>
</span></span><span style=display:flex><span>          _arg4 <span style=color:#f92672>=</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span>.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>asInterface</span>(data.<span style=color:#a6e22e>readStrongBinder</span>());
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>int</span> _arg5;
</span></span><span style=display:flex><span>          _arg5 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>          java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> _arg6;
</span></span><span style=display:flex><span>          _arg6 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readString</span>();
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>int</span> _arg7;
</span></span><span style=display:flex><span>          _arg7 <span style=color:#f92672>=</span> data.<span style=color:#a6e22e>readInt</span>();
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>int</span> _result <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bindService</span>(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7);
</span></span><span style=display:flex><span>          reply.<span style=color:#a6e22e>writeNoException</span>();
</span></span><span style=display:flex><span>          reply.<span style=color:#a6e22e>writeInt</span>(_result);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><p>asInterface 中： <code>new android.app.IServiceConnection.Stub.Proxy(obj)</code> 即是将Stub转换为Proxy对象；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#75715e>/** Local-side IPC implementation stub class. */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Stub</span> <span style=color:#66d9ef>extends</span> android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Binder</span> <span style=color:#66d9ef>implements</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>String</span> DESCRIPTOR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;android.app.IServiceConnection&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** Construct the stub at attach it to the interface. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Stub</span>()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attachInterface</span>(<span style=color:#66d9ef>this</span>, DESCRIPTOR);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Cast an IBinder object into an android.app.IServiceConnection interface,
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * generating a proxy if needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span> <span style=color:#a6e22e>asInterface</span>(android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IBinder</span> obj)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ((obj<span style=color:#f92672>==</span><span style=color:#66d9ef>null</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>IInterface</span> iin <span style=color:#f92672>=</span> obj.<span style=color:#a6e22e>queryLocalInterface</span>(DESCRIPTOR);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (((iin<span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span>)<span style=color:#f92672>&amp;&amp;</span>(iin <span style=color:#66d9ef>instanceof</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span>))) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ((android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span>)iin);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> android.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>IServiceConnection</span>.<span style=color:#a6e22e>Stub</span>.<span style=color:#a6e22e>Proxy</span>(obj);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>也就是说，ActivityManagerService.bindService方法中的IServiceConnection参数实际上是一个Proxy对象；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// 这里的Connection是一个代理对象</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>bindService</span>(IApplicationThread caller, IBinder token, Intent service,
</span></span><span style=display:flex><span>            String resolvedType, IServiceConnection connection, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String callingPackage, <span style=color:#66d9ef>int</span> userId) <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bindIsolatedService(caller, token, service, resolvedType, connection, flags,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>null</span>, callingPackage, userId);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=activitythreadhandlebindservice>ActivityThread#handleBindService<a hidden class=anchor aria-hidden=true href=#activitythreadhandlebindservice>#</a></h4><p>实际上就做了两件事情</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// android.app.ActivityThread#handleBindService</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/core/java/android/app/ActivityThread.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleBindService</span>(BindServiceData data) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取之前创建的服务</span>
</span></span><span style=display:flex><span>        Service s <span style=color:#f92672>=</span> mServices.<span style=color:#a6e22e>get</span>(data.<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (s <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) { <span style=color:#75715e>// 找不到之前创建的服务，则什么都不做</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                data.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>setExtrasClassLoader</span>(s.<span style=color:#a6e22e>getClassLoader</span>());
</span></span><span style=display:flex><span>                data.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>prepareToEnterProcess</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>data.<span style=color:#a6e22e>rebind</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 调用Service的onBind接口获取IBinder对象</span>
</span></span><span style=display:flex><span>                        IBinder binder <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>onBind</span>(data.<span style=color:#a6e22e>intent</span>);
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// 通知AMS来publicService</span>
</span></span><span style=display:flex><span>                        ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>publishService</span>(
</span></span><span style=display:flex><span>                                data.<span style=color:#a6e22e>token</span>, data.<span style=color:#a6e22e>intent</span>, binder);
</span></span><span style=display:flex><span>                    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                        s.<span style=color:#a6e22e>onRebind</span>(data.<span style=color:#a6e22e>intent</span>);
</span></span><span style=display:flex><span>                        ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>serviceDoneExecuting</span>(
</span></span><span style=display:flex><span>                                data.<span style=color:#a6e22e>token</span>, SERVICE_DONE_EXECUTING_ANON, 0, 0);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (RemoteException ex) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> ex.<span style=color:#a6e22e>rethrowFromSystemServer</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h4 id=activitymanagerservicepublishservice>ActivityManagerService#publishService<a hidden class=anchor aria-hidden=true href=#activitymanagerservicepublishservice>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActivityManagerService#publishService</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>publishService</span>(IBinder token, Intent intent, IBinder service) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Refuse possible leaked file descriptors</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (intent <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> intent.<span style=color:#a6e22e>hasFileDescriptors</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;File descriptors passed in Intent&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span>(<span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(token <span style=color:#66d9ef>instanceof</span> ServiceRecord)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Invalid service token&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// com.android.server.am.ActiveServices#publishServiceLocked</span>
</span></span><span style=display:flex><span>            mServices.<span style=color:#a6e22e>publishServiceLocked</span>((ServiceRecord)token, intent, service);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h4 id=activeservicespublishservicelocked>ActiveServices#publishServiceLocked<a hidden class=anchor aria-hidden=true href=#activeservicespublishservicelocked>#</a></h4><p>下面我们可以看到，在publishServiceLocked方法中，取出了一个连接记录列表，然后循环的调用了其中的IServiceConnection的connected方法，也就是会调用到我们自行定义的ServiceConnnection对象的connected方法。</p><p>不过我们有个问题，就是这个ConnectionRecord对象是何时构造的？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ConnectionRecord</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ConnectionRecord.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConnectionRecord</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> AppBindRecord binding;    <span style=color:#75715e>// The application/service binding.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> ActivityServiceConnectionsHolder<span style=color:#f92672>&lt;</span>ConnectionRecord<span style=color:#f92672>&gt;</span> activity;  <span style=color:#75715e>// If non-null, the owning activity.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> IServiceConnection conn;  <span style=color:#75715e>// The client connection.</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// com.android.server.am.ActiveServices#publishServiceLocked</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>publishServiceLocked</span>(ServiceRecord r, Intent intent, IBinder service) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> origId <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>clearCallingIdentity</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果服务记录为null，就什么都不做</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (r <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                Intent.<span style=color:#a6e22e>FilterComparison</span> filter
</span></span><span style=display:flex><span>                        <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Intent.<span style=color:#a6e22e>FilterComparison</span>(intent);
</span></span><span style=display:flex><span>                IntentBindRecord b <span style=color:#f92672>=</span> r.<span style=color:#a6e22e>bindings</span>.<span style=color:#a6e22e>get</span>(filter);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (b <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>b.<span style=color:#a6e22e>received</span>) {
</span></span><span style=display:flex><span>                    b.<span style=color:#a6e22e>binder</span> <span style=color:#f92672>=</span> service;
</span></span><span style=display:flex><span>                    b.<span style=color:#a6e22e>requested</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>                    b.<span style=color:#a6e22e>received</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 取出连接记录ConnectionRecord</span>
</span></span><span style=display:flex><span>                    ArrayMap<span style=color:#f92672>&lt;</span>IBinder, ArrayList<span style=color:#f92672>&lt;</span>ConnectionRecord<span style=color:#f92672>&gt;&gt;</span> connections <span style=color:#f92672>=</span> r.<span style=color:#a6e22e>getConnections</span>();
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> conni <span style=color:#f92672>=</span> connections.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>-</span> 1; conni <span style=color:#f92672>&gt;=</span> 0; conni<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>                        ArrayList<span style=color:#f92672>&lt;</span>ConnectionRecord<span style=color:#f92672>&gt;</span> clist <span style=color:#f92672>=</span> connections.<span style=color:#a6e22e>valueAt</span>(conni);
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> clist.<span style=color:#a6e22e>size</span>(); i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>                            ConnectionRecord c <span style=color:#f92672>=</span> clist.<span style=color:#a6e22e>get</span>(i);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                                <span style=color:#75715e>// 调用IServiceConnection的connected方法</span>
</span></span><span style=display:flex><span>                                c.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>connected</span>(r.<span style=color:#a6e22e>name</span>, service, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>                            } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                               
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                serviceDoneExecutingLocked(r, mDestroyingServices.<span style=color:#a6e22e>contains</span>(r), <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h4 id=构造-connectionrecord---bindservicelocked>构造 ConnectionRecord - bindServiceLocked<a hidden class=anchor aria-hidden=true href=#构造-connectionrecord---bindservicelocked>#</a></h4><p>实际上这个构建ConnectRecord的过程位于bindServiceLocked方法中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>bindServiceLocked</span>(IApplicationThread caller, IBinder token, Intent service,
</span></span><span style=display:flex><span>                          String resolvedType, <span style=color:#66d9ef>final</span> IServiceConnection connection, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>                          String instanceName, String callingPackage, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> userId)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingPid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingPid</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingUid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingUid</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ActivityServiceConnectionsHolder<span style=color:#f92672>&lt;</span>ConnectionRecord<span style=color:#f92672>&gt;</span> activity <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (token <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            activity <span style=color:#f92672>=</span> mAm.<span style=color:#a6e22e>mAtmInternal</span>.<span style=color:#a6e22e>getServiceConnectionsHolder</span>(token);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (activity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                Slog.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;Binding with unknown activity: &#34;</span> <span style=color:#f92672>+</span> token);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ServiceLookupResult res <span style=color:#f92672>=</span> retrieveServiceLocked(service, instanceName, resolvedType, callingPackage,
</span></span><span style=display:flex><span>                        callingPid, callingUid, userId, <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        callerFg, isBindExternal, allowInstant);
</span></span><span style=display:flex><span>        ServiceRecord s <span style=color:#f92672>=</span> res.<span style=color:#a6e22e>record</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            AppBindRecord b <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>retrieveAppBindingLocked</span>(service, callerApp);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 构造连接记录对象</span>
</span></span><span style=display:flex><span>            ConnectionRecord c <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionRecord(b, activity,
</span></span><span style=display:flex><span>                    connection, flags, clientLabel, clientIntent,
</span></span><span style=display:flex><span>                    callerApp.<span style=color:#a6e22e>uid</span>, callerApp.<span style=color:#a6e22e>processName</span>, callingPackage);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            IBinder binder <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>asBinder</span>();
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 添加到ServiceRecord对象中</span>
</span></span><span style=display:flex><span>            s.<span style=color:#a6e22e>addConnection</span>(binder, c);
</span></span><span style=display:flex><span>            b.<span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>add</span>(c);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (activity <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                activity.<span style=color:#a6e22e>addConnection</span>(c);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            b.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>add</span>(c);
</span></span><span style=display:flex><span>            c.<span style=color:#a6e22e>startAssociationIfNeeded</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 1;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h2 id=部分方法的源码>部分方法的源码<a hidden class=anchor aria-hidden=true href=#部分方法的源码>#</a></h2><h3 id=contextimplbindservice>ContextImpl.<code>bindService</code><a hidden class=anchor aria-hidden=true href=#contextimplbindservice>#</a></h3><ul><li><p><code>bindService</code> : (<code>frameworks/base/core/java/android/app/ContextImpl.java</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>bindService</span>(Intent service, ServiceConnection conn, <span style=color:#66d9ef>int</span> flags) {
</span></span><span style=display:flex><span>        warnIfCallingFromSystemProcess();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bindServiceCommon(service, conn, flags, <span style=color:#66d9ef>null</span>, mMainThread.<span style=color:#a6e22e>getHandler</span>(), <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>                getUser());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>bindService</span>(
</span></span><span style=display:flex><span>            Intent service, <span style=color:#66d9ef>int</span> flags, Executor executor, ServiceConnection conn) {
</span></span><span style=display:flex><span>        warnIfCallingFromSystemProcess();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bindServiceCommon(service, conn, flags, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, executor, getUser());
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div></li></ul><h3 id=contextimplbindservicecommon-1>ContextImpl.bindServiceCommon<a hidden class=anchor aria-hidden=true href=#contextimplbindservicecommon-1>#</a></h3><ul><li><p><code>bindServiceCommon</code>: (<code>frameworks/base/core/java/android/app/ContextImpl.java</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>bindServiceCommon</span>(Intent service, ServiceConnection conn, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, Handler handler, Executor executor, UserHandle user) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span>
</span></span><span style=display:flex><span>        IServiceConnection sd;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (conn <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;connection is null&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (handler <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> executor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException(<span style=color:#e6db74>&#34;Handler and Executor both supplied&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mPackageInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (executor <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                sd <span style=color:#f92672>=</span> mPackageInfo.<span style=color:#a6e22e>getServiceDispatcher</span>(conn, getOuterContext(), executor, flags);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                sd <span style=color:#f92672>=</span> mPackageInfo.<span style=color:#a6e22e>getServiceDispatcher</span>(conn, getOuterContext(), handler, flags);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;Not supported in system context&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        validateServiceIntent(service);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// WindowContext构造函数中的 WindowTokenClient</span>
</span></span><span style=display:flex><span>            IBinder token <span style=color:#f92672>=</span> getActivityToken();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (token <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> (flags<span style=color:#f92672>&amp;</span>BIND_AUTO_CREATE) <span style=color:#f92672>==</span> 0 <span style=color:#f92672>&amp;&amp;</span> mPackageInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&amp;&amp;</span> mPackageInfo.<span style=color:#a6e22e>getApplicationInfo</span>().<span style=color:#a6e22e>targetSdkVersion</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;</span> android.<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Build</span>.<span style=color:#a6e22e>VERSION_CODES</span>.<span style=color:#a6e22e>ICE_CREAM_SANDWICH</span>) {
</span></span><span style=display:flex><span>                flags <span style=color:#f92672>|=</span> BIND_WAIVE_PRIORITY;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            service.<span style=color:#a6e22e>prepareToLeaveProcess</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> res <span style=color:#f92672>=</span> ActivityManager.<span style=color:#a6e22e>getService</span>().<span style=color:#a6e22e>bindIsolatedService</span>(
</span></span><span style=display:flex><span>                mMainThread.<span style=color:#a6e22e>getApplicationThread</span>(), getActivityToken(), service,
</span></span><span style=display:flex><span>                service.<span style=color:#a6e22e>resolveTypeIfNeeded</span>(getContentResolver()),
</span></span><span style=display:flex><span>                sd, flags, instanceName, getOpPackageName(), user.<span style=color:#a6e22e>getIdentifier</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>&lt;</span> 0) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> SecurityException(
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;Not allowed to bind to service &#34;</span> <span style=color:#f92672>+</span> service);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> res <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (RemoteException e) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> e.<span style=color:#a6e22e>rethrowFromSystemServer</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div></li></ul><h3 id=activitymanagerservicebindisolatedservice>ActivityManagerService.bindIsolatedService<a hidden class=anchor aria-hidden=true href=#activitymanagerservicebindisolatedservice>#</a></h3><p>从这里开始，实际上位于AMS的Server端了，即我们的Activity所在的进程发送了一个启动服务的IPC请求给AMS（sysmte_server进程中）。</p><ul><li><p>ActivityManagerService.java : (frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>bindIsolatedService</span>(IApplicationThread caller, IBinder token, Intent service,
</span></span><span style=display:flex><span>            String resolvedType, IServiceConnection connection, <span style=color:#66d9ef>int</span> flags, String instanceName,
</span></span><span style=display:flex><span>            String callingPackage, <span style=color:#66d9ef>int</span> userId) <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// .... </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span>(<span style=color:#66d9ef>this</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用Binder接口</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> mServices.<span style=color:#a6e22e>bindServiceLocked</span>(caller, token, service,
</span></span><span style=display:flex><span>                    resolvedType, connection, flags, instanceName, callingPackage, userId);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div></li></ul><p><img alt=image-20210409144356311 loading=lazy src=https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210409144356.png></p><h3 id=activeservicesbindservicelocked-1>ActiveServices.bindServiceLocked<a hidden class=anchor aria-hidden=true href=#activeservicesbindservicelocked-1>#</a></h3><ul><li><p><code>ActiveServices.bindServiceLocked</code>: (<code>frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</code>)</p></li><li><p>这个方法有点长，我们截取重要部分</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>bindServiceLocked</span>(IApplicationThread caller, IBinder token, Intent service,
</span></span><span style=display:flex><span>            String resolvedType, <span style=color:#66d9ef>final</span> IServiceConnection connection, <span style=color:#66d9ef>int</span> flags,
</span></span><span style=display:flex><span>            String instanceName, String callingPackage, <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> userId)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throws</span> TransactionTooLargeException {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取调用方的权限</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingPid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingPid</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> callingUid <span style=color:#f92672>=</span> Binder.<span style=color:#a6e22e>getCallingUid</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ProcessRecord callerApp <span style=color:#f92672>=</span> mAm.<span style=color:#a6e22e>getRecordForAppLocked</span>(caller);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (callerApp <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> SecurityException(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Unable to find app for caller &#34;</span> <span style=color:#f92672>+</span> caller
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; (pid=&#34;</span> <span style=color:#f92672>+</span> callingPid
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;) when binding service &#34;</span> <span style=color:#f92672>+</span> service);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ActivityServiceConnectionsHolder<span style=color:#f92672>&lt;</span>ConnectionRecord<span style=color:#f92672>&gt;</span> activity <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (token <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            activity <span style=color:#f92672>=</span> mAm.<span style=color:#a6e22e>mAtmInternal</span>.<span style=color:#a6e22e>getServiceConnectionsHolder</span>(token);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (activity <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                Slog.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;Binding with unknown activity: &#34;</span> <span style=color:#f92672>+</span> token);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> clientLabel <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>        PendingIntent clientIntent <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isCallerSystem <span style=color:#f92672>=</span> callerApp.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>uid</span> <span style=color:#f92672>==</span> Process.<span style=color:#a6e22e>SYSTEM_UID</span>;
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> callerFg <span style=color:#f92672>=</span> callerApp.<span style=color:#a6e22e>setSchedGroup</span> <span style=color:#f92672>!=</span> ProcessList.<span style=color:#a6e22e>SCHED_GROUP_BACKGROUND</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> isBindExternal <span style=color:#f92672>=</span> (flags <span style=color:#f92672>&amp;</span> Context.<span style=color:#a6e22e>BIND_EXTERNAL_SERVICE</span>) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> allowInstant <span style=color:#f92672>=</span> (flags <span style=color:#f92672>&amp;</span> Context.<span style=color:#a6e22e>BIND_ALLOW_INSTANT</span>) <span style=color:#f92672>!=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ServiceLookupResult res <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>            retrieveServiceLocked(service, instanceName, resolvedType, callingPackage,
</span></span><span style=display:flex><span>                    callingPid, callingUid, userId, <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                    callerFg, isBindExternal, allowInstant);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (res.<span style=color:#a6e22e>record</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>1;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        ServiceRecord s <span style=color:#f92672>=</span> res.<span style=color:#a6e22e>record</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (unscheduleServiceRestartLocked(s, callerApp.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>uid</span>, <span style=color:#66d9ef>false</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (DEBUG_SERVICE) Slog.<span style=color:#a6e22e>v</span>(TAG_SERVICE, <span style=color:#e6db74>&#34;BIND SERVICE WHILE RESTART PENDING: &#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> s);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((flags<span style=color:#f92672>&amp;</span>Context.<span style=color:#a6e22e>BIND_AUTO_CREATE</span>) <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>                s.<span style=color:#a6e22e>lastActivity</span> <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>s.<span style=color:#a6e22e>hasAutoCreateConnections</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// This is the first binding, let the tracker know.</span>
</span></span><span style=display:flex><span>                    ServiceState stracker <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>getTracker</span>();
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (stracker <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                        stracker.<span style=color:#a6e22e>setBound</span>(<span style=color:#66d9ef>true</span>, mAm.<span style=color:#a6e22e>mProcessStats</span>.<span style=color:#a6e22e>getMemFactorLocked</span>(),
</span></span><span style=display:flex><span>                                s.<span style=color:#a6e22e>lastActivity</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((flags <span style=color:#f92672>&amp;</span> Context.<span style=color:#a6e22e>BIND_RESTRICT_ASSOCIATIONS</span>) <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>                mAm.<span style=color:#a6e22e>requireAllowedAssociationsLocked</span>(s.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>packageName</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            mAm.<span style=color:#a6e22e>startAssociationLocked</span>(callerApp.<span style=color:#a6e22e>uid</span>, callerApp.<span style=color:#a6e22e>processName</span>,
</span></span><span style=display:flex><span>                    callerApp.<span style=color:#a6e22e>getCurProcState</span>(), s.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>uid</span>, s.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>longVersionCode</span>,
</span></span><span style=display:flex><span>                    s.<span style=color:#a6e22e>instanceName</span>, s.<span style=color:#a6e22e>processName</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Once the apps have become associated, if one of them is caller is ephemeral</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// the target app should now be able to see the calling app</span>
</span></span><span style=display:flex><span>            mAm.<span style=color:#a6e22e>grantImplicitAccess</span>(callerApp.<span style=color:#a6e22e>userId</span>, service,
</span></span><span style=display:flex><span>                    callerApp.<span style=color:#a6e22e>uid</span>, UserHandle.<span style=color:#a6e22e>getAppId</span>(s.<span style=color:#a6e22e>appInfo</span>.<span style=color:#a6e22e>uid</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            AppBindRecord b <span style=color:#f92672>=</span> s.<span style=color:#a6e22e>retrieveAppBindingLocked</span>(service, callerApp);
</span></span><span style=display:flex><span>            ConnectionRecord c <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionRecord(b, activity,
</span></span><span style=display:flex><span>                    connection, flags, clientLabel, clientIntent,
</span></span><span style=display:flex><span>                    callerApp.<span style=color:#a6e22e>uid</span>, callerApp.<span style=color:#a6e22e>processName</span>, callingPackage);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            IBinder binder <span style=color:#f92672>=</span> connection.<span style=color:#a6e22e>asBinder</span>();
</span></span><span style=display:flex><span>            s.<span style=color:#a6e22e>addConnection</span>(binder, c);
</span></span><span style=display:flex><span>            b.<span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>add</span>(c);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (activity <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                activity.<span style=color:#a6e22e>addConnection</span>(c);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            b.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>add</span>(c);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (s.<span style=color:#a6e22e>app</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                updateServiceClientActivitiesLocked(s.<span style=color:#a6e22e>app</span>, c, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            ArrayList<span style=color:#f92672>&lt;</span>ConnectionRecord<span style=color:#f92672>&gt;</span> clist <span style=color:#f92672>=</span> mServiceConnections.<span style=color:#a6e22e>get</span>(binder);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (clist <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                clist <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>                mServiceConnections.<span style=color:#a6e22e>put</span>(binder, clist);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            clist.<span style=color:#a6e22e>add</span>(c);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((flags<span style=color:#f92672>&amp;</span>Context.<span style=color:#a6e22e>BIND_AUTO_CREATE</span>) <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>                s.<span style=color:#a6e22e>lastActivity</span> <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (bringUpServiceLocked(s, service.<span style=color:#a6e22e>getFlags</span>(), callerFg, <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>                        permissionsReviewRequired) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (s.<span style=color:#a6e22e>app</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> b.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>received</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Service is already running, so we can immediately</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// publish the connection.</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    c.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>connected</span>(s.<span style=color:#a6e22e>name</span>, b.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>binder</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (Exception e) {
</span></span><span style=display:flex><span>                    Slog.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;Failure sending service &#34;</span> <span style=color:#f92672>+</span> s.<span style=color:#a6e22e>shortInstanceName</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; to connection &#34;</span> <span style=color:#f92672>+</span> c.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>asBinder</span>()
</span></span><span style=display:flex><span>                            <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; (in &#34;</span> <span style=color:#f92672>+</span> c.<span style=color:#a6e22e>binding</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>processName</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;)&#34;</span>, e);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>b.<span style=color:#a6e22e>intent</span>.<span style=color:#a6e22e>requested</span>) {
</span></span><span style=display:flex><span>                requestServiceBindingLocked(s, b.<span style=color:#a6e22e>intent</span>, callerFg, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 1;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=activeservicesrealstartservicelocked>ActiveServices.realStartServiceLocked<a hidden class=anchor aria-hidden=true href=#activeservicesrealstartservicelocked>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Note the name of this method should not be confused with the started services concept.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * The &#34;start&#34; here means bring up the instance in the client, and this method is called
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * from bindService() as well.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>realStartServiceLocked</span>(ServiceRecord r,
</span></span><span style=display:flex><span>            ProcessRecord app, <span style=color:#66d9ef>boolean</span> execInFg) <span style=color:#66d9ef>throws</span> RemoteException {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (app.<span style=color:#a6e22e>thread</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemoteException();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        r.<span style=color:#a6e22e>setProcess</span>(app);
</span></span><span style=display:flex><span>        r.<span style=color:#a6e22e>restartTime</span> <span style=color:#f92672>=</span> r.<span style=color:#a6e22e>lastActivity</span> <span style=color:#f92672>=</span> SystemClock.<span style=color:#a6e22e>uptimeMillis</span>();
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建服务</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> newService <span style=color:#f92672>=</span> app.<span style=color:#a6e22e>startService</span>(r);
</span></span><span style=display:flex><span>        bumpServiceExecutingLocked(r, execInFg, <span style=color:#e6db74>&#34;create&#34;</span>);
</span></span><span style=display:flex><span>        mAm.<span style=color:#a6e22e>updateLruProcessLocked</span>(app, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        updateServiceForegroundLocked(r.<span style=color:#a6e22e>app</span>, <span style=color:#75715e>/* oomAdj= */</span> <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        mAm.<span style=color:#a6e22e>updateOomAdjLocked</span>(app, OomAdjuster.<span style=color:#a6e22e>OOM_ADJ_REASON_START_SERVICE</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> created <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>forceProcessStateUpTo</span>(ActivityManager.<span style=color:#a6e22e>PROCESS_STATE_SERVICE</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 创建服务</span>
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>thread</span>.<span style=color:#a6e22e>scheduleCreateService</span>(r, r.<span style=color:#a6e22e>serviceInfo</span>,
</span></span><span style=display:flex><span>                    mAm.<span style=color:#a6e22e>compatibilityInfoForPackage</span>(r.<span style=color:#a6e22e>serviceInfo</span>.<span style=color:#a6e22e>applicationInfo</span>),
</span></span><span style=display:flex><span>                    app.<span style=color:#a6e22e>getReportedProcState</span>());
</span></span><span style=display:flex><span>            r.<span style=color:#a6e22e>postNotification</span>();
</span></span><span style=display:flex><span>            created <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (DeadObjectException e) {
</span></span><span style=display:flex><span>            Slog.<span style=color:#a6e22e>w</span>(TAG, <span style=color:#e6db74>&#34;Application dead when creating service &#34;</span> <span style=color:#f92672>+</span> r);
</span></span><span style=display:flex><span>            mAm.<span style=color:#a6e22e>appDiedLocked</span>(app, <span style=color:#e6db74>&#34;Died when creating service&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> e;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// </span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 绑定服务</span>
</span></span><span style=display:flex><span>        requestServiceBindingsLocked(r, execInFg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        updateServiceClientActivitiesLocked(app, <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (newService <span style=color:#f92672>&amp;&amp;</span> created) {
</span></span><span style=display:flex><span>            app.<span style=color:#a6e22e>addBoundClientUidsOfNewService</span>(r);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the service is in the started state, and there are no</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// pending arguments, then fake up one so its onStartCommand() will</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// be called.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (r.<span style=color:#a6e22e>startRequested</span> <span style=color:#f92672>&amp;&amp;</span> r.<span style=color:#a6e22e>callStart</span> <span style=color:#f92672>&amp;&amp;</span> r.<span style=color:#a6e22e>pendingStarts</span>.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>            r.<span style=color:#a6e22e>pendingStarts</span>.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> ServiceRecord.<span style=color:#a6e22e>StartItem</span>(r, <span style=color:#66d9ef>false</span>, r.<span style=color:#a6e22e>makeNextStartId</span>(),
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, 0));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        sendServiceArgsLocked(r, execInFg, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://hanlyjiang.github.io/tags/android/>Android</a></li><li><a href=https://hanlyjiang.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/>源码分析</a></li></ul><nav class=paginav><a class=prev href=https://hanlyjiang.github.io/posts/idea-shi-yong-ji-qiao-zhi-dao-hang/><span class=title>« 上一页</span><br><span>IDEA使用技巧之导航</span>
</a><a class=next href=https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/><span class=title>下一页 »</span><br><span>搭建Android源码工作环境</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hanlyjiang.github.io/>清水池塘</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>