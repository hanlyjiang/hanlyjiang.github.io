<!doctype html><html lang=zh-cn dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用Kotlin编写gradle脚本 | 清水池塘</title><meta name=keywords content="Gradle"><meta name=description content="将gradle 脚本从 groovy 迁移到 kotlin dsl。

概述
IDE 支持

  
      
          
          Build import
          Syntax highlighting 1
          Semantic editor 2
      
  
  
      
          IntelliJ IDEA
          ✓
          ✓
          ✓
      
      
          Android Studio
          ✓
          ✓
          ✓
      
      
          Eclipse IDE
          ✓
          ✓
          ✖
      
      
          CLion
          ✓
          ✓
          ✖
      
      
          Apache NetBeans
          ✓
          ✓
          ✖
      
      
          Visual Studio Code (LSP)
          ✓
          ✓
          ✖
      
      
          Visual Studio
          ✓
          ✖
          ✖
      
  


Gradle Kotlin DSL scripts 中的Kotlin语法高亮
Gradle Kotlin DSL scripts 中支持代码补全，导航到源码，文档查看，重构等等；

Kotlin DSL 脚本命名
命名
Groovy DSL script 文件使用 .gradle 扩展文件名"><meta name=author content="野生莲藕"><link rel=canonical href=https://hanlyjiang.github.io/posts/shi-yong-kotlin-bian-xie-gradle-jiao-ben/><link crossorigin=anonymous href=/assets/css/stylesheet.1dac4471c235f77048759b61f5192f2fba4fce1a14cedacd96fa820edde1c41e.css integrity="sha256-HaxEccI193BIdZth9RkvL7pPzhoUztrNlvqCDt3hxB4=" rel="preload stylesheet" as=style><link rel=icon href=https://hanlyjiang.github.io/img/site-icon.png><link rel=icon type=image/png sizes=16x16 href=https://hanlyjiang.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanlyjiang.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://hanlyjiang.github.io/apple-touch-icon.png><link rel=mask-icon href=https://hanlyjiang.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-cn href=https://hanlyjiang.github.io/posts/shi-yong-kotlin-bian-xie-gradle-jiao-ben/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://hanlyjiang.github.io/posts/shi-yong-kotlin-bian-xie-gradle-jiao-ben/"><meta property="og:site_name" content="清水池塘"><meta property="og:title" content="使用Kotlin编写gradle脚本"><meta property="og:description" content="将gradle 脚本从 groovy 迁移到 kotlin dsl。
概述 IDE 支持 Build import Syntax highlighting 1 Semantic editor 2 IntelliJ IDEA ✓ ✓ ✓ Android Studio ✓ ✓ ✓ Eclipse IDE ✓ ✓ ✖ CLion ✓ ✓ ✖ Apache NetBeans ✓ ✓ ✖ Visual Studio Code (LSP) ✓ ✓ ✖ Visual Studio ✓ ✖ ✖ Gradle Kotlin DSL scripts 中的Kotlin语法高亮 Gradle Kotlin DSL scripts 中支持代码补全，导航到源码，文档查看，重构等等； Kotlin DSL 脚本命名 命名 Groovy DSL script 文件使用 .gradle 扩展文件名"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-24T22:29:04+00:00"><meta property="article:modified_time" content="2022-02-24T22:29:04+00:00"><meta property="article:tag" content="Gradle"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用Kotlin编写gradle脚本"><meta name=twitter:description content="将gradle 脚本从 groovy 迁移到 kotlin dsl。

概述
IDE 支持

  
      
          
          Build import
          Syntax highlighting 1
          Semantic editor 2
      
  
  
      
          IntelliJ IDEA
          ✓
          ✓
          ✓
      
      
          Android Studio
          ✓
          ✓
          ✓
      
      
          Eclipse IDE
          ✓
          ✓
          ✖
      
      
          CLion
          ✓
          ✓
          ✖
      
      
          Apache NetBeans
          ✓
          ✓
          ✖
      
      
          Visual Studio Code (LSP)
          ✓
          ✓
          ✖
      
      
          Visual Studio
          ✓
          ✖
          ✖
      
  


Gradle Kotlin DSL scripts 中的Kotlin语法高亮
Gradle Kotlin DSL scripts 中支持代码补全，导航到源码，文档查看，重构等等；

Kotlin DSL 脚本命名
命名
Groovy DSL script 文件使用 .gradle 扩展文件名"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hanlyjiang.github.io/posts/"},{"@type":"ListItem","position":2,"name":"使用Kotlin编写gradle脚本","item":"https://hanlyjiang.github.io/posts/shi-yong-kotlin-bian-xie-gradle-jiao-ben/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用Kotlin编写gradle脚本","name":"使用Kotlin编写gradle脚本","description":"将gradle 脚本从 groovy 迁移到 kotlin dsl。\n概述 IDE 支持 Build import Syntax highlighting 1 Semantic editor 2 IntelliJ IDEA ✓ ✓ ✓ Android Studio ✓ ✓ ✓ Eclipse IDE ✓ ✓ ✖ CLion ✓ ✓ ✖ Apache NetBeans ✓ ✓ ✖ Visual Studio Code (LSP) ✓ ✓ ✖ Visual Studio ✓ ✖ ✖ Gradle Kotlin DSL scripts 中的Kotlin语法高亮 Gradle Kotlin DSL scripts 中支持代码补全，导航到源码，文档查看，重构等等； Kotlin DSL 脚本命名 命名 Groovy DSL script 文件使用 .gradle 扩展文件名\n","keywords":["Gradle"],"articleBody":"将gradle 脚本从 groovy 迁移到 kotlin dsl。\n概述 IDE 支持 Build import Syntax highlighting 1 Semantic editor 2 IntelliJ IDEA ✓ ✓ ✓ Android Studio ✓ ✓ ✓ Eclipse IDE ✓ ✓ ✖ CLion ✓ ✓ ✖ Apache NetBeans ✓ ✓ ✖ Visual Studio Code (LSP) ✓ ✓ ✖ Visual Studio ✓ ✖ ✖ Gradle Kotlin DSL scripts 中的Kotlin语法高亮 Gradle Kotlin DSL scripts 中支持代码补全，导航到源码，文档查看，重构等等； Kotlin DSL 脚本命名 命名 Groovy DSL script 文件使用 .gradle 扩展文件名\nKotlin DSL script 文件使用 .gradle.kts 扩展文件名\n激活并使用 kotlin dsl 将脚本文件命名为 .gradle.kts 即可激活。也适用于 settings file（ settings.gradle.kts)和 initialization scripts. 为了得到更好的IDE支持，建议使用如下命名约定： Settings脚本命名为 *.settings.gradle.kts（包括所有从settings脚本中引入的脚本） initialization scripts 按 *.init.gradle.kts的命名模式命名，或者简单的取名为 init.gradle.kts。 kotlin DSL 构建脚本隐式的导入了如下内容： default Gradle API imports 在org.gradle.kotlin.dsl 和 org.gradle.kotlin.dsl.plugins.dsl 包中的Kotlin DSL API kotlin中读取运行时属性 Gradle Kotlin DSL Primer\ngradle 拥有两种运行时属性:\nproject properties extra properties 项目属性 可以通过kotlin的代理属性来访问:\nbuild.gradle.kts\n// 属性必须存在 val myProperty: String by project // 属性可以不存在 val myNullableProperty: String? by project extra 属性 extra属性在任意实现了ExtensionAware 接口的对象上都可以访问;\nbuild.gradle.kts\nval myNewProperty by extra(\"initial value\") // ❶ val myOtherNewProperty by extra { \"calculated initial value\" } //❷ val myProperty: String by extra // ❸ val myNullableProperty: String? by extra // ❹ ❶ 在当前上下文(当前为project中)创建一个名为myNewProperty新的extra属性,并且初始化其值为 “initial value”\n❷ 同 ❶ ，不过属性的初始值是通过lamdba表达式来计算的;\n❸ 绑定当前上下文(当前为project)中的属性到myProperty属性中;\n❹ 同 ❸ ，不过允许值为null；\n在子项目中访问rootProject的属性 val myNewProperty: String by rootProject.extra by是kotlin的关键字，表示 provided by ，即属性由某个其他的对象代理\n在任务中定义和使用属性 任务也继承了ExtensionAware，所以我们也可以在任务中使用extra属性\ntasks { test { val reportType by extra(\"dev\") doLast { // Use 'suffix' for post processing of reports } } register(\"archiveTestReports\") { val reportType: String by test.get().extra archiveAppendix.set(reportType) from(test.get().reports.html.destination) } } 通过map格式定义和访问extra属性 extra[\"myNewProperty\"] = \"initial value\" // ❶ tasks.create(\"myTask\") { doLast { println(\"Property: ${project.extra[\"myNewProperty\"]}\") // ❷ } } 迁移gradle构建逻辑到Kotlin 参考文档：\nMigrating build logic from Groovy to Kotlin (gradle.org) Android Gradle脚本从Groovy迁移到Kotlin DSL - 圣骑士wind - 博客园 (cnblogs.com) 准备groovy脚本 引号统一为双引号 方法调用加上括号 赋值操作加上等号 引号统一 通过==⌘⇧R==快捷键调出查找替换工具窗，将文件匹配设置为 .gradle ，然后将所有单引号替换为双引号。\n完成之后重新使用gradle文件同步项目，查看是否有错误\n赋值和属性修改 将所有的赋值操作添加上等号 所有的函数调用操作添加括号 这里就需要根据实际情况进行调整了。\n重命名文件 将 .gradle文件重命名为.gradle.kts，通过如下命令可以完成重命名操作\nfind . -name \"*.gradle\" -type f | xargs -I {} mv {} {}.kts 其他常见修改 在kotlin rootProject脚本中访问 gradle 属性 allprojects { repositories { maven { name = \"Sonatype-Snapshots\" setUrl(\"https://oss.sonatype.org/content/repositories/snapshots\") credentials(PasswordCredentials::class.java) { username = property(\"ossrhUsername\").toString() password = property(\"ossrhPassword\").toString() } } google() jcenter() mavenCentral() } } 定义任务 tasks.register(\"clean\", Delete::class.java) { group = \"build\" delete(rootProject.buildDir) } 迁移配置实例 rootProject kotlin dsl build脚本模板 // Top-level build file where you can add configuration options common to all sub-projects/modules. buildscript { // 定义extra 属性 val kotlin_version by extra(\"1.4.32\") val android_gradle_build_version by extra(\"4.1.3\") repositories { maven { setUrl(\"https://maven.aliyun.com/repository/gradle-plugin\") } maven { setUrl(\"https://maven.aliyun.com/repository/jcenter\") } maven { setUrl(\"https://maven.aliyun.com/repository/google\") } maven { setUrl(\"https://maven.aliyun.com/repository/public\") } google() jcenter() mavenCentral() } dependencies { classpath(\"com.android.tools.build:gradle:$android_gradle_build_version\") classpath(\"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version\") // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } allprojects { repositories { maven { setUrl(\"https://maven.aliyun.com/repository/jcenter\") } maven { setUrl(\"https://maven.aliyun.com/repository/google\") } maven { setUrl(\"https://maven.aliyun.com/repository/gradle-plugin\") } maven { setUrl(\"https://maven.aliyun.com/repository/public\") } // 加入项目临时仓库，方便测试 maven { name = \"ProjectLocal-Snapshots\" setUrl(File(rootProject.rootDir, \"local-maven-repo${File.separator}snapshots\")) } maven { name = \"ProjectLocal-Release\" setUrl(File(rootProject.rootDir, \"local-maven-repo${File.separator}release\")) } // 加入 maven snapshot 仓库及 release 仓库 maven { name = \"Sonatype-Snapshots\" setUrl(\"https://oss.sonatype.org/content/repositories/snapshots\") } maven { name = \"Sonatype-Staging\" setUrl(\"https://oss.sonatype.org/service/local/staging/deploy/maven2/\") credentials(PasswordCredentials::class.java) { username = property(\"ossrhUsername\").toString() password = property(\"ossrhPassword\").toString() } } google() mavenCentral() jcenter() } } tasks.register(\"clean\", Delete::class.java) { group = \"build\" delete(rootProject.buildDir) } 模块 build.gradle 模块build脚本模板 plugins { id(\"com.android.library\") id(\"signing\") // 等同于 id(\"\") `maven-publish` kotlin(\"android\") kotlin(\"android.extensions\") // 引入三方Gradle插件 id(\"com.github.hanlyjiang.android_maven_pub\") version (\"0.0.9\") apply (false) } android { compileSdkVersion(30) buildToolsVersion(\"30.0.3\") defaultConfig { minSdkVersion(22) targetSdkVersion(30) versionCode(1) versionName(\"1.0.0\") testInstrumentationRunner(\"androidx.test.runner.AndroidJUnitRunner\") consumerProguardFiles(\"consumer-rules.pro\") } buildTypes { getByName(\"release\") { minifyEnabled(false) proguardFiles( getDefaultProguardFile(\"proguard-android-optimize.txt\"), \"proguard-rules.pro\" ) } } compileOptions { sourceCompatibility(JavaVersion.VERSION_1_8) targetCompatibility(JavaVersion.VERSION_1_8) } } dependencies { implementation(\"org.jetbrains:annotations:21.0.1\") testImplementation(\"junit:junit:4.13.2\") androidTestImplementation(\"androidx.test.ext:junit:1.1.3\") androidTestImplementation(\"androidx.test.espresso:espresso-core:3.4.0\") // StringRes 注解 implementation(\"androidx.appcompat:appcompat:1.3.1\") // 注解库 https://developer.android.com/jetpack/androidx/releases/annotation#annotation-1.2.0 implementation(\"androidx.annotation:annotation:1.2.0\") } // 创建自定义任务 tasks.create(\"showGitRepoInfo\") { group = \"help\" doLast { println(\"${getGitBranch()}/${getGitRevision()}\") } } // 扩展函数 fun String.execute(): String { val process = Runtime.getRuntime().exec(this) return with(process.inputStream.bufferedReader()) { readText() } } /** * Get git revision with work tree status * * @return */ fun getGitRevision(): String { val rev = \"git rev-parse --short HEAD\".execute().trim() val stat = \"git diff --stat\".execute().trim() return if (stat.isEmpty()) { rev } else { \"$rev-dirty\" } } /** * Get git branch name * * @return */ fun getGitBranch(): String { return \"git rev-parse --abbrev-ref HEAD\".execute().trim() } 7.0.2 版本AGP插件配置实例-模块build脚本 plugins { id(\"com.android.application\") } android { compileSdk = 31 defaultConfig { applicationId = \"com.github.hanlyjiang.sample\" minSdk = 21 targetSdk = 31 versionCode = 1 versionName = \"1.0\" testInstrumentationRunner = \"androidx.test.runner.AndroidJUnitRunner\" } buildTypes { getByName(\"release\") { isMinifyEnabled = false proguardFiles( getDefaultProguardFile(\"proguard-android-optimize.txt\"), \"proguard-rules.pro\" ) } } compileOptions { sourceCompatibility(JavaVersion.VERSION_1_8) targetCompatibility(JavaVersion.VERSION_1_8) } } dependencies { implementation(files(\"../libs/lib-mod-release.aar\")) // https://mvnrepository.com/artifact/io.reactivex.rxjava3/rxjava implementation(\"io.reactivex.rxjava3:rxjava:3.1.3\") implementation(\"androidx.appcompat:appcompat:1.2.0\") implementation(\"com.google.android.material:material:1.3.0\") implementation(\"androidx.constraintlayout:constraintlayout:2.1.3\") testImplementation(\"junit:junit:4.+\") androidTestImplementation(\"androidx.test.ext:junit:1.1.2\") androidTestImplementation(\"androidx.test.espresso:espresso-core:3.3.0\") } 7.0.2 root Build gradle 脚本配置 dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS) repositories { google() mavenCentral() jcenter() // Warning: this repository is going to shut down soon flatDir { dir(\"libs\") } } } rootProject.name = \"NoSuchMethodError\" include ':app' include ':lib-mod' 限制/不足 在 kotlin dsl 脚本中引入其他独立的 kotlin 的dsl 脚本不方便，会存在无法识别相关依赖对象的问题，部分情况下还是得导入使用 groovy 编写的 gradle 脚本。\n","wordCount":"1802","inLanguage":"zh-cn","datePublished":"2022-02-24T22:29:04Z","dateModified":"2022-02-24T22:29:04Z","author":{"@type":"Person","name":"野生莲藕"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanlyjiang.github.io/posts/shi-yong-kotlin-bian-xie-gradle-jiao-ben/"},"publisher":{"@type":"Organization","name":"清水池塘","logo":{"@type":"ImageObject","url":"https://hanlyjiang.github.io/img/site-icon.png"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hanlyjiang.github.io/ accesskey=h title="清水池塘 (Alt + H)"><img src=https://hanlyjiang.github.io/img/site-img.png alt aria-label=logo height=35>清水池塘</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hanlyjiang.github.io/ title=首页><span><i class='fas fa-home'></i>首页</span></a></li><li><a href=https://hanlyjiang.github.io/archives/ title=归档><span><i class='fas fa-tags'></i>归档</span></a></li><li><a href=https://hanlyjiang.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://hanlyjiang.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hanlyjiang.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://hanlyjiang.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">使用Kotlin编写gradle脚本</h1><div class=post-meta><span title='2022-02-24 22:29:04 +0000 UTC'>2022年2月24日</span>&nbsp;·&nbsp;<span>4 min</span>&nbsp;·&nbsp;<span>野生莲藕</span></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%a6%82%e8%bf%b0 aria-label=概述>概述</a><ul><li><a href=#ide-%e6%94%af%e6%8c%81 aria-label="IDE 支持">IDE 支持</a></li><li><a href=#kotlin-dsl-%e8%84%9a%e6%9c%ac%e5%91%bd%e5%90%8d aria-label="Kotlin DSL 脚本命名">Kotlin DSL 脚本命名</a><ul><li><a href=#%e5%91%bd%e5%90%8d aria-label=命名>命名</a></li><li><a href=#%e6%bf%80%e6%b4%bb%e5%b9%b6%e4%bd%bf%e7%94%a8-kotlin-dsl aria-label="激活并使用 kotlin dsl">激活并使用 kotlin dsl</a></li></ul></li><li><a href=#kotlin%e4%b8%ad%e8%af%bb%e5%8f%96%e8%bf%90%e8%a1%8c%e6%97%b6%e5%b1%9e%e6%80%a7 aria-label=kotlin中读取运行时属性>kotlin中读取运行时属性</a><ul><li><a href=#%e9%a1%b9%e7%9b%ae%e5%b1%9e%e6%80%a7 aria-label=项目属性>项目属性</a></li><li><a href=#extra-%e5%b1%9e%e6%80%a7 aria-label="extra 属性">extra 属性</a></li><li><a href=#%e5%9c%a8%e5%ad%90%e9%a1%b9%e7%9b%ae%e4%b8%ad%e8%ae%bf%e9%97%aerootproject%e7%9a%84%e5%b1%9e%e6%80%a7 aria-label=在子项目中访问rootProject的属性>在子项目中访问rootProject的属性</a></li><li><a href=#%e5%9c%a8%e4%bb%bb%e5%8a%a1%e4%b8%ad%e5%ae%9a%e4%b9%89%e5%92%8c%e4%bd%bf%e7%94%a8%e5%b1%9e%e6%80%a7 aria-label=在任务中定义和使用属性>在任务中定义和使用属性</a></li><li><a href=#%e9%80%9a%e8%bf%87map%e6%a0%bc%e5%bc%8f%e5%ae%9a%e4%b9%89%e5%92%8c%e8%ae%bf%e9%97%aeextra%e5%b1%9e%e6%80%a7 aria-label=通过map格式定义和访问extra属性>通过map格式定义和访问extra属性</a></li></ul></li></ul></li><li><a href=#%e8%bf%81%e7%a7%bbgradle%e6%9e%84%e5%bb%ba%e9%80%bb%e8%be%91%e5%88%b0kotlin aria-label=迁移gradle构建逻辑到Kotlin>迁移gradle构建逻辑到Kotlin</a><ul><li><a href=#%e5%87%86%e5%a4%87groovy%e8%84%9a%e6%9c%ac aria-label=准备groovy脚本>准备groovy脚本</a><ul><li><a href=#%e5%bc%95%e5%8f%b7%e7%bb%9f%e4%b8%80 aria-label=引号统一>引号统一</a></li><li><a href=#%e8%b5%8b%e5%80%bc%e5%92%8c%e5%b1%9e%e6%80%a7%e4%bf%ae%e6%94%b9 aria-label=赋值和属性修改>赋值和属性修改</a></li></ul></li><li><a href=#%e9%87%8d%e5%91%bd%e5%90%8d%e6%96%87%e4%bb%b6 aria-label=重命名文件>重命名文件</a></li><li><a href=#%e5%85%b6%e4%bb%96%e5%b8%b8%e8%a7%81%e4%bf%ae%e6%94%b9 aria-label=其他常见修改>其他常见修改</a><ul><li><a href=#%e5%9c%a8kotlin-rootproject%e8%84%9a%e6%9c%ac%e4%b8%ad%e8%ae%bf%e9%97%ae-gradle-%e5%b1%9e%e6%80%a7 aria-label="在kotlin rootProject脚本中访问 gradle 属性">在kotlin rootProject脚本中访问 gradle 属性</a></li><li><a href=#%e5%ae%9a%e4%b9%89%e4%bb%bb%e5%8a%a1 aria-label=定义任务>定义任务</a></li></ul></li></ul></li><li><a href=#%e8%bf%81%e7%a7%bb%e9%85%8d%e7%bd%ae%e5%ae%9e%e4%be%8b aria-label=迁移配置实例>迁移配置实例</a><ul><li><a href=#rootproject-kotlin-dsl-build%e8%84%9a%e6%9c%ac%e6%a8%a1%e6%9d%bf aria-label="rootProject kotlin dsl build脚本模板">rootProject kotlin dsl build脚本模板</a></li><li><a href=#%e6%a8%a1%e5%9d%97-buildgradle-%e6%a8%a1%e5%9d%97build%e8%84%9a%e6%9c%ac%e6%a8%a1%e6%9d%bf aria-label="模块 build.gradle 模块build脚本模板">模块 build.gradle 模块build脚本模板</a></li><li><a href=#702-%e7%89%88%e6%9c%acagp%e6%8f%92%e4%bb%b6%e9%85%8d%e7%bd%ae%e5%ae%9e%e4%be%8b-%e6%a8%a1%e5%9d%97build%e8%84%9a%e6%9c%ac aria-label="7.0.2 版本AGP插件配置实例-模块build脚本">7.0.2 版本AGP插件配置实例-模块build脚本</a></li><li><a href=#702-root-build-gradle-%e8%84%9a%e6%9c%ac%e9%85%8d%e7%bd%ae aria-label="7.0.2 root Build gradle 脚本配置">7.0.2 root Build gradle 脚本配置</a></li></ul></li><li><a href=#%e9%99%90%e5%88%b6%e4%b8%8d%e8%b6%b3 aria-label=限制/不足>限制/不足</a></li></ul></div></details></div><div class=post-content><p>将gradle 脚本从 groovy 迁移到 kotlin dsl。</p><h2 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h2><h3 id=ide-支持>IDE 支持<a hidden class=anchor aria-hidden=true href=#ide-支持>#</a></h3><table><thead><tr><th style=text-align:right></th><th style=text-align:center>Build import</th><th style=text-align:center>Syntax highlighting <sub>1</sub></th><th style=text-align:center>Semantic editor <sub>2</sub></th></tr></thead><tbody><tr><td style=text-align:right>IntelliJ IDEA</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td></tr><tr><td style=text-align:right>Android Studio</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td></tr><tr><td style=text-align:right>Eclipse IDE</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center>✖</td></tr><tr><td style=text-align:right>CLion</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center>✖</td></tr><tr><td style=text-align:right>Apache NetBeans</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center>✖</td></tr><tr><td style=text-align:right>Visual Studio Code (LSP)</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center>✖</td></tr><tr><td style=text-align:right>Visual Studio</td><td style=text-align:center><strong>✓</strong></td><td style=text-align:center>✖</td><td style=text-align:center>✖</td></tr></tbody></table><ol><li>Gradle Kotlin DSL scripts 中的Kotlin语法高亮</li><li>Gradle Kotlin DSL scripts 中支持代码补全，导航到源码，文档查看，重构等等；</li></ol><h3 id=kotlin-dsl-脚本命名>Kotlin DSL 脚本命名<a hidden class=anchor aria-hidden=true href=#kotlin-dsl-脚本命名>#</a></h3><h4 id=命名>命名<a hidden class=anchor aria-hidden=true href=#命名>#</a></h4><p>Groovy DSL script 文件使用 <code>.gradle</code> 扩展文件名</p><p>Kotlin DSL script 文件使用 <code>.gradle.kts</code> 扩展文件名</p><h4 id=激活并使用-kotlin-dsl>激活并使用 kotlin dsl<a hidden class=anchor aria-hidden=true href=#激活并使用-kotlin-dsl>#</a></h4><ul><li>将脚本文件命名为 <code>.gradle.kts</code> 即可激活。也适用于 <a href=https://docs.gradle.org/current/userguide/build_lifecycle.html#sec:settings_file>settings file</a>（ <code>settings.gradle.kts</code>)和 <a href=https://docs.gradle.org/current/userguide/init_scripts.html#init_scripts>initialization scripts</a>.</li><li>为了得到更好的IDE支持，建议使用如下命名约定：<ul><li>Settings脚本命名为 <code>*.settings.gradle.kts</code>（包括所有从settings脚本中引入的脚本）</li><li><a href=https://docs.gradle.org/current/userguide/init_scripts.html#init_scripts>initialization scripts</a> 按 <code>*.init.gradle.kts</code>的命名模式命名，或者简单的取名为 <code>init.gradle.kts</code>。</li></ul></li><li>kotlin DSL 构建脚本隐式的导入了如下内容：<ul><li><a href=https://docs.gradle.org/current/userguide/writing_build_scripts.html#script-default-imports>default Gradle API imports</a></li><li>在<code>org.gradle.kotlin.dsl</code> 和 <code>org.gradle.kotlin.dsl.plugins.dsl</code> 包中的Kotlin DSL API</li></ul></li></ul><h3 id=kotlin中读取运行时属性>kotlin中读取运行时属性<a hidden class=anchor aria-hidden=true href=#kotlin中读取运行时属性>#</a></h3><blockquote><p><a href=https://docs.gradle.org/current/userguide/kotlin_dsl.html#kotdsl:properties>Gradle Kotlin DSL Primer</a></p></blockquote><p>gradle 拥有两种运行时属性:</p><ol><li><a href=https://docs.gradle.org/current/userguide/build_environment.html#sec:project_properties><em>project properties</em></a></li><li><a href=https://docs.gradle.org/current/userguide/writing_build_scripts.html#sec:extra_properties><em>extra properties</em></a></li></ol><h4 id=项目属性>项目属性<a hidden class=anchor aria-hidden=true href=#项目属性>#</a></h4><p>可以通过kotlin的代理属性来访问:</p><p><strong>build.gradle.kts</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// 属性必须存在
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> myProperty: String <span style=color:#66d9ef>by</span> project  
</span></span><span style=display:flex><span><span style=color:#75715e>// 属性可以不存在
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> myNullableProperty: String? <span style=color:#66d9ef>by</span> project 
</span></span></code></pre></div><h4 id=extra-属性>extra 属性<a hidden class=anchor aria-hidden=true href=#extra-属性>#</a></h4><p>extra属性在任意实现了<a href=https://docs.gradle.org/current/dsl/org.gradle.api.plugins.ExtensionAware.html#org.gradle.api.plugins.ExtensionAware>ExtensionAware</a> 接口的对象上都可以访问;</p><p><strong>build.gradle.kts</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> myNewProperty <span style=color:#66d9ef>by</span> extra(<span style=color:#e6db74>&#34;initial value&#34;</span>)   <span style=color:#75715e>// ❶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> myOtherNewProperty <span style=color:#66d9ef>by</span> extra { <span style=color:#e6db74>&#34;calculated initial value&#34;</span> }   <span style=color:#75715e>//❷ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> myProperty: String <span style=color:#66d9ef>by</span> extra   <span style=color:#75715e>// ❸
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>val</span> myNullableProperty: String? <span style=color:#66d9ef>by</span> extra   <span style=color:#75715e>// ❹
</span></span></span></code></pre></div><p>❶ 在当前上下文(当前为project中)创建一个名为<code>myNewProperty</code>新的extra属性,并且初始化其值为 &ldquo;initial value&rdquo;</p><p>❷ 同 ❶ ，不过属性的初始值是通过lamdba表达式来计算的;</p><p>❸ 绑定当前上下文(当前为project)中的属性到myProperty属性中;</p><p>❹ 同 ❸ ，不过允许值为null；</p><h4 id=在子项目中访问rootproject的属性>在子项目中访问rootProject的属性<a hidden class=anchor aria-hidden=true href=#在子项目中访问rootproject的属性>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>val</span> myNewProperty: String <span style=color:#66d9ef>by</span> rootProject.extra
</span></span></code></pre></div><blockquote><p><code>by</code>是kotlin的关键字，表示 provided by ，即属性由某个其他的对象代理</p></blockquote><h4 id=在任务中定义和使用属性>在任务中定义和使用属性<a hidden class=anchor aria-hidden=true href=#在任务中定义和使用属性>#</a></h4><p>任务也继承了ExtensionAware，所以我们也可以在任务中使用extra属性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>tasks {
</span></span><span style=display:flex><span>    test {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> reportType <span style=color:#66d9ef>by</span> extra(<span style=color:#e6db74>&#34;dev&#34;</span>)  
</span></span><span style=display:flex><span>        doLast {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Use &#39;suffix&#39; for post processing of reports
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    register&lt;Zip&gt;(<span style=color:#e6db74>&#34;archiveTestReports&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> reportType: String <span style=color:#66d9ef>by</span> test.<span style=color:#66d9ef>get</span>().extra  
</span></span><span style=display:flex><span>        archiveAppendix.<span style=color:#66d9ef>set</span>(reportType)
</span></span><span style=display:flex><span>        from(test.<span style=color:#66d9ef>get</span>().reports.html.destination)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=通过map格式定义和访问extra属性>通过map格式定义和访问extra属性<a hidden class=anchor aria-hidden=true href=#通过map格式定义和访问extra属性>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>extra[<span style=color:#e6db74>&#34;myNewProperty&#34;</span>] = <span style=color:#e6db74>&#34;initial value&#34;</span>   <span style=color:#75715e>// ❶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>tasks.create(<span style=color:#e6db74>&#34;myTask&#34;</span>) {
</span></span><span style=display:flex><span>    doLast {
</span></span><span style=display:flex><span>        println(<span style=color:#e6db74>&#34;Property: </span><span style=color:#e6db74>${project.extra[&#34;myNewProperty&#34;]}</span><span style=color:#e6db74>&#34;</span>)  <span style=color:#75715e>// ❷ 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=迁移gradle构建逻辑到kotlin>迁移gradle构建逻辑到Kotlin<a hidden class=anchor aria-hidden=true href=#迁移gradle构建逻辑到kotlin>#</a></h2><blockquote><p>参考文档：</p><ol><li><a href=https://docs.gradle.org/current/userguide/migrating_from_groovy_to_kotlin_dsl.html>Migrating build logic from Groovy to Kotlin (gradle.org)</a></li><li><a href=https://www.cnblogs.com/mengdd/p/android-gradle-migrate-from-groovy-to-kotlin.html>Android Gradle脚本从Groovy迁移到Kotlin DSL - 圣骑士wind - 博客园 (cnblogs.com)</a></li></ol></blockquote><h3 id=准备groovy脚本>准备groovy脚本<a hidden class=anchor aria-hidden=true href=#准备groovy脚本>#</a></h3><ol><li>引号统一为双引号</li><li>方法调用加上括号</li><li>赋值操作加上等号</li></ol><h4 id=引号统一>引号统一<a hidden class=anchor aria-hidden=true href=#引号统一>#</a></h4><ul><li><p>通过==⌘⇧R==快捷键调出查找替换工具窗，将文件匹配设置为 <code>.gradle</code> ，然后将所有单引号替换为双引号。</p></li><li><p>完成之后重新使用gradle文件同步项目，查看是否有错误</p></li></ul><h4 id=赋值和属性修改>赋值和属性修改<a hidden class=anchor aria-hidden=true href=#赋值和属性修改>#</a></h4><ul><li>将所有的赋值操作添加上等号</li><li>所有的函数调用操作添加括号</li></ul><p>这里就需要根据实际情况进行调整了。</p><h3 id=重命名文件>重命名文件<a hidden class=anchor aria-hidden=true href=#重命名文件>#</a></h3><p>将 <code>.gradle</code>文件重命名为<code>.gradle.kts</code>，通过如下命令可以完成重命名操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>find . -name <span style=color:#e6db74>&#34;*.gradle&#34;</span> -type f | xargs -I <span style=color:#f92672>{}</span> mv <span style=color:#f92672>{}</span> <span style=color:#f92672>{}</span>.kts
</span></span></code></pre></div><h3 id=其他常见修改>其他常见修改<a hidden class=anchor aria-hidden=true href=#其他常见修改>#</a></h3><h4 id=在kotlin-rootproject脚本中访问-gradle-属性>在kotlin rootProject脚本中访问 gradle 属性<a hidden class=anchor aria-hidden=true href=#在kotlin-rootproject脚本中访问-gradle-属性>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>allprojects {
</span></span><span style=display:flex><span>    repositories {
</span></span><span style=display:flex><span>        maven {
</span></span><span style=display:flex><span>            name = <span style=color:#e6db74>&#34;Sonatype-Snapshots&#34;</span>
</span></span><span style=display:flex><span>            setUrl(<span style=color:#e6db74>&#34;https://oss.sonatype.org/content/repositories/snapshots&#34;</span>)
</span></span><span style=display:flex><span>            credentials(PasswordCredentials<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java) {
</span></span><span style=display:flex><span>                username = <span style=color:#66d9ef>property</span>(<span style=color:#e6db74>&#34;ossrhUsername&#34;</span>).toString()
</span></span><span style=display:flex><span>                password = <span style=color:#66d9ef>property</span>(<span style=color:#e6db74>&#34;ossrhPassword&#34;</span>).toString()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        google()
</span></span><span style=display:flex><span>        jcenter()
</span></span><span style=display:flex><span>        mavenCentral()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=定义任务>定义任务<a hidden class=anchor aria-hidden=true href=#定义任务>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>tasks.register(<span style=color:#e6db74>&#34;clean&#34;</span>, Delete<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java) {
</span></span><span style=display:flex><span>    group = <span style=color:#e6db74>&#34;build&#34;</span>
</span></span><span style=display:flex><span>    delete(rootProject.buildDir)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=迁移配置实例>迁移配置实例<a hidden class=anchor aria-hidden=true href=#迁移配置实例>#</a></h2><h3 id=rootproject-kotlin-dsl-build脚本模板>rootProject kotlin dsl build脚本模板<a hidden class=anchor aria-hidden=true href=#rootproject-kotlin-dsl-build脚本模板>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#75715e>// Top-level build file where you can add configuration options common to all sub-projects/modules.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>buildscript {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 定义extra 属性
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>val</span> kotlin_version <span style=color:#66d9ef>by</span> extra(<span style=color:#e6db74>&#34;1.4.32&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> android_gradle_build_version <span style=color:#66d9ef>by</span> extra(<span style=color:#e6db74>&#34;4.1.3&#34;</span>)
</span></span><span style=display:flex><span>    repositories {
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/gradle-plugin&#34;</span>) }
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/jcenter&#34;</span>) }
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/google&#34;</span>) }
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/public&#34;</span>) }
</span></span><span style=display:flex><span>        google()
</span></span><span style=display:flex><span>        jcenter()
</span></span><span style=display:flex><span>        mavenCentral()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    dependencies {
</span></span><span style=display:flex><span>        classpath(<span style=color:#e6db74>&#34;com.android.tools.build:gradle:</span><span style=color:#e6db74>$android</span><span style=color:#e6db74>_gradle_build_version&#34;</span>)
</span></span><span style=display:flex><span>        classpath(<span style=color:#e6db74>&#34;org.jetbrains.kotlin:kotlin-gradle-plugin:</span><span style=color:#e6db74>$kotlin</span><span style=color:#e6db74>_version&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// NOTE: Do not place your application dependencies here; they belong
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// in the individual module build.gradle files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>allprojects {
</span></span><span style=display:flex><span>    repositories {
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/jcenter&#34;</span>) }
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/google&#34;</span>) }
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/gradle-plugin&#34;</span>) }
</span></span><span style=display:flex><span>        maven { setUrl(<span style=color:#e6db74>&#34;https://maven.aliyun.com/repository/public&#34;</span>) }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 加入项目临时仓库，方便测试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        maven {
</span></span><span style=display:flex><span>            name = <span style=color:#e6db74>&#34;ProjectLocal-Snapshots&#34;</span>
</span></span><span style=display:flex><span>            setUrl(File(rootProject.rootDir, <span style=color:#e6db74>&#34;local-maven-repo</span><span style=color:#e6db74>${File.separator}</span><span style=color:#e6db74>snapshots&#34;</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        maven {
</span></span><span style=display:flex><span>            name = <span style=color:#e6db74>&#34;ProjectLocal-Release&#34;</span>
</span></span><span style=display:flex><span>            setUrl(File(rootProject.rootDir, <span style=color:#e6db74>&#34;local-maven-repo</span><span style=color:#e6db74>${File.separator}</span><span style=color:#e6db74>release&#34;</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 加入 maven snapshot 仓库及 release 仓库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        maven {
</span></span><span style=display:flex><span>            name = <span style=color:#e6db74>&#34;Sonatype-Snapshots&#34;</span>
</span></span><span style=display:flex><span>            setUrl(<span style=color:#e6db74>&#34;https://oss.sonatype.org/content/repositories/snapshots&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        maven {
</span></span><span style=display:flex><span>            name = <span style=color:#e6db74>&#34;Sonatype-Staging&#34;</span>
</span></span><span style=display:flex><span>            setUrl(<span style=color:#e6db74>&#34;https://oss.sonatype.org/service/local/staging/deploy/maven2/&#34;</span>)
</span></span><span style=display:flex><span>            credentials(PasswordCredentials<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java) {
</span></span><span style=display:flex><span>                username = <span style=color:#66d9ef>property</span>(<span style=color:#e6db74>&#34;ossrhUsername&#34;</span>).toString()
</span></span><span style=display:flex><span>                password = <span style=color:#66d9ef>property</span>(<span style=color:#e6db74>&#34;ossrhPassword&#34;</span>).toString()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        google()
</span></span><span style=display:flex><span>        mavenCentral()
</span></span><span style=display:flex><span>        jcenter()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tasks.register(<span style=color:#e6db74>&#34;clean&#34;</span>, Delete<span style=color:#f92672>::</span><span style=color:#66d9ef>class</span>.java) {
</span></span><span style=display:flex><span>    group = <span style=color:#e6db74>&#34;build&#34;</span>
</span></span><span style=display:flex><span>    delete(rootProject.buildDir)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=模块-buildgradle-模块build脚本模板>模块 build.gradle 模块build脚本模板<a hidden class=anchor aria-hidden=true href=#模块-buildgradle-模块build脚本模板>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>plugins {
</span></span><span style=display:flex><span>    id(<span style=color:#e6db74>&#34;com.android.library&#34;</span>)
</span></span><span style=display:flex><span>    id(<span style=color:#e6db74>&#34;signing&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 等同于 id(&#34;&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#960050;background-color:#1e0010>`</span>maven-publish<span style=color:#960050;background-color:#1e0010>`</span>
</span></span><span style=display:flex><span>    kotlin(<span style=color:#e6db74>&#34;android&#34;</span>)
</span></span><span style=display:flex><span>    kotlin(<span style=color:#e6db74>&#34;android.extensions&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 引入三方Gradle插件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    id(<span style=color:#e6db74>&#34;com.github.hanlyjiang.android_maven_pub&#34;</span>) version (<span style=color:#e6db74>&#34;0.0.9&#34;</span>) apply (<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>android {
</span></span><span style=display:flex><span>    compileSdkVersion(<span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>    buildToolsVersion(<span style=color:#e6db74>&#34;30.0.3&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    defaultConfig {
</span></span><span style=display:flex><span>        minSdkVersion(<span style=color:#ae81ff>22</span>)
</span></span><span style=display:flex><span>        targetSdkVersion(<span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>        versionCode(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        versionName(<span style=color:#e6db74>&#34;1.0.0&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        testInstrumentationRunner(<span style=color:#e6db74>&#34;androidx.test.runner.AndroidJUnitRunner&#34;</span>)
</span></span><span style=display:flex><span>        consumerProguardFiles(<span style=color:#e6db74>&#34;consumer-rules.pro&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    buildTypes {
</span></span><span style=display:flex><span>        getByName(<span style=color:#e6db74>&#34;release&#34;</span>) {
</span></span><span style=display:flex><span>            minifyEnabled(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>            proguardFiles(
</span></span><span style=display:flex><span>                getDefaultProguardFile(<span style=color:#e6db74>&#34;proguard-android-optimize.txt&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;proguard-rules.pro&#34;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    compileOptions {
</span></span><span style=display:flex><span>        sourceCompatibility(<span style=color:#a6e22e>JavaVersion</span>.VERSION_1_8)
</span></span><span style=display:flex><span>        targetCompatibility(<span style=color:#a6e22e>JavaVersion</span>.VERSION_1_8)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;org.jetbrains:annotations:21.0.1&#34;</span>)
</span></span><span style=display:flex><span>    testImplementation(<span style=color:#e6db74>&#34;junit:junit:4.13.2&#34;</span>)
</span></span><span style=display:flex><span>    androidTestImplementation(<span style=color:#e6db74>&#34;androidx.test.ext:junit:1.1.3&#34;</span>)
</span></span><span style=display:flex><span>    androidTestImplementation(<span style=color:#e6db74>&#34;androidx.test.espresso:espresso-core:3.4.0&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// StringRes 注解
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    implementation(<span style=color:#e6db74>&#34;androidx.appcompat:appcompat:1.3.1&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注解库 https://developer.android.com/jetpack/androidx/releases/annotation#annotation-1.2.0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    implementation(<span style=color:#e6db74>&#34;androidx.annotation:annotation:1.2.0&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建自定义任务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>tasks.create(<span style=color:#e6db74>&#34;showGitRepoInfo&#34;</span>) {
</span></span><span style=display:flex><span>    group = <span style=color:#e6db74>&#34;help&#34;</span>
</span></span><span style=display:flex><span>    doLast {
</span></span><span style=display:flex><span>        println(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${getGitBranch()}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${getGitRevision()}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 扩展函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>String</span>.execute(): String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> process = <span style=color:#a6e22e>Runtime</span>.getRuntime().exec(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> with(process.inputStream.bufferedReader()) {
</span></span><span style=display:flex><span>        readText()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get git revision with work tree status
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getGitRevision</span>(): String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> rev = <span style=color:#e6db74>&#34;git rev-parse --short HEAD&#34;</span>.execute().trim()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>val</span> stat = <span style=color:#e6db74>&#34;git diff --stat&#34;</span>.execute().trim()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>if</span> (stat.isEmpty()) {
</span></span><span style=display:flex><span>        rev
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>$rev</span><span style=color:#e6db74>-dirty&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get git branch name
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>getGitBranch</span>(): String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;git rev-parse --abbrev-ref HEAD&#34;</span>.execute().trim()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=702-版本agp插件配置实例-模块build脚本>7.0.2 版本AGP插件配置实例-模块build脚本<a hidden class=anchor aria-hidden=true href=#702-版本agp插件配置实例-模块build脚本>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>plugins {
</span></span><span style=display:flex><span>    id(<span style=color:#e6db74>&#34;com.android.application&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>android {
</span></span><span style=display:flex><span>    compileSdk = <span style=color:#ae81ff>31</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    defaultConfig {
</span></span><span style=display:flex><span>        applicationId = <span style=color:#e6db74>&#34;com.github.hanlyjiang.sample&#34;</span>
</span></span><span style=display:flex><span>        minSdk = <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>        targetSdk = <span style=color:#ae81ff>31</span>
</span></span><span style=display:flex><span>        versionCode = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        versionName = <span style=color:#e6db74>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        testInstrumentationRunner = <span style=color:#e6db74>&#34;androidx.test.runner.AndroidJUnitRunner&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    buildTypes {
</span></span><span style=display:flex><span>        getByName(<span style=color:#e6db74>&#34;release&#34;</span>) {
</span></span><span style=display:flex><span>            isMinifyEnabled = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>            proguardFiles(
</span></span><span style=display:flex><span>                getDefaultProguardFile(<span style=color:#e6db74>&#34;proguard-android-optimize.txt&#34;</span>),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;proguard-rules.pro&#34;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    compileOptions {
</span></span><span style=display:flex><span>        sourceCompatibility(<span style=color:#a6e22e>JavaVersion</span>.VERSION_1_8)
</span></span><span style=display:flex><span>        targetCompatibility(<span style=color:#a6e22e>JavaVersion</span>.VERSION_1_8)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>    implementation(files(<span style=color:#e6db74>&#34;../libs/lib-mod-release.aar&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// https://mvnrepository.com/artifact/io.reactivex.rxjava3/rxjava
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    implementation(<span style=color:#e6db74>&#34;io.reactivex.rxjava3:rxjava:3.1.3&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;androidx.appcompat:appcompat:1.2.0&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;com.google.android.material:material:1.3.0&#34;</span>)
</span></span><span style=display:flex><span>    implementation(<span style=color:#e6db74>&#34;androidx.constraintlayout:constraintlayout:2.1.3&#34;</span>)
</span></span><span style=display:flex><span>    testImplementation(<span style=color:#e6db74>&#34;junit:junit:4.+&#34;</span>)
</span></span><span style=display:flex><span>    androidTestImplementation(<span style=color:#e6db74>&#34;androidx.test.ext:junit:1.1.2&#34;</span>)
</span></span><span style=display:flex><span>    androidTestImplementation(<span style=color:#e6db74>&#34;androidx.test.espresso:espresso-core:3.3.0&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=702-root-build-gradle-脚本配置>7.0.2 root Build gradle 脚本配置<a hidden class=anchor aria-hidden=true href=#702-root-build-gradle-脚本配置>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>dependencyResolutionManagement {
</span></span><span style=display:flex><span>    repositoriesMode.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>RepositoriesMode</span>.FAIL_ON_PROJECT_REPOS)
</span></span><span style=display:flex><span>    repositories {
</span></span><span style=display:flex><span>        google()
</span></span><span style=display:flex><span>        mavenCentral()
</span></span><span style=display:flex><span>        jcenter() <span style=color:#75715e>// Warning: this repository is going to shut down soon
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        flatDir {
</span></span><span style=display:flex><span>            dir(<span style=color:#e6db74>&#34;libs&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>rootProject.name = <span style=color:#e6db74>&#34;NoSuchMethodError&#34;</span>
</span></span><span style=display:flex><span>include <span style=color:#960050;background-color:#1e0010>&#39;</span>:app<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>include <span style=color:#960050;background-color:#1e0010>&#39;</span>:lib-mod<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span></code></pre></div><h2 id=限制不足>限制/不足<a hidden class=anchor aria-hidden=true href=#限制不足>#</a></h2><p>在 kotlin dsl 脚本中引入其他独立的 kotlin 的dsl 脚本不方便，会存在无法识别相关依赖对象的问题，部分情况下还是得导入使用 groovy 编写的 gradle 脚本。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://hanlyjiang.github.io/tags/gradle/>Gradle</a></li></ul><nav class=paginav><a class=prev href=https://hanlyjiang.github.io/posts/dagger-zai-android-ku-sdkmo-kuai-zhong-de-shi-yong-shi-jian/><span class=title>«</span><br><span>Dagger 在Android库(SDK)模块中的使用实践</span>
</a><a class=next href=https://hanlyjiang.github.io/posts/clion-da-jian-arduino-kai-fa-huan-jing/><span class=title>»</span><br><span>CLion搭建Arduino开发环境</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hanlyjiang.github.io/>清水池塘</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>