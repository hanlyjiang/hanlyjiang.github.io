{
  "posts": [
    {
      "content": "\n\n\n本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；\n\n<!-- more -->\n\n\n\n**预先知识：**\n\n* Binder通信机制\n\n## 整体分析与总结\n\n### 主线地图与问题提出\n\n我们从bindService一路跟踪，初步绘制了如下的调用序列图，我们可以以下面的图作为一个主线地图，避免走失，然后根据具体问题进行细节分析。\n\n<svg width=\"625px\" height=\"425px\" viewBox=\"0 0 625 425\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"Android源码分析\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"bindService流程分析备份\" transform=\"translate(-98.000000, -85.000000)\">\n            <g id=\"架构图/模块-源码\" transform=\"translate(122.000000, 124.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" stroke-width=\"0.669456067\" fill=\"#E4E4E4\" x=\"0.334728033\" y=\"0.334728033\" width=\"229.405661\" height=\"25.3305439\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"67.177475\" y=\"11\">Context.bindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"25.5312824\" y=\"23.3877551\">frameworks/base/core/java/android/content/Context.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份\" transform=\"translate(122.000000, 162.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" stroke-width=\"0.669456067\" fill=\"#E4E4E4\" x=\"0.334728033\" y=\"0.334728033\" width=\"229.405661\" height=\"25.3305439\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"56.3758014\" y=\"11\">ContextImpl.bindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"24.523751\" y=\"23.3877551\">frameworks/base/core/java/android/app/ContextImpl.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-2\" transform=\"translate(122.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" stroke-width=\"0.669456067\" fill=\"#E4E4E4\" x=\"0.334728033\" y=\"0.334728033\" width=\"229.405661\" height=\"25.3305439\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"35.0817428\" y=\"11\">ContextImpl.bindServiceCommon</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"24.523751\" y=\"23.3877551\">frameworks/base/core/java/android/app/ContextImpl.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-3\" transform=\"translate(122.000000, 239.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" stroke-width=\"0.669456067\" fill=\"#E4E4E4\" x=\"0.334728033\" y=\"0.334728033\" width=\"229.405661\" height=\"25.3305439\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"26.9511989\" y=\"11\">IActivityManager.bindIsolatedService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"61.7354666\" y=\"23.3877551\">android/app/IActivityManager.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-4\" transform=\"translate(428.000000, 124.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.835383\" y=\"11\">ActivityManagerService.bindIsolatedService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"33.7957176\" y=\"23.3877551\">com/android/server/am/ActivityManagerService.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-5\" transform=\"translate(428.000000, 162.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"34.6552993\" y=\"11\">ActiveServices.bindServiceLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-16\" transform=\"translate(428.000000, 239.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"19.1486884\" y=\"11\">IApplicationThread.scheduleBindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"57.7019938\" y=\"23.3877551\">android/app/IApplicationThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-17\" transform=\"translate(428.000000, 285.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"78.9632491\" y=\"11\">Binder.transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"104.925425\" y=\"23.3877551\">binder</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-18\" transform=\"translate(364.000000, 124.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"48.2300469\" height=\"140\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"7.74941678\" y=\"11\">Binder.</tspan>\n                    <tspan x=\"5.09234565\" y=\"25\">transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"14.5028896\" y=\"91.4489796\">binder</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-18\" transform=\"translate(364.000000, 327.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"48.2300469\" height=\"140\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"7.74941678\" y=\"11\">Binder.</tspan>\n                    <tspan x=\"5.09234565\" y=\"25\">transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"14.5028896\" y=\"91.4489796\">binder</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-10\" transform=\"translate(427.000000, 327.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"20.74668\" y=\"11\">ApplicationThread.scheduleBindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"21.4409058\" y=\"23.3877551\">frameworks/base/core/java/android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-12\" transform=\"translate(427.000000, 366.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"33.2260106\" y=\"11\">ActivityThread#handleBindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"21.4409058\" y=\"23.3877551\">frameworks/base/core/java/android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-19\" transform=\"translate(427.000000, 404.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"48.4748809\" y=\"11\">IBinder = Service.onBinder()</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"80.1254248\" y=\"23.3877551\">自定义的Service实现类</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-20\" transform=\"translate(427.000000, 442.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"37.3498599\" y=\"11\">IActivityManager#publishService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"61.7354666\" y=\"23.3877551\">android/app/IActivityManager.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-21\" transform=\"translate(122.000000, 327.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"21.6558014\" y=\"11\">ActivityManagerService#publishService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"61.7354666\" y=\"23.3877551\">android/app/IActivityManager.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-23\" transform=\"translate(122.000000, 366.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"26.4872658\" y=\"11\">ActiveServices#publishServiceLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-8\" transform=\"translate(428.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"9.12492271\" y=\"11\">ActiveServices.requestServiceBindingLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-13\" transform=\"translate(293.000000, 85.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" stroke-width=\"0.669456067\" fill=\"#E4E4E4\" x=\"0.334728033\" y=\"0.334728033\" width=\"57.6028444\" height=\"25.3305439\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.7070289\" y=\"11\">APP-client</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"16.1955644\" y=\"23.3877551\">APP进程</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-14\" transform=\"translate(664.000000, 85.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"57.2723005\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"2.28895358\" y=\"11\">AMS-server</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.60727991\" y=\"23.3877551\">system_process</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-14\" transform=\"translate(293.000000, 483.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"57.2723005\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"2.28895358\" y=\"11\">AMS-server</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.60727991\" y=\"23.3877551\">system_process</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-15\" transform=\"translate(664.000000, 484.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"57.2723005\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"3.26368162\" y=\"11\">APP:server</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.19221715\" y=\"23.3877551\">APP Service进程</tspan>\n                </text>\n            </g>\n            <path id=\"直线-16\" d=\"M648.958513,91.3054393 C649.115942,91.3054393 649.271209,91.3429319 649.412018,91.4149479 L649.412018,91.4149479 L664.383659,99.0721148 C664.884587,99.3283119 665.087628,99.9513781 664.837164,100.463772 C664.739039,100.664514 664.579909,100.827287 664.383659,100.927658 L664.383659,100.927658 L649.412018,108.584825 C648.91109,108.841022 648.301967,108.633333 648.051503,108.120939 C647.981098,107.976907 647.944444,107.818086 647.944444,107.657053 L647.944444,107.657053 L647.944,101.338 L351,101.338912 C350.260539,101.338912 349.661088,100.739461 349.661088,100 C349.661088,99.3040369 350.19209,98.732096 350.871054,98.667217 L351,98.6610879 L647.944,98.661 L647.944444,92.3427195 C647.944444,91.8080371 648.339941,91.3678422 648.848019,91.3115259 Z\" fill-opacity=\"0.56105479\" fill=\"#C9C9C9\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-16备份-2\" d=\"M366.041487,488.305439 C366.601542,488.305439 367.055556,488.769845 367.055556,489.342719 L367.055556,489.342719 L367.055,495.661 L664,495.661088 C664.739461,495.661088 665.338912,496.260539 665.338912,497 C665.338912,497.695963 664.80791,498.267904 664.128946,498.332783 L664,498.338912 L367.055,498.338 L367.055556,504.657053 C367.055556,504.777828 367.034938,504.897358 366.994927,505.010339 L366.948497,505.120939 C366.698033,505.633333 366.08891,505.841022 365.587982,505.584825 L365.587982,505.584825 L350.616341,497.927658 C350.420091,497.827287 350.260961,497.664514 350.162836,497.463772 C349.912372,496.951378 350.115413,496.328312 350.616341,496.072115 L350.616341,496.072115 L365.587982,488.414948 C365.728791,488.342932 365.884058,488.305439 366.041487,488.305439 Z\" fill-opacity=\"0.56105479\" fill=\"#C9C9C9\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-16备份\" d=\"M696.5,110.661088 C697.195963,110.661088 697.767904,111.19209 697.832783,111.871054 L697.838912,112 L697.838,467.944 L704.157281,467.944444 C704.691963,467.944444 705.132158,468.339941 705.188474,468.848019 L705.194561,468.958513 C705.194561,469.115942 705.157068,469.271209 705.085052,469.412018 L705.085052,469.412018 L697.427885,484.383659 C697.171688,484.884587 696.548622,485.087628 696.036228,484.837164 C695.835486,484.739039 695.672713,484.579909 695.572342,484.383659 L695.572342,484.383659 L687.915175,469.412018 C687.658978,468.91109 687.866667,468.301967 688.379061,468.051503 C688.523093,467.981098 688.681914,467.944444 688.842947,467.944444 L688.842947,467.944444 L695.161,467.944 L695.161088,112 C695.161088,111.260539 695.760539,110.661088 696.5,110.661088 Z\" fill-opacity=\"0.56105479\" fill=\"#C9C9C9\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线\" d=\"M235.834728,150.007377 L235.834,156.046 L239.17364,156.046784 L235.5,163.046784 L231.82636,156.046784 L235.165,156.046 L235.165272,150.007377 L235.834728,150.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-2\" d=\"M235.834728,188.007377 L235.834,194.046 L239.17364,194.046784 L235.5,201.046784 L231.82636,194.046784 L235.165,194.046 L235.165272,188.007377 L235.834728,188.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-3\" d=\"M235.834728,226.007377 L235.834,232.046 L239.17364,232.046784 L235.5,239.046784 L231.82636,232.046784 L235.165,232.046 L235.165272,226.007377 L235.834728,226.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-17\" d=\"M358.063889,246.82636 L365.063889,250.5 L358.063889,254.17364 L358.063,250.834 L351.990272,250.834728 L351.990272,250.165272 L358.063,250.165 L358.063889,246.82636 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-4\" d=\"M422.04798,132.82636 L429.04798,136.5 L422.04798,140.17364 L422.047,136.834 L414.006181,136.834728 L414.006181,136.165272 L422.047,136.165 L422.04798,132.82636 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-5\" d=\"M542.834728,150.007377 L542.834,156.046 L546.17364,156.046784 L542.5,163.046784 L538.82636,156.046784 L542.165,156.046 L542.165272,150.007377 L542.834728,150.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-6\" d=\"M542.834728,188.007377 L542.834,194.046 L546.17364,194.046784 L542.5,201.046784 L538.82636,194.046784 L542.165,194.046 L542.165272,188.007377 L542.834728,188.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-7\" d=\"M542.834728,226.007377 L542.834,232.046 L546.17364,232.046784 L542.5,239.046784 L538.82636,232.046784 L542.165,232.046 L542.165272,226.007377 L542.834728,226.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-8\" d=\"M542.834728,263.998605 L542.834,277.055 L546.17364,277.055556 L542.5,284.055556 L538.82636,277.055556 L542.165,277.055 L542.165272,263.998605 L542.834728,263.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-9\" d=\"M542.834728,309.998605 L542.834,321.055 L546.17364,321.055556 L542.5,328.055556 L538.82636,321.055556 L542.165,321.055 L542.165272,309.998605 L542.834728,309.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-10\" d=\"M542.834728,353.007377 L542.834,359.046 L546.17364,359.046784 L542.5,366.046784 L538.82636,359.046784 L542.165,359.046 L542.165272,353.007377 L542.834728,353.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-18\" d=\"M542.834728,392.007377 L542.834,398.046 L546.17364,398.046784 L542.5,405.046784 L538.82636,398.046784 L542.165,398.046 L542.165272,392.007377 L542.834728,392.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-11\" d=\"M542.834728,430.007377 L542.834,436.046 L546.17364,436.046784 L542.5,443.046784 L538.82636,436.046784 L542.165,436.046 L542.165272,430.007377 L542.834728,430.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-19\" d=\"M419.944444,451.82636 L419.944,455.165 L427.001395,455.165272 L427.001395,455.834728 L419.944,455.834 L419.944444,459.17364 L412.944444,455.5 L419.944444,451.82636 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-20\" d=\"M358.936111,336.82636 L358.936,340.165 L365.009728,340.165272 L365.009728,340.834728 L358.936,340.834 L358.936111,344.17364 L351.936111,340.5 L358.936111,336.82636 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-12\" d=\"M235.834728,353.007377 L235.834,359.046 L239.17364,359.046784 L235.5,366.046784 L231.82636,359.046784 L235.165,359.046 L235.165272,353.007377 L235.834728,353.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <g id=\"序号\" transform=\"translate(98.000000, 222.000000)\">\n                <circle id=\"椭圆形\" stroke=\"#888888\" fill-opacity=\"0.5\" fill=\"#E4E4E4\" cx=\"10\" cy=\"10\" r=\"9.5\"></circle>\n                <text id=\"1\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"10\" font-weight=\"800\" letter-spacing=\"0.110000004\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"6.9\" y=\"14\">1</tspan>\n                </text>\n            </g>\n            <g id=\"序号备份\" transform=\"translate(660.000000, 222.000000)\">\n                <circle id=\"椭圆形\" stroke=\"#888888\" fill-opacity=\"0.5\" fill=\"#E4E4E4\" cx=\"10\" cy=\"10\" r=\"9.5\"></circle>\n                <text id=\"2\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"10\" font-weight=\"800\" letter-spacing=\"0.110000004\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"6.9\" y=\"14\">2</tspan>\n                </text>\n            </g>\n        </g>\n    </g>\n</svg>\n\n\n从上图中，我们提出如下问题：\n\n1. bindServiceCommon到IActivityManager的调用中，是如何获取到ActivityManagerService的？\n2. AMS中如何获取ApplicationThread并与之通讯？\n   * ApplicatoinThread的用途？ApplicationThread运行的进程是哪个？\n3. 进程如何启动-即AMS如何创建APP:server进程？\n4. Service如何启动？\n5. Service如何绑定？\n   * ServiceConnection 的回调方法何时使用？\n\n### 问题解答汇总\n\n我们将相关问题的结论提前到此小节，便于后续从比较抽象的层次上来进行复习及预览；\n\n#### APP进程如何获取AMS？\n\n* APP进程中通过 `ServiceManager.getService(Context.ACTIVITY_SERVICE)` 获取的ActivityManagerService的客户端操作代理对象（Proxy）。\n\n  > 该对象位于APP进程中，可以使用此对象（通过Binder进程间通信）来要求（位于system_process中）的ActivityManagerService进行对应的服务操作； \n\n#### AMS如何获取ApplicationThread？\n\n* APP进程在binderSerice时，将自己进程中的ApplicationThread取出，通过Binde机制传递给AMS进程；\n\n  ```java\n  ActivityManager.getService().bindIsolatedService(\n              mMainThread.getApplicationThread(), getActivityToken(), service,\n              service.resolveTypeIfNeeded(getContentResolver()),\n              sd, flags, instanceName, getOpPackageName(), user.getIdentifier());\n  ```\n\n#### 服务如何绑定？服务如何启动？进程如何启动？\n\n* 进程启动：\n  * 在系统进程中，通过AMS的`startProcessLocked`方法启动进程，\n* 服务启动：\n  * \n* 服务绑定：\n  * \n\n### 整体流程总结\n\n## 详细分析解答问题\n\n### APP进程中如何获取AMS？\n\n> 说明：\n>\n> * 第一次先逐项查看各个小节，最后再看此处的总结；\n>\n> * 后续直接查看总结来快速获取结论；\n\n==总结：==\n\n* APP进程中通过 `ServiceManager.getService(Context.ACTIVITY_SERVICE)` 获取的ActivityManagerService的客户端操作代理对象（Proxy）。\n* 该对象位于APP进程中，可以使用此对象（通过Binder进程间通信）来要求（位于system_process中）的ActivityManagerService进行对应的服务操作； \n\n具体查看如下代码：\n\n#### ContextImpl.bindServiceCommon\n\n我们看 `ContextImpl.bindServiceCommon` 方法的实现，可以看到是调用了 ActivityManager.getService() 获取的；\n\n`frameworks/base/core/java/android/app/ContextImpl.java`: \n\n```java\nprivate boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags,\n            String instanceName, Handler handler, Executor executor, UserHandle user) {\n        // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.\n        IServiceConnection sd;\n        \n        if (executor != null) {\n            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags);\n        } else {\n            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);\n        }\n\t    //\n        int res = ActivityManager.getService().bindIsolatedService(\n            mMainThread.getApplicationThread(), getActivityToken(), service,\n            service.resolveTypeIfNeeded(getContentResolver()),\n            sd, flags, instanceName, getOpPackageName(), user.getIdentifier());\n\n}\n```\n\n#### `ActivityManager.getService()`\n\n如下代码，getService实际上是从ServiceManager获取一个ActivityService的Binder远程服务接口对象，并且这个会被设置为单例模式；\n\n`frameworks/base/core/java/android/app/ActivityManager.java`:\n\n```java\nprivate static final Singleton<IActivityManager> IActivityManagerSingleton =\n    new Singleton<IActivityManager>() {\n    @Override\n    protected IActivityManager create() {\n        // 直接通过 ServiceManager.getService 获取一个IBinder对象\n        final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);\n        final IActivityManager am = IActivityManager.Stub.asInterface(b);\n        return am;\n    }\n};\n\npublic static IActivityManager getService() {\n    // 直接从IActivityManagerSingleton获取实例\n    return IActivityManagerSingleton.get();\n}\n```\n\n### AMS如何获取到 ApplicatoinThread？\n\n首先，AMS实际上位于系统进程（system_process)，而ApplicationThread则位于我们的APP进程，那么为什么需要这个跨进程的操作呢？\n\n* Service的创建需要经过系统的管理，比方说鉴权及其他管理需要；\n* 而开发者定义的Service的实例的创建逻辑也还是需要开发者来实现，Service对应的类也应该只加载在开发者自己的进程之中，Service使用方实际上还是开发者自己，所以服务的真实实例的创建过程要在应用的进程中；\n\n那么，系统进程（中的AMS）如何获取ApplicationThread呢？\n\n#### ApplicationThread的来源？\n\n查看 **ContextImpl.bindServiceCommon** 的代码，可以看到，是在调用AMS的bindService方法时，将自己进程中的ApplicationThread及ActivityToken取出传递给了AMS服务；\n\n```java\n// frameworks/base/core/java/android/app/ContextImpl.java\nfinal @NonNull ActivityThread mMainThread;\nprivate final @Nullable IBinder mToken;\n\npublic IBinder getActivityToken() {\n    return mToken;\n}\n\nprivate boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags,\n            String instanceName, Handler handler, Executor executor, UserHandle user) {\n        // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.\n        IServiceConnection sd;\n        try {\n            service.prepareToLeaveProcess(this);\n            // 调用时传递了ApplicationThread和IBinder\n            int res = ActivityManager.getService().bindIsolatedService(\n                mMainThread.getApplicationThread(), getActivityToken(), service,\n                service.resolveTypeIfNeeded(getContentResolver()),\n                sd, flags, instanceName, getOpPackageName(), user.getIdentifier());\n            if (res < 0) {\n                throw new SecurityException(\n                        \"Not allowed to bind to service \" + service);\n            }\n            return res != 0;\n        } catch (RemoteException e) {\n            throw e.rethrowFromSystemServer();\n        }\n    }\n```\n\n> 这里我们暂不考虑ApplicationThread由何处而来，每个进程中都对应一个ActivityThread，ActivityThread中有一个ApplicationThread对象。\n\n#### ApplicationThread在bind流程中的使用\n\n我们发现，最终是使用 `ApplicationThread`的 `requestServiceBindingLocked` 方法来绑定服务的。不过这里使用的时候是经过了几次成员变量操作符（`r.app.thread.scheduleBindService`），我们先梳理一下ServiceRecord类同ApplicationThread的关系；\n\n```java\n// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java\n// com.android.server.am.ActiveServices#requestServiceBindingLocked\nprivate final boolean requestServiceBindingLocked(ServiceRecord r, IntentBindRecord i,\n            boolean execInFg, boolean rebind) throws TransactionTooLargeException {\n        if (r.app == null || r.app.thread == null) {\n            // If service is not currently running, can't yet bind.\n            return false;\n        }\n\t    // 调用ApplicationThread的绑定方法来进行绑定\n        r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,\n                                         r.app.getReportedProcState());\n        return true;\n    }\n\n// frameworks/base/services/core/java/com/android/server/am/ServiceRecord.java\nProcessRecord app;          // where this service is running or null.\n\n// frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java\nIApplicationThread thread;  // the actual proc...  may be null only if\n                            // 'persistent' is true (in which case we\n                            // are in the process of launching the app)\n```\n\n其中 `ServiceRecord.app` 的类型为 `ProcessRecord` ，`ServiceRecord.app.thread` 的类型为 `IApplicationThread`，我们梳理下对应的几个类的关系，如下图：\n\n\n<svg width=\"730px\" height=\"473px\" viewBox=\"0 0 730 473\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"Android源码分析\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"ServiceRecord类图\" transform=\"translate(-38.000000, -20.000000)\">\n            <g id=\"类\" transform=\"translate(41.000000, 22.000000)\">\n                <g id=\"编组\" transform=\"translate(0.663121, -1.869103)\">\n                    <path d=\"M182.673759,0.5 C183.364115,0.5 183.989115,0.779822031 184.441526,1.23223305 C184.893937,1.68464406 185.173759,2.30964406 185.173759,3 L185.173759,3 L185.173759,27.8255814 L0.5,27.8255814 L0.5,3 C0.5,2.30964406 0.779822031,1.68464406 1.23223305,1.23223305 C1.68464406,0.779822031 2.30964406,0.5 3,0.5 L3,0.5 Z\" id=\"矩形\" stroke=\"#979797\" fill=\"#F2F2F2\"></path>\n                    <text id=\"类名\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"41.574\" y=\"16.3255814\">ServiceRecord</tspan>\n                    </text>\n                </g>\n                <g id=\"属性\" transform=\"translate(0.663121, 22.288571)\">\n                    <rect id=\"矩形\" stroke=\"#979797\" fill=\"#E0E0E0\" x=\"0.5\" y=\"0.5\" width=\"184.756391\" height=\"46.2285714\"></rect>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"9.36631979\" y=\"14.7457143\">app:ProcessRecord </tspan>\n                        <tspan x=\"9.36631979\" y=\"32.7457143\">isolatedProc: ProcessRecord </tspan>\n                    </text>\n                </g>\n                <g id=\"方法\" transform=\"translate(0.663121, 67.942857)\">\n                    <path d=\"M185.256391,0.5 L185.256391,43.2285714 C185.256391,44.1950697 184.86464,45.0700697 184.231264,45.7034452 C183.597889,46.3368206 182.722889,46.7285714 181.756391,46.7285714 L181.756391,46.7285714 L4,46.7285714 C3.03350169,46.7285714 2.15850169,46.3368206 1.52512627,45.7034452 C0.891750844,45.0700697 0.5,44.1950697 0.5,43.2285714 L0.5,43.2285714 L0.5,0.5 L185.256391,0.5 Z\" id=\"矩形备份\" stroke=\"#979797\" fill=\"#E0E0E0\"></path>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"9.36631979\" y=\"15.74\">+ setProcess(ProcessRecord) </tspan>\n                    </text>\n                </g>\n            </g>\n            <g id=\"类备份\" transform=\"translate(41.000000, 193.000000)\">\n                <g id=\"编组\" transform=\"translate(0.663121, -1.869103)\">\n                    <path d=\"M182.673759,0.5 C183.364115,0.5 183.989115,0.779822031 184.441526,1.23223305 C184.893937,1.68464406 185.173759,2.30964406 185.173759,3 L185.173759,3 L185.173759,27.8255814 L0.5,27.8255814 L0.5,3 C0.5,2.30964406 0.779822031,1.68464406 1.23223305,1.23223305 C1.68464406,0.779822031 2.30964406,0.5 3,0.5 L3,0.5 Z\" id=\"矩形\" stroke=\"#979797\" fill=\"#F2F2F2\"></path>\n                    <text id=\"类名\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"40.426\" y=\"16.3255814\">ProcessRecord</tspan>\n                    </text>\n                </g>\n                <g id=\"属性\" transform=\"translate(0.663121, 22.288571)\">\n                    <rect id=\"矩形\" stroke=\"#979797\" fill=\"#E0E0E0\" x=\"0.5\" y=\"0.5\" width=\"184.756391\" height=\"46.2285714\"></rect>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"9.36631979\" y=\"14.7457143\">thread:IApplicationThread </tspan>\n                        <tspan x=\"9.36631979\" y=\"32.7457143\">pid: int  </tspan>\n                    </text>\n                </g>\n                <g id=\"方法\" transform=\"translate(0.663121, 67.942857)\">\n                    <path d=\"M185.256391,0.5 L185.256391,43.2285714 C185.256391,44.1950697 184.86464,45.0700697 184.231264,45.7034452 C183.597889,46.3368206 182.722889,46.7285714 181.756391,46.7285714 L181.756391,46.7285714 L4,46.7285714 C3.03350169,46.7285714 2.15850169,46.3368206 1.52512627,45.7034452 C0.891750844,45.0700697 0.5,44.1950697 0.5,43.2285714 L0.5,43.2285714 L0.5,0.5 L185.256391,0.5 Z\" id=\"矩形备份\" stroke=\"#979797\" fill=\"#E0E0E0\"></path>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\"></text>\n                </g>\n            </g>\n            <g id=\"类备份-2\" transform=\"translate(326.000000, 84.000000)\">\n                <g id=\"编组\" transform=\"translate(1.570922, 0.886379)\">\n                    <path d=\"M436.858156,0.5 C437.548512,0.5 438.173512,0.779822031 438.625923,1.23223305 C439.078334,1.68464406 439.358156,2.30964406 439.358156,3 L439.358156,3 L439.358156,27.8255814 L0.5,27.8255814 L0.5,3 C0.5,2.30964406 0.779822031,1.68464406 1.23223305,1.23223305 C1.68464406,0.779822031 2.30964406,0.5 3,0.5 L3,0.5 Z\" id=\"矩形\" stroke=\"#979797\" fill=\"#F2F2F2\"></path>\n                    <text id=\"类名\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"152.123\" y=\"16.3255814\">IApplicationThread</tspan>\n                    </text>\n                </g>\n                <g id=\"属性\" transform=\"translate(1.570922, 27.284286)\">\n                    <rect id=\"矩形\" stroke=\"#979797\" fill=\"#E0E0E0\" x=\"0.5\" y=\"0.5\" width=\"439.05391\" height=\"56.8142857\"></rect>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"22.1886613\" y=\"14.9128571\">thread:IApplicationThread </tspan>\n                        <tspan x=\"22.1886613\" y=\"32.9128571\">pid: int  </tspan>\n                    </text>\n                </g>\n                <g id=\"方法\" transform=\"translate(1.570922, 83.171429)\">\n                    <path d=\"M439.55391,0.5 L439.55391,53.8142857 C439.55391,54.780784 439.162159,55.655784 438.528783,56.2891594 C437.895408,56.9225349 437.020408,57.3142857 436.05391,57.3142857 L436.05391,57.3142857 L4,57.3142857 C3.03350169,57.3142857 2.15850169,56.9225349 1.52512627,56.2891594 C0.891750844,55.655784 0.5,54.780784 0.5,53.8142857 L0.5,53.8142857 L0.5,0.5 L439.55391,0.5 Z\" id=\"矩形备份\" stroke=\"#979797\" fill=\"#E0E0E0\"></path>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"22.1886613\" y=\"16.13\">+ scheduleBindService(IBinder, Intent, boolean rebind, int processState)</tspan>\n                        <tspan x=\"22.1886613\" y=\"34.13\">+ scheduleCreateService(IBinder, ServiceInfo info,… )</tspan>\n                        <tspan x=\"22.1886613\" y=\"52.13\">+ bindApplication(…)</tspan>\n                    </text>\n                </g>\n            </g>\n            <g id=\"IApplicationThread.Stub\" transform=\"translate(326.000000, 402.000000)\">\n                <g id=\"编组\" transform=\"translate(0.946809, -4.518605)\">\n                    <path d=\"M262.106383,0.5 C262.796739,0.5 263.421739,0.779822031 263.87415,1.23223305 C264.326561,1.68464406 264.606383,2.30964406 264.606383,3 L264.606383,3 L264.606383,27.8255814 L0.5,27.8255814 L0.5,3 C0.5,2.30964406 0.779822031,1.68464406 1.23223305,1.23223305 C1.68464406,0.779822031 2.30964406,0.5 3,0.5 L3,0.5 Z\" id=\"矩形\" stroke=\"#979797\" fill=\"#F2F2F2\"></path>\n                    <text id=\"类名\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"66.65\" y=\"16.3255814\">ApplicationThread</tspan>\n                    </text>\n                </g>\n                <g id=\"属性\" transform=\"translate(0.946809, 17.485000)\">\n                    <rect id=\"矩形\" stroke=\"#979797\" fill=\"#E0E0E0\" x=\"0.5\" y=\"0.5\" width=\"264.224365\" height=\"36.05\"></rect>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\"></text>\n                </g>\n                <g id=\"方法\" transform=\"translate(0.946809, 53.300000)\">\n                    <path d=\"M264.724365,0.5 L264.724365,33.05 C264.724365,34.0164983 264.332615,34.8914983 263.699239,35.5248737 C263.065864,36.1582492 262.190864,36.55 261.224365,36.55 L261.224365,36.55 L4,36.55 C3.03350169,36.55 2.15850169,36.1582492 1.52512627,35.5248737 C0.891750844,34.8914983 0.5,34.0164983 0.5,33.05 L0.5,33.05 L0.5,0.5 L264.724365,0.5 Z\" id=\"矩形备份\" stroke=\"#979797\" fill=\"#E0E0E0\"></path>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\"></text>\n                </g>\n            </g>\n            <g id=\"IApplicationThread.Stub备份-2\" transform=\"translate(38.000000, 375.000000)\">\n                <g id=\"编组\" transform=\"translate(0.673759, -4.518605)\">\n                    <path d=\"M185.652482,0.5 C186.342838,0.5 186.967838,0.779822031 187.420249,1.23223305 C187.87266,1.68464406 188.152482,2.30964406 188.152482,3 L188.152482,3 L188.152482,27.8255814 L0.5,27.8255814 L0.5,3 C0.5,2.30964406 0.779822031,1.68464406 1.23223305,1.23223305 C1.68464406,0.779822031 2.30964406,0.5 3,0.5 L3,0.5 Z\" id=\"矩形\" stroke=\"#979797\" fill=\"#F2F2F2\"></path>\n                    <text id=\"类名\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"41.408\" y=\"16.3255814\">ActivityThread</tspan>\n                    </text>\n                </g>\n                <g id=\"属性\" transform=\"translate(0.673759, 17.485000)\">\n                    <rect id=\"矩形\" stroke=\"#979797\" fill=\"#E0E0E0\" x=\"0.5\" y=\"0.5\" width=\"187.73644\" height=\"36.05\"></rect>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"9.5165816\" y=\"14.585\">mAppThread:ApplicationThread </tspan>\n                    </text>\n                </g>\n                <g id=\"方法\" transform=\"translate(0.673759, 53.300000)\">\n                    <path d=\"M188.23644,0.5 L188.23644,33.05 C188.23644,34.0164983 187.844689,34.8914983 187.211313,35.5248737 C186.577938,36.1582492 185.702938,36.55 184.73644,36.55 L184.73644,36.55 L4,36.55 C3.03350169,36.55 2.15850169,36.1582492 1.52512627,35.5248737 C0.891750844,34.8914983 0.5,34.0164983 0.5,33.05 L0.5,33.05 L0.5,0.5 L188.23644,0.5 Z\" id=\"矩形备份\" stroke=\"#979797\" fill=\"#E0E0E0\"></path>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\"></text>\n                </g>\n            </g>\n            <g id=\"IApplicationThread.Stub备份\" transform=\"translate(326.000000, 268.000000)\">\n                <g id=\"编组\" transform=\"translate(0.946809, -4.094684)\">\n                    <path d=\"M262.106383,0.5 C262.796739,0.5 263.421739,0.779822031 263.87415,1.23223305 C264.326561,1.68464406 264.606383,2.30964406 264.606383,3 L264.606383,3 L264.606383,27.8255814 L0.5,27.8255814 L0.5,3 C0.5,2.30964406 0.779822031,1.68464406 1.23223305,1.23223305 C1.68464406,0.779822031 2.30964406,0.5 3,0.5 L3,0.5 Z\" id=\"矩形\" stroke=\"#979797\" fill=\"#F2F2F2\"></path>\n                    <text id=\"类名\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                        <tspan x=\"44.7399999\" y=\"16.3255814\">IApplicationThread.Stub</tspan>\n                    </text>\n                </g>\n                <g id=\"属性\" transform=\"translate(0.946809, 18.253571)\">\n                    <rect id=\"矩形\" stroke=\"#979797\" fill=\"#E0E0E0\" x=\"0.5\" y=\"0.5\" width=\"264.224365\" height=\"37.6785714\"></rect>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\"></text>\n                </g>\n                <g id=\"方法\" transform=\"translate(0.946809, 55.642857)\">\n                    <path d=\"M264.724365,0.5 L264.724365,34.6785714 C264.724365,35.6450697 264.332615,36.5200697 263.699239,37.1534452 C263.065864,37.7868206 262.190864,38.1785714 261.224365,38.1785714 L261.224365,38.1785714 L4,38.1785714 C3.03350169,38.1785714 2.15850169,37.7868206 1.52512627,37.1534452 C0.891750844,36.5200697 0.5,35.6450697 0.5,34.6785714 L0.5,34.6785714 L0.5,0.5 L264.724365,0.5 Z\" id=\"矩形备份\" stroke=\"#979797\" fill=\"#E0E0E0\"></path>\n                    <text font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"12\" font-weight=\"300\" letter-spacing=\"0.132000005\"></text>\n                </g>\n            </g>\n            <g id=\"UML/线条/实现\" transform=\"translate(455.000000, 225.500000)\" stroke=\"#979797\">\n                <line x1=\"2.5\" y1=\"38.8055556\" x2=\"2.5\" y2=\"7.30555556\" id=\"直线-24\" stroke-linecap=\"square\" stroke-dasharray=\"2\"></line>\n                <path d=\"M2.5,-0.931966011 L5.69098301,5.45 L-0.690983006,5.45 L2.5,-0.931966011 Z\" id=\"三角形\"></path>\n            </g>\n            <g id=\"UML/线条/实现\" transform=\"translate(455.000000, 363.000000)\" stroke=\"#979797\">\n                <line x1=\"4.5\" y1=\"34.8333333\" x2=\"4.5\" y2=\"8\" id=\"直线-24\" stroke-linecap=\"square\"></line>\n                <path d=\"M4.5,1.11803399 L7.69098301,7.5 L1.30901699,7.5 L4.5,1.11803399 Z\" id=\"三角形\"></path>\n            </g>\n            <g id=\"UML/线条/聚合\" transform=\"translate(128.000000, 138.000000)\">\n                <path id=\"直线-24\" d=\"M6.50883555,9.81274647 L7.5086821,9.83026412 L7.49992328,10.3301874 L6.85324563,47.2403042 L6.746,53.315 L10.4214873,47.041539 L10.6742143,46.6101122 L11.5370678,47.1155662 L11.2843409,47.546993 L6.64489019,55.466936 L6.19559777,56.2339169 L5.77344839,55.451668 L1.41428008,47.3740662 L1.17682105,46.9340512 L2.05685107,46.4591331 L2.2943101,46.8991481 L5.747,53.297 L5.85339907,47.2227865 L6.50007672,10.3126697 L6.50883555,9.81274647 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n                <path d=\"M7.04493542,0.824414956 L10.6703645,5.5 L7.04493542,10.175585 L3.53698783,5.5 L7.04493542,0.824414956 Z\" id=\"多边形\" stroke=\"#979797\"></path>\n            </g>\n            <g id=\"编组\" transform=\"translate(272.810486, 148.720337)\" fill=\"#979797\">\n                <g id=\"UML/线条/组合\" transform=\"translate(4.500000, 49.000000) rotate(-90.000000) translate(-4.500000, -49.000000) \">\n                    <path id=\"直线-24\" d=\"M4.00288801,10.1257 L5.00287142,10.1314594 L4.99999171,10.6314511 L4.54315542,89.9498322 L4.507,96.035 L8.10875237,89.7196752 L8.35638881,89.2853065 L9.22512627,89.7805794 L8.97748982,90.2149481 L4.43148901,98.188898 L3.99124645,98.9611091 L3.55992793,98.1838782 L-0.893921989,90.1580935 L-1.13653865,89.7209011 L-0.262153947,89.2356678 L-0.0195372819,89.6728601 L3.507,96.027 L3.54317201,89.9440727 L4.00000829,10.6256917 L4.00288801,10.1257 Z\" fill-rule=\"nonzero\"></path>\n                    <polygon id=\"多边形\" stroke=\"#979797\" points=\"4.5 0 8.76467693 5.5 4.5 11 0.373519229 5.5\"></polygon>\n                </g>\n            </g>\n            <g id=\"编组\" transform=\"translate(272.810486, 366.720337)\" fill=\"#979797\">\n                <g id=\"UML/线条/组合\" transform=\"translate(4.500000, 49.000000) rotate(-90.000000) translate(-4.500000, -49.000000) \">\n                    <path id=\"直线-24\" d=\"M4.00288801,10.1257 L5.00287142,10.1314594 L4.99999171,10.6314511 L4.54315542,89.9498322 L4.507,96.035 L8.10875237,89.7196752 L8.35638881,89.2853065 L9.22512627,89.7805794 L8.97748982,90.2149481 L4.43148901,98.188898 L3.99124645,98.9611091 L3.55992793,98.1838782 L-0.893921989,90.1580935 L-1.13653865,89.7209011 L-0.262153947,89.2356678 L-0.0195372819,89.6728601 L3.507,96.027 L3.54317201,89.9440727 L4.00000829,10.6256917 L4.00288801,10.1257 Z\" fill-rule=\"nonzero\"></path>\n                    <polygon id=\"多边形\" stroke=\"#979797\" points=\"4.5 0 8.76467693 5.5 4.5 11 0.373519229 5.5\"></polygon>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>\n\n现在我们看下 ServiceRecord 是何时构造的，首先，根据方法的调用层次，我们可以看到：\n\n* `ActiveServices.bindServiceLocked` 方法中，参数中没有ServiceRecord，有的是IApplicationThread及一个IBinder。\n* `ActiveServices.requestServiceBindingLocked` 方法中，则变成了ServiceRecord类型。\n\n![image-20210410215833909](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410215833.png)\n\n> 提示：上述调用层次可以在IDEA中选中`ActiveServices.requestServiceBindingLocked`方法，然后通过“**Navigate｜Call Hierarchy**”（快捷键为==ctrl+opt+H==）弹出。\n\n\n\n所以，接下来我们看下 `ActiveServices.bindServiceLocked` 方法如何将`ApplicationThread`存入到`ServiceRecord`对象中。\n\n##### ActiveServices.bindServiceLocked\n\n```java\n    int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service,\n            String resolvedType, final IServiceConnection connection, int flags,\n            String instanceName, String callingPackage, final int userId)\n            throws TransactionTooLargeException {\n        final int callingPid = Binder.getCallingPid();\n        final int callingUid = Binder.getCallingUid();\n        // 这里获取了 ProcessRecord\n        final ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);\n\n        final boolean callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;\n        final boolean isBindExternal = (flags & Context.BIND_EXTERNAL_SERVICE) != 0;\n        final boolean allowInstant = (flags & Context.BIND_ALLOW_INSTANT) != 0;\n\n        // 将IApplicationThread及IBinder放入到ServiceRecord中的过程在retrieveServiceLocked中\n        ServiceLookupResult res =\n            retrieveServiceLocked(service, instanceName, resolvedType, callingPackage,\n                    callingPid, callingUid, userId, true,\n                    callerFg, isBindExternal, allowInstant);\n        // 此处获取ServiceRecord，故在上面\n        ServiceRecord s = res.record;\n        if (s.app != null && b.intent.received) {\n            requestServiceBindingLocked(s, b.intent, callerFg, true);\n        } else if (!b.intent.requested) {\n            requestServiceBindingLocked(s, b.intent, callerFg, false);\n        }\n        return 1;\n    }\n```\n\n到这里，我们可以发现ServiceRecord是通过`retrieveServiceLocked`方法获取到的`ServiceLookupResult`获取到的。\n\n==粗略看了下这个`retrieveServiceLocked`方法，其中逻辑比较多，我们这里转换下思路，直接查找 `ServiceRecord.app` 的赋值操作==。\n\n##### `ServiceRecord.app` 的赋值\n\n我们可以找到ServiceRecord.app（ProcessRecord）的赋值操作的调用方法为：`com.android.server.am.ActiveServices#realStartServiceLocked`\n\n```java\nprivate final void realStartServiceLocked(ServiceRecord r,\n            ProcessRecord app, boolean execInFg) throws RemoteException {\n        if (app.thread == null) {\n            throw new RemoteException();\n        }\n    \t// 在此处赋值\n        r.setProcess(app);\n\t    // ...\n}\n```\n\n查看 `realStartServiceLocked` 的调用序列：\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410224824.png\" alt=\"image-20210410224824691\" style=\"zoom:50%;\" />\n\n也就是又回到了我们的 `bindServiceLocked` 方法，其中有一段逻辑是，如果需要创建服务，就执行 `bringUpServiceLocked` 方法。\n\n```java\n// com.android.server.am.ActiveServices#bindServiceLocked   \nint bindServiceLocked(IApplicationThread caller, IBinder token, Intent service,\n            String resolvedType, final IServiceConnection connection, int flags,\n            String instanceName, String callingPackage, final int userId)\n            throws TransactionTooLargeException {   \n        // ... \n\t\t\tif ((flags&Context.BIND_AUTO_CREATE) != 0) {\n                s.lastActivity = SystemClock.uptimeMillis();\n                if (bringUpServiceLocked(s, service.getFlags(), callerFg, false,\n                        permissionsReviewRequired) != null) {\n                    return 0;\n                }\n            }\n        // ... \n    }\n```\n\n也就是说，在绑定服务的时候，如果服务没有创建，就先使用`bringUpServiceLocked`-`realStartServiceLocked` 进行创建，创建过程中会将ServiceRecord中的app赋值，然后存储起来；\n\n> 提示：我们可以通过如下IDEA操作来查找赋值操作\n>\n> 1. 选中成员（这里是 app）；\n>\n> 2. ==Ctrl+B== 或者 ==Command+鼠标单击==，弹出使用列表弹窗；\n>\n> 3. 然后在弹窗中设置仅查看write访问操作的；然后我们可以找到对应的赋值代码行；\n>\n>    <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410223230.png\" alt=\"image-20210410223230694\" style=\"zoom:50%;\" />\n>\n> 4. 通过勾选其中的方法图标，我们可以显示赋值的代码行所在的方法（这里是setProcess）；\n>\n>    <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410223820.png\" alt=\"image-20210410223820657\" style=\"zoom:50%;\" />\n>\n> 5. 然后我们继续在方法上执行上述操作，可以获取到更加上一步的赋值调用在哪；\n>\n>    <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410224023.png\" alt=\"image-20210410224023641\" style=\"zoom:50%;\" />\n\n### 服务如何绑定？服务如何启动？进程如何启动？\n\n1. **bringUpServiceLocked(ServiceRecord r,...)** 第一个参数为ServiceRecord，其中的app属性可存储一个进程记录； \n2. 如传入的ServiceRecord参数中表明服务已经启动过，`r.app(ProcessRecord)` 不为null，且`r.app.thread(IApplicationThread)`也不为null，则不创建，直接更新参数；\n3. 结下来，则分为两种情况，1）服务为声明单独的进程，则可直接在当前进程中启动；2）服务声明了单独的进程，则需要先启动进程，然后再启动服务；\n4. **非单独进程**：\n   * 进程记录获取：通过AMS直接查询，并未创建，因为进程已经存在了，具体代码为 `app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false)`\n   * 服务启动：使用 `realStartServiceLocked(r, app, execInFg);` 方法启动\n5. **单独进程**：\n   * 进程记录获取： 通过AMS.mAm.startProcessLocked 方法启动一个新的进程； \n     * `app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags,\n                           hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false)`\n   * 服务启动：未在此方法中直接调用 `realStartServiceLocked`\n\n这里我们可以看到，在**单独进程**的服务启动流程中，并没有即时调用`realStartServiceLocked`来启动服务，那么这里就又个问题，独立进程情况下服务何时启动？\n\n6. **单独进程服务启动：** 将待启动的服务加入到`mPendingServices(ArrayList<ServiceRecord>)`，在启动进程后再从此列表中读取需要启动的服务，然后启动；\n\n\n\n**总结：** \n\n1. 进程记录如何获取？\n\n   * 通过AMS的 `startProcessLocked` 方法创建（非独立进程的也应该是通过此方法创建，只是创建时机不是这里）\n\n2. 服务如何启动？\n\n   * 通过 `realStartServiceLocked` 方法启动（独立进程的应该也是此方法启动，会等到进程启动之后再启动）\n\n   * > `realStartServiceLocked` 中通过 `IApplicationThread` 执行 `scheduleCreateService` 来启动服务，最终调用 `android.app.ActivityThread.ApplicationThread#scheduleCreateService`来启动；\n\n### 进程创建\n\n> 问题：\n>\n> 1. 进程何时创建？- 已解决\n> 2. ApplicationThread对象何时设置到ProcessRecord中? - 已解决\n> 3. ActivityThread#main的入口点中，如何获取之前的结果？ - 已解决\n\n下面为创建进程的调用序列，注意如下序列中只是创建了一个ProcessRecord的对象，对应于Linux上的进程创建我们再起文章进行分析，对于我们的Service来说，拿到ProcessRecord对象即可供我们来创建服务；\n\n\n<svg width=\"526px\" height=\"575px\" viewBox=\"0 0 526 575\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"Android源码分析\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"bindService流程分析-加入启动流程\" transform=\"translate(-736.000000, -169.000000)\">\n            <g id=\"架构图/模块-源码备份-25\" transform=\"translate(737.000000, 235.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.5542114\" y=\"11\">ActivityManagerService#startProcessLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"33.7957176\" y=\"23.3877551\">com/android/server/am/ActivityManagerService.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-37\" transform=\"translate(990.000000, 235.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.5542114\" y=\"11\">ActivityManagerService#startProcessLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"28.3999017\" y=\"23.3877551\">startProcessLocked(hostingRecord, entryPoint) 带入口点</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-38\" transform=\"translate(973.000000, 278.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"133.629108\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"8.68091383\" y=\"11\">ProcessList#startProcess</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"11.0735497\" y=\"23.3877551\">带入口类 android.app.ActivityThread</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-49\" transform=\"translate(1120.000000, 278.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"140.661972\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"2.2157558\" y=\"11\">handleProcessStartedLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"22.5230361\" y=\"23.3877551\">记录ProcessRecord（通过PID）</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-39\" transform=\"translate(990.000000, 321.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"17.0024123\" y=\"11\">android.os.ZygoteProcess#startViaZygote</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"58.7965544\" y=\"23.3877551\">带入口类 android.app.ActivityThread</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-40\" transform=\"translate(990.000000, 364.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"8.41262146\" y=\"11\">ZygoteProcess#zygoteSendArgsAndGetResult</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"58.7965544\" y=\"23.3877551\">带入口类 android.app.ActivityThread</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-41\" transform=\"translate(990.000000, 412.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"99.5684373\" y=\"11\">zygote</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"84.7078515\" y=\"23.3877551\">zygote创建新的进程</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-42\" transform=\"translate(990.000000, 455.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"62.0929562\" y=\"11\">ActivityThread#main()</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"77.8124541\" y=\"23.3877551\">进程创建后执行入口函数</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-44\" transform=\"translate(990.000000, 497.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"62.7115336\" y=\"11\">ActivityThread#attach</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"103.107852\" y=\"23.3877551\">module</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-26\" transform=\"translate(737.000000, 281.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"35.9721194\" y=\"11\">ProcessList#startProcessLocked()</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"52.1187301\" y=\"23.3877551\">com/android/server/am/ProcessList.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-11\" transform=\"translate(736.000000, 323.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"24.3831654\" y=\"11\">ProcessList#newProcessRecordLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"52.1187301\" y=\"23.3877551\">com/android/server/am/ProcessList.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-27\" transform=\"translate(736.000000, 362.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"24.3831654\" y=\"11\">ProcessList#newProcessRecordLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"53.5814917\" y=\"23.3877551\">new ProcessRecord(ams, info, proc, uid)</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-9\" transform=\"translate(736.000000, 197.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"24.9173913\" y=\"11\">ActiveServices#bringUpServiceLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <path id=\"直线-7备份\" d=\"M851.834728,222.007377 L851.834,228.046 L855.17364,228.046784 L851.5,235.046784 L847.82636,228.046784 L851.165,228.046 L851.165272,222.007377 L851.834728,222.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-8备份\" d=\"M851.834728,259.998605 L851.834,273.055 L855.17364,273.055556 L851.5,280.055556 L847.82636,273.055556 L851.165,273.055 L851.165272,259.998605 L851.834728,259.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-9备份\" d=\"M851.834728,305.998605 L851.834,317.055 L855.17364,317.055556 L851.5,324.055556 L847.82636,317.055556 L851.165,317.055 L851.165272,305.998605 L851.834728,305.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-10备份\" d=\"M851.834728,349.007377 L851.834,355.046 L855.17364,355.046784 L851.5,362.046784 L847.82636,355.046784 L851.165,355.046 L851.165272,349.007377 L851.834728,349.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <text id=\"创建进程\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                <tspan x=\"966.692\" y=\"181\">创建进程</tspan>\n            </text>\n            <line x1=\"966.5\" y1=\"248.5\" x2=\"990.5\" y2=\"248.5\" id=\"直线-23\" stroke=\"#979797\" stroke-linecap=\"square\"></line>\n            <path id=\"直线-13\" d=\"M1067,260 L1067,270 L1071,270 L1066.5,279 L1062,270 L1066,270 L1066,260 L1067,260 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-14\" d=\"M1081,303 L1081,312 L1085,312 L1080.5,321 L1076,312 L1080,312 L1080,303 L1081,303 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-14备份\" d=\"M1184,260 L1184,269 L1188,269 L1183.5,278 L1179,269 L1183,269 L1183,260 L1184,260 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-15\" d=\"M1105,347 L1105,356 L1109,356 L1104.5,365 L1100,356 L1104,356 L1104,347 L1105,347 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-24\" d=\"M1105,390 L1105,404 L1109,404 L1104.5,413 L1100,404 L1104,404 L1104,390 L1105,390 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <text id=\"socket\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"8\" font-weight=\"300\" letter-spacing=\"0.088000003\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                <tspan x=\"1107.516\" y=\"401\">socket</tspan>\n            </text>\n            <path id=\"直线-25\" d=\"M1105,438 L1105,447 L1109,447 L1104.5,456 L1100,447 L1104,447 L1104,438 L1105,438 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <line x1=\"1235.5\" y1=\"301.5\" x2=\"1235.5\" y2=\"674.5\" id=\"直线-26\" stroke=\"#979797\" stroke-linecap=\"square\" stroke-dasharray=\"3\"></line>\n            <g id=\"架构图/模块-源码备份-45\" transform=\"translate(990.000000, 542.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"30.362747\" y=\"11\">IActivityManager#attachApplication</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"103.107852\" y=\"23.3877551\">module</tspan>\n                </text>\n            </g>\n            <path id=\"直线-27\" d=\"M1105,480 L1105,489 L1109,489 L1104.5,498 L1100,489 L1104,489 L1104,480 L1105,480 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-28\" d=\"M1105,523 L1105,534 L1109,534 L1104.5,543 L1100,534 L1104,534 L1104,523 L1105,523 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <g id=\"架构图/模块-源码备份-46\" transform=\"translate(990.000000, 629.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"14.6686884\" y=\"11\">ActivityManagerService#attachApplication</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"103.107852\" y=\"23.3877551\">module</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-47\" transform=\"translate(963.000000, 675.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"283.328638\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"25.0095075\" y=\"11\">ActivityManagerService#attachApplicationLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"87.6170389\" y=\"23.3877551\">获取之前缓存的ProcessRecord(app)</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-50\" transform=\"translate(963.000000, 718.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"283.328638\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"77.3964531\" y=\"11\">ProcessRecord#makeActive</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"52.1793819\" y=\"23.3877551\">app.makeActive(thread, mProcessStats) ; thread = _thread;</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-36\" transform=\"translate(990.000000, 583.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"95.5148809\" y=\"11\">transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"104.925425\" y=\"23.3877551\">binder</tspan>\n                </text>\n            </g>\n            <path id=\"直线-29\" d=\"M1105,567 L1105,575 L1109,575 L1104.5,584 L1100,575 L1104,575 L1104,567 L1105,567 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-30\" d=\"M1105,609 L1105,621 L1109,621 L1104.5,630 L1100,621 L1104,621 L1104,609 L1105,609 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-31\" d=\"M1105,655 L1105,667 L1109,667 L1104.5,676 L1100,667 L1104,667 L1104,655 L1105,655 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-32\" d=\"M1105,701 L1105,710 L1109,710 L1104.5,719 L1100,710 L1104,710 L1104,701 L1105,701 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n        </g>\n    </g>\n</svg>\n\n\n* 进程创建的执行位于AMS所在的系统进程之中；\n* （AMS进程）首先，构建一个ProcessRecord记录，并将其记录到AMS中；\n* （AMS进程）AMS通过socket通信，通知zygote来创建一个新的进程，同时指定入口点为 `android.app.ActivityThread` ;\n* （APP进程）新的进程启动后，执行ActivityThread中的方法，执行通知AMS来attachApplication；\n* （AMS进程）AMS中，通过PID获取之前存储的ProcessRecord，然后将ApplicationThread赋值给ProcessRecord的成员变量thread；\n* 支持完成了关联；\n\n#### 构造ProcessRecord实例\n\n`com.android.server.am.ProcessList#startProcessLocked`，简化下来就两句：\n\n* 构造ProcessRecord对象： `app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord)`\n* 启动进程：`startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride)`\n\n```java\n// com.android.server.am.ProcessList#newProcessRecordLocked\n// frameworks/base/services/core/java/com/android/server/am/ProcessList.java\nfinal ProcessRecord startProcessLocked(String processName, ApplicationInfo info,\n            boolean knownToBeDead, int intentFlags, HostingRecord hostingRecord,\n            int zygotePolicyFlags, boolean allowWhileBooting, boolean isolated, int isolatedUid,\n            boolean keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs,\n            Runnable crashHandler) {\n        long startTime = SystemClock.uptimeMillis();\n        ProcessRecord app;\n        if (app == null) {\n            // 构造ProcessRecord对象\n            app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord);\n            app.crashHandler = crashHandler;\n            app.isolatedEntryPoint = entryPoint;\n            app.isolatedEntryPointArgs = entryPointArgs;\n        } else {\n            // If this is a new package in the process, add the package to the list\n            app.addPackage(info.packageName, info.longVersionCode, mService.mProcessStats);\n        }\n\t    // 启动进程\n        final boolean success =\n                startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride);\n        checkSlow(startTime, \"startProcess: done starting proc!\");\n        return success ? app : null;\n    }\n```\n\n#### 启动进程 \n\n`startProcessLocked`: 启动了一个进程，并指定了入口点为 ==android.app.ActivityThread==，也就是进程启动后将会执行 ==android.app.ActivityThread==的main方法。\n\n```java\n// frameworks/base/services/core/java/com/android/server/am/ProcessList.java\n// com.android.server.am.ProcessList#startProcessLocked(com.android.server.am.ProcessRecord, com.android.server.am.HostingRecord, int, boolean, boolean, boolean, java.lang.String)\nboolean startProcessLocked(ProcessRecord app, HostingRecord hostingRecord,\n            int zygotePolicyFlags, boolean disableHiddenApiChecks, boolean disableTestApiChecks,\n            boolean mountExtStorageFull, String abiOverride) {\n        if (app.pendingStart) {\n            return true;\n        }\n        long startTime = SystemClock.uptimeMillis();\n        try {\n            try {\n                final int userId = UserHandle.getUserId(app.uid);\n                AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId);\n            } catch (RemoteException e) {\n                throw e.rethrowAsRuntimeException();\n            }\n\n            int uid = app.uid;\n            int[] gids = null;\n            // ... \n            \n            app.mountMode = mountExternal;\n            app.gids = gids;\n            app.setRequiredAbi(requiredAbi);\n            app.instructionSet = instructionSet;\n\n            final String seInfo = app.info.seInfo\n                    + (TextUtils.isEmpty(app.info.seInfoUser) ? \"\" : app.info.seInfoUser);\n            // Start the process.  It will either succeed and return a result containing\n            // the PID of the new process, or else throw a RuntimeException.\n            // 指定入口点为ActivityThread，启动进程\n            final String entryPoint = \"android.app.ActivityThread\";\n            return startProcessLocked(hostingRecord, entryPoint, app, uid, gids,\n                    runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi,\n                    instructionSet, invokeWith, startTime);\n        } catch (RuntimeException e) {\n            return false;\n        }\n    }\n\n\nboolean startProcessLocked(HostingRecord hostingRecord, String entryPoint, ProcessRecord app,\n            int uid, int[] gids, int runtimeFlags, int zygotePolicyFlags, int mountExternal,\n            String seInfo, String requiredAbi, String instructionSet, String invokeWith,\n            long startTime) {\n        app.pendingStart = true;\n        app.killedByAm = false;\n        app.removed = false;\n        app.killed = false;\n        final long startSeq = app.startSeq = ++mProcStartSeqCounter;\n        app.setStartParams(uid, hostingRecord, seInfo, startTime);\n        app.setUsingWrapper(invokeWith != null\n                || Zygote.getWrapProperty(app.processName) != null);\n        mPendingStarts.put(startSeq, app);\n\n        if (mService.mConstants.FLAG_PROCESS_START_ASYNC) {\n            return true;\n        } else {\n            try {\n                // 启动进程，并传入entrypoint\n                final Process.ProcessStartResult startResult = startProcess(hostingRecord,\n                        entryPoint, app,\n                        uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo,\n                        requiredAbi, instructionSet, invokeWith, startTime);\n                // 做启动后的操作\n                handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,\n                        startSeq, false);\n            } catch (RuntimeException e) {\n                \n            }\n            return app.pid > 0;\n        }\n    }\n```\n\n这里我们省略其他更加底层的步骤的分析，我们只需要知道到了这里之后，会启动一个进程，进程启动后会执行 ==android.app.ActivityThread#main== 方法；\n\n#### 记录进程记录到AMS\n\n`ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)`\n\n==这个地方有个关键的代码将之前创建的进程记录存储到了AMS的进程记录表中。==\n\n```java\n// com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)\n// frameworks/base/services/core/java/com/android/server/am/ProcessList.java\nActivityManagerService mService = null;\nboolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper,\n            long expectedStartSeq, boolean procAttached) {\n    // 将ProcessRecord 存储到AMS中\n    mService.addPidLocked(app);\n}\n  \n// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java\nvoid addPidLocked(ProcessRecord app) {\n    synchronized (mPidsSelfLocked) {\n        // 将进程记录添加到一个记录表中\n        mPidsSelfLocked.doAddInternal(app);\n    }\n    synchronized (sActiveProcessInfoSelfLocked) {\n        if (app.processInfo != null) {\n            sActiveProcessInfoSelfLocked.put(app.pid, app.processInfo);\n        } else {\n            sActiveProcessInfoSelfLocked.remove(app.pid);\n        }\n    }\n    mAtmInternal.onProcessMapped(app.pid, app.getWindowProcessController());\n}\n```\n```java\n// 完整代码\n// com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)\n// frameworks/base/services/core/java/com/android/server/am/ProcessList.java\nboolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper,\n            long expectedStartSeq, boolean procAttached) {\n        mPendingStarts.remove(expectedStartSeq);\n        final String reason = isProcStartValidLocked(app, expectedStartSeq);\n        if (reason != null) {\n            Slog.w(TAG_PROCESSES, app + \" start not valid, killing pid=\" +\n                    pid\n                    + \", \" + reason);\n            app.pendingStart = false;\n            killProcessQuiet(pid);\n            Process.killProcessGroup(app.uid, app.pid);\n            noteAppKill(app, ApplicationExitInfo.REASON_OTHER,\n                    ApplicationExitInfo.SUBREASON_INVALID_START, reason);\n            return false;\n        }\n        mService.mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);\n        checkSlow(app.startTime, \"startProcess: done updating battery stats\");\n\n        EventLog.writeEvent(EventLogTags.AM_PROC_START,\n                UserHandle.getUserId(app.startUid), pid, app.startUid,\n                app.processName, app.hostingRecord.getType(),\n                app.hostingRecord.getName() != null ? app.hostingRecord.getName() : \"\");\n\n        try {\n            AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid,\n                    app.seInfo, app.info.sourceDir, pid);\n        } catch (RemoteException ex) {\n            // Ignore\n        }\n\n        Watchdog.getInstance().processStarted(app.processName, pid);\n\n        checkSlow(app.startTime, \"startProcess: building log message\");\n        StringBuilder buf = mStringBuilder;\n        buf.setLength(0);\n        buf.append(\"Start proc \");\n        buf.append(pid);\n        buf.append(':');\n        buf.append(app.processName);\n        buf.append('/');\n        UserHandle.formatUid(buf, app.startUid);\n        if (app.isolatedEntryPoint != null) {\n            buf.append(\" [\");\n            buf.append(app.isolatedEntryPoint);\n            buf.append(\"]\");\n        }\n        buf.append(\" for \");\n        buf.append(app.hostingRecord.getType());\n        if (app.hostingRecord.getName() != null) {\n            buf.append(\" \");\n            buf.append(app.hostingRecord.getName());\n        }\n        mService.reportUidInfoMessageLocked(TAG, buf.toString(), app.startUid);\n        app.setPid(pid);\n        app.setUsingWrapper(usingWrapper);\n        app.pendingStart = false;\n        checkSlow(app.startTime, \"startProcess: starting to update pids map\");\n        ProcessRecord oldApp;\n        synchronized (mService.mPidsSelfLocked) {\n            oldApp = mService.mPidsSelfLocked.get(pid);\n        }\n        // If there is already an app occupying that pid that hasn't been cleaned up\n        if (oldApp != null && !app.isolated) {\n            // Clean up anything relating to this pid first\n            Slog.wtf(TAG, \"handleProcessStartedLocked process:\" + app.processName\n                    + \" startSeq:\" + app.startSeq\n                    + \" pid:\" + pid\n                    + \" belongs to another existing app:\" + oldApp.processName\n                    + \" startSeq:\" + oldApp.startSeq);\n            mService.cleanUpApplicationRecordLocked(oldApp, false, false, -1,\n                    true /*replacingPid*/);\n        }\n    // 注意这里 \n        mService.addPidLocked(app);\n        synchronized (mService.mPidsSelfLocked) {\n            if (!procAttached) {\n                Message msg = mService.mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);\n                msg.obj = app;\n                mService.mHandler.sendMessageDelayed(msg, usingWrapper\n                        ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);\n            }\n        }\n        checkSlow(app.startTime, \"startProcess: done updating pids map\");\n        return true;\n    }\n```\n\n#### 写入thread值到ProcessRecord\n\n从上面的流程中，我们发现构造出来的ProcessRecord的thread（ApplicationThread）成员变量还是没有被赋值，那么这个thread何时被赋值呢？\n\n> 查找`ProcessRecord`中`thread`赋值的入口：\n>\n> 1. 通过查找`thread`成员的赋值写入方法，可以确定起始点是，`com.android.server.am.ProcessRecord#makeActive` ，接下来查看调用这个方法的列表：\n> 2. ![image-20210411172323572](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411172323.png)\n>\n> 3. 这里我们显然选择 `com.android.server.am.ActivityManagerService#attachApplicationLocked`\n>\n> 4. `android.app.ActivityThread#attach`\n>\n> 5. 这里我们遇到两个选择：\n>\n>    <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411172524.png\" alt=\"image-20210411172524831\" style=\"zoom:50%;\" />\n>\n> 6. 显然，应该选择第二个：`android.app.ActivityThread#main`\n>\n> 7. 这里我们却无法直接通过IDEA的调用层次功能找到任何调用方法，说明可能是通过反射来调用的，所以直接通过全局字符串搜索==android.app.ActivityThread==，可以找到在 `ProcessList.startProcessLocked` 中调用的。\n\n通过上面的分析，这里我们从ActivityThread的main函数开始。\n\n#####  ActivityThread#main\n\n```java\n    public static void main(String[] args) {\n        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \"ActivityThreadMain\");\n\n        // Install selective syscall interception\n        AndroidOs.install();\n\n        // CloseGuard defaults to true and can be quite spammy.  We\n        // disable it here, but selectively enable it later (via\n        // StrictMode) on debug builds, but using DropBox, not logs.\n        CloseGuard.setEnabled(false);\n\n        Environment.initForCurrentUser();\n\n        // Make sure TrustedCertificateStore looks in the right place for CA certificates\n        final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());\n        TrustedCertificateStore.setDefaultUserDirectory(configDir);\n\n        // Call per-process mainline module initialization.\n        initializeMainlineModules();\n\n        Process.setArgV0(\"<pre-initialized>\");\n\n        Looper.prepareMainLooper();\n\n        // Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line.\n        // It will be in the format \"seq=114\"\n        long startSeq = 0;\n        if (args != null) {\n            for (int i = args.length - 1; i >= 0; --i) {\n                if (args[i] != null && args[i].startsWith(PROC_START_SEQ_IDENT)) {\n                    startSeq = Long.parseLong(\n                            args[i].substring(PROC_START_SEQ_IDENT.length()));\n                }\n            }\n        }\n        // 直接构造一个ActivityThread对象\n        ActivityThread thread = new ActivityThread();\n        // 执行attach方法\n        thread.attach(false, startSeq);\n\n        if (sMainThreadHandler == null) {\n            sMainThreadHandler = thread.getHandler();\n        }\n\n        if (false) {\n            Looper.myLooper().setMessageLogging(new\n                    LogPrinter(Log.DEBUG, \"ActivityThread\"));\n        }\n\n        // End of event ActivityThreadMain.\n        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);\n        Looper.loop();\n\n        throw new RuntimeException(\"Main thread loop unexpectedly exited\");\n    }\n```\n\n##### ActivityThread#attach\n\n```java\n private void attach(boolean system, long startSeq) {\n        sCurrentActivityThread = this;\n        mSystemThread = system;\n        if (!system) {\n            android.ddm.DdmHandleAppName.setAppName(\"<pre-initialized>\",\n                                                    UserHandle.myUserId());\n            // 将当前ApplicationThread的Binder对象保存为一个静态成员\n            RuntimeInit.setApplicationObject(mAppThread.asBinder());\n            // 获取AMS\n            final IActivityManager mgr = ActivityManager.getService();\n            try {\n                // 通知AMS来 attachApplication\n                mgr.attachApplication(mAppThread, startSeq);\n            } catch (RemoteException ex) {\n                throw ex.rethrowFromSystemServer();\n            }\n        } else {\n            \n        }\n}\n```\n\n##### **ActivityManagerService#attachApplication** & attachApplicationLocked\n\n```java\n    @Override\n    public final void attachApplication(IApplicationThread thread, long startSeq) {\n        if (thread == null) {\n            throw new SecurityException(\"Invalid application interface\");\n        }\n        synchronized (this) {\n            int callingPid = Binder.getCallingPid();\n            final int callingUid = Binder.getCallingUid();\n            final long origId = Binder.clearCallingIdentity();\n            attachApplicationLocked(thread, callingPid, callingUid, startSeq);\n            Binder.restoreCallingIdentity(origId);\n        }\n    }\n\n```\n上面的方法只是调用了 attachApplicationLocked：\n\n==有个关键的步骤是，从 AMS的进程记录表中根据PID取出一个 ProcessRecord: `app = mPidsSelfLocked.get(pid)`==\n\n```java\nprivate boolean attachApplicationLocked(@NonNull IApplicationThread thread,\n            int pid, int callingUid, long startSeq) {\n        // Find the application record that is being attached...  either via\n        // the pid if we are running in multiple processes, or just pull the\n        // next app record if we are emulating process with anonymous threads.\n        ProcessRecord app;\n        long startTime = SystemClock.uptimeMillis();\n        long bindApplicationTimeMillis;\n        if (pid != MY_PID && pid >= 0) {\n            synchronized (mPidsSelfLocked) {\n                // 从进程记录中获取\n                app = mPidsSelfLocked.get(pid);\n            }\n        }\n        // Make app active after binding application or client may be running requests (e.g\n        // starting activities) before it is ready.\n        // 关联thread到app（ProcessRecord）\n        app.makeActive(thread, mProcessStats);\n        return true;\n    }\n```\n\n经过上面的步骤，即完成了ProcessRecord到进程的ApplicationThread的关联。\n\n### 启动服务\n\n从AMS中调用ApplicationThread的方法来在Service自己应该所属的进程中创建Service对象的实例。\n\n\n<svg width=\"557px\" height=\"390px\" viewBox=\"0 0 557 390\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"Android源码分析\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"bindService流程分析-加入启动流程\" transform=\"translate(-1415.000000, -205.000000)\">\n            <g id=\"架构图/模块-源码备份-52\" transform=\"translate(1714.000000, 280.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"62.0929562\" y=\"11\">ActivityThread#main()</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"77.8124541\" y=\"23.3877551\">进程创建后执行入口函数</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-57\" transform=\"translate(1714.000000, 235.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"74.0568056\" y=\"11\">独立进程的Service</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"101.501157\" y=\"23.3877551\">启动进程</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-53\" transform=\"translate(1714.000000, 322.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"62.7115336\" y=\"11\">ActivityThread#attach</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"113.886094\" y=\"23.3877551\">-</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-28\" transform=\"translate(1416.000000, 316.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"13.5486884\" y=\"11\">IApplicationThread#scheduleCreateService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"57.7019938\" y=\"23.3877551\">android/app/IApplicationThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-29\" transform=\"translate(1416.000000, 362.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"95.5148809\" y=\"11\">transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"104.925425\" y=\"23.3877551\">binder</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-29\" transform=\"translate(1415.000000, 527.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"95.5148809\" y=\"11\">transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"104.925425\" y=\"23.3877551\">binder</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-30\" transform=\"translate(1415.000000, 404.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.14668\" y=\"11\">ApplicationThread#scheduleCreateService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"65.1496925\" y=\"23.3877551\">android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-31\" transform=\"translate(1415.000000, 443.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"28.8631654\" y=\"11\">ActivityThread#handleCreateService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"65.1496925\" y=\"23.3877551\">android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-33\" transform=\"translate(1416.000000, 485.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"20.3389813\" y=\"11\">IActivityManager#serviceDoneExecuting</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"65.1496925\" y=\"23.3877551\">android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-34\" transform=\"translate(1415.000000, 569.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.64492271\" y=\"11\">ActivityManagerService#serviceDoneExecuting</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"65.1496925\" y=\"23.3877551\">android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-32\" transform=\"translate(1416.000000, 237.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"24.9173913\" y=\"11\">ActiveServices#bringUpServiceLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-43\" transform=\"translate(1415.000000, 275.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"23.3147135\" y=\"11\">ActiveServices#realStartServiceLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <path id=\"直线-7备份-2\" d=\"M1531.83473,262.007377 L1531.834,268.046 L1535.17364,268.046784 L1531.5,275.046784 L1527.82636,268.046784 L1531.165,268.046 L1531.16527,262.007377 L1531.83473,262.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-8备份-2\" d=\"M1530.83473,340.998605 L1530.834,354.055 L1534.17364,354.055556 L1530.5,361.055556 L1526.82636,354.055556 L1530.165,354.055 L1530.16527,340.998605 L1530.83473,340.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-9备份-2\" d=\"M1530.83473,386.998605 L1530.834,398.055 L1534.17364,398.055556 L1530.5,405.055556 L1526.82636,398.055556 L1530.165,398.055 L1530.16527,386.998605 L1530.83473,386.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-10备份-2\" d=\"M1530.83473,430.007377 L1530.834,436.046 L1534.17364,436.046784 L1530.5,443.046784 L1526.82636,436.046784 L1530.165,436.046 L1530.16527,430.007377 L1530.83473,430.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <text id=\"启动服务\" font-family=\"NotoSansCJKsc-Black, Noto Sans CJK SC\" font-size=\"14\" font-weight=\"800\" letter-spacing=\"0.154000005\" fill=\"#020202\" fill-opacity=\"0.88378138\">\n                <tspan x=\"1503.692\" y=\"217\">启动服务</tspan>\n            </text>\n            <path id=\"直线-22\" d=\"M1530,469 L1530,477 L1534,477 L1529.5,486 L1525,477 L1529,477 L1529,469 L1530,469 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-22备份\" d=\"M1530,511 L1530,519 L1534,519 L1529.5,528 L1525,519 L1529,519 L1529,511 L1530,511 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-22备份-2\" d=\"M1530,553 L1530,561 L1534,561 L1529.5,570 L1525,561 L1529,561 L1529,553 L1530,553 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <g id=\"架构图/模块-源码备份-54\" transform=\"translate(1714.000000, 367.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"30.362747\" y=\"11\">IActivityManager#attachApplication</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"113.886094\" y=\"23.3877551\">-</tspan>\n                </text>\n            </g>\n            <path id=\"直线-27备份\" d=\"M1829,305 L1829,314 L1833,314 L1828.5,323 L1824,314 L1828,314 L1828,305 L1829,305 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-28备份\" d=\"M1829,348 L1829,359 L1833,359 L1828.5,368 L1824,359 L1828,359 L1828,348 L1829,348 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <g id=\"架构图/模块-源码备份-55\" transform=\"translate(1714.000000, 454.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"14.6686884\" y=\"11\">ActivityManagerService#attachApplication</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"113.886094\" y=\"23.3877551\">-</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-48\" transform=\"translate(1687.000000, 497.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"283.328638\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"25.0095075\" y=\"11\">ActivityManagerService#attachApplicationLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"59.3894238\" y=\"23.3877551\">获取之前存储的 mPendingServices - 待启动的服务列表</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-29\" transform=\"translate(1714.000000, 408.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"95.5148809\" y=\"11\">transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"104.925425\" y=\"23.3877551\">binder</tspan>\n                </text>\n            </g>\n            <path id=\"直线-29备份\" d=\"M1829,392 L1829,400 L1833,400 L1828.5,409 L1824,400 L1828,400 L1828,392 L1829,392 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-30备份\" d=\"M1829,434 L1829,446 L1833,446 L1828.5,455 L1824,446 L1828,446 L1828,434 L1829,434 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-33\" d=\"M1532,300 L1532,308 L1536,308 L1531.5,317 L1527,308 L1531,308 L1531,300 L1532,300 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-34\" d=\"M1829,480 L1829,488 L1833,488 L1828.5,497 L1824,488 L1828,488 L1828,480 L1829,480 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-35\" d=\"M1653.5,292.5 L1644.5,288 L1653.5,283.5 L1653.5,287.5 L1674.56431,287.5 L1674.564,509.5 L1687,509.5 L1687,510.5 L1673.56431,510.5 L1673.564,288.5 L1653.5,288.5 L1653.5,292.5 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-36\" d=\"M1829,260 L1829,271 L1833,271 L1828.5,280 L1824,271 L1828,271 L1828,260 L1829,260 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n        </g>\n    </g>\n</svg>\n\n#### ActiveServices#bringUpServiceLocked\n\n```java\n// com.android.server.am.ActiveServices#bringUpServiceLocked\n// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java\nprivate String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg,\n            boolean whileRestarting, boolean permissionsReviewRequired)\n            throws TransactionTooLargeException {\n        // 已经存在进程记录，并且进程记录中的IApplicationThread已经存在，则不创建服务，仅发送参数\n        if (r.app != null && r.app.thread != null) {\n            sendServiceArgsLocked(r, execInFg, false);\n            return null;\n        }\n        final boolean isolated = (r.serviceInfo.flags&ServiceInfo.FLAG_ISOLATED_PROCESS) != 0;\n        final String procName = r.processName;\n        HostingRecord hostingRecord = new HostingRecord(\"service\", r.instanceName);\n        ProcessRecord app;\n\t\t// 非独立的进程，则直接获取当前启动进程的进程信息\n        if (!isolated) {\n            app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false);\n             if (app != null && app.thread != null) {\n                try {\n                    app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats);\n                    // 非独立进程中，直接启动服务\n                    realStartServiceLocked(r, app, execInFg);\n                    // 调用启动方法后直接返回\n                    return null;\n                } catch (TransactionTooLargeException e) {\n                    throw e;\n                } catch (RemoteException e) {\n                    Slog.w(TAG, \"Exception when starting service \" + r.shortInstanceName, e);\n                }\n\n                // If a dead object exception was thrown -- fall through to\n                // restart the application.\n            }\n        } else {\n            // 独立进程则先尝试使用之前保存的\n            app = r.isolatedProc;\n        }\n\n        // 之前没有启动对应的进程，则开始创建，启动了，则无需进行赋值操作，因为ServiceRecord中已经有了\n        if (app == null && !permissionsReviewRequired) {\n            if ((app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags,\n                    hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false)) == null) {\n                String msg = \"Unable to launch app \"\n                        + r.appInfo.packageName + \"/\"\n                        + r.appInfo.uid + \" for service \"\n                        + r.intent.getIntent() + \": process is bad\";\n                Slog.w(TAG, msg);\n                bringDownServiceLocked(r);\n                // 进程启动失败，返回错误消息\n                return msg;\n            }\n            if (isolated) {\n                // 独立进程，缓存进程信息到传入的ServiceRecord参数中，以便后续直接使用\n                r.isolatedProc = app;\n            }\n        }\n        // 将服务记录加入的mPendingServices中，由于非独立进程创建后已经直接返回，所以这里适用于独立进程的\n        if (!mPendingServices.contains(r)) {\n            mPendingServices.add(r);\n        }\n\t    // 创建成功或者之前已经又了缓存，则返回null\n        return null;\n    }\n```\n\n#### 独立进程何时启动服务？\n\n* 一般来说，封装较好的代码会保证入口统一，如果非独立进程情况下服务的启动使用的是 `realStartServiceLocked` 方法来启动服务，那么独立进程情况下，服务的启动也应该使用此方法，所以我们查看 `realStartServiceLocked` 方法的调用层次，如下：\n\n  **图片版本:**\n\n  ![image-20210411112439961](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411112440.png)\n\n  **详细调用序列:**\n\n  * `ActiveServices.attachApplicationLocked`(ProcessRecord, String)  (com.android.server.am)\n    * ActivityManagerService.attachApplicationLocked(IApplicationThread, int, int, long)  (com.android.server.am)\n      * ActivityManagerService.attachApplication(IApplicationThread, long)  (com.android.server.am)\n  * `ActiveServices.bringUpServiceLocked`(ServiceRecord, int, boolean, boolean, boolean)  (com.android.server.am)\n    * ActiveServices.startServiceInnerLocked(ServiceMap, Intent, ServiceRecord, boolean, boolean)  (com.android.server.am)\n    * ActiveServices.bindServiceLocked(IApplicationThread, IBinder, Intent, String, IServiceConnection, int, String, ...)  (com.android.server.am)\n    * ActiveServices.performServiceRestartLocked(ServiceRecord)  (com.android.server.am)\n\n  也就是调用了 `ActiveServices.attachApplicationLocked` ,最终是通过AMS的`ActivityManagerService.attachApplication`来触发的;也就是只要找到`mAm.startProcessLocked`到`ActivityManagerService.attachApplication`的调用序列即可证明此猜想;\n\n  我们可以找到如下调用序列，即最终实际上是从ActivityThread的main函数进入的，所以做出以下猜想：**进程启动后，创建ActivityThread时，如果有需要创建的服务，就启动服务；**\n\n  <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210411114715.png\" alt=\"image-20210411114715216\" style=\"zoom:50%;\" />\n\n  我们再看`attachApplicationLocked` 的逻辑，可以发现，会检查`mPendingServices`中是否有待启动的服务，然后逐一处理，如果有需要启动的服务，则会调用`realStartServiceLocked(sr, proc, sr.createdFromFg)`来启动服务。\n\n  ```java\n  // com.android.server.am.ActiveServices#attachApplicationLocked\n  // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java\n  boolean attachApplicationLocked(ProcessRecord proc, String processName)\n              throws RemoteException {\n          boolean didSomething = false;\n          // Collect any services that are waiting for this process to come up.\n          if (mPendingServices.size() > 0) {\n              ServiceRecord sr = null;\n              try {\n                  for (int i=0; i<mPendingServices.size(); i++) {\n                      sr = mPendingServices.get(i);\n                      // 排除非独立Service\n                      if (proc != sr.isolatedProc && (proc.uid != sr.appInfo.uid\n                              || !processName.equals(sr.processName))) {\n                          continue;\n                      }\n  \n                      mPendingServices.remove(i);\n                      i--;\n                      proc.addPackage(sr.appInfo.packageName, sr.appInfo.longVersionCode,\n                              mAm.mProcessStats);\n                      // 启动服务\n                      realStartServiceLocked(sr, proc, sr.createdFromFg);\n                  }\n              } catch (RemoteException e) {\n                  Slog.w(TAG, \"Exception in new application when starting service \"\n                          + sr.shortInstanceName, e);\n                  throw e;\n              }\n          }\n  }\n  ```\n\n#### ActivityThread#handleCreateService\n\n在下方的`android.app.ActivityThread#handleCreateService`方法中：\n\n1. 通过ClassLoader加载并实例化了对应的Service对象；\n2. 将Service存储到ActivityThread中的一个ArrayMap中；\n\n```java\n// android/app/ActivityThread.java\n// android.app.ActivityThread#handleCreateService\n\nfinal ArrayMap<IBinder, Service> mServices = new ArrayMap<>();\nprivate void handleCreateService(CreateServiceData data) {\n        // If we are getting ready to gc after going to the background, well\n        // we are back active so skip it.\n        unscheduleGcIdler();\n\n        LoadedApk packageInfo = getPackageInfoNoCheck(\n                data.info.applicationInfo, data.compatInfo);\n        Service service = null;\n        try {\n            if (localLOGV) Slog.v(TAG, \"Creating service \" + data.info.name);\n\n            ContextImpl context = ContextImpl.createAppContext(this, packageInfo);\n            Application app = packageInfo.makeApplication(false, mInstrumentation);\n            java.lang.ClassLoader cl = packageInfo.getClassLoader();\n            // 创建对应的Service实例\n            service = packageInfo.getAppFactory()\n                    .instantiateService(cl, data.info.name, data.intent);\n            // Service resources must be initialized with the same loaders as the application\n            // context.\n            context.getResources().addLoaders(\n                    app.getResources().getLoaders().toArray(new ResourcesLoader[0]));\n\n            context.setOuterContext(service);\n            service.attach(context, this, data.info.name, data.token, app,\n                    ActivityManager.getService());\n            service.onCreate();\n            mServices.put(data.token, service);\n            try {\n                ActivityManager.getService().serviceDoneExecuting(\n                        data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);\n            } catch (RemoteException e) {\n                throw e.rethrowFromSystemServer();\n            }\n        } catch (Exception e) {\n            if (!mInstrumentation.onException(service, e)) {\n                throw new RuntimeException(\n                    \"Unable to create service \" + data.info.name\n                    + \": \" + e.toString(), e);\n            }\n        }\n    }\n```\n\n\n\n### 绑定服务\n\n\n<svg width=\"232px\" height=\"344px\" viewBox=\"0 0 232 344\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"Android源码分析\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"bindService流程分析-加入启动流程\" transform=\"translate(-427.000000, -124.000000)\">\n            <g id=\"架构图/模块-源码备份-4\" transform=\"translate(428.000000, 124.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.835383\" y=\"11\">ActivityManagerService.bindIsolatedService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"33.7957176\" y=\"23.3877551\">com/android/server/am/ActivityManagerService.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-5\" transform=\"translate(428.000000, 162.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"34.6552993\" y=\"11\">ActiveServices.bindServiceLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-16\" transform=\"translate(428.000000, 239.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"19.1486884\" y=\"11\">IApplicationThread.scheduleBindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"57.7019938\" y=\"23.3877551\">android/app/IApplicationThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-17\" transform=\"translate(428.000000, 285.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFED99\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"78.9632491\" y=\"11\">Binder.transact</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"104.925425\" y=\"23.3877551\">binder</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-10\" transform=\"translate(427.000000, 327.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"20.74668\" y=\"11\">ApplicationThread.scheduleBindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"21.4409058\" y=\"23.3877551\">frameworks/base/core/java/android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-12\" transform=\"translate(427.000000, 366.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"33.2260106\" y=\"11\">ActivityThread#handleBindService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"21.4409058\" y=\"23.3877551\">frameworks/base/core/java/android/app/ActivityThread.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-19\" transform=\"translate(427.000000, 404.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"48.4748809\" y=\"11\">IBinder = Service.onBinder()</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"80.1254248\" y=\"23.3877551\">自定义的Service实现类</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-20\" transform=\"translate(427.000000, 442.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#FFBBA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"37.3498599\" y=\"11\">IActivityManager#publishService</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"61.7354666\" y=\"23.3877551\">android/app/IActivityManager.java</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/模块-源码备份-8\" transform=\"translate(428.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#979797\" fill=\"#D5FFA2\" x=\"0.5\" y=\"0.5\" width=\"229.075117\" height=\"25\" rx=\"5.35564854\"></rect>\n                <text id=\"方法过程\" font-family=\"NotoSansCJKsc-Bold, Noto Sans CJK SC\" font-size=\"9.37238494\" font-weight=\"bold\" letter-spacing=\"0.103096234\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"9.12492271\" y=\"11\">ActiveServices.requestServiceBindingLocked</tspan>\n                </text>\n                <text id=\"代码地址\" font-family=\"NotoSansCJKsc-Light, Noto Sans CJK SC\" font-size=\"6.69456067\" font-weight=\"300\" letter-spacing=\"0.073640172\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"47.5865126\" y=\"23.3877551\">com/android/server/am/ActiveServices.java</tspan>\n                </text>\n            </g>\n            <path id=\"直线-5\" d=\"M542.834728,150.007377 L542.834,156.046 L546.17364,156.046784 L542.5,163.046784 L538.82636,156.046784 L542.165,156.046 L542.165272,150.007377 L542.834728,150.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-6\" d=\"M542.834728,188.007377 L542.834,194.046 L546.17364,194.046784 L542.5,201.046784 L538.82636,194.046784 L542.165,194.046 L542.165272,188.007377 L542.834728,188.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-7\" d=\"M542.834728,226.007377 L542.834,232.046 L546.17364,232.046784 L542.5,239.046784 L538.82636,232.046784 L542.165,232.046 L542.165272,226.007377 L542.834728,226.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-8\" d=\"M542.834728,263.998605 L542.834,277.055 L546.17364,277.055556 L542.5,284.055556 L538.82636,277.055556 L542.165,277.055 L542.165272,263.998605 L542.834728,263.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-9\" d=\"M542.834728,309.998605 L542.834,321.055 L546.17364,321.055556 L542.5,328.055556 L538.82636,321.055556 L542.165,321.055 L542.165272,309.998605 L542.834728,309.998605 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-10\" d=\"M542.834728,353.007377 L542.834,359.046 L546.17364,359.046784 L542.5,366.046784 L538.82636,359.046784 L542.165,359.046 L542.165272,353.007377 L542.834728,353.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-18\" d=\"M542.834728,392.007377 L542.834,398.046 L546.17364,398.046784 L542.5,405.046784 L538.82636,398.046784 L542.165,398.046 L542.165272,392.007377 L542.834728,392.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n            <path id=\"直线-11\" d=\"M542.834728,430.007377 L542.834,436.046 L546.17364,436.046784 L542.5,443.046784 L538.82636,436.046784 L542.165,436.046 L542.165272,430.007377 L542.834728,430.007377 Z\" fill=\"#979797\" fill-rule=\"nonzero\"></path>\n        </g>\n    </g>\n</svg>\n\n\n\n\n## 详细流程分析\n\n### ContextImpl.`bindService`\n\n* `bindService` : (`frameworks/base/core/java/android/app/ContextImpl.java`)\n\n  ```java\n      @Override\n      public boolean bindService(Intent service, ServiceConnection conn, int flags) {\n          warnIfCallingFromSystemProcess();\n          return bindServiceCommon(service, conn, flags, null, mMainThread.getHandler(), null,\n                  getUser());\n      }\n  \n      @Override\n      public boolean bindService(\n              Intent service, int flags, Executor executor, ServiceConnection conn) {\n          warnIfCallingFromSystemProcess();\n          return bindServiceCommon(service, conn, flags, null, null, executor, getUser());\n      }\n  \n  ```\n\n### ContextImpl.bindServiceCommon\n\n* `bindServiceCommon`:  (`frameworks/base/core/java/android/app/ContextImpl.java`)\n\n  ```java\n  private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags,\n              String instanceName, Handler handler, Executor executor, UserHandle user) {\n          // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.\n          IServiceConnection sd;\n          if (conn == null) {\n              throw new IllegalArgumentException(\"connection is null\");\n          }\n          if (handler != null && executor != null) {\n              throw new IllegalArgumentException(\"Handler and Executor both supplied\");\n          }\n          if (mPackageInfo != null) {\n              if (executor != null) {\n                  sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags);\n              } else {\n                  sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);\n              }\n          } else {\n              throw new RuntimeException(\"Not supported in system context\");\n          }\n          validateServiceIntent(service);\n          try {\n              // WindowContext构造函数中的 WindowTokenClient\n              IBinder token = getActivityToken();\n              if (token == null && (flags&BIND_AUTO_CREATE) == 0 && mPackageInfo != null\n                      && mPackageInfo.getApplicationInfo().targetSdkVersion\n                      < android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) {\n                  flags |= BIND_WAIVE_PRIORITY;\n              }\n              service.prepareToLeaveProcess(this);\n              int res = ActivityManager.getService().bindIsolatedService(\n                  mMainThread.getApplicationThread(), getActivityToken(), service,\n                  service.resolveTypeIfNeeded(getContentResolver()),\n                  sd, flags, instanceName, getOpPackageName(), user.getIdentifier());\n              if (res < 0) {\n                  throw new SecurityException(\n                          \"Not allowed to bind to service \" + service);\n              }\n              return res != 0;\n          } catch (RemoteException e) {\n              throw e.rethrowFromSystemServer();\n          }\n      }\n  ```\n\n### ActivityManagerService.bindIsolatedService\n\n从这里开始，实际上位于AMS的Server端了，即我们的Activity所在的进程发送了一个启动服务的IPC请求给AMS（sysmte_server进程中）。\n\n* ActivityManagerService.java : (frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java)\n\n  ```java\n  public int bindIsolatedService(IApplicationThread caller, IBinder token, Intent service,\n              String resolvedType, IServiceConnection connection, int flags, String instanceName,\n              String callingPackage, int userId) throws TransactionTooLargeException {\n  \t\t// .... \n          synchronized(this) {\n              // 调用Binder接口\n              return mServices.bindServiceLocked(caller, token, service,\n                      resolvedType, connection, flags, instanceName, callingPackage, userId);\n          }\n      }\n  ```\n\n![image-20210409144356311](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210409144356.png)\n\n### ActiveServices.bindServiceLocked\n\n*  `ActiveServices.bindServiceLocked`: (`frameworks/base/services/core/java/com/android/server/am/ActiveServices.java`)\n\n  * 这个方法有点长，我们截取重要部分\n\n  ```java\n  int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service,\n              String resolvedType, final IServiceConnection connection, int flags,\n              String instanceName, String callingPackage, final int userId)\n              throws TransactionTooLargeException {\n      // 获取调用方的权限\n          final int callingPid = Binder.getCallingPid();\n          final int callingUid = Binder.getCallingUid();\n          final ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);\n          if (callerApp == null) {\n              throw new SecurityException(\n                      \"Unable to find app for caller \" + caller\n                      + \" (pid=\" + callingPid\n                      + \") when binding service \" + service);\n          }\n  \n          ActivityServiceConnectionsHolder<ConnectionRecord> activity = null;\n          if (token != null) {\n              activity = mAm.mAtmInternal.getServiceConnectionsHolder(token);\n              if (activity == null) {\n                  Slog.w(TAG, \"Binding with unknown activity: \" + token);\n                  return 0;\n              }\n          }\n  \n          int clientLabel = 0;\n          PendingIntent clientIntent = null;\n          final boolean isCallerSystem = callerApp.info.uid == Process.SYSTEM_UID;\n         \n  \n          final boolean callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;\n          final boolean isBindExternal = (flags & Context.BIND_EXTERNAL_SERVICE) != 0;\n          final boolean allowInstant = (flags & Context.BIND_ALLOW_INSTANT) != 0;\n  \n          ServiceLookupResult res =\n              retrieveServiceLocked(service, instanceName, resolvedType, callingPackage,\n                      callingPid, callingUid, userId, true,\n                      callerFg, isBindExternal, allowInstant);\n          if (res == null) {\n              return 0;\n          }\n          if (res.record == null) {\n              return -1;\n          }\n          ServiceRecord s = res.record;\n  \n          try {\n              if (unscheduleServiceRestartLocked(s, callerApp.info.uid, false)) {\n                  if (DEBUG_SERVICE) Slog.v(TAG_SERVICE, \"BIND SERVICE WHILE RESTART PENDING: \"\n                          + s);\n              }\n  \n              if ((flags&Context.BIND_AUTO_CREATE) != 0) {\n                  s.lastActivity = SystemClock.uptimeMillis();\n                  if (!s.hasAutoCreateConnections()) {\n                      // This is the first binding, let the tracker know.\n                      ServiceState stracker = s.getTracker();\n                      if (stracker != null) {\n                          stracker.setBound(true, mAm.mProcessStats.getMemFactorLocked(),\n                                  s.lastActivity);\n                      }\n                  }\n              }\n  \n              if ((flags & Context.BIND_RESTRICT_ASSOCIATIONS) != 0) {\n                  mAm.requireAllowedAssociationsLocked(s.appInfo.packageName);\n              }\n  \n              mAm.startAssociationLocked(callerApp.uid, callerApp.processName,\n                      callerApp.getCurProcState(), s.appInfo.uid, s.appInfo.longVersionCode,\n                      s.instanceName, s.processName);\n              // Once the apps have become associated, if one of them is caller is ephemeral\n              // the target app should now be able to see the calling app\n              mAm.grantImplicitAccess(callerApp.userId, service,\n                      callerApp.uid, UserHandle.getAppId(s.appInfo.uid));\n  \n              AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);\n              ConnectionRecord c = new ConnectionRecord(b, activity,\n                      connection, flags, clientLabel, clientIntent,\n                      callerApp.uid, callerApp.processName, callingPackage);\n  \n              IBinder binder = connection.asBinder();\n              s.addConnection(binder, c);\n              b.connections.add(c);\n              if (activity != null) {\n                  activity.addConnection(c);\n              }\n              b.client.connections.add(c);\n              if (s.app != null) {\n                  updateServiceClientActivitiesLocked(s.app, c, true);\n              }\n              ArrayList<ConnectionRecord> clist = mServiceConnections.get(binder);\n              if (clist == null) {\n                  clist = new ArrayList<>();\n                  mServiceConnections.put(binder, clist);\n              }\n              clist.add(c);\n  \n              if ((flags&Context.BIND_AUTO_CREATE) != 0) {\n                  s.lastActivity = SystemClock.uptimeMillis();\n                  if (bringUpServiceLocked(s, service.getFlags(), callerFg, false,\n                          permissionsReviewRequired) != null) {\n                      return 0;\n                  }\n              }\n  \n              if (s.app != null && b.intent.received) {\n                  // Service is already running, so we can immediately\n                  // publish the connection.\n                  try {\n                      c.conn.connected(s.name, b.intent.binder, false);\n                  } catch (Exception e) {\n                      Slog.w(TAG, \"Failure sending service \" + s.shortInstanceName\n                              + \" to connection \" + c.conn.asBinder()\n                              + \" (in \" + c.binding.client.processName + \")\", e);\n                  }\n              } else if (!b.intent.requested) {\n                  requestServiceBindingLocked(s, b.intent, callerFg, false);\n              }\n          } finally {\n          }\n          return 1;\n      }\n  ```\n  \n  ### ActiveServices.realStartServiceLocked\n```java\n /**\n     * Note the name of this method should not be confused with the started services concept.\n     * The \"start\" here means bring up the instance in the client, and this method is called\n     * from bindService() as well.\n     */\n    private final void realStartServiceLocked(ServiceRecord r,\n            ProcessRecord app, boolean execInFg) throws RemoteException {\n        if (app.thread == null) {\n            throw new RemoteException();\n        }\n        r.setProcess(app);\n        r.restartTime = r.lastActivity = SystemClock.uptimeMillis();\n\t\t// 创建服务\n        final boolean newService = app.startService(r);\n        bumpServiceExecutingLocked(r, execInFg, \"create\");\n        mAm.updateLruProcessLocked(app, false, null);\n        updateServiceForegroundLocked(r.app, /* oomAdj= */ false);\n        mAm.updateOomAdjLocked(app, OomAdjuster.OOM_ADJ_REASON_START_SERVICE);\n\n        boolean created = false;\n        try {\n            app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);\n            // 创建服务\n            app.thread.scheduleCreateService(r, r.serviceInfo,\n                    mAm.compatibilityInfoForPackage(r.serviceInfo.applicationInfo),\n                    app.getReportedProcState());\n            r.postNotification();\n            created = true;\n        } catch (DeadObjectException e) {\n            Slog.w(TAG, \"Application dead when creating service \" + r);\n            mAm.appDiedLocked(app, \"Died when creating service\");\n            throw e;\n        } finally {\n            // \n        }\n\n        // 绑定服务\n        requestServiceBindingsLocked(r, execInFg);\n\n        updateServiceClientActivitiesLocked(app, null, true);\n\n        if (newService && created) {\n            app.addBoundClientUidsOfNewService(r);\n        }\n\n        // If the service is in the started state, and there are no\n        // pending arguments, then fake up one so its onStartCommand() will\n        // be called.\n        if (r.startRequested && r.callStart && r.pendingStarts.size() == 0) {\n            r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(),\n                    null, null, 0));\n        }\n        sendServiceArgsLocked(r, execInFg, true);\n    }\n```\n\n\n\n### ActivityManagerService.attachApplicationLocked\n\n```java\n    @GuardedBy(\"this\")\n    private boolean attachApplicationLocked(@NonNull IApplicationThread thread,\n            int pid, int callingUid, long startSeq) {\n     \t   \n        \n    }\n```\n\n### ApplicationThread.handleCreateService\n\n`frameworks/base/core/java/android/app/ActivityThread.java`\n\n```java\n @UnsupportedAppUsage\n    private void handleCreateService(CreateServiceData data) {\n        // If we are getting ready to gc after going to the background, well\n        // we are back active so skip it.\n        unscheduleGcIdler();\n\n        LoadedApk packageInfo = getPackageInfoNoCheck(\n                data.info.applicationInfo, data.compatInfo);\n        Service service = null;\n        try {\n            if (localLOGV) Slog.v(TAG, \"Creating service \" + data.info.name);\n\t\t\t// 创建上下文对象\n            ContextImpl context = ContextImpl.createAppContext(this, packageInfo);\n            // 创建Application\n            Application app = packageInfo.makeApplication(false, mInstrumentation);\n            // 获取对应的类加载器\n            java.lang.ClassLoader cl = packageInfo.getClassLoader();\n            // 创建Service实例\n            service = packageInfo.getAppFactory()\n                    .instantiateService(cl, data.info.name, data.intent);\n            // Service resources must be initialized with the same loaders as the application\n            // context.\n            context.getResources().addLoaders(\n                    app.getResources().getLoaders().toArray(new ResourcesLoader[0]));\n\n            context.setOuterContext(service);\n            service.attach(context, this, data.info.name, data.token, app,\n                    ActivityManager.getService());\n            // 调用onCreate回调\n            service.onCreate();\n            mServices.put(data.token, service);\n            try {\n                ActivityManager.getService().serviceDoneExecuting(\n                        data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0);\n            } catch (RemoteException e) {\n                throw e.rethrowFromSystemServer();\n            }\n        } catch (Exception e) {\n            if (!mInstrumentation.onException(service, e)) {\n                throw new RuntimeException(\n                    \"Unable to create service \" + data.info.name\n                    + \": \" + e.toString(), e);\n            }\n        }\n    }\n```\n",
      "data": {
        "title": "[Android]bindService流程分析",
        "date": "2021-04-10 20:23:53",
        "tags": [],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "\n\n\n本文分析bindService的流程，首先我们通过阅读源码获取一个主线的调用地图，然后提出若干问题，包括：APP进程中如何获取AMS，AMS如何启动APP-service的进程，AMS中如何获取ApplicationThread并与之通讯，Service的启动及绑定流程；然后再通过源码一一解答。最后再整体总结梳理一下整体流程；",
      "fileName": "androidbindservice-liu-cheng-fen-xi"
    },
    {
      "content": "# Gitlab&持续集成&效率工具\n\n```mermaid\ngraph \nGitlab[Gitlab&持续集成&效率工具]\nGitlab --> 服务维护\nGitlab --> Gitlab&Sonar使用问题解答与解决\nGitlab --> CI[基于Gitlab CI的自动化流程]\n```\n\n## 服务维护\n\n目前有3个服务器需要维护，上面有部署若干服务：\n\n```mermaid\ngraph \n205[172.17.0.205]\n206[172.17.0.206]\n208[172.17.0.208]\n\n205 --> gitlab\n206 --> sonarqube\n206 --> mattermost\n208 --> yapi\n208 --> confluence\n208 --> gitlab-runner\n208 --> 移动中心H5站点\n```\n\n服务的连接方式及部署的服务可以参考文档： [《Gitlab-SonarQube服务信息汇总》](https://shimo.im/docs/REkKVZppmPcjFQqx/)， 该文档记录了服务器的ssh远程的方式，各服务的部署启动方式，部署的目录；\n\n以下简要说明各个服务的维护方式及可能遇到的问题。\n\n### gitlab（205）\n\n* 部署目录： `/data/gitlab/`\n\nteambition的thoughts上记录了部分使用过程中可能遇到的问题，可以访问[tb的此文档目录](https://thoughts.teambition.com/workspaces/5e8da16aaf7af5001a4c7222/folders/5ee970c5b7ad5400012b51ac) 进行查阅；\n\n这里我们重点强调下gitlab的重启可能遇到的问题，**使用过程中发现，在gitlab重启时，如果有gitlab-runner不停的向gitlab服务器发送请求，则有可能导致gitlab无法启动，故我们采取gitlab启动过程中不连接网络，启动完成后再连接网络的方式启动gitlab**详细可参考[tb上的此文章](https://thoughts.teambition.com/workspaces/5e8da16aaf7af5001a4c7222/docs/5f4c5eaf77f66f00010659ae)。\n\n\n\n### sonarqube （206）\n\n* 部署目录：`/data/_data/sonarqube`\n\n一般只需要启动及重启，可参考   [《Gitlab-SonarQube服务信息汇总》](https://shimo.im/docs/REkKVZppmPcjFQqx/) 的相关小节，主要命令如下：\n\n```shell\n# 部署    \ndocker stack deploy -c docker-compose.yml sonarqube\n\n# 停止 \ndocker stack down sonarqube\n\n# 重新启动\ndocker stack up sonarqube -c docker-compose.yml\n```\n\n### yapi（208）\n\n* 部署目录： `/data/yapi-docker-deploy` \n\n```shell\n# 启动命令\ndocker stack deploy -c docker-compose.yml yapi\n# 其他维护命令基于yapi的stack执行即可\n```\n\n### mattermost相关（206）\n\nmattermost相关请联系段春先\n\n\n\n### gitlab-runner（208）\n\n208上的gitlab-runner作为部门的公用runner，执行各种通用任务。\n\n\n\n我们在208上注册启动了两个runner，一个使用docker方式运行，一个使用二进制方式直接运行在主机上，使用的时候需要注意区分；\n\n#### docker方式运行的runner\n\n* 使用docker方式运行的runner使用geostar用户运行，用于执行通用任务，使用docker作为执行器。\n* 相关维护操作直接对容器进行即可：\n  * 重启：`docker restart gitlab-runner`\n  * 扩展了命令别名，默认情况下，使用geostar用户在主机上直接执行 gitlab-runner命令时，实际上时执行 `docker exec -it gitlab-runner [命令]` \n  * 执行命令：`docker exec -it gitlab-runner bash`\n\n#### 二进制运行的runner\n\n* 使用二进制运行的runner使用root用户运行，使用shell作为执行器，用于执行需要直接操作主机的命令，如打包docker镜像。\n* 相关维护操作需要使用root用户完成（通过 /usr/bin/gitlab-runner 命令）\n  * 如，查看状态：`sudo /usr/bin/gitlab-runner status`\n\n## Gitlab&Sonar使用问题解答与解决\n\nsonarqube的启动重启请参考 [《Gitlab-SonarQube服务信息汇总》](https://shimo.im/docs/REkKVZppmPcjFQqx/) 中的sonar的部署方式。\n\n## 基于Gitlab CI的自动化流程相关\n\n这里下面另外启动一个章节说明\n\n\n\n# Gitlab相关-Gitlab安装及配置\n\n## 安装\n\n我们使用docker来安装Gitlab，执行如下命令即可安装运行，完成后使用\n\n```shell\nexport GITLAB_DATA=/data/gitlab\n# 设置主机的ip域名\nexport HOST_IP=192.168.43.62\nmkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data\ndocker run --detach \\\n        --hostname $HOST_IP \\\n        --publish 443:443 --publish 80:80 --publish 22:22 \\\n        --name gitlab \\\n        --restart always \\\n        --volume $GITLAB_DATA/config:/etc/gitlab \\\n        --volume $GITLAB_DATA/logs:/var/log/gitlab \\\n        --volume $GITLAB_DATA/data:/var/opt/gitlab \\\n        gitlab/gitlab-ce:13.9.1-ce.0\n```\n\n> * 数据全部挂载在外部目录 GITLAB_DATA 中\n> * `--hostname 192.168.43.62` : 指定当前服务的IP或者域名，后续将会显示为gitlab代码仓库的克隆地址\n> * `--restart always` : 设置服务自动重启\n\n> 查看gitlab的可用版本： \n>\n> * [dockerhub/gitlab-ce](dockerhub/gitlab-ce)\n> * [gitlab release page](https://about.gitlab.com/releases/categories/releases/)\n\n### **查看启动状态**\n\n启动期间可以使用 `docker ps` 查看状态，如STATUS中显示为`starting`则表示服务还在启动中，如显示为`healthy`则表示服务已正常启动，即可访问 http://192.168.43.62 访问Gitlab的web地址。\n\n```shell\nCONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS                 PORTS                                                          NAMES\n79b432f0f601        gitlab/gitlab-ce:13.0.6-ce.0   \"/assets/wrapper\"   2 months ago        Up 2 weeks (healthy)   0.0.0.0:22->22/tcp, 0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp   gitlab\n```\n\n也可使用 `docker logs -f gitlab` 来查看gitlab的服务启动日志\n\n### 设置root管理员用户密码\n\n首次打开页面后会提示设置root用户的密码，设置后务必记录好用户密码，后续将使用此用户对Gitlab进行管理\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302163607.png\" alt=\"image-20210302163607120\" style=\"zoom:50%;\" />\n\n## 配置LDAP\n\n服务启动正常后，`$GITLAB_DATA/config` 文件夹中即生成了gitlab的配置文件，可编辑`$GITLAB_DATA/config/gitlab.rb` （对应容器内部 `/etc/gitlab/gitlab.rb` ）文件来修改gitlab配置以使用LDAP\n\n```shell\nvim /etc/gitlab/gitlab.rb\n```\n\n通过`?` 搜索`LDAP`，找到如下配置端，按如下方式进行修改：\n\n```ruby\n### LDAP Settings\n###! Docs: https://docs.gitlab.com/omnibus/settings/ldap.html\n###! **Be careful not to break the indentation in the ldap_servers block. It is\n###!   in yaml format and the spaces must be retained. Using tabs will not work.**\n\ngitlab_rails['ldap_enabled'] = true\n\ngitlab_rails['ldap_servers'] = YAML.load <<-'EOS'\n   main:\n     label: '域账号'\n     host: '172.17.0.3'\n     port: 389\n     uid: 'sAMAccountName'\n     bind_dn: 'CN=智慧城市Mattermost系统,OU=邮箱用户,DC=geostar,DC=com,DC=cn'\n     password: '3uQ5V2LDgG'\n     encryption: 'plain' # \"start_tls\" or \"simple_tls\" or \"plain\"\n     verify_certificates: false\n     smartcard_auth: false\n     active_directory: true\n     allow_username_or_email_login: false # 是否允许以用户名登录（邮箱也会取用户名来严重）\n     lowercase_usernames: false\n     block_auto_created_users: false\n     base: 'OU=武大吉奥-域用户,DC=geostar,DC=com,DC=cn'\n     user_filter: ''\nEOS\n```\n\n> 配置修改说明：\n>\n> * `ldap_enabled` 需要设置为true\n> * `ldap_servers` 配置AD域相关信息\n>   * label： 随便取，会显示在gitlab的登录页面\n>   * host： 域控制服务器主机地址\n>   * port： 域控制器服务端口\n>   * uid：  将域用户信息中的哪个字段作为gitlab上的登录标识（一般都是sAMAccountName）\n>   * bind_dn： 用于访问域控制服务器的用户账号，用户账号的格式需要使用`CN=xxx,OU=XXX,DC=XXXX` 类似的格式\n>   * password： 对应的base_dn账号的密码\n>   * base： 用于登录时，会去base所定义的组里面去检索用户是否存在，如用户在这个范围内，才可以登录；如及用于公司一个部门的登录，可将base值配置到部门级别，则其他部分无法以域账号进行登录；\n>\n> 提示： 如无法确认 uid，bind_dn，base 等的值，可以咨询信息中心或者使用AD域访问查看软件（如：[Apache Directory](http://directory.apache.org/)）连接到域账号控制器服务后，通过图形界面查看对应信息；\n\n修改完毕后需要保存文件后重启gitlab服务，对于docker启动的gitlab来说，可执行如下命令重启服务：\n\n```shell\n# 其中gitlab为我们使用docker run 命令时通过--name选项指定的容器名称\ndocker restart gitlab \n```\n\n待gitlab重启完毕后，登录界面即出现域账号登录的tab入口，点击域账号tab即可使用域账号进行登录\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302161215.png\" alt=\"image-20210302161215567\" style=\"zoom:50%;\" />\n\n## 配置邮箱通知\n\n公司邮箱服务器配置：\n\n我们使用向信息中心申请的公共的mattermost邮箱账号。\n\n```ruby\ngitlab_rails['smtp_enable'] = true\ngitlab_rails['smtp_address'] = \"mail.geostar.com.cn\"\ngitlab_rails['smtp_port'] = 25\ngitlab_rails['smtp_user_name'] = \"zh-mattermost@geostar.com.cn\"\ngitlab_rails['smtp_password'] = \"3uQ5V2LDgG\"\ngitlab_rails['smtp_domain'] = \"geostar.com.cn\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true\ngitlab_rails['smtp_tls'] = false\n```\n\n163邮箱配置示例：（需在163邮箱中开启SMTP服务，可参考： [CSDN-如何使用163的SMTP服务发邮件？](https://blog.csdn.net/liuyuinsdu/article/details/113878840)）\n\n```ruby\ngitlab_rails['smtp_enable'] = true\ngitlab_rails['smtp_address'] = \"smtp.163.com\"\ngitlab_rails['smtp_port'] = 25\ngitlab_rails['smtp_user_name'] = \"colorless@163.com\"\ngitlab_rails['smtp_password'] = \"密码\"\ngitlab_rails['smtp_domain'] = \"163.com\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true\ngitlab_rails['smtp_tls'] = false\n```\n\n\n\n## 关闭及管理员配置\n\n### 赋予指定域账号管理员权限\n\n在配置了域账号登录之后，先让需要设置为管理员的账号使用域账号登录一次gitlab，登录后gitlab即会为该用户创建关联的gitlab账号。\n\n然后使用root用户登录，进入\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164307.png\" alt=\"image-20210302164306980\" style=\"zoom:50%;\" />\n\n将用户的访问类型切换为管理员：\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164354.png\" alt=\"image-20210302164354791\" style=\"zoom:50%;\" />\n\n### 关闭用户注册\n\n在配置了域账号登录之后，可以关闭用户注册，即只允许拥有域账号的人员进行登录；\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164139.png\" alt=\"image-20210302164139380\" style=\"zoom:67%;\" />\n\n\n\n# Gitlab相关-安装并注册Gitlab-Runner \n\n## 安装Gitlab-Runner\n\ngitlab-runner可以使用docker方式运行，也可以在主机上运行其二进制可执行文件，可按如下方式进行选择：\n\n* 执行通用的构建测试任务及与不需要直接访问主机目录的，以docker方式安装；\n* 执行部署类任务或需要直接访问主机目录的，以二进制方式安装；\n\n以下分别介绍上述两种安装方式。\n\n\n\n### 使用docker安装gitlab-runner\n\n使用docker方式安装的，需先在主机上安装docker环境，可参考 Docker 官方安装文档。以下操作假设主机上已正确安装并配置了docker运行环境；\n\n>提示：可以使用基于alpine的镜像来减小大小\n\n```shell\n# 建立配置挂载目录\nmkdir -p /data/gitlab-runner/config\n# 建立构建目录挂载目录\nmkdir -p /data/gitlab-runner/home\n# 注意，这里我们使用了基于alpine的镜像来减小大小；使用 --restart 标识来自动重启\ndocker run -d --name gitlab-runner --restart always \\\n  -v /data/gitlab-runner/config:/etc/gitlab-runner \\\n  -v /data/gitlab-runner/home:/home/gitlab-runner \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  gitlab/gitlab-runner:alpine\n  \n# 通过以下命令设置docker开机自启\nsudo systemctl enable docker\n```\n\n### docker安装的gitlab-runner常用操作\n\n#### 运行命令\n\n使用已有容器\n\n```shell\n# 容器已经运行的情况下\n# 1. 交互式执行，执行以下命令，然后输入命令\ndocker exec -it gitlab-runner /bin/bash\n# 然后执行命令\ngitlab-runer --help\n# 2. 单次执行\ndocker exec gitlab-runner gitlab-runner --help\n```\n\n使用临时的：\n\n```shell\ndocker run --rm -t -i gitlab/gitlab-runner:alpine --help\n# -it 使用交互式终端\n# --rm 自动删除\n```\n\n#### 重启gitlab-runner\n\n```\ndocker restart gitlab-runner\n```\n\n#### 升级版本\n\n```shell\n# 获取最新\ndocker pull gitlab/gitlab-runner:alpine\ndocker stop gitlab-runner && docker rm gitlab-runner\ndocker run -d --name gitlab-runner --restart always \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  -v /data/gitlab-runner/config:/etc/gitlab-runner \\\n  -v /data/gitlab-runner/home:/home/gitlab-runner \\\n  gitlab/gitlab-runner:alpine\n```\n\n#### 查看日志\n\n```shell\ndocker logs gitlab-runner\n```\n\n#### 配置 gitlab-runner 别名\n\n在 `~/.bash_profile` 或 `~/.bashrc` 文件中加入如下函数配置，后续运行 gitlab-runner 命令时即可省去docker exec 命令\n\n```shell\n# 添加 gitlab-runner 直接执行到容器\nfunction gitlab-runner(){\n    docker exec -it gitlab-runner gitlab-runner $@\n}\n```\n\n\n\n### 使用二进制包安装运行gitlab-runner\n\n#### 获取安装包安装并运行\n\n* Centos or RedHat 使用如下命令安装：\n\n  ```shell\n  ARCH=$(arch)\n  \n  curl -LJO \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner$ARCH.rpm\"\n  \n  rpm -i gitlab-runner_$ARCH.rpm\n  ```\n\n* Debian or Ubuntu 使用如下命令安装\n\n  ```shell\n  ARCH=$(arch)\n  \n  curl -LJO \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_$ARCH.deb\"\n  \n  dpkg -i gitlab-runner_$ARCH.deb\n  ```\n\n* Windows 安装\n\n  请参考官方文档： https://docs.gitlab.com/runner/install/windows.html#installation\n\n* 测试是否安装成功，如能成功输出gitlab-runner的用法信息，则表示安装成功\n\n  ```\n  gitlab-runner --help\n  ```\n\n* 测试是否成功启动\n\n  ```\n  gitlab-runner status\n  # 如输出 Service is running，则表示成功启动了\n  ```\n\n  > 通过docker方式运行的runner在运行 `gitlab-runner status`时会输出 `not running`，这对于docker方式运行的runner是正常的，只有直接运行于主机上的runner需要启动对应的服务；\n\n#### 安装并更新Git版本\n\nGitlab-CI 任务在 runner 机器上执行，会先通过git获取对应仓库的最新代码，这个获取代码的操作是通过git来完成的，所以我们需要安装git工具；\n\n* **安装Git**\n\n  ```shell\n  sudo yum install -y git\n   # 查看版本\n  git --version\n  # centos7 上为 1.8.x，无法满足gitlab要求\n  ```\n\n* **升级Git版本**\n\n  某些linux发型版上git版本过低，在执行流水线时会失败，需要升级git版本，可按如下方式从源码安装最新git版本；\n\n  * 下载git v2.27.0源码\n\n    ```shell\n    ## 以下下载方式任选其一\n    # 可选下载方式1 - 从gitee 克隆\n    git clone -b v2.27.0 https://gitee.com/hanlyjiang/git.git git-2.27.0\n    cd git-2.27.0 && git checkout -b tag-v2.27.0 v2.27.0\n    \n    # 可选下载方式2 - 从github直接下载包\n    curl -LJO https://github.com/git/git/archive/v2.27.0.tar.gz\n    tar -xvf git-2.27.0.tar.gz \n    cd git-2.27.0\n    ```\n\n  * 编译安装\n\n    ```shell\n    # 安装编译依赖库\n    sudo yum install  -y autoconf gcc openssh zlib-devel\n    \n    # 编译并安装\n    make configure ;# as yourself\n    ./configure --prefix=/usr ;# as yourself\n    make -j8 all ;# as yourself\n    sudo make install ;# as root\n    \n    # 确认版本：\n    git --version\n    # git version 2.27.0\n    ```\n\n#### 将gitlab-runner用户添加到docker用户组（可选）\n\n如需要在该gitlab-runner的CI脚本中运行docker命令，这需要将 gitlab-runner用户添加到docker的用户组，可执行如下命令：\n\n```shell\nsudo usermod -a -G docker gitlab-runner\n\n# 验证权限\nsudo -u gitlab-runner -H docker info\n```\n\n#### 修改 gitlab-runner 构建目录\n\n如在执行ci任务时，拉取代码时报build目录权限问题，可尝试按如下方式修改指定runner的构建目录\n\n1. 查找配置文件路径\n\n   ``` shell\n   gitlab-runner list \n   # 其中ConfigFile的值就是对应的配置文件，如：\n   # ConfigFile=/etc/gitlab-runner/config.toml\n   ```\n\n2. 修改 `builds_dir` 指向\n\n   找对该任务对应的`[[runner]]` 配置段，并在该配置中添加 `builds_dir` 指向新的具有权限的目录，然后重启启动gitlab-runner即可；\n\n   ```yaml\n   [[runners]]\n     name = \"blockdataapi-engine\"\n     url = \"http://172.17.0.205/\"\n     token = \"Y-6zdV9zzi8xsY1rygbn\"\n     executor = \"shell\"\n     builds_dir = \"/data/gitlab-runner/builds\"\n     [runners.custom_build_dir]\n     [runners.cache]\n       [runners.cache.s3]\n       [runners.cache.gcs]\n   ```\n\n\n\n## 注册 Runner 到 Gitlab\n\n这里我们将runner注册为群组的Runner，群组runner可以在群组中共享，所有子群组和项目都可以使用该Runner。也可以将Runner注册到指定项目仓库上，操作上只有获取gitlab-runner注册信息时不一样；\n\n### 获取gitlab-runner注册信息\n\n> 如需注册到具体项目，在项目的设置在进入对应的CI/CD设置即可，后续操作流程一致；\n\n在群组的设置中打开 CI/CD 设置\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180602.png!thumbnail)\n\n展开 Runner 栏位\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180606.png!thumbnail)\n\n这里我们选择通过手动设置group runner的方式来注册，可以获取到以下信息：\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180610.png!thumbnail)\n\n### 注册runner\n\n以docker方式运行的gitlab-runner可按如下方式进入交互环境，**直接二进制运行的无需此操作**；\n\n在gitlab-runner 的机器上执行注册命令，将runner注册到gitlab，为了方便操作，我们使用以下命令进入gitlab-runner容器shell环境：\n\n```shell\ndocker exec -it gitlab-runner /bin/bash\n```\n\n执行完成后出现如下交互窗口\n\n```shell\nbash-4.4#\n```\n\ndocker方式运行的runner需在此bash中执行命令，主机之间运行的runner直接在shell中执行即可。\n\n### 执行register命令进行注册\n\n```shell\ngitlab-runner register \n# url：\nhttp://172.17.0.205/\n# token\ncEJ611JDeCWSMyu7WXWi\n# description - 用于辨识该注册所属的群组或项目，可以设置为方便区分的字符串\nsonarqube-runner\n# ci-tag - 标签用于后续CI配置中选择此执行器，后期可以通过gitlab界面更改\nsonarqube,common-build\n# executor - 后续CI任务的执行方式，docker方式运行的请选择docker\ndocker\n# default image - CI配置中未指定镜像时默认使用的镜像\nbusybox:1.31.1\n```\n\n以下为一个注册过程的交互示例：\n\n```shell\nbash-4.4# gitlab-runner register \nRuntime platform                                    arch=amd64 os=linux pid=205 revision=05161b14 version=12.4.1\nRunning in system-mode.                            \n                                                   \nPlease enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):\nhttp://172.17.0.205/\nPlease enter the gitlab-ci token for this runner:\ncEJ611JDeCWSMyu7WXWi\nPlease enter the gitlab-ci description for this runner:\n[e0311b0ce34b]: sonarqube-runner\nPlease enter the gitlab-ci tags for this runner (comma separated):\nsonarqube,common-build\nRegistering runner... succeeded                     runner=cEJ611JD\nPlease enter the executor: virtualbox, docker+machine, docker-ssh+machine, custom, docker-ssh, parallels, kubernetes, docker, shell, ssh:\ndocker\nPlease enter the default Docker image (e.g. ruby:2.6):\nbusybox:1.31.1\nRunner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!\n```\n\n### 注册后确认\n\n完成后在刚才的页面可以看到；\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180615.png)\n\n### 取消注册\n\n使用 list 命令查看当前注册的token及url\n\n```shell\ngitlab-runner list\n# 输出类似\nRuntime platform                                    arch=amd64 os=linux pid=23 revision=05161b14 version=12.4.1\nListing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml\nsonarqube-runner                                    Executor=docker Token=wNwxjEztRpKxYDyK1zVd URL=http://172.17.0.205/\n```\n\n使用list命令输出的token机url作为参数 使用unregister命令取消注册\n\n```shell\ngitlab-runner unregister -t 7KM7ftthLAYeJdsB3Tbk -u http://172.17.0.205/\n```\n\n\n\n## 了解更多\n\n* [DOCKER 方式安装gitlab-runner](https://docs.gitlab.com/runner/install/docker.html)\n* [Linux安装gitlab-runner-Gitlab官方文档](https://docs.gitlab.com/runner/install/linux-manually.html)\n* [使用Docker运行Gitlab-Runner-Gitlab官方文档](https://docs.gitlab.com/runner/install/docker.html)\n* [注册Runner-Gitlab官方文档](https://docs.gitlab.com/runner/register/index.html)\n* [Gitlab-Runner alpine Dockerfile](https://gitlab.com/gitlab-org/gitlab-runner/blob/master/dockerfiles/alpine/Dockerfile)\n* [Windows上注册Runner](https://docs.gitlab.com/runner/install/windows.html)\n* [如何在docker执行器中构建Docker镜像？](http://github.com/help/ci/docker/using_docker_build.md)\n\n\n\n# Gitlab相关-GitlabCI&CD自动化\n\n**可先阅读文档：** \n\n* Gitlab&Mattermost&Sonarqube介绍-无批注.pdf（本地文件）\n* [Gitlab协作工具使用指引](http://172.17.0.205/Public-Share/gitlab-usage)\n\n**关键点总结：**\n\n* 主要概念：Gitlab，gitlab-ci.yml，runner，流水线，job\n\n  * Gitlab 提供代码托管，提供ci/cd能力\n  * Gitlab-CI从 项目源码中的gitlab-ci.yml文件中读取CI流程，然后执行，我们在此文件中定义流水线及任务\n  * Runner是一个具体的机器，用于执行任务\n\n* Runner执行器：\n\n  * shell：执行与机器相关的任务，需要使用主机命令的，如docker打包，部署\n  * docker： 使用容器执行通用的构建任务\n  * 注册流程参考：[《2019/11/19-GitlabRunner配置-共享》](https://shimo.im/docs/PVAPV289P6tmFVql/ )\n\n* Gitlab-ci配置参考： http://172.17.0.205/help/ci/yaml/README.md\n\n* Gitlab-ci重要配置 - **job**\n\n  * 定义要执行的任务，使用script定义具体要执行的命令\n\n* Gitlab-ci重要概念 - 阶段 - 定义执行顺序\n\n  * 顶层的stage定义流水线的阶段，job下的stage确定该job的归属，按顶层的stage定义的顺序执行job\n\n* Gitlab-ci重要概念 - **变量** - 用于参数化构建流程 \n\n  * 预定义变量：http://172.17.0.205/help/ci/variables/predefined_variables.md\n  * Gitlab Web界面配置变量，支持在群组及项目级别分别配置，项目级别的优先级较高\n  * gitlab-ci.yml 中配置变量，yml中配置的变量会被web界面中配置的覆盖\n\n* Gitlab-ci重要配置 - 归档\n\n  * 用于将成果归档，可供下载\n  * 用于将成果在不同的阶段的job中传递（Gitlab自动完成）\n  * 使用时指定要归档的文件相对于CI_PROJECT_DIR的路径即可\n  * **特别注意**要限制归档可以存储的时间，避免无用的归档文件占据gitlab磁盘空间\n\n* Gitlab-ci重要配置 - 规则（only，except，rule）\n\n  * **only/expect**\n\n  * - 提交相关：\n\n    - - branches - 所有分支\n      - tags - 所有标签\n      - pushes - 推送\n      - merge_requests - 提起合并请求\n      - external_pull_requests - 外部合并请求（基本用不到）\n\n  * - 其他：\n\n    - - api - 调用gitlab api触发\n      - external - 未了解\n      - pipelines - 未了解\n      - **schedules** ： 定时器（gitlabCI/CD设置页面设置）\n      - triggers：- 未了解\n      - **web**： 界面手动触发\n      - chat - 用不到\n\n  * rules\n\n    * 参考使用规则定义 http://172.17.0.205/help/ci/yaml/README.md#rules\n    * 参考示例 [GeoSocial自动部署](http://172.17.0.205/geosocial-pc/auto-build-deploy/front-auto-deploy/-/blob/master/.gitlab-ci.yml)\n\n\n\n**CI/CD配置示例**\n\n* [VuePress Web项目CI自动构建及部署](http://172.17.0.205/Development/Mobile/geopanel/h5-sdk-api-document/-/blob/master/.gitlab-ci.yml)\n* Android\n  * [Android项目CI自动打包-洪山管理通](http://172.17.0.205/Development/Mobile/support/cgt-sgt/hongshan-sgt/-/blob/master/.gitlab-ci.yml)\n  * [Android项目自动打包-移动中心APP](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/.gitlab-ci.yml)\n* springboot:\n  * [springboot gradle自动打包-GeoRobox3.0-后台](http://172.17.0.205/Development/Mobile/georobox_3_0/georobox-mobile-server/-/blob/master/.gitlab-ci.yml)\n  * [springboot-gradle打包示例-自动打包-多环境部署](http://172.17.0.205/Public-Share/gitlab-ci-examples/springboot-gradle/-/blob/gitlab-ci/.gitlab-ci.yml)\n* sonar代码检查：\n  * [使用帮助-Sonar检查通用模板配置](http://172.17.0.205/Public-Share/gitlab-usage/-/wikis/%E4%BD%BF%E7%94%A8Gitlab/%E4%BD%BF%E7%94%A8gitlab-ci%E8%BF%9B%E8%A1%8Csonar%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5#331-%E9%80%9A%E7%94%A8%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E9%99%A4msbuild%E4%B9%8B%E5%A4%96%E7%9A%84%E9%A1%B9%E7%9B%AE)\n  * [C#代码检查示例项目](http://172.17.0.205/Public-Share/gitlab-ci-examples/donet-sonar-scanner-sample-project/-/blob/master/.gitlab-ci.yml)\n  * [移动中心Android代码检查](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/.gitlab-ci.yml)\n\n# Gitlab相关-使用提示\n\n## CI脚本中变量含有特殊字符时的处理\n\n对于变量中有`$`的，可以使用两个 `$` 来进行转义，如：\n\n```\nrobot$$gitlab\n```\n\n\n\n## 如何检查CI配置？\n\n> 注意： CI规则的检查是和项目相关的，只能在对应的项目中进行检查\n\n检查CI配置是否合规，可在项目的CI/CD界面，点击`CI配置检查（CI lint）`，然后粘贴自己的配置到输入框中执行检查\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210331103427.png\" alt=\"image-20210331103427469\" style=\"zoom:50%;\" />\n\n\n\n## Docker Runner的构建加速（配置数据卷）\n\nDocker的Runner非常适合用于作为通用的构建机器，以执行各种不同类型的语言及不同打包工具的编译任务，比方说gradle,maven，npm等等。\n\n一般来说，我们的项目都会使用很多第三方的依赖，而且这些依赖只是在构建需要时从网络上获取，然后构建工具会将这些包缓存在某个目录中，如：\n\n* gradle 一般放置在 `~/.gradle` 目录中，同时也会存储 gradle 的各种版本；\n* mvn 一般放置于 `~/.m2` 目录中；\n\n使用容器构建时，这些缓存目录都位于容器内部，也就是每次都需要重新下载，非常浪费时间。所以我们需要能让这些目录可以自动挂载到执行的容器中，gitlab-runner提供了这种能力，具体配置方式参考如下：\n\n1. 找到gitlab-runner的配置文件，可通过如下命令查找，查看其中的ConfigFile指向的目录\n\n   ```shell\n   $ sudo /usr/bin/gitlab-runner list\n   \n   Runtime platform                                    arch=amd64 os=linux pid=15738 revision=05161b14 version=12.4.1\n   Listing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml\n   blockdataapi-engine                                 Executor=shell Token=Y-6zdV9zzi8xsY1rygbn URL=http://172.17.0.205/\n   产品开发部                                               Executor=shell Token=vdxuftxm6EL_fVgAS7Td URL=http://172.17.0.205/\n   移动中心-部署                                             Executor=shell Token=zx2vFV3x4S19n5mJDjD_ URL=http://172.17.0.205/\n   localhost                                           Executor=shell Token=3xHHCWiysKqf4kWdnA_e URL=http://172.17.0.205/\n   ```\n\n   > 注意：如果是通过gitlab运行的gitlab-runner，则在挂载的config目录\n\n2. 找到对应的Runner配置段，可通过name进行区分\n\n   ```yaml\n   [[runners]]\n     name = \"sonarqube-runner\"\n     url = \"http://172.17.0.205/\"\n     token = \"wNwxjEztRpKxYDyK1zVd\"\n     executor = \"docker\"\n     [runners.custom_build_dir]\n     [runners.docker]\n       tls_verify = false\n       image = \"busybox:1.31.1\"\n       privileged = false\n       disable_entrypoint_overwrite = false\n       oom_kill_disable = false\n       disable_cache = false\n       shm_size = 0\n     [runners.cache]\n       [runners.cache.s3]\n       [runners.cache.gcs]\n   ```\n\n3. 在  `[runners.docker]` 配置中添加`volumes`配置，示例如下，写法于通过docker挂载命名卷一致 \n\n   ```yaml\n   [[runners]]\n     name = \"sonarqube-runner\"\n     url = \"http://172.17.0.205/\"\n     token = \"wNwxjEztRpKxYDyK1zVd\"\n     executor = \"docker\"\n     [runners.custom_build_dir]\n     [runners.docker]\n       tls_verify = false\n       image = \"busybox:1.31.1\"\n       privileged = false\n       disable_entrypoint_overwrite = false\n       oom_kill_disable = false\n       disable_cache = false\n       volumes = [\"/cache\", \"maven:/root/.m2\", \"gradle_gradle:/home/gradle/.gradle\", \"nginx_static:/work/html\", \"android_build_tools:/android-sdk/build-tools\", \"android_platforms:/android-sdk/platforms\", \"android_extras:/android-sdk/extras\"]\n       shm_size = 0\n     [runners.cache]\n       [runners.cache.s3]\n       [runners.cache.gcs]\n   ```\n\n   > 提示：修改后直接保存，无需重新启动gitlab-runner，下次对应的任务跑到这个runner上时，即会自动生效\n\n   > 这里解释下几个卷的配置：\n   >\n   > * `\"maven:/root/.m2\"`: 一般的maven的镜像的缓存配置目录在`/root/.m2` \n   > * `\"gradle_gradle:/home/gradle/.gradle\"`: 一般的gradle镜像的缓存目录 `/home/gradle/.gradle`\n   > * `\"nginx_static:/work/html\"`: 为我们通过docker启动的一个nginx服务，启动时挂载了 nginx_static 到/work/html，在ci任务中，我们可在容器中将web资源拷贝到执行任务的容器内部的/work/html目录即可将web资源发布到该runner上启动的nginx服务中\n   > * 另外两个都是自行构建的android构建镜像的缓存目录。\n\n## 使用cache-缓存加速构建\n\n可使用gitlab的cache关键字缓存构建的依赖下载文件\n\n```yaml\ncache:\n  key: \"$CI_COMMIT_REF_SLUG\"\n  paths:\n    - node_modules/\n\nstages:\n    - test\n    - build\n    - deploy\n\nbuild:\n  stage: build\n  image: node:11-alpine\n  script:\n    # - npm install --registry=https://registry.npm.taobao.org\n    - npm install \n    - npm run build:prod\n  artifacts:\n    expire_in: 1 hours\n    name: \"$CI_PROJECT_NAME--$CI_COMMIT_REF_NAME--$CI_COMMIT_SHORT_SHA--$CI_JOB_NAME--$CI_JOB_ID\"\n    paths:\n      - dist/\n  tags:\n    - common-build\n  only:\n    - branches\n    - web\n```\n\n之后在任务开始时，会加载缓存：\n\n![image-20210401153959401](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210406143904.png)\n\n在任务完成后，会保存缓存：\n\n![image-20210401154038947](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401154039.png)\n\n配置前后的构建时间差距如下：（第一次需要3分钟，第二次只需要1分钟）\n\n![image-20210401154401344](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401154404.png)\n\n> 参考： \n>\n> * [Cache dependencies in GitLab CI/CD](https://docs.gitlab.com/ee/ci/caching/index.html)\n> * [gitlab-ci.yaml - cache](https://docs.gitlab.com/ee/ci/yaml/README.html#cache)\n\n\n\n\n\n# Gitlab相关-升级记录（12.10.0-13.0.6）\n\n考虑到后续可能需要对gitlab进行升级，这里将之前的一次升级记录贴出，供后续升级作为参考。\n\n> 升级需要选择无人使用的时段，并提前通知。\n\n## 升级准备工作\n\n### **确定升级路线**\n\n- 现有版本：12.10.0\n- 当下目标版本：13.0.6\n- 结合 [Gitlab升级路线建议](https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations) 确定如下升级路线：\n  - 12.10.0 -> 13.0.0 -> 13.0.6 \n  - 由于我们跨大版本升级了（12-13），所以引入了 13.0.0 的中间升级路径\n\n### **获取最新版本信息**\n\n- 查看 gitlab release页面 信息\n- 查看 gitlab docker hub 获取gitlab-ce docker镜像版本TAG：\n- 13.0.0: `gitlab/gitlab-ce:13.0.0-ce.0`\n- 13.0.6: `gitlab/gitlab-ce:13.0.6-ce.0`\n- 查看升级注意事项\n- 升级流程： https://docs.gitlab.com/omnibus/docker/README.html#update\n- 版本升级建议路线：https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations\n\n## 备份\n\n备份有两种方式，备份的数据量不相同：\n\n* 对docker挂载的gitlab数据目录整体备份\n* 使用 gitlab的 `gitlab-backup create` 命令创建备份，可包含所有git仓库，包括wiki及权限信息。\n\n> 建议对挂载的gitlab数据目录进行一次整体备份，目前暂不清楚gitlab-backup create命令创建的备份是否包含ci相关内容。\n\n以下对gitalb-backup 命令执行备份进行简要介绍。数据目录的备份方式直接对目录进行操作即可。\n\n进入到gitlab部署机器，执行如下命令：\n\n```shell l\ndocker exec -t <container name> gitlab-backup create\n# 如果docker容器的名称是gitlab，则可以执行如下命令，备份完成后位于gitlab的数据目录，如：/data/gitlab/data/backups/\ndocker exec -t $(docker ps | grep gitlab | awk '{print $1}') gitlab-backup create\n# 备份配置目录\nsudo tar -cvf /data/gitlab/data/backups/1592710400_2020_06_21_12.10.0_gitlab_config_backup.tar /data/gitlab/config \n```\n\n## 执行升级：\n\n- 进入到gitlab部署机器 \n\n```shell\nssh -p 10022 geostar@172.17.0.205\n```\n\n- 获取Gitlab中间版本镜像及最终版本镜像\n\n```shell\ndocker pull gitlab/gitlab-ce:13.0.0-ce.0\ndocker pull gitlab/gitlab-ce:13.0.6-ce.0\n```\n\n- 停止并移除现有服务\n\n```shell\nsudo docker stop gitlab \nsudo docker rm gitlab \n```\n\n- 进行升级，使用 13.0.0 的镜像运行gitlab，gitlab会自动处理数据升级流程\n\n```shell\n    sudo docker run --detach \\\n        --hostname 172.17.0.205 \\\n        --publish 443:443 --publish 80:80 --publish 22:22 \\\n        --name gitlab \\\n        --restart always \\\n        --volume /data/gitlab/config:/etc/gitlab \\\n        --volume /data/gitlab/logs:/var/log/gitlab \\\n        --volume /data/gitlab/data:/var/opt/gitlab \\\n        gitlab/gitlab-ce:13.0.0-ce.0\n```\n\n- 待 13.0.0 升级完毕之后，升级到 13.0.6，使用 13.0.6 的镜像运行gitlab\n\n```shell\n      sudo docker stop gitlab \n      sudo docker rm gitlab \n      sudo docker run --detach \\\n        --hostname 172.17.0.205 \\\n        --publish 443:443 --publish 80:80 --publish 22:22 \\\n        --name gitlab \\\n        --restart always \\\n        --volume /data/gitlab/config:/etc/gitlab \\\n        --volume /data/gitlab/logs:/var/log/gitlab \\\n        --volume /data/gitlab/data:/var/opt/gitlab \\\n        gitlab/gitlab-ce:13.0.6-ce.0\n```\n\n## 确认升级成功\n\n登录管理员账号，进入管理中心-仪表盘，查看gitlab版本：\n\n![image-20210302165417697](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302165417.png)\n\n\n\n\n",
      "data": {
        "title": "工作交接-Gitlab相关",
        "date": "2021-04-08 16:48:23",
        "tags": [
          "工作"
        ],
        "published": false,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "",
      "fileName": "工作交接-Gitlab相关"
    },
    {
      "content": "# GeoPanel-移动中心-代码同步\n\n## 一般步骤\n\n1. 克隆gitlab代码到本地\n\n\n\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<svg version=\"1.1\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xl=\"http://www.w3.org/1999/xlink\" viewBox=\"586.5 -80 601.5 198.46154\" width=\"601.5\" height=\"198.46154\">\n  <defs>\n    <font-face font-family=\"Helvetica\" font-size=\"16\" units-per-em=\"1000\" underline-position=\"-75.68359\" underline-thickness=\"49.316406\" slope=\"0\" x-height=\"522.9492\" cap-height=\"717.28516\" ascent=\"770.0195\" descent=\"-229.98047\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"Helvetica\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"PingFang SC\" font-size=\"16\" panose-1=\"2 11 4 0 0 0 0 0 0 0\" units-per-em=\"1000\" underline-position=\"-150\" underline-thickness=\"58\" slope=\"0\" x-height=\"600\" cap-height=\"860\" ascent=\"1060.0021\" descent=\"-340.0007\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"PingFangSC-Regular\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Helvetica Neue\" font-size=\"16\" panose-1=\"2 0 5 3 0 0 0 2 0 4\" units-per-em=\"1000\" underline-position=\"-100\" underline-thickness=\"50\" slope=\"0\" x-height=\"517\" cap-height=\"714\" ascent=\"951.9958\" descent=\"-212.99744\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"HelveticaNeue\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Courier New\" font-size=\"16\" panose-1=\"2 7 3 9 2 2 5 2 4 4\" units-per-em=\"1000\" underline-position=\"-232.91016\" underline-thickness=\"41.015625\" slope=\"0\" x-height=\"422.85156\" cap-height=\"571.28906\" ascent=\"832.5195\" descent=\"-300.29297\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"CourierNewPSMT\"/>\n      </font-face-src>\n    </font-face>\n  </defs>\n  <metadata> Produced by OmniGraffle 7.18.4\\n2021-03-23 05:56:46 +0000</metadata>\n  <g id=\"Canvas_1\" stroke=\"none\" fill-opacity=\"1\" fill=\"none\" stroke-opacity=\"1\" stroke-dasharray=\"none\">\n    <title>Canvas 1</title>\n    <g id=\"Canvas_1_Layer_1\">\n      <title>Layer 1</title>\n      <g id=\"Group_33\">\n        <title>General - Internet</title>\n        <g id=\"Group_35\">\n          <g id=\"Graphic_37\">\n            <path d=\"M 1188 27.79753 L 1188 34.97935 C 1188 47.996394 1173.6364 61.4623 1156.1307 61.4623 L 1061.8693 61.4623 C 1044.1392 61.4623 1030 48.220826 1030 34.97935 L 1030 27.79753 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_36\">\n            <path d=\"M 1090.821 -42.000765 C 1107.2045 -42.000765 1121.3438 -32.350197 1127.6278 -18.210992 C 1130.9943 -20.45531 1134.8097 -21.8019 1139.2983 -21.8019 C 1150.5199 -21.8019 1159.4972 -13.04906 1159.7216 -2.0519012 C 1175.6562 -.7053103 1188 14.556053 1188 26.899803 L 1188 29.592985 C 1188 42.83446 1173.6364 56.07594 1155.9062 56.07594 L 1061.8693 56.07594 C 1044.1392 56.07594 1030 42.83446 1030 29.592985 L 1030 26.899803 C 1030 16.800372 1038.5284 2.8855988 1050.4233 -.4808785 C 1050.4233 -.9297421 1050.4233 -1.154174 1050.4233 -1.6030376 C 1050.4233 -24.04622 1068.3778 -42.000765 1090.821 -42.000765 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_34\">\n          <text transform=\"translate(1085.4865 63.4623)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">Gitlab</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_38\">\n        <title>Mobile Services - SNS - Topic</title>\n        <g id=\"Group_40\">\n          <title>Layer_1</title>\n          <g id=\"Group_53\">\n            <g id=\"Graphic_54\">\n              <rect x=\"586.5\" y=\"48.76923\" width=\"279\" height=\"47.69231\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_51\">\n            <g id=\"Graphic_52\">\n              <rect x=\"586.5\" y=\"-5.736264\" width=\"279\" height=\"43.263736\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_49\">\n            <g id=\"Graphic_50\">\n              <path d=\"M 865.1593 -28.9011 L 865.1593 -20.384615 L 586.5 -20.384615 L 586.5 -28.9011 L 746.95055 -75.23077 Z\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_47\">\n            <g id=\"Graphic_48\">\n              <rect x=\"586.5\" y=\"-80\" width=\"279\" height=\"51.0989\" fill=\"#ad688b\"/>\n              <text transform=\"translate(591.5 -65.45055)\" fill=\"white\">\n                <tspan font-family=\"PingFang SC\" font-size=\"16\" font-weight=\"400\" fill=\"white\" x=\"102.5\" y=\"17\">本地仓库</tspan>\n              </text>\n            </g>\n          </g>\n          <g id=\"Group_45\">\n            <g id=\"Graphic_46\">\n              <rect x=\"586.5\" y=\"-13.571429\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Group_43\">\n            <g id=\"Graphic_44\">\n              <rect x=\"586.5\" y=\"45.36264\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Graphic_42\">\n            <rect x=\"595.35714\" y=\"-4.7142857\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 -1.6745485)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"73.91253\" y=\"15\">remotes/origin</tspan>\n            </text>\n          </g>\n          <g id=\"Graphic_41\">\n            <rect x=\"595.35714\" y=\"54.56044\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_39\">\n          <text transform=\"translate(677.9922 98.46154)\" fill=\"black\">\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"4.800781\" y=\"13\">git clone </tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Line_55\">\n        <line x1=\"865.5\" y1=\"19.23077\" x2=\"1030\" y2=\"21.23077\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-dasharray=\"8.0,8.0\" stroke-width=\"2\"/>\n      </g>\n    </g>\n  </g>\n</svg>\n\n\n2. 添加github远程仓库到本地仓库（下面取名为github）\n\n   可使用 `git remote -v show` 命令确认当前说注册的远程仓库列表\n\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<svg version=\"1.1\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xl=\"http://www.w3.org/1999/xlink\" viewBox=\"285 274 903 216.46154\" width=\"903\" height=\"216.46154\">\n  <defs>\n    <font-face font-family=\"Helvetica\" font-size=\"16\" units-per-em=\"1000\" underline-position=\"-75.68359\" underline-thickness=\"49.316406\" slope=\"0\" x-height=\"522.9492\" cap-height=\"717.28516\" ascent=\"770.0195\" descent=\"-229.98047\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"Helvetica\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"PingFang SC\" font-size=\"16\" panose-1=\"2 11 4 0 0 0 0 0 0 0\" units-per-em=\"1000\" underline-position=\"-150\" underline-thickness=\"58\" slope=\"0\" x-height=\"600\" cap-height=\"860\" ascent=\"1060.0021\" descent=\"-340.0007\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"PingFangSC-Regular\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Helvetica Neue\" font-size=\"16\" panose-1=\"2 0 5 3 0 0 0 2 0 4\" units-per-em=\"1000\" underline-position=\"-100\" underline-thickness=\"50\" slope=\"0\" x-height=\"517\" cap-height=\"714\" ascent=\"951.9958\" descent=\"-212.99744\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"HelveticaNeue\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Courier New\" font-size=\"16\" panose-1=\"2 7 3 9 2 2 5 2 4 4\" units-per-em=\"1000\" underline-position=\"-232.91016\" underline-thickness=\"41.015625\" slope=\"0\" x-height=\"422.85156\" cap-height=\"571.28906\" ascent=\"832.5195\" descent=\"-300.29297\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"CourierNewPSMT\"/>\n      </font-face-src>\n    </font-face>\n  </defs>\n  <metadata> Produced by OmniGraffle 7.18.4\\n2021-03-23 05:56:46 +0000</metadata>\n  <g id=\"Canvas_1\" stroke=\"none\" fill-opacity=\"1\" fill=\"none\" stroke-opacity=\"1\" stroke-dasharray=\"none\">\n    <title>Canvas 1</title>\n    <g id=\"Canvas_1_Layer_1\">\n      <title>Layer 1</title>\n      <g id=\"Group_3\">\n        <title>General - Internet</title>\n        <g id=\"Group_5\">\n          <g id=\"Graphic_7\">\n            <path d=\"M 443 414.7983 L 443 421.9801 C 443 434.99716 428.63636 448.46307 411.1307 448.46307 L 316.8693 448.46307 C 299.1392 448.46307 285 435.2216 285 421.9801 L 285 414.7983 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_6\">\n            <path d=\"M 345.82102 345 C 362.20455 345 376.34375 354.65057 382.62784 368.78977 C 385.9943 366.54545 389.80966 365.19886 394.2983 365.19886 C 405.5199 365.19886 414.49716 373.9517 414.7216 384.94886 C 430.65625 386.29545 443 401.5568 443 413.90057 L 443 416.59375 C 443 429.83523 428.63636 443.0767 410.90625 443.0767 L 316.8693 443.0767 C 299.1392 443.0767 285 429.83523 285 416.59375 L 285 413.90057 C 285 403.80114 293.5284 389.88636 305.4233 386.5199 C 305.4233 386.071 305.4233 385.8466 305.4233 385.39773 C 305.4233 362.95455 323.37784 345 345.82102 345 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_4\">\n          <text transform=\"translate(336.4865 450.46307)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">GitHub</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_8\">\n        <title>General - Internet</title>\n        <g id=\"Group_10\">\n          <g id=\"Graphic_12\">\n            <path d=\"M 1188 381.79753 L 1188 388.97935 C 1188 401.9964 1173.6364 415.4623 1156.1307 415.4623 L 1061.8693 415.4623 C 1044.1392 415.4623 1030 402.22083 1030 388.97935 L 1030 381.79753 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_11\">\n            <path d=\"M 1090.821 311.99924 C 1107.2045 311.99924 1121.3438 321.6498 1127.6278 335.789 C 1130.9943 333.5447 1134.8097 332.1981 1139.2983 332.1981 C 1150.5199 332.1981 1159.4972 340.95094 1159.7216 351.9481 C 1175.6562 353.2947 1188 368.55605 1188 380.8998 L 1188 383.593 C 1188 396.83446 1173.6364 410.07594 1155.9062 410.07594 L 1061.8693 410.07594 C 1044.1392 410.07594 1030 396.83446 1030 383.593 L 1030 380.8998 C 1030 370.80037 1038.5284 356.8856 1050.4233 353.51912 C 1050.4233 353.07026 1050.4233 352.84583 1050.4233 352.39696 C 1050.4233 329.9538 1068.3778 311.99924 1090.821 311.99924 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_9\">\n          <text transform=\"translate(1085.4865 417.4623)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">Gitlab</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_13\">\n        <title>Mobile Services - SNS - Topic</title>\n        <g id=\"Group_15\">\n          <title>Layer_1</title>\n          <g id=\"Group_28\">\n            <g id=\"Graphic_29\">\n              <rect x=\"586.5\" y=\"402.76923\" width=\"279\" height=\"47.69231\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_26\">\n            <g id=\"Graphic_27\">\n              <rect x=\"586.5\" y=\"348.26374\" width=\"279\" height=\"43.263736\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_24\">\n            <g id=\"Graphic_25\">\n              <path d=\"M 865.1593 325.0989 L 865.1593 333.6154 L 586.5 333.6154 L 586.5 325.0989 L 746.95055 278.76923 Z\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_22\">\n            <g id=\"Graphic_23\">\n              <rect x=\"586.5\" y=\"274\" width=\"279\" height=\"51.0989\" fill=\"#ad688b\"/>\n              <text transform=\"translate(591.5 288.54945)\" fill=\"white\">\n                <tspan font-family=\"PingFang SC\" font-size=\"16\" font-weight=\"400\" fill=\"white\" x=\"102.5\" y=\"17\">本地仓库</tspan>\n              </text>\n            </g>\n          </g>\n          <g id=\"Group_20\">\n            <g id=\"Graphic_21\">\n              <rect x=\"586.5\" y=\"340.42857\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Group_18\">\n            <g id=\"Graphic_19\">\n              <rect x=\"586.5\" y=\"399.36264\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n              <text transform=\"translate(591.5 402.42985)\" fill=\"black\">\n                <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"130.5\" y=\"15\">s</tspan>\n              </text>\n            </g>\n          </g>\n          <g id=\"Graphic_17\">\n            <rect x=\"595.35714\" y=\"349.2857\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 352.32545)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"73.91253\" y=\"15\">remotes/origin</tspan>\n            </text>\n          </g>\n          <g id=\"Graphic_16\">\n            <rect x=\"595.35714\" y=\"408.56044\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 411.6002)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"71.23253\" y=\"15\">remotes/github</tspan>\n            </text>\n          </g>\n        </g>\n        <g id=\"Graphic_14\">\n          <text transform=\"translate(605.9805 452.46154)\" fill=\"black\">\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"19.203125\" y=\"13\">git remote add github</tspan>\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"31\">https://github/com/xx.git</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Line_30\">\n        <line x1=\"586.5\" y1=\"409\" x2=\"443\" y2=\"408.23153\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-dasharray=\"8.0,8.0\" stroke-width=\"2\"/>\n      </g>\n      <g id=\"Line_32\">\n        <line x1=\"865.5\" y1=\"382.23077\" x2=\"1030\" y2=\"375.23077\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-dasharray=\"8.0,8.0\" stroke-width=\"2\"/>\n      </g>\n    </g>\n  </g>\n</svg>\n\n\n3. 使用 `fetch` 命令获取github远程仓库代码到本地\n\n   > 通过 `git fetch github` 获取github远程仓库上的所有分支及tag\n   >\n   > 如我们需要获取指定分支（如：alpha分支），也可以通过 `git fetch github alpha:refs/remotes/github/alpha` 只拉取指定分支；\n   >\n   > 如果我们需要获取指定tag（如 v1.3.3），可通过 `git fetch github v1.3.3:refs/tagg/v1.3.3` 只拉取指定tag；\n\n\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<svg version=\"1.1\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xl=\"http://www.w3.org/1999/xlink\" viewBox=\"285 616.5008 903 198.46154\" width=\"903\" height=\"198.46154\">\n  <defs>\n    <font-face font-family=\"Helvetica\" font-size=\"16\" units-per-em=\"1000\" underline-position=\"-75.68359\" underline-thickness=\"49.316406\" slope=\"0\" x-height=\"522.9492\" cap-height=\"717.28516\" ascent=\"770.0195\" descent=\"-229.98047\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"Helvetica\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"PingFang SC\" font-size=\"16\" panose-1=\"2 11 4 0 0 0 0 0 0 0\" units-per-em=\"1000\" underline-position=\"-150\" underline-thickness=\"58\" slope=\"0\" x-height=\"600\" cap-height=\"860\" ascent=\"1060.0021\" descent=\"-340.0007\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"PingFangSC-Regular\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Helvetica Neue\" font-size=\"16\" panose-1=\"2 0 5 3 0 0 0 2 0 4\" units-per-em=\"1000\" underline-position=\"-100\" underline-thickness=\"50\" slope=\"0\" x-height=\"517\" cap-height=\"714\" ascent=\"951.9958\" descent=\"-212.99744\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"HelveticaNeue\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Courier New\" font-size=\"16\" panose-1=\"2 7 3 9 2 2 5 2 4 4\" units-per-em=\"1000\" underline-position=\"-232.91016\" underline-thickness=\"41.015625\" slope=\"0\" x-height=\"422.85156\" cap-height=\"571.28906\" ascent=\"832.5195\" descent=\"-300.29297\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"CourierNewPSMT\"/>\n      </font-face-src>\n    </font-face>\n    <marker orient=\"auto\" overflow=\"visible\" markerUnits=\"strokeWidth\" id=\"StickArrow_Marker\" stroke-linejoin=\"miter\" stroke-miterlimit=\"10\" viewBox=\"-6 -3 7 6\" markerWidth=\"7\" markerHeight=\"6\" color=\"black\">\n      <g>\n        <path d=\"M -4.8 0 L 0 0 M 0 1.8 L -4.8 0 L 0 -1.8\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1\"/>\n      </g>\n    </marker>\n  </defs>\n  <metadata> Produced by OmniGraffle 7.18.4\\n2021-03-23 06:35:35 +0000</metadata>\n  <g id=\"Canvas_1\" stroke=\"none\" fill-opacity=\"1\" fill=\"none\" stroke-opacity=\"1\" stroke-dasharray=\"none\">\n    <title>Canvas 1</title>\n    <g id=\"Canvas_1_Layer_1\">\n      <title>Layer 1</title>\n      <g id=\"Group_57\">\n        <title>General - Internet</title>\n        <g id=\"Group_59\">\n          <g id=\"Graphic_61\">\n            <path d=\"M 443 757.2991 L 443 764.4809 C 443 777.4979 428.63636 790.9638 411.1307 790.9638 L 316.8693 790.9638 C 299.1392 790.9638 285 777.7224 285 764.4809 L 285 757.2991 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_60\">\n            <path d=\"M 345.82102 687.5008 C 362.20455 687.5008 376.34375 697.1513 382.62784 711.2905 C 385.9943 709.0462 389.80966 707.6996 394.2983 707.6996 C 405.5199 707.6996 414.49716 716.4525 414.7216 727.4496 C 430.65625 728.7962 443 744.0576 443 756.4013 L 443 759.0945 C 443 772.336 428.63636 785.5775 410.90625 785.5775 L 316.8693 785.5775 C 299.1392 785.5775 285 772.336 285 759.0945 L 285 756.4013 C 285 746.3019 293.5284 732.3871 305.4233 729.02065 C 305.4233 728.5718 305.4233 728.34736 305.4233 727.8985 C 305.4233 705.4553 323.37784 687.5008 345.82102 687.5008 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_58\">\n          <text transform=\"translate(336.4865 792.9638)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">GitHub</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_62\">\n        <title>General - Internet</title>\n        <g id=\"Group_64\">\n          <g id=\"Graphic_66\">\n            <path d=\"M 1188 724.2983 L 1188 731.4801 C 1188 744.4972 1173.6364 757.9631 1156.1307 757.9631 L 1061.8693 757.9631 C 1044.1392 757.9631 1030 744.7216 1030 731.4801 L 1030 724.2983 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_65\">\n            <path d=\"M 1090.821 654.5 C 1107.2045 654.5 1121.3438 664.1506 1127.6278 678.2898 C 1130.9943 676.04545 1134.8097 674.6989 1139.2983 674.6989 C 1150.5199 674.6989 1159.4972 683.4517 1159.7216 694.4489 C 1175.6562 695.79545 1188 711.0568 1188 723.4006 L 1188 726.09375 C 1188 739.3352 1173.6364 752.5767 1155.9062 752.5767 L 1061.8693 752.5767 C 1044.1392 752.5767 1030 739.3352 1030 726.09375 L 1030 723.4006 C 1030 713.3011 1038.5284 699.3864 1050.4233 696.0199 C 1050.4233 695.571 1050.4233 695.3466 1050.4233 694.8977 C 1050.4233 672.45455 1068.3778 654.5 1090.821 654.5 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_63\">\n          <text transform=\"translate(1085.4865 759.9631)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">Gitlab</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_67\">\n        <title>Mobile Services - SNS - Topic</title>\n        <g id=\"Group_69\">\n          <title>Layer_1</title>\n          <g id=\"Group_82\">\n            <g id=\"Graphic_83\">\n              <rect x=\"586.5\" y=\"745.27\" width=\"279\" height=\"47.69231\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_80\">\n            <g id=\"Graphic_81\">\n              <rect x=\"586.5\" y=\"690.7645\" width=\"279\" height=\"43.263736\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_78\">\n            <g id=\"Graphic_79\">\n              <path d=\"M 865.1593 667.5997 L 865.1593 676.11615 L 586.5 676.11615 L 586.5 667.5997 L 746.95055 621.27 Z\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_76\">\n            <g id=\"Graphic_77\">\n              <rect x=\"586.5\" y=\"616.5008\" width=\"279\" height=\"51.0989\" fill=\"#ad688b\"/>\n              <text transform=\"translate(591.5 631.0502)\" fill=\"white\">\n                <tspan font-family=\"PingFang SC\" font-size=\"16\" font-weight=\"400\" fill=\"white\" x=\"102.5\" y=\"17\">本地仓库</tspan>\n              </text>\n            </g>\n          </g>\n          <g id=\"Group_74\">\n            <g id=\"Graphic_75\">\n              <rect x=\"586.5\" y=\"682.9293\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Group_72\">\n            <g id=\"Graphic_73\">\n              <rect x=\"586.5\" y=\"741.8634\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Graphic_71\">\n            <rect x=\"595.35714\" y=\"691.7865\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 694.8262)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"73.91253\" y=\"15\">remotes/origin</tspan>\n            </text>\n          </g>\n          <g id=\"Graphic_70\">\n            <rect x=\"595.35714\" y=\"751.0612\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 754.1009)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"71.23253\" y=\"15\">remotes/github</tspan>\n            </text>\n          </g>\n        </g>\n        <g id=\"Graphic_68\">\n          <text transform=\"translate(649.1875 794.9623)\" fill=\"black\">\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"13\">git fetch github</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Line_84\">\n        <line x1=\"573.6002\" y1=\"751.4317\" x2=\"443\" y2=\"750.7323\" marker-start=\"url(#StickArrow_Marker)\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"/>\n      </g>\n      <g id=\"Line_85\">\n        <line x1=\"865.5\" y1=\"715.7315\" x2=\"1030\" y2=\"717.7315\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-dasharray=\"8.0,8.0\" stroke-width=\"2\"/>\n      </g>\n    </g>\n  </g>\n</svg>\n\n\n\n\n4. 将上一步拉取的github远程仓库上的分支/tag推送到gitlab远程仓库的指定分支；\n\n   > 推送分支到gitlab：`git push origin refs/remotes/github/alpha:alpha` \n   >\n   > 推送tag到github：`git push origin refs/tags/v1.3.3:v1.3.3`\n\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<svg version=\"1.1\" xmlns:dc=\"http://purl.org/dc/elements/1.1/\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xl=\"http://www.w3.org/1999/xlink\" viewBox=\"285 956 903 234.46154\" width=\"903\" height=\"234.46154\">\n  <defs>\n    <font-face font-family=\"Helvetica\" font-size=\"16\" units-per-em=\"1000\" underline-position=\"-75.68359\" underline-thickness=\"49.316406\" slope=\"0\" x-height=\"522.9492\" cap-height=\"717.28516\" ascent=\"770.0195\" descent=\"-229.98047\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"Helvetica\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"PingFang SC\" font-size=\"16\" panose-1=\"2 11 4 0 0 0 0 0 0 0\" units-per-em=\"1000\" underline-position=\"-150\" underline-thickness=\"58\" slope=\"0\" x-height=\"600\" cap-height=\"860\" ascent=\"1060.0021\" descent=\"-340.0007\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"PingFangSC-Regular\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Helvetica Neue\" font-size=\"16\" panose-1=\"2 0 5 3 0 0 0 2 0 4\" units-per-em=\"1000\" underline-position=\"-100\" underline-thickness=\"50\" slope=\"0\" x-height=\"517\" cap-height=\"714\" ascent=\"951.9958\" descent=\"-212.99744\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"HelveticaNeue\"/>\n      </font-face-src>\n    </font-face>\n    <font-face font-family=\"Courier New\" font-size=\"16\" panose-1=\"2 7 3 9 2 2 5 2 4 4\" units-per-em=\"1000\" underline-position=\"-232.91016\" underline-thickness=\"41.015625\" slope=\"0\" x-height=\"422.85156\" cap-height=\"571.28906\" ascent=\"832.5195\" descent=\"-300.29297\" font-weight=\"400\">\n      <font-face-src>\n        <font-face-name name=\"CourierNewPSMT\"/>\n      </font-face-src>\n    </font-face>\n    <marker orient=\"auto\" overflow=\"visible\" markerUnits=\"strokeWidth\" id=\"FilledArrow_Marker\" stroke-linejoin=\"miter\" stroke-miterlimit=\"10\" viewBox=\"-1 -3 7 6\" markerWidth=\"7\" markerHeight=\"6\" color=\"black\">\n      <g>\n        <path d=\"M 4.8 0 L 0 -1.8 L 0 1.8 Z\" fill=\"currentColor\" stroke=\"currentColor\" stroke-width=\"1\"/>\n      </g>\n    </marker>\n  </defs>\n  <metadata> Produced by OmniGraffle 7.18.4\\n2021-03-23 06:34:36 +0000</metadata>\n  <g id=\"Canvas_1\" stroke=\"none\" fill-opacity=\"1\" fill=\"none\" stroke-opacity=\"1\" stroke-dasharray=\"none\">\n    <title>Canvas 1</title>\n    <g id=\"Canvas_1_Layer_1\">\n      <title>Layer 1</title>\n      <g id=\"Group_87\">\n        <title>General - Internet</title>\n        <g id=\"Group_89\">\n          <g id=\"Graphic_91\">\n            <path d=\"M 443 1096.7983 L 443 1103.9801 C 443 1116.9972 428.63636 1130.4631 411.1307 1130.4631 L 316.8693 1130.4631 C 299.1392 1130.4631 285 1117.2216 285 1103.9801 L 285 1096.7983 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_90\">\n            <path d=\"M 345.82102 1027 C 362.20455 1027 376.34375 1036.6506 382.62784 1050.7898 C 385.9943 1048.5455 389.80966 1047.1989 394.2983 1047.1989 C 405.5199 1047.1989 414.49716 1055.9517 414.7216 1066.9489 C 430.65625 1068.2955 443 1083.5568 443 1095.9006 L 443 1098.5938 C 443 1111.8352 428.63636 1125.0767 410.90625 1125.0767 L 316.8693 1125.0767 C 299.1392 1125.0767 285 1111.8352 285 1098.5938 L 285 1095.9006 C 285 1085.8011 293.5284 1071.8864 305.4233 1068.5199 C 305.4233 1068.071 305.4233 1067.8466 305.4233 1067.3977 C 305.4233 1044.9545 323.37784 1027 345.82102 1027 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_88\">\n          <text transform=\"translate(336.4865 1132.4631)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">GitHub</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_92\">\n        <title>General - Internet</title>\n        <g id=\"Group_94\">\n          <g id=\"Graphic_96\">\n            <path d=\"M 1188 1063.7975 L 1188 1070.9793 C 1188 1083.9964 1173.6364 1097.4623 1156.1307 1097.4623 L 1061.8693 1097.4623 C 1044.1392 1097.4623 1030 1084.2208 1030 1070.9793 L 1030 1063.7975 Z\" fill=\"#7d7c7c\"/>\n          </g>\n          <g id=\"Graphic_95\">\n            <path d=\"M 1090.821 993.9992 C 1107.2045 993.9992 1121.3438 1003.6498 1127.6278 1017.789 C 1130.9943 1015.5447 1134.8097 1014.1981 1139.2983 1014.1981 C 1150.5199 1014.1981 1159.4972 1022.951 1159.7216 1033.9481 C 1175.6562 1035.2947 1188 1050.556 1188 1062.8998 L 1188 1065.593 C 1188 1078.8345 1173.6364 1092.076 1155.9062 1092.076 L 1061.8693 1092.076 C 1044.1392 1092.076 1030 1078.8345 1030 1065.593 L 1030 1062.8998 C 1030 1052.8004 1038.5284 1038.8856 1050.4233 1035.5191 C 1050.4233 1035.0703 1050.4233 1034.8458 1050.4233 1034.397 C 1050.4233 1011.9538 1068.3778 993.9992 1090.821 993.9992 Z\" fill=\"#d2d3d3\"/>\n          </g>\n        </g>\n        <g id=\"Graphic_93\">\n          <text transform=\"translate(1085.4865 1099.4623)\" fill=\"black\">\n            <tspan font-family=\"Helvetica\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"0\" y=\"15\">Gitlab</tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Group_97\">\n        <title>Mobile Services - SNS - Topic</title>\n        <g id=\"Group_99\">\n          <title>Layer_1</title>\n          <g id=\"Group_112\">\n            <g id=\"Graphic_113\">\n              <rect x=\"586.5\" y=\"1084.7692\" width=\"279\" height=\"47.69231\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_110\">\n            <g id=\"Graphic_111\">\n              <rect x=\"586.5\" y=\"1030.2637\" width=\"279\" height=\"43.263736\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_108\">\n            <g id=\"Graphic_109\">\n              <path d=\"M 865.1593 1007.0989 L 865.1593 1015.6154 L 586.5 1015.6154 L 586.5 1007.0989 L 746.95055 960.7692 Z\" fill=\"#692f56\"/>\n            </g>\n          </g>\n          <g id=\"Group_106\">\n            <g id=\"Graphic_107\">\n              <rect x=\"586.5\" y=\"956\" width=\"279\" height=\"51.0989\" fill=\"#ad688b\"/>\n              <text transform=\"translate(591.5 970.5495)\" fill=\"white\">\n                <tspan font-family=\"PingFang SC\" font-size=\"16\" font-weight=\"400\" fill=\"white\" x=\"102.5\" y=\"17\">本地仓库</tspan>\n              </text>\n            </g>\n          </g>\n          <g id=\"Group_104\">\n            <g id=\"Graphic_105\">\n              <rect x=\"586.5\" y=\"1022.4286\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Group_102\">\n            <g id=\"Graphic_103\">\n              <rect x=\"586.5\" y=\"1081.3626\" width=\"279\" height=\"42.58242\" fill=\"#ad688b\"/>\n            </g>\n          </g>\n          <g id=\"Graphic_101\">\n            <rect x=\"595.35714\" y=\"1031.2857\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 1034.3255)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"73.91253\" y=\"15\">remotes/origin</tspan>\n            </text>\n          </g>\n          <g id=\"Graphic_100\">\n            <rect x=\"595.35714\" y=\"1090.5604\" width=\"260.94505\" height=\"24.527473\" fill=\"white\"/>\n            <text transform=\"translate(600.35714 1093.6002)\" fill=\"black\">\n              <tspan font-family=\"Helvetica Neue\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"71.23253\" y=\"15\">remotes/github</tspan>\n            </text>\n          </g>\n        </g>\n        <g id=\"Graphic_98\">\n          <text transform=\"translate(572.375 1134.4615)\" fill=\"black\">\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"76.05078\" y=\"13\">git push origin </tspan>\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"52.046875\" y=\"31\">refs/remotes/github/</tspan>\n            <tspan font-family=\"Courier New\" font-size=\"16\" font-weight=\"400\" fill=\"black\" x=\"95.25391\" y=\"49\">alpha:alpha </tspan>\n          </text>\n        </g>\n      </g>\n      <g id=\"Line_114\">\n        <line x1=\"586.5\" y1=\"1091\" x2=\"443\" y2=\"1090.2315\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-dasharray=\"8.0,8.0\" stroke-width=\"2\"/>\n      </g>\n      <g id=\"Line_115\">\n        <line x1=\"870.5\" y1=\"1034.1538\" x2=\"1017.2329\" y2=\"1055.3836\" marker-end=\"url(#FilledArrow_Marker)\" stroke=\"black\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"/>\n      </g>\n    </g>\n  </g>\n</svg>\n\n\n\n\n\n\n## 移动中心同步脚本说明\n\n> 同步脚本gitlab地址： [syncCode.sh](http://172.17.0.205/Development/Mobile/tools/all/-/blob/master/scripts/sync-code/syncCode.sh)\n\n### 用法说明\n\n```shell\nsource syncCode.sh\nWORKDIR=/Users/hanlyjiang/Wksp/work/gitlab/MOA-auto-sync\n# 移动端代码同步 \nsync_work_repo_branch https://chuanqi900:stgzsz821006@github.com/3930615/moa-release-geo.git $WORKDIR/moa-release-geo-github.git git@172.17.0.205:GeoPanel/MobileCenter/geopanel-android.git \n# 后台代码同步\nsync_work_repo_branch https://chuanqi900:stgzsz821006@github.com/3930615/moa-release.git $WORKDIR/moa-release-github.git git@172.17.0.205:GeoPanel/MobileCenter/geopanel-mobile-server.git\n```\n\n执行如上同步命令之后，会将从链动github仓库获取的所有分支及tag推送到gitlab仓库；\n\n\n\n\n\n# GeoPanel-移动中心-ARM镜像制作-成果链接\n\n本节介绍移动中心国产化的构建成果，请阅读以下文章：\n\n* [《移动中心国产化-ARM迁移基本思路》](https://shimo.im/docs/0l3NVKX0BgflYN3R/)\n* [《移动中心国产化-MOA服务迁移记录》](https://shimo.im/docs/VHgRHrXYq9vQkX3Q/ )\n* [《移动中心国产化-实时音视频服务迁移记录》](https://shimo.im/docs/gO3ox1XzJlHlVzqD/ )\n\n相关成果已上传到gitlab仓库的如下分支：\n\n* [arm/0.5.0-dev](http://zh-gitlab.geostar.com.cn/GeoPanel/MobileCenter/geopanel-mobile-server/-/tree/arm/0.5.0-dev)\n* [arm/v0.3.0-im](http://zh-gitlab.geostar.com.cn/GeoPanel/MobileCenter/geopanel-mobile-server/-/tree/arm/v0.3.0-im)\n\n\n\n# GeoPanel-移动中心-APP相关\n\n本小节介绍移动中心APP相关内容，主要包括如下内容：\n\n* 项目仓库介绍\n* 注意点介绍：主要是我方进行的一些修改，对修改点有所了解，以便后续需要合并代码时减少可能由合并导致的错误。\n\n## 项目仓库介绍\n\n### 项目地址\n\n* 项目仓库地址： http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android\n* 相关文档： \n\n### 仓库分支及Tag说明\n\n#### 分支说明\n\n此仓库同步了链动的代码分支，并新建新的分支对链动代码进行修改，具体分支跟踪关系如下：\n\n\n<svg width=\"834px\" height=\"587px\" viewBox=\"0 0 834 587\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"页面-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"移动中心APP分支图\" transform=\"translate(-196.000000, -78.000000)\">\n            <g id=\"export\" transform=\"translate(197.000000, 79.000000)\">\n                <g id=\"Github链动分支\">\n                    <g id=\"架构图/带标题栏框\">\n                        <g id=\"编组\" stroke-linejoin=\"round\">\n                            <g id=\"分组\">\n                                <rect id=\"边框栏\" stroke=\"#FF9500\" x=\"0.5\" y=\"0.5\" width=\"283\" height=\"584\"></rect>\n                                <rect id=\"标题栏\" fill=\"#FF9500\" x=\"0\" y=\"0\" width=\"284\" height=\"26\"></rect>\n                            </g>\n                        </g>\n                        <text id=\"标题\" font-family=\"PingFangSC-Regular, PingFang SC\" font-size=\"16\" font-weight=\"normal\" letter-spacing=\"0.0959999995\" fill=\"#FFFFFF\">\n                            <tspan x=\"84.8480622\" y=\"17\">链动Github仓库</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份-7\" transform=\"translate(20.000000, 499.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-app-workbench</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"157.85841\" y=\"13.2608696\">小应用-工作台</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份-6\" transform=\"translate(20.000000, 434.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-app-task</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"169.93041\" y=\"13.2608696\">小应用-任务</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份-5\" transform=\"translate(20.000000, 369.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-app-calendar</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"169.93041\" y=\"13.2608696\">小应用-日历</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份-4\" transform=\"translate(20.000000, 304.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-app-appmarket</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"145.78641\" y=\"13.2608696\">小应用-应用市场</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份-3\" transform=\"translate(20.000000, 239.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-app-addressbook</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"157.85841\" y=\"13.2608696\">小应用-通讯录</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份-2\" transform=\"translate(20.000000, 174.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-web-imsdk</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"198.29841\" y=\"13.2608696\">imsdk</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支备份\" transform=\"translate(20.000000, 109.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-client-android-module</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"174.31041\" y=\"13.2608696\">APP库模块</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/直线分支\" transform=\"translate(20.000000, 44.000000)\">\n                        <line x1=\"0.603462208\" y1=\"20.5434783\" x2=\"234.508368\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                        <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"0\" y=\"13.2608696\">moa-client-android</tspan>\n                        </text>\n                        <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"210.52641\" y=\"13.2608696\">APP</tspan>\n                        </text>\n                    </g>\n                </g>\n                <g id=\"GeoStar仓库备份\" transform=\"translate(370.000000, 0.000000)\">\n                    <g id=\"架构图/带标题栏框备份\">\n                        <g id=\"编组\" stroke-linejoin=\"round\">\n                            <g id=\"分组\">\n                                <rect id=\"边框栏\" stroke=\"#FF9500\" x=\"0.5\" y=\"0.5\" width=\"461\" height=\"583\"></rect>\n                                <rect id=\"标题栏\" fill=\"#FF9500\" x=\"0\" y=\"0\" width=\"462\" height=\"26\"></rect>\n                            </g>\n                        </g>\n                        <text id=\"标题\" font-family=\"PingFangSC-Regular, PingFang SC\" font-size=\"16\" font-weight=\"normal\" letter-spacing=\"0.0959999995\" fill=\"#FFFFFF\">\n                            <tspan x=\"158.956777\" y=\"17\">GeoStar Gitlab仓库</tspan>\n                        </text>\n                    </g>\n                    <g id=\"链动原分支\" transform=\"translate(18.000000, 44.000000)\">\n                        <g id=\"分支/直线分支备份-8\" transform=\"translate(0.000000, 455.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-app-workbench</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"155.172218\" y=\"13.2608696\">小应用-工作台</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-9\" transform=\"translate(0.000000, 390.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-app-task</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"167.244218\" y=\"13.2608696\">小应用-任务</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-10\" transform=\"translate(0.000000, 325.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-app-calendar</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"167.244218\" y=\"13.2608696\">小应用-日历</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-11\" transform=\"translate(0.000000, 260.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-app-appmarket</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"143.100218\" y=\"13.2608696\">小应用-应用市场</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-12\" transform=\"translate(0.000000, 195.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-app-addressbook</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"155.172218\" y=\"13.2608696\">小应用-通讯录</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-13\" transform=\"translate(0.000000, 130.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-web-imsdk</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"195.612218\" y=\"13.2608696\">imsdk</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-14\" transform=\"translate(0.000000, 65.000000)\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-client-android-module</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"171.624218\" y=\"13.2608696\">APP库模块</tspan>\n                            </text>\n                        </g>\n                        <g id=\"分支/直线分支备份-15\">\n                            <line x1=\"0.595758436\" y1=\"20.5434783\" x2=\"231.514644\" y2=\"20.5434783\" id=\"分支直线\" stroke=\"#979797\" stroke-width=\"5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"></line>\n                            <text id=\"分支名称\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"0\" y=\"13.2608696\">moa-client-android</tspan>\n                            </text>\n                            <text id=\"说明\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                                <tspan x=\"207.840218\" y=\"13.2608696\">APP</tspan>\n                            </text>\n                        </g>\n                    </g>\n                    <g id=\"编组\" transform=\"translate(115.000000, 67.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"172.132\" y=\"16.5\">geo-client-android/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份\" transform=\"translate(115.000000, 129.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"93.772\" y=\"16.5\">geo-moa-client-android-module/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份-2\" transform=\"translate(115.000000, 196.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"161.584\" y=\"16.5\">geo-moa-web-imsdk/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份-3\" transform=\"translate(118.000000, 259.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"155.548\" y=\"16.5\">geo-app-addressbook/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份-4\" transform=\"translate(115.000000, 326.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"166.204\" y=\"16.5\">geo-app-appmarket/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份-5\" transform=\"translate(115.000000, 393.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"144.148\" y=\"16.5\">geo-app-calendar/nskst/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份-6\" transform=\"translate(115.000000, 456.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"171.112\" y=\"16.5\">geo-app-task/nskst/master</tspan>\n                        </text>\n                    </g>\n                    <g id=\"分支/派生备份-7\" transform=\"translate(115.000000, 519.500000)\">\n                        <path d=\"M-5.68434189e-14,0 L-5.68434189e-14,7.33908739 C-5.22101777e-14,16.1622639 7.14257577,23.3201537 15.965732,23.3390507 L324.567554,24 L324.567554,24\" id=\"路径-2\" stroke=\"#F7B500\" stroke-width=\"5\" stroke-linecap=\"round\"></path>\n                        <text id=\"geo-client-android/m\" font-family=\"NotoSerifCJKsc-Regular, Noto Serif CJK SC\" font-size=\"12\" font-weight=\"normal\" letter-spacing=\"0.0719999996\" fill=\"#000000\" fill-opacity=\"0.85\">\n                            <tspan x=\"128.956\" y=\"16.5\">geo-app-workbench/nskst/master</tspan>\n                        </text>\n                    </g>\n                </g>\n                <g id=\"连接线\" transform=\"translate(259.000000, 63.000000)\" fill=\"#7A7A7A\" fill-rule=\"nonzero\">\n                    <path id=\"直线-2\" d=\"M0.188059701,-4 C2.5043073,-4 4.41182503,-2.25001939 4.6605859,-8.51613636e-05 L9.6880597,0 L9.6880597,1 L4.66051705,1.00070744 C4.41147331,3.25034205 2.50409376,5 0.188059701,5 C-2.29722167,5 -4.3119403,2.98528137 -4.3119403,0.5 C-4.3119403,-1.98528137 -2.29722167,-4 0.188059701,-4 Z M117.31194,-4 L126.31194,0.5 L117.31194,5 L117.311,1 L113.68806,1 L113.68806,0 L117.311,0 L117.31194,-4 Z M19.6880597,0 L19.6880597,1 L13.6880597,1 L13.6880597,0 L19.6880597,0 Z M29.6880597,0 L29.6880597,1 L23.6880597,1 L23.6880597,0 L29.6880597,0 Z M39.6880597,0 L39.6880597,1 L33.6880597,1 L33.6880597,0 L39.6880597,0 Z M49.6880597,0 L49.6880597,1 L43.6880597,1 L43.6880597,0 L49.6880597,0 Z M59.6880597,0 L59.6880597,1 L53.6880597,1 L53.6880597,0 L59.6880597,0 Z M69.6880597,0 L69.6880597,1 L63.6880597,1 L63.6880597,0 L69.6880597,0 Z M79.6880597,0 L79.6880597,1 L73.6880597,1 L73.6880597,0 L79.6880597,0 Z M89.6880597,0 L89.6880597,1 L83.6880597,1 L83.6880597,0 L89.6880597,0 Z M99.6880597,0 L99.6880597,1 L93.6880597,1 L93.6880597,0 L99.6880597,0 Z M109.68806,0 L109.68806,1 L103.68806,1 L103.68806,0 L109.68806,0 Z\"></path>\n                    <path id=\"直线-2备份\" d=\"M0.5,61 C2.81637876,61 4.72398135,62.7501788 4.97256844,65.000297 L10,65 L10,66 L4.97245735,66.0007074 C4.7234136,68.2503421 2.81603406,70 0.5,70 C-1.98528137,70 -4,67.9852814 -4,65.5 C-4,63.0147186 -1.98528137,61 0.5,61 Z M117.31194,61 L126.31194,65.5 L117.31194,70 L117.311,66 L114,66 L114,65 L117.311,65 L117.31194,61 Z M20,65 L20,66 L14,66 L14,65 L20,65 Z M30,65 L30,66 L24,66 L24,65 L30,65 Z M40,65 L40,66 L34,66 L34,65 L40,65 Z M50,65 L50,66 L44,66 L44,65 L50,65 Z M60,65 L60,66 L54,66 L54,65 L60,65 Z M70,65 L70,66 L64,66 L64,65 L70,65 Z M80,65 L80,66 L74,66 L74,65 L80,65 Z M90,65 L90,66 L84,66 L84,65 L90,65 Z M100,65 L100,66 L94,66 L94,65 L100,65 Z M110,65 L110,66 L104,66 L104,65 L110,65 Z\"></path>\n                    <path id=\"直线-2备份-2\" d=\"M0.5,127 C2.81637876,127 4.72398135,128.750179 4.97256844,131.000297 L10,131 L10,132 L4.97245735,132.000707 C4.7234136,134.250342 2.81603406,136 0.5,136 C-1.98528137,136 -4,133.985281 -4,131.5 C-4,129.014719 -1.98528137,127 0.5,127 Z M117.31194,127 L126.31194,131.5 L117.31194,136 L117.311,132 L114,132 L114,131 L117.311,131 L117.31194,127 Z M20,131 L20,132 L14,132 L14,131 L20,131 Z M30,131 L30,132 L24,132 L24,131 L30,131 Z M40,131 L40,132 L34,132 L34,131 L40,131 Z M50,131 L50,132 L44,132 L44,131 L50,131 Z M60,131 L60,132 L54,132 L54,131 L60,131 Z M70,131 L70,132 L64,132 L64,131 L70,131 Z M80,131 L80,132 L74,132 L74,131 L80,131 Z M90,131 L90,132 L84,132 L84,131 L90,131 Z M100,131 L100,132 L94,132 L94,131 L100,131 Z M110,131 L110,132 L104,132 L104,131 L110,131 Z\"></path>\n                    <path id=\"直线-2备份-3\" d=\"M1.5,191 C3.81637876,191 5.72398135,192.750179 5.97256844,195.000297 L11,195 L11,196 L5.97245735,196.000707 C5.7234136,198.250342 3.81603406,200 1.5,200 C-0.985281374,200 -3,197.985281 -3,195.5 C-3,193.014719 -0.985281374,191 1.5,191 Z M117.31194,191 L126.31194,195.5 L117.31194,200 L117.311,196 L115,196 L115,195 L117.311,195 L117.31194,191 Z M21,195 L21,196 L15,196 L15,195 L21,195 Z M31,195 L31,196 L25,196 L25,195 L31,195 Z M41,195 L41,196 L35,196 L35,195 L41,195 Z M51,195 L51,196 L45,196 L45,195 L51,195 Z M61,195 L61,196 L55,196 L55,195 L61,195 Z M71,195 L71,196 L65,196 L65,195 L71,195 Z M81,195 L81,196 L75,196 L75,195 L81,195 Z M91,195 L91,196 L85,196 L85,195 L91,195 Z M101,195 L101,196 L95,196 L95,195 L101,195 Z M111,195 L111,196 L105,196 L105,195 L111,195 Z\"></path>\n                    <path id=\"直线-2备份-4\" d=\"M0.482071855,257.000036 C2.79821908,256.990808 4.7126401,258.733051 4.97047097,260.981861 L9.99586739,260.962164 L9.99985142,261.962156 L4.97441669,261.982885 C4.73433754,264.233494 2.83394382,265.990737 0.517928145,265.999964 C-1.96733351,266.009866 -3.99006285,264.00319 -3.99996429,261.517928 C-4.00986573,259.032666 -2.00318979,257.009937 0.482071855,257.000036 Z M117.482139,256.5339 L126.499996,260.998008 L117.517996,265.533829 L117.501,261.533 L114.499022,261.545825 L113.999026,261.547817 L113.995042,260.547825 L114.495038,260.545833 L117.498,260.533 L117.482139,256.5339 Z M19.995788,260.922324 L19.9997721,261.922316 L13.9998197,261.94622 L13.9958356,260.946228 L19.995788,260.922324 Z M29.9957087,260.882483 L29.9996927,261.882475 L23.9997403,261.90638 L23.9957563,260.906387 L29.9957087,260.882483 Z M39.9956293,260.842643 L39.9996133,261.842635 L33.9996609,261.866539 L33.9956769,260.866547 L39.9956293,260.842643 Z M49.9955499,260.802803 L49.999534,261.802795 L43.9995816,261.826699 L43.9955976,260.826707 L49.9955499,260.802803 Z M59.9954706,260.762962 L59.9994546,261.762954 L53.9995022,261.786859 L53.9955182,260.786866 L59.9954706,260.762962 Z M69.9953912,260.723122 L69.9993752,261.723114 L63.9994229,261.747018 L63.9954388,260.747026 L69.9953912,260.723122 Z M79.9953118,260.683282 L79.9992959,261.683274 L73.9993435,261.707178 L73.9953595,260.707186 L79.9953118,260.683282 Z M89.9952325,260.643441 L89.9992165,261.643433 L83.9992641,261.667338 L83.9952801,260.667346 L89.9952325,260.643441 Z M99.9951531,260.603601 L99.9991372,261.603593 L93.9991848,261.627497 L93.9952007,260.627505 L99.9951531,260.603601 Z M109.995074,260.563761 L109.999058,261.563753 L103.999105,261.587657 L103.995121,260.587665 L109.995074,260.563761 Z\"></path>\n                    <path id=\"直线-2备份-5\" d=\"M1.48192786,323.000036 C3.79794324,322.990735 5.71233408,324.732719 5.97041043,326.981335 L10.9958338,326.96186 L10.9998499,327.961852 L5.97453919,327.981737 C5.73499066,330.232835 3.83443222,331.990661 1.51807214,331.999964 C-0.967189189,332.009945 -2.98998274,330.003333 -2.99996371,327.518072 C-3.00994468,325.032811 -1.00333348,323.010017 1.48192786,323.000036 Z M117.481996,322.534173 L126.499996,326.997992 L117.518141,331.5341 L117.502,327.534 L115.499007,327.542177 L114.999011,327.544185 L114.994995,326.544193 L115.494991,326.542185 L117.497,326.534 L117.481996,322.534173 Z M20.9957532,326.9217 L20.9997692,327.921692 L14.9998176,327.945788 L14.9958016,326.945796 L20.9957532,326.9217 Z M30.9956726,326.881539 L30.9996886,327.881531 L24.999737,327.905628 L24.9957209,326.905636 L30.9956726,326.881539 Z M40.9955919,326.841379 L40.999608,327.841371 L34.9996563,327.865467 L34.9956403,326.865475 L40.9955919,326.841379 Z M50.9955113,326.801219 L50.9995273,327.801211 L44.9995757,327.825307 L44.9955597,326.825315 L50.9955113,326.801219 Z M60.9954306,326.761058 L60.9994467,327.76105 L54.9994951,327.785147 L54.995479,326.785155 L60.9954306,326.761058 Z M70.99535,326.720898 L70.999366,327.72089 L64.9994144,327.744986 L64.9953984,326.744994 L70.99535,326.720898 Z M80.9952693,326.680738 L80.9992854,327.68073 L74.9993338,327.704826 L74.9953177,326.704834 L80.9952693,326.680738 Z M90.9951887,326.640578 L90.9992047,327.640569 L84.9992531,327.664666 L84.9952371,326.664674 L90.9951887,326.640578 Z M100.995108,326.600417 L100.999124,327.600409 L94.9991725,327.624505 L94.9951564,326.624513 L100.995108,326.600417 Z M110.995027,326.560257 L110.999043,327.560249 L104.999092,327.584345 L104.995076,326.584353 L110.995027,326.560257 Z\"></path>\n                    <path id=\"直线-2备份-6\" d=\"M1.5,387 C3.81637876,387 5.72398135,388.750179 5.97256844,391.000297 L11,391 L11,392 L5.97245735,392.000707 C5.7234136,394.250342 3.81603406,396 1.5,396 C-0.985281374,396 -3,393.985281 -3,391.5 C-3,389.014719 -0.985281374,387 1.5,387 Z M117.31194,387 L126.31194,391.5 L117.31194,396 L117.311,392 L115,392 L115,391 L117.311,391 L117.31194,387 Z M21,391 L21,392 L15,392 L15,391 L21,391 Z M31,391 L31,392 L25,392 L25,391 L31,391 Z M41,391 L41,392 L35,392 L35,391 L41,391 Z M51,391 L51,392 L45,392 L45,391 L51,391 Z M61,391 L61,392 L55,392 L55,391 L61,391 Z M71,391 L71,392 L65,392 L65,391 L71,391 Z M81,391 L81,392 L75,392 L75,391 L81,391 Z M91,391 L91,392 L85,392 L85,391 L91,391 Z M101,391 L101,392 L95,392 L95,391 L101,391 Z M111,391 L111,392 L105,392 L105,391 L111,391 Z\"></path>\n                    <path id=\"直线-2备份-7\" d=\"M0,451 C2.31637876,451 4.22398135,452.750179 4.47256844,455.000297 L9.5,455 L9.5,456 L4.47245735,456.000707 C4.2234136,458.250342 2.31603406,460 0,460 C-2.48528137,460 -4.5,457.985281 -4.5,455.5 C-4.5,453.014719 -2.48528137,451 0,451 Z M117.31194,451 L126.31194,455.5 L117.31194,460 L117.311,456 L113.5,456 L113.5,455 L117.311,455 L117.31194,451 Z M19.5,455 L19.5,456 L13.5,456 L13.5,455 L19.5,455 Z M29.5,455 L29.5,456 L23.5,456 L23.5,455 L29.5,455 Z M39.5,455 L39.5,456 L33.5,456 L33.5,455 L39.5,455 Z M49.5,455 L49.5,456 L43.5,456 L43.5,455 L49.5,455 Z M59.5,455 L59.5,456 L53.5,456 L53.5,455 L59.5,455 Z M69.5,455 L69.5,456 L63.5,456 L63.5,455 L69.5,455 Z M79.5,455 L79.5,456 L73.5,456 L73.5,455 L79.5,455 Z M89.5,455 L89.5,456 L83.5,456 L83.5,455 L89.5,455 Z M99.5,455 L99.5,456 L93.5,456 L93.5,455 L99.5,455 Z M109.5,455 L109.5,456 L103.5,456 L103.5,455 L109.5,455 Z\"></path>\n                </g>\n            </g>\n        </g>\n    </g>\n</svg>\n\n由上面图可以看出，链动在一个仓库中通过分支分别存放了移动端Android源码，移动端APP库源码，imsdk及示例源码，还有5个基础H5小应用。\n\n* 首先，我们完全同步链动的几个分支（`moa-xxx`）到我们的gitlab仓库；\n* 然后，我们基于链动的几个分支，分别拉取了我们自己的分支进行修改，命名为 `geo-xxxx`\n\n#### Tag管理\n\n由于我们在一个仓库中放置了若干个模块，通过分支区分，在建立tag时，也需要相应的区分；另外由于链动也会在仓库中提交tag，所以我们需要对tag的命名作一定的约束，一般tag应将分支名称作为前缀，如：\n\n* [geo-client-android-v1.2.22](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/releases/geo-client-android-v1.2.22): 为android端的最新版本tag\n* [geo-app-appmarket-v1.0.2](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/releases/geo-app-appmarket-v1.0.2)： 为小应用的最新版本tag\n\n\n\n**Android端版本tag说明**\n\nAndroid端代码会对应多个地区的项目，如果为每个地区单独区分版本号，会造成主线版本管理混乱。\n\nAPP的版本号不与任何项目进行关联，打包时不论针对哪个项目/产品发包，只要发布了Release版本，就将版本号递增。如下图所示：\n\n* 南山块事通发布版本时，版本号为 1.2.19 \n* 洪山管理通时则将版本号设置为 1.2.20 \n\n![image-20210406160652462](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210406160652.png)\n\n\n\n## 重要修改说明\n\n前面说过，我们的代码从链动分支拉取新分支进行了一些修改，这里主要介绍一些重要的修改点：\n\n1. **打包配置逻辑调整（包括包名，签名，第三方服务账号的key等的修改）**\n2. **UI界面样式调整；**\n3. **迁移到AndroidX；**\n4. **扩展cordova插件；**\n\n\n\n### 打包配置修改\n\n#### 不同项目的包配置区分\n\n链动提供的版本中，包名为链动的包名，而我们需要将一个包应用到不同的项目之中，故需要对包名进行区分，同时还有对应的百度地图及三方推送等的账号也需要进行区分，故提取了一套配置方式，为了减少对链动原有代码文件的修改，我们的配置主要位于如下新增加的文件及目录中：\n\n```shell\nandroid\n├── dist-config  -  不同项目的打包配置定义\n│   └── moa-moa-geo-third-share.gradle\n│   ├── hongshan_sgt_debug_wuhan.gradle\n│   ├── hongshan_sgt_release.gradle\n│   ├── jiujiang_egt_debug_wuhan.gradle\n│   ├── jiujiang_egt_official.gradle\n│   ├── ld_test.gradle\n│   ├── luohu_kst_official.gradle\n│   ├── moa_jiujiang_wuhan_fixed.gradle\n│   ├── moa_wxtest_wuhan_195.gradle\n│   ├── mobile_center_aliyun.gradle\n│   ├── nskst_official.gradle\n│   ├── nskst_official_demonstration.gradle\n│   ├── nskst_official_pre_release.gradle\n│   ├── nskst_test_internet_shenzhen.gradle\n│   ├── nskst_test_shenzhen.gradle\n│   ├── nskst_test_wuhan_fixed.gradle\n│   ├── nskst_test_wuhan_jianghang.gradle\n│   ├── nskst_test_wuhan_open.gradle\n│   ├── nskst_test_wuhan_private.gradle\n│   ├── nskst_test_wuhan_sr.gradle\n│   ├── nskst_test_wuhan_wsr.gradle\n│   ├── rongjiang_kst_official.gradle\n│   ├── shenzhen_shi_official.gradle\n│   └── template.gradle\n├── dist-config.gradle - 定义配置dist-config目录中配置的加载逻辑 \n```\n\n* 引入dist-config.gradle：(platforms/android/app/build.gradle)\n\n  ```groovy\n  apply from: '../dist-config.gradle'\n  ```\n\n> 具体的每个地方的配置，由于已经有接触并配置过，不再赘述\n\n#### 签名配置\n\n* 设置debug和release相同签名: (platforms/android/app/build.gradle)\n\n  ```groovy\n   buildTypes {\n          release {\n              minifyEnabled true\n              zipAlignEnabled true  //压缩优化\n              shrinkResources true  //移出无用资源\n              proguardFiles getDefaultProguardFile(\"proguard-android.txt\"), \"proguard-rules.pro\"\n              signingConfig signingConfigs.moasign\n          }\n          debug {\n              signingConfig signingConfigs.moasign\n          }\n  }\n  ```\n\n* 签名信息替换：(platforms/android/gradle.properties)(链动未提供其签名信息，所以我们自己生成了签名并替换链动的配置)\n\n  ```groovy\n  # keyAlias\n  MOA_RELEASE_KEY_ALIAS=geostar-moa\n  #keyPassword\n  MOA_RELEASE_KEY_PASSWORD=a7cbf71f1019635fc794df0e1abc3e79\n  #storeFile\n  MOA_RELEASE_STORE_FILE=../geostar.moa.jks\n  #storePassword\n  MOA_RELEASE_STORE_PASSWORD=9b1d0e07ee4bdb03e2249bf57f6974a4\n  ```\n\n  \n\n### 迁移到AndroidX\n\ngoogle最初发布了support库（如：v4，v7，design），之前很多控件都是位于这些库中的（如：RecyclerView，CardView等），后统一为androidx的库，旧的support库不再维护，为了能够避免后续开发功能时引入的某些库无法使用，故将项目其迁移到androidx。\n\n迁移androidx的修改可以查看Gitlab上的提交：[migrate： 迁移到AndroidX (adc773ca) · 提交 · GeoPanel / 移动中心 / 移动平台-Android端 · GitLab](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/commit/adc773ca06c807ec0cb271fb900e72bff48ae5ee)\n\n迁移使用androidstudio提供的迁移命令，会自动将项目中的原先使用support库的部分替换为对应的androidx库的用法，同时在编译时也会对依赖库中jar里面使用的support库进行处理。\n\n### UI界面样式调整\n\n在MOA最初应用到南山项目时，按照南山的UI界面进行了一波界面调整。主要包括：\n\n* 登录界面替换；\n* 所有native页面的顶部样式；\n* 基础小应用的顶部样式及界面样式；\n\n\n\n### 扩展cordova插件\n\nAPP整体的架构如下：\n\n<svg width=\"423px\" height=\"345px\" viewBox=\"0 0 423 345\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n    <g id=\"页面-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\n        <g id=\"移动中心APP架构\" transform=\"translate(-219.000000, -162.000000)\">\n            <g id=\"架构图/带标题栏框\" transform=\"translate(219.000000, 429.000000)\">\n                <g id=\"分组\">\n                    <rect id=\"边框栏\" stroke=\"#FF9500\" x=\"0.5\" y=\"0.5\" width=\"422\" height=\"77\"></rect>\n                    <rect id=\"标题栏\" fill=\"#FF9500\" x=\"0\" y=\"0\" width=\"423\" height=\"26\"></rect>\n                </g>\n                <text id=\"标题\" font-family=\"PingFangSC-Regular, PingFang SC\" font-size=\"16\" font-weight=\"normal\" letter-spacing=\"0.0959999995\" fill=\"#FFFFFF\">\n                    <tspan x=\"179.034036\" y=\"17\">系统能力</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/带标题栏框备份\" transform=\"translate(219.000000, 340.000000)\">\n                <g id=\"分组\">\n                    <rect id=\"边框栏\" stroke=\"#FF9500\" x=\"0.5\" y=\"0.5\" width=\"422\" height=\"77\"></rect>\n                    <rect id=\"标题栏\" fill=\"#FF9500\" x=\"0\" y=\"0\" width=\"423\" height=\"26\"></rect>\n                </g>\n                <text id=\"标题\" font-family=\"PingFangSC-Regular, PingFang SC\" font-size=\"16\" font-weight=\"normal\" letter-spacing=\"0.0959999995\" fill=\"#FFFFFF\">\n                    <tspan x=\"179.458036\" y=\"17\">APP能力</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/带标题栏框备份-2\" transform=\"translate(219.000000, 251.000000)\">\n                <g id=\"分组\">\n                    <rect id=\"边框栏\" stroke=\"#FF9500\" x=\"0.5\" y=\"0.5\" width=\"422\" height=\"77\"></rect>\n                    <rect id=\"标题栏\" fill=\"#FF9500\" x=\"0\" y=\"0\" width=\"423\" height=\"26\"></rect>\n                </g>\n                <text id=\"标题\" font-family=\"PingFangSC-Regular, PingFang SC\" font-size=\"16\" font-weight=\"normal\" letter-spacing=\"0.0959999995\" fill=\"#FFFFFF\">\n                    <tspan x=\"149.010036\" y=\"17\">cordova插件框架</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/带标题栏框备份-3\" transform=\"translate(219.000000, 162.000000)\">\n                <g id=\"分组\">\n                    <rect id=\"边框栏\" stroke=\"#FF9500\" x=\"0.5\" y=\"0.5\" width=\"422\" height=\"77\"></rect>\n                    <rect id=\"标题栏\" fill=\"#FF9500\" x=\"0\" y=\"0\" width=\"423\" height=\"26\"></rect>\n                </g>\n                <text id=\"标题\" font-family=\"PingFangSC-Regular, PingFang SC\" font-size=\"16\" font-weight=\"normal\" letter-spacing=\"0.0959999995\" fill=\"#FFFFFF\">\n                    <tspan x=\"176.426036\" y=\"17\">H5小应用</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块\" transform=\"translate(228.000000, 468.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.9717835\" y=\"12\">相机</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-6\" transform=\"translate(228.000000, 379.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.4112835\" y=\"12\">通讯录</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-6\" transform=\"translate(228.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.4112835\" y=\"12\">通讯录</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-16\" transform=\"translate(294.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.9717835\" y=\"12\">日程</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-17\" transform=\"translate(360.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.9717835\" y=\"12\">任务</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-18\" transform=\"translate(426.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"10.4112835\" y=\"12\">工作台</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-12\" transform=\"translate(228.000000, 290.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"402.608247\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"66.7353762\" y=\"12\">将系统能力及APP能力以JS接口的方式暴露给H5小应用</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-7\" transform=\"translate(294.000000, 379.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.9717835\" y=\"12\">消息</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-14\" transform=\"translate(491.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.8507835\" y=\"12\">应用市场</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-8\" transform=\"translate(360.000000, 379.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"4.8507835\" y=\"12\">镜像管理</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-15\" transform=\"translate(558.000000, 201.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"73.742268\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"9.82636597\" y=\"12\">其他小应用</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-9\" transform=\"translate(426.000000, 379.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"69.7560137\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"7.81949312\" y=\"12\">数据库存储</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-10\" transform=\"translate(509.000000, 379.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"69.7560137\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"13.3799931\" y=\"12\">文件存储</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-11\" transform=\"translate(592.000000, 379.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"39.8591065\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"9.44944673\" y=\"12\">其他</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份\" transform=\"translate(294.000000, 468.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.9717835\" y=\"12\">文件</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-2\" transform=\"translate(360.000000, 468.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"69.7560137\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"7.81949312\" y=\"12\">方向传感器</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-3\" transform=\"translate(443.000000, 468.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"52.814433\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"15.5702835\" y=\"12\">GPS</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-4\" transform=\"translate(509.000000, 468.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"60.7869416\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"8.8645292\" y=\"12\">网络请求</tspan>\n                </text>\n            </g>\n            <g id=\"架构图/单个模块备份-5\" transform=\"translate(583.000000, 468.000000)\">\n                <rect id=\"矩形\" stroke=\"#C0C0C0\" fill=\"#EEEEEE\" x=\"0.5\" y=\"0.5\" width=\"48.8281787\" height=\"23\"></rect>\n                <text id=\"模块名称\" font-family=\"PingFangSC-Semibold, PingFang SC\" font-size=\"11\" font-weight=\"500\" letter-spacing=\"0.121000004\" fill=\"#151515\" fill-opacity=\"0.88378138\">\n                    <tspan x=\"13.9649106\" y=\"12\">其他</tspan>\n                </text>\n            </g>\n        </g>\n    </g>\n</svg>\n\n业务的开发主要以H5开发为主，为此APP需要将原生的能力提供为JS的API，链动提供了很多API接口，不过后续发现部分接口有BUG，或者项目上有新的需求，为此我们对cordova插件做了一些修改及扩展，主要包括如下内容：\n\n* [二维码扫描](http://172.17.0.208:12345/moa-doc/api/barcode.html)功能扩展，支持更多自定义选项\n* [设置](http://172.17.0.208:12345/moa-doc/api/private-settings.html)功能扩展，添加若干设置项API，包括清除IM消息，打开消息设置界面等\n* [拍摄视频限制时长，视频选择添加时长及大小限制](http://172.17.0.208:12345/moa-doc/api/media.html#app-video-getvideo)\n* [拍照支持添加水印](http://172.17.0.208:12345/moa-doc/api/photo.html#app-picture-camera)\n* [增加附件查看接口](http://172.17.0.208:12345/moa-doc/api/filebrowser.html#文件浏览器)\n* [添加手势密码保护相关设置](http://172.17.0.208:12345/moa-doc/api/private-settings.html#app-settings-opengestureunlocksetting-打开内置的手势解锁设置页面)\n* [添加第三方分享接口](http://172.17.0.208:12345/moa-doc/api/third-share.html#分享接口-app-share)\n* [添加打开微信小程序接口](http://172.17.0.208:12345/moa-doc/api/third-share.html#打开微信小程序-app-weixin-openminiprogram)\n* [添加启用引导页面的接口](http://172.17.0.208:12345/moa-doc/api/private-settings.html#)\n\n我方添加的接口都在 `cd plugins_dev/repo/cordova-plugin-moa-geo-app ` 目录中，具体细节也可以在git log中筛选 “H5”，或者针对此目录相关的文件查看历史修改记录，定位具体的commit进行了解。\n\n\n\n关于插件开发的方式，之前已有接触，不在赘述，仅整理一些文档：\n\n* https://shimo.im/docs/XRkgJOPwzmtrFbqM/ 《Cordova相关-README》，可复制链接后用石墨文档 App 或小程序打开\n* https://shimo.im/docs/ne3VVlGLWQf8FB3b/ 《MOA中的Cordova插件开发 - 工作流程篇》，可复制链接后用石墨文档 App 或小程序打开\n* [Gitlab-插件JS合并readme](http://172.17.0.205/GeoPanel/MobileCenter/geopanel-android/-/blob/geo-client-android/master/plugins_dev/jsMerge/README.md)\n\n## 其他说明\n\n由于最初规划是链动开发基础版本，后续由公司自行维护，故前期部分修改并未特别严格的考虑同链动的代码后续的合并。且我方代码只有非常少的部分同步到了链动，故后续合并代码时应该特别注意。==建议合并代码后再与合并前的代码进行对比，确认合并所产生的差异==。\n\n\n",
      "data": {
        "title": "移动中心交接",
        "date": "2021-04-08 16:46:15",
        "tags": [
          "工作"
        ],
        "published": false,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "",
      "fileName": "移动中心交接"
    },
    {
      "content": "# GeoPanel容器化概览\n\n此部分主要工作是对GeoPanel中的各服务进行容器化改造，即制作docker镜像，然后对服务进行容器化编排，简化部署步骤，适应更加智能化的部署需求。\n\n主要包括如下部分：\n\n```mermaid\ngraph \n\nGeoPanel[GeoPanel容器化]\nGeoPanel --> pgspider打包\nGeoPanel --> hasura-块数据API引擎\nGeoPanel --> 公司自研镜像打包\nGeoPanel --> 服务编排\n```\n\n* 由于pgspider和hasura的打包过程比较复杂，所以需要这里单独列出；\n* 公司自研服务的镜像打包主要是springboot的镜像打包，流程比较简单，所以合并起来说；\n* 服务编排中描述当前已经容器化的服务及使用swarm编排的情况；\n\n\n\n# GeoPanel容器化-ARM镜像构建-通用步骤\n\n这里的国产化主要指：制作arm版本的镜像\n\n## 前言\n\n移动中心所有服务全部基于docker，故此文档实际叙述的是基于docker部署的服务在arm平台上迁移的基本路径；\n\n1. ARM 版本Docker安装；\n2. 构建所有镜像的ARM版本；\n\n## 测试机信息\n\n| CPU      | FT-1500A 4核 arm64 |\n| :------- | :----------------- |\n| 内存     | 8G                 |\n| OS       | 麒麟V10            |\n| 包管理器 | apt                |\n\n## ARM机器上安装Docker\n\n>[Docker官方文档](https://docs.docker.com/engine/install/?fileGuid=0l3NVKX0BgflYN3R)\n\nDocker支持如下系统及架构\n\n![图片](https://uploader.shimo.im/f/EgAMxl7X6CbHg4J9.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R)\n\n国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按[官方文档- Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/?fileGuid=0l3NVKX0BgflYN3R)进行安装。\n\n### 查看系统信息\n\n```plain\ngeostar@geostar-ft1500a:~$ cat /proc/version\nLinux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020\n```\n\n这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源\n\n### 添加软件源\n\n>参考：\n>https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/\n>https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/\n\n添加清华镜像软件源（arm架构）\n\n```plain\n# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse\n```\n\n更新：\n\n```plain\nsudo apt-get install apt-transport-https\nsudo apt-get clean\nsudo apt-get update\n```\n\n### 安装Docker\n\n```plain\n# 卸载旧版本docker\nsudo apt-get remove docker docker-engine docker.io containerd runc\nsudo apt-get update\nsudo apt-get install \\\n    apt-transport-https \\\n    ca-certificates \\\n    curl \\\n    gnupg-agent \\\n    software-properties-common\n    \ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n# 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88)\nsudo apt-key fingerprint 0EBFCD88\n```\n\n编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存\n\n```plain\n# https://docs.docker.com/engine/install/ubuntu/\ndeb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable\n```\n\n安装 docker\n\n```plain\nsudo apt-get update\n# 安装Docker\nsudo apt-get install docker-ce docker-ce-cli containerd.io\n# 安装成功，查看版本\ndocker --version\nDocker version 19.03.12, build 48a6621\n```\n\n## 在Dockerhub上查找已有的arm镜像\n\n实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以[postgres](https://hub.docker.com/_/postgres?fileGuid=0l3NVKX0BgflYN3R)为例，在dockerhub上可以看到\n\n![图片](https://uploader.shimo.im/f/mEUtglSoqQESjJXs.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R)\n\n在具体的tag中也可以看到版本的镜像是否支持arm架构\n\n![图片](https://uploader.shimo.im/f/nUbvEcHQlUFCmAkl.png!thumbnail?fileGuid=0l3NVKX0BgflYN3R)\n\n但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。\n\n## ARM版本镜像构建（非ARM机器上执行）\n\n>参考：\n>-[https://github.com/docker/cli/blob/master/experimental/README.md](https://github.com/docker/cli/blob/master/experimental/README.md?fileGuid=0l3NVKX0BgflYN3R)\n>-[跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R)\n\n### 构建ARM镜像的两种方式\n\n对于构建镜像的ARM版本，有如下两种方式：\n\n1. 在ARM机器上使用 docker build 进行构建；\n2. 在X86/AMD64 的机器上使用 docker buildx 进行交叉构建；\n\n实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；\n\n关于第二种构建方式，可先阅读[跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R)进行了解，以下简要介绍使用buildx交叉构建的方式；\n\n> **⚠️注意：**\n>\n> 1. 交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；\n>\n> 2. 实际测试发现，使用[qemu方式](https://github.com/multiarch/qemu-user-static)在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；\n>\n>    上面第二点按如下方式测试： \n>\n>    * `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch` 可正常输出；\n>    * `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version` 则会**卡住**，且需要使用`docker stop`停止容器才可以退出容器；\n\n### 启用试验性功能\n\n>参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features\n>注意：buildx 仅支持 docker19.03 及以上docker版本\n\n如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：\n\n* 编辑   /etc/docker/daemon.json\n* 添加：\n\n```json\n{\n    \"experimental\": true\n}\n```\n\n* 编辑 ～/.docker/config.json 添加：\n\n```json\n\"experimental\" : \"enabled\"\n```\n\n* 重启Docker使生效：\n  * sudo systemctl  daemon-reload\n  * sudo systemctl  restart docker\n* 确认是否开启：\n  * docker version -f'{{.Server.Experimental}}'\n  * 如果输出true，则表示开启成功\n\n### 使用buildx构建\n\nbuildx 的详细使用可参考：[Docker官方文档-Reference-buildx ](https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R)\n\n#### 创建 buildx 构建器\n\n使用 docker buildx ls 命令查看现有的构建器\n\n```shell\ndocker buildx ls\n```\n\n创建并构建器：\n\n```shell\n# 下面的创建命令任选一条符合情况的即可\n# 1. 不指定任何参数创建\ndocker buildx create --use --name multiarch-builder\n# 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令\ndocker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder\n# 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 \ndocker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder \n```\n\nbuildx-config.toml 配置文件写法类似：\n\n```plain\n# https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md\n# registry configures a new Docker register used for cache import or output.\n[registry.\"zh-registry.geostar.com.cn\"]\n  mirrors = [\"zh-registry.geostar.com.cn\"]\n  http = true\n  insecure = true\n```\n\n**启用构建器**\n\n```shell\n# 初始化并激活\ndocker buildx inspect multiarch-builder --bootstrap\n```\n\n**确认成功**\n\n```plain\n# 使用 docker buildx ls 查看\ndocker buildx ls \n```\n\n### 修改Dockerfile\n\n对 Dockerfile 的修改，大致需要进行如下操作：\n\n1. 确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译；\n2. 确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件\n\n`ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz`\n\n此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：\n\n`ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz`\n\n当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；\n\n> **提示：**\n>\n> 怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 `file {可执行文件路径}` 来查看，\n>\n> 如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-`x86_64&arm64e`：\n>\n> ```shell\n> file $(which git)\n> /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]\n> /usr/bin/git (for architecture x86_64):\tMach-O 64-bit executable x86_64\n> /usr/bin/git (for architecture arm64e):\tMach-O 64-bit executable arm64e\n> ```\n>\n> 下面的命令则对一个so文件执行了file，可以看到其中的架构信息 `ARM aarch64`：\n>\n> ```shell\n> file /lib/aarch64-linux-gnu/libpthread-2.23.so\n> /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped\n> ```\n\n### docker buildx 构建arm64镜像的命令\n\n使用 --platform来指定架构，使用 `--push` 或 `--load` 来指定构建完毕后的动作。\n\n```shell\ndocker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push \n```\n\n> 提示：当指定多个架构时，只能使用 --push 推送到远程仓库，无法 --load，推送成功后再通过 docker pull --platform 来拉取指定架构的镜像\n\n### 检查构建成果\n\n1. 通过 `docker buildx imagetools inspect` 命令查看镜像信息，看是否有对应的arm架构信息；\n2. 实际运行镜像，确认运行正常；（在arm机器上执行）\n\n>提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。\n\n\n\n## 在x86上运行arm镜像\n\n可参考 [github/qemu-user-static](https://github.com/multiarch/qemu-user-static) ,简要描述如下：\n\n* 执行如下命令安装：\n\n  `docker run --rm --privileged multiarch/qemu-user-static --reset -p yes`\n\n* 之后即可运行arm版本的镜像，如：\n\n  ```shell\n  docker run --rm -t arm64v8/fedora uname -m\n  ```\n\n  \n\n\n\n\n\n# GeoPanel容器化-PGspider镜像构建\n\n## 概览\n\npostgreSQL是一个开源的对象-关系型数据库管理系统，本身提供了x86及arm版本的镜像，那么我们为什么要自己构建对应呢？\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210319141649.png\" alt=\"image-20210319141649673\" style=\"zoom: 50%;\" />\n\n因为我们需要使用[pgspider](https://github.com/pgspider/pgspider)，它是给予pg11.6的代码补丁包，所以我们无法直接复用官方的镜像作为基础镜像；\n\n同时，我们还添加了许多pg的插件用于扩展pg的能力，如此，我们必须自行打包pg镜像；\n\n### 镜像需要包括的组件：\n\n| 组件                 | 说明                                                        |\n| -------------------- | ----------------------------------------------------------- |\n| postgis11.6          | postgreSQL                                                  |\n| pgspider             | postgreSQL源码补丁，增强FDW功能                             |\n| postgis2.5.3及其依赖 | postgres gis 插件，用于提供geometry相关支持                 |\n| postgres_fdw         | postgres_fdw 接入外部postgres数据源                         |\n| sqlite_fdw           | sqlite_fdw 接入外部sqlite数据源                             |\n| mysql_fdw            | mysql_fdw 接入外部mysql数据源                               |\n| oracle_fdw           | oracle_fdw 接入外部oracle数据源                             |\n| zdb(es_fdw)          | es_fdw 接入外部es数据源                                     |\n| debezium             | 数据库事件转为事件流，配合kafka使用，实现数据实时同步       |\n| wal2json             | pg 日志格式转换插件，配合debezium使用，以json格式推送事件流 |\n\n\n\n### 整体构建流程\n\n为了构建此镜像，我们制作了若干辅助镜像，包括：\n\n```mermaid\ngraph \nbuilder\n\npgspider-base\n\npostgis-pgspider\n```\n\n其中:\n\n* `builder` 镜像为我们的构建器镜像，用做pgspider的编译环境，其中包含pg11.6源码及pgspider源码，及编译好的pg及pgspider，但是我们并未对成果物进行提取，因为此进行要保留所有构建环境，用于后续其他我们附加到pg的插件的构建；\n* `pgspider-base` 镜像中安装postgres运行所需要的若干依赖，作为最终镜像构建的基础，避免每次构建镜像都需要执行重复的依赖安装操作；\n* `postgis-pgspider` 为我们的最终镜像；基于`pgspider-base`镜像制作，并合并我们使用 `builder` 镜像构建的所有需要的成果文件；\n\n接下来我们详细说明以上几个镜像分别如何构建。\n\n\n\n### 现在成果仓库\n\nGitlab仓库地址：[geopanel-deploy](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider)\n\n> 提示： 可查看[仓库目录中的README.md](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/tree/master/build/pgspider) 了解更多信息；\n\n目录结构如下：\n\n```shell\npgspider\n    ├── Dockerfile-base.dockerfile - 构建pgspider-base镜像的脚本\n    ├── Dockerfile-builder.dockerfile - 构建pgspider-builder镜像的脚本\n    ├── Dockerfile-source-arm-add.dockerfile - 构建postgis-pgspider镜像的脚本（用于增量构建）\n    ├── Dockerfile-source-arm.dockerfile - 构建postgis-pgspider镜像的脚本\n    ├── Dockerfile-source.dockerfile - 构建postgis-pgspider镜像的脚本\n    ├── README.md\n    ├── binary - 我方有修改的预编译的fdw（x86架构）\n    │   ├── mysql_fdw\n    │   │   ├── mysql_fdw--1.1.sql\n    │   │   ├── mysql_fdw.control\n    │   │   └── mysql_fdw.so\n    │   ├── oracle\n    │   │   └── oracle_fdw.so\n    │   └── zdblibs\n    │       ├── zombodb--1.0.0a1--1.0.0a2.sql\n    │       ├── zombodb--1.0.0a2--1.0.0a3.sql\n    │       ├── zombodb--1.0.0a3--1.0.0a4.sql\n    │       ├── zombodb--1.0.0a4--1.0.0a5.sql\n    │       ├── zombodb--1.0.0a5--1.0.0a6.sql\n    │       ├── zombodb--1.0.0a6--1.0.0a7.sql\n    │       ├── zombodb--1.0.0a7--1.0.0a8.sql\n    │       ├── zombodb--1.0.0a8--1.0.0a9.sql\n    │       ├── zombodb--1.0.0a9--10-1.0.0a9.sql\n    │       ├── zombodb--10-1.0.0--10-1.0.1.sql\n    │       ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql\n    │       ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql\n    │       ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql\n    │       ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql\n    │       ├── zombodb--10-1.0.0b12--10-1.0.0.sql\n    │       ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql\n    │       ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql\n    │       ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql\n    │       ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql\n    │       ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql\n    │       ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql\n    │       ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql\n    │       ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql\n    │       ├── zombodb--10-1.0.1--10-1.0.2.sql\n    │       ├── zombodb--10-1.0.2--10-1.0.3.sql\n    │       ├── zombodb--10-1.0.3--10-1.0.4.sql\n    │       ├── zombodb--10-1.0.4--10-1.0.5.sql\n    │       ├── zombodb--10-1.0.5--4.0.sql\n    │       ├── zombodb--4.0.sql\n    │       ├── zombodb.control\n    │       └── zombodb.so\n    ├── binary-arm 我方有修改的预编译的fdw（arm架构）\n    │   ├── mysql_fdw\n    │   │   ├── mysql_fdw--1.1.sql\n    │   │   ├── mysql_fdw.control\n    │   │   └── mysql_fdw.so\n    │   └── zdblibs\n    │       ├── zombodb--1.0.0a1--1.0.0a2.sql\n    │       ├── zombodb--1.0.0a2--1.0.0a3.sql\n    │       ├── zombodb--1.0.0a3--1.0.0a4.sql\n    │       ├── zombodb--1.0.0a4--1.0.0a5.sql\n    │       ├── zombodb--1.0.0a5--1.0.0a6.sql\n    │       ├── zombodb--1.0.0a6--1.0.0a7.sql\n    │       ├── zombodb--1.0.0a7--1.0.0a8.sql\n    │       ├── zombodb--1.0.0a8--1.0.0a9.sql\n    │       ├── zombodb--1.0.0a9--10-1.0.0a9.sql\n    │       ├── zombodb--10-1.0.0--10-1.0.1.sql\n    │       ├── zombodb--10-1.0.0a9--10-1.0.0b1.sql\n    │       ├── zombodb--10-1.0.0b1--10-1.0.0b2.sql\n    │       ├── zombodb--10-1.0.0b10--10-1.0.0b11.sql\n    │       ├── zombodb--10-1.0.0b11--10-1.0.0b12.sql\n    │       ├── zombodb--10-1.0.0b12--10-1.0.0.sql\n    │       ├── zombodb--10-1.0.0b2--10-1.0.0b3.sql\n    │       ├── zombodb--10-1.0.0b3--10-1.0.0b4.sql\n    │       ├── zombodb--10-1.0.0b4--10-1.0.0b5.sql\n    │       ├── zombodb--10-1.0.0b5--10-1.0.0b6.sql\n    │       ├── zombodb--10-1.0.0b6--10-1.0.0b7.sql\n    │       ├── zombodb--10-1.0.0b7--10-1.0.0b8.sql\n    │       ├── zombodb--10-1.0.0b8--10-1.0.0b9.sql\n    │       ├── zombodb--10-1.0.0b9--10-1.0.0b10.sql\n    │       ├── zombodb--10-1.0.1--10-1.0.2.sql\n    │       ├── zombodb--10-1.0.2--10-1.0.3.sql\n    │       ├── zombodb--10-1.0.3--10-1.0.4.sql\n    │       ├── zombodb--10-1.0.4--10-1.0.5.sql\n    │       ├── zombodb--10-1.0.5--4.0.sql\n    │       ├── zombodb--4.0.sql\n    │       ├── zombodb.control\n    │       └── zombodb.so\n    ├── config - 数据库配置文件\n    │   ├── pg_hba.conf\n    │   ├── pg_hba.conf.raw\n    │   └── postgresql.conf\n    ├── debezium - debezium插件的源码及wal2json的源码\n    │   ├── README.md\n    │   ├── init-debezium.sh\n    │   ├── postgres-decoderbufs.tar.gz\n    │   ├── test.sql\n    │   └── wal2json-wal2json_1_0.tar.gz\n    ├── docker-entrypoint.sh - 入口启动脚本\n    ├── draft - 临时文件，可忽略\n    │   ├── Dockerfile\n    │   ├── Dockerfile-all-in-one.dockerfile\n    │   ├── Dockerfile-apt.dockerfile\n    │   ├── Dockerfile-postGIS.dockerfile\n    │   └── README.md\n    ├── initdb-fdw.sh - 初始化fdws脚本\n    ├── oracle\n    │   ├── instantclient-basic-linux.x64-12.2.0.1.0.zip\n    │   ├── instantclient-sdk-linux.x64-12.2.0.1.0.zip\n    │   ├── instantclient-sqlplus-linux.x64-12.2.0.1.0.zip\n    │   └── oracle_fdw-ORACLE_FDW_2_2_0.tar.gz\n    ├── postgis - postgis及其依赖库源码及初始化脚本\n    │   ├── CGAL-4.11.2.tar.xz\n    │   ├── SFCGAL-1.3.5.tar.gz\n    │   ├── boost_1_67_0.tar.gz\n    │   ├── gdal-3.0.2.tar.gz\n    │   ├── geos-3.8.0.tar.bz2\n    │   ├── initdb-postgis.sh\n    │   ├── libspatialite-4.3.0a.tar.gz\n    │   ├── mpfr-4.0.2.tar.gz\n    │   ├── postgis-2.5.2.tar.gz\n    │   ├── postgis-2.5.3.tar.gz\n    │   ├── proj-6.2.0.tar.gz\n    │   └── update-postgis.sh\n    └── test.sql - 测试是否正常工作的sql文件\n\n```\n\n\n\n## builder镜像构建\n\nbuilder镜像的打包脚本为 `Dockerfile-builder.dockerfile`，我们使用相同的脚本构建arm及x86版本的镜像；\n\n### 打包命令\n\n```shell\nTAG=$(date +%Y%m%d)\n# X86 镜像构建\ndocker build -t pgspider-builder:$TAG -f Dockerfile-builder.dockerfile ./\n## arm\ndocker buildx build \\\n      --progress plain \\\n      --platform=linux/arm64 \\\n      -t pgspider-builder-arm:latest \\\n      -f Dockerfile-builder.dockerfile ./ --load\n```\n\n### 脚本详解\n\n> 文件地址： [Dockerfile-builder.dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-builder.dockerfile)\n\n脚本内容如下，请查看脚本中的注释：\n\n这里需要注意的是，我们编译后的成果其实位于 `/usr/local/pgspider` 目录中，这个后面会用到；\n\n```dockerfile\n#\n# pgspider 源码构建镜像，包含pgspider源码及中间临时成果，用于后续构建其他fdw及提取pgspider可运行镜像\n#\n## 使用 debian:stretch-slim 作为基础\nFROM debian:stretch-slim\nRUN apt-get update && apt-get install -y build-essential git libossp-uuid-dev wget libreadline-dev  zlib1g-dev\n## 设置工作目录为app\nWORKDIR /app\n## \n# 来源 https://github.com/docker-library/postgres/blob/master/11/Dockerfile\n## 配置locales为en_US.utf8\nRUN set -eux; \\\n   if [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \\\n       # if this file exists, we're likely in \"debian:xxx-slim\", and locales are thus being excluded so we need to remove that exclusion (since we need locales)\n       grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\\n       sed -ri '/\\/usr\\/share\\/locale/d' /etc/dpkg/dpkg.cfg.d/docker; \\\n       ! grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\\n   fi; \\\n   apt-get update; apt-get install -y locales; rm -rf /var/lib/apt/lists/*; \\\n   localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8\nENV LANG en_US.utf8\n\n## 安装所需依赖\nRUN set -eux; \\\n   apt-get update; \\\n# install \"nss_wrapper\" in case we need to fake \"/etc/passwd\" and \"/etc/group\" (especially for OpenShift)\n# https://github.com/docker-library/postgres/issues/359\n# https://cwrap.org/nss_wrapper.html\n   apt-get install -y --no-install-recommends libnss-wrapper; \\\n   rm -rf /var/lib/apt/lists/*\n  \n## 获取pg11.6源码\nRUN wget https://ftp.postgresql.org/pub/source/v11.6/postgresql-11.6.tar.gz\n## 获取pgspider的补丁包\nRUN wget https://raw.githubusercontent.com/pgspider/pgspider/master/pgspider.patch\n## 解压pg\nRUN tar xvf postgresql-11.6.tar.gz\n## 应用pgspider源码补丁包到pg源码\nRUN patch -p1 -d postgresql-11.6 < /app/pgspider.patch\n## 开始执行编译，可参考pgspider github页面\nRUN cd postgresql-11.6 \\\n   && ./configure --with-uuid=ossp \\\n   ## 编译PG并install\n   && make && make install \\\n   ## 编译pgspider_core_fdw 并install\n   && cd /app/postgresql-11.6/contrib/pgspider_core_fdw \\\n   && make && make install \\\n   ## 编译 pgspider_fdw 并install\n   && cd /app/postgresql-11.6/contrib/pgspider_fdw \\\n   && make && make install \\\n   ## 编译postgres_fdw并install\n   && cd /app/postgresql-11.6/contrib/postgres_fdw \\\n   && make && make install \\\n   ## 编译contrib并install\n   && cd /app/postgresql-11.6/contrib \\\n   && make && make install\nENV PATH $PATH:/usr/local/pgspider/bin\n```\n\n\n\n## base镜像构建\n\nbase 镜像的打包脚本为 `Dockerfile-base.dockerfile`，我们使用相同的脚本构建arm及x86版本的镜像；\n\n### 打包命令\n\n```shell\nTAG=$(date +%Y%m%d)\n# 打包x86版本\ndocker build -t pgspider-base:$TAG -f Dockerfile-base.dockerfile ./\n## arm\ndocker buildx build \\\n      --progress plain \\\n      --platform=linux/arm64 \\\n      -t pgspider-base-arm:$TAG \\\n      -f Dockerfile-base.dockerfile ./ --load\n      \n## 也可使用一条命令构建两个版本的镜像，此时必须在镜像tag中包含可用的docker registry地址，并且使用 `--push` 参数在打包完成后推送镜像到registry\n## 完成后再拉取到本地进行测试\ndocker buildx build \\\n      --progress plain \\\n      --platform=linux/arm64,linux/amd64 \\\n      -t hanlyjiang/pgspider-base-arm:$TAG \\\n      -f Dockerfile-base.dockerfile ./ --push\n```\n\n\n\n### 脚本详解\n\n> 脚本在线地址： [gitlab](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/Dockerfile-base.dockerfile)\n\n```dockerfile\n#\n# PGSpider 基础镜像\n# 1. 安装需要的依赖，避免后续每次构建时都需要安装（依赖部分可能需要精简）\n# 2. 添加对应的postgres用户\nFROM debian:stretch-slim\n\n## 安装必要依赖\nRUN set -ex; \\\n\tif ! command -v gpg > /dev/null; then \\\n\t\tapt-get update; \\\n\t\tapt-get install -y --no-install-recommends \\\n\t\t\tgnupg \\\n\t\t\tdirmngr \\\n\t\t; \\\n\t\trm -rf /var/lib/apt/lists/*; \\\n\tfi\n\n## 安装依赖，并创建pg需要的用户及组id，创建pg需要的目录并赋予对应的组和id改目录的权限\n# explicitly set user/group IDs\nRUN set -eux; \\\n\tgroupadd -r postgres --gid=999; \\\n# https://salsa.debian.org/postgresql/postgresql-common/blob/997d842ee744687d99a2b2d95c1083a2615c79e8/debian/postgresql-common.postinst#L32-35\n\tuseradd -r -g postgres --uid=999 --home-dir=/var/lib/postgresql --shell=/bin/bash postgres; \\\n# also create the postgres user's home directory with appropriate permissions\n# see https://github.com/docker-library/postgres/issues/274\n\tmkdir -p /var/lib/postgresql; \\\n\tchown -R postgres:postgres /var/lib/postgresql\n\n## 添加 gosu 用于后续方便使从root降权限\n# grab gosu for easy step-down from root\n# https://github.com/tianon/gosu/releases\nENV GOSU_VERSION 1.12\nRUN set -eux; \\\n\tsavedAptMark=\"$(apt-mark showmanual)\"; \\\n\tapt-get update; \\\n\tapt-get install -y --no-install-recommends ca-certificates wget; \\\n\trm -rf /var/lib/apt/lists/*; \\\n\tdpkgArch=\"$(dpkg --print-architecture | awk -F- '{ print $NF }')\"; \\\n\twget -O /usr/local/bin/gosu \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch\"; \\\n\twget -O /usr/local/bin/gosu.asc \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc\"; \\\n\texport GNUPGHOME=\"$(mktemp -d)\"; \\\n\tgpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \\\n\tgpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \\\n\tgpgconf --kill all; \\\n\trm -rf \"$GNUPGHOME\" /usr/local/bin/gosu.asc; \\\n\tapt-mark auto '.*' > /dev/null; \\\n\t[ -z \"$savedAptMark\" ] || apt-mark manual $savedAptMark > /dev/null; \\\n\tapt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \\\n\tchmod +x /usr/local/bin/gosu; \\\n\tgosu --version; \\\n\tgosu nobody true\n\n## 配置locale\n# make the \"en_US.UTF-8\" locale so postgres will be utf-8 enabled by default\nRUN set -eux; \\\n\tif [ -f /etc/dpkg/dpkg.cfg.d/docker ]; then \\\n# if this file exists, we're likely in \"debian:xxx-slim\", and locales are thus being excluded so we need to remove that exclusion (since we need locales)\n\t\tgrep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\\n\t\tsed -ri '/\\/usr\\/share\\/locale/d' /etc/dpkg/dpkg.cfg.d/docker; \\\n\t\t! grep -q '/usr/share/locale' /etc/dpkg/dpkg.cfg.d/docker; \\\n\tfi; \\\n\tapt-get update; apt-get install -y --no-install-recommends locales; rm -rf /var/lib/apt/lists/*; \\\n\tlocaledef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8\nENV LANG en_US.utf8\n\n## 安装必要依赖库\nRUN set -eux; \\\n\tapt-get update; \\\n\tapt-get install -y --no-install-recommends \\\n# install \"nss_wrapper\" in case we need to fake \"/etc/passwd\" and \"/etc/group\" (especially for OpenShift)\n# https://github.com/docker-library/postgres/issues/359\n# https://cwrap.org/nss_wrapper.html\n\t\tlibnss-wrapper \\\n# install \"xz-utils\" for .sql.xz docker-entrypoint-initdb.d files\n\t\txz-utils \\\n\t; \\\n\trm -rf /var/lib/apt/lists/*\n\n## 配置信任的gpg key\nRUN set -ex; \\\n# pub   4096R/ACCC4CF8 2011-10-13 [expires: 2019-07-02]\n#       Key fingerprint = B97B 0AFC AA1A 47F0 44F2  44A0 7FCC 7D46 ACCC 4CF8\n# uid                  PostgreSQL Debian Repository\n\tkey='B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8'; \\\n\texport GNUPGHOME=\"$(mktemp -d)\"; \\\n\tgpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys \"$key\"; \\\n\tgpg --batch --export \"$key\" > /etc/apt/trusted.gpg.d/postgres.gpg; \\\n\tcommand -v gpgconf > /dev/null && gpgconf --kill all; \\\n\trm -rf \"$GNUPGHOME\"; \\\n\tapt-key list\n\nENV PG_MAJOR 11\nENV GOSU_VERSION 1.11\n\n## 添加postgresql软件源仓库\nRUN set -ex; \\\n\t\\\n# see note below about \"*.pyc\" files\n\texport PYTHONDONTWRITEBYTECODE=1; \\\n\t\\\n\tdpkgArch=\"$(dpkg --print-architecture)\"; \\\n\tcase \"$dpkgArch\" in \\\n\t\tamd64 | i386 | ppc64el) \\\n# arches officialy built by upstream\n\t\t\techo \"deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR\" > /etc/apt/sources.list.d/pgdg.list; \\\n\t\t\techo \"apt-get update;\"; \\\n\t\t\t;; \\\n\t\t*) \\\n# we're on an architecture upstream doesn't officially build for\n# let's build binaries from their published source packages\n        echo \"deb-src http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main $PG_MAJOR\" > /etc/apt/sources.list.d/pgdg.list; \\\n        ;; \\\n\tesac;\n\n# 添加必要的工具及依赖\nRUN apt-get update && apt-get install -y --no-install-recommends unzip wget \\\n    libreadline-dev \\\n    libmongoc-1.0-0  \\\n    libmysql++-dev \\\n    libsqlite3-dev libspatialite7 \\\n    libsybdb5 \\\n    libhiredis-dev \\\n    freetds-dev freetds-common libcurl4-nss-dev unixodbc-dev  \\\n    # libaio-dev - oracle_fdw\n    libaio-dev \\\n    && rm -rf /var/lib/apt/lists/*;\n\n```\n\n\n\n## pgspider镜像构建\n\n对x86及arm架构，我们分别编写了对应的脚本，其中x86使用 Dockerfile-source.dockerfile 脚本构建，arm使用Dockerfile-source-arm.dockerfile脚本构建；\n\n### 构建命令\n\n```shell\nTAG=$(date +%Y%m%d)\ndocker build -t pgspider-postgis:$TAG -f Dockerfile-source.dockerfile ./\n## arm \ndocker buildx build \\\n      --progress plain \\\n      --build-arg --platform=linux/arm64 \\\n      -t pgspider-postgis:arm-$TAG \\\n      -f Dockerfile-source-arm.dockerfile ./ --load\n```\n\n### 脚本详解\n\n* pgspider 镜像构建的步骤较多，我们采取分步骤构建的方式使用中间构建过程来减小最终镜像的层数及大小；\n\n* 另外两个平台的构建脚本大体一致，仅有少数过程有差异，我们先使用x86版本的对整体过程进行说明，后面我们会说明两个平台之间的差异；\n\n#### x86 构建脚本\n\n> 提示：脚本中有多个FROM段，此为Docker多阶段构建可以通过[此文章](https://zhuanlan.zhihu.com/p/33795821)进行了解；\n\n主要过程如下：\n\n**第一阶段：**\n\n1. 从builder镜像开始，由于builder镜像中已经包含pg源码还有已经编好的pg及pgspider等，所以我们无需再编译这些；\n\n2. 编译 mysql_fdw 及 sqlite_fdw（注意，其中mysql_fdw其实可以不用了）\n\n3. 安装 oracle_fdw 所需要的依赖（oracle instant client）；\n\n4. 编译postgis，编译postgis需要先编译其依赖（mpfr，boost_1_67_0，CGAL等），这里我们将postgis的所有的依赖及其自身的安装路径都设置为 `/usr/local/pgspider/plugin/postgis`\n\n   ```shell\n   ENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis\n   ```\n\n5. 编译并安装 debezium及wal2json；\n\n6. 使用strip对postgis目录中的所有so库进行大小优化\n\n7. 将预先编译好的 几个fdw的so及配置及sql文件拷贝到指定目录以安装或更新这些fdw；\n\n**第二阶段：**\n\n1. 从 pgspider-base 镜像开始构建；\n2. 安装必要的依赖；\n3. 从第一阶段拷贝出oracle_instantclient的依赖；（arm版本无此步骤，因为oracle_instantclient不支持arm架构）\n4. 从第一阶段拷贝出 /usr/local/pgspider 目录，其中包含了我们之前编译的的成果；\n5. 添加各种初始化脚本，并为pg运行做必要的准备，可以参考官方dockerfile；\n6. 最后使用 EXPOSE 暴露 5432端口，使用 CMD [\"postgres\"] 默认启动pg；\n\n```dockerfile\n# ---\n# 构建融合中心pg镜像(从源码构建）：\n# 1. 构建pgspider（pgspider-base镜像中包含）\n# 2. 添加若干fdw：mysql_fdw,oracle_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中）\n# 3. 添加 postgis\n#\n# 参考：\n# - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one\n# ---\n## 构建 sqlite_fdw  mysql_fdw  oracle_fdw\n#FROM pgspider-builder as build\nFROM hanlyjiang/pgspider-builder as build\n\nWORKDIR /app\n\n## PG 主版本\nENV PG_MAJOR 11\nENV PG_VERSION 6\n\n## 安装构建所需的依赖\nRUN apt-get update \\\n    && apt-get install -y automake autoconf libtool pkg-config libssl-dev \\\n    libsqlite3-dev libsybdb5 freetds-dev freetds-common \\\n    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \\\n    # for oracle\n    unzip \\\n#    libmysql++-dev\n    libmysql++-dev \\\n    # libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7\n    libspatialite7\n#    postgresql-${PG_MAJOR}-python-multicorn python-pip\n\n## 安装 sqlite_fdw\nRUN git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw\nRUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw && make && make install\n\n## 安装 mysql_fdw\nRUN git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw\nRUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw && make && make install\n\n## 安装 Install es_fdw\n#RUN pip install pg_es_fdw\n\n## 安装 oracle_fdw\n### 安装oracle instantclient\n# https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle\nADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip\nADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip\nADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip\nRUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/\nRUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/\nRUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/\nRUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient\nRUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so\nRUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus\nENV ORACLE_HOME=/usr/local/instantclient\nENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient\n\n#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \\\nADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/\nRUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\\n    && cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\\n    && make && make install\n\n##  POSTGIS 构建\n### 安装依赖\nRUN apt-get install  -y --no-install-recommends \\\n    libtool libxml2 libxml2-dev \\\n    libxslt1.1 libxslt1-dev \\\n    libjson-c-dev libgmp-dev \\\n    cmake libmpfr-dev\n\n### 创建临时工作目录\nRUN mkdir /app/postgis/\nENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis\nENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib\nENV PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH\n\n### 构建 mpfr\nADD postgis/mpfr-4.0.2.tar.gz /app/postgis/\nRUN cd /app/postgis/mpfr-4.0.2 \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH \\\n    && make && make install\n\n### 构建 boost\nADD postgis/boost_1_67_0.tar.gz /app/postgis/\nRUN cd /app/postgis/boost_1_67_0  \\\n    && ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH && ./b2 && ./b2 install\n\n### 构建 CGAL\nADD postgis/CGAL-4.11.2.tar.xz /app/postgis/\nRUN cd /app/postgis/CGAL-4.11.2  \\\n    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install\n\n### 构建 SFCGAL\nADD postgis/SFCGAL-1.3.5.tar.gz /app/postgis/\nRUN cd /app/postgis/SFCGAL-1.3.5 \\\n    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install\n\n### 构建 proj，需要先安装sqlite3\nRUN apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev\nADD postgis/proj-6.2.0.tar.gz /app/postgis/\nRUN cd /app/postgis/proj-6.2.0  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH && make -j$(nproc) && make install\n\n### 构建 gdal\nADD postgis/gdal-3.0.2.tar.gz /app/postgis/\nRUN cd /app/postgis/gdal-3.0.2  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH \\\n    # proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同\n        --with-proj=$PGIS_INSTALL_PATH \\\n    && make -j$(nproc) && make install\n\n### 构建 geos\nADD postgis/geos-3.8.0.tar.bz2 /app/postgis/\nRUN cd /app/postgis/geos-3.8.0  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH  \\\n    && make -j$(nproc) && make install\n\n### 构建 postgis\nADD postgis/postgis-2.5.3.tar.gz /app/postgis/\nRUN cd /app/postgis/postgis-2.5.3  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH \\\n    # 几个config命令直接配置PATH后可以找到，所以不在使用参数配置\n#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \\\n#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \\\n#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \\\n        --with-projdir=$PGIS_INSTALL_PATH \\\n    && make -j$(nproc) && make install\n\n\nRUN set -ex \\\n#    && sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\\n#    && sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\"  /etc/apt/sources.list \\\n    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev\n#    && echo \"deb http://deb.debian.org/debian stretch-backports main\" >>/etc/apt/sources.list \\\n    && apt-get update \\\n    && apt-get install -y --no-install-recommends \\\n      libprotobuf-c-dev \\\n#      postgresql-12-wal2json \\\n      protobuf-c-compiler \\\n      && rm -rf /var/lib/apt/lists/*\n\n## 添加 debezium https://github.com/eulerto/wal2json\nADD debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/\nRUN cd /app/debezium/wal2json-wal2json_1_0 \\\n    && make -j$(nproc) && make install\n\n## 添加 debezium - decoderbufs 研究院修改版本\nADD debezium/postgres-decoderbufs.tar.gz /app/debezium/\nRUN cd /app/debezium/postgres-decoderbufs \\\n    && cd proto \\\n    && protoc-c --c_out=../src/proto pg_logicaldec.proto \\\n    && cd .. \\\n    ## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean\n    && make -B -j$(nproc) && make install\n\n## 添加 debezium - decoderbufs 官方版本\n#ADD debezium/postgres-decoderbufs-v.1.3.1.Final.tar.gz /app/debezium/\n#RUN cd /app/debezium/postgres-decoderbufs-v.1.3.1.Final \\\n#    && make -j$(nproc) && make install\n\n### 对构建postgis过程中生成的文件进行优化，以减小大小\n#### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化\nRUN cd $PGIS_INSTALL_PATH/lib \\\n    && rm *.a \\\n    && find . -type f -name \"lib*.so.*\" -exec strip {} +\n#    && cd /usr/local/pgspider/plugin/proj/lib \\\n#    && rm *.a && find . -type f -name \"lib*.so.*\" -exec strip {} +\n\n## 拷贝mysql\nCOPY binary/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/\nCOPY binary/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/\nCOPY binary/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/\n## 拷贝zombodb\nCOPY binary/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/\nCOPY binary/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/\nCOPY binary/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/\n\n## 拷贝oracle fdw\nCOPY binary/oracle/*.so           /usr/local/pgspider/lib/postgresql/\n\n# ------ 开始构建实际发布的镜像 ------\nFROM hanlyjiang/pgspider-base:latest\nLABEL maintainer=\"jianghanghang@geostar.com.cn\"\n\n## 设置若干ENV，指示版本信息\n# buster 上为12 ，stretch 上为 12\n# ENV CDAL_VERSION 12\nENV BOOST_VERSION=1.67.0 \\\n    PG_MAJOR=11 \\\n    PG_VERSION=6 \\\n    POSTGIS_VESION=2.5.3\n\n## 安装必要的依赖（TODO: 部分依赖可能不需要）\nRUN set -ex \\\n#    && sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\\n#    && sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\"  /etc/apt/sources.list \\\n    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev\n#    && echo \"deb http://deb.debian.org/debian stretch-backports main\" >>/etc/apt/sources.list \\\n    && apt-get update \\\n    && apt-get install -y --no-install-recommends \\\n      curl \\\n      libcurl3-gnutls \\\n      libexpat1 \\\n      libgmp10 \\\n      libgmpxx4ldbl \\\n      libjson-c3 \\\n      # buster 上为6，stretch上为4\n#      libmpfr6 \\\n#      libmpfr4 \\\n      libprotobuf-c1 \\\n      libtiff5 \\\n      libxml2 \\\n      # for debezium\n      postgresql-12-wal2json \\\n      libprotobuf-c-dev \\\n      && rm -rf /var/lib/apt/lists/*\n\n## 安装oracle_fdw需要的 Oracle instantclient\n### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle\nCOPY --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2\nRUN set -ex \\\n    && ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \\\n    && ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus\n\n## 设置若干运行需要的环境变量\nENV ORACLE_HOME=/usr/local/instantclient \\\n    PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis\nENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \\\n    PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH\n## 拷贝构建好的成果\nCOPY --from=build  /usr/local/pgspider /usr/local/pgspider\n## 入口脚本添加\nCOPY docker-entrypoint.sh /usr/local/bin/\nRUN mkdir /docker-entrypoint-initdb.d \\\n    && chmod +x /usr/local/bin/docker-entrypoint.sh \\\n    && ln -s usr/local/bin/docker-entrypoint.sh /\n\n## postgis 脚本添加\n### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template\nCOPY ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh\nCOPY ./postgis/update-postgis.sh /usr/local/bin\n## 添加扩展初始化脚本\nCOPY ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh\nCOPY ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh\n\n## make the sample config easier to munge (and \"correct by default\")\nRUN sed -ri \"s!^#?(listen_addresses)\\s*=\\s*\\S+.*!\\1 = '*'!\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \\\n   grep -F \"listen_addresses = '*'\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample\n\nRUN mkdir -p /var/run/postgresql && chown -R postgres:postgres /var/run/postgresql  && chmod 2777 /var/run/postgresql\n\nENV PGDATA /var/lib/postgresql/data\n## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary \"--user\" values)\nRUN mkdir -p \"$PGDATA\" && chown -R postgres:postgres \"$PGDATA\" && chmod 777 \"$PGDATA\"\nVOLUME /var/lib/postgresql/data\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n\n# COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile\n# We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL\n# calls \"Fast Shutdown mode\" wherein new connections are disallowed and any\n# in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and\n# flush tables to disk, which is the best compromise available to avoid data\n# corruption.\n#\n# Users who know their applications do not keep open long-lived idle connections\n# may way to use a value of SIGTERM instead, which corresponds to \"Smart\n# Shutdown mode\" in which any existing sessions are allowed to finish and the\n# server stops when all sessions are terminated.\n#\n# See https://www.postgresql.org/docs/12/server-shutdown.html for more details\n# about available PostgreSQL server shutdown signals.\n#\n# See also https://www.postgresql.org/docs/12/server-start.html for further\n# justification of this as the default value, namely that the example (and\n# shipped) systemd service files use the \"Fast Shutdown mode\" for service\n# termination.\n#\nSTOPSIGNAL SIGINT\n\n# An additional setting that is recommended for all users regardless of this\n# value is the runtime \"--stop-timeout\" (or your orchestrator/runtime's\n# equivalent) for controlling how long to wait between sending the defined\n# STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).\n#\n# The default in most runtimes (such as Docker) is 10 seconds, and the\n# documentation at https://www.postgresql.org/docs/12/server-start.html notes\n# that even 90 seconds may not be long enough in many instances.\nEXPOSE 5432\nCMD [\"postgres\"]\n```\n\n### ARM版本构建脚本\n\n与x86版本不同之处在于：\n\n1. from的镜像不同，一个是x86版本，一个是arm版本；\n2. arm版本不包含oracle_fdw 构建的相关步骤；\n\n```dockerfile\n# ---\n# 构建融合中心pg镜像-armb版本(从源码构建）：\n# 1. 构建pgspider（pgspider-base镜像中包含）\n# 2. 添加若干fdw：mysql_fdw,sqlite_fdw,postgres_fdw（postgres_fdw包含于pgspider-base镜像中）\n# 3. 添加 postgis\n#\n# 参考：\n# - https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one\n# ---\n## 构建 sqlite_fdw  mysql_fdw\nFROM zh-registry.geostar.com.cn/geopanel/pgspider-builder-arm:latest as build\n\nWORKDIR /app\n\n## PG 主版本\nENV PG_MAJOR 11\nENV PG_VERSION 6\n\n## 安装构建所需的依赖\nRUN apt-get update \\\n    && apt-get install -y automake autoconf libtool pkg-config libssl-dev \\\n    libsqlite3-dev libsybdb5 freetds-dev freetds-common \\\n    libhiredis-dev libcurl4-nss-dev unixodbc-dev libaio-dev \\\n    # for oracle\n    unzip \\\n#    libmysql++-dev\n    libmysql++-dev \\\n    # libspatialite sqlite 空间数据支持 - https://packages.debian.org/stretch/libspatialite7\n    libspatialite7\n#    postgresql-${PG_MAJOR}-python-multicorn python-pip\n\n## 安装 sqlite_fdw\nRUN git clone https://github.com/pgspider/sqlite_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw\nRUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/sqlite_fdw && make && make install\n\n## 安装 mysql_fdw\nRUN git clone https://github.com/pgspider/mysql_fdw.git /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw\nRUN cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/mysql_fdw && make && make install\n\n## 安装 Install es_fdw\n#RUN pip install pg_es_fdw\n\n## 安装 oracle_fdw(arm 不支持)\n### 安装oracle instantclient\n# https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle\n#ADD oracle/instantclient-basic-linux.x64-12.2.0.1.0.zip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip\n#ADD oracle/instantclient-sdk-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip\n#ADD oracle/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip\n#RUN unzip /tmp/instantclient-basic-linux.x64-12.2.0.1.0.zip -d /usr/local/\n#RUN unzip /tmp/instantclient-sdk-linux.x64-12.2.0.1.0.zip -d /usr/local/\n#RUN unzip /tmp/instantclient-sqlplus-linux.x64-12.2.0.1.0.zip -d /usr/local/\n#RUN ln -s /usr/local/instantclient_12_2 /usr/local/instantclient\n#RUN ln -s /usr/local/instantclient/libclntsh.so.12.1 /usr/local/instantclient/libclntsh.so\n#RUN ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus\n#ENV ORACLE_HOME=/usr/local/instantclient\n#ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/instantclient\n\n#RUN wget -O /app/ORACLE_FDW_2_2_0.tar.gz https://github.com/laurenz/oracle_fdw/archive/ORACLE_FDW_2_2_0.tar.gz \\\n#ADD oracle/oracle_fdw-ORACLE_FDW_2_2_0.tar.gz /app/\n#RUN mv /app/oracle_fdw-ORACLE_FDW_2_2_0 /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\\n#    && cd /app/postgresql-${PG_MAJOR}.${PG_VERSION}/contrib/oracle_fdw \\\n#    && make && make install\n\n##  POSTGIS 构建\n### 安装依赖\nRUN apt-get install  -y --no-install-recommends \\\n    libtool libxml2 libxml2-dev \\\n    libxslt1.1 libxslt1-dev \\\n    libjson-c-dev libgmp-dev \\\n    cmake libmpfr-dev\n\n### 创建临时工作目录\nRUN mkdir /app/postgis/\nENV PGIS_INSTALL_PATH /usr/local/pgspider/plugin/postgis\nENV LD_LIBRARY_PATH $LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib\nENV PATH $PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH\n\n### 构建 mpfr\nADD postgis/mpfr-4.0.2.tar.gz /app/postgis/\nRUN cd /app/postgis/mpfr-4.0.2 \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH \\\n    && make && make install\n\n### 构建 boost\nADD postgis/boost_1_67_0.tar.gz /app/postgis/\nRUN cd /app/postgis/boost_1_67_0  \\\n    && ./bootstrap.sh -prefix=$PGIS_INSTALL_PATH && ./b2 && ./b2 install\n\n### 构建 CGAL\nADD postgis/CGAL-4.11.2.tar.xz /app/postgis/\nRUN cd /app/postgis/CGAL-4.11.2  \\\n    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install\n\n### 构建 SFCGAL\nADD postgis/SFCGAL-1.3.5.tar.gz /app/postgis/\nRUN cd /app/postgis/SFCGAL-1.3.5 \\\n    && cmake -DCMAKE_INSTALL_PREFIX=$PGIS_INSTALL_PATH . && make -j$(nproc) && make install\n\n### 构建 proj，需要先安装sqlite3\nRUN apt-get install  -y --no-install-recommends sqlite3 libsqlite3-dev\nADD postgis/proj-6.2.0.tar.gz /app/postgis/\nRUN cd /app/postgis/proj-6.2.0  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH && make -j$(nproc) && make install\n\n### 构建 gdal\nADD postgis/gdal-3.0.2.tar.gz /app/postgis/\nRUN cd /app/postgis/gdal-3.0.2  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH \\\n    # proj 无法直接找到，必须手动指定（可能是需要配置include），这里我们直接指定，postgis里面同\n        --with-proj=$PGIS_INSTALL_PATH \\\n    && make -j$(nproc) && make install\n\n### 构建 geos\nADD postgis/geos-3.8.0.tar.bz2 /app/postgis/\nRUN cd /app/postgis/geos-3.8.0  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH  \\\n    && make -j$(nproc) && make install\n\n### 构建 postgis\nADD postgis/postgis-2.5.3.tar.gz /app/postgis/\nRUN cd /app/postgis/postgis-2.5.3  \\\n    && ./configure --prefix=$PGIS_INSTALL_PATH \\\n    # 几个config命令直接配置PATH后可以找到，所以不在使用参数配置\n#        --with-pgconfig=/usr/local/pgspider/bin/pg_config \\\n#        --with-geosconfig=$$PGIS_INSTALL_PATH/bin/geos-config \\\n#        --with-gdalconfig=$$PGIS_INSTALL_PATH/bin/gdal-config \\\n        --with-projdir=$PGIS_INSTALL_PATH \\\n    && make -j$(nproc) && make install\n\nRUN set -ex \\\n#    && sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\\n#    && sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\"  /etc/apt/sources.list \\\n    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev\n#    && echo \"deb http://deb.debian.org/debian stretch-backports main\" >>/etc/apt/sources.list \\\n    && apt-get update \\\n    && apt-get install -y --no-install-recommends \\\n      libprotobuf-c-dev \\\n#      postgresql-12-wal2json \\\n      protobuf-c-compiler \\\n      && rm -rf /var/lib/apt/lists/*\n\n## 添加 debezium https://github.com/eulerto/wal2json\nADD debezium/wal2json-wal2json_1_0.tar.gz /app/debezium/\nRUN cd /app/debezium/wal2json-wal2json_1_0 \\\n    && make -j$(nproc) && make install\n\n## 添加 debezium - decoderbufs 研究院修改版本\nADD debezium/postgres-decoderbufs.tar.gz /app/debezium/\nRUN cd /app/debezium/postgres-decoderbufs \\\n    && cd proto \\\n    && protoc-c --c_out=../src/proto pg_logicaldec.proto \\\n    && cd .. \\\n    ## make -B： 研究院提供的包中可能带有之前make的成果，此时不会重新构建，所以我们使用 -B 来强制重新构建，也可以先执行 make clean\n    && make -B -j$(nproc) && make install\n\n### 对构建postgis过程中生成的文件进行优化，以减小大小\n#### 1. 移除静态链接库文件；2. 使用strip命令对动态链接库so文件进行符号表优化\nRUN cd $PGIS_INSTALL_PATH/lib \\\n    && rm *.a \\\n    && find . -type f -name \"lib*.so.*\" -exec strip {} +\n#    && cd /usr/local/pgspider/plugin/proj/lib \\\n#    && rm *.a && find . -type f -name \"lib*.so.*\" -exec strip {} +\n\n## 拷贝mysql\nCOPY binary-arm/mysql_fdw/*.sql         /usr/local/pgspider/share/postgresql/extension/\nCOPY binary-arm/mysql_fdw/*.control    /usr/local/pgspider/share/postgresql/extension/\nCOPY binary-arm/mysql_fdw/*.so         /usr/local/pgspider/lib/postgresql/\n# 拷贝zombodb\nCOPY binary-arm/zdblibs/*.sql          /usr/local/pgspider/share/postgresql/extension/\nCOPY binary-arm/zdblibs/*.control      /usr/local/pgspider/share/postgresql/extension/\nCOPY binary-arm/zdblibs/*.so           /usr/local/pgspider/lib/postgresql/\n\n# ------ 开始构建实际发布的镜像 ------\nFROM zh-registry.geostar.com.cn/geopanel/pgspider-base-arm:latest\nLABEL maintainer=\"jianghanghang@geostar.com.cn\"\n\n## 设置若干ENV，指示版本信息\n# buster 上为12 ，stretch 上为 12\n# ENV CDAL_VERSION 12\nENV BOOST_VERSION=1.67.0 \\\n    PG_MAJOR=11 \\\n    PG_VERSION=6 \\\n    POSTGIS_VESION=2.5.3\n\n## 安装必要的依赖（TODO: 部分依赖可能不需要）\nRUN set -ex \\\n#    && sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list \\\n#    && sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\"  /etc/apt/sources.list \\\n    # https://packages.debian.org/stretch-backports/libboost-atomic1.67-dev\n#    && echo \"deb http://deb.debian.org/debian stretch-backports main\" >>/etc/apt/sources.list \\\n    && apt-get update \\\n    && apt-get install -y --no-install-recommends \\\n      curl \\\n      libcurl3-gnutls \\\n      libexpat1 \\\n      libgmp10 \\\n      libgmpxx4ldbl \\\n      libjson-c3 \\\n      # buster 上为6，stretch上为4\n#      libmpfr6 \\\n#      libmpfr4 \\\n      libprotobuf-c1 \\\n      libtiff5 \\\n      libxml2 \\\n      && rm -rf /var/lib/apt/lists/*\n\n## 安装oracle_fdw需要的 Oracle instantclient (arm版本不支持）\n### from: https://github.com/rongfengliang/pgspider-docker/blob/master/Dockerfile-all-in-one-oracle\n#COPY --from=build  /usr/local/instantclient_12_2 /usr/local/instantclient_12_2\n#RUN set -ex \\\n#    && ln -s /usr/local/instantclient_12_2 /usr/local/instantclient \\\n#    && ln -s /usr/local/instantclient/sqlplus /usr/bin/sqlplus\n\n## 设置若干运行需要的环境变量\n#ENV ORACLE_HOME=/usr/local/instantclient \\\nENV PGIS_INSTALL_PATH=/usr/local/pgspider/plugin/postgis\nENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PGIS_INSTALL_PATH/lib:/usr/local/instantclient \\\n    PATH=$PGIS_INSTALL_PATH/bin:/usr/local/pgspider/bin:$PATH\n## 拷贝构建好的成果\nCOPY --from=build  /usr/local/pgspider /usr/local/pgspider\n## 入口脚本添加\nCOPY docker-entrypoint.sh /usr/local/bin/\nRUN mkdir /docker-entrypoint-initdb.d \\\n    && chmod +x /usr/local/bin/docker-entrypoint.sh \\\n    && ln -s usr/local/bin/docker-entrypoint.sh /\n\n## postgis 脚本添加\n### from： https://github.com/postgis/docker-postgis/blob/master/Dockerfile.master.template\nCOPY ./postgis/initdb-postgis.sh /docker-entrypoint-initdb.d/10_postgis.sh\nCOPY ./postgis/update-postgis.sh /usr/local/bin\n## 添加扩展初始化脚本\nCOPY ./initdb-fdw.sh /docker-entrypoint-initdb.d/00_fdws.sh\nCOPY ./debezium/init-debezium.sh /docker-entrypoint-initdb.d/01_debezium.sh\n\n## make the sample config easier to munge (and \"correct by default\")\nRUN sed -ri \"s!^#?(listen_addresses)\\s*=\\s*\\S+.*!\\1 = '*'!\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample; \\\n   grep -F \"listen_addresses = '*'\" /usr/local/pgspider/share/postgresql/postgresql.conf.sample\n\nRUN mkdir -p /var/run/postgresql && chown -R postgres:postgres /var/run/postgresql  && chmod 2777 /var/run/postgresql\n\nENV PGDATA /var/lib/postgresql/data\n## 设置目录权限 - this 777 will be replaced by 700 at runtime (allows semi-arbitrary \"--user\" values)\nRUN mkdir -p \"$PGDATA\" && chown -R postgres:postgres \"$PGDATA\" && chmod 777 \"$PGDATA\"\nVOLUME /var/lib/postgresql/data\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n\n# COPY FROM https://github.com/docker-library/postgres/blob/master/11/Dockerfile\n# We set the default STOPSIGNAL to SIGINT, which corresponds to what PostgreSQL\n# calls \"Fast Shutdown mode\" wherein new connections are disallowed and any\n# in-progress transactions are aborted, allowing PostgreSQL to stop cleanly and\n# flush tables to disk, which is the best compromise available to avoid data\n# corruption.\n#\n# Users who know their applications do not keep open long-lived idle connections\n# may way to use a value of SIGTERM instead, which corresponds to \"Smart\n# Shutdown mode\" in which any existing sessions are allowed to finish and the\n# server stops when all sessions are terminated.\n#\n# See https://www.postgresql.org/docs/12/server-shutdown.html for more details\n# about available PostgreSQL server shutdown signals.\n#\n# See also https://www.postgresql.org/docs/12/server-start.html for further\n# justification of this as the default value, namely that the example (and\n# shipped) systemd service files use the \"Fast Shutdown mode\" for service\n# termination.\n#\nSTOPSIGNAL SIGINT\n\n# An additional setting that is recommended for all users regardless of this\n# value is the runtime \"--stop-timeout\" (or your orchestrator/runtime's\n# equivalent) for controlling how long to wait between sending the defined\n# STOPSIGNAL and sending SIGKILL (which is likely to cause data corruption).\n#\n# The default in most runtimes (such as Docker) is 10 seconds, and the\n# documentation at https://www.postgresql.org/docs/12/server-start.html notes\n# that even 90 seconds may not be long enough in many instances.\nEXPOSE 5432\nCMD [\"postgres\"]\n```\n\n\n\n## 镜像测试及使用\n\n> 提示：镜像使用了pg官方的入口脚本，官方支持的配置及变量都可以使用，具体可查看[官方dockerhub页面](https://hub.docker.com/_/postgres?tab=description&page=1&ordering=last_updated)\n\n下面描述了一个简单的测试流程，详细可参考： [pgspider镜像运行测试](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/build/pgspider/README.md#%E8%BF%90%E8%A1%8C-1)\n\n```shell\n## 根据平台及需要使用的源，设置 `PG_IMAGE` 变量\n# x86 - dockerhub \nPG_IMAGE=hanlyjiang/pgspider-postgis:latest\n# arm - dockerhub\nPG_IMAGE=hanlyjiang/pgspider-postgis-arm:latest\n# x86 - 阿里云\nPG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis:latest\n# arm - 阿里云\nPG_IMAGE= zh-registry.geostar.com.cn/geopanel/pgspider-postgis-arm:latest\n\n# 启动 pgspider （可以将 --rm 换成 -d 以便持续在后台运行 ）\n## 通过 POSTGRES_PASSWORD 变量可以设置密码\ndocker run -it --rm \\\n    --name pgspider \\\n    -p 5434:5432 \\\n    -e POSTGRES_PASSWORD=mysecretpassword \\\n    -v $PWD/data:/var/lib/postgresql/data \\\n    $PG_IMAGE\n\n## 启动后进入容器：\ndocker exec -it pgspider bash\n### 然后可以执行 psql 等命令\n\n# 测试用，正常运行可以不用管\ndocker run -it --rm \\\n    --entrypoint=\"\" \\\n    --name pgspider \\\n    -e POSTGRES_PASSWORD=mysecretpassword \\\n    -v $PWD/data:/var/lib/postgresql/data \\\n    pgspider-postgis:latest bash\n\n```\n\n## 可优化部分\n\nbuilder镜像和base镜像的构建arm及x86两个架构的镜像构建可以合并成一条命令并使用相同的镜像名称；同时pgspider镜像也可以经过一定的更改统一成一个打包脚本；\n\n\n\n# GeoPanel容器化-hasura即块数据API引擎镜像构建\n\n## Hasura镜像构建概览\n\n### hasura 是什么？\n\n引用[hasura官方]([https://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md](https://github.com/hasura/graphql-engine/blob/master/translations/README.chinese.md)\n)的介绍\n\n> Hasura GraphQL引擎是一个高性能的GraphQL服务器，可为您提供 **Postgres上开箱即用的实时GraphQL API**， 响应数据库事件的 [**Webhook触发器**](https://github.com/hasura/graphql-engine/blob/master/event-triggers.md)，以及用于业务逻辑处理的 [**远端Schema**](https://github.com/hasura/graphql-engine/blob/master/remote-schemas.md)。\n> Hasura可帮助您构建基于Postgres的GraphQL应用程序，或将使用Postgres的现有应用迁移到GraphQL上。\n\nGithub及DockerHub地址：\n\n* 开源仓库Github地址：[hasura/graphql-engine](hasura/graphql-engine)\n* 官方Dockerhub镜像地址：[hasura/graphql-engine](https://hub.docker.com/r/hasura/graphql-engine/tags?page=1&ordering=last_updated)\n\n### 我们做的修改\n\n我们使用hasura作为融合中心的块数据API引擎，针对开源版本作了如下修改/扩展：\n\n1. 汉化了 graphl-engine console，其中包括：\n   * 汉化 graphql-engine的console入口文件中的 `Loading...`;\n   * console web页面的所有界面；\n2. 根据需要扩展了几个模块，模块扩展的方式为：1）在console中添加扩展模块的web操作界面；2）提供对应的springboot服务作为后端接口提供服务；到目前为止，包括以下模块：\n   * token管理服务\n   * 数据库集成服务\n   * restapi服务\n\n### 目标及成果\n\n通过官方的dockerhub可以看到，目前没有arm版本的镜像，故我们需要从头编译。同时我们希望能让hasura在arm平台上运行，最终也完成了构建流程，整体如下：\n\n![image-20210316140949364](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316140949.png)\n\n### hasura整体结构\n\n```mermaid\ngraph\n\ngraphql-engine\n\nconsole\n\ncli\n\n```\n\n1. graphql-engine: graphql 引擎\n\n2. console：前端界面，实际上console也会一起打包到graphql-engine的镜像里面\n\n3. Hasura CLI是一个命令行工具，是管理Hasura项目和迁移的主要模式。\n\n实际上我们只需要前两个部分即可\n\n### 整体构建流程梳理\n\n#### 代码结构说明\n\n```shell\ngraphql-engine \n\t|-- server\n\t\t  |-- src-rsr\n\t\t  \t\t|-- console.html\n\t|-- console\n\t\t  |-- xx.html\n\t\t  |-- xxxx\n```\n\nserver 目录会编译出一个 graphql-engine 的二进制文件，其中会包含 `server/src-rsr/console.html` 文件作为首页的加载模板（即console.html）。\n\n#### graphql-engine console\n\nconsole为web工程，使用npm run build即可编译，非常简单。我们只需要重点关注server部分即可。现在我们重点分析这个server部分：\n\n#### graphql-engine server\n\n- graphql-engine server 使用haskell语言进行编写，使用 cabal 进行构建；\n- haskell是一个函数式编程语言，编译器为GHC，编译工具一般使用cabal，cabal同时也是项目的管理工具（如包管理，依赖管理）。\n\n也就是说为了编译server，我们需要GHC及cabal，那么这两个工具的arm版本现状如何了？\n\n* GHC： 无arm版本现成的docker镜像，有预编译的二进制；\n* cabal： 无arm版本现成的docker镜像及二进制文件；\n\n为了不污染环境，并且持久化构建环境，我们准备构建一个docker的镜像，包含ghc及cabal，也就是说，我们两者都需要构建。\n\n总结以下构建步骤：\n\n1. 准备haskell的ARM版本编译环境（包括GHC编译器及hasura编译所需要的cabal工具）；\n2. 使用之前准备好的ARM版本编译环境编译hasura；\n3. 打包成Docker镜像；\n\n\n\n#### 整体构建流程\n\n在浏览`graphql-engine` 的仓库中ci构建的部分文件之后，我发现还需要其他一些辅助镜像，最后梳理出如下构建流程：\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210316090603.png\" alt=\"docker-image-builder-flow\" style=\"zoom: 50%;\" />\n\n\n\n1. 首先，我们需要构建 `graphql-engine-builder` 的镜像，其中包括haskell的GHC编译器及cabal依赖管理工具；\n2. 然后我们使用`graphql-engine-builder`镜像对 graphql-engine 的源码进行编译，生成 graphql-engine 的二进制可执行文件及 graphql-engine 运行所需要的依赖库；\n3. 由于第二步构建过程中有很多中间成果，我需要为graphql-engine创造一个纯净的运行环境以缩小最终的运行镜像的大小，所以我们需要构建 `graphql-engine-packager` 镜像，其中包含一个精简版的根文件系统。\n4. 现在，我们将第二步中生成的graphql-engine及其依赖文件和第三步 `graphql-engine-packager` 镜像中的根文件系统合并到一个scratch镜像，然后生成 `graphql-engine-base` 的镜像，这个镜像已经包含了一个可以正常运行的 graphql-engine ，只是没有集成console资源到镜像中；\n5. 最后我们对console进行编译，生成assets资源，然后基于 `graphql-engine-base` 添加这些前端资源文件，生成我们最终需要的 `graphql-engine` 镜像；\n\n\n\n## graphql-engine-builder 镜像构建\n\n基于以下原因，我决定构建一个graphql-engine-builder的镜像：\n\n1. 不想污染自己的主机的环境，安装一堆haskell的构建环境；\n2. 持久化编译环境，使得构建过程可以无成本迁移到任何机器；\n\n这个builder镜像包含以下内容(实际上就是haskell语言的构建环境)：\n\n* GHC\n* cabal\n\n经过一番尝试，确定了如下Dockerfile构建脚本：\n\n### **X86** Dockerfile\n\n```dockerfile\n#  x86 用于构建hasura的镜像\n# 构建命令 docker build -f Dockerfile -t hanlyjiang/graphql-engine-builder:latest .\nFROM haskell:8.10.1\n\n## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误）\nENV LANG            C.UTF-8\n\n# 避免配置tzdata时出现的交互式等待界面导致构建卡住\n## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/\nENV DEBIAN_FRONTEND noninteractive\n\nRUN sed -i \"s/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g\" /etc/apt/sources.list && \\\n   sed -i \"s/security.debian.org/mirrors.tuna.tsinghua.edu.cn/g\"  /etc/apt/sources.list && \\\n   apt-get update && \\\n   apt-get install -y --no-install-recommends apt-utils lsb-release wget && \\\n   echo \"deb http://apt.postgresql.org/pub/repos/apt buster-pgdg main\" > /etc/apt/sources.list.d/pgdg.list && \\\n   wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc |  apt-key add - && \\\n   apt-get update && \\\n   apt-get install -y --no-install-recommends  postgresql libpq-dev && \\\n   rm -fr /var/lib/apt/lists/* && \\\n   # 安装 upx\n   wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-amd64_linux.tar.xz && \\\n           tar -xf upx-3.96-amd64_linux.tar.xz  && \\\n           cp upx-3.96-amd64_linux/upx /usr/bin/upx && \\\n           rm -fr upx-3.96-amd64_linux\n```\n\nx86版本基于 haskell官方的`haskell:8.10.1` 镜像，添加了如下动作：\n\n1. 替换软件源为国内软件源；\n2. 安装必要的软件依赖；\n3. 添加了upx用于二进制文件优化；\n\n### **ARM** Dockerfile\n\narm版本的则需要从头构建\n\n* 我们使用 `ubuntu:18.04` 作为基础镜像；\n* 首先安装了 LLVM6.0 及 GHC8.6.5 ；\n* 使用 GHC8.6.5 构建 Cabal3.2.0.0（包括cabal-install），因为GHC8.10.1无法成功构建cabal-install 3.2；\n* 然后安装 LLVM 9 及GHC8.10.1，用于后续编译hasura；\n* 添加必要的依赖；\n* 添加了upx用于二进制文件优化；\n\n```dockerfile\n## Hasura graphql-engine 编译环境\n# 测试发现只有在arm机器上才可能构建成功，x86 docker交叉构建失败\n# docker build -t registry.cn-hangzhou.aliyuncs.com/geostar_private_arm/haskell-ghc8.6.5_8.10.1-cabal3.2:20200817 .\n\n# ghc-8.6.5的安装构建需要在ubuntu18.04上（glibc2.27)\n## 通过如下方式确认glibc版本：\n### docker run -it --rm ubuntu:18.04 bash -c \"find / -type f | grep libc-.*.so\" # 输出 /lib/x86_64-linux-gnu/libc-2.27.so\n### docker run -it --rm debian:stretch bash -c \"find / -type f | grep libc-.*.so\" # 输出 /lib/x86_64-linux-gnu/libc-2.24.so\n### docker run -it --rm debian:buster bash -c \"find / -type f | grep libc-.*.so\" # 输出 /lib/aarch64-linux-gnu/libc-2.28.so\n### debian也可以在此页面查看：https://packages.debian.org/search?searchon=sourcenames&keywords=glibc\n#FROM debian:stretch\nFROM ubuntu:18.04\n\n## ensure locale is set during build（否则无法构建cabal，会出现hGetContent错误）\nENV LANG            C.UTF-8\n\n# 避免配置tzdata时出现的交互式等待界面导致构建卡住\n## https://techoverflow.net/2019/05/18/how-to-fix-configuring-tzdata-interactive-input-when-building-docker-images/\nENV DEBIAN_FRONTEND noninteractive\n\n# 以防网络不好，切换到国内镜像源\nRUN apt-get update && \\\n     apt install -y apt-transport-https ca-certificates\nADD ubuntu18.04-sources.list /etc/apt/sources.list\n\n\n# 避免 hash sum mismatch 问题：\n## https://stackoverflow.com/questions/15505775/debian-apt-packages-hash-sum-mismatch\n# RUN apt-get clean && rm -rf /var/lib/apt/lists/* && apt-get clean && apt-get update && \\\n\n# 安装常用软件及GHC构建相关依赖\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends gnupg ca-certificates dirmngr curl git wget && \\\n    apt-get install -y --no-install-recommends zlib1g-dev libtinfo-dev libsqlite3-dev \\\n                g++ netbase xz-utils libnuma-dev make openssh-client \\\n                # hasura 构建需要（pg-client）\n                ## https://stackoverflow.com/questions/17915098/openssl-ssl-h-no-such-file-or-directory-during-installation-of-git\n                libssl-dev libkrb5-dev && \\\n    # 安装llvm 6.0（用于构建cabal）\n    LLVM_VERSION=6.0 && \\\n    # apt-get install -y software-properties-common && \\\n    apt-get install -y --no-install-recommends libghc-network-dev \\\n        llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev && \\\n        rm -fr /var/lib/apt/lists/* && \\\n    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc  && \\\n    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt\n\n# 安装 GHC 8.6.5（用于构建Cabal3.2.0.0）\nRUN GHC=8.6.5 && GHC_OS_DIST=ubuntu18.04 && \\\n    ## 下载链接类似：https://downloads.haskell.org/~ghc/8.10.1/ghc-8.10.1-aarch64-deb9-linux.tar.xz \n    wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \\\n    tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \\\n    cd ghc-${GHC}  && \\\n    ./configure && \\\n    make install && \\\n    cd ../ && \\\n    rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} \n\n# 构建 Cabal 3.2.0.0 （包括 cabal-install）\nRUN git clone -b cabal-install-v3.2.0.0 https://github.com/haskell/cabal.git && \\\n    cd cabal/cabal-install && \\\n    ./bootstrap.sh && \\\n    cd ../.. && \\\n    rm -fr cabal\n\n# 安装 llvm 9 及其他构建所需 （postgresql libpq-dev）pg_config\nRUN LLVM_VERSION=9 && \\\n    apt-get update && \\\n    apt-get install -y --no-install-recommends llvm-${LLVM_VERSION} llvm-${LLVM_VERSION}-dev postgresql libpq-dev && \\\n    # 如果有旧版本的，则移除链接\n    rm /usr/local/bin/llc /usr/local/bin/opt && \\\n    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/llc /usr/local/bin/llc && \\\n    ln -s /usr/lib/llvm-${LLVM_VERSION}/bin/opt /usr/local/bin/opt && \\\n    # 安装ghc8.10.1 ，自带Cabal库的3.2版本\n    GHC=8.10.1 && GHC_OS_DIST=deb9 && \\\n    wget https://downloads.haskell.org/~ghc/${GHC}/ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \\\n    tar -xvf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz && \\\n    cd ghc-${GHC}  && \\\n    ./configure && \\\n    make install && \\\n    cd ../ && \\\n    rm -rf ghc-${GHC}-aarch64-${GHC_OS_DIST}-linux.tar.xz ghc-${GHC} && \\\n    # 安装3.96版本的upx-用于压缩优化graphql-engine二进制可执行文件（软件源中的3.94版本有压缩aarch的二进制后有问题 https://github.com/upx/upx/issues/130）\n    wget https://github.com/upx/upx/releases/download/v3.96/upx-3.96-arm64_linux.tar.xz && \\\n    tar -xf upx-3.96-arm64_linux.tar.xz  && \\\n    cp upx-3.96-arm64_linux/upx /usr/bin/upx && \\\n    rm -fr upx-3.96-arm64_linux upx-3.96-arm64_linux.tar.xz /var/lib/apt/lists/*\n\n\n## stack 安装(hasura构建可不安装stack)\n# ARG STACK=2.1.3\n# ARG STACK_KEY=C5705533DA4F78D8664B5DC0575159689BEFB442\n# ARG STACK_RELEASE_KEY=2C6A674E85EE3FB896AFC9B965101FF31C5C154D\n\n# RUN arch=`uname -m` && \\\n#     echo $arch && \\ \n#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz -o  stack.tar.gz && \\\n#     curl -fSL https://github.com/commercialhaskell/stack/releases/download/v${STACK}/stack-${STACK}-linux-$arch.tar.gz.asc -o stack.tar.gz.asc \n# RUN export GNUPGHOME=\"$(mktemp -d)\" && \\\n#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_KEY} && \\\n#     gpg --batch --keyserver ha.pool.sks-keyservers.net --recv-keys ${STACK_RELEASE_KEY} && \\\n#     gpg --batch --trusted-key 0x575159689BEFB442 --verify stack.tar.gz.asc stack.tar.gz && \\\n#     tar -xf stack.tar.gz -C /usr/local/bin --strip-components=1 && \\\n#     /usr/local/bin/stack config set system-ghc --global true && \\\n#     /usr/local/bin/stack config set install-ghc --global false && \\\n#     rm -rf \"$GNUPGHOME\" /var/lib/apt/lists/* /stack.tar.gz.asc /stack.tar.gz;\n\n# 设置环境变量使可以找到cabal，GHC的默认会安装到PATH中，无需额外设置\nENV PATH /root/.cabal/bin:$PATH\n\n## 没有指定命令的时候默认运行ghci\nCMD [\"ghci\"]\n\n```\n\n> 注意：由于以上builder镜像是用于编译graphql-engine的工具镜像，而非最终的镜像，所以并未刻意对镜像大小进行优化；\n\n## graphql-engine-packager 构建\n\npackager镜像中包含一个纯净的根文件系统，可为graphql-engine server提供基础的运行环境；\n\n### 整体说明\n\ngraphql-engine-packager的镜像构建脚本位于源码的 `server/packaging` 目录中的 `package.df` 文件中，内容如下：\n\n```dockerfile\nFROM hasura/haskell-docker-packager:20190731\nMAINTAINER vamshi@hasura.io\n\nRUN apt-get update && apt-get install -y libpq5 upx \\\n && update-ca-certificates \\\n && mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \\\n && cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \\\n && rm -rf /var/lib/apt/lists/*\n```\n\n可以看到其基于 `hasura/haskell-docker-packager:20190731` 的镜像（[DockerHub对应页面](https://hub.docker.com/r/hasura/haskell-docker-packager/tags?page=1&ordering=last_updated)），具体构建方式如下：\n\n```shell\nregistry=hanlyjiang  # 替换成自行设置的值\npackager_ver=20210316 # 替换成自行设置的值\n\ndocker build -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager.df ./packaging/\n```\n\n从以上分析可知，我们要构建packager镜像，需要先构建`haskell-docker-packager`镜像，而对于X86版本来说，可以直接使用使用官方已经构建好的镜像，对于ARM版本来说，则需要我们从头构建；\n\n\n\n### X86镜像构建\n\n如上所述，我们直接基于官方的 `hasura/haskell-docker-packager:20190731`并使用源码目录中的 `packaging/packager.df` 文件构建出对应的`graphql-engine-packager`镜像即可；\n\n### ARM\n\n#### haskell-docker-packager 镜像构建\n\narm版本则需要我们从头构建 `haskell-docker-packager` 的镜像，基于官方的 [github/hasura/haskell-docker-builder](https://github.com/hasura/haskell-docker-builder) 源码，我略作修改，让其可以构建出arm版本的镜像，对应的代码放置于 [github/hanlyjiang/haskell-docker-builder](https://github.com/hanlyjiang/haskell-docker-builder) 中，执行如下命令即可构建出arm版本的 `haskell-docker-packager` 镜像：\n\n```shell\ngit clone git@github.com:hanlyjiang/haskell-docker-builder.git \nmake build \n```\n\n上述命令执行完毕后会生成一个 `hanlyjiang/haskell-docker-packager:当前日期` 的镜像。\n\n\n\n#### graphql-engine-packager 镜像构建\n\n同样的，我们在 graphql-engine的源代码的 `server/packaging` 目录中添加一个名为 `packaging-arm.df` 的文件用于构建 arm 版本的 `graphql-engine-packager` 镜像，内容如下：\n\n```dockerfile\nFROM hanlyjiang/haskell-docker-packager:20200814\nMAINTAINER hanlyjiang@outlook.com\n\nRUN apt-get update && apt-get install -y libpq5 upx \\\n && update-ca-certificates \\\n && mkdir -p /usr/src/busybox/rootfs/etc/ssl/certs \\\n && cp -L /etc/ssl/certs/* /usr/src/busybox/rootfs/etc/ssl/certs/ \\\n && rm -rf /var/lib/apt/lists/*\n```\n\n可通过如下命令构建arm版本镜像：\n\n```shell\nregistry=hanlyjiang  # 替换成自行设置的值\npackager_ver=20210316 # 替换成自行设置的值\n```\n\n构建可以在arm机器上执行，也可以在x86机器上通过buildx来交叉构建：\n\n- arm 机器上执行：    \n\n```shell\ndocker build -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager-arm.df ./packaging/\n```\n\n- 非arm机器上交叉构建arm镜像\n\n```shell\ndocker buildx build --platform=linux/arm64 -t '$registry/graphql-engine-packager:$packager_ver' -f packaging/packager-arm.df ./packaging/ --load\n```\n\n\n\n## graphql-engine-base 构建\n\n`graphql-engine-base` 镜像包含 graphql-engine 的 server，当不包含 console 的 web 资源；\n\n### X86镜像构建\n\n```dockerfile\n### 构建 graphql-engine 镜像\n## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./\n\n## -- 编译 graphql-engine\n# \nFROM hanlyjiang/graphql-engine-builder:20201111 as builder\n\nARG GIT_TAG=v1.3.2\nARG GIT_USER=docker-build\nARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq\n\nRUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine \n\nWORKDIR /app/graphql-engine/server\n\n# 初始化cabal的配置\nRUN ln -s cabal.project.ci cabal.project.local && \\\n    export LANG=C.UTF-8 && \\\n    # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html\n    cabal user-config update && \\\n    # 替换为国内源\n    sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config  && \\\n    sed -i 's/mirrors.tuna.tsinghua.edu.cn\\//mirrors.tuna.tsinghua.edu.cn\\/hackage/g' /root/.cabal/config\n\n# 重新更新软件包信息(单独作为一层，以便缓存)\nRUN cabal new-update\n\n# 编译 graphql-engine 可执行文件\n# 我们将加载中替换为中文\nRUN sed -i 's/Loading/加载中/g' src-rsr/console.html && \\\n    # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs\n    cabal new-build --jobs=$(nproc)\nRUN build_output=../_build_output && \\\n    exec_glob=`find ./dist-newstyle/ -type f -name \"graphql-engine\"` && \\\n    mkdir $build_output && \\\n    cp \"$exec_glob\" $build_output/ && \\\n    # get-version 需要基于git仓库获取版本号\n    ../scripts/get-version.sh >$build_output/version.txt \n\n\n## -- 提取基础的rootfs\n# docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./\nFROM hasura/graphql-engine-packager:20190731 as baseRootfs\nCOPY --from=builder /app/graphql-engine/_build_output/ /root/\nRUN mkdir /rootfs/ && /build.sh graphql-engine | tar -x -C /rootfs/\n\n\n## 构建最终的rootfs\n# docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./\nFROM builder as bulderRootfs\nWORKDIR /app/graphql-engine/\nCOPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs\n\nRUN pg_dump_ver=12 && \\\n    exec_glob=`find server/dist-newstyle/ -type f -name \"graphql-engine\"` && \\\n    build_output=./_build_output  && \\\n    packaging_dir=./server/packaging/  && \\\n    rootfs_dir=$packaging_dir/build/rootfs  && \\\n    cp $build_output/graphql-engine $rootfs_dir/bin && \\\n    # 获取所有动态链接库\n    ldd $build_output/graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ && \\\n    # 获取 pg_dump\n    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump && \\\n    # 优化&压缩\n    strip --strip-unneeded $rootfs_dir/bin/graphql-engine && \\\n    upx $rootfs_dir/bin/graphql-engine \n\n## - 不带 console-assets\n# docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./\nFROM scratch as graphql-engine-base\nCOPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /\nENV LANG=C.UTF-8 LC_ALL=C.UTF-8\nCMD [\"graphql-engine\", \"serve\"]\n```\n\n执行如下命令构建：\n\n```shell\nTAG=$(date '+%Y%m%d')\n\ndocker build -t graphql-engine-base:$TAG ./ \n```\n\n\n\n### ARM版本镜像构建\n\n```dockerfile\n### 构建 graphql-engine 镜像\n## docker buildx build --platform=linux/arm64  -f Dockerfile-base-arm.dockerfile -t graphql-engine-base:arm-20201109 ./ --load\n\n\n## 构建准备\n# docker pull hanlyjiang/graphql-engine-builder:arm-latest\n\n## -- 编译 graphql-engine\n# \nFROM hanlyjiang/graphql-engine-builder:arm-latest as builder\n\nARG GIT_TAG=v1.3.2\nARG GIT_USER=docker-build\nARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq\n\nRUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine \n\nWORKDIR /app/graphql-engine/server\n\n# 初始化cabal的配置\nRUN ln -s cabal.project.ci cabal.project.local && \\\n    export LANG=C.UTF-8 && \\\n    # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html\n    cabal user-config update && \\\n    # 替换为国内源\n    sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config  && \\\n    sed -i 's/mirrors.tuna.tsinghua.edu.cn\\//mirrors.tuna.tsinghua.edu.cn\\/hackage/g' /root/.cabal/config\n\n# 重新更新软件包信息(单独作为一层，以便缓存)\n## update 过程中可能自动去github下载仓库\nRUN cabal new-update\n\n# 编译 graphql-engine 可执行文件\nRUN sed -i 's/Loading/加载中/g' src-rsr/console.html && \\\n    # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs\n    cabal new-build --jobs=$(nproc)\nRUN build_output=../_build_output && \\\n    exec_glob=`find ./dist-newstyle/ -type f -name \"graphql-engine\"` && \\\n    mkdir $build_output && \\\n    cp \"$exec_glob\" $build_output/ && \\\n    # get-version 需要基于git仓库获取版本号\n    ../scripts/get-version.sh >$build_output/version.txt \n\n\n## -- 提取基础的rootfs\n# docker buildx build --platform=linux/arm64  -f Dockerfile-base.dockerfile --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./ --load\nFROM hanlyjiang/graphql-engine-packager:20200814 as baseRootfs\nCOPY --from=builder /app/graphql-engine/_build_output/ /root/\n# build.sh 的内容就是下面的 ldd graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t ，用于拷贝packager镜像中graphql-engine需要的依赖库到rootfs\nRUN mkdir /rootfs/ && /build.sh graphql-engine | tar -x -C /rootfs/\n\n\n## 构建最终的rootfs\n# docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./ --load\nFROM builder as bulderRootfs\nWORKDIR /app/graphql-engine/\nCOPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs\n\nRUN pg_dump_ver=12 && \\\n    exec_glob=`find server/dist-newstyle/ -type f -name \"graphql-engine\"` && \\\n    build_output=./_build_output  && \\\n    packaging_dir=./server/packaging/  && \\\n    rootfs_dir=$packaging_dir/build/rootfs  && \\\n    cp $build_output/graphql-engine $rootfs_dir/bin && \\\n    # 获取所有动态链接库\n    ldd $build_output/graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ && \\\n    # 获取 pg_dump(arm builder镜像路径不一样)\n    cp /usr/share/postgresql-common/pg_wrapper $rootfs_dir/bin/pg_dump && \\\n    # 优化&压缩\n    strip --strip-unneeded $rootfs_dir/bin/graphql-engine && \\\n    upx $rootfs_dir/bin/graphql-engine \n\n## - 不带 console-assets\n# docker buildx build --platform=linux/arm64  --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base-arm:20201110 --target graphql-engine-base ./ --load\nFROM scratch as graphql-engine-base\nLABEL maintainer=\"jianghanghang@geostar.com.cn\"\nCOPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /\nENV LANG=C.UTF-8 LC_ALL=C.UTF-8\nCMD [\"graphql-engine\", \"serve\"]\n\n```\n\n执行如下命令构建：\n\n```shell\nTAG=$(date '+%Y%m%d')\n\n# ARM机器执行\ndocker build  -t graphql-engine-base:arm-$TAG  ./\n\n# x86交叉构建\ndocker buildx build --platform=linux/arm64 -t  graphql-engine-base:arm-$TAG ./ --load\n```\n\n\n\n### 构建脚本合并简化（未验证）\n\n```dockerfile\n### 构建 graphql-engine 镜像\n## docker build -f Dockerfile-all.dockerfile -t graphql-engine-base:20201109 ./\n\n## -- 编译 graphql-engine\n# \n\nARG builder_image\nARG packager_image\nFROM ${builder_image} as builder\n\nARG GIT_TAG=v1.3.2\nARG GIT_USER=docker-build\nARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq\n\nRUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine \n\nWORKDIR /app/graphql-engine/server\n\n# 初始化cabal的配置\nRUN ln -s cabal.project.ci cabal.project.local && \\\n    export LANG=C.UTF-8 && \\\n    # 生成配置文件(~/.cabal/config) https://cabal.readthedocs.io/en/3.4/installing-packages.html\n    cabal user-config update && \\\n    # 替换为国内源\n    sed -i 's/hackage.haskell.org/mirrors.tuna.tsinghua.edu.cn/g' /root/.cabal/config  && \\\n    sed -i 's/mirrors.tuna.tsinghua.edu.cn\\//mirrors.tuna.tsinghua.edu.cn\\/hackage/g' /root/.cabal/config\n\n# 重新更新软件包信息(单独作为一层，以便缓存)\nRUN cabal new-update\n\n# 编译 graphql-engine 可执行文件\n# 我们将加载中替换为中文\nRUN sed -i 's/Loading/加载中/g' src-rsr/console.html && \\\n    # https://cabal.readthedocs.io/en/3.4/cabal-project.html#cfg-flag---jobs\n    cabal new-build --jobs=$(nproc)\nRUN build_output=../_build_output && \\\n    exec_glob=`find ./dist-newstyle/ -type f -name \"graphql-engine\"` && \\\n    mkdir $build_output && \\\n    cp \"$exec_glob\" $build_output/ && \\\n    # get-version 需要基于git仓库获取版本号\n    ../scripts/get-version.sh >$build_output/version.txt \n\n\n## -- 提取基础的rootfs\n# docker build --progress plain -t graphql-engine-baserootfs:20201110 --target baseRootfs ./\nFROM ${packager_image} as baseRootfs\nCOPY --from=builder /app/graphql-engine/_build_output/ /root/\nRUN mkdir /rootfs/ && /build.sh graphql-engine | tar -x -C /rootfs/\n\n\n## 构建最终的rootfs\n# docker build --progress plain -f Dockerfile-all.dockerfile -t graphql-engine-builderrootfs:20201110 --target bulderRootfs ./\nFROM builder as bulderRootfs\nWORKDIR /app/graphql-engine/\nCOPY --from=baseRootfs /rootfs /app/graphql-engine/server/packaging/build/rootfs\n\nRUN pg_dump_ver=12 && \\\n    exec_glob=`find server/dist-newstyle/ -type f -name \"graphql-engine\"` && \\\n    build_output=./_build_output  && \\\n    packaging_dir=./server/packaging/  && \\\n    rootfs_dir=$packaging_dir/build/rootfs  && \\\n    cp $build_output/graphql-engine $rootfs_dir/bin && \\\n    # 获取所有动态链接库\n    ldd $build_output/graphql-engine | awk 'BEGIN{ORS=\"\\n\"}$1~/^\\//{print $1}$3~/^\\//{print $3}' | xargs cp -n -L --parents -t $rootfs_dir/ && \\\n    # 获取 pg_dump\n    cp /usr/lib/postgresql/$pg_dump_ver/bin/pg_dump $rootfs_dir/bin/pg_dump && \\\n    # 优化&压缩\n    strip --strip-unneeded $rootfs_dir/bin/graphql-engine && \\\n    upx $rootfs_dir/bin/graphql-engine \n\n## - 不带 console-assets\n# docker build --progress plain -f Dockerfile-base.dockerfile -t graphql-engine-base:20201110 --target graphql-engine-base ./\nFROM scratch as graphql-engine-base\nCOPY --from=bulderRootfs /app/graphql-engine/server/packaging/build/rootfs/ /\nENV LANG=C.UTF-8 LC_ALL=C.UTF-8\nCMD [\"graphql-engine\", \"serve\"]\n```\n\n构建命令：\n\n* **X86**\n\n  ```shell\n  builder_image=hanlyjiang/graphql-engine-builder:20201111\n  packager_image=hasura/graphql-engine-packager:20190731\n  TAG=$(date '+%Y%m%d')\n  \n  docker build ./ -t graphql-engine-base:$TAG --build-arg builder_image=\"$builder_image\" --build-arg packager_image=\"$packager_image\"\n  ```\n\n* **ARM**\n\n  ```shell\n  builder_image=hanlyjiang/graphql-engine-builder:arm-latest\n  packager_image=hanlyjiang/graphql-engine-packager:20200814\n  TAG=$(date '+%Y%m%d')\n  \n  # ARM机器执行\n  docker build  -t graphql-engine-base:arm-$TAG --build-arg builder_image=\"$builder_image\" --build-arg packager_image=\"$packager_image\" ./\n  \n  # x86交叉构建\n  docker buildx build --platform=linux/arm64 -t  graphql-engine-base:arm-$TAG --build-arg builder_image=\"$builder_image\" --build-arg packager_image=\"$packager_image\" ./ --load\n  ```\n\n  \n\n## graphql-engine 镜像构建\n\ngraphql-engine 即是我们最终需要使用的镜像，包含graphql-engine 的server及console web资源；\n\n### X86\n\n```dockerfile\n### 构建 graphql-engine 镜像\n## docker build -t graphql-engine:20201111 ./\n\n## -- 构建 console \n# docker build --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./\nFROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder\n# 有时console代码更新，我们直接从仓库获取最新代码\n# COPY --from=builder /app/graphql-engine/console /app/console\nARG GIT_TAG=v1.3.2\nARG GIT_USER=docker-build\nARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq\nRUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine\n\nWORKDIR /app/graphql-engine/console\n# 单独提取install步骤便于缓存\nRUN set -eux ; \\\n    npm config set sass_binary_site=https://npm.taobao.org/mirrors/node-sass && \\\n    npm install --registry=https://registry.npm.taobao.org\n# RUN npm install\nRUN git pull && npm run build\n# 开始构建\nRUN set -eux ; \\\n    CONSOLE_ASSETS_PATH=./static/assets && \\\n    DIST_PATH=./static/dist && \\\n    ls -laR $DIST_PATH && \\\n    if [ ! -d \"$CONSOLE_ASSETS_PATH/common\" ]; then \\\n\t\tmkdir -p $CONSOLE_ASSETS_PATH/common; \\\n\t\tcp -r \"$DIST_PATH/../assets/common\" \"$CONSOLE_ASSETS_PATH\"; \\\n\tfi;  \\ \n\trm -rf \"$CONSOLE_ASSETS_PATH/versioned\" && \\\n\tmkdir -p \"$CONSOLE_ASSETS_PATH/versioned\" && \\\n    cp \"$DIST_PATH\"/*.js \"$CONSOLE_ASSETS_PATH/versioned/\" && \\\n\tgzip -f $CONSOLE_ASSETS_PATH/versioned/*.js && \\\n    # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成\n    cp \"$DIST_PATH\"/*.css \"$CONSOLE_ASSETS_PATH/versioned/\" || true && \\\n    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true\n\n## -- 构建最终镜像\n# docker build --progress plain -t graphql-engine:20201110 ./\nFROM zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123\nLABEL maintainer=\"jianghanghang@geostar.com.cn\"\nCOPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets\n\nCOPY docker-entrypoint.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/docker-entrypoint.sh \\\n    && ln -s usr/local/bin/docker-entrypoint.sh /\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n```\n\n执行如下命令构建：\n\n```shell\nTAG=$(date '+%Y%m%d')\ndocker build -t graphql-engine:$TAG ./\n```\n\n\n\n### ARM\n\n```dockerfile\n### 构建 graphql-engine 镜像\n## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./\n## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load\n\n## -- 构建 console \n# docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load\nFROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder\n# 有时console代码更新，我们直接从仓库获取最新代码\n# COPY --from=builder /app/graphql-engine/console /app/console\nARG GIT_TAG=v1.3.2\nARG GIT_USER=docker-build\nARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq\nRUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine\n\nWORKDIR /app/graphql-engine/console\n# 单独提取install步骤便于缓存\nRUN npm install --registry=https://registry.npm.taobao.org\nRUN npm run build \n# 开始构建\nRUN set -eux ; \\\n    CONSOLE_ASSETS_PATH=./static/assets && \\\n    DIST_PATH=./static/dist && \\\n    ls -laR $DIST_PATH && \\\n    if [ ! -d \"$CONSOLE_ASSETS_PATH/common\" ]; then \\\n\t\tmkdir -p $CONSOLE_ASSETS_PATH/common; \\\n\t\tcp -r \"$DIST_PATH/../assets/common\" \"$CONSOLE_ASSETS_PATH\"; \\\n\tfi;  \\ \n\trm -rf \"$CONSOLE_ASSETS_PATH/versioned\" && \\\n\tmkdir -p \"$CONSOLE_ASSETS_PATH/versioned\" && \\\n    cp \"$DIST_PATH\"/*.js \"$CONSOLE_ASSETS_PATH/versioned/\" && \\\n\tgzip -f $CONSOLE_ASSETS_PATH/versioned/*.js && \\\n    # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成\n    cp \"$DIST_PATH\"/*.css \"$CONSOLE_ASSETS_PATH/versioned/\" || true && \\\n    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true\n\n## -- 构建最终镜像\n# docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load\nFROM zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2\nLABEL maintainer=\"jianghanghang@geostar.com.cn\"\nCOPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets\n# COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets\n\nCOPY docker-entrypoint.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/docker-entrypoint.sh \\\n    && ln -s usr/local/bin/docker-entrypoint.sh /\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n\n```\n\n构建命令：\n\n```shell\nTAG=$(date '+%Y%m%d')\ndocker build  -f Dockerfile-arm.dockerfile -t graphql-engine:$TAG ./\ndocker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-$TAG ./ --load\n```\n\n\n\n### 构建脚本简化(未验证)\n\n```dockerfile\n### 构建 graphql-engine 镜像\n## docker build  -f Dockerfile-arm.dockerfile -t graphql-engine:20201113 ./\n## docker buildx build --platform=linux/arm64  -f Dockerfile-arm.dockerfile -t graphql-engine:arm-20201113 ./ --load\n\nARG base_image\n\n## -- 构建 console \n# docker buildx build --platform=linux/arm64 --progress plain -f Dockerfile-console.dockerfile  -t graphql-engine-consolebuilder:20201110 --target consoleBuilder ./  --load\nFROM hanlyjiang/node-11-alpine-git:20201113 as consoleBuilder\n# 有时console代码更新，我们直接从仓库获取最新代码\n# COPY --from=builder /app/graphql-engine/console /app/console\nARG GIT_TAG=v1.3.2\nARG GIT_USER=docker-build\nARG GIT_PWD=4Kqy9Cb4FcYx2H4goiEq\nRUN git clone -b $GIT_TAG http://$GIT_USER:$GIT_PWD@172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine.git /app/graphql-engine\n\nWORKDIR /app/graphql-engine/console\n# 单独提取install步骤便于缓存\nRUN npm install --registry=https://registry.npm.taobao.org\nRUN npm run build \n# 开始构建\nRUN set -eux ; \\\n    CONSOLE_ASSETS_PATH=./static/assets && \\\n    DIST_PATH=./static/dist && \\\n    ls -laR $DIST_PATH && \\\n    if [ ! -d \"$CONSOLE_ASSETS_PATH/common\" ]; then \\\n\t\tmkdir -p $CONSOLE_ASSETS_PATH/common; \\\n\t\tcp -r \"$DIST_PATH/../assets/common\" \"$CONSOLE_ASSETS_PATH\"; \\\n\tfi;  \\ \n\trm -rf \"$CONSOLE_ASSETS_PATH/versioned\" && \\\n\tmkdir -p \"$CONSOLE_ASSETS_PATH/versioned\" && \\\n    cp \"$DIST_PATH\"/*.js \"$CONSOLE_ASSETS_PATH/versioned/\" && \\\n\tgzip -f $CONSOLE_ASSETS_PATH/versioned/*.js && \\\n    # console 打包方式中可能将css放置到js中，这里不强制要求有css文件生成\n    cp \"$DIST_PATH\"/*.css \"$CONSOLE_ASSETS_PATH/versioned/\" || true && \\\n    gzip -f $CONSOLE_ASSETS_PATH/versioned/*.css || true\n\n## -- 构建最终镜像\n# docker buildx build --platform=linux/arm64  --progress plain -t graphql-engine:20201110 ./  --load\nFROM ${base_image}\nLABEL maintainer=\"jianghanghang@geostar.com.cn\"\nCOPY --from=consoleBuilder /app/graphql-engine/console/static/assets /srv/console-assets\n# COPY --from=zh-registry.geostar.com.cn/geopanel/graphql-engine:v1.3.2 /srv/console-assets /srv/console-assets\n\nCOPY docker-entrypoint.sh /usr/local/bin/\nRUN chmod +x /usr/local/bin/docker-entrypoint.sh \\\n    && ln -s usr/local/bin/docker-entrypoint.sh /\n\nENTRYPOINT [\"docker-entrypoint.sh\"]\n```\n\n* x86构建：\n\n  ```shell\n  base_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:20201123\n  \n  TAG=$(date '+%Y%m%d')\n  \n  docker build ./ -t graphql-engine-base:$TAG --build-arg base_image=\"$base_image\" --build-arg \n  ```\n\n  \n\n* arm构建\n\n  ```shell\n  base_image=zh-registry.geostar.com.cn/geopanel/graphql-engine-base:arm-v1.3.2\n  \n  TAG=$(date '+%Y%m%d')\n  \n  # arm 机器直接构建\n  docker build ./ -t graphql-engine:arm-$TAG --build-arg base_image=\"$base_image\" --build-arg \n  \n  \n  # x86交叉构建\n  docker buildx build --platform=linux/arm64 -t  graphql-engine:arm-$TAG --build-arg base_image=\"$base_image\" ./ --load\n  ```\n\n\n\n# GeoPanel容器化-自研服务镜像构建\n\n## 前言\n\n所有当前已经构建的服务，都可以通过[gepanel-deploy 仓库中的readme](http://172.17.0.205/dept-development/product-project/geopanel/geopanel-deploy/-/blob/master/README.md)进行快速导航，如：\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210319162128.png\" alt=\"image-20210319162127913\" style=\"zoom: 50%;\" />\n\n## blockapi-token 服务镜像构建\n\n镜像构建的相关文件目录位于 [gitlab此路径](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/tree/v1.3.2/docker/hasura-token)，具体构建时操作步骤如下：\n\n1. **王峰**提供成品jar包；\n2. 放置到此目录执行docker buildx build 命令打包；\n\n由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：\n\n* [dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/Dockerfile)\n* [打包及使用方式](http://172.17.0.205/dept-development/product-project/geopanel/development-center/blockdataapi-engine/-/blob/v1.3.2/docker/hasura-token/README.md)\n\n\n\n## blockapi-db-integrate 服务镜像构建\n\n数据库集成服务的镜像构建相关文件位于 [gitlab此路径](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev/docker) ，具体构建时操作步骤如下：\n\n1. **韩小乐** 提供成品jar或者我们自行从[源码](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/tree/dev)编译jar；\n2. 放置到docker构建目录使用docker buildx build命令构建；\n\n由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：\n\n* [dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/Dockerfile)\n* [打包及使用方式](http://172.17.0.205/dept-development/product-project/geopanel/FusionCenter/integrate-db/-/blob/dev/docker/README.md)\n\n\n\n## blockapi-restapi 服务镜像构建\n\n由于之前有完成过，在此不在叙述，可参考 [此gitlab目录](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/FusionCenter/rest-api/-/tree/master/docker)\n\n\n\n## gpl-datacollection 服务镜像构建\n\n埋点系统服务镜像的构建文件位于 [gitlab此路径](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/tree/develop/docker) ，具体构建时操作步骤如下：\n\n1. **王峰** 提供成品jar；\n2. 放置到docker构建目录使用 docker buildx build命令构建；\n\n由于其dockerfile非常简单，所以在此不再解释，可直接查看gitlab中对应的：\n\n* [dockerfile](http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/Dockerfile)\n* [打包及使用方式](http://172.17.0.205/dept-development/product-project/geopanel/development-center/event-tracking-manager-system/-/blob/develop/docker/README.md)\n\n\n\n\n\n# GeoPanel容器化-服务编排\n\n## 镜像存储及分发管理\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210323092448.png\" alt=\"geopanel-registrys\" style=\"zoom: 40%;\" />\n\n1. harbor 为内网基于 [harbor](https://goharbor.io/) 搭建的私有docker registry;\n2. 对于自行构建的镜像，我们只需要将镜像推送到harbor，根据配置好的自动复制规则，镜像会自动同步到阿里云私有docker镜像仓库，之后该镜像即可从阿里云镜像仓库拉取；\n3. harbor仓库可使用域账号进行登录，按项目进行读写权限控制；   \n4. 阿里云的私有镜像仓库开放一个公用的只读账号，不接受手动镜像推送；   \n5. 实际部署时，可根据现场的网络情况，选择使用公司仓库/阿里云仓库在线拉取，或者使用镜像批量导出脚本批量导出镜像文件，进行离线部署；\n\n\n\n## GeoPanel服务名及变量命名约定\n\n### 自有服务命名约定   \n\n规范服务命名能方便标识服务之间的逻辑关系，对应的服务命名会反映到集群部署中服务的名称，服务中接口/页面的基础地址，服务相关的配置变量。\n\n* 服务中应包含服务所属的模块内容缩写，如块数据api引擎为blockapi；\n* 服务的容器编排名称，镜像名称，服务的基础服务地址，服务在整个集群中的导入或导出的配置变量名称均应保持一致性；\n\n目前有如下几个主要服务单元：\n\n#### **当前集群服务命名**\n\n| 服务             | 命名说明                                                     |\n| ---------------- | ------------------------------------------------------------ |\n| 块数据API引擎    | 命名为 blockapi ，包含以下服务：<br/>1. `blockapi` : 块数据api引擎服务（基础hasura graphql引擎）<br/>2. `blockapi-token`: 块数据api引擎扩展模块-token管理service <br/>3. `blockapi-db-integrate`：块数据api引擎扩展模块-数据库集成service <br/>4. `blockapi-restapi`: 块数据api引擎扩展模块-restapi service |\n| 埋点日志管理系统 | 命名 ： `gpl-data-collection`                                |\n\n#### **当前各服务接口/web界面基础地址：**\n\n| 服务                  | 基础地址             | 示例                                                         |\n| --------------------- | -------------------- | ------------------------------------------------------------ |\n| blockapi              | -                    | 保持和开源版本graphql-engine一致                             |\n| blockapi-token        | /block-api/tks       | http://192.168.43.73:8881/block-api/tks                      |\n| blockapi-db-integrate | /block-api/db-intgrs | http://192.168.43.73:8882/block-api/db-intgrs                |\n| blockapi-restapi      | /block-api/restapi   | [http://172.17.0.105:8884/block-api/restapi](http://172.17.0.105:8884/block-api/restapi) |\n| gpl-data-collection   | /gpl-dc              | http://192.168.43.73:8883/gpl-dc                             |\n\n### 通用变量说明\n\n#### 概述\n\n在服务部署时，我们使用环境变量来为各个服务提供需要的配置，以下通用变量用于减少服务部署时所需要的变量，大致按以下原则：\n\n* 相同含义的变量尽量统一为一个\n* 有可能内部和外部用途的服务使用两个变量区分开来\n* 变量命名需要带上服务名前缀\n\n> **外部URL和内部URL说明：（下方部分服务会导出内部和外部两个url的变量）**\n>\n> * **内部URL**：在docker集群内部，可以使用服务名替代IP地址访问对应的服务，一般用于服务内部之间互相访问；（如使用内部URL，在部署时可不需要修改配置）\n> * **外部URL**：当服务需要给客户端（如APP或浏览器）或不属于我方服务集群的其他服务调用时，需要提供外部的IP（非docker集群内部）给外部访问；\n\n| **服务**              | **变量名**                                                   | 说明及示例值                                                 | **springboot变量名**                      |\n| :-------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- | ----------------------------------------- |\n| postgres              |                                                              |                                                              |                                           |\n| zookeeper             |                                                              | 暂未供外部使用，不导出变量                                   |                                           |\n| kafka                 | *kafka 内部地址*<br/>`KAFKA_INTERNAL_URL`                    | kafka:9092                                                   | kafka.internal_url                        |\n|                       | *kafka 外部地址*<br/>`KAFKA_EXTERNAL_URL`                    | 192.168.43.22:9094                                           | kafka.external_url                        |\n| redis                 | Redis服务主机<br/>`REDIS_HOST`                               | redis                                                        | redis.host                                |\n|                       | Redis服务端口<br/>`REDIS_PORT`                               | 6379                                                         | redis.port                                |\n|                       | Redis服务访问密码<br/>`REDIS_PASSWORD`                       | vsMEDgmxZdjOi7Nd                                             | redis.password                            |\n| blockapi              | 块数据API引擎数据库地址<br/>`HASURA_GRAPHQL_DATABASE_URL`<br/>`BLOCKAPI_DATABASE_URL` | postgres://postgres:<br/>d8cfe3137214759a932014084ac410b9<br/>@postgres:5432/hasura | blockapi.database_url                     |\n|                       | 块数据API引擎管理密钥<br/>`HASURA_GRAPHQL_ADMIN_SECRET`<br/>`BLOCKAPI_ADMIN_SECRET` | d8cfe3137214759a932014084ac410b9<br/>两个变量含义一致，优先使用 BLOCKAPI_ADMIN_SECRET | blockapi.admin_secert                     |\n|                       | 块数据API引擎内部地址<br/>`BLOCKAPI_INTERNAL_URL`            | `http://graphql-engine:8080`                                 | blockapi.internal_url                     |\n|                       | 块数据API引擎的外部地址<br>`BLOCKAPI_EXTERNAL_URL`           | `http://192.168.43.22:8883`                                  | blockapi.external_url                     |\n| blockapi-token<br>    | 块数据API引擎token管理服务内部接口地址<br>`BLOCKAPI_TOKEN_INTERNAL_URL` | http://blockapi-token:9099/block-api/tks                     | blockapi.token.internal_url               |\n|                       | 块数据API引擎token管理服务外部接口地址<br>`BLOCKAPI_TOKEN_EXTERNAL_URL` | http://192.168.43.73:8881/block-api/tks                      | blockapi.token.external_url               |\n| blockapi-db-integrate | 块数据API引擎数据库集成服务外部接口地址<br>`BLOCKAPI_DATABASE_INTEGRATE_EXTERNAL_URL` | http://192.168.43.73:8882/block-api/db-intgrs                | blockapi.database_intergrate.external_url |\n| gpl-data-collection   | 埋点系统服务地址，暂未供外部使用，但提供预定义2个变量<br>`GPL_DATACOLLECTION_INTERNAL_URL` |                                                              | gpl_datacollection.internal_url           |\n|                       | `GPL_DATACOLLECTION_EXTERNAL_URL`                            |                                                              | gpl_datacollection.external_url           |\n\n#### 在springboot中使用变量\n\n> 待补充\n\n\n\n## 当前服务编排策略\n\n当前将所有已经容器化的服务划分为如下服务部署单元：\n\n```mermaid\ngraph LR\n\nG[GeoPanel] --> B\n\nG --> K\n\nG --> GPL_DC\n\nB[blockapi] --> blockapi-engine\nB --> postgres\nB --> redis\nB --> blockapi-token\nB --> blockapi-db-integrate\nB --> blockapi-restapi\n\nK[kafka] --> kafka\nK --> zookeeper\n\nGPL_DC[gpl-datacollection] --> gpl-datacollection\n```\n\n目前分为三块（blockapi，kafka，gpl-datacollection），每个模块分别对应一个swarm的部署yml配置，可以单独进行启动，使用相同的stack名称启动后，则可以进入一个stack中；\n\n部署仓库地址位于[gitlab上](http://zh-gitlab.geostar.com.cn/dept-development/product-project/geopanel/geopanel-deploy)。\n\n## 当前部署仓库细节说明\n\n```shell\n.\n├── README.md -- 文档说明\n├── blockapi -- 块数据api引擎的部署配置所在目录\n│   ├── README.md -- 块数据api引擎的配置及启动说明文档\n│   ├── config.env -- 单独的配置文件，目前未使用\n│   ├── db-init - 数据库初始化脚本，仅做备份，目前未使用\n│   │   ├── 00_fdws.sh\n│   │   ├── 10_postgis.sh\n│   │   └── 20_gpl_data_collection.sql\n│   ├── docker-compose-arm.yml -- arm版本的部署配置文件\n│   ├── docker-compose.yml -- x86版本的部署配置文件\n│   └── redis-config -- redis 配置\n│       └── redis.conf\n├── data -- 数据挂载目录\n│   └── redis\n├── deploy.sh -- 辅助部署脚本\n├── env -- 全局配置目录\n│   └── global.env -- 全局配置，包含所有配置项目，如可能有需要使用公共配置的，服务都应该在yml中声明时引用此配置\n├── gpl-datacollection -- 埋点管理系统部署配置目录\n│   ├── README.md -- 埋点系统的配置修改及启动方式说明文档\n│   ├── config.env -- 埋点系统的单独的配置文件，目前未使用\n│   └── docker-compose.yml --埋点系统的部署启动配置文件\n├── kafka -- kafka的部署配置目录\n│   ├── README.md -- kafka服务说明，kafka验证方式说明\n│   └── docker-compose.yml -- 部署配置文件\n```\n\n总的来说，目前有如下结构设计：\n\n1. 按逻辑相关性将服务进行一定的划分，一个单元的服务的部署相关文件及配置在一个部署目录中单独存储，使用一个docker-compose.yml文件来编排，可以单独启动；\n2. 使用一个 `env/global.env` 文件来存放所有需要修改的配置及全局配置/需要共享的配置-以方便部署时统一修改，每个部署单元中预留一个`.env`文件-用于存放私有配置，只是目前都没有使用；\n3. 提供了一个 `deploy.sh` 的辅助部署脚本用于简化部署步骤，但此脚本目前并不够完善；\n4. 每个部署目录提供README.md单独对当前目录中的部署单元进行说明，一般应包含配置修改说明，部署启动说明，启动成功确认方式，数据挂载情况说明，根据具体情况也可以提供简单的测试步骤；\n\n> 对于各个部署单元的部署文件，不再单独说明，请参考仓库中的yml部署文件及readme\n\n\n\n\n",
      "data": {
        "title": "GeoPanel容器化",
        "date": "2021-04-08 15:10:06",
        "tags": [],
        "published": false,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "",
      "fileName": "geopanel-rong-qi-hua"
    },
    {
      "content": "\n\n* 简单介绍系统架构、编译环境的搭建\n* 简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式\n\n<!-- more -->\n\n\n## Android系统架构\n\nAndroid 系统架构如下两图所示：\n\n![Android 框架详情](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401092831.png) \n\n![Android 系统架构概览](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401092925.png)\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n\n\n- **应用框架**。应用框架最常被应用开发者使用。很多此类 API 都可以直接映射到底层 HAL 接口，并可提供与实现驱动程序相关的实用信息。\n- **Binder IPC**。Binder 进程间通信 (IPC) 机制允许应用框架跨越进程边界并调用 Android 系统服务代码，这使得高级框架 API 能与 Android 系统服务进行交互。在应用框架级别，开发者无法看到此类通信的过程，但一切似乎都在“按部就班地运行”。\n- **系统服务**。系统服务是专注于特定功能的模块化组件，例如窗口管理器、搜索服务或通知管理器。应用框架 API 所提供的功能可与系统服务通信，以访问底层硬件。Android 包含两组服务：“系统”（诸如窗口管理器和通知管理器之类的服务）和“媒体”（与播放和录制媒体相关的服务）。\n- **硬件抽象层 (HAL)**。HAL 可定义一个标准接口以供硬件供应商实现，这可让 Android 忽略较低级别的驱动程序实现。借助 HAL，硬件开发者可以顺利实现相关功能，而不会影响或更改更高级别的系统。HAL 实现会被封装成模块，并会由 Android 系统适时地加载。如需了解详情，请参阅[硬件抽象层 (HAL)](https://source.android.google.cn/devices/architecture/hal?hl=zh-cn)。\n- **Linux 内核**。开发设备驱动程序与开发典型的 Linux 设备驱动程序类似。Android 使用的 Linux 内核版本包含一些特殊的补充功能，例如低内存终止守护进程（一个内存管理系统，可更主动地保留内存）、唤醒锁定（一种 [`PowerManager`](https://developer.android.google.cn/reference/android/os/PowerManager.html?hl=zh-cn) 系统服务）、Binder IPC 驱动程序，以及对移动嵌入式平台来说非常重要的其他功能。这些补充功能主要用于增强系统功能，不会影响驱动程序开发。可以使用任意版本的内核，只要它支持所需功能（如 Binder 驱动程序）即可。不过建议使用 Android 内核的最新版本。如需了解详情，请参阅[构建内核](https://source.android.google.cn/setup/building-kernels?hl=zh-cn)一文。\n\n> 以上部分内容来源： https://source.android.google.cn/devices/architecture?hl=zh-cn\n\n## 搭建开发环境并编译源码\n\n本节将讨论 Android 11 源码下载和编译的方法、AndroidStudio开发环境的搭建方法，及 system_process 进程的调试方法等相关知识。\n\n### 选择分支\n\n可参考 source.android.google.cn 的文档 [代号、标记和 Build 号](https://source.android.google.cn/setup/start/build-numbers) ，可以看到当前最新的版本及标记如下：\n\n| Build           | 标记               | 版本      | 支持的设备                                                   | 安全补丁程序级别 |\n| :-------------- | :----------------- | :-------- | :----------------------------------------------------------- | :--------------- |\n| RQ2A.210305.007 | android-11.0.0_r33 | Android11 | --                                                           | --               |\n| RQ1D.210105.003 | android-11.0.0_r28 | Android11 | Pixel 3、Pixel 3 XL、Pixel 4a (5G)、Pixel 5                  | 2021-01-05       |\n| RQ1A.210105.003 | android-11.0.0_r27 | Android11 | Pixel 3、Pixel 3 XL、Pixel 4、Pixel 4a (5G)、Pixel 4 XL、Pixel 5 | 2021-01-05       |\n| RQ1A.210105.002 | android-11.0.0_r26 | Android11 | Pixel 3a、Pixel 3a XL、Pixel 4a                              | 2021-01-05       |\n\n参考代码仓库中的[最新Tag](https://android.googlesource.com/platform/bionic/+/refs/tags/android-11.0.0_r33)，我们选择 `android-11.0.0_r33`\n\n### 搭建Android构建环境\n\n构建环境的搭建可参考官方的 [搭建构建环境](https://source.android.google.cn/setup/build/initializing) 文档，以下结合实际搭建过程中遇到的问题简要进行介绍。\n\n#### 构建环境要求\n\n首先需要机器满足一些[要求](https://source.android.google.cn/setup/build/requirements)，一般来说，需要：\n\n* 操作系统： Linux 或者 macOS\n* 内存： 16GB的可用RAM/交换空间\n* 硬盘： 检出代码至少250GB可用磁盘空间，如果需要构建，则还需要150GB\n\n从Android8.0 开始，可以使用源码中带的Dockerfile来构建一个镜像用于编译aosp源码；下面我们将分别介绍如何构建编译用的Docker镜像及直接在macOS11.2上搭建构建环境，构建时根据情况任选一种即可。\n\n> 提示：\n>\n> 最新的构建要求可以参考官方文档 [aosp源码构建要求](https://source.android.google.cn/setup/build/requirements)\n\n#### 搭建构建环境-Docker\n\n> docker镜像基于ubuntu:18.04，所以ubuntu上也可以按照dockerfile中的命令配置环境\n\n这里假设安装了Docker，如果没有安装，可以参考[Docker官方安装文档](https://docs.docker.com/engine/install/)进行安装。\n\n```shell\nmkdir docker\ncd docker\n```\n\n将如下内容保存为Dockerfile，并存储到之前建立的docker目录\n\n```dockerfile\nFROM ubuntu:18.04\n\nARG userid\nARG groupid\nARG username\n\nRUN apt-get update \\\n    && apt-get install -y git-core gnupg flex bison build-essential zip \\\n    curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \\\n    x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \\\n    python3 \\\n    && rm -rf /var/lib/apt/lists/* \n    \n# 最新的AOSP源码中已经带了JDK，所以无需安装\n# RUN curl -o jdk8.tgz https://android.googlesource.com/platform/prebuilts/jdk/jdk8/+archive/master.tar.gz \\\n#  && tar -zxf jdk8.tgz linux-x86 \\\n#  && mv linux-x86 /usr/lib/jvm/java-8-openjdk-amd64 \\\n#  && rm -rf jdk8.tgz\n\nRUN curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo \\\n && chmod a+x /usr/local/bin/repo \\\n && ln -s /usr/bin/python3 /usr/bin/python\n\nRUN groupadd -f -g $groupid $username || true \\\n && useradd -m -u $userid -g $groupid $username \\\n && echo $username >/root/username \\\n && echo \"export USER=\"$username >>/home/$username/.gitconfig\nCOPY gitconfig /home/$username/.gitconfig\nRUN chown $userid:$groupid /home/$username/.gitconfig\nENV HOME=/home/$username\nENV USER=$username\nENTRYPOINT chroot --userspec=$(cat /root/username):$(cat /root/username) / /bin/bash -i\n```\n\n> 以上dockerfile基于源码中 `build/make/tools/docker/Dockerfile` 修改\n\n**构建镜像：**\n\n```shell\n# Copy your host gitconfig, or create a stripped down version\n$ cp ~/.gitconfig gitconfig\n$ docker build --build-arg userid=$(id -u) --build-arg groupid=$(id -g) --build-arg username=$(id -un) -t android-build-bionic .\n```\n\n**使用镜像：**\n\n> 可以直接使用我已经构建好的镜像： `hanlyjiang/android-build-bionic`，可以使用如下命令拉取并修改tag：\n>\n> `docker pull hanlyjiang/android-build-bionic`\n>\n> `docker tag hanlyjiang/android-build-bionic android-build-bionic:latest`\n\n假设aosp的源码目录位于 ～/aosp\n\n```shell\n# 设置变量指向源码顶层目录\nANDROID_BUILD_TOP=~/aosp\n# 如自行构建镜像，此处\nBUILD_IMAGE=android-build-bionic\ncd $ANDROID_BUILD_TOP\n# 运行容器，并将aosp源码目录挂载到容器内部的/src目录\ndocker run -it --rm --name aosp-builder -v $PWD:/src $BUILD_IMAGE\n```\n\n启动成功后就会进入容器的shell中，之后在容器中进行执行对应的编译命令即可。\n\n> **docker使用提示：**\n>\n> 1. 上面的`docker run `命令中添加了 `--rm` 选项，在启动的交互式bash结束后就会自动移除容器。之后需要再次输入`docker run`命令启动容器；为了避免每次都输入如上命令启动容器，可以移除`--rm` 选项\n> 2. 我们执行构建一般需要较长时间，期间如果我们退出容器的bash，则构建任务会终止，这显然不是我们想要的，我们可以通过 `ctrl+P ctrl+Q` 命令告诉docker我们需要关闭容器到本机的输入输出重定向，但是并不暂停任何执行的任务。之后再使用 `docker attach aosp-builder`（aosp-builder是我们启动时指定的容器名称） 即可重新将容器输入输出重定向到本机终端，继续与容器内的shell交互。\n\n#### 搭建构建环境-macOS11.2\n\n这里介绍下macOS（x86）编译的环境配置\n\n1. 准备源码目录\n\n   由于macOS默认的分区是不区分大小写的，但是aosp编译需要区分大小写，所以需要创建一个区分大小写的分区，这里可以有两种选择：\n\n   1）使用另外一个磁盘（如外置的移动硬盘），然后使用磁盘工具将其抹掉为区分大小写的分区；\n\n   2）创建一个区分大小写的磁盘映像，可通过如下命令执行\n\n   ```shell\n   hdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 250g ~/android.dmg.sparseimage\n   \n   # 定义装载卸载函数\n   mountAndroid() { hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android; }\n   umountAndroid() { hdiutil detach /Volumes/android; }\n   # 装载刚刚创建的磁盘映像到 /Volumes/android 目录，之后cd 到此目录执行即可\n   mountAndroid\n   ```\n\n2. 安装 xcode 命令行工具\n\n   ```shell\n   xcode-select --install\n   ```\n\n3. 设置bash\n\n   ```shell\n   # 可加入到～/.bash_profile 文件中\n   ulimit -S -n 2048\n   ```\n\n4. 下载 10.15 SDK\n\n   从此处下载： https://github.com/phracker/MacOSX-SDKs/releases\n\n   下载完成后放入到此目录：`/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/`\n\n5. 修复代码（在下载完成源码之后执行）\n\n   * 编辑文件 `system/core/base/cmsg.cpp`\n\n   * 添加一行：`size_t psize = getpagesize();`\n\n     ```cpp\n     namespace base {\n         \n     size_t psize = getpagesize();\n         \n     ssize_t SendFileDescriptorVector(borrowed_fd sockfd, const void* data, size_t len,\n     ```\n\n   * 将文件中所有 **PAGE_SIZE** 替换为 **psize**\n\n> 参考：\n>\n> * [Building Android 11 for PH-1 on Apple Silicon](https://nf4789.medium.com/building-android-11-for-ph-1-on-apple-silicon-6600436a36a0)\n> * [Could not find a supported mac sdk: “10.10” “10.11” “10.12” “10.13”](https://stackoverflow.com/questions/50760701/could-not-find-a-supported-mac-sdk-10-10-10-11-10-12-10-13)\n> * [创建区分大小写的磁盘映像-source.android.google.cn](https://source.android.google.cn/setup/build/initializing?hl=zh-cn#creating-a-case-sensitive-disk-image)\n\n### 下载源码\n\n#### 安装Repo\n\n> 提示： 先前构建的docker镜像中已经安装了repo，如使用镜像，可跳过此步骤\n\n```shell\nmkdir ~/.bin\nPATH=~/.bin:$PATH\n\n# 这里可能需要开启代理\ncurl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo\nchmod a+x ~/bin/repo\n\n# 验证是否安装成功\nrepo help\n```\n\n输出如下则表示安装成功：\n\n```shell\nusage: repo COMMAND [ARGS]\n\nrepo is not yet installed.  Use \"repo init\" to install it here.\n\nThe most commonly used repo commands are:\n\n  init      Install repo in the current working directory\n  help      Display detailed help on a command\n\nFor access to the full online help, install repo (\"repo init\").\n```\n\n#### 获取aosp源码底包\n\n```shell\nwget https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar\n# 解压\ntar xf aosp-latest.tar\n```\n\n或者直接下载：\n\n```shell\nmkdir aosp ; cd aosp \nrepo init -u https://android.googlesource.com/platform/manifest -b android-11.0.0_r33\n```\n\n然后执行代码同步命令：\n\n```shell\nrepo sync -c -j16\n```\n\n> repo sync 命令说明： \n>\n> * 通过 `-c` 指定只获取当前分支\n> * 通过 `-j16` 指定并行获取的线程数量，这里我电脑为8核，所以指定了16个线程\n\n> **提示：**\n>\n> 代码下载完成后，我们复制一份到另外一个目录只用于浏览代码 `rsync -a -H --progress aosp aosp-ro`\n\n### 编译源码\n\n首先， 我们使用 repo 启动一个工作分支\n\n```shell\nrepo start dev_android11_r33 --all\n```\n\n初始化环境：\n\n```shell\nsource build/envsetup.sh\n```\n\n`envsetup.sh` 脚本会导入若干命令，可使用 `hmm` 查看完整的可用命令列表。\n\n选择目标：\n\n```shell\nlunch aosp_x86_64-eng\n```\n\n输出如下：\n\n```shell\n$ lunch aosp_x86_64-eng\n============================================\nPLATFORM_VERSION_CODENAME=REL\nPLATFORM_VERSION=11\nTARGET_PRODUCT=aosp_x86_64\nTARGET_BUILD_VARIANT=eng\nTARGET_BUILD_TYPE=release\nTARGET_ARCH=x86_64\nTARGET_ARCH_VARIANT=x86_64\nTARGET_2ND_ARCH=x86\nTARGET_2ND_ARCH_VARIANT=x86_64\nHOST_ARCH=x86_64\nHOST_OS=darwin\nHOST_OS_EXTRA=Darwin-20.3.0-x86_64-11.2.3\nHOST_BUILD_TYPE=release\nBUILD_ID=RQ2A.210305.007\nOUT_DIR=out\nPRODUCT_SOONG_NAMESPACES=device/generic/goldfish device/generic/goldfish-opengl hardware/google/camera hardware/google/camera/devices/EmulatedCamera device/generic/goldfish device/generic/goldfish-opengl\n```\n\n构建：\n\n```shell\nmake -j16\n```\n\n> 提示：构建命令可参考 [官方文档-编译 Android](https://source.android.google.cn/setup/build/building)\n\n构建成功后输出如下：\n\n```shell\n[100% 119047/119047] Create system-qemu.img now\nremoving out/target/product/generic_x86_64/system-qemu.img.qcow2\nout/host/darwin-x86/bin/sgdisk --clear out/target/product/generic_x86_64/system-qemu.img\n\n#### build completed successfully (14:34:15 (hh:mm:ss)) ####\n```\n\n我们这里使用模拟器进行运行\n\n```shell\nemulator\n```\n\n运行起来之后，查看其中的系统版本号如下：\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210403135316.png\" alt=\"Screenshot_1617429150\" style=\"zoom:35%;\" />\n\n## 使用AndroidStudio调试 `system_process`\n\n本小节介绍如何使用AS来调试Android Java Framework的核心进程 system_process。\n\n### 下载安装AndroidStudio\n\n从[AndroidStudio官方页面](https://developer.android.google.cn/studio)下载安装运行即可\n\n### 生成AS项目配置\n\n总的流程如下：\n\n* 全量编译一次aosp源码\n* 编译`development/tools/idegen` 生成 `idegen.jar` 文件；\n* 使用`development/tools/idegen/idegen.sh` 生成AS项目配置\n* 使用AndroidStudio打开生成的配置，导入源码项目\n\n其中 `idegen.sh` 仅是简单的使用java执行idegen.jar，idegen.jar 会在源码根目录生成androidstudio使用的两个文件，即`android.iml`和`android.ipr`，生成过程中会读取 `excluded-paths` 文件，该文件中可以使用正则表达式定义过滤规则，该文件会从三个路径去读取：\n\n* `development/tools/idegen/excluded-paths`\n* `vendor/google/excluded-paths`\n* 源码根目录的 `excluded-paths`\n\n所以我们只需要将自己的过滤规则定义到源码根目录的 `excluded-paths`文件中即可。\n\n`android.iml` 中有三种xml配置: \n\n1）`sourceFolder`;\n\n2) `excludeFolder`;\n\n3) `orderEntry`; \n\nidegen.jar 在执行时会根据配置的规则自动写入这三种规则，其中sourceFolder用于指定源码目录-即as会将其作为源码导入，excludeFolder用于指定排除目录-即as压根不会去搜索任何文件，也不会对其中的文件建立索引，orderEntry 则一般用于指定依赖的jar文件；\n\n在idegen.jar的逻辑中：\n\n* 没有被过滤规则匹配到的目录都会尝试去其中搜寻java及jar文件，只有在其中找到了源码文件，才会被加入到sourceFolder中。\n* 过滤规则中配置的目录，只有其中有java及jar文件时，才会被加入到excludeFolder配置中。\n* 如果目录中找到了java文件，会去读取java文件，自动确认sourceFolder的开始路径，以保证路径能正确匹配包名，如：有个目录`de vice/test/src/java/android/Test.java`，其中Test.java的包为android，那么sourceFolder的路径会自动设置为`de vice/test/src/java/`。\n\n#### 修改idegen代码并编译idegen.jar\n\n修改 `development/tools/idegen` 模块代码及配置\n\n1. `src/Log.java` 为了方便我们查看生成的过程，打开debug日志开关\n\n   ```java\n   class Log {\n   \n       static final boolean DEBUG = true;\n       \n       // ...\n   }\n   ```\n\n2. `src/IntelliJ.java` , 这里由于代码中书写错误，prebuilt 实际上在源码中并不存在，我们手动将其修改为 `prebuilts`\n\n   ```java\n           sourceRootsXml.append(\"<excludeFolder url=\\\"file://$MODULE_DIR$/out/target/product\\\"/>\\n\");\n   // 修改这一行 prebuilt --> prebuilts\n           sourceRootsXml.append(\"<excludeFolder url=\\\"file://$MODULE_DIR$/prebuilts\\\"/>\\n\");\n   \n   ```\n\n3. 编译生成 idegen.jar\n\n   ```shell\n   # 在源码根目录执行\n   source build/envsetup.sh\n   cd development/tools/idegen\n   mm -j16\n   ```\n\n   成功生成后输出如下：\n\n   ```shell\n   [100% 228/228] Install: out/host/darwin-x86/framework/idegen.jar\n   #### build completed successfully (05:30 (mm:ss)) ####\n   ```\n\n\n\n#### 手动获取java文件\n\n##### 手动获取AIDL生成的java文件\n\n我们通过如下命令将aidl生成的java文件拷贝到 源码根目录的`idea/aidl/src`目录下\n\n```shell\ncroot\nmkdir -p idea/aidl/src\nfind out/soong/.intermediates/frameworks/base/api-stubs-docs-non-updatable/android_common/gen/aidl -name \"*.srcjar\" | xargs -I {} unzip {} -d idea/aidl/src\n```\n\n##### 获取生成的资源\n\n```shell\ncp -R out/soong/.intermediates/frameworks/base/core/res/framework-res/android_common/gen/aapt2/R idea/framework-res_R\n```\n\n\n\n#### 编辑排除规则并生成配置\n\n1. 在项目根目录中添加一个 `excluded-paths` 文件，输入如下内容（一行作为一个匹配规则，规则的格式按Java中Pattern类的规则编写）\n\n   ```shell\n   # 几个根目录的规则\n   ^art/.*\n   ^packages/.*\n   ^bootable/.*\n   ^build/.*\n   ^cts/.*\n   ^dalvik/.*\n   ^developers/.*\n   ^external/.*\n   ^platform_testing/.*\n   ^pdk/.*\n   ^sdk/.*\n   ^system/.*\n   ^test/.*\n   \n   # platform-compat中有注解的类\n   ^tools/(?!(platform-compat))\n   ^development/.*\n   ^device/.*\n   ^prebuilts/*\n   \n   # 这里我们查看这两个模块，所以注释掉\n   #^libcore/.*\n   #^frameworks/.*\n   # 关于out其他的一些规则\n   ^out/soong/.intermediates/(?!((frameworks)|(libcore)))\n   # ./out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_x86_64_shared/gen/aidl/android/os/BnServiceManager.h\n   # ^out/soong/.intermediates/.*\n   ^out/target/.*\n   \n   # 根据实际运行情况补充的规则\n   # 移除可能的jar\n   # 如 ./frameworks/base/tools/aapt2/integration-tests/CommandTests/android-28.jar\n   ^frameworks/base/tools/aapt2/.*\\.jar\n   ^frameworks/base/tests\n   ^libcore/support/src/test\n   ^libcore/luni/src/test\n   gradle-wrapper.jar\n   \n   # 对于sdk源码的隐藏，我们exclude掉，以使可以找到真正的源码\n   ^libcore/ojluni/annotations\n   ```\n\n2. 生成iml文件，执行下面命令生成\n\n   ```shell\n   development/tools/idegen/idegen.sh\n   ```\n\n   完成后根目录下即生成了`android.iml`,`android.ipr` \n\n### 导入到AndroidStudio\n\n#### androidstudio 配置\n\n1. 配置jvm选项，根据机器实际情况设置vm分配的内存策略\n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402093304.png\" alt=\"image-20210402093304425\"  />\n\n   ```shell\n   -Xmx16g\n   -Xms2g\n   ```\n\n2. 配置 idea 属性\n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210401212321.png\" alt=\"image-20210401212321136\" style=\"zoom:40%;\" />\n\n   ```shell\n   # 大小写敏感（macOS）\n   idea.case.sensitive.fs=true\n   \n   idea.max.intellisense.filesize=100000\n   ```\n\n#### 导入项目到AS并配置\n\n配置sdk主要是为了避免查看或调试代码时，AS仍然去使用SDK中配置的class，而不是我们的aosp中的java源码。\n\n1. 使用AndroidStudio 打开项目根目录下 `android.ipr` 文件即可导入项目；\n\n2. 配置项目SDK，进入项目设置，添加一个新的JDK，并删除所有依赖jar库，我们这里取名为：`1.8 (No Libraries)`\n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402095209.png\" alt=\"image-20210402095209074\" style=\"zoom:67%;\" />\n\n3. 配置项目SDK，进入项目设置，添加一个新的SDK，并删除所有jar库，对应的JDK选择之前创建的`1.8 (No Libraries)`，这里我们将SDK命名为 `Android API 30 Platform-NoLib`\n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402095255.png\" alt=\"image-20210402095255063\" style=\"zoom:67%;\" />\n\n4. 在Project设置中，选择项目SDK为之前设置的 `Android API 30 Platform-NoLib`\n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402095343.png\" alt=\"image-20210402095343474\" style=\"zoom:67%;\" />\n\n5. 进入项目设置-模块设置，将模块的SDK设置为之前设置的  `Android API 30 Platform-NoLib` \n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402095449.png\" alt=\"image-20210402095449805\" style=\"zoom:67%;\" />\n\n#### 附加调试器到 system_process \n\n1. 附加调试器到 `system_process` 进程\n\n![image-20210402093915683](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402093915.png)\n\n![image-20210402095736899](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402095736.png)\n\n2. 成功后的Debugger界面如下所示\n\n   ![image-20210402100639004](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402100639.png)\n\n3. 打断点测试，这里我们选择在 `Binder.java` 文件中添加断点，然后在模拟器中打开相机APP以触发断点逻辑。下图就表示我们到达了断点，说明我们可以通过AS来调试该进程了。\n\n   ![image-20210402101258438](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402101258.png)\n\n> 提示：附加调试器时，如找不到设备，可参考第5小节中的 *错误解决：Debug中不显示设备*\n\n## 修改并更新系统模块\n\n在调试分析过程中，可能我们需要修改一下其中内容以协助分析，可以按如下方式进行。\n\n### Framework\n\n构建 framework 分两块：\n\n1. JAR 部分使用命令 `mmm frameworks/base/`\n2. 资源部分： `mmm frameworks/base/core/res/`\n\n**安装：**\n\n```shell\n# 获取root权限\nadb root\nadb disable-verity\nadb reboot\nadb remount\n# 移除旧的framework\nadb shell\ncd /system/framework/\nrm framework-res.apk\nexit\n\n# 推入新的framework\nadb push out/target/product/<device_targeted>/system/framework/framework-res.apk /system/framework/\n\n# 重启服务\nadb reboot\n```\n\n### packages中app\n\n* 构建\n\n```shell\ncd ~/aosp\nsource build/envsetup.sh \nlunch aosp_x86_64-eng\n# 重新构建单个模块 (如 Dialer)\nmmm packages/apps/dialer/\n# 生成的文件会在控制台中输出来\n```\n\n* 更新到系统\n\n```shell\nadb install -r out/target/product/<device_targeted>/system/priv-app/<app_name>/<app_name>.apk\nadb reboot\n```\n\n### SystemUI\n\n* 编译\n\n```shell\ncd WORKING_DIRECTORY\nsource build/envsetup.sh\n# 选择设备\nlunch 31\n# 重新构建SystemUI\nmmm frameworks/base/packages/SystemUI/\n```\n\n* 安装到系统\n\n```shell\nadb install -r out/target/product/<device_targeted>/system/priv-app/SystemUI/SystemUI.apk\nadb reboot\n```\n\n\n\n## 使用提示及常见错误\n\n### 使用提示：项目源码浏览配置\n\n#### 筛选Project代码范围\n\n1. 点击project窗口的设置按钮，选择 “Edit Scopes”\n\n   ![image-20210402104239366](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402104239.png)\n\n2. 新建一个规则，输入名称，并在Pattern中输入过滤规则： `file[android]:frameworks//*||file[android]:libcore//*`\n\n   <img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402104205.png\" alt=\"image-20210402104205399\" style=\"zoom:67%;\" />\n\n#### 过滤VCS配置中不必要的模块\n\n打开VCS配置，移除frameworks和libcore之外的所有其他模块\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402105446.png\" alt=\"image-20210402105446083\" style=\"zoom: 67%;\" />\n\n### 使用提示：导入其他模块的源码到AS\n\n不建议直接修改 android.iml 文件，应当通过修改源码根目录自定义的 `excluded-paths` 文件中定义的规则来包含其他模块的源码。\n\n修改此文件后，重新执行 `development/tools/idegen/idegen.sh` 来生成最新的as项目配置。生成完成后一般as如果是打开状态，会自动更新索引，如果索引更新有问题，可关闭项目，然后重新打开。\n\n### 错误解决：macOS .DS_Store 导致打包镜像失败\n\n编译基本完成，但是最后打包system.img文件时报错，报错内容如下：\n\n```shell\nset_selinux_xattr: No such file or directory searching for label \"/.DS_Store\"\ne2fsdroid: No such file or directory while configuring the file system\n\n10:00:38 ninja failed with: exit status 1\n```\n\n解决方式：删除源码目录中的所有 `.DS_Store`，可通过如下命令进行统一清理\n\n```shell\nfind . -name \".DS_Store\"  | xargs -I {} rm {} \n```\n\n> 说明： .DS_Store 文件为macOS中存储文件夹界面展示相关的一些信息，在Finder中查看对应目录后可能会生成\n\n### 错误解决：附加调试器时不显示设备\n\n在附加调试器时，可能会如下图一样，模拟器已经启动了，但是附加调试器的窗口中设备列表中没有设备\n\n![image-20210402121454042](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402121454.png)\n\n此时检查自己的项目配置中的SDK是否选择了AndroidSDK，设置成 Android SDK 即可\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210402121537.png\" alt=\"image-20210402121537412\" style=\"zoom:67%;\" />\n\n\n\n### 错误解决：模拟器无法启动-报找不到内核版本信息\n\n当使用 `android-11.0.0_r28` 版本时，编译通过后，使用emulator启动时，报出如下错误\n\n```shell\nemulator: ERROR: Can't find 'Linux version ' string in kernel image file: /Volumes/HIKVISION/google-aosp/out/target/product/generic_x86_64/kernel-ranchu\n```\n\n原因是emulator版本过旧，需要使用新的emulator，执行如下命令获取新的版本：\n\n```shell\ncd prebuilts/android-emulator\n# 查询可用分支，https://android.googlesource.com/platform/prebuilts/android-emulator/+refs\ngit fetch aosp android-11.0.0_r33:refs/remotes/m/android-11.0.0_r33\n# 检出分支\ngit co -b android-11.0.0_r33 refs/remotes/m/\nandroid-11.0.0_r33\n```\n\n获取完成后再次执行 `emulator` 命令\n\n```shell\nemulator -version\n# Android emulator version 30.3.0.0 (build_id 6946397) (CL:N/A)\nemulator \n# 启动模拟器\n```\n\n## 参考文章\n\n**参考：** \n\n* [使用 Android Studio 阅读 AOSP 源码](https://blog.devwu.com/2019/06/23/how-to-reading-AOSP-with-Android-Studio/)\n* [AOSP Source Code in Android Studio (Explore only)](https://param105.medium.com/aosp-source-code-in-android-studio-explore-only-1cdc3081cf51)\n* [Stackoverflow aosp-and-intellij-idea](https://stackoverflow.com/questions/16582112/aosp-and-intellij-idea)\n* [Building Android O with a Mac - Christopher Ney](https://medium.com/@christopherney/building-android-o-with-a-mac-da07e8bd94f9)\n* [Building Android 11 for PH-1 on Apple Silicon](https://nf4789.medium.com/building-android-11-for-ph-1-on-apple-silicon-6600436a36a0)\n* [Could not find a supported mac sdk: “10.10” “10.11” “10.12” “10.13”](https://stackoverflow.com/questions/50760701/could-not-find-a-supported-mac-sdk-10-10-10-11-10-12-10-13)\n* [创建区分大小写的磁盘映像-source.android.google.cn](https://source.android.google.cn/setup/build/initializing?hl=zh-cn#creating-a-case-sensitive-disk-image)\n\n\n\n",
      "data": {
        "title": "搭建Android源码工作环境",
        "date": "2021-04-08 10:18:50",
        "tags": [
          "Android",
          "源码分析"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": true
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "\n\n* 简单介绍系统架构、编译环境的搭建\n* 简单介绍利用 AndroidStudio 调试 system_process 进程的方法及编译更新部分系统模块的方式",
      "fileName": "搭建Android源码工作环境"
    },
    {
      "content": "仅记录使用Gridea过程中解决的问题及解决方式\n<!-- more -->\n\n\n\n## 下载安装并使用\n访问这里（https://gridea.dev/）下载安装并使用，不赘述。\n\n## 远程同步github配置\n关于建立仓库，获取token，配置pages赘述，仅记录额外的配置。\n\n\n在Gridea的工作目录的根目录中新建一个 `.gitignore` 文件，输入如下内容：\n```txt\n.DS_Store\n*/.DS_Store\n# 自己的本地草稿\ntypora\n```\n> 远程同步时，会将此文件放入到output目录下，然后将output目录推送到github上，为了避免将其中的某些文件推入到远程仓库，故可以通过此方式定义gitignore\n",
      "data": {
        "title": "Gridea使用小记",
        "date": "2021-04-05 11:58:07",
        "tags": [
          "工具"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "仅记录使用Gridea过程中解决的问题及解决方式",
      "fileName": "Gridea使用小记"
    },
    {
      "content": "翻译国外文章，该文章介绍了Android开发中矩阵相关的数学知识，包括矩阵是什么？矩阵加法及乘法运算，2x2矩阵的变换，最后演进为Android中使用的3x3矩阵。文中图片及动图比较多，相对好懂。\n<!-- more -->\n\n\n> 原文链接：https://i-rant.arnaudbos.com/matrices-for-developers/#technical-challenge\n\n几周前，我在一个android-user-group频道上，有人问一个关于Android的Matrix.postScale（sx，sy，px，py）方法及其工作原理的问题，因为它“难以掌握”。 \n\n在2016年初，我在一个Android应用程序上完成了一个自由项目，在其中我必须实现一个令人兴奋的功能： \n\n用户在购买并下载了岩壁的数字地形后，必须能够查看由以下部分组成的岩壁： \n\n* 悬崖的照片， \n* 包含爬坡路线叠加层的SVG文件。 \n\n用户必须具有随意平移和缩放的能力，并且必须具有“跟随”图片的路线层。 \n\n| APP截图1                                                     | APP截图2                                                     | APP截图3                                                     |\n| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| <img src=\"Matrices for developers_files/ca-screenshot-1.png\" alt=\"img\" style=\"zoom:25%;\" /> | <img src=\"Matrices for developers_files/ca-screenshot-2.png\" alt=\"img\" style=\"zoom:25%;\" /> | <img src=\"Matrices for developers_files/ca-screenshot-3.png\" alt=\"img\" style=\"zoom:25%;\" /> |\n\n\n\n## 技术挑战\n\n为了让攀爬路线的图层能够跟随用户的手势操作，我发现我不得不重载Android ImageView，在Canvas上绘制并处理手指手势。 作为一名优秀的工程师：我搜索了Stack Overflow😅 我发现需要`android.graphics.Matrix`类进行2D转换。 \n\n这个类的问题在于，从方法名称来说，你能很清楚的了解它的作用，但是如果没有没有一定的数学背景知识，你很难了解它背后是怎么实现的，比方说下面是matrix的某个方法的API文档说明：\n\n> boolean postScale (float sx, float sy, float px, float py)\n>\n> Postconcats the matrix with the specified scale. M’ = S(sx, sy, px, py) * M\n\n从文档看起它可以通过某些参数缩放某些东西，并通过某种乘法来完成它。不过我还是有很多疑问： \n\n* 它到底是做什么的？ 缩放矩阵？ 那是什么意思，我想缩放画布… \n* 我应该使用preScale还是postScale？ 当我从从手势检测代码获取输入参数，然后进入尝试和错误的无限循环时，是否需要尝试同时使用这两个方法？ \n\n因此，在开发过程的这一刻，我意识到在完成大学的头两年后，我需要重新学习很多年前关于矩阵的基本数学技能。 \n\n\n\n在搜寻网络资料时，我发现了很多不错的资源，并且能够再次学习一些数学知识。 通过将我的理解应用到Java和Android中的代码，它还帮助我解决了2D转换问题。 因此，考虑到我在上面提到的频道上进行的讨论，似乎我不是唯一一个在矩阵中苦苦挣扎的人，试图弄明白这一点，并在Android的Matrix类和方法中使用这些技能，所以我想我会写一篇文章，第一部分是关于矩阵的，第二部分“[使用Android和Java进行2D转换](https://i-rant.arnaudbos.com/2d-transformations-android-java/)”是关于如何在Java和Android上将关于矩阵的知识应用到代码中。 \n\n## Matrix是什么？\n\n我在可汗学院（Khan Academy）上发现一门[关于矩阵的很好的代数课程](https://www.khanacademy.org/math/algebra-home/alg-matrices)。 \n\n如果你也遇到此类问题，我觉得你也可以花时间来学习这个课程，等到你觉得“原来就是这样”，就差不多了。实际上学习这些课程只需几个小时的投资，而且课程是免费的，你一定不会后悔。 \n\n矩阵擅长表示数据，所以对矩阵的操作可以帮助您解决此数据上的问题。还记得在学校必须解线性方程组吗？\n\n解线性方程组最常见方法（至少是我研究过的两种方法）是消元法或行减少方法。不过，我们也可以使用矩阵来进行线性方程组的求解。\n\n矩阵在每个科学分支中都大量使用，它们也可以用于线性变换来描述点在空间中的位置，这就是我们将在本文中简要研究的。 \n\n### 解刨\n\n简单来说，矩阵是一个二维数组，实际上，一个 $m\\ \\times n$ 的矩阵可以对应于一个长度为 $m$ 的数组，该数组的每个item是另外一个长度为 $n$ 的数组。 通常来说 $m$ 代表了行数，$n$ 代表列数，matrix中的每个元素称之为 条目-$entry$ .\n\n矩阵使用一个粗体大写字母表示，每个 $entry$ 使用对应的小写字母表示，同时使用行号和列号组合成为下标，一个矩阵的示例如下：\n$$\n\\textbf{A} = \\begin{pmatrix} \na_{11} & a_{12} &  ...  & a_{1n} \\\\ \na_{21} & a_{12} &  ...  & a_{1n} \\\\ \n⋮ & ⋮ &  ⋱  & ⋮ \\\\ \na_{m1} & a_{m2} &  ...  & a_{mn} \\\\ \n\\end{pmatrix}\n$$\n\n\n接下来我们将学习矩阵的一些运算：[加法和减法](https://www.khanacademy.org/bigbingo_redirect?continue=https%3A%2F%2Fwww.khanacademy.org%2Fmath%2Falgebra-home%2Falg-matrices%2Falg-adding-and-subtracting-matrices%2Fv%2Fmatrix-addition-and-subtraction-1&conversion_ids=condensed_tutorial_title_click)和[乘法（multiplication）](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-multiplying-matrices-by-matrices/a/multiplying-matrices)。 \n\n### 加法和减法\n\n[矩阵的加法和减法](https://www.khanacademy.org/bigbingo_redirect?continue=https%3A%2F%2Fwww.khanacademy.org%2Fmath%2Falgebra-home%2Falg-matrices%2Falg-adding-and-subtracting-matrices%2Fv%2Fmatrix-addition-and-subtraction-1&conversion_ids=condensed_tutorial_title_click)是通过矩阵的相应的entry相加或相减来完成的，计算方式如下：\n$$\n\\textbf{A} + \\textbf{B} = \\begin{pmatrix} \na_{11} & a_{12} &  ...  & a_{1n} \\\\ \na_{21} & a_{12} &  ...  & a_{1n} \\\\ \n⋮ & ⋮ &  ⋱  & ⋮ \\\\ \na_{m1} & a_{m2} &  ...  & a_{mn} \\\\ \n\\end{pmatrix} + \n\\begin{pmatrix} \nb_{11} & b_{12} &  ...  & b_{1n} \\\\ \nb_{21} & b_{12} &  ...  & b_{1n} \\\\ \n⋮ & ⋮ &  ⋱  & ⋮ \\\\ \nb_{m1} & b_{m2} &  ...  & b_{mn} \\\\ \n\\end{pmatrix}= \n\\begin{pmatrix} \na_{11} + b_{11} & a_{12}+b_{12} &  ...  & a_{1n}+b_{1n} \\\\ \na_{21}+b_{21} \t& a_{12}+b_{12} &  ...  & a_{1n}+b_{1n} \\\\ \n⋮ \t\t\t\t&\t⋮ \t\t\t&   ⋱  \t& \t⋮ \t\t\t\\\\ \na_{m1}+b_{m1} \t& a_{m2}+b_{m2} &  ...  & a_{mn}+b_{mn} \\\\ \n\\end{pmatrix}\n$$\n从上面的计算方式可以确定，矩阵的加法和减法只能是两个具有相同维度（$m \\times n$）的矩阵之间进行；\n\n**加法示例：**\n$$\n\\textbf{A} + \\textbf{B} = \\begin{pmatrix} \n4 & -8  &  7 \\\\ \n0 & 2 &  3 \\\\ \n15 & 4 & 9 \\\\\n\\end{pmatrix} + \n\\begin{pmatrix} \n-5 & 2  & 3 \\\\\n4 & -1 & 6 \\\\\n0 & 12 & 3 \\\\\n\\end{pmatrix}= \n\\begin{pmatrix} \n4+(-5) & (-8)+2 & 7+3 \\\\\n0+4 & 2+(-1) & (-1)+6 \\\\\n15+0 & 4+12 & 9+3 \\\\\n\\end{pmatrix}= \n\\begin{pmatrix} \n-1 & -6 & 10 \\\\\n4 & 1 & -5 \\\\\n15 & 16 & 12 \\\\\n\\end{pmatrix}\n$$\n\n**减法示例：**\n$$\n\\textbf{A} + \\textbf{B} = \n\\begin{pmatrix} \n    4 & -8  &  7 \\\\ \n    0 & 2 &  3 \\\\ \n    15 & 4 & 9 \\\\\n\\end{pmatrix}+ \n\\begin{pmatrix} \n    -5 & 2  & 3 \\\\\n    4 & -1 & 6 \\\\\n    0 & 12 & 3 \\\\\n\\end{pmatrix}= \n\\begin{pmatrix} \n    4-(-5) & (-8)-2 & 7-3 \\\\\n    0-4 & 2-(-1) & (-1)-6 \\\\\n    15-0 & 4-12 & 9-3 \\\\\n\\end{pmatrix}= \n\\begin{pmatrix} \n    9  &  -10  &   4 \\\\\n    -4  &   3  &  -7 \\\\\n    15  &  -8  &   6 \\\\\n\\end{pmatrix}\n$$\n\n\n### 矩阵乘法\n\n上数学课的时候，老师说过：“你不能在橘子里加苹果，这是没有道理的”，然后告诉我们单位在运算中的重要性，也就是不同单位的操作数不能进行运算。 \n\n但是，对于矩阵来说，苹果和橙子相乘是合法的，我们只能将矩阵加到相同维度的矩阵上，但是我们可以将矩阵与数字和其他维度不同的矩阵相乘。 \n\n#### 标量 $\\times$ 矩阵\n\n在矩阵的乘法中，单一的数字实际上应该称之为标量（$\\textbf{scalar}$），下面的运算中，实际上不是将矩阵乘以数字，而是将矩阵乘以标量。矩阵乘以标量的计算方式是：**将矩阵中的每个条目乘以标量，然后得到另外一个矩阵**。 \n$$\n\\textit{k} . \\textbf{A} =  \n\\textit{k} .\n\\begin{pmatrix} \na_{11} & a_{12} &  ...  & a_{1n} \\\\ \na_{21} & a_{12} &  ...  & a_{1n} \\\\ \n⋮ & ⋮ &  ⋱  & ⋮ \\\\ \na_{m1} & a_{m2} &  ...  & a_{mn} \\\\ \n\\end{pmatrix}= \n\\begin{pmatrix} \n\\textit{k} . a_{11} & \\textit{k} . a_{12} &  ...  & \\textit{k} . a_{1n} \\\\ \n\\textit{k} .a_{21} \t& \\textit{k} . a_{12} &  ...  & \\textit{k} . a_{1n} \\\\ \n⋮ \t\t\t\t&\t⋮ \t\t\t&   ⋱  \t& \t⋮ \t\t\t\\\\ \n\\textit{k} .a_{m1} \t& \\textit{k} . a_{m2} &  ...  & \\textit{k} . a_{mn} \\\\ \n\\end{pmatrix}\n$$\n一个简单的**示例**如下：\n$$\n4 . \\begin{pmatrix}\n0 & 3 & 12 \\\\\n7 & -5 & 1 \\\\\n-8 & 2 & 0  \\\\\n\\end{pmatrix} =  \n\\begin{pmatrix}\n0 & 12 & 48 \\\\\n28 & -20 & 4 \\\\\n-32 & 8 & 0  \\\\\n\\end{pmatrix} \n$$\n\n\n#### 矩阵 $\\times$ 矩阵\n\n另外一种矩阵乘法就是 [矩阵乘以矩阵](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-multiplying-matrices-by-matrices/a/multiplying-matrices) ，矩阵乘法运算起来稍微有点复杂，因为我们并不能简单的对应的entry进行乘法运算，具体计算规则我们直接看维基百科的说明：\n\n> 如果 $\\mathbf{A}$ 是一个 $m \\times n$ 的 矩阵，$\\mathbf{B}$ 是一个 $n \\times p$ 的matrix, 那么它们的矩阵乘积 $\\mathbf{AB}$ 是一个 $m \\times p $的矩阵, \n>\n> 其中矩阵 $\\mathbf{A}$ 行中的 $n$ 个条目与矩阵 $\\mathbf{B}$ 列中的 $n$ 个条目 相乘并求和 得出矩阵 $\\mathbf{AB}$ 的条目。\n\n看起来有点复杂，让我们逐段分解的来看：\n\n> 如果 $\\mathbf{A}$ 是一个 $m \\times n$ 的 矩阵，$\\mathbf{B}$ 是一个 $n \\times p$ 的matrix, 那么它们的矩阵乘积 $\\mathbf{AB}$ 是一个 $m \\times p$ 的矩阵\n\n上面的规则我们可以写成： $\\mathbf{A}_{m \\times n}  \\times \\mathbf{B}_{n \\times p} = \\mathbf{AB}_{m \\times p}$\n\n看一个简单的矩阵 $\\mathbf{A}_{2 \\times 3} = \\begin{pmatrix} a_{11} & a_{12} & a_{13} \\\\ a_{21}&a_{22}&a_{23} \\end{pmatrix}$ 和另外一个矩阵 $\\mathbf{B}_{3 \\times 1} = \\begin{pmatrix} b_{11} \\\\ b_{21} \\\\ b_{31}  \\end{pmatrix}$ ，这里$m = 2, n=3, p=1$，所以矩阵乘积为一个$2\\times1$的矩阵： $\\mathbf{AB}=\\begin{pmatrix} ab_{11} \\\\ ab_{12} \\end{pmatrix}$。\n\n接下来我们分解第二部分：\n\n* ==矩阵 $\\mathbf{A}$ 行中的 $n$ 个条目== 指的是：矩阵 $\\mathbf{A}$ 的每一行都是一个 $n=3$ 的数组，第一行我们可以记为 $a_{11}, a_{12} , a_{13}$\n* ==矩阵 $\\mathbf{B}$ 列中的 $n$ 个条目== 指的是：矩阵 $\\mathbf{B}$ 中的每一列也是一个 $n=3$ 的数组，第一列可以记为： $b_{11}, b_{12} , b_{13}$\n* ==相乘== 指： $\\mathbf{A}$ 的行中的每个条目都与 $\\mathbf{B}$ 的列中的每个对应条目一一相乘（第一个条目对应第一个，第二对第二，依次），结果就是：$a_{11} \\times b_{11}, a_{12} \\times b_{12} \\ 和 \\  a_{13} \\times b_{13}$\n* ==求和== 指：累加这些对应的行和列条目的乘积，得到新的矩阵在该行号和列号处的新的条目，新的条目的值为：$a_ {11} \\times b_ {11} + a_ {12} \\times b_ {21} + a_{13} \\times b_ {31}$\n\n$$\n\\mathbf{A} = \\begin{pmatrix} a_{11} & a_{12} & \\cdots & a_{1n}\\\\ a_{21} & a_{22} & \\vdots & a_{2n}\\\\ \\vdots & \\vdots & \\ddots & \\vdots\\\\ a_{m1} & a_{m2} & \\cdots & a_{mn} \\end{pmatrix} \\text{, } \\mathbf{B} = \\begin{pmatrix} b_{11} & b_{12} & \\cdots & b_{1p}\\\\ b_{21} & b_{22} & \\vdots & b_{2p}\\\\ \\vdots & \\vdots & \\ddots & \\vdots\\\\ b_{n1} & b_{n2} & \\cdots & b_{np} \\end{pmatrix} \\\\ \\\\\n\\mathbf{AB} = \\begin{pmatrix} ab_{11} & ab_{12} & \\cdots & ab_{1p}\\\\ ab_{21} & ab_{22} & \\vdots & ab_{2p}\\\\ \\vdots & \\vdots & \\ddots & \\vdots\\\\ ab_{m1} & ab_{m2} & \\cdots & ab_{mp} \\end{pmatrix} \\text{其中 } ab_{ij}=\\sum_{k=1}^{m}a_{ik}b_{kj}\n$$\n\n我们用一个可视化的方式来表示这个过程：\n\n![Matrix multiplication diagram 2](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308191112.png)\n\n$$\n\\mathbf{A} = \\begin{pmatrix} 4 & 3\\\\ 0 & -5\\\\ 2 & 1\\\\ -6 & 8 \\end{pmatrix} \\text{, } \\mathbf{B} = \\begin{pmatrix} 7 & 1 & 3\\\\ -2 & 4 & 1 \\end{pmatrix}\n\\\\ \n\\begin{aligned} \\mathbf{AB} &= \\begin{pmatrix} 4\\times7+3\\times\\left(-2\\right) & 4\\times1+3\\times4 & 4\\times3+3\\times1\\\\ 0\\times7+\\left(-5\\right)\\times\\left(-2\\right) & 0\\times1+\\left(-5\\right)\\times4 & 0\\times3+\\left(-5\\right)\\times1\\\\ 2\\times7+1\\times\\left(-2\\right) & 2\\times1+1\\times4 & 2\\times3+1\\times1\\\\ \\left(-6\\right)\\times7+8\\times\\left(-2\\right) & \\left(-6\\right)\\times1+8\\times4 & \\left(-6\\right)\\times3+8\\times1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 28-6 & 4+12 & 12+3\\\\ 0+10 & 0-20 & 0-5\\\\ 14-2 & 2+4 & 6+1\\\\ -42-16 & -6+32 & -18+8 \\end{pmatrix}\\\\\\\\ \\mathbf{AB} &= \\begin{pmatrix} 22 & 16 & 15\\\\ 10 & -20 & -5\\\\ 12 & 6 & 7\\\\ -58 & 26 & -10 \\end{pmatrix} \\end{aligned}\n$$\n\n\n> 注意：\n>\n> 为了定义矩阵乘法，==第一个矩阵中的列数==必须等于==第二个矩阵中的行数==。\n\n\n**了解更多：**\n\n* [了解更多](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-properties-of-matrix-multiplication/v/defined-and-undefined-matrix-operations)\n* [了解更多](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-properties-of-matrix-multiplication/a/matrix-multiplication-dimensions)\n\n## 变换矩阵\n\n现在我们知道了矩阵是什么，并且知道矩阵如何相乘，接下来我们看下矩阵如何应用于二维变换；\n\n### 转换点\n\n正如之前所说，矩阵可以被用于表示线性方程组，假设我们有如下方程组：\n$$\n2x + y = 5 \\\\\n-x + 2y = 0\n$$\n如果你对矩阵乘法很熟悉，你可能看到上述方程中隐藏的矩阵乘法：\n$$\n\\begin{pmatrix}\n2 & 1 \\\\\n-1 & 2 \\\\ \n\\end{pmatrix} \n. \n\\begin{pmatrix}\nx \\\\ y \n\\end{pmatrix}=\n\\begin{pmatrix}\n5 \\\\ 0\n\\end{pmatrix}\n$$\n如果你看的更深一点，你可能会发现基于矩阵$\\begin{pmatrix} x \\\\ y \\end{pmatrix}$ 和 $\\begin{pmatrix} 5 \\\\ 0 \\end{pmatrix}$的一些规律。\n\n那就是：这两个矩阵都可以被用来代表笛卡尔平面中的点，一个点可以用源自原点的向量表示，这个向量是一个 $2×1$ 的矩阵。 \n\n我们现在知道了一个矩阵乘法就代表了一个点到另外一个点的转换，尽管我们目前还不知道第一个点的坐标是什么，不过不用担心，我们只需要知道，给定一个位置矢量，我们就可以通过矩阵乘法运算将其转换为另外一个矢量。\n\n如果一个点 $\\mathbf{P}$ 是一个值为$\\begin{pmatrix} x\\\\y \\end{pmatrix}$ 的位置矢量，我们可以乘一个矩阵来得到一个新的点 $\\mathbf{P}^{'}$\n\n它可以通过位置矢量 $\\begin{pmatrix} x^{'} \\\\ y^{'} \\end{pmatrix}$ 来表示；\n\n一个重要的点在于，为了满足矩阵乘法的要求，[矩阵变换](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-matrices-as-transformations/v/transforming-position-vector)必须拥有特定的维度，因为源位置矢量 $\\begin{pmatrix} x\\\\y \\end{pmatrix}$ 是一个 $2\\times 1$ 的矩阵，而目标位置矢量 $\\begin{pmatrix} x^{'} \\\\ y^{'} \\end{pmatrix}$ 也是一个 $2 \\times 1$ 的矩阵，所以变换矩阵必须是一个 $2 \\times 2$ 的矩阵，这样才能满足矩阵乘法的要求：\n$$\n\\mathbf{A} . \\begin{pmatrix} x\\\\y \\end{pmatrix} = \\begin{pmatrix} a_{11} & a_{12}\\\\ a_{21} & a_{22} \\end{pmatrix} . \\begin{pmatrix} x\\\\y \\end{pmatrix} = \\begin{pmatrix} x^{\\prime}\\\\y^{\\prime} \\end{pmatrix}\n$$\n\n> 1. 第一个矩阵的列数必须等于第二个矩阵的行数，所以第一个矩阵的列数需要为 2 \n> 2. 矩阵相乘得到的矩阵的尺寸为 $第一个矩阵的行数 \\times 第二个矩阵的列数$，为了得到一个 $2 \\times 1$ 的结果矩阵，则==第一个矩阵的行数== 为 2\n> 3. 故变换矩阵的行列数为：$2 \\times 2$\n> 4. 提示：后面我们会看到，矩阵乘法中的顺序很重要。比方说上面的矩阵乘法，如果调换 $\\mathbf{A}$ 和 $\\begin{pmatrix} x\\\\y \\end{pmatrix}$ 的顺序，则无法获得一个新的点： $P_{2\\times1} . A_{1\\times n}=P^{'}_{2 \\times n}$（不成立）\n\n>  转换矩阵的另外一个非常好用的地方在于，它可以同时[批量的转换一批点](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-matrices-as-transformations/v/matrix-transformation-triangle)；\n\n$$\n\\mathbf{A} . \\begin{pmatrix} x\\\\y \\end{pmatrix} = \\begin{pmatrix} a_{11} & a_{12}\\\\ a_{21} & a_{22} \\end{pmatrix} . \\begin{pmatrix} x\\\\y \\end{pmatrix} = \\begin{pmatrix} x^{\\prime}\\\\y^{\\prime} \\end{pmatrix}\n$$\n\n\n\n假设你知道所需要的应用的所有转换类型（`rotation`,`scale`,`translation`）及其他参数。\n\n那么，如何获得缩放2倍并沿着顺时针方向旋转90度的转换矩阵呢？ \n\n答案是：我们需要更多数学知识。\n\n### 更多数学知识 \n\n建议大家阅读[此课程](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-matrices-as-transformations/a/matrices-as-transformations)中有关变换的矩阵课程（其中有大量精美的图示和动画），特别是它的最后一部分：*用矩阵表示二维线性变换*，讲的非常不错；\n\n回到我们刚才讨论的问题，现在让我们了解更多数学知识吧。\n\n现在我假设你学习了上面的课程，下面的部分是对该课程的简单回顾：\n\n* 一个位置矢量 $\\begin{pmatrix}x \\\\ y \\end{pmatrix}$ 可以被表示为 ： $\\begin{pmatrix}x \\\\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$\n\n  > **解释：**\n  >\n  > $\\begin{pmatrix}x \\\\ y \\end{pmatrix}$ 可以被分解为一个矩阵加法运算： $\\begin{pmatrix}x \\\\ y \\end{pmatrix} = \\begin{pmatrix}x \\\\ 0 \\end{pmatrix} + \\begin{pmatrix}0 \\\\ y \\end{pmatrix}$ \n  >\n  > 其中的每个加法的运算矩阵都可以被继续拆分为一个标量同矩阵的乘法：\n  >\n  > * $\\begin{pmatrix} x \\\\ 0 \\end{pmatrix} = x . \\begin{pmatrix} 1 \\\\ 0 \\end{pmatrix}$ \n  > * $\\begin{pmatrix} 0 \\\\ y \\end{pmatrix} = y . \\begin{pmatrix} 0 \\\\ 1 \\end{pmatrix}$ \n  >\n  > 现在，我们看其中的矩阵 $\\begin{pmatrix} 1\\\\0 \\end{pmatrix}$ 和 $\\begin{pmatrix} 0 \\\\1 \\end{pmatrix}$，其实它们是笛卡尔坐标平面的单位矢量；\n  >\n  > 因此， $\\begin{pmatrix}x \\\\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$ 就是位置矢量 $\\begin{pmatrix}x \\\\ y \\end{pmatrix}$ 的另外一种写法，它代表了由我们的笛卡尔平面的单位向量的变换给出的点。 \n\n* 在应用了变换矩阵$\\mathbf{A} = \\begin{pmatrix} \\color{Green} a & \\color{Red} b\\\\ \\color{Green} c & \\color{Red} d \\end{pmatrix}$ 之后， $\\begin{pmatrix} \\color{Green}a\\\\\\color{Green}c \\end{pmatrix}$ 和 $\\begin{pmatrix}\\color{Red} b\\\\ \\color{Red} d\\end{pmatrix}$ 将被分别放置于 $\\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix}$ 和 $\\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$ 的位置；\n\n  > **解释：**\n  >\n  > 我们依然从单位矢量 $\\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix}$和 $\\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$ 开始\n  >\n  > 我们知道 $\\begin{pmatrix}x \\\\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$，现在我们想像一下，如果我们应用一个变换到我们的平面上，那么我们的单位矢量也会随之变换吧？ \n  >\n  > 我们假设变换后 $\\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix}$ 会坐落在 $\\begin{pmatrix} \\color{Green}a \\\\ \\color{Green}c \\end{pmatrix}$ 上，而$\\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$ 会落在 $\\begin{pmatrix} \\color{Red}b \\\\ \\color{Red}d \\end{pmatrix}$ 上，那么我们的位置矢量 $\\begin{pmatrix}x \\\\ y \\end{pmatrix}$  将会落在 $x.\\begin{pmatrix}\\color{Green} a \\\\ c \\end{pmatrix} + y.\\begin{pmatrix} \\color{Red} b\\\\d  \\end{pmatrix} = \\begin{pmatrix}\\color{Green}a.x + \\color{Red}b.y \\\\ {\\color{Green}c.x + \\color{Red}d.y}  \\end{pmatrix}$\n\n* 经过上面的矩阵变换，$\\begin{pmatrix} x \\\\ y \\end{pmatrix}$ 将会坐落于 $\\begin{pmatrix} \\color{Green}a.x + \\color{Red}b.y \\\\ \\color{Green}c.x + \\color{Red}d.y \\\\ \\end{pmatrix}$\n\n如果你无法理解上面的变换过程，请学习上面的课程并反复阅读。\n\n\n\n现在，我们需要明确我们的目标，就是：我们需要找出我们的变换矩阵 $\\mathbf{A}$ ，因为我们知道了我们想要应用的转换，但是我们需要找到那个能够应用到我们的位置矢量上来转换我们图形的矩阵；\n\n让我们以一系列点的转换为例：我们知道位置矢量将到达的位置，但是我们需要求出矩阵 $\\mathbf{A}$ 。 \n\n我们的笛卡尔平面上有一个由三个点 $\\mathbf{P}_{(2,1)},\\mathbf{Q}_{(2,0)}  \\mathbf{R}_{(0,2)}$ P组成的三角形， 以及另一个代表第一个三角形的变换版本的三角形：$\\mathbf{P}^{'}_{(5,0)},\\mathbf{Q}^{'}_{(-4,2)}  \\mathbf{R}^{'}_{(2,4)}$ \n\n![2D-transformed-triangle](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308214033.png)\n\n上面的例子中我们只需要两个点就可以求解出矩阵$\\mathbf{A}$，我们使用 $\\mathbf{P}$ 和 $\\mathbf{Q}$，我们知道，变换之后：\n$$\n\\begin{pmatrix} 2\\\\ 1 \\end{pmatrix} \\text{ 位于 } \\begin{pmatrix} 5\\\\ 0 \\end{pmatrix} \n\\\\\n\\\\\n\\begin{pmatrix} -2\\\\ 0 \\end{pmatrix} \\text{ 位于 } \\begin{pmatrix} -4\\\\ 2 \\end{pmatrix}\n$$\n也就是说：\n$$\n\\begin{pmatrix} x\\\\ y \\end{pmatrix} = \\begin{pmatrix} 2\\\\ 1 \\end{pmatrix} \\text{ 位于 } \\begin{pmatrix} a.x+b.y\\\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} 5\\\\ 0 \\end{pmatrix}\n\\\\\n\\\\\n\\begin{pmatrix} x\\\\ y \\end{pmatrix} = \\begin{pmatrix} -2\\\\ 0 \\end{pmatrix} \\text{ 位于 } \\begin{pmatrix} a.x+b.y\\\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} -4\\\\ 2 \\end{pmatrix}\n$$\n简化之后就是：\n$$\n\\begin{pmatrix} 2.a+1.b\\\\ 2.c+1.d \\end{pmatrix} = \\begin{pmatrix} 5\\\\ 0 \\end{pmatrix}\n\\\\\n\\begin{pmatrix} -2.a+0.b\\\\ -2.c+0.d \\end{pmatrix} = \\begin{pmatrix} -4\\\\ 2 \\end{pmatrix}\n$$\n通过第2个等式可以算出， $a=2$ ，$c=-1$，代入到第一个等式中可以得出： $b=1$, $d =2$，现在我们得到了我们的变换矩阵：\n$$\n\\mathbf{A} = \\begin{pmatrix} \\color{Green} 2 & \\color{Red} 1\\\\ \\color{Green} -\\color{Green} 1 & \\color{Red} 2 \\end{pmatrix}\n$$\n\n### 单位矩阵\n\n现在我们还不知道如何定义一个转换矩阵，但是我们知道它的表示形式。接下来我们要做什么呢？还记得在上一个小节中，我们说过，一个位置$\\begin{pmatrix}x \\\\ y \\end{pmatrix}$ 可以被表示为 $\\begin{pmatrix}x \\\\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\\\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\\\ \\color{Red}1 \\end{pmatrix}$ ，这是一个很好的起点，我们刚刚列出了我们的==基本==矩阵：\n\n$$\n\\begin{pmatrix} \\color{Green}1 & \\color{Red}0 \\\\ \\color{Green} 0  & \\color{Red} 1 \\end{pmatrix}\n$$\n\n这个矩阵代表了你的平面的基础状态，也就是刚加载图像时应用于平面的矩阵（图像与其变换后的容器视图的大小相同），换一种说法就是，应用了这个矩阵的位置矢量将会返回一样的位置矢量。这样的矩阵就称之为 ==单位矩阵==([identity matrix](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-properties-of-matrix-multiplication/a/intro-to-identity-matrices))\n\n### 结合多种变换\n\n在我们了解更多细节之前，还有一件事，就是：我们希望用户能够组合/链接多种变换（例如，同时缩放和平移）。 \n\n为了能链接多个转换，我们需要理解[矩阵乘法的性质](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-properties-of-matrix-multiplication/a/properties-of-matrix-multiplication) 。更具体的说是我们需要了解矩阵乘法的==非交换性(non-commutative)==和==结合性==(associative)\n\n* 矩阵乘法是可结合的： $\\left(\\mathbf{A}.\\mathbf{B}\\right).\\mathbf{C} = \\mathbf{A}.\\left(\\mathbf{B}.\\mathbf{C}\\right)$\n* 矩阵乘法是不可交换的：$\\mathbf{A}.\\mathbf{B} \\neq \\mathbf{B}.\\mathbf{A}$\n\n回到我们的变换，想象我们想要应用变换 $\\mathbf{B}$ ,然后应用变换 $\\mathbf{A}$ 到我们的位置矢量 $\\vec{v}$ ,两次变换可以分别表示为：$\\vec{v^{\\prime}} = \\mathbf{B} . \\vec{v}$ 及 $\\vec{v^{\\prime\\prime}} = \\mathbf{A} . \\vec{v^{\\prime}}$ ,结合下来：\n\n$$\n\\vec{v^{\\prime\\prime}} = \\mathbf{A} . \\left( \\mathbf{B} . \\vec{v} \\right)\n$$\n因为矩阵乘法是可以结合的，所以：\n$$\n\\vec{v^{\\prime\\prime}} = \\mathbf{A} . \\left( \\mathbf{B} . \\vec{v} \\right) \\Leftrightarrow \\vec{v^{\\prime\\prime}} = \\left( \\mathbf{A} . \\mathbf{B} \\right) . \\vec{v}\n$$\n因为矩阵乘法是不可交换的，所以两个变换矩阵的应用顺序不可改变，即 $\\mathbf{A}.\\mathbf{B}$ 不能变换成 $\\mathbf{B}.\\mathbf{A}$，否则将会产生不同的变换效果；\n\n> 注意这里矩阵变换应用的顺序和转换成乘法之后的矩阵顺序，我们先应用$\\mathbf{B}$，然后再应用 $\\mathbf{A}$，结合之后的顺序是 ：$\\mathbf{A.B}$\n\n## 变换类型\n\n使用 $2\\times2$ 的矩阵我们可以定义多种不同类型的二维变换类型，你可能已经在课程  [matrices as transformations](https://www.khanacademy.org/math/algebra-home/alg-matrices/alg-matrices-as-transformations/a/matrices-as-transformations) 中了解了其中的大部分变换，这些变换包括：\n\n* 缩放\n* Reflexion-反射\n* Shearing\n* Rotation-旋转\n\n本小节中，我们假设我们有一个点 $\\mathbf{P}_{(x,y)}$，这个点代表了平面中的任一个点，我们希望找到一个矩阵能将点转换到 $\\mathbf{P^{'}}_{(x^{'},y^{'})}$，也就是：\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime} \\end{pmatrix} = \\mathbf{A} . \\begin{pmatrix} x\\\\y \\end{pmatrix} = \\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} . \\begin{pmatrix} x\\\\y \\end{pmatrix}\n$$\n\n### Scaling\n\n缩放看起来很好表示，比方说放大2倍，只需将坐标乘以比例因子就可以了，但是我们可能希望对转换使用不同的水平和垂直缩放比例，这种情况下我们应该怎么做呢？\n\n为了能够在不同的方向使用不同的缩放比例，我们必须区分水平和垂直方向的缩放比例，它们分别使用$S_{x}$ 和$S_{y}$表示；\n\n我们可以得到如下两个等式：\n$$\n\\begin{aligned} x' &= S_{x} . x \\\\ y' &= S_{y} . y \\end{aligned}\n$$\n结合之前的矩阵：\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime} \\end{pmatrix} = \\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} . \\begin{pmatrix} x\\\\y \\end{pmatrix}\n$$\n我们可以得到 $a,b,c,d$ 如下：\n$$\n\\left.\n\\begin{aligned} S_{x} . x &= a . x + b . y\\\\\\\\ \\Rightarrow a &= S_{x} \\text{ 且 }\\\\ b &= 0 \\end{aligned}\n\\middle |\n\\begin{aligned} S_{y} . y &= c . x + d . y\\\\\\\\ \\Rightarrow c &= S_{y} \\text{ 且 }\\\\ d &= 0 \\end{aligned}\n\\right.\n$$\n\n缩放比例$(S_x,S_y)$ 对应的 $2\\times2$ 缩放矩阵就是：\n$$\n \\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} =\n  \\begin{pmatrix} S_x & 0\\\\0 & S_y \\end{pmatrix}\n$$\n当缩放比例为 $1$ 时，应用这个缩放矩阵是：\n$$\n\\begin{pmatrix} S_{x} & 0\\\\0 & S_{y} \\end{pmatrix} = \\begin{pmatrix} 1 & 0\\\\0 & 1 \\end{pmatrix}\n$$\n也就是单位矩阵，应用之后 $x$，$y$ 均不会改变，这与单位矩阵的意义符合。\n\n### Reflexion-仿射\n\n仿射，我们可以考虑两种前方的仿射类型：围绕轴或围绕点的仿射。 \n\n为简单起见，我们将重点放在$x$和$y$轴周围的仿射（原点周围的反射等同于在$x$和$y$轴上连续施加仿射）。 \n\n围绕 $x$ 轴的反射：\n$$\n\\left.\\begin{aligned} x^{\\prime} &= x\\\\ x &= a . x + b . y\\\\\\\\ \\Rightarrow a &= 1 \\text{ and }\\\\ b &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= -y\\\\ -y &= c . x + d . y\\\\\\\\ \\Rightarrow c &= 0 \\text{ and }\\\\ d &= -1 \\end{aligned}\n\\right. \n$$\n有趣的是，围绕 $x$ 轴的仿射和使用 -1 作为缩放因子对$x$ 进行缩放的转换矩阵一致；\n$$\n\\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} = \\begin{pmatrix} 1 & 0\\\\ 0 & -1 \\end{pmatrix}\n$$\n围绕 $y$ 轴方向的仿射：\n$$\n\\left.\n\\begin{aligned} x^{\\prime} &= -x\\\\ -x &= a . x + b . y\\\\\\\\ \\Rightarrow a &= -1 \\text{ and }\\\\ b &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= y\\\\ y &= c . x + d . y\\\\\\\\ \\Rightarrow c &= 0 \\text{ and }\\\\ d &= 1 \\end{aligned}\n\\right.\n$$\n转换矩阵：\n$$\n\\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} = \\begin{pmatrix} -1 & 0\\\\ 0 & 1 \\end{pmatrix}\n$$\n\n### Shearing-剪切\n\n这个Shearing变换有些复杂。\n\n在我发现的大多数示例中，剪切都是通过添加一个可以代表shearing角度的常量来更改坐标来解释的。\n\n比方说，一个沿着$x$ 轴方向的 shear 通常使用一个顶点位于$(0,1)$ 的矩形变换成一个顶点位于 $(1,1)$ 的平行四边形来解释；\n\n![2D-constant-shearing](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308225012.png)\n\n<center>Shearing along x axis by a constant k<sub>x</sub>=1</center>\n\n不过在这篇文章中，我想用剪切角（轴被剪切的角度）来解释它。我们称之为 $\\alpha$ （alpha）。\n\n![2D-angle-shearing](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308230002.gif)\n\n![D-angle-shearing](Matrices for developers_files/2D-angle-shearing.gif)\n\n<center>Shearing along x axis by an angle α</center>\n\n如果看上面的平面，我们可以看到新的横坐标 $x^{\\prime}$ 等于$x$加/减去$y$轴，$y$轴的剪切形式以及矩形左上角顶点与平行四边形左上角顶点之间的线段所形成的三角形的相对边。 换句话说，$x ^{\\prime}$ 等于 $x$​ 加/减绿色三角形的另一侧\n\n| ![2D-angle-shearing-triangles-1](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308231659.png) | ![2D-angle-shearing-triangles-2](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308231705.png) |\n| ------------------------------------------------------------ | ------------------------------------------------------------ |\n| ![2D-angle-shearing-triangles-3](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308231710.png) | ![2D-angle-shearing-triangles-4](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210308231717.png) |\n\n> 在直角三角形中： \n>\n> * 斜边(==*hypotenuse*==)是最长的一面 \n> * 对边（==*opposite*==）是与给定角度相反的那一侧 \n> * 相邻边（==*adjacent*==）是给定角度的下一个 \n\n* $\\mathbf{PP^{'}}$ 是对边，为了计算$x^{'}$ 到 $x$ 的距离，我们需要计算出对边的长度 ($k$)；\n* 邻边就是 $P^{'}$ 的坐标： $y$ ;\n* 我们不知道斜边的长度\n\n在三角函数（trigonometry）中：\n$$\n\\begin{aligned} \\cos \\left( \\alpha \\right) &= \\frac{邻边}{斜边}\\\\\\\\ \\sin \\left( \\alpha \\right) &= \\frac{对边}{斜边}\\\\\\\\ \\tan \\left( \\alpha \\right) &= \\frac{对边}{邻边} \\end{aligned}\n$$\n现在，我们知道了 $\\alpha$ ,但我们不知道斜边的长度，所以我们不能使用 cosine 函数。\n\n另一方面，我们知道邻边的长度（也就是$y$),我一我们可以使用 tangent 函数来求出对边的长度：\n$$\n\\begin{aligned}\\tan \\left( \\alpha \\right) &= \\frac{对边}{邻边}\\\\\\\\对边 &= 邻边 \\times \\tan \\left( \\alpha \\right)\\end{aligned}\n$$\n 我们可以开始求解我们的线性方程组来得出我们需要的矩阵：\n$$\nx^{\\prime} = x + k = x + y . \\tan \\left( \\alpha \\right)\n\\\\\ny^{\\prime} = y\n$$\n当 $\\alpha > 0$ 时，$tan(\\alpha) < 0$，当 $α<0, \\tan \\left( \\alpha \\right) > 0$ ,两种情况下，通过 $x′= x+k=x+y.tan(α)$ 求解出来的可能为正也可能为负；$\\alpha > 0$ 为逆时针的旋转/斜切角，当 $α<0$ 时，为顺时针方向的旋转/斜切角。\n$$\n\\left.\n\\begin{aligned} x^{\\prime} &= x + y . \\tan \\left( \\alpha \\right) \\\\ x + y . \\tan \\left( \\alpha \\right) &= a . x + b . y\\\\\\\\ \\Rightarrow a &= 1 \\text{ and }\\\\ b &= \\tan \\left( \\alpha \\right) \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= y\\\\ y &= c . x + d . y\\\\\\\\ \\Rightarrow c &= 0 \\text{ and }\\\\ d &= 1 \\end{aligned}\n\\right.\n$$\n\n沿$x$方向剪切的变换矩阵为:\n$$\n\\begin{aligned} \n\\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} = \\begin{pmatrix} 1 & \\tan \\alpha \\\\ 0 & 1 \\end{pmatrix} = \\begin{pmatrix} 1 & k_{x}\\\\ 0 & 1 \\end{pmatrix}\\\\\\\\ \n{\\text{其中 } k_{x} \\text{ 是 shearing 常量}}\n\\end{aligned}\n$$\n 类似的，沿 $y$ 方向剪切的变换矩阵为：\n$$\n\\begin{aligned} \\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} = \\begin{pmatrix} 1 & 0\\\\ \\tan \\beta & 1 \\end{pmatrix} = \\begin{pmatrix} 1 & 0\\\\ k_{y} & 1 \\end{pmatrix}\\\\\\\\ \\text{其中 } k_{y} \\text{ 是 shearing 常量} \\end{aligned}\n$$\n\n### Rotation\n\n旋转就更加复杂了。\n\n我们仔细看下下面 围绕原点旋转 $\\theta$ (theta)角度 的例子:\n\n![D-angle-shearing](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210309094706.gif)\n\n![D-angle-shearing](Matrices for developers_files/2D-rotation.gif)\n\n\n\n注意，两个点 $\\mathbf{P}$ 和  $\\mathbf{P}^{'}$ 在它们自己的坐标平面中都有相同的坐标$(x,y)$，但是 $\\mathbf{P}^{'}$ 在第一个没有被旋转的坐标系中有新的坐标： $\\left({x^{'},y^{'}}\\right)$ 。\n\n那么，现在我们可以定义原始坐标点$(x,y)$ 到新的坐标点  $\\left({x^{'},y^{'}}\\right)$ 之间的关系了吗？\n\n我们可以使用三角函数来帮助我们计算，在寻找对应的解法时，我发现了[尼克·贝里（Nick Berry）](http://datagenetics.com/blog/august32013/)的基于几何的解释和[此视频](https://www.youtube.com/watch?v=h11ljFJeaLo)。 \n\n老实说，我对这种解决方案不是100％满意，因为我不完全理解了它。 在重新阅读我写的内容之后，Hadrien（审阅者之一）和我发现我的解释有些不是那么完美。因此，如果您有兴趣，我会把它留在这里，但我建议您不要打扰，除非您非常好奇并且不要介意一些混乱。 \n\n> \n\n现在，为了进行简单的解释清楚旋转的概念，我将采用 *此位置向量落在映射到另外一个位置向量上* 的路线。 \n\n假设你像下图一样在单位矢量上进行缩放： \n\n![2D-rotation-unit](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210309101356.png)\n\n基于三角函数的规则，我们可以看得到：\n$$\n\\left.\n\\begin{pmatrix} 0\\\\ 1 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} \\cos \\theta \\\\ \\sin \\theta \\end{pmatrix}\n\\middle|\n\\begin{pmatrix} 1\\\\ 0 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} - \\sin \\theta \\\\ \\cos \\theta \\end{pmatrix}\n\\right.\n$$\n也就是：\n$$\n\\begin{pmatrix} x\\\\ y \\end{pmatrix} = \\begin{pmatrix} 1\\\\ 0 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} a.x+b.y\\\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} \\cos \\theta \\\\ \\sin \\theta \\end{pmatrix}\n$$\n\n$$\n\\begin{pmatrix} x\\\\ y \\end{pmatrix} = \\begin{pmatrix} 0\\\\ 1 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} a.x+b.y\\\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} - \\sin \\theta \\\\ \\cos \\theta \\end{pmatrix}\n$$\n\n我们可以推断出：\n$$\n\\left.\n\\begin{pmatrix} 1.a+0.b\\\\ 1.c+0.d \\end{pmatrix} = \\begin{pmatrix} \\cos \\theta \\\\ \\sin \\theta \\end{pmatrix}\n\\middle|\n\\begin{pmatrix} 0.a+1.b\\\\ 0.c+1.d \\end{pmatrix} = \\begin{pmatrix} - \\sin \\theta \\\\ \\cos \\theta \\end{pmatrix}\n\\right.\n$$\n很明显可以得出： $a = \\cos\\left(\\theta \\right), b = - \\sin \\left( \\theta \\right), c = \\sin \\left( \\theta \\right) ，而\\  d = \\cos \\left( \\theta \\right)$ ，我们可以得到我们的旋转矩阵：\n$$\n\\begin{pmatrix} a & b\\\\c & d \\end{pmatrix} = \\begin{pmatrix} \\cos \\theta & -\\sin \\theta\\\\ \\sin \\theta & \\cos \\theta \\end{pmatrix}\n$$\n恭喜你！现在你已经知道了如何定义缩放，仿射，剪切和旋转的变换矩阵。 那么，还差什么呢？ \n\n## 3x3 变换矩阵\n\n如果你看到了这里，经过上面的解释，你可能知道了上述的单个变换为什么会起作用，但是，我们的目标其实是理解这些仿射变换，然后在代码中应用它们。\n\n仅仅知道单个变换的用法也是很有用的，因为现在我们知道了变换矩阵长什么样，并且知道如何在给定的几个位置矢量的情况下计算一个变换矩阵，了解这些就已经非常了不起了。\n\n但是，有一个问题就是：我们能通过 $2\\times2$ 的矩阵所做的操作太少了，你只能做一些我们之间见到过的变换：\n\n* Scaling - 缩放\n* Reflexion - 仿射\n* Shearing - 剪切\n* Rotation - 旋转\n\n那么我们还需要什么？ 答案是： **平移-translations**\n\n平移非常有用，比方说当用户触摸图像并移动手指时，图片需要能跟随用户的手势一起移动；平移可以被定义为两个矩阵的加法：\n$$\n\\begin{pmatrix}\nx^{'} \\\\ y^{'} \n\\end{pmatrix} = \\begin{pmatrix} x \\\\ y \\end{pmatrix} + \\begin{pmatrix} t_x \\\\ t_y \\end{pmatrix}\n$$\n不过，我们希望用户能够联合执行多种变换（如以一个不是原点的点为中心进行缩放），因此我们需要找到将平移表示为矩阵乘法的方式。\n\n> 这里可能涉及到 [Homogeneous coordinates](https://en.wikipedia.org/wiki/Homogeneous_coordinates 的世界，不过你可以不用了解这些。\n\n这里关联概念就是：\n\n* 我们使用的平面笛卡尔坐标平面实际上只是三维坐标空间中众多平面中的一个，其 $z$ 坐标 为 1 \n* 对于三维空间的任意点 $(x,y,z)$ 来说，投影空间中穿过这个点和原点的线，同时也会穿过使用相同的缩放比例对 $x,y,z$ 进行缩放后的点；\n* 这条线上的任意点的坐标可以表示为：$\\left(\\frac{x}{z}, \\frac{y}{z}, z\\right)$  \n\n![img](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210309104502.png)\n\n>  我在本文的末尾附上了我收集的相关文章及博客的链接，如果你感兴趣，可以继续深入阅读。\n\n我们现在不仅可以将笛卡尔坐标系（$z=1$）中的点表示为一个 $2\\times1$ 的矩阵，也可以表示为一个 $3\\times1$的矩阵：\n$$\n\\begin{pmatrix} x\\\\ y \\end{pmatrix} \\Leftrightarrow \\begin{pmatrix} x\\\\ y\\\\ 1 \\end{pmatrix}\n$$\n不过这也意味着我们需要重新定义我们之前得到的变换矩阵，因为一个 $3\\times1$ 的位置矢量乘以一个 $2\\times2$ 的变换矩阵是未定义的。\n\n我们必须找到一个变换矩阵 $\\mathbf{A} = \\begin{pmatrix} a & b & c \\\\ d & e &f \\\\ g&h &i \\end{pmatrix}$ \n\n同前面的章节一样，我们假设我们有一个点 $\\mathbf{P}_{(x,y,z)}$ ，这个点代表了笛卡尔平面中的任意点，接下来我们希望找到一个变换矩阵矩阵能够将坐标点转换成 $\\mathbf{P}^{'}_{(x^{'},y^{'},z^{'})}$ ，其中变换后的点的 $z^{'} = z$ :\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime}\\\\z^{\\prime} \\end{pmatrix} = \\mathbf{A} . \\begin{pmatrix} x\\\\y\\\\z \\end{pmatrix} = \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} . \\begin{pmatrix} x\\\\y\\\\z \\end{pmatrix}\n$$\n\n### 缩放\n\n缩放的矩阵形式如下：\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime}\\\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} s_{x}.x\\\\s_{y}.y\\\\z \\end{pmatrix} = \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} . \\begin{pmatrix} x\\\\y\\\\z \\end{pmatrix}\n$$\n为了找到矩阵 $A$ ，我们进行线性方程求解：\n$$\n\\left.\n\\begin{aligned} x^{\\prime} &= s_{x} . x\\\\ s_{x} . x &= a . x + b . y + c . z\\\\\\\\ \\Rightarrow a &= s_{x} \\text{ 且 }\\\\ b &= 0 \\text{ 且 }\\\\ c &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= s_{y} . y\\\\ s_{y} . y &= d . x + e . y + f + z\\\\\\\\ \\Rightarrow e &= s_{y} \\text{ 且 }\\\\ d &= 0 \\text{ 且 }\\\\ f &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} z^{\\prime} &= z\\\\ \\Rightarrow z &= g . x + h . y + i + z\\\\ \\Rightarrow g &= 0 \\text{ 且 }\\\\ h &= 0 \\text{ 且 }\\\\ i &= 1 \\end{aligned}\n\\right.\n$$\n缩放比例 $\\left( S_x, S_y \\right)$ 的 $3 \\times 3$ 的矩阵为：\n$$\n\\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} = \\begin{pmatrix} s_{x} & 0 &0\\\\0 & s_{y} & 0\\\\0 & 0 & 1\\end{pmatrix}\n$$\n\n### Reflexion\n\n对围绕 $x$ 轴的仿射的矩阵 $\\mathbf{A}$ 如下：\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime}\\\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} x\\\\-y\\\\z \\end{pmatrix} = \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} . \\begin{pmatrix} x\\\\y\\\\z \\end{pmatrix}\n$$\n同理，求解线性方程组，得到变换矩阵各个条目的值：\n$$\n\\left.\n\\begin{aligned} x^{\\prime} &= x\\\\ x &= a . x + b . y + c . z\\\\\\\\ \\Rightarrow a &= 1 \\text{ 且 }\\\\ b &= 0 \\text{ 且 }\\\\ c &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= -y\\\\ -y &= d . x + e . y + f . z\\\\\\\\ \\Rightarrow d &= 0 \\text{ 且 }\\\\ e &= -1 \\text{ 且 }\\\\ f &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} z^{\\prime} &= z\\\\ z &= g . x + h . y + i . z\\\\\\\\ \\Rightarrow g &= 0 \\text{ 且 }\\\\ h &= 0 \\text{ 且 }\\\\ i &= 1 \\end{aligned}\n\\right.\n$$\n根据求解结果，得到围绕 $x$ 轴的变换矩阵为：\n$$\n\\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} = \\begin{pmatrix} 1 & 0 & 0\\\\ 0 & -1 & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\n$$\n对围绕 $y$ 轴的仿射的矩阵 $\\mathbf{A}$ 看如下：\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime}\\\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} x\\\\-y\\\\z \\end{pmatrix} = \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} . \\begin{pmatrix} x\\\\y\\\\z \\end{pmatrix}\n$$\n求解线性方程组：\n$$\n\\left.\n\\begin{aligned} x^{\\prime} &= -x\\\\ -x &= a . x + b . y + c . z\\\\\\\\ \\Rightarrow a &= -1 \\text{ and }\\\\ b &= 0 \\text{ and }\\\\ c &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= y\\\\ y &= d . x + e . y + f . z\\\\\\\\ \\Rightarrow d &= 0 \\text{ and }\\\\ e &= 1 \\text{ and }\\\\ f &= 0 \\end{aligned}\n\\middle|\n\\begin{aligned} z^{\\prime} &= z\\\\ z &= g . x + h . y + i . z\\\\\\\\ \\Rightarrow g &= 0 \\text{ and }\\\\ h &= 0 \\text{ and }\\\\ i &= 1 \\end{aligned}\n\\right.\n$$\n\n那么，围绕 $y$ 轴的变换矩阵为：\n$$\n\\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} = \\begin{pmatrix} -1 & 0 & 0\\\\ 0 & 1 & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\n$$\n\n### Shearing\n\n沿着 $x$ 方向剪切的转换矩阵：\n$$\n\\begin{aligned} \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} &= \\begin{pmatrix} 1 & \\tan \\alpha & 0\\\\ 0 & 1 & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 1 & k_{x} & 0\\\\ 0 & 1 & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ & \\text{其中 } k \\text{ 是 shearing 常量} \\end{aligned}\n$$\n同样的，沿着 y 方向剪切的转换矩阵：\n$$\n\\begin{aligned} \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} &= \\begin{pmatrix} 1 & 0 & 0\\\\ \\tan \\beta & 1 & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 1 & 0 & 0\\\\ k_{y} & 1 & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ & \\text{其中 } k \\text{ 是 shearing 常量} \\end{aligned}\n$$\n\n### 旋转\n\n使用相同的计算放出，我们可以得出新的旋转矩阵是基于我们之前的 $2\\times2$ 的旋转矩阵，添加了一列，该列的条目是：$0,0$ 和 $1$。\n$$\n\\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} = \\begin{pmatrix} \\cos \\theta & -\\sin \\theta & 0\\\\ \\sin \\theta & \\cos \\theta & 0\\\\ 0 & 0 & 1 \\end{pmatrix}\n$$\n\n### 平移\n\n平移是最有意思的，因为我们可以定义一个 $3\\times3$ 的平移矩阵，我们需要的矩阵 $\\mathbf{A}$ 需要满足如下条件：\n$$\n\\begin{pmatrix} x^{\\prime}\\\\y^{\\prime}\\\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} x+t_{x}\\\\y+t_{y}\\\\z \\end{pmatrix} = \\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} . \\begin{pmatrix} x\\\\y\\\\z \\end{pmatrix}\n$$\n求解线性方程组：\n$$\n\\left.\n\\begin{aligned} x^{\\prime} &= x + t_{x} \\\\ x + t_{x} &= a . x + b . y + c . z\\\\\\\\ \\Rightarrow a &= 1 \\text{ 且 }\\\\ b &= 0 \\text{ 且 }\\\\ c &= t_{x} \\end{aligned}\n\\middle|\n\\begin{aligned} y^{\\prime} &= y + t_{y}\\\\ y + t_{y} &= d . x + e . y + f . z\\\\\\\\ \\Rightarrow d &= 0 \\text{ 且 }\\\\ e &= 1 \\text{ 且 }\\\\ f &= t_{y} \\end{aligned}\n\\middle|\n\\begin{aligned} z^{\\prime} &= z\\\\ z &= g . x + h . y + i . z\\\\\\\\ \\Rightarrow g &= 0 \\text{ 且 }\\\\ h &= 0 \\text{ 且 }\\\\ i &= 1 \\end{aligned}\n\\right.\n$$\n得到矩阵 $\\mathbf{A}$:\n$$\n\\begin{pmatrix} a & b & c\\\\d & e & f\\\\g & h & i\\end{pmatrix} = \\begin{pmatrix} 1 & 0 & t_{x}\\\\0 & 1 & t_{y}\\\\0 & 0 & 1\\end{pmatrix}\n$$\n\n## 矩阵总结(Matrices wrap-up) \n\n实际上，你不必每次都做这些线性代数的计算，你只需要使用它们就可以了。\n\n**总结：**\n\n* 平移矩阵：$\\begin{pmatrix}1 & 0 & t_{x}\\\\0 & 1 & t_{y}\\\\0 & 0 & 1\\end{pmatrix}$\n* 缩放矩阵：$\\begin{pmatrix}s_{x} & 0 & 0\\\\0 & s_{y} & 0\\\\0 & 0 & 1\\end{pmatrix}$\n* 剪切矩阵：$\\begin{pmatrix}1 & \\tan \\alpha & 0\\\\\\tan \\beta & 1 & 0\\\\0 & 0 & 1\\end{pmatrix} = \\begin{pmatrix}1 & k_{x} & 0\\\\k_{y} & 1 & 0\\\\0 & 0 & 1\\end{pmatrix}$\n* 旋转矩阵： $\\begin{pmatrix}\\cos \\theta & -\\sin \\theta & 0\\\\\\sin \\theta & \\cos \\theta & 0\\\\0 & 0 & 1\\end{pmatrix}$\n\n现在，我们可以轻易的定义我们自己需要的矩阵，而且你也知道了它如何工作。\n\n最后一个问题是：我们之前讨论的变换都是以原点为中心。如果我们需要不以原点为中心了？比方说以指定点进行缩放，以某个点对图像进行旋转，这要怎么做了？\n\n这个问题的答案是： 组合（***composition***），我们必须使用几个变换来组合成我们需要的变换；\n\n\n\n### 组合实例： pinch-zoom\n\n想象你有一个形状（比方说正方形），你想要以正方形的中心进行缩放，用于模拟捏合缩放行为。\n\n变换可以按如下序列进行组合：\n\n* 移动锚点到原点: $\\left( -t_{x}, -t_{y} \\right)$\n* 使用 $\\left( s_{x}, s_{y} \\right)$ 进行缩放\n* 将锚点移动回来：$\\left( t_{x}, t_{y} \\right)$\n\n其中 $t$ 是我们缩放变换的锚点（这里是正方形的中心点）。\n\n我们的变换序列包括下面的第一个平移矩阵 $\\mathbf{C}$ ，缩放矩阵 $\\mathbf{B}$ ，还有后面的一个平移矩阵 $\\mathbf{A}$ \n$$\n\\mathbf{C} = \\begin{pmatrix} 1 & 0 & -t_{x} \\\\ 0 & 1 & -t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} \\text{ , } \\mathbf{B} = \\begin{pmatrix} s_{x} & 0 & 0 \\\\ 0 & s_{y} & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} \\text{ 还有 } \\mathbf{A} = \\begin{pmatrix} 1 & 0 & t_{x} \\\\ 0 & 1 & t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix}\n$$\n因为矩阵乘法运算是不可交换的，顺序很重要，因此我们将反过来应用这些矩阵。\n\n我们得到如下组合结果：\n$$\n\\begin{aligned} \\mathbf{A} . \\mathbf{B} . \\mathbf{C} &= \\begin{pmatrix} 1 & 0 & t_{x} \\\\ 0 & 1 & t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} s_{x} & 0 & 0 \\\\ 0 & s_{y} & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} 1 & 0 & -t_{x} \\\\ 0 & 1 & -t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 1 & 0 & t_{x} \\\\ 0 & 1 & t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} s_{x} & 0 & -s_{x}.t_{x} \\\\ 0 & s_{y} & -s_{y}.t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ \\mathbf{A} . \\mathbf{B} . \\mathbf{C} &= \\begin{pmatrix} s_{x} & 0 & -s_{x}.t_{x} + t_{x} \\\\ 0 & s_{y} & -s_{y}.t_{y} + t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} \\end{aligned}\n$$\n假设我们有如下正方形，其各点坐标如下：\n$$\n\\begin{pmatrix}x_{1} & x_{2} & x_{3} & x_{4}\\\\y_{1} & y_{2} & y_{3} & y_{4}\\\\1 & 1 & 1 & 1\\end{pmatrix} = \\begin{pmatrix}2 & 4 & 4 & 2\\\\1 & 1 & 3 & 3\\\\1 & 1 & 1 & 1\\end{pmatrix}\n$$\n![pinch-zoom-init](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210309115937.png)\n\n我们想要以它的中心点应用两倍的缩放： \n\n新的坐标将会是下面这样：\n$$\n\\begin{aligned} \\begin{pmatrix} x_{1}^{\\prime} & x_{2}^{\\prime} & x_{3}^{\\prime} & x_{4}^{\\prime}\\\\ y_{1}^{\\prime} & y_{2}^{\\prime} & y_{3}^{\\prime} & y_{4}^{\\prime}\\\\ 1 & 1 & 1 & 1 \\end{pmatrix} &= \\begin{pmatrix} s_{x} & 0 & -s_{x}.t_{x} + t_{x} \\\\ 0 & s_{y} & -s_{y}.t_{y} + t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} x_{1} & x_{2} & x_{3} & x_{4}\\\\ y_{1} & y_{2} & y_{3} & y_{4}\\\\ 1 & 1 & 1 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 2 & 0 & -2.3 + 3 \\\\ 0 & 2 & -2.2 + 2 \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} 2 & 4 & 4 & 2\\\\ 1 & 1 & 3 & 3\\\\ 1 & 1 & 1 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 2 & 0 & -3 \\\\ 0 & 2 & -2 \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} 2 & 4 & 4 & 2\\\\ 1 & 1 & 3 & 3\\\\ 1 & 1 & 1 & 1 \\end{pmatrix}\\\\\\\\ \\begin{pmatrix} x_{1}^{\\prime} & x_{2}^{\\prime} & x_{3}^{\\prime} & x_{4}^{\\prime}\\\\ y_{1}^{\\prime} & y_{2}^{\\prime} & y_{3}^{\\prime} & y_{4}^{\\prime}\\\\ 1 & 1 & 1 & 1 \\end{pmatrix} &= \\begin{pmatrix} 1 & 5 & 5 & 1\\\\ 0 & 0 & 4 & 4\\\\ 1 & 1 & 1 & 1 \\end{pmatrix} \\end{aligned}\n$$\n![pinch-zoom](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210309120126.gif)\n\n### 组合示例： 旋转图像\n\n假设你有一个图像设置在view中，但是原点并不是view的中心点，通常原点可能在左上角，但是你希望能够围绕view的中点来旋转图像；\n\n这个变换的组合包括如下序列：\n\n- 移动锚点到原点： $\\left( -t_{x}, -t_{y} \\right)$\n- 旋转 $\\theta$ 角度\n- 移动回锚点: $\\left( t_{x}, t_{y} \\right)$\n\n其中 $t$ 是我们旋转变换的锚点。\n\n同样的，变换过程有如下三个矩阵，第一个平移矩阵 $\\mathbf{C}$ ，旋转矩阵 $\\mathbf{B}$ ,还有后面的一个平移矩阵$\\mathbf{A}$ ：\n$$\n\\mathbf{C} = \\begin{pmatrix} 1 & 0 & -t_{x} \\\\ 0 & 1 & -t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} \\text{ , } \\mathbf{B} = \\begin{pmatrix} \\cos \\theta & -\\sin \\theta & 0 \\\\ \\sin \\theta & \\cos \\theta & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} \\text{ 还有 } \\mathbf{A} = \\begin{pmatrix} 1 & 0 & t_{x} \\\\ 0 & 1 & t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix}\n$$\n我们可以组合得到如下结果：\n$$\n\\begin{aligned} \\mathbf{A} . \\mathbf{B} . \\mathbf{C} &= \\begin{pmatrix} 1 & 0 & t_{x} \\\\ 0 & 1 & t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} \\cos \\theta & -\\sin \\theta & 0 \\\\ \\sin \\theta & \\cos \\theta & 0 \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} 1 & 0 & -t_{x} \\\\ 0 & 1 & -t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 1 & 0 & t_{x} \\\\ 0 & 1 & t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} \\cos \\theta & -\\sin \\theta & -\\cos \\theta.t_{x} +\\sin \\theta.t_{y} \\\\ \\sin \\theta & \\cos \\theta & -\\sin \\theta.t_{x} -\\cos \\theta.t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix}\\\\\\\\ \\mathbf{A} . \\mathbf{B} . \\mathbf{C} &= \\begin{pmatrix} \\cos \\theta & -\\sin \\theta & -\\cos \\theta.t_{x} +\\sin \\theta.t_{y} + t_{x} \\\\ \\sin \\theta & \\cos \\theta & -\\sin \\theta.t_{x} -\\cos \\theta.t_{y} + t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} \\end{aligned}\n$$\n假设我们的view的范围是一个正方形，顶点坐标如下：\n$$\n\\begin{pmatrix}x_{1} & x_{2} & x_{3} & x_{4}\\\\y_{1} & y_{2} & y_{3} & y_{4}\\\\1 & 1 & 1 & 1\\end{pmatrix} = \\begin{pmatrix}2 & 4 & 4 & 2\\\\1 & 1 & 3 & 3\\\\1 & 1 & 1 & 1\\end{pmatrix}\n$$\n![rotate-image-init](https://i-rant.arnaudbos.com/img/matrices-for-developers/rotate-image-init.png)\n\n我们希望围绕其中心旋转 $\\theta = 90^{\\circ}$ ，那么新的坐标是：\n$$\n\\begin{aligned} \\begin{pmatrix} x_{1}^{\\prime} & x_{2}^{\\prime} & x_{3}^{\\prime} & x_{4}^{\\prime}\\\\ y_{1}^{\\prime} & y_{2}^{\\prime} & y_{3}^{\\prime} & y_{4}^{\\prime}\\\\ 1 & 1 & 1 & 1 \\end{pmatrix} &= \\begin{pmatrix} \\cos \\theta & -\\sin \\theta & -\\cos \\theta.t_{x} +\\sin \\theta.t_{y} + t_{x} \\\\ \\sin \\theta & \\cos \\theta & -\\sin \\theta.t_{x} -\\cos \\theta.t_{y} + t_{y} \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} x_{1} & x_{2} & x_{3} & x_{4}\\\\ y_{1} & y_{2} & y_{3} & y_{4}\\\\ 1 & 1 & 1 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 0 & -1 & -0.3+1.2+3 \\\\ 1 & 0 & -1.3-0.2+2 \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} 2 & 4 & 4 & 2\\\\ 1 & 1 & 3 & 3\\\\ 1 & 1 & 1 & 1 \\end{pmatrix}\\\\\\\\ &= \\begin{pmatrix} 0 & -1 & 5 \\\\ 1 & 0 & -1 \\\\ 0 & 0 & 1 \\end{pmatrix} . \\begin{pmatrix} 2 & 4 & 4 & 2\\\\ 1 & 1 & 3 & 3\\\\ 1 & 1 & 1 & 1 \\end{pmatrix}\\\\\\\\ \\begin{pmatrix} x_{1}^{\\prime} & x_{2}^{\\prime} & x_{3}^{\\prime} & x_{4}^{\\prime}\\\\ y_{1}^{\\prime} & y_{2}^{\\prime} & y_{3}^{\\prime} & y_{4}^{\\prime}\\\\ 1 & 1 & 1 & 1 \\end{pmatrix} &= \\begin{pmatrix} 4 & 4 & 2 & 2\\\\ 1 & 3 & 3 & 1\\\\ 1 & 1 & 1 & 1 \\end{pmatrix} \\end{aligned}\n$$\n![rotate-image](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210309121028.gif)\n\n![rotate-image](https://i-rant.arnaudbos.com/img/matrices-for-developers/rotate-image.gif)\n\n## 资源及链接\n\n- [All the Geogebra files I’ve used to generate the graphics and gifs](https://github.com/arnaudbos/i-rant/tree/develop/static/code/matrices-for-developers)\n- [Khan Academy algebra course on matrices](https://www.khanacademy.org/math/algebra-home/alg-matrices)\n- [A course on “Affine Transformation” at The University of Texas at Austin](https://www.cs.utexas.edu/~fussell/courses/cs384g-fall2010/lectures/lecture07-Affine.pdf)\n- [A course on “Composing Transformations” at The Ohio State University](http://web.cse.ohio-state.edu/~whmin/courses/cse5542-2013-spring/6-Transformation_II.pdf)\n- [A blogpost on “Rotating images” by Nick Berry](http://datagenetics.com/blog/august32013/)\n- [A Youtube video course on “The Rotation Matrix” by Michael J. Ruiz](https://www.youtube.com/watch?v=h11ljFJeaLo)\n- [Wikipedia on Homogeneous coordinates](https://en.wikipedia.org/wiki/Homogeneous_coordinates)\n- [A blogpost on “Explaining Homogeneous Coordinates & Projective Geometry” by Tom Dalling](http://www.tomdalling.com/blog/modern-opengl/explaining-homogenous-coordinates-and-projective-geometry/)\n- [A blogpost on “Homogeneous Coordinates” by Song Ho Ahn](http://www.songho.ca/math/homogeneous/homogeneous.html)\n- [A Youtube video course on “2D transformations and homogeneous coordinates” by Tarun Gehlot](https://www.youtube.com/watch?v=Xzu8_Fe3ImI)\n\n### [2D Transformations with Android and Java](https://i-rant.arnaudbos.com/2d-transformations-android-java/)\n\n\n<br/>\n--- \n<br/>\n\n### 译者补充 \n#### android 矩阵：\n\n$$\n\\begin{bmatrix}\n  MSCALE\\_X & MSKEW\\_X & MTRANS\\_X \\\\\n  MSKEW\\_Y & MSCALE\\_Y & MTRANS\\_Y \\\\\n  MPERSP\\_0 & MPERSP\\_1 & MPERSP\\_2 \\\\\n\\end{bmatrix}\n$$\n\n| 字段                                 | 用途                                         |\n| ------------------------------------ | -------------------------------------------- |\n| `MSCALE_X`，`MSCALE_Y`               | 控制X轴和Y轴方向的缩放                       |\n| `MSKEW_X`，`MSKEW_Y`                 | 控制X坐标和Y坐标的扭曲系数(旋转)             |\n| `MTRANS_X`，`MTRANS_Y`               | 控制X方向和Y方向的线性平移                   |\n| `MPERSP_0` , `MPERSP_1` , `MPERSP_2` | MPERSP_0、MPERSP_1和MPERSP_2是关于透视的控制 |\n\n#### matlab 矩阵运算 \n\n>\n>`>>`A = [4 3 ; 0 -5; 2 1 ; -6 8]\n>\n>A =\n>\n>     4     3\n>     0    -5\n>     2     1\n>    -6     8\n>\n>`>>`B = [7 1 3 ; -2 4 1]\n>\n>B =\n>\n>     7     1     3\n>    -2     4     1\n>\n>`>>`A*B\n>\n>ans =\n>\n>    22    16    15\n>    10   -20    -5\n>    12     6     7\n>   -58    26   -10\n>\n>`>>`B*A\n>\n><p style=\"color:red\">错误使用  * <br/>\n>\n><p style=\"color:red\">用于矩阵乘法的维度不正确。请检查并确保第一个矩阵中的列数与第二个矩阵中\n>的行数匹配。要执行按元素相乘，请使用 '.*'。</p>\n>\n>\n>\n>`>>`A+B\n>\n><p style=\"color:red\">矩阵维度必须一致。</p>\n",
      "data": {
        "title": "[译]Android开发所需要的矩阵知识",
        "date": "2021-02-08 10:38:22",
        "tags": [
          "Android"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": true
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "翻译国外文章，该文章介绍了Android开发中矩阵相关的数学知识，包括矩阵是什么？矩阵加法及乘法运算，2x2矩阵的变换，最后演进为Android中使用的3x3矩阵。文中图片及动图比较多，相对好懂。",
      "fileName": "Android开发所需要的矩阵知识"
    },
    {
      "content": "\ngradle有三种编写插件的方式，我们这里使用在项目中的buildSrc模块中编写插件的方式，自定义了一个应用于Android项目的根据flavor过滤so库的gradle插件；\n\n<!-- more -->\n\n## 概述   \n\n自定义gradle插件有如下三种方式（[🔗链接](https://docs.gradle.org/current/userguide/custom_plugins.html#sec:packaging_a_plugin)）：\n\n1. 在buildscript中直接编写；\n2. 在buildSrc项目中编写插件代码；\n3. 在独立的项目中编写插件代码；\n\n这里我们将使用buildSrc方式实现一个gradle插件。\n\n## 新建 buildSrc module\n\ngradle会在项目中寻找名称为buildSrc模块，将其加载为gradle的插件代码目录。所以我们直接通过菜单新建一个名为 buildSrc 的java/kotlin模块。\n\n然后在build.gradle中添加相关的plugin(java-gradle-plugin)及依赖：\n\n```groovy\nplugins {\n    id 'java'\n    id 'java-gradle-plugin'\n    id \"org.jetbrains.kotlin.jvm\" version '1.3.61'\n}\n\ngroup = \"io.github.hanlyjiang.gradle\"\nversion = \"0.0.2\"\n\ndependencies {\n    testCompile group: 'junit', name: 'junit', version: '4.12'\n    // 添加android相关build tools依赖，以便使用 android gradle 相关的API\n    compile 'com.android.tools.build:gradle:3.2.0'\n}\n```\n\n## 编写插件\n\n### 需求简介\n\n* **应用场景：**我们的产品中集成了两种VPN SDK，但是具体到每个项目上面，都只会落地到具体的一种，这个时候需要排除对应的SDK的SO库以减小APP包大小，不同的地区的打包配置通过flavor来进行区分配置，即每个地区会对应不同的flavor；\n\n* **需求提取**： 这里实际上我们需要的是能够根据flavor，在打包过程中移除指定的so文件；\n\n* **实现思路：** \n\n  * flavor配置方式：在flavor中配置一个buildConfigField字段，用于指定我们的flavor需要的配置\n\n    ```groovy\n    // 配置VPN类型\n    buildConfigField \"String\", \"VPN_TYPE\", \"\\\"$VpnType.SANG_FOR\\\"\"\n    ```\n\n  * 插件配置：我们使用一个so_exclude配置来指定具体的exclude规则，包含两个字段。\n\n    * buildConfigFieldKey 用于指定之前在flavor中定义的配置；\n    * configMap 为一个配置表，指定上面的字段可取的值，即对应值应该exclude的so文件列表；\n\n    ```groovy\n    so_exclude {\n        /**\n         * 使用VPN_TYPE 来设置so过滤的规则\n         */\n        buildConfigFieldKey = \"VPN_TYPE\"\n        configMap = [\n                (VpnType.H3C_iNode.name()): [\n                        // 新华三过滤深信服的\n                        \"lib/armeabi-v7a/libauth_forward.so\",\n                        \"lib/armeabi-v7a/libhttps.so\",\n                        \"lib/armeabi-v7a/libpkcs12cert.so\",\n                        \"lib/armeabi-v7a/libsvpnservice.so\"\n                ],\n                (VpnType.SANG_FOR.name()) : [\n                        // 深信服过滤新华三的\n                        \"lib/armeabi-v7a/libies.so\",\n                ],\n                (VpnType.NONE.name())     : [\n                        // 如配置成 NONE，则过滤掉所有的VPN的\n                        // 深信服的so\n                        \"lib/armeabi-v7a/libauth_forward.so\",\n                        \"lib/armeabi-v7a/libhttps.so\",\n                        \"lib/armeabi-v7a/libpkcs12cert.so\",\n                        \"lib/armeabi-v7a/libsvpnservice.so\",\n                        // inode的so\n                        \"lib/armeabi-v7a/libies.so\",\n                ]\n        ]\n    }\n    ```\n\n### 定义插件及使用插件简介\n\n* 插件需要继承 `org.gradle.api.Plugin`，可在Plugin对构建流程进行自定义（如：创建任务，定义任务关系，修改已有任务动作等）\n* 插件如果需要能够读取一些配置，可通过 `project.extensions.create` 来从build.gradle中提取\n* 如需在自己的 android代码模块中使用插件，通过 `apply plugin: 插件类引用即可`\n\n### 插件实现\n\n* 插件的实现如下：\n  * 读取 so_exclude 配置，存储到 extension（类型为 FlavorSoExcludePluginExtension ）中\n  * 读取 android 的配置，找到 AppExtension类型的配置，也就是应用了 `apply application` 的模块的配置，我们的项目中只有一个app模块应用此配置-即我们的apk模块；\n  * 遍历所有变体，获取对应变体的 so_exclude 对应的配置字段的值，建立flavor到配置值的映射表；\n  * 修改 packageApplication 任务，让其在执行之前即删除待打包临时目录中的对应so文件；\n\n```kotlin\npackage io.github.hanlyjiang.gradle.plugin.soexclude\n\nimport com.android.build.gradle.AppExtension\nimport com.android.build.gradle.api.ApkVariantOutput\nimport org.gradle.api.Plugin\nimport org.gradle.api.Project\nimport org.gradle.api.logging.LogLevel\nimport org.gradle.api.logging.Logger\nimport org.gradle.api.logging.Logging\nimport java.io.File\n\n/**\n * so 插件的 gradle 配置实体\n */\nopen class FlavorSoExcludePluginExtension {\n\n    /**\n     * so 过滤配置表\n     */\n    var configMap: Map<String, List<String>>? = null\n\n    /**\n     * 配置字段的名称\n     */\n    var buildConfigFieldKey: String = FlavorSoExcludePlugin.DEFAULT_CONFIG_KEY\n}\n\n/**\n * flavor so 打包过滤配置\n *\n * ## 用法说明：\n *\n * 1. 在build.gradle 中引入插件 <code>apply plugin: FlavorSoExcludePlugin</code>;\n * 2. 添加 so_exclude 配置段：\n *\n * ```groovy\n * so_exclude {\n *   buildConfigFieldKey = \"VPN_TYPE\"\n *   configMap = [\n *       (VpnType.H3C_iNode.name()): [\n *           \"lib/armeabi-v7a/libauth_forward.so\",\n *           \"lib/armeabi-v7a/libhttps.so\",\n *           \"lib/armeabi-v7a/libpkcs12cert.so\",\n *           \"lib/armeabi-v7a/libsvpnservice.so\"\n *      ],\n *      (VpnType.SANG_FOR.name()) : [\n *           \"lib/armeabi-v7a/libies.so\",\n *       ],\n *       (VpnType.NONE.name())     : [\n *               // 深信服的so\n *               \"lib/armeabi-v7a/libauth_forward.so\",\n *               \"lib/armeabi-v7a/libhttps.so\",\n *               \"lib/armeabi-v7a/libpkcs12cert.so\",\n *               \"lib/armeabi-v7a/libsvpnservice.so\",\n *               // inode的so\n *               \"lib/armeabi-v7a/libies.so\",\n *        ]\n *   ]\n *}\n *```\n * 3. 在flavor的配置中添加 buildConfigField 配置，如：\n * ```\n * buildConfigField \"String\", \"VPN_TYPE\", \"\\\"$VpnType.H3C_iNode\\\"\"\n * ```\n * 其中字段的名称为 之前 so_exclude 中配置的 `buildConfigFieldKey` 字段，对应的值为 configMap 中的 key ，如此配置后，打包时就会将configMap对应key中的so列表过滤掉\n * @author hanlyjiang 09/20/20 2:42 PM\n * @version 1.0\n */\nclass FlavorSoExcludePlugin : Plugin<Project> {\n    companion object {\n        const val PLUGIN_NAME = \"FlavorSoExcludePlugin\"\n        const val DEFAULT_CONFIG_KEY = \"SO_EXCLUDE\"\n        const val DEBUG = false\n\n        private val logger: Logger = Logging.getLogger(FlavorSoExcludePlugin::class.java)\n\n        fun logInfo(msg: String) {\n            logger.log(LogLevel.LIFECYCLE, \"<- $PLUGIN_NAME: $msg ->\")\n        }\n\n        fun logDebug(msg: String) {\n            if (DEBUG) {\n                logInfo(msg)\n            }\n        }\n    }\n\n    lateinit var extension: FlavorSoExcludePluginExtension\n\n    override fun apply(project: Project) {\n        // 添加自己的配置\n        extension = project.extensions.create(\"so_exclude\", FlavorSoExcludePluginExtension::class.java)\n\n        // 创建一个打印配置的任务，用于定义\n        val task = project.tasks.create(\"printConfig\")\n        task.group = \"soExclude-plugin\"\n        task.doLast {\n            logInfo(\"-- 配置字段：buildConfigFieldKey= \" + extension.buildConfigFieldKey)\n            logInfo(\"-- 当前配置：\")\n            extension.configMap?.run {\n                this.keys.forEach { key ->\n                    logInfo(\"-- config: $key -- \")\n                    get(key)?.forEach {\n                        logInfo(\"values: $it\")\n                    }\n                    logInfo(\"------------------ \")\n                }\n            }\n        }\n\t\t// 获取android的配置\n        val androidExtensions = project.extensions.getByName(\"android\")\n        logInfo(\"\" + androidExtensions.javaClass)\n        if (androidExtensions is AppExtension) { \n            // applicatoin类型的就进行任务处理\n            initPackageOptions(project, androidExtensions)\n        }\n    }\n\n\n    /**\n     * vpn 配置\n     */\n    private var configMap: MutableMap<String, String> = HashMap()\n\n    private fun initPackageOptions(project: Project, android: AppExtension) {\n        project.afterEvaluate {\n            android.productFlavors.all {\n                val flavorName = it.name\n                logDebug(\"--productFlavors : ${it.name}\")\n                var soExcludeConfig = \"\"\n                it.buildConfigFields[extension.buildConfigFieldKey]?.run {\n                    soExcludeConfig = value.replace(\"\\\"\", \"\")\n                }\n                logDebug(\"--productFlavors : $flavorName, soExcludeConfig: $soExcludeConfig\")\n                configMap[flavorName] = soExcludeConfig\n            }\n            android.applicationVariants.all { variant ->\n                logDebug(\"app variant flavorName: ${variant.flavorName}\")\n                val flavorName = variant.flavorName\n                val configKey = configMap[flavorName]\n                variant.outputs.forEach { output ->\n                    if (output is ApkVariantOutput) {\n                        //核心逻辑：修改packageApplication任务，在生成apk包之前，删除打包临时目录中的so文件即可避免打包so到apk中\n                        output.packageApplication.doFirst {\n                            output.packageApplication.jniFolders.all {\n                                // jniFolder 目录为最后打包apk时，用于存放so文件的临时目录\n                                logInfo(\"变体名称: ${variant.flavorName} , configKey: ${configKey}, jniFolders: \" + it.absoluteFile)\n                                handleExclude(it, configKey);\n                                true\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    private fun handleExclude(jniFolder: File?, configKey: String?) {\n        extension.configMap?.run {\n            val soExcludeList: List<String>? = get(configKey)\n            soExcludeList?.run {\n                deleteJniSoFiles(jniFolder, *(soExcludeList.toTypedArray()))\n            }\n        }\n\n    }\n\n    private fun deleteJniSoFiles(jniFolder: File?, vararg files: String) {\n        for (item in files) {\n            val file = File(jniFolder, item)\n            if (file.exists()) {\n                val deleteResult = file.delete()\n                logInfo(\"删除so文件 $item : ${if (deleteResult) \"成功\" else \"失败\"}\")\n            }\n        }\n    }\n\n}\n\n```\n\n\n\n## 使用枚举进行配置\n\n我们在buildSrc中定义一个枚举类，用于约定可以配置的值，即可以清晰定义配置值避免配置时直接写字符串容易出错，又可以支持代码自动补全方便配置。\n\n```kotlin\npackage io.github.hanlyjiang.gradle.plugin.vpn\n\n/**\n * VPN 类型\n */\nenum class VpnType {\n    /**\n     * 深信服\n     */\n    SANG_FOR,\n\n    /**\n     * 新华三\n     */\n    H3C_iNode,\n\n    /**\n     * 不使用VPN\n     */\n    NONE,\n}\n/**\n * VPN 类型\n */\nenum class VpnType {\n    /**\n     * 深信服\n     */\n    SANG_FOR,\n\n    /**\n     * 新华三\n     */\n    H3C_iNode,\n\n    /**\n     * 不使用VPN\n     */\n    NONE,\n}\n```\n\n## 使用插件\n\n1. 通过 apply plugin 引入插件，直接使用插件类名称即可；\n2. 枚举配置使用，在gradle配置中导入对应的枚举类，然后直接使用即可：\n\n具体配置如下：\n\n```groovy\n// app/build.gradle\nimport io.github.hanlyjiang.gradle.plugin.soexclude.FlavorSoExcludePlugin\nimport io.github.hanlyjiang.gradle.plugin.vpn.VpnType\n\napply plugin: 'com.android.application'\n// 应用插件\napply plugin: FlavorSoExcludePlugin\n\nso_exclude {\n    /**\n     * 使用VPN_TYPE 来设置so过滤的规则\n     */\n    buildConfigFieldKey = \"VPN_TYPE\"\n    configMap = [\n            (VpnType.H3C_iNode.name()): [\n                    // 新华三过滤深信服的\n                    \"lib/armeabi-v7a/libauth_forward.so\",\n                    \"lib/armeabi-v7a/libhttps.so\",\n                    \"lib/armeabi-v7a/libpkcs12cert.so\",\n                    \"lib/armeabi-v7a/libsvpnservice.so\"\n            ],\n            (VpnType.SANG_FOR.name()) : [\n                    // 深信服过滤新华三的\n                    \"lib/armeabi-v7a/libies.so\",\n            ],\n            (VpnType.NONE.name())     : [\n                    // 如配置成 NONE，则过滤掉所有的VPN的\n                    // 深信服的so\n                    \"lib/armeabi-v7a/libauth_forward.so\",\n                    \"lib/armeabi-v7a/libhttps.so\",\n                    \"lib/armeabi-v7a/libpkcs12cert.so\",\n                    \"lib/armeabi-v7a/libsvpnservice.so\",\n                    // inode的so\n                    \"lib/armeabi-v7a/libies.so\",\n            ]\n    ]\n}\n\nandroid {\n    defaultConfig {\n        // 配置VPN类型\n        buildConfigField \"String\", \"VPN_TYPE\", \"\\\"$VpnType.SANG_FOR\\\"\"\n    }\n    productFlavors {\n        // ...\n    }\n}\n```\n\n## 参考文档\n\n- [自定义插件-官方文档](https://docs.gradle.org/current/userguide/custom_plugins.html)\n- [再见吧 buildSrc, 拥抱 Composing builds 提升Android 编译速度](https://juejin.im/post/6844904176250519565)\n- [如何判断任务是否UP-TO-DATE](https://www.jianshu.com/p/eb3fb33e4287)\n- [如何让任务支持UP_TO_DATE-Gradle官方文档](https://docs.gradle.org/current/userguide/more_about_tasks.html#sec:up_to_date_checks)\n- 创建任务-https://docs.gradle.org/current/dsl/org.gradle.api.Project.html#org.gradle.api.Project:task(java.util.Map,java.lang.String)\n- [增量任务-Gradle官方文档](https://docs.gradle.org/current/userguide/custom_tasks.html#incremental_tasks)\n- [增量构建如何实现？-gradle官方文档](https://docs.gradle.org/current/userguide/more_about_tasks.html#sec:how_does_it_work)",
      "data": {
        "title": "编写一个Android Gradle插件",
        "date": "2020-09-20 10:18:50",
        "tags": [
          "Android",
          "Gradle"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "\ngradle有三种编写插件的方式，我们这里使用在项目中的buildSrc模块中编写插件的方式，自定义了一个应用于Android项目的根据flavor过滤so库的gradle插件；",
      "fileName": "编写一个Android-Gradle插件"
    },
    {
      "content": "\n介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。\n\n<!-- more -->\n\n\n## 前言\n\n现在很多地方都对服务的国产化适配有所要求，一般的国产化平台都提供arm版本的linux云环境供我们进行服务部署，因此需要构建arm版本的镜像。\n\n\n## 测试机信息\n\n| CPU      | FT-1500A 4核 arm64 |\n| :------- | :----------------- |\n| 内存     | 8G                 |\n| OS       | 麒麟V10            |\n| 包管理器 | apt                |\n\n## ARM机器上安装Docker\n\n>[Docker官方文档](https://docs.docker.com/engine/install/?fileGuid=0l3NVKX0BgflYN3R)\n\nDocker支持如下系统及架构\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172838.png!thumbnail)\n\n国产系统依据安装包的格式选择对应的参考系统即可，如麒麟v10基于ubuntu，可以按[官方文档- Install Docker Engine on Ubuntu](https://docs.docker.com/engine/install/ubuntu/?fileGuid=0l3NVKX0BgflYN3R)进行安装。\n\n### 查看系统信息\n\n```plain\ngeostar@geostar-ft1500a:~$ cat /proc/version\nLinux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020\n```\n\n这里可以看到系统是基于ubuntu16.04 的，所以我们添加ubuntu16.04（xenial）的软件源\n\n### 添加软件源\n\n>参考：\n>https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/\n>https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/\n\n添加清华镜像软件源（arm架构）\n\n```plain\n# 默认注释了源码镜像以提高 apt update 速度，如有需要可自行取消注释\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse\ndeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse\n```\n\n更新：\n\n```plain\nsudo apt-get install apt-transport-https\nsudo apt-get clean\nsudo apt-get update\n```\n\n### 安装Docker\n\n```plain\n# 卸载旧版本docker\nsudo apt-get remove docker docker-engine docker.io containerd runc\nsudo apt-get update\nsudo apt-get install \\\n    apt-transport-https \\\n    ca-certificates \\\n    curl \\\n    gnupg-agent \\\n    software-properties-common\n    \ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -\n# 确认key添加成功(查找：9DC8 5822 9FC7 DD38 854A  E2D8 8D81 803C 0EBF CD88)\nsudo apt-key fingerprint 0EBFCD88\n```\n\n编辑 /etc/apt/source.list，添加docker软件源（arm64 xenial），并保存\n\n```plain\n# https://docs.docker.com/engine/install/ubuntu/\ndeb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable\n```\n\n安装 docker\n\n```plain\nsudo apt-get update\n# 安装Docker\nsudo apt-get install docker-ce docker-ce-cli containerd.io\n# 安装成功，查看版本\ndocker --version\nDocker version 19.03.12, build 48a6621\n```\n\n## 在Dockerhub上查找已有的arm镜像\n\n实际上很多镜像都有构建arm版本，对于直接使用的镜像，或者作为Dockerfile中FROM的镜像，如果有对应的arm版本，则可以直接使用，省略构建过程。以[postgres](https://hub.docker.com/_/postgres?fileGuid=0l3NVKX0BgflYN3R)为例，在dockerhub上可以看到\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172847.png!thumbnail)\n\n在具体的tag中也可以看到版本的镜像是否支持arm架构\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210408172851.png!thumbnail)\n\n但需要使用的镜像不是我们自己编译的时候，可以通过这种方式来确认该镜像是否有对应的arm版本。\n\n## ARM版本镜像构建（非ARM机器上执行）\n\n>参考：\n>-[https://github.com/docker/cli/blob/master/experimental/README.md](https://github.com/docker/cli/blob/master/experimental/README.md?fileGuid=0l3NVKX0BgflYN3R)\n>-[跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R)\n\n### 构建ARM镜像的两种方式\n\n对于构建镜像的ARM版本，有如下两种方式：\n\n1. 在ARM机器上使用 docker build 进行构建；\n2. 在X86/AMD64 的机器上使用 docker buildx 进行交叉构建；\n\n实际测试中发现第一种方式在某些情况下会有问题，建议采用结合采用这二种方式；\n\n关于第二种构建方式，可先阅读[跨平台构建 Docker 镜像新姿势，x86、arm 一把梭](https://cloud.tencent.com/developer/article/1543689?fileGuid=0l3NVKX0BgflYN3R)进行了解，以下简要介绍使用buildx交叉构建的方式；\n\n> **⚠️注意：**\n>\n> 1. 交叉构建和交叉运行的方式会有一些无法预知的问题，建议简单的构建步骤（如只是下载解压对应架构的文件）可考虑在x86下交叉构建，复杂的（如需要编译的）则直接在arm机器上进行构建；\n>\n> 2. 实际测试发现，使用[qemu方式](https://github.com/multiarch/qemu-user-static)在x86平台下运行arm版本的镜像时，执行简单的命令可以成功（如arch），执行某些复杂的程序时（如启动java虚拟机），会无响应，所以镜像的验证工作应尽量放置到arm机器上进行；\n>\n>    上面第二点按如下方式测试： \n>\n>    * `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch` 可正常输出；\n>    * `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version` 则会**卡住**，且需要使用`docker stop`停止容器才可以退出容器；\n\n### 启用试验性功能\n\n>参考：https://docs.docker.com/engine/reference/commandline/cli/#experimental-features\n>注意：buildx 仅支持 docker19.03 及以上docker版本\n\n如需使用 buildx，需要开启docker的实验功能后，才可以使用，开启方式：\n\n* 编辑   /etc/docker/daemon.json\n* 添加：\n\n```json\n{\n    \"experimental\": true\n}\n```\n\n* 编辑 ～/.docker/config.json 添加：\n\n```json\n\"experimental\" : \"enabled\"\n```\n\n* 重启Docker使生效：\n  * sudo systemctl  daemon-reload\n  * sudo systemctl  restart docker\n* 确认是否开启：\n  * docker version -f'{{.Server.Experimental}}'\n  * 如果输出true，则表示开启成功\n\n### 使用buildx构建\n\nbuildx 的详细使用可参考：[Docker官方文档-Reference-buildx ](https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R)\n\n#### 创建 buildx 构建器\n\n使用 docker buildx ls 命令查看现有的构建器\n\n```shell\ndocker buildx ls\n```\n\n创建并构建器：\n\n```shell\n# 下面的创建命令任选一条符合情况的即可\n# 1. 不指定任何参数创建\ndocker buildx create --use --name multiarch-builder\n# 2. 如创建后使用docker buildx ls 发现构建起没有arm架构支持，可使用--platform明确指定要支持的构建类型，如以下命令\ndocker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder\n# 3. 如需在buildx访问私有registry，可使用host模式，并手动指定配置文件，避免buildx时无法访问本地的registry主机 \ndocker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder \n```\n\nbuildx-config.toml 配置文件写法类似：\n\n```plain\n# https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md\n# registry configures a new Docker register used for cache import or output.\n[registry.\"zh-registry.geostar.com.cn\"]\n  mirrors = [\"zh-registry.geostar.com.cn\"]\n  http = true\n  insecure = true\n```\n\n**启用构建器**\n\n```shell\n# 初始化并激活\ndocker buildx inspect multiarch-builder --bootstrap\n```\n\n**确认成功**\n\n```plain\n# 使用 docker buildx ls 查看\ndocker buildx ls \n```\n\n### 修改Dockerfile\n\n对 Dockerfile 的修改，大致需要进行如下操作：\n\n1. 确认基础镜像（FROM）是否有arm版本，如果有，则可以不用改动，如果没有，则需要寻找替代镜像，如没有替代镜像，则可能需要自行编译；\n2. 确认dockerfile的各个步骤中是否有依赖CPU架构的，如果有，则需要替换成arm架构的，如在构建jitis的镜像时，Dockerfile中有添加一个amd64架构的软件\n\n`ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz`\n\n此时需要替换为下面的地址(注意amd64替换成了aarch64，当然，需要先确认下载地址中有无对应架构的gz包，不能简单做字符替换)：\n\n`ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz`\n\n当然，我们需要确认该软件有此架构的归档包，如果没有，则需要考虑从源码构建；\n\n> **提示：**\n>\n> 怎么确定一个可执行文件/so库的对应的执行架构？ 可以通过 `file {可执行文件路径}` 来查看，\n>\n> 如下面时macOS上执行file命令的输入，可以发现macOS上的git程序可以兼容两种架构-`x86_64&arm64e`：\n>\n> ```shell\n> file $(which git)\n> /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]\n> /usr/bin/git (for architecture x86_64):\tMach-O 64-bit executable x86_64\n> /usr/bin/git (for architecture arm64e):\tMach-O 64-bit executable arm64e\n> ```\n>\n> 下面的命令则对一个so文件执行了file，可以看到其中的架构信息 `ARM aarch64`：\n>\n> ```shell\n> file /lib/aarch64-linux-gnu/libpthread-2.23.so\n> /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped\n> ```\n\n### docker buildx 构建arm64镜像的命令\n\n使用 --platform来指定架构，使用 `--push` 或 `--load` 来指定构建完毕后的动作。\n\n```shell\ndocker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push \n```\n\n> 提示：当指定多个架构时，只能使用 --push 推送到远程仓库，无法 --load，推送成功后再通过 docker pull --platform 来拉取指定架构的镜像\n\n### 检查构建成果\n\n1. 通过 `docker buildx imagetools inspect` 命令查看镜像信息，看是否有对应的arm架构信息；\n2. 实际运行镜像，确认运行正常；（在arm机器上执行）\n\n>提示：如运行时输出 exec format error 类似错误，则表示镜像中部分可执行文件架构不匹配。\n\n\n\n## 在x86上运行arm镜像\n\n可参考 [github/qemu-user-static](https://github.com/multiarch/qemu-user-static) ,简要描述如下：\n\n* 执行如下命令安装：\n\n  `docker run --rm --privileged multiarch/qemu-user-static --reset -p yes`\n\n* 之后即可运行arm版本的镜像，如：\n\n  ```shell\n  docker run --rm -t arm64v8/fedora uname -m\n  ```\n\n",
      "data": {
        "title": "Docker构建Arm架构镜像-通用步骤",
        "date": "2020-08-19 17:20:59",
        "tags": [
          "Docker"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "\n介绍ARM版本的Docker镜像的构建，包括ARM机器上Docker的安装，在ARM机器上构建镜像，及在amd64机器上使用buildx交叉构建arm版本镜像。",
      "fileName": "Docker-ARM架构镜像构建-通用步骤"
    },
    {
      "content": "本文介绍Gitlab-Runner的安装运行（包括docker方式安装运行及二进制直接运行），并介绍如何将Gitlab注册到Gitlab。同时还介绍了gitlab-runner的一些常用操作命令。\n\n\n<!-- more -->\n\n\n\n## 安装Gitlab-Runner\n\ngitlab-runner可以使用docker方式运行，也可以在主机上运行其二进制可执行文件，可按如下方式进行选择：\n\n* 执行通用的构建测试任务及与不需要直接访问主机目录的，以docker方式安装；\n* 执行部署类任务或需要直接访问主机目录的，以二进制方式安装；\n\n以下分别介绍上述两种安装方式。\n\n\n\n### 使用docker安装gitlab-runner\n\n使用docker方式安装的，需先在主机上安装docker环境，可参考 Docker 官方安装文档。以下操作假设主机上已正确安装并配置了docker运行环境；\n\n>提示：可以使用基于alpine的镜像来减小大小\n\n```shell\n# 建立配置挂载目录\nmkdir -p /data/gitlab-runner/config\n# 建立构建目录挂载目录\nmkdir -p /data/gitlab-runner/home\n# 注意，这里我们使用了基于alpine的镜像来减小大小；使用 --restart 标识来自动重启\ndocker run -d --name gitlab-runner --restart always \\\n  -v /data/gitlab-runner/config:/etc/gitlab-runner \\\n  -v /data/gitlab-runner/home:/home/gitlab-runner \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  gitlab/gitlab-runner:alpine\n  \n# 通过以下命令设置docker开机自启\nsudo systemctl enable docker\n```\n\n### docker安装的gitlab-runner常用操作\n\n#### 运行命令\n\n使用已有容器\n\n```shell\n# 容器已经运行的情况下\n# 1. 交互式执行，执行以下命令，然后输入命令\ndocker exec -it gitlab-runner /bin/bash\n# 然后执行命令\ngitlab-runer --help\n# 2. 单次执行\ndocker exec gitlab-runner gitlab-runner --help\n```\n\n使用临时的：\n\n```shell\ndocker run --rm -t -i gitlab/gitlab-runner:alpine --help\n# -it 使用交互式终端\n# --rm 自动删除\n```\n\n#### 重启gitlab-runner\n\n```\ndocker restart gitlab-runner\n```\n\n#### 升级版本\n\n```shell\n# 获取最新\ndocker pull gitlab/gitlab-runner:alpine\ndocker stop gitlab-runner && docker rm gitlab-runner\ndocker run -d --name gitlab-runner --restart always \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  -v /data/gitlab-runner/config:/etc/gitlab-runner \\\n  -v /data/gitlab-runner/home:/home/gitlab-runner \\\n  gitlab/gitlab-runner:alpine\n```\n\n#### 查看日志\n\n```shell\ndocker logs gitlab-runner\n```\n\n#### 配置 gitlab-runner 别名\n\n在 `~/.bash_profile` 或 `~/.bashrc` 文件中加入如下函数配置，后续运行 gitlab-runner 命令时即可省去docker exec 命令\n\n```shell\n# 添加 gitlab-runner 直接执行到容器\nfunction gitlab-runner(){\n    docker exec -it gitlab-runner gitlab-runner $@\n}\n```\n\n\n\n### 使用二进制包安装运行gitlab-runner\n\n#### 获取安装包安装并运行\n\n* Centos or RedHat 使用如下命令安装：\n\n  ```shell\n  ARCH=$(arch)\n  \n  curl -LJO \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner$ARCH.rpm\"\n  \n  rpm -i gitlab-runner_$ARCH.rpm\n  ```\n\n* Debian or Ubuntu 使用如下命令安装\n\n  ```shell\n  ARCH=$(arch)\n  \n  curl -LJO \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_$ARCH.deb\"\n  \n  dpkg -i gitlab-runner_$ARCH.deb\n  ```\n\n* Windows 安装\n\n  请参考官方文档： https://docs.gitlab.com/runner/install/windows.html#installation\n\n* 测试是否安装成功，如能成功输出gitlab-runner的用法信息，则表示安装成功\n\n  ```\n  gitlab-runner --help\n  ```\n\n* 测试是否成功启动\n\n  ```\n  gitlab-runner status\n  # 如输出 Service is running，则表示成功启动了\n  ```\n\n  > 通过docker方式运行的runner在运行 `gitlab-runner status`时会输出 `not running`，这对于docker方式运行的runner是正常的，只有直接运行于主机上的runner需要启动对应的服务；\n\n#### 安装并更新Git版本\n\nGitlab-CI 任务在 runner 机器上执行，会先通过git获取对应仓库的最新代码，这个获取代码的操作是通过git来完成的，所以我们需要安装git工具；\n\n* **安装Git**\n\n  ```shell\n  sudo yum install -y git\n   # 查看版本\n  git --version\n  # centos7 上为 1.8.x，无法满足gitlab要求\n  ```\n\n* **升级Git版本**\n\n  某些linux发型版上git版本过低，在执行流水线时会失败，需要升级git版本，可按如下方式从源码安装最新git版本；\n\n  * 下载git v2.27.0源码\n\n    ```shell\n    ## 以下下载方式任选其一\n    # 可选下载方式1 - 从gitee 克隆\n    git clone -b v2.27.0 https://gitee.com/hanlyjiang/git.git git-2.27.0\n    cd git-2.27.0 && git checkout -b tag-v2.27.0 v2.27.0\n    \n    # 可选下载方式2 - 从github直接下载包\n    curl -LJO https://github.com/git/git/archive/v2.27.0.tar.gz\n    tar -xvf git-2.27.0.tar.gz \n    cd git-2.27.0\n    ```\n\n  * 编译安装\n\n    ```shell\n    # 安装编译依赖库\n    sudo yum install  -y autoconf gcc openssh zlib-devel\n    \n    # 编译并安装\n    make configure ;# as yourself\n    ./configure --prefix=/usr ;# as yourself\n    make -j8 all ;# as yourself\n    sudo make install ;# as root\n    \n    # 确认版本：\n    git --version\n    # git version 2.27.0\n    ```\n\n#### 将gitlab-runner用户添加到docker用户组（可选）\n\n如需要在该gitlab-runner的CI脚本中运行docker命令，这需要将 gitlab-runner用户添加到docker的用户组，可执行如下命令：\n\n```shell\nsudo usermod -a -G docker gitlab-runner\n\n# 验证权限\nsudo -u gitlab-runner -H docker info\n```\n\n#### 修改 gitlab-runner 构建目录\n\n如在执行ci任务时，拉取代码时报build目录权限问题，可尝试按如下方式修改指定runner的构建目录\n\n1. 查找配置文件路径\n\n   ``` shell\n   gitlab-runner list \n   # 其中ConfigFile的值就是对应的配置文件，如：\n   # ConfigFile=/etc/gitlab-runner/config.toml\n   ```\n\n2. 修改 `builds_dir` 指向\n\n   找对该任务对应的`[[runner]]` 配置段，并在该配置中添加 `builds_dir` 指向新的具有权限的目录，然后重启启动gitlab-runner即可；\n\n   ```yaml\n   [[runners]]\n     name = \"blockdataapi-engine\"\n     url = \"http://172.17.0.205/\"\n     token = \"Y-6zdV9zzi8xsY1rygbn\"\n     executor = \"shell\"\n     builds_dir = \"/data/gitlab-runner/builds\"\n     [runners.custom_build_dir]\n     [runners.cache]\n       [runners.cache.s3]\n       [runners.cache.gcs]\n   ```\n\n\n\n## 注册 Runner 到 Gitlab\n\n这里我们将runner注册为群组的Runner，群组runner可以在群组中共享，所有子群组和项目都可以使用该Runner。也可以将Runner注册到指定项目仓库上，操作上只有获取gitlab-runner注册信息时不一样；\n\n### 获取gitlab-runner注册信息\n\n> 如需注册到具体项目，在项目的设置在进入对应的CI/CD设置即可，后续操作流程一致；\n\n在群组的设置中打开 CI/CD 设置\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180602.png!thumbnail)\n\n展开 Runner 栏位\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180606.png!thumbnail)\n\n这里我们选择通过手动设置group runner的方式来注册，可以获取到以下信息：\n\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180610.png!thumbnail)\n\n### 注册runner\n\n以docker方式运行的gitlab-runner可按如下方式进入交互环境，**直接二进制运行的无需此操作**；\n\n在gitlab-runner 的机器上执行注册命令，将runner注册到gitlab，为了方便操作，我们使用以下命令进入gitlab-runner容器shell环境：\n\n```shell\ndocker exec -it gitlab-runner /bin/bash\n```\n\n执行完成后出现如下交互窗口\n\n```shell\nbash-4.4#\n```\n\ndocker方式运行的runner需在此bash中执行命令，主机之间运行的runner直接在shell中执行即可。\n\n### 执行register命令进行注册\n\n```shell\ngitlab-runner register \n# url：\nhttp://172.17.0.205/\n# token\ncEJ611JDeCWSMyu7WXWi\n# description - 用于辨识该注册所属的群组或项目，可以设置为方便区分的字符串\nsonarqube-runner\n# ci-tag - 标签用于后续CI配置中选择此执行器，后期可以通过gitlab界面更改\nsonarqube,common-build\n# executor - 后续CI任务的执行方式，docker方式运行的请选择docker\ndocker\n# default image - CI配置中未指定镜像时默认使用的镜像\nbusybox:1.31.1\n```\n\n以下为一个注册过程的交互示例：\n\n```shell\nbash-4.4# gitlab-runner register \nRuntime platform                                    arch=amd64 os=linux pid=205 revision=05161b14 version=12.4.1\nRunning in system-mode.                            \n                                                   \nPlease enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):\nhttp://172.17.0.205/\nPlease enter the gitlab-ci token for this runner:\ncEJ611JDeCWSMyu7WXWi\nPlease enter the gitlab-ci description for this runner:\n[e0311b0ce34b]: sonarqube-runner\nPlease enter the gitlab-ci tags for this runner (comma separated):\nsonarqube,common-build\nRegistering runner... succeeded                     runner=cEJ611JD\nPlease enter the executor: virtualbox, docker+machine, docker-ssh+machine, custom, docker-ssh, parallels, kubernetes, docker, shell, ssh:\ndocker\nPlease enter the default Docker image (e.g. ruby:2.6):\nbusybox:1.31.1\nRunner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!\n```\n\n### 注册后确认\n\n完成后在刚才的页面可以看到；\n![图片](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224180615.png)\n\n### 取消注册\n\n使用 list 命令查看当前注册的token及url\n\n```shell\ngitlab-runner list\n# 输出类似\nRuntime platform                                    arch=amd64 os=linux pid=23 revision=05161b14 version=12.4.1\nListing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml\nsonarqube-runner                                    Executor=docker Token=wNwxjEztRpKxYDyK1zVd URL=http://172.17.0.205/\n```\n\n使用list命令输出的token机url作为参数 使用unregister命令取消注册\n\n```shell\ngitlab-runner unregister -t 7KM7ftthLAYeJdsB3Tbk -u http://172.17.0.205/\n```\n\n\n\n## 了解更多\n\n* [DOCKER 方式安装gitlab-runner](https://docs.gitlab.com/runner/install/docker.html)\n* [Linux安装gitlab-runner-Gitlab官方文档](https://docs.gitlab.com/runner/install/linux-manually.html)\n* [使用Docker运行Gitlab-Runner-Gitlab官方文档](https://docs.gitlab.com/runner/install/docker.html)\n* [注册Runner-Gitlab官方文档](https://docs.gitlab.com/runner/register/index.html)\n* [Gitlab-Runner alpine Dockerfile](https://gitlab.com/gitlab-org/gitlab-runner/blob/master/dockerfiles/alpine/Dockerfile)\n* [Windows上注册Runner](https://docs.gitlab.com/runner/install/windows.html)\n* [如何在docker执行器中构建Docker镜像？](http://github.com/help/ci/docker/using_docker_build.md)",
      "data": {
        "title": "Gitlab-Runner安装并注册 ",
        "date": "2020-06-11 16:11:58",
        "tags": [
          "Gitlab",
          "工具"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "本文介绍Gitlab-Runner的安装运行（包括docker方式安装运行及二进制直接运行），并介绍如何将Gitlab注册到Gitlab。同时还介绍了gitlab-runner的一些常用操作命令。",
      "fileName": "Gitlab-安装并注册Gitlab-runner"
    },
    {
      "content": "\n将gitlab（Docker方式运行）从12.10.0升级到13.0.6 的过程记录。\n\n<!-- more -->\n\n## 升级准备工作\n\n### **确定升级路线**\n\n- 现有版本：12.10.0\n- 当下目标版本：13.0.6\n- 结合 [Gitlab升级路线建议](https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations) 确定如下升级路线：\n  - 12.10.0 -> 13.0.0 -> 13.0.6 \n  - 由于我们跨大版本升级了（12-13），所以引入了 13.0.0 的中间升级路径\n\n### **获取最新版本信息**\n\n- 查看 gitlab release页面 信息\n- 查看 gitlab docker hub 获取gitlab-ce docker镜像版本TAG：\n- 13.0.0: `gitlab/gitlab-ce:13.0.0-ce.0`\n- 13.0.6: `gitlab/gitlab-ce:13.0.6-ce.0`\n- 查看升级注意事项\n- 升级流程： https://docs.gitlab.com/omnibus/docker/README.html#update\n- 版本升级建议路线：https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations\n\n## 备份\n\n备份有两种方式，备份的数据量不相同：\n\n* 对docker挂载的gitlab数据目录整体备份\n* 使用 gitlab的 `gitlab-backup create` 命令创建备份，可包含所有git仓库，包括wiki及权限信息。\n\n> 建议对挂载的gitlab数据目录进行一次整体备份，目前暂不清楚gitlab-backup create命令创建的备份是否包含ci相关内容。\n\n以下对gitalb-backup 命令执行备份进行简要介绍。数据目录的备份方式直接对目录进行操作即可。\n\n进入到gitlab部署机器，执行如下命令：\n\n```shell l\ndocker exec -t <container name> gitlab-backup create\n# 如果docker容器的名称是gitlab，则可以执行如下命令，备份完成后位于gitlab的数据目录，如：/data/gitlab/data/backups/\ndocker exec -t $(docker ps | grep gitlab | awk '{print $1}') gitlab-backup create\n# 备份配置目录\nsudo tar -cvf /data/gitlab/data/backups/1592710400_2020_06_21_12.10.0_gitlab_config_backup.tar /data/gitlab/config \n```\n\n## 执行升级：\n\n- 进入到gitlab部署机器 \n\n```shell\nssh -p 10022 geostar@172.17.0.205\n```\n\n- 获取Gitlab中间版本镜像及最终版本镜像\n\n```shell\ndocker pull gitlab/gitlab-ce:13.0.0-ce.0\ndocker pull gitlab/gitlab-ce:13.0.6-ce.0\n```\n\n- 停止并移除现有服务\n\n```shell\nsudo docker stop gitlab \nsudo docker rm gitlab \n```\n\n- 进行升级，使用 13.0.0 的镜像运行gitlab，gitlab会自动处理数据升级流程\n\n```shell\n    sudo docker run --detach \\\n        --hostname 172.17.0.205 \\\n        --publish 443:443 --publish 80:80 --publish 22:22 \\\n        --name gitlab \\\n        --restart always \\\n        --volume /data/gitlab/config:/etc/gitlab \\\n        --volume /data/gitlab/logs:/var/log/gitlab \\\n        --volume /data/gitlab/data:/var/opt/gitlab \\\n        gitlab/gitlab-ce:13.0.0-ce.0\n```\n\n- 待 13.0.0 升级完毕之后，升级到 13.0.6，使用 13.0.6 的镜像运行gitlab\n\n```shell\n      sudo docker stop gitlab \n      sudo docker rm gitlab \n      sudo docker run --detach \\\n        --hostname 172.17.0.205 \\\n        --publish 443:443 --publish 80:80 --publish 22:22 \\\n        --name gitlab \\\n        --restart always \\\n        --volume /data/gitlab/config:/etc/gitlab \\\n        --volume /data/gitlab/logs:/var/log/gitlab \\\n        --volume /data/gitlab/data:/var/opt/gitlab \\\n        gitlab/gitlab-ce:13.0.6-ce.0\n```\n\n## 确认升级成功\n\n登录管理员账号，进入管理中心-仪表盘，查看gitlab版本：\n\n![image-20210302165417697](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302165417.png)\n\n",
      "data": {
        "title": "Gitlab升级记录（12.10.0-13.0.6）",
        "date": "2020-05-21 16:50:41",
        "tags": [
          "Gitlab"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "\n将gitlab（Docker方式运行）从12.10.0升级到13.0.6 的过程记录。",
      "fileName": "gitlab-sheng-ji-ji-lu-12100-1306"
    },
    {
      "content": "主要内容：\n*  使用docker运行 gitlab；\n*  配置LDAP及邮箱；\n*  配置管理员账号；\n*  配置邮箱通知；\n*  关闭用户注册；\n<!-- more -->\n\n## 安装\n\n我们使用docker来安装Gitlab，执行如下命令即可安装运行，完成后使用\n\n```shell\nexport GITLAB_DATA=/data/gitlab\n# 设置主机的ip域名\nexport HOST_IP=192.168.43.62\nmkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data\ndocker run --detach \\\n        --hostname $HOST_IP \\\n        --publish 443:443 --publish 80:80 --publish 22:22 \\\n        --name gitlab \\\n        --restart always \\\n        --volume $GITLAB_DATA/config:/etc/gitlab \\\n        --volume $GITLAB_DATA/logs:/var/log/gitlab \\\n        --volume $GITLAB_DATA/data:/var/opt/gitlab \\\n        gitlab/gitlab-ce:13.9.1-ce.0\n```\n\n> * 数据全部挂载在外部目录 GITLAB_DATA 中\n> * `--hostname 192.168.43.62` : 指定当前服务的IP或者域名，后续将会显示为gitlab代码仓库的克隆地址\n> * `--restart always` : 设置服务自动重启\n\n> 查看gitlab的可用版本： \n>\n> * [dockerhub/gitlab-ce](dockerhub/gitlab-ce)\n> * [gitlab release page](https://about.gitlab.com/releases/categories/releases/)\n\n### **查看启动状态**\n\n启动期间可以使用 `docker ps` 查看状态，如STATUS中显示为`starting`则表示服务还在启动中，如显示为`healthy`则表示服务已正常启动，即可访问 http://192.168.43.62 访问Gitlab的web地址。\n\n```shell\nCONTAINER ID        IMAGE                          COMMAND             CREATED             STATUS                 PORTS                                                          NAMES\n79b432f0f601        gitlab/gitlab-ce:13.0.6-ce.0   \"/assets/wrapper\"   2 months ago        Up 2 weeks (healthy)   0.0.0.0:22->22/tcp, 0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp   gitlab\n```\n\n也可使用 `docker logs -f gitlab` 来查看gitlab的服务启动日志\n\n### 设置root管理员用户密码\n\n首次打开页面后会提示设置root用户的密码，设置后务必记录好用户密码，后续将使用此用户对Gitlab进行管理\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302163607.png\" alt=\"image-20210302163607120\" style=\"zoom:50%;\" />\n\n## 配置LDAP\n\n服务启动正常后，`$GITLAB_DATA/config` 文件夹中即生成了gitlab的配置文件，可编辑`$GITLAB_DATA/config/gitlab.rb` （对应容器内部 `/etc/gitlab/gitlab.rb` ）文件来修改gitlab配置以使用LDAP\n\n```shell\nvim /etc/gitlab/gitlab.rb\n```\n\n通过`?` 搜索`LDAP`，找到如下配置端，按如下方式进行修改：\n\n```ruby\n\n### LDAP Settings\n###! Docs: https://docs.gitlab.com/omnibus/settings/ldap.html\n###! **Be careful not to break the indentation in the ldap_servers block. It is\n###!   in yaml format and the spaces must be retained. Using tabs will not work.**\n\ngitlab_rails['ldap_enabled'] = true\n\ngitlab_rails['ldap_servers'] = YAML.load <<-'EOS'\n   main:\n     label: '域账号'\n     host: '172.17.0.3'\n     port: 389\n     uid: 'sAMAccountName'\n     bind_dn: 'CN=域账号读取用户,OU=colorless-域用户,DC=colorless,DC=com,DC=cn'\n     password: '域账号读取用户的登录密码'\n     encryption: 'plain' # \"start_tls\" or \"simple_tls\" or \"plain\"\n     verify_certificates: false\n     smartcard_auth: false\n     active_directory: true\n     allow_username_or_email_login: false # 是否允许以用户名登录（邮箱也会取用户名来严重）\n     lowercase_usernames: false\n     block_auto_created_users: false\n     base: 'OU=colorless-域用户,DC=colorless,DC=com,DC=cn'\n     user_filter: ''\nEOS\n\n```\n\n> 配置修改说明：\n>\n> * `ldap_enabled` 需要设置为true\n> * `ldap_servers` 配置AD域相关信息\n>   * label： 随便取，会显示在gitlab的登录页面\n>   * host： 域控制服务器主机地址\n>   * port： 域控制器服务端口\n>   * uid：  将域用户信息中的哪个字段作为gitlab上的登录标识（一般都是sAMAccountName）\n>   * bind_dn： 用于访问域控制服务器的用户账号，用户账号的格式需要使用`CN=xxx,OU=XXX,DC=XXXX` 类似的格式\n>   * password： 对应的base_dn账号的密码\n>   * base： 用于登录时，会去base所定义的组里面去检索用户是否存在，如用户在这个范围内，才可以登录；如及用于公司一个部门的登录，可将base值配置到部门级别，则其他部分无法以域账号进行登录；\n>\n> 提示： 如无法确认 uid，bind_dn，base 等的值，可以咨询信息中心或者使用AD域访问查看软件（如：[Apache Directory](http://directory.apache.org/)）连接到域账号控制器服务后，通过图形界面查看对应信息；\n\n修改完毕后需要保存文件后重启gitlab服务，对于docker启动的gitlab来说，可执行如下命令重启服务：\n\n```shell\n# 其中gitlab为我们使用docker run 命令时通过--name选项指定的容器名称\ndocker restart gitlab \n```\n\n待gitlab重启完毕后，登录界面即出现域账号登录的tab入口，点击域账号tab即可使用域账号进行登录\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302161215.png\" alt=\"image-20210302161215567\" style=\"zoom:50%;\" />\n\n## 配置邮箱通知\n\n公司邮箱服务器配置：\n\n```ruby\ngitlab_rails['smtp_enable'] = true\ngitlab_rails['smtp_address'] = \"mail.colorless.com.cn\"\ngitlab_rails['smtp_port'] = 25\ngitlab_rails['smtp_user_name'] = \"gitlab@colorless.com.cn\"\ngitlab_rails['smtp_password'] = \"xxxxx\"\ngitlab_rails['smtp_domain'] = \"colorless.com.cn\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true\ngitlab_rails['smtp_tls'] = false\n```\n\n163邮箱配置示例：（需在163邮箱中开启SMTP服务，可参考： [CSDN-如何使用163的SMTP服务发邮件？](https://blog.csdn.net/liuyuinsdu/article/details/113878840)）\n\n```ruby\ngitlab_rails['smtp_enable'] = true\ngitlab_rails['smtp_address'] = \"smtp.163.com\"\ngitlab_rails['smtp_port'] = 25\ngitlab_rails['smtp_user_name'] = \"colorless@163.com\"\ngitlab_rails['smtp_password'] = \"密码\"\ngitlab_rails['smtp_domain'] = \"163.com\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true\ngitlab_rails['smtp_tls'] = false\n```\n\n\n\n## 关闭及管理员配置\n\n### 赋予指定域账号管理员权限\n\n在配置了域账号登录之后，先让需要设置为管理员的账号使用域账号登录一次gitlab，登录后gitlab即会为该用户创建关联的gitlab账号。\n\n然后使用root用户登录，进入\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164307.png\" alt=\"image-20210302164306980\" style=\"zoom:50%;\" />\n\n将用户的访问类型切换为管理员：\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164354.png\" alt=\"image-20210302164354791\" style=\"zoom:50%;\" />\n\n### 关闭用户注册\n\n在配置了域账号登录之后，可以关闭用户注册，即只允许拥有域账号的人员进行登录；\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210302164139.png\" alt=\"image-20210302164139380\" style=\"zoom:67%;\" />\n\n\n",
      "data": {
        "title": "Gitlab安装配置",
        "date": "2020-04-06 11:54:06",
        "tags": [
          "Gitlab",
          "工具"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "主要内容：\n*  使用docker运行 gitlab；\n*  配置LDAP及邮箱；\n*  配置管理员账号；\n*  配置邮箱通知；\n*  关闭用户注册；",
      "fileName": "Gitlab-安装并配置Gitlab"
    },
    {
      "content": "Android提供的几种JS同Java交互的方式介绍，通过一个实例介绍通过`evaluateJavascript`调用JS方法。\n\n<!-- more -->\n## Android提供的js原生交互API\n\n### Android调用 JS 代码：\n\n1. 通过WebView的 **loadUrl()**\n2. 通过WebView的 **evaluateJavascript()** 方法\n\nAndroid调用 JS 代码主要使用 第二种方法。\n\n### JS 调用 Android 代码：\n\n1. **通过 WebView 的 addJavascriptInterface() 进行对象映射**\n2. 通过**WebChromeClient**的 **onJsAlert**() 、**onJsConfirm**()、**onJsPrompt**() 方法回调拦截JS对话框**alert**()、**confirm**()、**prompt**() 消息\n3. 通过**WebViewClient**的**shouldOverrideUrlLoading()** 方法回调拦截 url\n\n第2和第3中方式能力有限，所以主要是第一种。\n\n**官方示例代码：**\n\naddJavaScriptInterface 注入原生对象到JS + 原生通过loadUrl 调用JS代码\n\n```\nclass JsObject {\n@JavascriptInterface\npublic String toString() { return \"injectedObject\"; }\n}\nwebview.getSettings().setJavaScriptEnabled(true);\n// 注入Java对象到 JavaScript ，JS中可以通过 injectedObject 来调用原生代码\nwebView.addJavascriptInterface(new JsObject(), \"injectedObject\");\nwebView.loadData(\"\", \"text/html\", null);\nwebView.loadUrl(\"javascript:alert(injectedObject.toString())\");\n```\n>**注意：**\n>1. Android 4.2（JELLY BEAN）及更高版本中只有被*JavascriptInterface*注解的public方法才可以在js中调用； Android4.2以下设备上，所有public方法都可以被js访问（包括继承的）\n>2. 通过*addJavaScriptInterface*加入对象 ： 必须在注入对象之前启用JavaScript，并且注入的对象直到下次页面重新加载才会出现在JavaScript中。\n\n\n\n## 应用实例：Java同Vue交互\n\n我们需要在页面加载完毕之后更新数据，此时需要通过Java侧调用JS的方法来将数据传递给JS通知其更新；\n首先，我们需要在JS侧定义一个接收数据的方法，为了能让Java侧能方便找到，我们将方法定义到window对象上。\n然后在WebView中页面加载完毕（onPageFinished）后，调用 `webView.evaluateJavascript` 来调用此JS方法；\n\n### JS侧方法注册\n\n>注意：\n>1. 需要添加到全局对象，这样才能Android侧才能调用；\n>2. 由于示例中只有一个app组件，所以直接使用 vm.$children[0] 获取vue组件\n>3. component.$data 获取组件的数据，并赋值，赋值后view会自动变化；\n```javascript\n// main.js\n/* eslint-disable no-new */\nlet vm = new Vue({\n  el: '#app',\n  components: {App},\n  template: '<App/>',\n});\n// 定义hnUpdateData方法到window全局对象\nwindow.hnApp = {};\nwindow.hnApp.hnUpdateData = function (data) {\n  if (!data) {\n    Android.alert(\"数据格式不正确\");\n    return;\n  }\n  console.log(data);\n  const jsonData = JSON.parse(data);\n  const component = vm.$children[0];\n  component.$data.header = jsonData.header ? jsonData.header : {};\n  component.$data.jjb = jsonData.jjb ? jsonData.jjb : {};\n  component.$data.events = jsonData.events ? jsonData.events : [];\n};\n```\n### 原生侧调用JS\n\n#### 定义方法-调用JS方法更新数据\n\n```java\n    private void tryUpdateWebData(JSdata jSdata) {\n        if (isPageLoaded && isDataReady) {\n            String methodName = \"window.hnApp.hnUpdateData\";\n            String params = new Gson().toJson(jSdata);\n            String js = \"javascript:\" + methodName + \"(\" + JSONObject.quote(params) + \")\";\n            webView.evaluateJavascript(js, new ValueCallback<String>() {\n                @Override\n                public void onReceiveValue(String value) {\n                }\n            });\n        }\n    }\n```\n> 注意：\n>\n> 1.  js执行代码：javascript:methodName(参数)\n> 2.  参数处理：JSONObject.quote(params) 对象转json字符串\n\n### WebView初始化并调用JS方法\n\n```java\npublic void initView() {\n        webView = (WebView) findViewById(R.id.web_view);\n        webView.setWebViewClient(webViewClient);\n        webView.setWebChromeClient(webChromeClient);\n        webView.setDownloadListener(downloadListener);\n        webView.requestFocusFromTouch();\n        WebSettings settings = webView.getSettings();    // Copy From Cordova SystemWebViewEngine.java\n        settings.setJavaScriptEnabled(true);\n        settings.setJavaScriptCanOpenWindowsAutomatically(true);\n        settings.setJavaScriptEnabled(true);\n    }\n\n    private WebViewClient webViewClient = new WebViewClient() {\n        @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n        @Override\n        public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {\n            view.loadUrl(request.getUrl().toString());\n            super.shouldOverrideUrlLoading(view, request);\n            return true;\n        }\n\n        @Override\n        public void onPageFinished(WebView view, String url) {\n            super.onPageFinished(view, url);\n            isPageLoaded = true;\n            // 调用js更新数据\n            tryUpdateWebData(mData);\n        }\n    };\n\n    private WebChromeClient webChromeClient = new WebChromeClient() {\n        // ...   \n    }\n\n```",
      "data": {
        "title": "Android-WebView中Java同JS的交互",
        "date": "2020-03-20 10:18:50",
        "tags": [
          "Android",
          "WebView",
          "Vue"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "Android提供的几种JS同Java交互的方式介绍，通过一个实例介绍通过`evaluateJavascript`调用JS方法。",
      "fileName": "Android-WebView中Java同JS的交互"
    },
    {
      "content": "> 欢迎来到我的小站呀，很高兴遇见你！🤝\n\n## 🏠 关于本站\n\n## 👨‍💻 博主是谁\n\n## ⛹ 兴趣爱好\n\n## 📬 联系我呀\n",
      "data": {
        "title": "关于",
        "date": "2019-01-25 19:09:48",
        "tags": null,
        "published": true,
        "hideInList": true,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "",
      "fileName": "about"
    },
    {
      "content": "👏  欢迎使用 **Gridea** ！  \n✍️  **Gridea** 一个静态博客写作客户端。你可以用它来记录你的生活、心情、知识、笔记、创意... ... \n\n<!-- more -->\n\n[Github](https://github.com/getgridea/gridea)  \n[Gridea 主页](https://gridea.dev/)  \n[示例网站](http://fehey.com/)\n\n## 特性👇\n📝  你可以使用最酷的 **Markdown** 语法，进行快速创作  \n\n🌉  你可以给文章配上精美的封面图和在文章任意位置插入图片  \n\n🏷️  你可以对文章进行标签分组  \n\n📋  你可以自定义菜单，甚至可以创建外部链接菜单  \n\n💻  你可以在 **Windows**，**MacOS** 或 **Linux** 设备上使用此客户端  \n\n🌎  你可以使用 **𝖦𝗂𝗍𝗁𝗎𝖻 𝖯𝖺𝗀𝖾𝗌** 或 **Coding Pages** 向世界展示，未来将支持更多平台  \n\n💬  你可以进行简单的配置，接入 [Gitalk](https://github.com/gitalk/gitalk) 或 [DisqusJS](https://github.com/SukkaW/DisqusJS) 评论系统  \n\n🇬🇧  你可以使用**中文简体**或**英语**  \n\n🌁  你可以任意使用应用内默认主题或任意第三方主题，强大的主题自定义能力  \n\n🖥  你可以自定义源文件夹，利用 OneDrive、百度网盘、iCloud、Dropbox 等进行多设备同步  \n\n🌱 当然 **Gridea** 还很年轻，有很多不足，但请相信，它会不停向前 🏃\n\n未来，它一定会成为你离不开的伙伴\n\n尽情发挥你的才华吧！\n\n😘 Enjoy~\n",
      "data": {
        "title": "Hello Gridea",
        "date": "2018-12-12 00:00:00",
        "tags": [
          "Gridea"
        ],
        "published": true,
        "hideInList": true,
        "feature": "/post-images/hello-gridea.png",
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "👏  欢迎使用 **Gridea** ！  \n✍️  **Gridea** 一个静态博客写作客户端。你可以用它来记录你的生活、心情、知识、笔记、创意... ... ",
      "fileName": "hello-gridea"
    },
    {
      "content": "android事件基础及手势，主要关注各种手势的使用及其计算原理 。  \n\n<!-- more -->\n\n\n## Android事件基础\n\n这里我们主要关注概念\n\n### 事件监听器及事件处理程序\n\n可直接查看 [官方文档](https://developer.android.google.cn/guide/topics/ui/ui-events)，此处仅做简要描述；\n\n#### 事件监听器\n\nView类的包含一个回调方法的接口，通过setXXXListener来定义事件处理程序；\n\n> 事件监听器是 `View` 类中包含一个回调方法的接口。当用户与界面项目之间的互动触发已注册监听器的 View 对象时，Android 框架将调用这些方法。\n>\n> 事件监听器接口中包含以下回调方法：onClick()，onLongClick()，onFocusChange()，onKey()，onTouch()，onCreateContextMenu()\n\n我们重点关注onTouch：\n\n> onTouch()： 在 `View.OnTouchListener` 中。当用户执行可视为触摸事件的操作时，包括按下、释放或屏幕上的任何移动手势（在项目边界内），系统会调用此方法。\n>\n> 此方法返回一个布尔值，指示监听器是否处理完此事件。重要的是，此事件可以拥有多个分先后顺序的操作。因此，如果在收到 down 操作事件时返回 false，则表示您并未处理完此事件，而且对其后续操作也不感兴趣。因此，您无需执行事件内的任何其他操作，如手势或最终的 up 操作事件。\n\n#### 事件处理程序\n\n直接引用官方文档描述：\n\n> 如果您从 View 构建自定义组件，则可定义几种回调方法，用作默认事件处理程序。在有关[自定义 View 组件](https://developer.android.google.cn/guide/topics/ui/custom-components)的文档中，您将了解一些用于事件处理的常见回调，包括：\n>\n> - `onKeyDown(int, KeyEvent)`：在发生新的按键事件时调用。\n> - `onKeyUp(int, KeyEvent)`：在发生 key up 事件时调用。\n> - `onTrackballEvent(MotionEvent)`：在发生轨迹球动作事件时调用。\n> - `onTouchEvent(MotionEvent)`：在发生触屏动作事件时调用。\n> - `onFocusChanged(boolean, int, Rect)`：在 View 对象获得或失去焦点时调用。\n>\n> 还有一些其他方法值得您注意，尽管它们并非 View 类的一部分，但可能会直接影响所能采取的事件处理方式。因此，在管理布局内更复杂的事件时，不妨考虑使用以下其他方法：\n>\n> - `Activity.dispatchTouchEvent(MotionEvent)`：此方法允许 `Activity` 在所有触摸事件分派给窗口之前截获它们。\n> - `ViewGroup.onInterceptTouchEvent(MotionEvent)`：此方法允许 `ViewGroup` 监视分派给子级 View 的事件。\n> - `ViewParent.requestDisallowInterceptTouchEvent(boolean)`：对父级 View 调用此方法，可指示不应使用 `onInterceptTouchEvent(MotionEvent)` 截获触摸事件。\n\n这里我们重点关注 `onTouchEvent(MotionEvent)` 即在发生触屏动作事件时调用的回调方法；\n\n### 触摸手势\n\n手势可以让用户通过触摸来与屏幕元素进行交互；\n\n**用户交户角度的手势划分**：\n\n| 手势类型 | 具体手势-不同类型之间有重复 | 解释                                                         |\n| -------- | --------------------------- | ------------------------------------------------------------ |\n| 导航手势 |                             | 实现导航作用                                                 |\n|          | 点击 - Tap                  | 如：点击按钮跳转到另外一个页面                               |\n|          | 滚动和拖移 - Scroll&Pan     | 如：滑动图片列表或拖动以浏览地图<br/><br/>Scroll - 快速拖动并抬起手指时发生的一种滚动 <br/> Pan-拖移，慢速移动 |\n|          | 拖动/拖拽 - Drag            | 用户在触摸屏上拖动手指时发生的一种滚动<br/>如：按住底部sheet并向屏幕顶部拖动 |\n|          | 轻扫 - Swipe                | 单个手指触摸屏幕并快速地朝任意一个方向滑动<br/>如：左右滑动以在不同的Tab页中切换 |\n|          | 捏合/缩放 - Pinch           | 双指或多指捏合<br/>如：在一个图片列表中缩放一个item进入大图查看界面 |\n| 动作手势 |                             | 执行某种动作                                                 |\n|          | 点击 - Tap                  |                                                              |\n|          | 长按 - Long press           | 如：长按选中                                                 |\n|          | 轻扫 - Swipe                | 如：轻扫item展现删除/收藏按钮                                |\n| 变换手势 |                             | 用于改变元素大小，位置，旋转角度，实现变换效果               |\n|          | 双击 - Double tap           | 如：双击缩放图片                                             |\n|          | 捏合/缩放 - Pinch           | 如：缩放查看图片细节                                         |\n|          | 组合手势                    | 如：地图中的放大缩小&旋转                                    |\n|          | 选取并拖动 - Pick up&Move   | 长按选择元素 + 拖动元素                                      |\n\n>  [来源](https://material.io/design/interaction/gestures.html)及手势的动画效果可以看这里： [material.io](https://material.io/design/interaction/gestures.html#types-of-gestures)\n\n**Android中用于检测或处理手势的类/方法：**\n\n* [GestureDetector](https://developer.android.google.cn/reference/android/view/GestureDetector)：支持检测按下、滑动、长按等手势；事件回调方法包括 `onDown()`、`onLongPress()`、`onFling()`、[onScroll()](https://developer.android.google.cn/reference/android/view/GestureDetector.OnGestureListener#onScroll(android.view.MotionEvent, android.view.MotionEvent, float, float)) 等。可以将 `GestureDetector` 与 `onTouchEvent()` 方法结合使用；\n* [ScaleGestureDetector](https://developer.android.google.cn/reference/android/view/ScaleGestureDetector)：用于检测缩放手势；\n* [onTouchEvent()](https://developer.android.google.cn/reference/android/view/View#onTouchEvent(android.view.MotionEvent))： 直接处理onTouchEvent()方法，然后自行根据事件序列来判断手势；\n* [VelocityTracker](https://developer.android.google.cn/reference/android/view/VelocityTracker)：用于跟踪触摸事件的速度，如滑动事件中一般需要结合速度来使用；\n* [Scroller](https://developer.android.google.cn/reference/android/widget/Scroller) & [OverScroller](https://developer.android.google.cn/reference/android/widget/OverScroller)： 用于收集触摸事件来生成滚动动画所需的数据，OverScroller可以指示滑动后是否到达了内容边缘；\n\n>  **两种不同的滚动: 拖动和滑动**\n>\n> - **拖动**是指用户在触摸屏上拖动手指时发生的一种滚动。简单的拖动通常是通过替换 `GestureDetector.OnGestureListener` 中的 `onScroll()` 实现的。有关拖动的详细讨论，可参阅[拖动和缩放](https://developer.android.google.cn/training/gestures/scale)。\n> - **滑动**是用户快速拖动并抬起手指时发生的一种滚动。在用户抬起手指后，您通常需要继续滚动（移动视口），但要减速，直到视口停止移动为止。滑动可以通过替换 `GestureDetector.OnGestureListener` 中的 `onFling()` 以及使用滚动条对象来实现。\n> - 系统会在用户拖动手指以平移内容时调用 `onScroll()`，系统仅在手指还在屏幕上时才会调用 `onScroll()`；当手指从屏幕上抬起时，手势便会结束，或开始执行滑动手势（如果手指在抬起之前正在以一定的速度移动）。\n\n\n\n接下来我们详细了解触摸手势中各个item的用法；\n\n\n\n## 触摸事件类逐个了解\n\n我们先对涉及的元素类进行单独学习，由于普通的事件监听器比较简单，所以主要关注触摸手势部分，这块先从GestureDetector开始；\n\n### GestureDetector 详解\n\n能够识别的手势，是 `GestureDetector.OnGestureListener`及 ，`GestureDetector.SimpleOnGestureListener` ,其中 包括如下几种：\n\n| 回调方法                                                    | 对应事件触发时机及说明                       |\n| ----------------------------------------------------------- | -------------------------------------------- |\n| `onDown(downEvent):Boolean`                                 | 点按按下手指时 event为down事件时触发.        |\n| `onFling(downEvent,upEvent,velocityX,velocityY):Boolean`    | 滑动(投掷)事件发生时触发                     |\n| `onLongPress(downEvent)`                                    | 发生长按事件时触发                           |\n| `onScroll(downEvent,moveEvent,distanceX,distanceY):Boolean` | 拖动事件发生时                               |\n| `onShowPress(downEvent)`                                    | 按在屏幕上但是没有移动或抬起手指             |\n| `onSingleTapUp(upEvent):Boolean`                            | 点按抬起手指时触发                           |\n| `GestureDetector.SimpleOnGestureListener`                   |                                              |\n| `onContextClick(event)`                                     | 上下文菜单点击事件发生时                     |\n| `onDoubleTap(event)`                                        | 双击事件                                     |\n| `onDoubleTapEvent(event)`                                   | 双击事件过程中的事件，包括down，move，up事件 |\n| `onSingleTapConfirmed(event)`                               | 单次点击发生时                               |\n\n#### **问题：**\n\n以下通过**阅读API文档并编写简单的示例代码**，通过**操作触发对应的手势来观察**以确定以下问题的答案。\n\n1. GestureDetector 各个事件发生的关系，有无交叉？\n   * 按下-释放可能的事件序列：\n     * onDown - onSingleTapUp： 按下，迅速抬起（干净利落的）\n     * onDown - onShowPress - onSingleTapUp：按下，缓慢抬起\n     * onDown - onShowPress - onLongPress：按下，稍有延迟的抬起\n   * onScroll触发的可能事件序列：\n     * longPress 被触发之后，无法再触发onScroll\n     * onDown - onScroll\n     * onDown - onShowPress - onScroll\n   * onFling的触发序列\n     * 触发onScroll - 多个 onScroll - onFling\n2. GestureDetector.SimpleOnGestureDetector\n   * 单次点击事件序列：\n     * onDown - onSingleTapUp - onSingleTapConfirmed\n     * onDown - onShowPress - onSingleTapUp - onSingleTapConfirmed （按下后稍有停顿）\n   * 双击可能的事件序列：\n     * onDown - onShowPress - onSingleTapUp - onDoubleTap_down - onDoubleTapEvent_down - **onDown** - onShowPress - onDoubleTapEvent_up\n3. 滑动onFling和拖动onScroll的区别时机？\n   * onScroll一定先发生，如果抬起时有一定速度，就会触发onFling\n4. `onSingleTapUp(upEvent)` 及 `onSingleTapConfirmed(event)`的区别？\n   - onSingleTapConfirmed 只会在确认当前tap之后不会有另外一次tap构成double-tap手势的情况下才会被触发，也就是说onSingleTapUp实际上有可能时doubleTap的一次事件，如果确定只能又明确的单次点击事件触发，就需要区分\n5. onDoubleTab 和 onDoubleTapEvent 之前的区别？\n   - onDoubleTab 只包含down事件，而onDoubleTapEvent则还包含其他事件（move，up）\n\n\n\n\n\n\n\n\n\n#### Scroller 详解\n\nscroller 本身并不与View关联，仅用于做辅助的动画计算，使用起来有以下步骤：\n\n1. 初始化\n2. 通过`startScroll`或`fling`方法设定计算模型及计算所需要的参数\n3. 定期调用 `computeScrollOffset` 进行运算，然后取出运算后的值\n4. 使用运算后的值动态的改变View的属性实现滚动效果\n\n##### 计算模型：\n\n| 模型/方法       | 参数      | 含义                                                         |\n| --------------- | --------- | ------------------------------------------------------------ |\n| **startScroll** | startX    | 起始水平滚动偏移量（以像素为单位），正数会将内容向左滚动。   |\n|                 | startY    | 开始的垂直滚动偏移量（以像素为单位）。 正数将使内容向上滚动。 |\n|                 | dx        | 滑动的水平距离。 正数会将内容向左滚动。                      |\n|                 | dy        | 垂直滑动距离。 正数将使内容向上滚动。                        |\n|                 | duration  | 滚动持续时间（以毫秒为单位）                                 |\n| **fling**       | startX    | 滚动的起点（X）                                              |\n|                 | startY    | 滚动的起点（Y）                                              |\n|                 | velocityX | 滚动的初始速度（X方向），以像素/秒为单位。                   |\n|                 | velocityY | 滚动的初始速度（Y方向），以像素/秒为单位。                   |\n|                 | minX      | 最小X值。 滚动条将不会滚动到该点。                           |\n|                 | maxX      | 最大X值。 滚动条将不会滚动到该点。                           |\n|                 | minY      | 最小Y值。 滚动条将不会滚动到该点。                           |\n|                 | maxY      | 最大Y值。 滚动条将不会滚动到该点。                           |\n\n##### 计算结果值\n\n| 方法/值  | 说明                            |\n| -------- | ------------------------------- |\n| getCurrX | 新的X偏移量是距原点的绝对距离。 |\n| getCurrY | 新的Y偏移量是距原点的绝对距离。 |\n|          |                                 |\n\n### `ScaleGestureDetector` 详解\n\n使用提供的 MotionEvent 事件序列来检测缩放手势，当检测到对应的缩放事件时，会通过 OnScaleGestureListener 来通知用户；\n\n使用流程：\n\n* 为 View 创建 ScaleGestureDetector 实例；\n* 在 View.onTouchEvent(MotionEvent) 方法中调用 ScaleGestureDetector 实例的 onTouchEvent 方法；\n\n#### 基本用法\n\n* ##### **构造函数**\n\n| 仓库                 | 含义/作用                      |\n| -------------------- | ------------------------------ |\n| context              | 上下文                         |\n| ScaleGestureListener | 缩放监听                       |\n| Handler（可选）      | 用于运行延迟侦听事件的处理程序 |\n\n* ##### **方法及属性** \n\n| 属性/方法             | 含义说明                                                     | 备注                                            |\n| --------------------- | ------------------------------------------------------------ | ----------------------------------------------- |\n| getCurrent**Span**    | 两个手指之间的通过手势焦点的平均距离                         | （何为平均距离？）                              |\n| getCurrent**Span**X   | 形成手势的过程中两个手指之间通过手势焦点的X方向的平均距离    | 两个手指的滑动X距离相加取平均                   |\n| getCurrent**Span**Y   | 形成手势的过程中两个手指之间通过手势焦点的Y方向的平均距离    | 两个手指的滑动Y距离相加取平均                   |\n| getEventTime          | 返回正在处理的当前事件的事件时间                             |                                                 |\n| get**Focus**X         | 当前手势焦点（gesture's focal point）的X坐标                 | 手势焦点=两个手势点的中点；双击触发时则是触摸点 |\n| get**Focus**Y         | 当前手势焦点（gesture's focal point）的Y坐标                 | 两个手势点的中点                                |\n| getPrevious**Span**   | 之前的 两个手指之间的通过**手势焦点**的平均距离              | 上次回调（scaleBegin/scale）的span参数          |\n| getPrevious**Span**X  | 之前的 形成手势的过程中两个手指之间通过手势焦点的X方向的平均距离 |                                                 |\n| getPrevious**Span**Y  | 之前的 形成手势的过程中两个手指之间通过手势焦点的Y方向的平均距离 |                                                 |\n| getScaleFactor        | 从之前的缩放事件到当前缩放事件的 缩放比例                    | 两次回调之间的缩放比例                          |\n| getTimeDelta          | 上一个被接受的缩放事件到当前缩放事件之前的时间差             | 两次回调之间的                                  |\n| isInProgress          | 缩放手势是否正在进行中                                       | ScaleBegin 中为false，另外两个为true            |\n| isQuickScaleEnabled   | 是否启用了快速缩放-用户通过双击+一个Swipe操作来触发缩放      |                                                 |\n| isStylusScaleEnabled  | 返回用户使用触笔并按下按钮的触笔缩放手势是否应该执行缩放。   |                                                 |\n| setQuickScaleEnabled  | 当用户执行双击+Swipe动作时是否触发缩放监听                   |                                                 |\n| setStylusScaleEnabled | 当用户执行触笔缩放动作时是否触发缩放监听                     |                                                 |\n| onTouchEvent          | 接受MotionEvents并在适当的时机分发事件到 OnScaleGestureListener |                                                 |\n\n* **如何使用？**\n\n  1. 构造侦听器对象；\n  2. 在 onTouchEvent 回调中调用侦听器对象的 onTouchEvent方法并传入MotionEvent；\n\n  ```kotlin\n  var mScaleGestureDetector = ScaleGestureDetector(this,this)\n  \n  override fun onTouchEvent(event: MotionEvent?): Boolean {\n          return mScaleGestureDetector.onTouchEvent(event) || super.onTouchEvent(event)\n  }\n  ```\n\n#### 深入探究\n\n1. 如何触发手势？\n   - 两个手指张开闭合就可以\n2. 如何消费手势？\n3. 如何利用手势的参数实现缩放的动画/动作？\n\n##### 如何消费手势？ \n\n| **事件类型**     | **CurrentSpan** | **currentSpanX** | **currentSpanY** | **EventTime** | **FocusX** | **FocusY** | **Previouspan** | **PreviouspanX** | **PreviouspanY** | **ScaleFactor** | **TimeDelta** | **isInProgress** | **isQuickScaleEnabled** | **isStylusScaleEnabled** |\n| ---------------- | --------------- | ---------------- | ---------------- | ------------- | ---------- | ---------- | --------------- | ---------------- | ---------------- | --------------- | ------------- | ---------------- | ----------------------- | ------------------------ |\n| **onScaleBegin** | 448.18158       | 338.30157        | 293.9707         | 120680064     | 405.82724  | 765.9927   | 448.18158       | 338.30157        | 293.9707         | 1.0             | 0             | FALSE            | TRUE                    | TRUE                     |\n| **onScale**      | 448.18158       | 338.30157        | 293.9707         | 120680064     | 405.82724  | 765.9927   | 448.18158       | 338.30157        | 293.9707         | 1.0             | 0             | TRUE             | TRUE                    | true                     |\n| **onScale**      | 473.83823       | 355.72217        | 313.0246         | 120680081     | 408.95367  | 770.60486  | 448.18158       | 338.30157        | 293.9707         | 1.0572461       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 492.1729        | 367.65485        | 327.20648        | 120680098     | 410.2758   | 772.77576  | 473.83823       | 355.72217        | 313.0246         | 1.038694        | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 509.8993        | 380.36285        | 339.59003        | 120680114     | 411.72714  | 775.3407   | 492.1729        | 367.65485        | 327.20648        | 1.0360166       | 16            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 526.8072        | 391.90063        | 352.05072        | 120680131     | 413.6501   | 777.7251   | 509.8993        | 380.36285        | 339.59003        | 1.0331593       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 541.9916        | 402.3568         | 363.13068        | 120680147     | 415.72614  | 780.33923  | 526.8072        | 391.90063        | 352.05072        | 1.0288234       | 16            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 552.3365        | 408.6225         | 371.62244        | 120680164     | 418.1556   | 782.6556   | 541.9916        | 402.3568         | 363.13068        | 1.0190868       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 560.9881        | 413.25342        | 379.38013        | 120680181     | 418.5      | 783.56335  | 552.3365        | 408.6225         | 371.62244        | 1.0156636       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 567.2112        | 417.16174        | 384.32355        | 120680197     | 419.58087  | 785.08093  | 560.9881        | 413.25342        | 379.38013        | 1.011093        | 16            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 575.6995        | 423.24652        | 390.24646        | 120680214     | 420.5411   | 786.0411   | 567.2112        | 417.16174        | 384.32355        | 1.014965        | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 584.7019        | 428.15033        | 398.2005         | 120680230     | 422.02505  | 788.0502   | 575.6995        | 423.24652        | 390.24646        | 1.0156373       | 16            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 592.25555       | 432.04736        | 405.09473        | 120680247     | 423.02368  | 789.5237   | 584.7019        | 428.15033        | 398.2005         | 1.0129188       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 601.86597       | 436.95844        | 413.89606        | 120680263     | 424.47922  | 791.9689   | 592.25555       | 432.04736        | 405.09473        | 1.0162268       | 16            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 611.9895        | 442.71814        | 422.5302         | 120680280     | 425.453    | 793.453    | 601.86597       | 436.95844        | 413.89606        | 1.0168202       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 621.78754       | 447.69666        | 431.49445        | 120680297     | 426.94946  | 794.94946  | 611.9895        | 442.71814        | 422.5302         | 1.0160102       | 17            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 629.77124       | 451.88318        | 438.64954        | 120680313     | 427.9416   | 795.4416   | 621.78754       | 447.69666        | 431.49445        | 1.0128399       | 16            | TRUE             | TRUE                    | true                     |\n| **onScale**      | 636.78015       | 454.8739         | 445.6217         | 120680330     | 428.43695  | 795.93695  | 629.77124       | 451.88318        | 438.64954        | 1.0111293       | 17            | TRUE             | TRUE                    | true                     |\n| **onScaleEnd**   | 644.16754       | 458.65613        | 452.31226        | 120680346     | 428.5      | 795.5      | 636.78015       | 454.8739         | 445.6217         | 1.0             | 16            | TRUE             | TRUE                    | true                     |\n\n以下是测试过程中的detector的属性变化数据，可以发现如下规律：\n\n1.  **onScaleBegin** 时 inProgress为false\n\n2. currentSpan<sup>^2</sup> = currentSpanX<sup>^2</sup> * currentSpanY<sup>^2</sup> ，即currentSpan为两个手指总共移动的距离，如下图所示：\n\n* 手指1移动的轨迹为蓝色矩形中的对角线，手指2移动的轨迹为红色矩形的对角线\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224223801.png\" alt=\"image-20210224223801886\" style=\"zoom:50%;\" />\n\n* currentSpan 就是两个手指移动的对角线相加，currentSpanX和currentSpanY分别为蓝色矩形和红色矩形按如下方式拼接成一个大的矩形之后的两条边；\n\n<img src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210224223831.png\" alt=\"image-20210224223831274\" style=\"zoom:50%;\" />\n\n3. 每次事件的previouSpan的值都等于上次事件的currentSpan的值；\n4. FocusX和FocusY即为事件回调触发时两个手指连线的中点坐标，随着手指的不断移动，焦点也是不断的变化的；\n5. 大部分timeDelta都在16-17ms左右，所以不应在回调方法中执行耗时事件，对应逻辑应放置到Runnable中去执行；\n6. scaleBegin和第一次onScale回调的各项值都一致，除了scaleBegin的isInProgress为`FALSE`；\n7. 缩放比例（scaleFactor）为1.0时，没有缩放；\n\n##### 如何利用手势的参数实现缩放的动画/动作？\n\n假设我现在需要在检测到缩放手势时同步的对ImageView执行缩放动作，此时应该怎么做？\n\n* 如何对ImageView的图片进行缩放？\n  * 根据缩放比例不断的重新设置View的scaleX及scaleY的值；\n* 每次事件触发都进行缩放操作？还是积累一定程度之后进行？\n  * 由于每次变化的时间非常短，所以我们应该在每次onScale方法触发时执行变换；\n\n## 如何让View根据手势效果进行变换？\n\n通过之前对手势侦听器，缩放手势侦听器及滚动条类的学习及分析，我们知道了各个类的基本用途：\n\n* GeostureDetector： 辅助侦听判断down，tag，doubletap，scroll，fling等手势并在检测到手势后回调对应的方法，给出事件相关的参数数据；\n* ScaleGeostureDetector： 辅助侦听判断缩放手势，并在缩放手势发生时通过回调对应方法来通知我们对应事件的发生，并给出事件相关的参数数据；\n* Scroller： 用于辅助计算生成滚动过程中的一系列值的序列；\n\n可以方向，上述类只是告诉你事件发生了，还有告诉你事件的相关参数，如滚动事件的滚动距离，fling事件的滑动速度，等等，但是都没有涉及到如何变换将这些事件反映到界面的变化上，那么我们如何将上述的事件变化反映到界面上呢？\n\n### View基础属性\n\n部分变化效果都是针对View/ViewGroup来说的，要想改变View，就得改变其属性，如：\n\n* 滑动时改变TransitionX，TransitionY\n* 缩放时改变View的scaleX/scaleY\n\n我们需要研究View中有哪些属性，属性如何影响View的展示效果，以下通过API文档的setXXX属性列出View的部分属性：\n\n| 属性                                                    | 说明                                                         |\n| ------------------------------------------------------- | ------------------------------------------------------------ |\n| **alpha**                                               | 透明度                                                       |\n| background/backgroundColor                              | 背景                                                         |\n| **bottom<br/>left<br/>right<br/>top**<br/>**elevation** | 视图相对于parent的位置<br/>elevation为view的深度             |\n| clipBounds                                              | 矩形裁剪区域，view的内容会在该区域绘制                       |\n| clipToOutline:Boolean                                   |                                                              |\n| fadingEdgeLength                                        | 用于指示此视图中更多内容可用的褪色边缘的大小                 |\n| foreground                                              | 前景drawable                                                 |\n| layoutParams                                            | 布局参数                                                     |\n| minHeight<br/>minWidth                                  | 最小宽高                                                     |\n| padding                                                 | 内边距                                                       |\n| relativePadding                                         | 减去可能的滚动条尺寸                                         |\n| **pivotX<br/>pivotY**                                   | view 旋转缩放所围绕的点。默认为view中点坐标                  |\n| **rotation**                                            | 绕pivot点的旋转角度                                          |\n| **rotationX<br/>rotationY**                             | 绕通过pivot点的水平线/垂直线的旋转角度                       |\n| **scaleX<br/>scaleY**                                   | X/Y方向上绕pivot点的缩放比例，1.0表示无缩放                  |\n| **scrollX<br/>scrollY**                                 | 水平/垂直滚动位置的position                                  |\n| **translationX<br/>translationY<br/>translationZ**      | 相对于视图左边位置的水平/垂直/深度位置，可以改变布局         |\n| **x/y/z**                                               | x: x位置； 等效translationX=x-left<br/>y: y位置； 等效translationY=y-top<br/>z: z位置； 等效translationZ=z-elevation |\n\n与视图变化相关的最基本的就是加粗部分的属性，总结起来就是位置，大小，透明度，旋转，缩放，平移。其他具体的子View则可能引入自己的属性；\n\n### 那么旋转/平移/缩放究竟改变的是啥？\n\n* 滚动及平移（scroll/fling）：改变x和y（亦可以通过translationX/Y，最终都是改变了x和y）\n* 缩放： 改变scaleX/scaleY/pivotX/pivotY\n\n\n\n### Matrix解析\n\n用途： matrix存储一个3x3的矩阵，用于对坐标进行变换；\n$$\n\\begin{bmatrix}\n  MSCALE\\_X & MSKEW\\_X & MTRANS\\_X \\\\\n  MSKEW\\_Y & MSCALE\\_Y & MTRANS\\_Y \\\\\n  MPERSP\\_0 & MPERSP\\_1 & MPERSP\\_2 \\\\\n\\end{bmatrix}\n$$\n矩阵各个元素的用途：\n\n| 字段                                 | 用途                                         |\n| ------------------------------------ | -------------------------------------------- |\n| `MSCALE_X`，`MSCALE_Y`               | 控制X轴和Y轴方向的缩放                       |\n| `MSKEW_X`，`MSKEW_Y`                 | 控制X坐标和Y坐标的扭曲系数(旋转)             |\n| `MTRANS_X`，`MTRANS_Y`               | 控制X方向和Y方向的线性平移                   |\n| `MPERSP_0` , `MPERSP_1` , `MPERSP_2` | MPERSP_0、MPERSP_1和MPERSP_2是关于透视的控制 |\n\nMatrix提供一系列的辅助变换函数，每种类型有 `pre`,`post`,`set`三种操作方式，矩阵的乘法运算顺序不一致结果不同，pre表示前（preconcats），post表示后（postconcats），set为直接设置；\n\n`postScale`方法来对坐标后接触缩放变换，有两种变体：\n\n| 方法                                                 | 说明                                                         |\n| ---------------------------------------------------- | ------------------------------------------------------------ |\n| `postScale (float sx, float sy, float px, float py)` | 使用指定的scale执行矩阵postconcats：`M' = S(sx, sy, px, py) * M` <br/>其中sx，sy分别为x轴和y轴的缩放大小，px，py为缩放中心点的坐标 |\n| `boolean postScale (float sx, float sy)`             | 使用指定的scale执行矩阵postconcats： `M' = S(sx, sy) * M`    |\n\n#### post和set及pre的区别\n\n##### scale\n\n|           | currentScale                                                 |\n| --------- | ------------------------------------------------------------ |\n| preScale  | 和postScale对值产生一样的效果，但是如果有其他变换一起使用，他会先于set被应用 |\n| setScale  | 直接覆盖，如果matrix中原先有scale的值，那么原先的值会被覆盖  |\n| postScale | 只需要设置增量即可，如原先的scale为0.5425669，postScale(1.3947428)后scale的值为 $$0.5425669*1.3947428 = 0.7567413$$ |\n\n\n\n### Matrix如何与ImageView结合\n\n那么我们如何才能将Matrix同ImageView或者Canvas或者Bitmap结合起来呢？\n\n查找Canvas的相关方法，可以看到setMatrix方法，\n\n> ```\n> public void setMatrix (Matrix matrix)\n> ```\n>\n> Completely replace the current matrix with the specified matrix. If the matrix parameter is null, then the current matrix is reset to identity. **Note:** it is recommended to use `concat(android.graphics.Matrix)`, `scale(float, float)`, `translate(float, float)` and `rotate(float)` instead of this method.\n\n同时下面温馨提示，让我们使用其他方法，其中涉及到矩阵的就有contact，所以我们研究下contact方法：\n\ncontact方法接受一个Matrix对象，可以将参数中的矩阵预连接到canvas本身的矩阵上（Preconcat the current matrix with the specified matrix.）；假设当前矩阵为C，要连接的矩阵为S，这里的预连接（preconcat）指的是：`C = S x C`\n\n## 单一效果实现\n\n### 拖动效果实现\n\n1. 初始化`GestureDetector`\n\n   ```kotlin\n   private lateinit var mDetector: GestureDetector\n   \n   override fun onCreate(savedInstanceState: Bundle?) {\n           super.onCreate(savedInstanceState)\n           mDetector = GestureDetector(this, simpleDetectorListener)\n   }\n   ```\n\n2. 使用 `GestureDetector` 侦听 `onScroll` 手势\n\n   ```kotlin\n   override fun dispatchTouchEvent(ev: MotionEvent?): Boolean {\n   \treturn mDetector.onTouchEvent(ev)\n   }\n   ```\n\n3. `GestureDetector` 的 `onScroll` 回调方法中处理滚动事件\n\n   ```kotlin\n   override fun onScroll(e1: MotionEvent?, e2: MotionEvent?, distanceX: Float, distanceY: Float): Boolean {\n       // 改变ImageView 的x和y\n       imageView.x -= distanceX\n       imageView.y -= distanceY\n       return true\n   }\n   ```\n\n### Fling-投掷效果实现\n\n1. 初始化`GestureDetector`及 `Scroller`\n\n   ```kotlin\n   private lateinit var mDetector: GestureDetector\n   private lateinit var mScroller: Scroller\n   override fun onCreate(savedInstanceState: Bundle?) {\n           super.onCreate(savedInstanceState)\n           mDetector = GestureDetector(this, simpleDetectorListener)\n       \tmScroller = Scroller(this)\n   }\n   ```\n\n2. 在onTouchEvent或dispatchTouchEvent中使用`GestureDetector` 侦听 `onFling` 手势\n\n   ```kotlin\n   override fun dispatchTouchEvent(ev: MotionEvent?): Boolean {\n           return mDetector.onTouchEvent(ev)\n   }\n   ```\n\n3. onFling回调中使用`Scroller `完成滚动辅助计算并从Scroller中获取参数来更新视图的x,y相关属性\n\n   ```kotlin\n   override fun onFling(e1: MotionEvent?, e2: MotionEvent?, velocityX: Float, velocityY: Float): Boolean {\n           return handleFling(e1, e2, velocityX, velocityY)\n   }\n   \n   private fun handleFling(down: MotionEvent?, move: MotionEvent?, velocityX: Float, velocityY: Float): Boolean {\n           // 停止\n           mScroller.forceFinished(true)\n           val minX: Int = (imageView.pivotX * (1 - imageView.scaleX)).roundToInt()\n           val minY: Int = (imageView.pivotY * (1 - imageView.scaleY)).roundToInt()\n           val maxX: Int = ((imageView.width - imageView.pivotX) * (imageView.scaleX - 1)).roundToInt()\n           val maxY: Int = ((imageView.height - imageView.pivotY) * (imageView.scaleY - 1)).roundToInt()\n           mScroller.fling(imageView.x.toInt(), imageView.y.toInt(), velocityX.toInt(), velocityY.toInt(),\n                   minX, maxX, minY, maxY)\n           // Invalidate to request a redraw\n           isFling = true\n           postFling()\n           return true\n   }\n   \n   private fun postFling() {\n       imageView.postDelayed(flingRunnable, 16L)\n   }\n   \n   private val flingRunnable = Runnable {\n           if (!mScroller.isFinished ) {\n               // 计算滚动后的参数\n               mScroller.computeScrollOffset()\n               // 从滚动器中获取计算出的值并更新图片的x,y属性\n               imageView.x = mScroller.currX.toFloat()\n               imageView.y = mScroller.currY.toFloat()\n               // 定期刷新\n               postFling()\n           }\n   }\n   ```\n\n**View缩放后fling边界计算**\n\n![image-20210228180521446](https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210228180522.png)\n\n**说明：**\n\n1. 缩放前宽：width\n\n2. 缩放前高：height\n\n3. 缩放比例：scale\n\n4. 缩放焦点坐标：focusX，focusY\n\n5. minX = - focusX * （scale-1）\n\n6. minY = - focusY * （scale-1）\n\n7. maxX = （width-focusX）*（scale-1）\n\n8. maxY = （height-focusY）*（scale-1）\n\n### ScaleGestureDetector 实现双指缩放效果\n\n1. 初始化 `ScaleGestureDetector` ；\n\n   ```\n       private lateinit var mScaleDetector: ScaleGestureDetector\n       private val scaleDetectorListener: ScaleGestureDetector.OnScaleGestureListener = object : ScaleGestureDetector.OnScaleGestureListener {\n   \n           override fun onScaleBegin(detector: ScaleGestureDetector?): Boolean {\n               isScaling = true\n               scaleStartX = detector!!.focusX\n               scaleStartY = detector.focusY\n               return true\n           }\n   \n           override fun onScale(detector: ScaleGestureDetector?): Boolean {\n               Timber.tag(\"GestureDetector\").d(\"handleScale onScale\")\n               detector?.run {\n                   handleScale(detector)\n               }\n               return true\n           }\n   \n   \n           override fun onScaleEnd(detector: ScaleGestureDetector?) {\n               Timber.tag(\"GestureDetector\").d(\"handleScale onScaleEnd\")\n               isScaling = false\n           }\n       }\n   ```\n\n   \n\n2. 事件分发时调用 `ScaleGestureDetector` 的 onTouchEvent 方法传递事件序列；\n\n3. 在scale事件回调方法中处理scale事件-根据事件参数更新View的缩放（scaleX，scaleY）属性完成视图更新；\n\n## 参考文章 \n\n### matrix参考\n\n* [Android matrix.postScale的用法](https://blog.csdn.net/maxchenfuhai/article/details/51690857)\n* [Android Matrix](https://www.jianshu.com/p/a08e589ce5d4)\n* [Matrix学习1、基础的知识](https://www.cnblogs.com/li-print/p/3318805.html)\n* [MathJax基本的使用方式](https://blog.csdn.net/u010945683/article/details/46757757)\n* [Typora Math Block](https://support.typora.io/Markdown-Reference/#math-blocks)\n* [What does it mean to “preconcat” a matrix in Android?](https://stackoverflow.com/questions/2695537/what-does-it-mean-to-preconcat-a-matrix-in-android)\n* [Android Matrix的pre、post理解](https://www.jianshu.com/p/7ca1d675a7c8)\n\n### android手势\n\n* [手势类型- Material.io](https://material.io/design/interaction/gestures.html#types-of-gestures)\n\n\n",
      "data": {
        "title": "Android事件及手势",
        "date": "2018-02-20 10:13:24",
        "tags": [
          "Android"
        ],
        "published": true,
        "hideInList": false,
        "feature": null,
        "isTop": false
      },
      "isEmpty": false,
      "excerpt": "",
      "abstract": "android事件基础及手势，主要关注各种手势的使用及其计算原理 。  ",
      "fileName": "android-shi-jian-ji-shou-shi"
    }
  ],
  "tags": [
    {
      "name": "WebView",
      "slug": "6XxcIf5h1",
      "used": true
    },
    {
      "name": "Vue",
      "slug": "-DsjqfHTsD",
      "used": true
    },
    {
      "name": "Gradle",
      "slug": "A1ylY5G8e",
      "used": true
    },
    {
      "name": "Docker",
      "slug": "NMptrGpeB",
      "used": true
    },
    {
      "index": -1,
      "name": "工作",
      "slug": "BRSqI8ENH",
      "used": true
    },
    {
      "name": "Gitlab",
      "slug": "uWWSWaUAr",
      "used": true
    },
    {
      "name": "Android",
      "slug": "50sRf4lAz",
      "used": true
    },
    {
      "name": "源码分析",
      "slug": "WWHfwvAsi_",
      "used": true
    },
    {
      "name": "工具",
      "slug": "d4ukbE27b",
      "used": true
    },
    {
      "name": "Gridea",
      "slug": "iJMEiKV_v",
      "used": true
    },
    {
      "index": 5,
      "name": "设计",
      "slug": "design",
      "used": false
    },
    {
      "index": -1,
      "name": "Sketch",
      "slug": "Sketch",
      "used": false
    },
    {
      "index": -1,
      "name": "日常",
      "slug": "SwVYtT_78",
      "used": false
    }
  ],
  "menus": [
    {
      "link": "/",
      "name": "首页",
      "openType": "Internal"
    },
    {
      "link": "/archives",
      "name": "归档",
      "openType": "Internal"
    },
    {
      "link": "/tags",
      "name": "标签",
      "openType": "Internal"
    },
    {
      "link": "/post/about",
      "name": "关于",
      "openType": "Internal"
    }
  ]
}