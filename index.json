[{"content":"å‰è¨€ æœ€è¿‘å…¥æ‰‹äº† MT3000ï¼Œä½¿ç”¨è¿‡åå‘ç°æ˜¯å½“å‰æœ€çœå¿ƒçš„ğŸ§™â€â™€ï¸è·¯ç”±å™¨äº†ï¼›æ•…æ­¤è®°å½•ä¸‹ç›¸å…³çš„é…ç½®è¿‡ç¨‹ï¼›\nä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š\nåŸºç¡€é…ç½®éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ”¹åŒºï¼Œä¸­ç»§ä¸Šç½‘é…ç½®ç­‰æ“ä½œï¼› ğŸ§™â€â™€ï¸ä¸Šç½‘é…ç½®éƒ¨åˆ†ï¼› åŸºç¡€é…ç½® ç³»ç»Ÿå‡çº§ åˆ°æ‰‹åå†…ç½®ç³»ç»Ÿæ˜¯ 4.7.13 ç‰ˆæœ¬ï¼Œå¯å…ˆå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ 4.8.1 ï¼š\nå‡çº§ç³»ç»Ÿåï¼š\næ¢åŒº å›½å†…ä¹°çš„é»˜è®¤æ˜¯å›½åŒºï¼Œéƒ¨åˆ†åŠŸèƒ½ç”¨ä¸äº†ï¼Œæ‰€ä»¥éœ€è¦æ¢åŒºæˆUSï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ¢åŒºå¤„ç†ï¼š\nå…ˆé€šè¿‡å‘½ä»¤æŸ¥çœ‹ /dev/mtdblock3 ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ CN çš„å­—ç¬¦ï¼š\nroot@GL-MT3000:~# cat /dev/mtdblock3 â–¡yâ–¡â–¡â–¡z â–¡â–¡â–¡â–¡z â–¡zra209c0fe807b2d847b4cfe306bf2c496d32a8MCZQDR99YWfirsttestsecondtestGL-250725902794â–¡CN[HL(â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ â–¡\u0026#34;\u0026#34;\u0026#34;\u0026#34;3333333333333333333333333333%%))%%%%%%%%%%%%%%%((((($$$$\u0026#34;\u0026#34;\u0026#34;\u0026#34;$$$$\u0026#34;\u0026#34;\u0026#34;\u0026#34;$$$$\u0026#34;\u0026#34;\u0026#34;\u0026#34;$$$$\u0026#34;\u0026#34;\u0026#34;\u0026#34;â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ â–¡â–¡7777777777777777777777777777\u0026#34;â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡Å‡IRVUUUUJRQQQQQJSUVVVVIPNQQQQIQPTTTTIPQQQQQIRQPPPPIRQQQQQIRQTTTTIQPTTTTISRQQQQISSRRRRIQPPPPPIQRTTTTIRQSSSSâ–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡Ã‚â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡Äâ–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡@â–¡â–¡â–¡â–¡â–¡â–¡â–¡@â–¡@â–¡@â–¡â–¡â–¡@â–¡â–¡â–¡â–¡â–¡â–¡â–¡@â–¡@â–¡â–¡â–¡â–¡â–¡â–¡â–¡@â–¡@â–¡â–¡â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡@â–¡root@GL-MT3000:~# æ›¿æ¢åŒºåŸŸå­—æ®µï¼š\necho \u0026#34;US\u0026#34; | dd of=/dev/mtdblock3 bs=1 seek=136 sync è¾“å…¥å¦‚ä¸‹ï¼š root@GL-MT3000:~# echo \u0026#34;US\u0026#34; | dd of=/dev/mtdblock3 bs=1 seek=136 3+0 records in 3+0 records out root@GL-MT3000:~# sync é‡å¯åå°±ä¸æ˜¯CN äº†ã€‚\næ”¹è¯­è¨€ æ¢åŒºä¹‹åï¼Œæ”¹æˆè‹±æ–‡å°±å¯ä»¥å‡ºç°ADGuardHome æ’ä»¶äº†ï¼Œä½†æ˜¯åˆ‡æ¢æˆå°±åˆæ²¡æœ‰äº†ã€‚\næ‰€ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å°†ç¹ä½“ä¸­æ–‡çš„è¯­è¨€æ”¹æˆç®€ä½“ä¸­æ–‡çš„ï¼Œç„¶åå†å°†è¯­è¨€æ›¿æ¢æˆç¹ä½“ä¸­æ–‡å°±å¯ä»¥äº†ï¼›\ncd /www/i18n \u0026amp;\u0026amp; \\ for f in *zh-tw*; do mv \u0026#34;$f\u0026#34; \u0026#34;${f//zh-tw/zh-bak}\u0026#34;; done \u0026amp;\u0026amp; \\ for f in *zh-cn*; do cp \u0026#34;$f\u0026#34; \u0026#34;${f//zh-cn/zh-tw}\u0026#34;; done ç½‘ç»œé…ç½® ç½‘ç»œé…ç½®åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š\nå¸¦ Scramble çš„æ’ä»¶å®‰è£… è¿æ¥æœ«æ³•ç½‘ç»œ é…ç½®ç­–ç•¥è§„åˆ™ Scramble æ’ä»¶å®‰è£… è‡ªå¸¦çš„open è™šæ‹Ÿä¸“ç”¨ç½‘ç»œæ’ä»¶æ˜¯ä¸å¸¦ Scramble çš„ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…æˆå¸¦ Scrameble çš„ç‰ˆæœ¬ï¼Œå¯é€šè¿‡ LuCI è½¯ä»¶åŒ…ç®¡ç†ç•Œé¢è¿›è¡Œè¦†ç›–å®‰è£…å³å¯ï¼›\næ³¨æ„ï¼šæ­¤ç‰ˆæœ¬éœ€è¦è‡ªè¡Œç¼–è¯‘ ipk æ’ä»¶\né€šè¿‡ ç³»ç»Ÿ-é«˜çº§è®¾ç½® å³å¯è¿›å…¥ luCI ä¸­æ‰‹åŠ¨å®‰è£… ipk è½¯ä»¶åŒ…ï¼Œå®‰è£…è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼›ç¼–è¯‘æ’ä»¶çš„è¿‡ç¨‹æ­¤å¤„ä¹Ÿç•¥å»ï¼›\nè¿æ¥é­”æ³•ç½‘ç»œ GLiNet çš„é­”æ³•ç½‘ç»œé…ç½®è¿˜æ˜¯æŒºæ–¹ä¾¿çš„ï¼Œå°†ç›¸å…³é…ç½®åŠè¯ä¹¦æ–‡ä»¶ç­‰æ‰“åŒ…æˆä¸€ä¸ª å‹ç¼©åŒ…ä¸Šä¼ å³å¯æ·»åŠ ï¼Œå…·ä½“é…ç½®è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼›\næ·»åŠ æˆåŠŸä¹‹åå°±å¯ä»¥è¿æ¥äº†ï¼›\né…ç½®ç­–ç•¥è§„åˆ™ è¿æ¥é­”æ³•ç½‘ç»œä¹‹åï¼Œéœ€è¦èƒ½æ ¹æ®å›½å†…å’Œå›½å¤–åŸŸåæ¥åŒºåˆ†èµ°çš„è·¯å¾„ï¼ŒGLiNet ä¹Ÿæœ‰ç›¸å…³é…ç½®æ”¯æŒï¼Œç›´æ¥å¯¼å…¥å¯¹åº”çš„åœ°å€åˆ—è¡¨å³å¯ï¼›\nåœ°å€æ¥æºäºï¼šchnroute/CN.rsc at master Â· ruijzhan/chnroute Â· GitHub\né€šè¿‡æ–‡æœ¬æ›¿æ¢æå–çš„æ–¹å¼ï¼Œæå–å‡ºç¬¦åˆæ ¼å¼çš„IPåˆ—è¡¨å³å¯ï¼›\n","permalink":"https://hanlyjiang.github.io/posts/glinet-mt3000%E9%85%8D%E7%BD%AE/","summary":"\u003ch1 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h1\u003e\n\u003cp\u003eæœ€è¿‘å…¥æ‰‹äº† MT3000ï¼Œä½¿ç”¨è¿‡åå‘ç°æ˜¯å½“å‰æœ€çœå¿ƒçš„ğŸ§™â€â™€ï¸è·¯ç”±å™¨äº†ï¼›æ•…æ­¤è®°å½•ä¸‹ç›¸å…³çš„é…ç½®è¿‡ç¨‹ï¼›\u003c/p\u003e\n\u003cp\u003eä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåŸºç¡€é…ç½®éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ”¹åŒºï¼Œä¸­ç»§ä¸Šç½‘é…ç½®ç­‰æ“ä½œï¼›\u003c/li\u003e\n\u003cli\u003eğŸ§™â€â™€ï¸ä¸Šç½‘é…ç½®éƒ¨åˆ†ï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"åŸºç¡€é…ç½®\"\u003eåŸºç¡€é…ç½®\u003c/h1\u003e\n\u003ch2 id=\"ç³»ç»Ÿå‡çº§\"\u003eç³»ç»Ÿå‡çº§\u003c/h2\u003e\n\u003cp\u003eåˆ°æ‰‹åå†…ç½®ç³»ç»Ÿæ˜¯ 4.7.13 ç‰ˆæœ¬ï¼Œå¯å…ˆå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ 4.8.1 ï¼š\u003c/p\u003e\n\u003cimg src=\"./pics/image-20251116104528933.png\" alt=\"image-20251116104528933\" style=\"zoom:50%;\" /\u003e\n\u003cp\u003eå‡çº§ç³»ç»Ÿåï¼š\u003c/p\u003e\n\u003cimg src=\"./pics/image-20251116103205645.png\" alt=\"image-20251116103205645\" style=\"zoom:50%;\" /\u003e\n\u003ch2 id=\"æ¢åŒº\"\u003eæ¢åŒº\u003c/h2\u003e\n\u003cp\u003eå›½å†…ä¹°çš„é»˜è®¤æ˜¯å›½åŒºï¼Œéƒ¨åˆ†åŠŸèƒ½ç”¨ä¸äº†ï¼Œæ‰€ä»¥éœ€è¦æ¢åŒºæˆUSï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ¢åŒºå¤„ç†ï¼š\u003c/p\u003e","title":"GLiNet-MT3000é…ç½®"},{"content":"æ¦‚è¿° æœ¬æ–‡ç”¨äºæ¢³ç†è¦å¦‚ä½•ä½¿ç”¨ hugo ï¼Œå¦‚åç»­ä½¿ç”¨ä¸­éœ€è¦ä½¿ç”¨å“ªäº›å‘½ä»¤ï¼Œå½“å‰å¯¹åšå®¢çš„ä¸€äº›è§„åˆ’ï¼Œä½¿ç”¨è§„åˆ™ç­‰ï¼›\næ•´ä½“å¸ƒå±€ æ”¯æŒä¸‰ä¸ªç»´åº¦ï¼š\nä¸“é¢˜ï¼ˆseriesï¼‰ï¼šç”¨äºå°†ä¸€ä¸ªä¸»é¢˜ç›¸å…³çš„å†…å®¹è¿æ¥èµ·æ¥ï¼› åˆ†ç±»ï¼ˆcategoriesï¼‰ï¼šä¸»è¦ç”¨äºåŒºåˆ†æ–‡ç« çš„ç±»åˆ«ï¼Œå½“å‰åˆ’åˆ†å¦‚ä¸‹å‡ ç§ï¼š æ—¥æ¸¸æ‰€æ€ï¼šä¸ªäººæ„Ÿæƒ³ï¼Œæ—¥è®°ç­‰ç­‰ï¼› èœ»èœ“ç‚¹æ°´ï¼šä¸»è¦æ˜¯ä¸€äº›è½»åº¦æŠ€æœ¯å†…å®¹ï¼Œå¦‚åšå®¢é…ç½®ï¼Œç½‘ç»œé…ç½®ï¼Œç©æœºé…ç½®ç­‰ï¼ŒæŠ€æœ¯ç›¸å…³çš„æƒ³æ³•ï¼Œä½†æ˜¯ä¸æ¶‰åŠå…·ä½“æŠ€æœ¯ç»†èŠ‚çš„ï¼› æ°´æ¼«é‡‘å±±ï¼šçº¯æŠ€æœ¯ç›¸å…³çš„å†…å®¹ï¼Œå¦‚æŠ€æœ¯å­¦ä¹ æ•™ç¨‹ï¼ŒæŠ€æœ¯æ€»ç»“ç­‰ï¼› æ ‡ç­¾ï¼ˆtagsï¼‰ï¼šæ ‡è¯†æ–‡ç« æ‰€æ¶‰åŠçš„ä¸€äº›å…³é”®è¯ï¼Œçƒ­ç‚¹ï¼Œå…³é”®æŠ€æœ¯ç­‰ç­‰ï¼Œå¯ä»¥å°½é‡å¤šæ·»åŠ ï¼› ä½¿ç”¨æ–‡ä»¶å¤´éƒ¨ meta å®šä¹‰çš„æ–¹å¼æ¥æ·»åŠ å¯¹åº”çš„ç»´åº¦æ ‡è®°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼š\n+++ date = \u0026#39;2025-11-01T23:15:13+08:00\u0026#39; draft = false title = \u0026#39;Title\u0026#39; categories = [\u0026#34;åå²¸è§‚æ°´\u0026#34;,\u0026#34;èœ»èœ“ç‚¹æ°´\u0026#34;,\u0026#34;æµ®æ¸¸æ°´é¢\u0026#34;,\u0026#34;æ·±å…¥æ°´åº•\u0026#34;,] tags = [\u0026#34;Hugo\u0026#34;, \u0026#34;æ•™ç¨‹\u0026#34;] series = [\u0026#34;Blogé…ç½®ç³»åˆ—\u0026#34;] +++ ","permalink":"https://hanlyjiang.github.io/posts/hugo%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F/","summary":"\u003ch2 id=\"æ¦‚è¿°\"\u003eæ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡ç”¨äºæ¢³ç†è¦å¦‚ä½•ä½¿ç”¨ hugo ï¼Œå¦‚åç»­ä½¿ç”¨ä¸­éœ€è¦ä½¿ç”¨å“ªäº›å‘½ä»¤ï¼Œå½“å‰å¯¹åšå®¢çš„ä¸€äº›è§„åˆ’ï¼Œä½¿ç”¨è§„åˆ™ç­‰ï¼›\u003c/p\u003e\n\u003ch2 id=\"æ•´ä½“å¸ƒå±€\"\u003eæ•´ä½“å¸ƒå±€\u003c/h2\u003e\n\u003cp\u003eæ”¯æŒä¸‰ä¸ªç»´åº¦ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eä¸“é¢˜ï¼ˆseriesï¼‰ï¼šç”¨äºå°†ä¸€ä¸ªä¸»é¢˜ç›¸å…³çš„å†…å®¹è¿æ¥èµ·æ¥ï¼›\u003c/li\u003e\n\u003cli\u003eåˆ†ç±»ï¼ˆcategoriesï¼‰ï¼šä¸»è¦ç”¨äºåŒºåˆ†æ–‡ç« çš„ç±»åˆ«ï¼Œå½“å‰åˆ’åˆ†å¦‚ä¸‹å‡ ç§ï¼š\n\u003col\u003e\n\u003cli\u003eæ—¥æ¸¸æ‰€æ€ï¼šä¸ªäººæ„Ÿæƒ³ï¼Œæ—¥è®°ç­‰ç­‰ï¼›\u003c/li\u003e\n\u003cli\u003eèœ»èœ“ç‚¹æ°´ï¼šä¸»è¦æ˜¯ä¸€äº›è½»åº¦æŠ€æœ¯å†…å®¹ï¼Œå¦‚åšå®¢é…ç½®ï¼Œç½‘ç»œé…ç½®ï¼Œç©æœºé…ç½®ç­‰ï¼ŒæŠ€æœ¯ç›¸å…³çš„æƒ³æ³•ï¼Œä½†æ˜¯ä¸æ¶‰åŠå…·ä½“æŠ€æœ¯ç»†èŠ‚çš„ï¼›\u003c/li\u003e\n\u003cli\u003eæ°´æ¼«é‡‘å±±ï¼šçº¯æŠ€æœ¯ç›¸å…³çš„å†…å®¹ï¼Œå¦‚æŠ€æœ¯å­¦ä¹ æ•™ç¨‹ï¼ŒæŠ€æœ¯æ€»ç»“ç­‰ï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003eæ ‡ç­¾ï¼ˆtagsï¼‰ï¼šæ ‡è¯†æ–‡ç« æ‰€æ¶‰åŠçš„ä¸€äº›å…³é”®è¯ï¼Œçƒ­ç‚¹ï¼Œå…³é”®æŠ€æœ¯ç­‰ç­‰ï¼Œå¯ä»¥å°½é‡å¤šæ·»åŠ ï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eä½¿ç”¨æ–‡ä»¶å¤´éƒ¨ meta å®šä¹‰çš„æ–¹å¼æ¥æ·»åŠ å¯¹åº”çš„ç»´åº¦æ ‡è®°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼š\u003c/p\u003e","title":"Hugoä½¿ç”¨è§„åˆ™"},{"content":"å®‰è£… æ­¤éƒ¨åˆ†çœç•¥ï¼Œå¯ç›´æ¥ä½¿ç”¨ AI æä¾›ï¼›\né…ç½®ä¸­æ–‡ åŸºç¡€é…ç½® # é…ç½®è¯­è¨€ languageCode: zh-cn defaultContentLanguage: zh-cn # æ‰€æœ‰è¯­è¨€éƒ½æ”¾å…¥ç‹¬ç«‹å­ç›®å½• false defaultContentLanguageInSubdir: false æ³¨æ„: è¿™é‡Œçš„è¯­è¨€æ˜¯ zh-cnï¼Œä½†æ˜¯ PaperMod ä¸»é¢˜çš„å¤šè¯­è¨€é…ç½®ä¸­å¯¹åº”çš„æ˜¯ zh.yaml æ–‡ä»¶\nå¤šè¯­è¨€ç¿»è¯‘æ–‡ä»¶ ç»è¿‡åŸºç¡€é…ç½®ï¼Œéƒ¨åˆ†ç•Œé¢å·²ç»æ˜¯ä¸­æ–‡äº†ï¼Œä½†æ˜¯åƒé˜…è¯»æ—¶é—´è¿™ç§è¿˜æ˜¯è‹±æ–‡çš„ï¼Œè¿™é‡Œå°† PaperMod çš„ä¸»é¢˜ä¸­çš„æ–‡ä»¶æ‹·è´è¿‡æ¥ï¼›\ncp themes/PaperMod/i18n/zh.yaml i18n/zh-cn.yaml hugo server -D å‚è€ƒ https://blog.rzlnb.top/ https://www.yuweihung.com/posts/2021/papermod-lang-zh/ https://github.com/adityatelange/hugo-PaperMod?tab=readme-ov-file https://github.com/adityatelange/hugo-PaperMod/wiki/Features ","permalink":"https://hanlyjiang.github.io/posts/hugo%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE/","summary":"\u003ch2 id=\"å®‰è£…\"\u003eå®‰è£…\u003c/h2\u003e\n\u003cp\u003eæ­¤éƒ¨åˆ†çœç•¥ï¼Œå¯ç›´æ¥ä½¿ç”¨ AI æä¾›ï¼›\u003c/p\u003e\n\u003ch2 id=\"é…ç½®ä¸­æ–‡\"\u003eé…ç½®ä¸­æ–‡\u003c/h2\u003e\n\u003ch3 id=\"åŸºç¡€é…ç½®\"\u003eåŸºç¡€é…ç½®\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# é…ç½®è¯­è¨€\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003elanguageCode\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ezh-cn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003edefaultContentLanguage\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ezh-cn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# æ‰€æœ‰è¯­è¨€éƒ½æ”¾å…¥ç‹¬ç«‹å­ç›®å½• false\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003edefaultContentLanguageInSubdir\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003efalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003eæ³¨æ„: è¿™é‡Œçš„è¯­è¨€æ˜¯ zh-cnï¼Œä½†æ˜¯ PaperMod ä¸»é¢˜çš„å¤šè¯­è¨€é…ç½®ä¸­å¯¹åº”çš„æ˜¯ zh.yaml æ–‡ä»¶\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"å¤šè¯­è¨€ç¿»è¯‘æ–‡ä»¶\"\u003eå¤šè¯­è¨€ç¿»è¯‘æ–‡ä»¶\u003c/h3\u003e\n\u003cp\u003eç»è¿‡åŸºç¡€é…ç½®ï¼Œéƒ¨åˆ†ç•Œé¢å·²ç»æ˜¯ä¸­æ–‡äº†ï¼Œä½†æ˜¯åƒé˜…è¯»æ—¶é—´è¿™ç§è¿˜æ˜¯è‹±æ–‡çš„ï¼Œè¿™é‡Œå°† PaperMod çš„ä¸»é¢˜ä¸­çš„æ–‡ä»¶æ‹·è´è¿‡æ¥ï¼›\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-SHELL\" data-lang=\"SHELL\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ecp themes/PaperMod/i18n/zh.yaml i18n/zh-cn.yaml\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ehugo server -D\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"å‚è€ƒ\"\u003eå‚è€ƒ\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://blog.rzlnb.top/\"\u003ehttps://blog.rzlnb.top/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.yuweihung.com/posts/2021/papermod-lang-zh/\"\u003ehttps://www.yuweihung.com/posts/2021/papermod-lang-zh/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/adityatelange/hugo-PaperMod?tab=readme-ov-file\"\u003ehttps://github.com/adityatelange/hugo-PaperMod?tab=readme-ov-file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/adityatelange/hugo-PaperMod/wiki/Features\"\u003ehttps://github.com/adityatelange/hugo-PaperMod/wiki/Features\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","title":"Hugoåšå®¢é…ç½®"},{"content":"è¿™é‡Œæˆ‘ä»¬ä»¥è§£å†³ PopupWindow æ˜¾ç¤ºçš„ä¸€ä¸ªé—®é¢˜ä½œä¸ºç›®æ ‡æ¥è¿›è¡Œåˆ†æã€‚\né—®é¢˜æè¿° æƒ³è¦çš„æ•ˆæœ åœ¨æ§ä»¶ä¸Šæ–¹æ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯å•è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯å¤šè¡Œã€‚\nå®ç°æ–¹å¼ ä½¿ç”¨ showAsDropdown æ—¶ï¼Œå¯é€šè¿‡ yOffset å‚æ•°æŒ‡å®šYè½´æ–¹å‘ä¸Šçš„åç§»é‡ï¼š\nåç§»é‡ = anchorView.height + popupWindow.height\nå¯¹äºç¬¬ 2 ç§å•è¡Œçš„å¼¹å‡ºæ¡†æ¥è¯´ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒç®€å•:\nclass RawPopupWindowActivity : DemoButtonsActivity() { private var popupWindow: PopupWindow? = null override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) addButton(\u0026#34;å•è¡ŒPopup\u0026#34;) { v -\u0026gt; showPopup(v, Constants.TEXT_SHORT) } addButton(\u0026#34;å¤šè¡ŒPopup\u0026#34;) { v -\u0026gt; showPopup(v, Constants.TEXT_MEDIUM) } addButton(\u0026#34;å¤šè¡ŒPopup\u0026#34;) { v -\u0026gt; showPopup(v, Constants.TEXT_LONG) } } private fun showPopup(anchorView: View, content: String) { popupWindow?.run { dismiss() } popupWindow = PopupWindow(applicationContext).apply { isOutsideTouchable = true PopupHelper(applicationContext).run { contentView = binding.root setText(content) } width = WindowManager.LayoutParams.WRAP_CONTENT height = WindowManager.LayoutParams.WRAP_CONTENT setBackgroundDrawable(ColorDrawable(Color.TRANSPARENT)) // æµ‹é‡é«˜åº¦ contentView.measure( View.MeasureSpec.makeMeasureSpec(width, View.MeasureSpec.UNSPECIFIED), View.MeasureSpec.makeMeasureSpec(height, View.MeasureSpec.UNSPECIFIED) ) // æ˜¾ç¤ºæ—¶å‘ä¸Šç§»åŠ¨ anchorView.height + contentView.measuredHeight showAsDropDown(anchorView, 0, -(anchorView.height + contentView.measuredHeight)) } } } å®ç°æ•ˆæœåŠé—®é¢˜ æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\nå¯ä»¥çœ‹åˆ°å‚ç›´æ–¹å‘ä¸Šï¼š\nå•è¡Œçš„æ²¡æœ‰åç§» ä¸¤è¡Œçš„æœ‰äº›è®¸åç§» å¤šè¡Œçš„åç§»å°±éå¸¸å¤§äº† è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æµ‹é‡çš„æ—¶å€™å¹¶ä¸æ˜¯æŒ‰ç…§PopupWindowæœ¬èº«çš„æµ‹é‡æ–¹å¼è¿›è¡Œæµ‹é‡çš„ï¼Œæ‰€ä»¥heightçš„å€¼ä¸åŒ¹é…çœŸå®é«˜åº¦ã€‚\nWindowæ·»åŠ è¿‡ç¨‹ showAsDropDown // android/widget/PopupWindow.java public void showAsDropDown(View anchor, int xoff, int yoff) { showAsDropDown(anchor, xoff, yoff, DEFAULT_ANCHORED_GRAVITY); } public void showAsDropDown(View anchor, int xoff, int yoff, int gravity) { if (isShowing() || !hasContentView()) { return; } // å…³é—­ mDecorView ä¸Šçš„åŠ¨ç”» TransitionManager.endTransitions(mDecorView); // å»ºä¸‹æ–¹ attachToAnchor(anchor, xoff, yoff, gravity); mIsShowing = true; mIsDropdown = true; // æ ¹æ®ä¼ é€’è¿›æ¥çš„å‚æ•°ï¼Œè®¾ç½®å¸ƒå±€å‚æ•° final WindowManager.LayoutParams p = createPopupLayoutParams(anchor.getApplicationWindowToken()); // åˆ›å»º DecorView BackgroundView ContentView å‡ ä¸ªå±‚æ¬¡çš„åŒ…è£… preparePopup(p); final boolean aboveAnchor = findDropDownPosition(anchor, p, xoff, yoff, p.width, p.height, gravity, mAllowScrollingAnchorParent); updateAboveAnchor(aboveAnchor); p.accessibilityIdOfAnchor = (anchor != null) ? anchor.getAccessibilityViewId() : -1; invokePopup(p); } attachToAnchor protected void attachToAnchor(View anchor, int xoff, int yoff, int gravity) { detachFromAnchor(); final ViewTreeObserver vto = anchor.getViewTreeObserver(); if (vto != null) { vto.addOnScrollChangedListener(mOnScrollChangedListener); } // Viewè¢«æ·»åŠ åˆ°Windowæˆ–è€…ä»Windowä¸Šåˆ†ç¦»æ—¶çš„ç›‘å¬ anchor.addOnAttachStateChangeListener(mOnAnchorDetachedListener); final View anchorRoot = anchor.getRootView(); anchorRoot.addOnAttachStateChangeListener(mOnAnchorRootDetachedListener); // å› ä¸ºå¸ƒå±€å˜åŒ–å¯¼è‡´Viewçš„è¾¹ç•Œå˜åŒ–æ—¶çš„ç›‘å¬ anchorRoot.addOnLayoutChangeListener(mOnLayoutChangeListener); // å­˜å‚¨ é”šView çš„ä¸€äº›ä¿¡æ¯ mAnchor = new WeakReference\u0026lt;\u0026gt;(anchor); mAnchorRoot = new WeakReference\u0026lt;\u0026gt;(anchorRoot); mIsAnchorRootAttached = anchorRoot.isAttachedToWindow(); mParentRootView = mAnchorRoot; mAnchorXoff = xoff; mAnchorYoff = yoff; mAnchoredGravity = gravity; } ä»è¿™é‡Œå¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š\nmAnchorï¼š é”šView ï¼ˆå¼±å¼•ç”¨ï¼‰ mAnchorRootï¼š é”šViewçš„é¡¶å±‚View (å¼±å¼•ç”¨) mParentRootView ï¼š mAnchorRoot ï¼ˆå¼ºå¼•ç”¨ï¼‰ createPopupLayoutParams å°±æ˜¯ LayoutParams è®¾ç½®\nprotected final WindowManager.LayoutParams createPopupLayoutParams(IBinder token) { final WindowManager.LayoutParams p = new WindowManager.LayoutParams(); p.gravity = computeGravity(); p.flags = computeFlags(p.flags); p.type = mWindowLayoutType; p.token = token; p.softInputMode = mSoftInputMode; p.windowAnimations = computeAnimationResource(); // è®¾ç½®äº†èƒŒæ™¯æ—¶ï¼Œä»èƒŒæ™¯Drawableå–åƒç´ æ ¼å¼ if (mBackground != null) { p.format = mBackground.getOpacity(); } else { p.format = PixelFormat.TRANSLUCENT; } if (mHeightMode \u0026lt; 0) { p.height = mLastHeight = mHeightMode; } else { p.height = mLastHeight = mHeight; } if (mWidthMode \u0026lt; 0) { p.width = mLastWidth = mWidthMode; } else { p.width = mLastWidth = mWidth; } p.privateFlags = PRIVATE_FLAG_WILL_NOT_REPLACE_ON_RELAUNCH | PRIVATE_FLAG_LAYOUT_CHILD_WINDOW_IN_PARENT_FRAME; // Used for debugging. p.setTitle(\u0026#34;PopupWindow:\u0026#34; + Integer.toHexString(hashCode())); return p; } preparePopup private void preparePopup(WindowManager.LayoutParams p) { // When a background is available, we embed the content view within // another view that owns the background drawable. if (mBackground != null) { mBackgroundView = createBackgroundView(mContentView); mBackgroundView.setBackground(mBackground); } else { mBackgroundView = mContentView; } mDecorView = createDecorView(mBackgroundView); } æ€»ä½“å°±æ˜¯ä¸ºäº†åˆ›å»ºå¦‚ä¸‹å±‚æ¬¡çš„ Viewï¼š\nä¸è¿‡ï¼Œ DecorView ä¸Šæœ‰é™„åŠ æ•ˆæœï¼Œä¸»è¦æ˜¯äº‹ä»¶å’ŒåŠ¨ç”»ç›¸å…³çš„ã€‚åé¢å…·ä½“è¿›è¡Œåˆ†æã€‚\nfindDropDownPosition å°±åƒå…¶æ³¨é‡Šè¯´çš„ï¼Œè®¡ç®—PopupWindow åœ¨å±å¹•ä¸Šé¢çš„ä½ç½®ï¼š\nå¦‚æœPopupWindowå¤ªé«˜ï¼Œæ— æ³•æ”¾ç½®åˆ°anchorçš„ä¸‹æ–¹ï¼Œåˆ™ä¼šæ£€æµ‹ä¸Šå±‚æ˜¯å¦æœ‰å¯æ»šåŠ¨çš„è§†å›¾ï¼Œå¹¶å‘ä¸Šæ»šåŠ¨ä»¥è·å–å¯ç”¨ç©ºé—´ã€‚ å¦‚æœçˆ¶å¸ƒå±€æ— æ³•æ»šåŠ¨ï¼ŒpopupWindowä¼šæ”¾ç½®åˆ°anchorçš„ä¸Šæ–¹ã€‚ protected boolean findDropDownPosition(View anchor, WindowManager.LayoutParams outParams, int xOffset, int yOffset, int width, int height, int gravity, boolean allowScroll) { // è·å– anchorå®½é«˜ final int anchorHeight = anchor.getHeight(); final int anchorWidth = anchor.getWidth(); // å…è®¸é‡å æ—¶ï¼Œä¼šå…ˆä¸Šç§»åŠ¨ anchor çš„é«˜åº¦ if (mOverlapAnchor) { yOffset -= anchorHeight; } // å…ˆå°è¯•å°†ä½ç½®æ”¾ç½®åœ¨anchorçš„å·¦ä¸‹è§’å¹¶åŠ ä¸Šåç§»é‡ // è·å–anchorçš„rootViewåœ¨å±å¹•ä¸Šçš„ä½ç½® appScreenLocation final int[] appScreenLocation = mTmpAppLocation; final View appRootView = getAppRootView(anchor); appRootView.getLocationOnScreen(appScreenLocation); // è·å– anchor åœ¨å±å¹•ä¸Šçš„ä½ç½® screenLocation final int[] screenLocation = mTmpScreenLocation; anchor.getLocationOnScreen(screenLocation); // è®¡ç®—åˆæ­¥çš„ç»˜åˆ¶ä½ç½® final int[] drawingLocation = mTmpDrawingLocation; drawingLocation[0] = screenLocation[0] - appScreenLocation[0]; drawingLocation[1] = screenLocation[1] - appScreenLocation[1]; outParams.x = drawingLocation[0] + xOffset; outParams.y = drawingLocation[1] + anchorHeight + yOffset; // å¦‚æœå®½é«˜å‚æ•°ä¸º MATCH_PARENT æ—¶ï¼Œæ ¹æ®å¤–å±‚å¯ç”¨ç©ºé—´è®¡ç®—çœŸæ­£çš„å…·ä½“å®½é«˜æ•°å€¼ final Rect displayFrame = new Rect(); appRootView.getWindowVisibleDisplayFrame(displayFrame); if (width == MATCH_PARENT) { width = displayFrame.right - displayFrame.left; } if (height == MATCH_PARENT) { height = displayFrame.bottom - displayFrame.top; } // Let the window manager know to align the top to y. outParams.gravity = computeGravity(); outParams.width = width; outParams.height = height; // ç¬¬ä¸€é˜¶æ®µå®Œæˆ // ç¬¬äºŒé˜¶æ®µï¼šå°è¯•ï¼ˆåœ¨ä¸è°ƒæ•´å¤§å°çš„æƒ…å†µä¸‹ï¼‰è°ƒæ•´Popupçš„å‚ç›´æ–¹å‘ï¼Œé€šè¿‡è¿”å›å€¼å¯ä»¥åˆ¤æ–­å‚ç›´æ–¹å‘ä¸Šæ˜¯å¦å¤Ÿç”¨ final boolean fitsVertical = tryFitVertical(outParams, yOffset, height, anchorHeight, drawingLocation[1], screenLocation[1], displayFrame.top, displayFrame.bottom, false); // ç¬¬ä¸‰é˜¶æ®µï¼šæ¥ä¸‹æ¥,å°è¯•ï¼ˆåœ¨ä¸è°ƒæ•´å¤§å°çš„æƒ…å†µä¸‹ï¼‰è°ƒæ•´Popupçš„æ°´å¹³æ–¹å‘ï¼Œé€šè¿‡è¿”å›å€¼å¯ä»¥åˆ¤æ–­æ°´å¹³æ–¹å‘ä¸Šæ˜¯å¦å¤Ÿç”¨ final boolean fitsHorizontal = tryFitHorizontal(outParams, xOffset, width, anchorWidth, drawingLocation[0], screenLocation[0], displayFrame.left, displayFrame.right, false); // ç¬¬å››é˜¶æ®µï¼šå¦‚æœæ— æ³•æ»¡è¶³Popupçš„æ˜¾ç¤ºï¼Œåˆ™å°è¯•æ»šåŠ¨çˆ¶View if (!fitsVertical || !fitsHorizontal) { final int scrollX = anchor.getScrollX(); final int scrollY = anchor.getScrollY(); final Rect r = new Rect(scrollX, scrollY, scrollX + width + xOffset, scrollY + height + anchorHeight + yOffset); if (allowScroll \u0026amp;\u0026amp; anchor.requestRectangleOnScreen(r, true)) { // Reset for the new anchor position. anchor.getLocationOnScreen(screenLocation); drawingLocation[0] = screenLocation[0] - appScreenLocation[0]; drawingLocation[1] = screenLocation[1] - appScreenLocation[1]; outParams.x = drawingLocation[0] + xOffset; outParams.y = drawingLocation[1] + anchorHeight + yOffset; // Preserve the gravity adjustment. if (hgrav == Gravity.RIGHT) { outParams.x -= width - anchorWidth; } } // Try to fit the popup again and allowing resizing. tryFitVertical(outParams, yOffset, height, anchorHeight, drawingLocation[1], screenLocation[1], displayFrame.top, displayFrame.bottom, mClipToScreen); tryFitHorizontal(outParams, xOffset, width, anchorWidth, drawingLocation[0], screenLocation[0], displayFrame.left, displayFrame.right, mClipToScreen); } // Return whether the popup\u0026#39;s top edge is above the anchor\u0026#39;s top edge. return outParams.y \u0026lt; drawingLocation[1]; } ç¬¬ä¸€é˜¶æ®µçš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼Œå¾—åˆ°æœ€åçš„xï¼Œyå€¼ï¼š\ntryFitVertical private boolean tryFitVertical(@NonNull LayoutParams outParams, int yOffset, int height, int anchorHeight, int drawingLocationY, int screenLocationY, int displayFrameTop, int displayFrameBottom, boolean allowResize) { // è®¡ç®—Yæ–¹å‘ä¸Šçš„ offsetï¼ŒscreenLocationYä¸ºanchorViewçš„Yï¼ŒdrawingLocationYä¸ºpopupçš„Y final int winOffsetY = screenLocationY - drawingLocationY; // anchor final int anchorTopInScreen = outParams.y + winOffsetY; final int spaceBelow = displayFrameBottom - anchorTopInScreen; if (anchorTopInScreen \u0026gt;= displayFrameTop \u0026amp;\u0026amp; height \u0026lt;= spaceBelow) { return true; } final int spaceAbove = anchorTopInScreen - anchorHeight - displayFrameTop; if (height \u0026lt;= spaceAbove) { // Move everything up. if (mOverlapAnchor) { yOffset += anchorHeight; } outParams.y = drawingLocationY - height + yOffset; return true; } if (positionInDisplayVertical(outParams, height, drawingLocationY, screenLocationY, displayFrameTop, displayFrameBottom, allowResize)) { return true; } return false; } tryFitHorizontal ","permalink":"https://hanlyjiang.github.io/posts/popupwindow-ding-bu-duo-xing-xian-shi/","summary":"\u003cp\u003eè¿™é‡Œæˆ‘ä»¬ä»¥è§£å†³ PopupWindow æ˜¾ç¤ºçš„ä¸€ä¸ªé—®é¢˜ä½œä¸ºç›®æ ‡æ¥è¿›è¡Œåˆ†æã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"é—®é¢˜æè¿°\"\u003eé—®é¢˜æè¿°\u003c/h2\u003e\n\u003ch3 id=\"æƒ³è¦çš„æ•ˆæœ\"\u003eæƒ³è¦çš„æ•ˆæœ\u003c/h3\u003e\n\u003cp\u003eåœ¨æ§ä»¶ä¸Šæ–¹æ˜¾ç¤ºï¼Œå¯èƒ½æ˜¯å•è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯å¤šè¡Œã€‚\u003c/p\u003e\n\u003cimg src=\"https://s2.loli.net/2022/04/16/iE2q13rHFBwXWph.png\" alt=\"image-20220416163306855\" style=\"zoom: 33%;\" /\u003e\n\u003ch3 id=\"å®ç°æ–¹å¼\"\u003eå®ç°æ–¹å¼\u003c/h3\u003e\n\u003cp\u003eä½¿ç”¨ \u003ccode\u003eshowAsDropdown\u003c/code\u003e æ—¶ï¼Œå¯é€šè¿‡ yOffset å‚æ•°æŒ‡å®šYè½´æ–¹å‘ä¸Šçš„åç§»é‡ï¼š\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eåç§»é‡ = anchorView.height + popupWindow.height\u003c/code\u003e\u003c/p\u003e\n\u003cimg src=\"https://s2.loli.net/2022/04/16/xaRPLy16hOUFMtN.png\" alt=\"image-20220416200612183\" style=\"zoom: 33%;\" /\u003e\n\u003cp\u003eå¯¹äºç¬¬ 2 ç§å•è¡Œçš„å¼¹å‡ºæ¡†æ¥è¯´ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒç®€å•:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eRawPopupWindowActivity\u003c/span\u003e : DemoButtonsActivity() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e popupWindow: PopupWindow? = \u003cspan style=\"color:#66d9ef\"\u003enull\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eoverride\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efun\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eonCreate\u003c/span\u003e(savedInstanceState: Bundle?) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003esuper\u003c/span\u003e.onCreate(savedInstanceState)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        addButton(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;å•è¡ŒPopup\u0026#34;\u003c/span\u003e) { v \u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e showPopup(v, \u003cspan style=\"color:#a6e22e\"\u003eConstants\u003c/span\u003e.TEXT_SHORT) }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        addButton(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;å¤šè¡ŒPopup\u0026#34;\u003c/span\u003e) { v \u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e showPopup(v, \u003cspan style=\"color:#a6e22e\"\u003eConstants\u003c/span\u003e.TEXT_MEDIUM) }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        addButton(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;å¤šè¡ŒPopup\u0026#34;\u003c/span\u003e) { v \u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e showPopup(v, \u003cspan style=\"color:#a6e22e\"\u003eConstants\u003c/span\u003e.TEXT_LONG) }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eprivate\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efun\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eshowPopup\u003c/span\u003e(anchorView: View, content: String) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        popupWindow\u003cspan style=\"color:#f92672\"\u003e?.\u003c/span\u003erun {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            dismiss()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        popupWindow = PopupWindow(applicationContext).apply {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            isOutsideTouchable = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            PopupHelper(applicationContext).run {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                contentView = binding.root\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                setText(content)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            width = \u003cspan style=\"color:#a6e22e\"\u003eWindowManager\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLayoutParams\u003c/span\u003e.WRAP_CONTENT\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            height = \u003cspan style=\"color:#a6e22e\"\u003eWindowManager\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLayoutParams\u003c/span\u003e.WRAP_CONTENT\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            setBackgroundDrawable(ColorDrawable(\u003cspan style=\"color:#a6e22e\"\u003eColor\u003c/span\u003e.TRANSPARENT))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          \t\u003cspan style=\"color:#75715e\"\u003e// æµ‹é‡é«˜åº¦\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e            contentView.measure(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#a6e22e\"\u003eView\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMeasureSpec\u003c/span\u003e.makeMeasureSpec(width, \u003cspan style=\"color:#a6e22e\"\u003eView\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMeasureSpec\u003c/span\u003e.UNSPECIFIED),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#a6e22e\"\u003eView\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMeasureSpec\u003c/span\u003e.makeMeasureSpec(height, \u003cspan style=\"color:#a6e22e\"\u003eView\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMeasureSpec\u003c/span\u003e.UNSPECIFIED)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          \t\u003cspan style=\"color:#75715e\"\u003e// æ˜¾ç¤ºæ—¶å‘ä¸Šç§»åŠ¨ anchorView.height + contentView.measuredHeight \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e            showAsDropDown(anchorView, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, -(anchorView.height + contentView.measuredHeight))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"å®ç°æ•ˆæœåŠé—®é¢˜\"\u003eå®ç°æ•ˆæœåŠé—®é¢˜\u003c/h3\u003e\n\u003cp\u003eæœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š\u003c/p\u003e","title":" PopupWindow é¡¶éƒ¨å¤šè¡Œæ˜¾ç¤º"},{"content":"Android Jacoco è¦†ç›–ç‡ç»Ÿè®¡Gradleé…ç½®ï¼ŒåŒ…æ‹¬ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œä»ªå™¨å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æ‰§è¡Œæ•°æ®å¹¶åœ¨AndroidStudioçš„ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹æ¯ä¸€è¡Œçš„è¦†ç›–ç‡æƒ…å†µã€‚\nå¦‚ä½•è®©æµ‹è¯•ä»»åŠ¡ç”Ÿæˆ Jacoco è¦†ç›–ç‡ç»Ÿè®¡æ•°æ®ï¼Ÿ è¿™é‡Œæˆ‘ä»¬ä»…ä»…ä»Gradleä»»åŠ¡æ¥è¯´ï¼Œä¸è€ƒè™‘ AndroidStudio/IDEAã€‚\næœ¬åœ°å•å…ƒæµ‹è¯•ï¼ˆTestï¼‰ å¯¹äºæœ¬åœ°å•å…ƒæµ‹è¯•æ¥è¯´ï¼ŒåŸå…ˆæœ‰ä¸€ä¸ª testDebugUnitTest çš„æµ‹è¯•ä»»åŠ¡ï¼Œå¦‚æœä¸åšé…ç½®ï¼Œè¯¥ä»»åŠ¡åªä¼šç”Ÿæˆæµ‹è¯•é€šè¿‡æƒ…å†µçš„æŠ¥å‘Šã€‚åªè¦åº”ç”¨ jacoco æ’ä»¶ï¼Œç„¶åè¿è¡Œ testDebugUnitTest ä»»åŠ¡æ—¶ï¼Œå°±ä¼šåŒæ—¶ç”Ÿæˆjacocoè¦†ç›–ç‡ç»Ÿè®¡æ‰§è¡Œæ•°æ®æ–‡ä»¶ã€‚\n// build.gradle apply(plugin = \u0026#34;jacoco\u0026#34;) ä¹‹æ‰€ä»¥èƒ½è¿™æ ·æ˜¯å› ä¸º jacoco æ’ä»¶ä¼šç»™æ‰€æœ‰ Test ç±»å‹çš„ä»»åŠ¡æ·»åŠ  jacoco çš„é…ç½®ã€‚\nå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¾“å‡ºå…¶æ‰§è¡Œæ•°æ®æ–‡ä»¶è·¯å¾„ï¼š\nafterEvaluate { tasks.getByName(\u0026#34;testDebugUnitTest\u0026#34;).apply { doLast { (this.extensions.getByName(\u0026#34;jacoco\u0026#34;) as JacocoTaskExtension).apply { logger.lifecycle(\u0026#34;testDebugUnitTest dest: ${this.destinationFile?.absolutePath}\u0026#34;) } } } } æ‰§è¡Œæƒ…å†µå¦‚ä¸‹ï¼š\ntestDebugUnitTest dest: /Users/hanlyjiang/Wksp/project/AndroidTestSample/app/build/outputs/unit_test_code_coverage/debugUnitTest/testDebugUnitTest.exec ä»ªå™¨å•å…ƒæµ‹è¯•ï¼ˆAndroidTestï¼‰ ä»ªå™¨å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ•°æ®çš„ç»Ÿè®¡éœ€è¦æ‰“å¼€testCoverageEnabledå¼€å…³ï¼Œç„¶åä¼šæœ‰ä¸€ä¸ªcreateDebugCoverageReport çš„ä»»åŠ¡ç”Ÿæˆï¼ŒåŒæ—¶ä¹Ÿä¼šç”Ÿæˆhtmlçš„æŠ¥å‘Šã€‚\n// groovy android { buildTypes { debug { testCoverageEnabled = true } } } // kotlin android { buildTypes { getByName(\u0026#34;debug\u0026#34;).apply { isTestCoverageEnabled = true } } } è¿æ¥è®¾å¤‡æ‰§è¡Œè¯¥ä»»åŠ¡å³å¯ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œæ•°æ®æ–‡ä»¶åŠå¯¹åº”çš„è¦†ç›–ç‡æŠ¥å‘Šã€‚\né€šè¿‡åœ¨build.gradleä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å¯ä»¥åœ¨æ‰§è¡Œæ—¶è¾“å‡ºå…¶æ‰§è¡Œæ•°æ®æ–‡ä»¶åœ¨æœ¬æœºçš„ä½ç½®ï¼š\ntasks.withType(com.android.build.gradle.internal.coverage.JacocoReportTask::class.java) { logger.lifecycle(\u0026#34;-\u0026gt; JacocoReportTask task : $name\u0026#34;) doFirst { logger.lifecycle(\u0026#34;-\u0026gt; JacocoReportTask task : $name , ${jacocoConnectedTestsCoverageDir.get()})}\u0026#34;) } } ç„¶åæ‰§è¡ŒcreateDebugCoverageReport, è¾“å‡ºå¦‚ä¸‹ ï¼š\n\u0026gt; Task :app:createDebugAndroidTestCoverageReport -\u0026gt; JacocoReportTask task : createDebugAndroidTestCoverageReport , /Users/hanlyjiang/Wksp/project/AndroidTestSample/app/build/outputs/code_coverage/debugAndroidTest/connected)} \u0026gt; Task :app:createDebugCoverageReport å°ç»“ é€šè¿‡ä»¥ä¸Šä¿¡æ¯æˆ‘ä»¬å¯çŸ¥ï¼š\nåº”ç”¨ jacoco æ’ä»¶ä¹‹åï¼Œæœ¬åœ°å•å…ƒæµ‹è¯•ä»»åŠ¡ï¼ˆtestDebugUnitTestï¼‰å°±ä¼šç”Ÿæˆ jacoco è¦†ç›–ç‡executionæ•°æ®æ–‡ä»¶ï¼Œä½†æ˜¯ä¸ä¼šç”ŸæˆhtmlæŠ¥å‘Šï¼› å¼€å¯ isTestCoverageEnabled å¼€å…³ï¼Œä¼šç”Ÿæˆ createDebugCoverageReport ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä¼šæ‰§è¡Œä»ªå™¨å•å…ƒæµ‹è¯•ï¼ŒåŒæ—¶ç”Ÿæˆexecutionæ•°æ®æ–‡ä»¶ï¼Œå¹¶ç”ŸæˆhtmlæŠ¥å‘Šã€‚ ç”Ÿæˆ HTML æŠ¥å‘Š ç”±äºandroidTest å·²ç»ç”Ÿæˆäº†htmlæŠ¥å‘Šï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è¦ä¸ºæˆ‘ä»¬çš„æœ¬åœ°å•å…ƒæµ‹è¯•ç”ŸæˆHTMLæŠ¥å‘Šã€‚\nè¦ç”ŸæˆhtmlæŠ¥å‘Šï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»å‹ä¸º JacocoReport çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬åœ¨gradle ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œç”¨äºç”Ÿæˆ jacocoTestDebugUnitTestReport ä»»åŠ¡\napply(plugin = \u0026#34;jacoco\u0026#34;) android { buildTypes { getByName(\u0026#34;debug\u0026#34;).apply { isTestCoverageEnabled = true } } } afterEvaluate { // ç”±äºæˆ‘ä»¬éœ€è¦è·å–å¯¹åº”çš„æºç åŠclassç›®å½•ï¼Œæ‰€ä»¥ä½¿ç”¨ android.applicationVariants forEach æ¥è·å–å˜ä½“ android.applicationVariants.forEach { variant -\u0026gt; if (variant.buildType.isTestCoverageEnabled) { val variantCapName = variant.name.capitalize(); tasks.register( \u0026#34;jacocoTest${variantCapName}UnitTestReport\u0026#34;, JacocoReport::class.java ) { group = \u0026#34;jacoco\u0026#34; // ä¾èµ–æµ‹è¯•ä»»åŠ¡ dependsOn(\u0026#34;test${variantCapName}UnitTest\u0026#34;) // æ ¹æ®æ‰§è¡Œæ•°æ®ç”ŸæˆæŠ¥å‘Šï¼Œç›´æ¥ä¼ è¾“taskå³å¯ executionData(tasks.getByName(\u0026#34;test${variantCapName}UnitTest\u0026#34;)) // æŠ¥å‘Šä¸­ä¼šåŒ…å«æºç ï¼Œå¯ä»¥æŸ¥çœ‹æºç çš„å¯¹åº”çš„è¦†ç›–æƒ…å†µ sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories }) // æ²¡æœ‰ class æ•°æ®æŠ¥å‘Šä¼šæ˜¯ç©ºçš„ classDirectories.from(variant.javaCompileProvider.get().destinationDirectory) doLast { logger.lifecycle(reports.html.outputLocation.asFile.get().absolutePath) } } } } } æ·»åŠ ä¹‹å sync gradleï¼Œå³å¯ç”Ÿæˆä¸€ä¸ª jacocoTestDebugUnitTestReport çš„ä»»åŠ¡ï¼Œæ‰§è¡Œå®ƒå³å¯ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šï¼Œç”Ÿæˆçš„æµ‹è¯•æŠ¥å‘Šä½äºï¼š build/reports/jacoco/jacocoTestDebugUnitTestReportä¸­ã€‚\nä¸‹å›¾å°±æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„æŠ¥å‘Šï¼Œå¯ä»¥çœ‹åˆ°StringUtilså·²ç»èƒ½å¤Ÿç»Ÿè®¡è¦†ç›–ç‡äº†ã€‚è€ŒMainActivityè¿˜æ²¡æœ‰æ•°æ®ã€‚\nç”Ÿæˆåˆå¹¶HTMLæŠ¥å‘Š æˆ‘ä»¬å·²ç»å¯ä»¥ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•çš„è¦†ç›–ç‡æŠ¥å‘Šï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦ç”ŸæˆandroidTest + test çš„åˆå¹¶æŠ¥å‘Šã€‚\nä¹‹å‰æˆ‘ä»¬å·²ç»çŸ¥é“ï¼š\ncreateDebugCoverageReport ä»»åŠ¡å³å¯ç”Ÿæˆ execution æ–‡ä»¶å¹¶ä¸”ç”ŸæˆhtmlæŠ¥å‘Š æˆ‘ä»¬å·²ç»æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡å¯ä»¥ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•çš„æŠ¥å‘Šã€‚ ç°åœ¨æˆ‘ä»¬è¦åšçš„æ˜¯å°†å®ƒä»¬åˆå¹¶ï¼Œä½†æ˜¯æˆ‘ä»¬çš„åˆå¹¶å¹¶ä¸æ˜¯é’ˆå¯¹htmlæŠ¥å‘Šï¼Œè€Œæ˜¯é’ˆå¯¹executionæ•°æ®ã€‚\nè®©æˆ‘ä»¬æ·»åŠ å¦‚ä¸‹é…ç½®æ¥ç”Ÿæˆä¸€ä¸ªåˆå¹¶æŠ¥å‘Šçš„gradleä»»åŠ¡ï¼š\napply(plugin = \u0026#34;jacoco\u0026#34;) android { buildTypes { getByName(\u0026#34;debug\u0026#34;).apply { isTestCoverageEnabled = true } } } afterEvaluate { android.applicationVariants.forEach { variant -\u0026gt; if (variant.buildType.isTestCoverageEnabled) { val variantCapName = variant.name.capitalize(); tasks.register(\u0026#34;mergedJacoco${variantCapName}TestReport\u0026#34;, JacocoReport::class.java) { group = \u0026#34;jacoco\u0026#34; executionData( tasks.getByName(\u0026#34;test${variantCapName}UnitTest\u0026#34;), ) val androidCoverageTask = tasks.getByName(\u0026#34;create${variantCapName}AndroidTestCoverageReport\u0026#34;) if (androidCoverageTask is com.android.build.gradle.internal.coverage.JacocoReportTask) { executionData(androidCoverageTask.jacocoConnectedTestsCoverageDir.asFileTree) } sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories }) classDirectories.from(variant.javaCompileProvider.get().destinationDirectory) dependsOn( \u0026#34;test${variantCapName}UnitTest\u0026#34;, \u0026#34;create${variantCapName}AndroidTestCoverageReport\u0026#34; ) doLast { logger.lifecycle(reports.html.outputLocation.asFile.get().absolutePath) } } } } } è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿æœ‰äº†ä¸€ä¸ª mergedJacocoDebugTestReport çš„ä»»åŠ¡ï¼Œæ‰§è¡Œåå³å¯åœ¨build/reports/jacoco/mergedJacocoDebugTestReport/html ç›®å½•ä¸­æ‰¾åˆ°æˆ‘ä»¬çš„ report ã€‚\nç°åœ¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„MainActivityï¼ˆAndroidTestï¼‰åŠStringUtilsï¼ˆtestï¼‰å¯ä»¥åœ¨ä¸€ä»½æŠ¥å‘Šä¸­æ˜¾ç¤ºè¦†ç›–ç‡æ•°æ®äº†ã€‚\nç”Ÿæˆåˆå¹¶ Execution æ•°æ®æ–‡ä»¶ åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ç”Ÿæˆäº†HTMLç‰ˆæœ¬çš„åˆå¹¶æŠ¥å‘Šï¼Œå¹¶ä¸”å¯ä»¥åœ¨å…¶ä¸­çœ‹åˆ°æºç æ²¡ä¸€è¡Œè¦†ç›–çš„æƒ…å†µã€‚\nä½†æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨AndroidStudioçš„ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºè¦†ç›–ç‡çš„æƒ…å†µï¼Œå‘ä¸‹é¢è¿™æ ·ğŸ‘‡ï¼š\nå®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AndroidStudioçš„Menu-Run-Show Covarage DataåŠ è½½ execution æ–‡ä»¶ï¼Œç„¶ååœ¨AndroidStudioä¸­æ˜¾ç¤ºè¦†ç›–ç‡æ•°æ®ã€‚\næ‰§è¡Œçš„æ•°æ®æ–‡ä»¶ä½äºç±»ä¼¼å¦‚ä¸‹ç›®å½• ï¼š\nbuild/outputs/unit_test_code_coverage/debugUnitTest/testDebugUnitTest.exec build/outputs/code_coverage/debugAndroidTest/connected/Pixel_5_API_Tiramisu(AVD) - 12/coverage.ec ä½†æ˜¯è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š\ndebugAndroidTest ç›®å½•ä¸­çš„ .ec æ–‡ä»¶æ— æ³•è¢«AndroidStudioè¯†åˆ«ã€‚ è¿™ä¸¤ä¸ªæ–‡ä»¶æ˜¯åˆ†å¼€çš„ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶åªåŒ…å«ä¸€ç§æµ‹è¯•çš„è¦†ç›–æ•°æ®ã€‚ ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåˆå¹¶ä»»åŠ¡ï¼š\nafterEvaluate { tasks.getByName(\u0026#34;testDebugUnitTest\u0026#34;).apply { (this.extensions.getByName(\u0026#34;jacoco\u0026#34;) as JacocoTaskExtension).apply { logger.lifecycle(\u0026#34;testDebugUnitTest dest: ${this.destinationFile?.absolutePath}\u0026#34;) } } tasks.withType(org.gradle.api.tasks.testing.Test::class.java) { logger.lifecycle(\u0026#34;-\u0026gt; test task : $name\u0026#34;) } tasks.withType(JacocoReport::class.java) { logger.lifecycle(\u0026#34;-\u0026gt; JacocoReport task : $name\u0026#34;) } tasks.withType(com.android.build.gradle.internal.coverage.JacocoReportTask::class.java) { logger.lifecycle(\u0026#34;-\u0026gt; JacocoReportTask task : $name\u0026#34;) doFirst { logger.lifecycle(\u0026#34;-\u0026gt; JacocoReportTask task : $name , ${jacocoConnectedTestsCoverageDir.get()})}\u0026#34;) } } android.applicationVariants.forEach { variant -\u0026gt; if (variant.buildType.isTestCoverageEnabled) { val variantCapName = variant.name.capitalize(); tasks.register( \u0026#34;jacocoTest${variantCapName}UnitTestReport\u0026#34;, JacocoReport::class.java ) { group = \u0026#34;jacoco\u0026#34; executionData(tasks.getByName(\u0026#34;test${variantCapName}UnitTest\u0026#34;)) sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories }) classDirectories.from(variant.javaCompileProvider.get().destinationDirectory) dependsOn(\u0026#34;test${variantCapName}UnitTest\u0026#34;) doLast { logger.lifecycle(\u0026#34;Jacoco Report: \u0026#34; + reports.html.outputLocation.asFile.get().absolutePath) } } tasks.register(\u0026#34;mergedJacoco${variantCapName}TestReport\u0026#34;, JacocoReport::class.java) { group = \u0026#34;jacoco\u0026#34; executionData( tasks.getByName(\u0026#34;test${variantCapName}UnitTest\u0026#34;), ) val androidCoverageTask = tasks.getByName(\u0026#34;create${variantCapName}AndroidTestCoverageReport\u0026#34;) if (androidCoverageTask is com.android.build.gradle.internal.coverage.JacocoReportTask) { executionData(androidCoverageTask.jacocoConnectedTestsCoverageDir.asFileTree) } sourceDirectories.from(variant.sourceSets.flatMap { it.javaDirectories + it.kotlinDirectories }) classDirectories.from(variant.javaCompileProvider.get().destinationDirectory) dependsOn( \u0026#34;test${variantCapName}UnitTest\u0026#34;, \u0026#34;create${variantCapName}AndroidTestCoverageReport\u0026#34; ) doLast { logger.lifecycle(\u0026#34;Jacoco Report: \u0026#34; + reports.html.outputLocation.asFile.get().absolutePath) } } tasks.register(\u0026#34;mergeJacoco${variantCapName}Execution\u0026#34;, JacocoMerge::class.java) { group = \u0026#34;jacoco\u0026#34; executionData( tasks.getByName(\u0026#34;test${variantCapName}UnitTest\u0026#34;), ) val androidCoverageTask = tasks.getByName(\u0026#34;create${variantCapName}AndroidTestCoverageReport\u0026#34;) if (androidCoverageTask is com.android.build.gradle.internal.coverage.JacocoReportTask) { executionData(androidCoverageTask.jacocoConnectedTestsCoverageDir.asFileTree) } doLast { logger.lifecycle(\u0026#34;Jacoco Execution: \u0026#34; + destinationFile.absolutePath) } } } } } æ‰§è¡Œä¹‹åä½äºï¼šbuild/jacoco/mergeJacocoDebugExecution.exec, é€šè¿‡AndroidStudio åŠ è½½ä¹‹åï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼Œä¸¤ç§æµ‹è¯•çš„ç»“æœå·²ç»åˆå¹¶æ˜¾ç¤ºäº†ã€‚\nå®Œæ•´é…ç½®æ–‡ä»¶ è¯·å‚è€ƒï¼š AndroidTestSample/build.gradle.kts at main Â· hanlyjiang/AndroidTestSample (github.com)\n","permalink":"https://hanlyjiang.github.io/posts/android-jacoco-fu-gai-lu-tong-ji-pei-zhi/","summary":"\u003cp\u003eAndroid Jacoco è¦†ç›–ç‡ç»Ÿè®¡Gradleé…ç½®ï¼ŒåŒ…æ‹¬ç”Ÿæˆæœ¬åœ°å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œä»ªå™¨å•å…ƒæµ‹è¯•æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æŠ¥å‘Šï¼Œåˆå¹¶ä¸¤ç§æµ‹è¯•çš„æ‰§è¡Œæ•°æ®å¹¶åœ¨AndroidStudioçš„ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹æ¯ä¸€è¡Œçš„è¦†ç›–ç‡æƒ…å†µã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"å¦‚ä½•è®©æµ‹è¯•ä»»åŠ¡ç”Ÿæˆ-jacoco-è¦†ç›–ç‡ç»Ÿè®¡æ•°æ®\"\u003eå¦‚ä½•è®©æµ‹è¯•ä»»åŠ¡ç”Ÿæˆ Jacoco è¦†ç›–ç‡ç»Ÿè®¡æ•°æ®ï¼Ÿ\u003c/h2\u003e\n\u003cp\u003eè¿™é‡Œæˆ‘ä»¬ä»…ä»…ä»Gradleä»»åŠ¡æ¥è¯´ï¼Œä¸è€ƒè™‘ AndroidStudio/IDEAã€‚\u003c/p\u003e\n\u003ch3 id=\"æœ¬åœ°å•å…ƒæµ‹è¯•test\"\u003eæœ¬åœ°å•å…ƒæµ‹è¯•ï¼ˆTestï¼‰\u003c/h3\u003e\n\u003cp\u003eå¯¹äºæœ¬åœ°å•å…ƒæµ‹è¯•æ¥è¯´ï¼ŒåŸå…ˆæœ‰ä¸€ä¸ª \u003ccode\u003etestDebugUnitTest\u003c/code\u003e çš„æµ‹è¯•ä»»åŠ¡ï¼Œå¦‚æœä¸åšé…ç½®ï¼Œè¯¥ä»»åŠ¡åªä¼šç”Ÿæˆæµ‹è¯•é€šè¿‡æƒ…å†µçš„æŠ¥å‘Šã€‚åªè¦åº”ç”¨ jacoco æ’ä»¶ï¼Œç„¶åè¿è¡Œ \u003ccode\u003etestDebugUnitTest\u003c/code\u003e ä»»åŠ¡æ—¶ï¼Œå°±ä¼šåŒæ—¶ç”Ÿæˆjacocoè¦†ç›–ç‡ç»Ÿè®¡\u003cstrong\u003eæ‰§è¡Œæ•°æ®æ–‡ä»¶\u003c/strong\u003eã€‚\u003c/p\u003e","title":"Android Jacocoè¦†ç›–ç‡ç»Ÿè®¡é…ç½®"},{"content":"é‡åˆ°ä¸€ä¸ªåˆçœ‹æ—¶éå¸¸è¯¡å¼‚çš„é—®é¢˜ï¼Œç°å·²è§£å†³ï¼Œç‰¹è®°å½•ä¸€ä¸‹è§£å†³è¿‡ç¨‹ã€‚\nğŸ™‹â€â™€ï¸ æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ é”™è¯¯æ—¥å¿— APPè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¿½ç„¶æŠ¥äº†ä¸€ä¸ªè«åå…¶å¦™çš„é”™è¯¯ï¼š NoSuchMethodError, æŠ¥é”™çš„åœ°æ–¹æ˜¯ rxjava3 çš„ Disposable.disposed()\nE/AndroidRuntime: FATAL EXCEPTION: main Process: com.github.hanlyjiang.sample, PID: 7357 java.lang.NoSuchMethodError: No static method disposed()Lio/reactivex/rxjava3/disposables/Disposable; in class Lio/reactivex/rxjava3/disposables/Disposable; or its super classes (declaration of \u0026#39;io.reactivex.rxjava3.disposables.Disposable\u0026#39; appears in /data/app/~~veR3ZUFYzXjZ48FDcAW0Nw==/com.github.hanlyjiang.sample-bhuZG0wVNdVKs_mfxOh5gg==/base.apk) at com.github.hanlyjiang.lib_mod.ViewTest.disposable(ViewTest.java:8) at com.github.hanlyjiang.sample.MainActivity.lambda$onCreate$0(MainActivity.java:15) at com.github.hanlyjiang.sample.MainActivity$$ExternalSyntheticLambda0.onClick(Unknown Source:0) at android.view.View.performClick(View.java:7456) at com.google.android.material.button.MaterialButton.performClick(MaterialButton.java:1119) at android.view.View.performClickInternal(View.java:7433) at android.view.View.access$3700(View.java:836) at android.view.View$PerformClick.run(View.java:28832) at android.os.Handler.handleCallback(Handler.java:938) at android.os.Handler.dispatchMessage(Handler.java:99) at android.os.Looper.loopOnce(Looper.java:201) at android.os.Looper.loop(Looper.java:288) at android.app.ActivityThread.main(ActivityThread.java:7902) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:933) â° Tip\nå®é™…ä¸Šè¿˜æœ‰é‡åˆ°è¿‡ä¸€ä¸ª AbstractMethodError çš„é”™è¯¯\nå‡ºç°åœºæ™¯ AAR å¼•å…¥åˆ°APPæ¨¡å— æ‰“åŒ…APKï¼ˆä¸é€šè¿‡AndroidStudioç›´æ¥è¿è¡Œï¼‰ å®‰è£…å¹¶è¿è¡Œ è§£å†³æ–¹æ¡ˆ å¯¹äºéœ€è¦è§£å†³é—®é¢˜çš„ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒå°è¯•ä¸‹é¢ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚\nè§£æ³•1 gradle.properties æ–‡ä»¶ä¸­æ·»åŠ å±æ€§ï¼š\nandroid.enableDexingArtifactTransform.desugaring=false è§£æ³•2 ä¿®æ”¹ aar çš„ä¾èµ–æ–¹å¼ï¼Œå°†name+extçš„æ–¹å¼ä¿®æ”¹ä¸º files\nimplementation(name: \u0026#39;libmod-release\u0026#39;, ext: \u0026#39;aar\u0026#39;) ä¿®æ”¹ä¹‹å\nimplementation(files(\u0026#39;libs/libmod-release.aar\u0026#39;)) æ¡ˆä¾‹è§‚å¯Ÿ æ ¹æ®é”™è¯¯ä¿¡æ¯ï¼Œæ‰¾åˆ°æˆ‘ä»¬çš„ä»£ç ï¼Œå¾—åˆ°å¦‚ä¸‹è°ƒç”¨å…³ç³»ï¼š\nViewTest.disposable -\u0026gt; Disposable.disposed() ä¸ºäº†æ–¹ä¾¿åˆ†æåŠæ¼”ç¤ºï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªæµ‹è¯•å·¥ç¨‹ä½äºï¼š colorless-hanly/NoSuchMethodError: NoSuchMethodError (github.com)ï¼Œè¿è¡Œæ­¤å·¥ç¨‹èƒ½å¤ç°è¯¥é—®é¢˜ã€‚\nclasså­—èŠ‚ç æ²¡æœ‰é—®é¢˜ æˆ‘ä»¬çš„AARæä¾›ç»™APPæ¨¡å—æ—¶ï¼Œæ˜¯ä»¥ class ç±»æ–‡ä»¶æä¾›çš„ï¼Œé€šè¿‡åç¼–è¯‘æŸ¥çœ‹å…¶å†…å®¹ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚\næ‰€ä»¥æˆ‘ä»¬çœ‹çœ‹æœ€åè¿è¡Œçš„APKå¯¹åº”çš„DEXï¼Œå¹¶é€šè¿‡AndroidStudio æŸ¥çœ‹å…¶å¯¹åº”çš„å­—èŠ‚ç ã€‚\nViewTest.disposable é¦–å…ˆæˆ‘ä»¬æ ¹æ®æŠ¥é”™ä¿¡æ¯æ‰¾åˆ°å‡ºé”™çš„ViewTest.disposableç±»ï¼Œå¹¶æŸ¥çœ‹å…¶å­—èŠ‚ç \nJava ä»£ç ï¼š\npublic class ViewTest { public static Disposable disposable() { return Disposable.disposed(); } } å­—èŠ‚ç ï¼š\n.class public Lcom/github/hanlyjiang/lib_mod/ViewTest; .super Ljava/lang/Object; .source \u0026#34;ViewTest.java\u0026#34; # direct methods .method public constructor \u0026lt;init\u0026gt;()V .registers 1 .line 5 invoke-direct {p0}, Ljava/lang/Object;-\u0026gt;\u0026lt;init\u0026gt;()V return-void .end method .method public static disposable()Lio/reactivex/rxjava3/disposables/Disposable; .registers 1 .line 8 invoke-static {}, Lio/reactivex/rxjava3/disposables/Disposable;-\u0026gt;disposed()Lio/reactivex/rxjava3/disposables/Disposable; move-result-object v0 return-object v0 .end method çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚\nDisposable.disposed() æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹ Disposable æ¥å£çš„å­—èŠ‚ç ï¼Œå‘ç°å±…ç„¶æ²¡æœ‰æˆ‘ä»¬è°ƒç”¨çš„ disposed æ–¹æ³•ã€‚\nä½†æ˜¯ï¼Œå¾ˆå¿«å°±åœ¨æœ‰ä¸€ä¸ªå«åš Disposable$-CC çš„ç±»ä¸­æ‰¾åˆ°äº†æˆ‘ä»¬çš„ disposed æ–¹æ³•ï¼ŒåŒæ—¶å…¶ä¸­è¿˜åŒ…æ‹¬äº† Disposable æ¥å£ä¸­çš„æ‰€æœ‰é™æ€æ–¹æ³•\nè¿™é‡Œæˆ‘ä»¬ç²˜è´´ä¸‹ Disposable æ¥å£çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸¤ä¸ªæ¥å£æ–¹æ³•å®šä¹‰ï¼Œè¿˜æœ‰è‹¥å¹²staticæ–¹æ³•çš„å®šä¹‰åŠå®ç°ã€‚è€Œæˆ‘ä»¬çš„é™æ€æ–¹æ³•å…¨éƒ¨ä½äºå­—èŠ‚ç ä¸­ Disposable$-CC è¿™ä¸ªç±»ä¸­ï¼Œè€Œä¸¤ä¸ªæ¥å£æ–¹æ³•è¿˜ä¿ç•™åœ¨ Disposable ç±»ä¸­ã€‚\npublic interface Disposable { void dispose(); boolean isDisposed(); static Disposable fromRunnable(@NonNull Runnable run) { Objects.requireNonNull(run, \u0026#34;run is null\u0026#34;); return new RunnableDisposable(run); } static Disposable fromAction(@NonNull Action action) { Objects.requireNonNull(action, \u0026#34;action is null\u0026#34;); return new ActionDisposable(action); } static Disposable fromFuture(@NonNull Future\u0026lt;?\u0026gt; future) { Objects.requireNonNull(future, \u0026#34;future is null\u0026#34;); return fromFuture(future, true); } static Disposable fromFuture(@NonNull Future\u0026lt;?\u0026gt; future, boolean allowInterrupt) { Objects.requireNonNull(future, \u0026#34;future is null\u0026#34;); return new FutureDisposable(future, allowInterrupt); } static Disposable fromSubscription(@NonNull Subscription subscription) { Objects.requireNonNull(subscription, \u0026#34;subscription is null\u0026#34;); return new SubscriptionDisposable(subscription); } static Disposable fromAutoCloseable(@NonNull AutoCloseable autoCloseable) { Objects.requireNonNull(autoCloseable, \u0026#34;autoCloseable is null\u0026#34;); return new AutoCloseableDisposable(autoCloseable); } static AutoCloseable toAutoCloseable(@NonNull Disposable disposable) { Objects.requireNonNull(disposable, \u0026#34;disposable is null\u0026#34;); return disposable::dispose; } static Disposable empty() { return fromRunnable(Functions.EMPTY_RUNNABLE); } static Disposable disposed() { return EmptyDisposable.INSTANCE; } } æ­£ç¡®çš„ViewTest.disposableå­—èŠ‚ç  å‰é¢æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬å­—èŠ‚ç ä¸­è°ƒç”¨çš„æ–¹æ³•æ˜¯ Disposable;-\u0026gt;disposed()ï¼Œè€Œå®é™…ä¸Šè¯¥æ–¹æ³•ä½äº Disposable$-CC;-\u0026gt;disposed(),ç°åœ¨æˆ‘ä»¬çœ‹ä¸‹æ­£å¸¸çš„å¯ä»¥è¿è¡Œé€šè¿‡çš„apkä¸­dexå¯¹åº”çš„å­—èŠ‚ç ã€‚\nç»è¿‡å¯¹æ¯”ï¼Œå‘ç°Disposable è¿˜æ˜¯è¢«æ‹†åˆ†ä¸ºäº† Disposable å’Œ Disposable$-CC è€Œ ViewTest.disposable å¯¹åº”çš„å­—èŠ‚ç å´æœ‰åŒºåˆ«ï¼Œæ­£å¸¸å¯ä»¥è°ƒç”¨é€šè¿‡çš„å­—èŠ‚ç å’Œå¼‚å¸¸çš„å¯¹æ¯”å¦‚ä¸‹ï¼š // æ­£ç¡®çš„ invoke-static {}, Lio/reactivex/rxjava3/disposables/Disposable$-CC;-\u0026gt;disposed()Lio/reactivex/rxjava3/disposables/Disposable; // é”™è¯¯çš„ invoke-static {}, Lio/reactivex/rxjava3/disposables/Disposable;-\u0026gt;disposed()Lio/reactivex/rxjava3/disposables/Disposable; å¯ä»¥å‘ç°ï¼Œèƒ½æ­£å¸¸è¿è¡Œçš„æ–¹æ³•è°ƒç”¨ç¡®å®æŒ‡å‘äº† Disposable$-CC;-\u0026gt;disposed()ã€‚\næ€»ç»“ ä¹Ÿå°±æ˜¯è¯´åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼š\nDisposable ä¼šè¢«æ‹†åˆ†ä¸º Disposable å’Œ Disposable$-CC Disposable åŒ…å«äº†æ¥å£æ–¹æ³•çš„å£°æ˜ Disposable$-CC ä¸­åˆ™åŒ…å«äº†é™æ€æ–¹æ³•çš„å£°æ˜åŠå®ç° å¯¹äºè°ƒç”¨åˆ° Disposable çš„é™æ€æ–¹æ³•çš„éƒ¨åˆ†ï¼Œæœ€ç»ˆç¼–è¯‘å®Œæˆåï¼Œä¼šæ›¿æ¢ä¸ºæŒ‡å‘Disposable$-CC è€Œæˆ‘ä»¬å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ²¡æœ‰æ­£ç¡®æŒ‡å‘çš„ï¼Œæ‰€ä»¥ç¡®å®ä¼šå‡ºç°æ‰¾ä¸åˆ°å¯¹åº”çš„æ–¹æ³•çš„æƒ…å†µã€‚\nåŸå› åˆ†æ class -\u0026gt; dex \u0026amp; Java8 è¯­è¨€ç‰¹æ€§æ”¯æŒ ä»¥ä¸‹ä¸ºAndroid å®˜æ–¹æ–‡æ¡£ä¸Šçš„ç›¸å…³æè¿°ï¼š\nä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½å’Œ API Android Gradle æ’ä»¶å¯¹ä½¿ç”¨æŸäº› Java 8 è¯­è¨€åŠŸèƒ½ä»¥åŠåˆ©ç”¨è¿™äº›åŠŸèƒ½çš„ç¬¬ä¸‰æ–¹åº“æä¾›å†…ç½®æ”¯æŒã€‚å¦‚å›¾ æ‰€ç¤ºï¼Œé»˜è®¤å·¥å…·é“¾å®ç°æ–°è¯­è¨€åŠŸèƒ½çš„æ–¹æ³•æ˜¯åœ¨ä½¿ç”¨ D8/R8 å°†ç±»æ–‡ä»¶ç¼–è¯‘æˆ dex ä»£ç çš„è¿‡ç¨‹ä¸­æ‰§è¡Œå­—èŠ‚ç è½¬æ¢ï¼Œè¿™ç§è½¬æ¢ç§°ä¸º desugarã€‚\nJava 8 åŠæ›´é«˜ç‰ˆæœ¬ API è„±ç³–æ”¯æŒï¼ˆAndroid Gradle æ’ä»¶ 4.0.0 åŠæ›´é«˜ç‰ˆæœ¬ï¼‰ å¦‚æœæ‚¨ä½¿ç”¨ Android Gradle æ’ä»¶ 4.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬æ„å»ºåº”ç”¨ï¼Œæ’ä»¶æ‰©å±•äº†å¯¹ä½¿ç”¨å¤šç§ Java 8 è¯­è¨€ API çš„æ”¯æŒï¼Œè€Œæ— éœ€ä¸ºåº”ç”¨è®¾ç½®æœ€ä½ API çº§åˆ«ã€‚\nä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°å¯¹è¾ƒä½å¹³å°ç‰ˆæœ¬çš„è¿™ç§é¢å¤–æ”¯æŒï¼Œæ˜¯å› ä¸ºè„±ç³–å¼•æ“ç»è¿‡æ’ä»¶ 4.0.0 åŠæ›´é«˜ç‰ˆæœ¬æ‰©å±•åï¼Œä¹Ÿèƒ½ä½¿ Java è¯­è¨€ API è„±ç³–ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥åœ¨æ”¯æŒè¾ƒä½ Android ç‰ˆæœ¬çš„åº”ç”¨ä¸­æ·»åŠ è¿‡å»ä»…åœ¨æœ€æ–° Android ç‰ˆæœ¬ä¸­å¯ç”¨çš„æ ‡å‡†è¯­è¨€ APIï¼ˆå¦‚ java.util.streamsï¼‰ã€‚\nä½¿ç”¨ Android Gradle æ’ä»¶ 4.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬æ„å»ºåº”ç”¨æ—¶ï¼Œæ”¯æŒä¸‹é¢ä¸€ç»„ APIï¼š\né¡ºåºæµ (java.util.stream) java.time çš„å­é›† java.util.function java.util.{Map,Collection,Comparator} çš„æœ€è¿‘æ–°å¢å†…å®¹ å¯é€‰å†…å®¹ï¼ˆjava.util.Optionalã€java.util.OptionalInt å’Œ java.util.OptionalDoubleï¼‰ä»¥åŠå¯¹ä¸Šè¿° API å¾ˆæœ‰ç”¨çš„ä¸€äº›å…¶ä»–æ–°ç±» java.util.concurrent.atomic çš„ä¸€äº›æ–°å¢å†…å®¹ï¼ˆAtomicIntegerã€AtomicLong å’Œ AtomicReference çš„æ–°æ–¹æ³•ï¼‰ ConcurrentHashMapï¼ˆåŒ…å« Android 5.0 çš„é—®é¢˜ä¿®å¤ï¼‰ å¦‚éœ€æŸ¥çœ‹å—æ”¯æŒçš„ API çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…é€šè¿‡è„±ç³–è·å¾— Java 8 åŠæ›´é«˜ç‰ˆæœ¬ APIã€‚\nä¸ºäº†æ”¯æŒè¿™äº›è¯­è¨€ APIï¼Œæ’ä»¶ç¼–è¯‘äº†ä¸€ä¸ªå•ç‹¬çš„ DEX æ–‡ä»¶ï¼ˆå…¶ä¸­åŒ…å«ç¼ºå¤± API çš„å®ç°ï¼‰ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ‚¨çš„åº”ç”¨ä¸­ã€‚è„±ç³–è¿‡ç¨‹ä¼šé‡æ–°ç¼–å†™åº”ç”¨çš„ä»£ç ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶æ”¹ç”¨æ­¤åº“ã€‚\nç¼–è¯‘ä½¿ç”¨äº† Java 8 è¯­è¨€åŠŸèƒ½çš„å­—èŠ‚ç  d8 é€šè¿‡ä¸€ä¸ªå«åšâ€œè„±ç³–â€çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œä½¿æ‚¨èƒ½å¤Ÿåœ¨ä»£ç ä¸­ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½ï¼Œæ­¤è¿‡ç¨‹ä¼šå°†è¿™äº›å®ç”¨çš„è¯­è¨€åŠŸèƒ½è½¬æ¢ä¸ºå¯ä»¥åœ¨ Android å¹³å°ä¸Šè¿è¡Œçš„å­—èŠ‚ç ã€‚\nAndroid Studio å’Œ Android Gradle æ’ä»¶åŒ…å«äº† d8 ä¸ºæ‚¨å¯ç”¨è„±ç³–æ‰€éœ€çš„ç±»è·¯å¾„èµ„æºã€‚\nAndroid Studio å’Œ Android Gradle æ’ä»¶åŒ…å«äº† d8 ä¸ºæ‚¨å¯ç”¨è„±ç³–æ‰€éœ€çš„ç±»è·¯å¾„èµ„æºã€‚ä¸è¿‡ï¼Œä»å‘½ä»¤è¡Œä½¿ç”¨ d8 æ—¶ï¼Œæ‚¨éœ€è¦æ‰‹åŠ¨æ·»åŠ è¿™äº›èµ„æºã€‚\nå…¶ä¸­ä¸€ä¸ªèµ„æºå°±æ˜¯ç›®æ ‡ Android SDK ä¸­çš„ android.jarã€‚æ­¤èµ„æºåŒ…å«ä¸€ç»„ Android å¹³å° APIï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ --lib æ ‡è®°æ¥æŒ‡å®šè¯¥èµ„æºçš„è·¯å¾„ã€‚\nå¦ä¸€ä¸ªèµ„æºæ˜¯æ‚¨é¡¹ç›®çš„éƒ¨åˆ†å·²ç¼–è¯‘çš„ Java å­—èŠ‚ç ï¼Œæ‚¨ç›®å‰ä¸æ‰“ç®—å°†è¿™éƒ¨åˆ†å­—èŠ‚ç ç¼–è¯‘ä¸º DEX å­—èŠ‚ç ï¼Œä½†åœ¨å°†å…¶ä»–ç±»ç¼–è¯‘ä¸º DEX å­—èŠ‚ç æ—¶éœ€è¦ç”¨åˆ°è¿™äº›å­—èŠ‚ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»£ç ä½¿ç”¨é»˜è®¤å’Œé™æ€æ¥å£æ–¹æ³•ï¼ˆä¸€ç§ Java 8 è¯­è¨€åŠŸèƒ½ï¼‰ï¼Œåˆ™æ‚¨éœ€è¦ä½¿ç”¨æ­¤æ ‡è®°æ¥æŒ‡å®šæ‚¨é¡¹ç›®çš„æ‰€æœ‰ Java å­—èŠ‚ç çš„è·¯å¾„ï¼Œå³ä½¿æ‚¨ä¸æ‰“ç®—å°†æ‰€æœ‰ Java å­—èŠ‚ç éƒ½ç¼–è¯‘ä¸º DEX å­—èŠ‚ç ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸º d8 éœ€è¦æ ¹æ®è¿™äº›ä¿¡æ¯æ¥ç†è§£æ‚¨é¡¹ç›®çš„ä»£ç å¹¶è§£æå¯¹æ¥å£æ–¹æ³•çš„è°ƒç”¨ã€‚\né€šè¿‡ä»¥ä¸Šæè¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š\nAndroid é€šè¿‡ D8 å°† class è½¬æ¢ä¸ºå¯åœ¨Androidå¹³å°ä¸Šæ‰§è¡Œçš„dexï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º desugar ï¼ˆè„±ç³–ï¼‰ã€‚ è„±ç³–è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé‡æ–°ç¼–å†™åº”ç”¨çš„ä»£ç ã€‚ è„±ç³–æ—¶éœ€è¦æŒ‡å®šè„±ç³–æ‰€éœ€è¦çš„ç±»è·¯å¾„èµ„æºã€‚ å¯¹åº”æˆ‘ä»¬çš„é—®é¢˜ å¾…è¡¥å……\né€šè¿‡ d8 æ‰‹åŠ¨å¯¹classè¿›è¡Œdexè½¬æ¢ï¼Œç„¶åè§‚å¯Ÿè½¬æ¢å·®å¼‚ã€‚\nd8 MainActivity.class --intermediate --file-per-class --output ~/build/intermediate/dex --lib android_sdk/platforms/api-level/android.jar --classpath ~/build/javac/debug å°†ç±»æ–‡ä»¶ç¼–è¯‘æˆ dex ä»£ç çš„è¿‡ç¨‹ä¸­æ‰§è¡Œå­—èŠ‚ç è½¬æ¢ï¼Œè¿™ç§è½¬æ¢ç§°ä¸º desugarã€‚AGP ä½¿ç”¨ D8 å®Œæˆdesugar ï¼Œä¸ºäº†èƒ½æ­£ç¡®çš„å¤„ç†classï¼Œéœ€è¦æ ¹æ®POMä¾èµ–ä¿¡æ¯æ¥å¯»æ‰¾å¯¹åº”çš„ä¾èµ–ï¼Œç„¶åå°†æ‰€æœ‰ä¾èµ–é¡¹ç›®éƒ½åŠ å…¥åˆ° desurge classpathï¼Œç„¶åæ‰èƒ½æ­£ç¡®å¤„ç†ã€‚è€Œ aar å¼•å…¥æ—¶ä¸å…·å¤‡è¿™äº›POMä¾èµ–ä¿¡æ¯ï¼Œæ‰€ä»¥æ— æ³•è¿˜åŸã€‚\nè¿›ä¸€æ­¥äº†è§£ d8 | Android å¼€å‘è€… | Android Developers (google.cn) ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½å’Œ API | Android å¼€å‘è€… | Android Developers (google.cn) ä½¿ç”¨ Java 8 è¯­è¨€åŠŸèƒ½å’Œ API | Android å¼€å‘è€… | Android Developers (google.cn) Android Gradle æ’ä»¶ç‰ˆæœ¬è¯´æ˜ | Android å¼€å‘è€… | Android Developers (google.cn) ","permalink":"https://hanlyjiang.github.io/posts/aar-java8-jie-kou-nosuchmethoderror-cuo-wu-jie-jue-ji-lu/","summary":"\u003cp\u003eé‡åˆ°ä¸€ä¸ªåˆçœ‹æ—¶éå¸¸è¯¡å¼‚çš„é—®é¢˜ï¼Œç°å·²è§£å†³ï¼Œç‰¹è®°å½•ä¸€ä¸‹è§£å†³è¿‡ç¨‹ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"-æ˜¯ä»€ä¹ˆé—®é¢˜\"\u003eğŸ™‹â€â™€ï¸ æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ\u003c/h2\u003e\n\u003ch3 id=\"é”™è¯¯æ—¥å¿—\"\u003eé”™è¯¯æ—¥å¿—\u003c/h3\u003e\n\u003cp\u003eAPPè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¿½ç„¶æŠ¥äº†ä¸€ä¸ªè«åå…¶å¦™çš„é”™è¯¯ï¼š \u003ccode\u003eNoSuchMethodError\u003c/code\u003e, æŠ¥é”™çš„åœ°æ–¹æ˜¯ rxjava3 çš„ \u003ccode\u003eDisposable.disposed()\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eE/AndroidRuntime: FATAL EXCEPTION: main\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    Process: com.github.hanlyjiang.sample, PID: \u003cspan style=\"color:#ae81ff\"\u003e7357\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    java.lang.NoSuchMethodError: No static method disposed\u003cspan style=\"color:#f92672\"\u003e()\u003c/span\u003eLio/reactivex/rxjava3/disposables/Disposable; in class Lio/reactivex/rxjava3/disposables/Disposable; or its super classes \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003edeclaration of \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;io.reactivex.rxjava3.disposables.Disposable\u0026#39;\u003c/span\u003e appears in /data/app/~~veR3ZUFYzXjZ48FDcAW0Nw\u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e/com.github.hanlyjiang.sample-bhuZG0wVNdVKs_mfxOh5gg\u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e/base.apk\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at com.github.hanlyjiang.lib_mod.ViewTest.disposable\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eViewTest.java:8\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at com.github.hanlyjiang.sample.MainActivity.lambda$onCreate$0\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eMainActivity.java:15\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at com.github.hanlyjiang.sample.MainActivity$$ExternalSyntheticLambda0.onClick\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eUnknown Source:0\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.view.View.performClick\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eView.java:7456\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at com.google.android.material.button.MaterialButton.performClick\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eMaterialButton.java:1119\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.view.View.performClickInternal\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eView.java:7433\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.view.View.access$3700\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eView.java:836\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.view.View$PerformClick.run\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eView.java:28832\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.os.Handler.handleCallback\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eHandler.java:938\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.os.Handler.dispatchMessage\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eHandler.java:99\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.os.Looper.loopOnce\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eLooper.java:201\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.os.Looper.loop\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eLooper.java:288\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at android.app.ActivityThread.main\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eActivityThread.java:7902\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at java.lang.reflect.Method.invoke\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eNative Method\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eRuntimeInit.java:548\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        at com.android.internal.os.ZygoteInit.main\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eZygoteInit.java:933\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eâ° Tip\u003c/strong\u003e\u003c/p\u003e","title":" AAR Java8 æ¥å£ NoSuchMethodError é”™è¯¯è§£å†³è®°å½•"},{"content":"æœ¬æ–‡ä¸»è¦æè¿°å¦‚ä½•ä½¿ç”¨Daggerè§£å†³å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜æ˜¯ï¼š\nå¦‚ä½•åœ¨åº“ï¼ˆSDKï¼‰æ¨¡å—ä¸­ä½¿ç”¨Daggerä¾èµ–æ³¨å…¥ï¼Ÿ MVPä¸­çš„Daggerä¾èµ–æ³¨å…¥å¦‚ä½•å®ç°æ— æ„Ÿæ³¨å…¥ï¼Ÿ æœ¬æ–‡ä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨Daggerï¼Œåªä¸“æ³¨äºæè¿°å¦‚ä¸Šä¸¤ä¸ªé—®é¢˜çš„è§£å†³çš„å‰å› åæœåŠè§£å†³æ–¹æ¡ˆã€‚\nèƒŒæ™¯ æ¥æ‰‹å¼€å‘ä¸€ä¸ªSDKï¼Œå¤§è‡´æƒ…å†µå¦‚ä¸‹ï¼š\nè¯¥SDKå†…éƒ¨æœ‰è‹¥å¹²ç•Œé¢ï¼ŒåŒ…æ‹¬Activityï¼ŒFragmentç­‰ ä½¿ç”¨MVPæ¶æ„ é€æ¸å‘ç°å†…éƒ¨ä¾èµ–æ··ä¹±ï¼Œåœ¨å¾—ç©ºåï¼Œé‚å¯¹å…¶ä¾èµ–éƒ¨åˆ†è¿›è¡Œé‡æ„æ”¹é€ ã€‚\nä¸ºä»€ä¹ˆä½¿ç”¨ä¾èµ–æ³¨å…¥è¿›è¡Œæ”¹é€ ï¼Ÿ ä¸»è¦æ˜¯ä¾èµ–æ··ä¹±ï¼Œå•ä¾‹çš„æ»¥ç”¨å¯¼è‡´ä¾èµ–å…³ç³»ä¸æ˜æ˜¾ï¼Œæ— æ³•ç®¡ç†ï¼Œæ— æ³•æµ‹è¯•\næŸäº›å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨å¾ˆå¤šç±»ä¸­éƒ½éœ€è¦ä½¿ç”¨ï¼Œå¦‚ Retrofit çš„è¯·æ±‚å¯¹è±¡ï¼Œä»£è¡¨ä¿¡æ¯çš„æ ‡è¯†å­—æ®µç­‰ï¼Œæ­¤æ—¶ä¸ºäº†é¿å…é€šè¿‡æ„é€ å‡½æ•°æˆ–è€…setteræ–¹æ³•æ¥ä¼ é€’ï¼Œå°±ç›´æ¥èµ·äº†ä¸ªå•ä¾‹ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–ç±»ä¼¼çš„æƒ…å†µï¼Œæœ€ç»ˆå¯¼è‡´å•ä¾‹æœ‰10å¤šä¸ªï¼Œè°ƒç”¨å•ä¾‹ getInstance çš„åœ°æ–¹æ›´æ˜¯æ•°ä¸èƒœæ•°ã€‚\nå¯¼è‡´æˆ‘ä»¬è¦å¯¹å¯¹åº”çš„ä»£ç è¿›è¡Œå•å…ƒæµ‹è¯•åšmockæ“ä½œå¼‚å¸¸å›°éš¾ï¼Œ\nå› ä¸ºä¾èµ–å…³ç³»å¤ªä¸æ˜æ˜¾ï¼Œå‡ ä¹å¾—ä¸€è¡Œè¡Œæ‰¾æ‰èƒ½æ‰¾åˆ°ç±»æˆ–æ–¹æ³•åˆ°åº•ä¾èµ–äº†å“ªäº›å¯¹è±¡ åŒæ—¶mockçš„è¿‡ç¨‹ä¹Ÿå˜å¾—éº»çƒ¦ï¼Œç”±äºæ²¡æœ‰ä½œä¸ºç±»æˆå‘˜ï¼Œæ‰€ä»¥æ— æ³•ç®€å•é€šè¿‡mockæ›¿æ¢\få¯¹åº”æˆå‘˜ï¼› ä¾èµ–æ³¨å…¥æ”¹é€ çš„é—®é¢˜ç‚¹ ä¸»è¦æœ‰å¦‚ä¸‹é—®é¢˜ï¼š\n1.Â æ²¡æœ‰Applicationã€‚è¯¥æ¨¡å—ä¸ºSDKï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥ä¿®æ”¹Applicationå¯¹è±¡ï¼ŒApplicationä¸ºé›†æˆæ–¹è‡ªè¡Œç¼–å†™ã€‚\n2. MVPçš„ç»‘å®šã€‚MVPç»‘å®šä¸­æ¨¡æ¿ä»£ç è¾ƒå¤šï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å°½å¯èƒ½çš„å®ç°æ— æ„Ÿçš„æ³¨å…¥ã€‚\nä¹‹æ‰€ä»¥æç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºGoogle é’ˆå¯¹Androidï¼Œåœ¨Daggerçš„åŸºç¡€ä¸Šé’ˆå¯¹æ€§çš„æ„å»ºäº†ä¸€ä¸ªHilt çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œèƒ½å¤Ÿå‡å°‘Androidä¸­ç›´æ¥ä½¿ç”¨Daggerçš„æ¨¡æ¿ä»£ç ã€‚ä½†æ˜¯Hiltçš„ä½¿ä¸­æœ‰è¦æ±‚ï¼š\næ‰€æœ‰ä½¿ç”¨ Hilt çš„åº”ç”¨éƒ½å¿…é¡»åŒ…å«ä¸€ä¸ªå¸¦æœ‰ @HiltAndroidApp æ³¨é‡Šçš„ Application ç±»ã€‚\nå‚è€ƒï¼š ä½¿ç”¨ Hilt å®ç°ä¾èµ–é¡¹æ³¨å…¥ | Android å¼€å‘è€… | Android Developers (google.cn)\nä¹Ÿå°±æ˜¯å¿…é¡»èƒ½æ§åˆ¶ä½Applicationï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬ä½œä¸ºä¸€ä¸ªSDKçš„æä¾›æ–¹ï¼š\næ˜¯æ²¡æœ‰æœºä¼šä¿®æ”¹Applicationçš„ä»£ç çš„ è€Œä¸”ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½è¦æ±‚ä½¿ç”¨æ–¹å»åšè¿™ç§é™åˆ¶ï¼›åŒæ—¶ï¼Œå¦‚æœä½¿ç”¨æ–¹æœ‰ä½¿ç”¨ Hilt å‘¢ï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦ä¼šå¯¹å…¶äº§ç”Ÿå½±å“ï¼Ÿ æ•…ï¼Œæˆ‘ä»¬åªèƒ½ç›´æ¥ä½¿ç”¨Daggerã€‚\nè€Œå¦å¤–ä¸€ä¸ªé—®é¢˜åœ¨äºMVPçš„æ¶æ„é™åˆ¶ï¼ŒP å±‚éœ€è¦æŒæœ‰Vå±‚çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯Pä¾èµ–Vï¼Œè€ŒVé€šå¸¸æ˜¯Activityæˆ–è€…Fragmentï¼Œè€ŒActivityåŠFragmentçš„åˆ›å»ºè¿‡ç¨‹ç”±Androidç³»ç»Ÿæ§åˆ¶ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨Daggeræ—¶æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›æ¨¡æ¿ä»£ç ï¼ˆä¸‹æ–¹ä¼šè¯´æ˜ï¼‰ï¼Œå°† ActivityåŠFragmentå¯¹è±¡æ³¨å…¥åˆ° Dagger çš„ä¾èµ–å›¾è°±ä¸­ã€‚\næ²¡æœ‰ Application çš„é—®é¢˜è§£å†³ é¦–å…ˆï¼Œæˆ‘ä»¬è¦è§£å†³çš„æ˜¯æ²¡æœ‰Applicationçš„é—®é¢˜ï¼Œé‚£ä¹ˆæ²¡æœ‰Applicationä¼šç»™æˆ‘ä»¬å¸¦æ¥å“ªäº›é—®é¢˜å‘¢ï¼Ÿ\næ— æ³•ä½¿ç”¨ Hilt æ— æ³•ç›´æ¥ä½¿ç”¨ dagger-android è¿™ä¸¤ä¸ªé—®é¢˜å®é™…ä¸Šæ˜¯ç±»ä¼¼çš„ï¼ŒHiltåŠDagger-Androidéƒ½æ˜¯ç”¨äºè§£å†³ Android ç»„ä»¶ï¼ˆActivityï¼ŒFragmentï¼ŒServiceï¼ŒBroadcastReceiver ç­‰ï¼‰çš„ä¾èµ–æ³¨å…¥çš„ã€‚ä½†æ˜¯ä»–ä»¬éƒ½è¦æ±‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ Applicationã€‚\nä¸ºä»€ä¹ˆä¸€å®šè¦Applicationï¼Ÿ é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ dagger-android çš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™é‡Œå‚è€ƒ [Google çš„ç¤ºä¾‹](architecture-components-samples/GithubBrowserSample at master Â· android/architecture-components-samples) è¿›è¡Œè¯´æ˜ã€‚\nDagger-Android çš„ä½¿ç”¨ è¿™é‡Œæˆ‘ä»¬çœç•¥ gradle ä¾èµ–çš„å¼•å…¥éƒ¨åˆ†ï¼Œç›´æ¥è§£é‡Šä»£ç ã€‚\n1. Application è¿›è¡Œæ”¹é€  å¦‚ä¸‹ä»£ç æ‰€è¿°ï¼Œä¸»è¦æœ‰å¦‚ä¸‹ä¿®æ”¹ï¼š\nä»¤ Application å®ç° HasActivityInjector æ¥å£ï¼› Application ä¸­æ³¨å…¥ä¸€ä¸ªç±»å‹ä¸º DispatchingAndroidInjector\u0026lt;Activity\u0026gt; çš„æˆå‘˜ï¼ŒåŒæ—¶é€šè¿‡HasActivityInjectoræ¥å£å®šä¹‰çš„é‡è½½æ–¹æ³• activityInjector() è¿”å›è¯¥æˆå‘˜ã€‚ åœ¨ Application.onCreate ä¸­è°ƒç”¨ AppInjector.init(this) æ‰§è¡Œæ³¨å…¥æ“ä½œã€‚ è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå°±å®Œæ¯•äº†ï¼Œä¹‹åå°±å¯ä»¥ä½¿ç”¨Dagger æ— æ„Ÿæ³¨å…¥Activityæˆ–è€…Fragmentäº†ã€‚\nclass GithubApp : Application(), HasActivityInjector { @Inject lateinit var dispatchingAndroidInjector: DispatchingAndroidInjector\u0026lt;Activity\u0026gt; override fun onCreate() { super.onCreate() if (BuildConfig.DEBUG) { Timber.plant(Timber.DebugTree()) } AppInjector.init(this) } override fun activityInjector() = dispatchingAndroidInjector } AppInjector.init çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯ï¼š\nåœ¨ Activity Create çš„æ—¶å€™è°ƒç”¨ AndroidInjection.inject(activity) åŠ åœ¨ Fragment Create çš„æ—¶å€™è°ƒç”¨ AndroidSupportInjection.inject(f) object AppInjector { fun init(githubApp: GithubApp) { DaggerAppComponent.builder().application(githubApp) .build().inject(githubApp) githubApp .registerActivityLifecycleCallbacks(object : Application.ActivityLifecycleCallbacks { override fun onActivityCreated(activity: Activity, savedInstanceState: Bundle?) { handleActivity(activity) } }) } private fun handleActivity(activity: Activity) { if (activity is HasSupportFragmentInjector) { AndroidInjection.inject(activity) } if (activity is FragmentActivity) { activity.supportFragmentManager .registerFragmentLifecycleCallbacks( object : FragmentManager.FragmentLifecycleCallbacks() { override fun onFragmentCreated(fm: FragmentManager,f: Fragment,savedInstanceState: Bundle? ) { if (f is Injectable) { AndroidSupportInjection.inject(f) } } }, true ) } } } AndroidInjection.inject åŠ AndroidSupportInjection.injectä¸º dagger-android æä¾›çš„æ¥å£ï¼Œæˆ‘ä»¬åç»­è¿›è¡Œåˆ†æã€‚\n2. ä½¿ç”¨ å†å®Œæˆä¸Šè¿°å‡†å¤‡å·¥ä½œä¹‹åï¼Œè¦æƒ³è®©Activityæˆ–è€…Fragmentèƒ½å¤Ÿè‡ªåŠ¨æ³¨å…¥ï¼Œåªéœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼ˆæˆ‘ä»¬åŒæ ·è¿˜æ˜¯å‚è€ƒGoogleç¤ºä¾‹ä»£ç ï¼‰\nåœ¨ Module ä¸­ä½¿ç”¨@ContributesAndroidInjector æ ‡è®°ä¸€ä¸ªè¿”å›å¯¹åº”Activityï¼ˆå¦‚MainActivityï¼‰çš„æ–¹æ³• // https://github.com/android/architecture-components-samples/blob/master/GithubBrowserSample/app/src/main/java/com/android/example/github/di/MainActivityModule.kt @Module abstract class MainActivityModule { @ContributesAndroidInjector(modules = [FragmentBuildersModule::class]) abstract fun contributeMainActivity(): MainActivity } å½“ç„¶è¿˜éœ€è¦å°†è¿™ä¸ªModuleåŒ…å«åˆ° AppComponentä¸­ï¼ˆåŒæ—¶ AppComponentä¸­éœ€è¦åŒ…å« AndroidInjectionModuleè¿™ä¸ª dagger-android æä¾›çš„moduleï¼‰ // https://github.com/android/architecture-components-samples/blob/master/GithubBrowserSample/app/src/main/java/com/android/example/github/di/AppComponent.kt @Singleton @Component( modules = [ AndroidInjectionModule::class, MainActivityModule::class] ) interface AppComponent { // åˆ é™¤å…¶ä»–éƒ¨åˆ† } 3. æ€»ç»“ ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨dagger-androidæ—¶ï¼Œåœ¨å®Œæˆäº†å‡†å¤‡åŠ¨ä½œä¹‹åï¼Œåç»­åªéœ€è¦æ·»åŠ ä¸€ä¸ª @ContributesAndroidInjector æ³¨è§£çš„æ–¹æ³•ï¼Œå°±å¯ä»¥è®©ä½ çš„Activityæ”¯æŒè‡ªåŠ¨ä¾èµ–æ³¨å…¥ã€‚\nä¸ºä»€ä¹ˆéœ€è¦ Application ä¸Šé¢ä»‹ç»äº† dagger-android çš„ä½¿ç”¨æ–¹å¼ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†å±•ç¤ºåœ¨ä½¿ç”¨Dagger-Androidä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ— éœ€å¯¹Activityè¿›è¡Œä¿®æ”¹ï¼Œå°±å¯ä»¥è‡ªåŠ¨å‘å…¶ä¸­æ³¨å…¥ä¾èµ–ã€‚ è¿™é‡Œçš„ä¿®æ”¹å®é™…ä¸ŠæŒ‡çš„æ˜¯æ‰‹åŠ¨åœ¨æ¯ä¸ªActivity çš„ onCreate æ–¹æ³•è°ƒç”¨Daggerç»„ä»¶çš„æ³¨å…¥æ–¹æ³•ã€‚\nä½†æ˜¯æˆ‘ä»¬çš„é—®é¢˜å¹¶æ²¡æœ‰å¾—åˆ°å›ç­”ï¼Œå³ï¼š\nä¸ºä»€ä¹ˆéœ€è¦Applicationï¼Ÿ\nç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸‹ AndroidInjection.inject(activity) çš„å®ç°ï¼š(AndroidInjection ä¸ºdagger-android åº“æä¾›çš„è¾…åŠ©å·¥å…·ç±»)\npublic static void inject(Activity activity) { checkNotNull(activity, \u0026#34;activity\u0026#34;); Application application = activity.getApplication(); if (!(application instanceof HasActivityInjector)) { throw new RuntimeException( String.format( \u0026#34;%s does not implement %s\u0026#34;, application.getClass().getCanonicalName(), HasActivityInjector.class.getCanonicalName())); } AndroidInjector\u0026lt;Activity\u0026gt; activityInjector = ((HasActivityInjector) application).activityInjector(); checkNotNull(activityInjector, \u0026#34;%s.activityInjector() returned null\u0026#34;, application.getClass()); activityInjector.inject(activity); } ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†å¦‚ä¸‹æ­¥éª¤ï¼š\nç”±Activityè·å–Applicationï¼› åˆ¤æ–­ Application æ˜¯å¦å®ç°äº† HasActivityInjector ä» Application è·å– AndroidInjector\u0026lt;Activity\u0026gt;ï¼Œç„¶åä½¿ç”¨æ­¤å¯¹è±¡æ‰§è¡Œå¯¹ç›®æ ‡Activityçš„æ³¨å…¥ã€‚ å¦å¤–ï¼ŒAndroidInjection ç±»è¿˜æœ‰å¯¹ Serviceï¼ŒFragmentç­‰çš„æ³¨å…¥è¾…åŠ©æ–¹æ³•ï¼Œè¿‡ç¨‹ä¸­ä¹Ÿéƒ½ç±»ä¼¼å¯¹Activityçš„æ³¨å…¥ï¼Œä¼šè·å– Application å¯¹è±¡ï¼Œç„¶åä»Applicationå¯¹è±¡ä¸­è·å–AndroidInejctorï¼Œå†ç”¨æ­¤å¯¹è±¡è¿›è¡Œç›®æ ‡ç»„ä»¶çš„ä¾èµ–æ³¨å…¥ã€‚\næ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ä¸ºä»€ä¹ˆä¸€å®šè¦Applicationäº†ï¼š\nå®é™…ä¸Šï¼Œæ˜¯éœ€è¦å…¶ä¸­çš„ AndroidInjector ï¼› åœ¨å„ç§Androidç»„ä»¶ä¸­ï¼ˆActivityï¼ŒServiceï¼Œç­‰ï¼‰æˆ‘ä»¬éƒ½èƒ½ç›´æ¥é€šè¿‡å…¶è·å–åˆ°Applicationå¯¹è±¡ï¼Œè¿™æ ·å°±èƒ½æ‰¾åˆ°å­˜åœ¨äºApplicationä¸­çš„ AndroidInjectorï¼Œç„¶åæ‰§è¡Œæ³¨å…¥æ“ä½œã€‚ æ‰©å±• - AndroidInjector å“ªé‡Œæ¥çš„ï¼Ÿ é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†ä¸ºä»€ä¹ˆ dagger-android ä¸€å®šéœ€è¦Applicationï¼Œæ˜¯ä¸ºäº†è·å–å…¶ä¸­çš„AndroidInjector ç”¨æ¥æ‰§è¡Œç›®æ ‡Androidç»„ä»¶çš„æ³¨å…¥æ“ä½œã€‚\né‚£ä¹ˆï¼Œè¿™ä¸ª AndroidInjector æ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ\nç”±å‰é¢çš„GithubAppä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ª AndroidInject å°±æ˜¯Applicationä¸­ä½¿ç”¨äº† @Inject æ ‡è®°çš„ç±»å‹ä¸º DispatchingAndroidInjector\u0026lt;Activity\u0026gt; çš„å¯¹è±¡\n// AndroidInjection.inject(activity) AndroidInjector\u0026lt;Activity\u0026gt; activityInjector = ((HasActivityInjector) application).activityInjector(); // GithubApp @Inject lateinit var dispatchingAndroidInjector: DispatchingAndroidInjector\u0026lt;Activity\u0026gt; override fun activityInjector() = dispatchingAndroidInjector æˆ‘ä»¬å»Dagger çš„ç”Ÿæˆä»£ç ä¸­( DaggerAppComponent )ä¸­æŸ¥æ‰¾å¯¹åº”çš„ç±»å‹ DispatchingAndroidInjector\u0026lt;Activity\u0026gt;\n// DaggerAppComponent.java private DispatchingAndroidInjector\u0026lt;Activity\u0026gt; getDispatchingAndroidInjectorOfActivity() { return DispatchingAndroidInjector_Factory.newDispatchingAndroidInjector( getMapOfClassOfAndProviderOfFactoryOf()); } private GithubApp injectGithubApp(GithubApp instance) { GithubApp_MembersInjector.injectDispatchingAndroidInjector( instance, getDispatchingAndroidInjectorOfActivity()); return instance; } @Override public void inject(GithubApp githubApp) { injectGithubApp(githubApp); } // GithubApp_MembersInjector.java @Override public void injectMembers(GithubApp instance) { injectDispatchingAndroidInjector(instance, dispatchingAndroidInjectorProvider.get()); } public static void injectDispatchingAndroidInjector( GithubApp instance, DispatchingAndroidInjector\u0026lt;Activity\u0026gt; dispatchingAndroidInjector) { instance.dispatchingAndroidInjector = dispatchingAndroidInjector; } å¯ä»¥çœ‹åˆ° DaggerAppComponentä¸­åœ¨æ³¨å…¥inject(GithubApp)æ—¶ï¼Œä¼šå°†DispatchingAndroidInjector\u0026lt;Activity\u0026gt; ç±»å‹çš„ä¾èµ–æ³¨å…¥åˆ° GithubApp ä¸­ã€‚\næ›´å¤šç»†èŠ‚ï¼š\ndagger-android-processor å¤„ç†å…¶ä¼šæ ¹æ® @ContributesAndroidInjector è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªModuleçš„ä»£ç ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n@Module(subcomponents = MainActivityModule_ContributeMainActivity.MainActivitySubcomponent.class) public abstract class MainActivityModule_ContributeMainActivity { private MainActivityModule_ContributeMainActivity() {} @Binds @IntoMap @ActivityKey(MainActivity.class) abstract AndroidInjector.Factory\u0026lt;? extends Activity\u0026gt; bindAndroidInjectorFactory( MainActivitySubcomponent.Builder builder); @Subcomponent(modules = FragmentBuildersModule.class) public interface MainActivitySubcomponent extends AndroidInjector\u0026lt;MainActivity\u0026gt; { @Subcomponent.Builder abstract class Builder extends AndroidInjector.Builder\u0026lt;MainActivity\u0026gt; {} } } æ­¤æ¨¡å—ä¸­å®šä¹‰äº† bindAndroidInjectorFactory æ–¹æ³•ï¼Œä½¿ç”¨ @Binds @IntoMapç”Ÿæˆ Map\u0026lt;Class\u0026lt;? extends T\u0026gt;, Provider\u0026lt;AndroidInjector.Factory\u0026lt;? extends T\u0026gt;\u0026gt;\u0026gt; ç±»å‹çš„Map åœ¨è¿™é‡Œæ³¨å…¥åˆ°Mapä¸­çš„å†…å®¹å°±æ˜¯ (MainActivity.class, MainActivitySubcomponent.Builder builder), å…¶ä¸­ MainActivitySubcomponent.Builder ç”¨äºæ„å»º MainActivitySubcomponent MainActivitySubcomponent ç»§æ‰¿äº† AndroidInjector\u0026lt;MainActivity\u0026gt; ç±»ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€ä¸ª inject(MainActivity instance)çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æœ€ä¸­å®ç°å¯¹ MainActivity ä¾èµ–æ³¨å…¥çš„å®ç°å…¥å£ï¼› åŒæ—¶ dagger-android ä¸­çš„DispatchingAndroidInjector ç±»ä¸­ï¼Œä¼šå£°æ˜å¯¹ ç±»å‹Map\u0026lt;Class\u0026lt;? extends T\u0026gt;, Provider\u0026lt;AndroidInjector.Factory\u0026lt;? extends T\u0026gt;\u0026gt;\u0026gt; çš„ä¾èµ–ï¼Œæ‰€ä»¥ä¸Šé¢çš„(MainActivity.class, MainActivitySubcomponent.Builder builder)ä¼šè‡ªåŠ¨è¢«æ³¨å…¥åˆ° DispatchingAndroidInjector å¯¹è±¡ä¸­\npublic final class DispatchingAndroidInjector\u0026lt;T\u0026gt; implements AndroidInjector\u0026lt;T\u0026gt; { private final Map\u0026lt;Class\u0026lt;? extends T\u0026gt;, Provider\u0026lt;AndroidInjector.Factory\u0026lt;? extends T\u0026gt;\u0026gt;\u0026gt; injectorFactories; @Inject DispatchingAndroidInjector( Map\u0026lt;Class\u0026lt;? extends T\u0026gt;, Provider\u0026lt;AndroidInjector.Factory\u0026lt;? extends T\u0026gt;\u0026gt;\u0026gt; injectorFactories) { this.injectorFactories = injectorFactories; } } è€Œè¿™ä¸ª DispatchingAndroidInjector\u0026lt;Activity\u0026gt; åœ¨ GithubAppä¸­è¢«å£°æ˜ä¸ºä¾èµ–ï¼Œæ‰€ä»¥ä¹Ÿä¼šè¢«è‡ªåŠ¨æ³¨å…¥ï¼Œä»è€Œæˆ‘ä»¬èƒ½åœ¨GithubAppä¸­é€šè¿‡ AndroidInjection è·å–åˆ° DispatchingAndroidInjector\u0026lt;Activity\u0026gt;, ç„¶åè°ƒç”¨å…¶ MainActivitySubcomponent ï¼Œç„¶åè°ƒç”¨å…¶ inject æ–¹æ³•å®Œæˆæ³¨å…¥\npublic final class DispatchingAndroidInjector\u0026lt;T\u0026gt; implements AndroidInjector\u0026lt;T\u0026gt; { public boolean maybeInject(T instance) { Provider\u0026lt;AndroidInjector.Factory\u0026lt;? extends T\u0026gt;\u0026gt; factoryProvider = // instance ç±»å‹ä¸º MainActivityï¼Œæ‰€ä»¥å¯ä»¥è·å–åˆ° Provider\u0026lt;MainActivitySubcomponent.Builder\u0026gt; injectorFactories.get(instance.getClass()); // è¿™é‡Œå°±é€šè¿‡ MainActivitySubcomponent.Builder è·å–åˆ° factory = MainActivitySubcomponent.Builder AndroidInjector.Factory\u0026lt;T\u0026gt; factory = (AndroidInjector.Factory\u0026lt;T\u0026gt;) factoryProvider.get(); try { AndroidInjector\u0026lt;T\u0026gt; injector = checkNotNull( factory.create(instance), \u0026#34;%s.create(I) should not return null.\u0026#34;, factory.getClass()); // ä¸Šé¢è°ƒç”¨ factory.create(instance) å°±æ˜¯è°ƒç”¨ MainActivitySubcomponent.Builder.create æ–¹æ³•åˆ›å»º MainActivitySubcomponent // è¿™é‡Œçš„ inejctor å°±æ˜¯ MainActivitySubcomponent // ç„¶åé€šè¿‡ MainActivitySubcomponent çš„ inejct(MainActivity) æ–¹æ³•æ¥å®ç°å¯¹ MainActivity çš„æ³¨å…¥ injector.inject(instance); return true; } catch (ClassCastException e) { throw new InvalidInjectorBindingException( String.format( \u0026#34;%s does not implement AndroidInjector.Factory\u0026lt;%s\u0026gt;\u0026#34;, factory.getClass().getCanonicalName(), instance.getClass().getCanonicalName()), e); } } } æ€»ç»“ ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹å‰é¢çš„å†…å®¹æ€»ç»“ä¸€ä¸‹ï¼š\ndagger-android ä¸ºäº†å®ç°å¯¹äºActivityç­‰Androidç»„ä»¶çš„æ— æ„Ÿæ³¨å…¥ï¼Œå°†Activityç­‰æ³¨å…¥çš„å®ç°Componentæ”¾åœ¨äº†Applicationçš„æˆå‘˜å˜é‡ä¸­\nè§£å†³æ–¹æ¡ˆ ä¹‹æ‰€ä»¥é€‰æ‹©Applicationå¯¹è±¡ï¼Œæ˜¯å› ä¸ºå…¶ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒæŒä¹…ï¼Œå’Œåº”ç”¨ä¸€è‡´ã€‚è€Œä¸ºäº†å¯¹Activityå®ç°æ— æ„Ÿæ³¨å…¥ï¼Œä½¿ç”¨åˆ°çš„åªæ˜¯è¢«æ³¨å…¥åˆ°Applicationä¸­çš„ DispatchingAndroidInjector å¯¹è±¡ã€‚\næ•…æˆ‘ä»¬å¯ä»¥å°†Applicationæ›¿æ¢ä¸ºä»»æ„ä¸€ä¸ªé™æ€çš„å¯¹è±¡å³å¯ï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š\npublic class SdkContainer implements HasAndroidInjector { @Inject protected DispatchingAndroidInjector\u0026lt;Object\u0026gt; androidInjector; @Override public AndroidInjector\u0026lt;Object\u0026gt; androidInjector() { return androidInjector; } } public class SdkInjector { private static final String TAG = \u0026#34;SdkInjector\u0026#34;; private static SdkContainer sSdkContainer; public static SdkContainer getSdkContainer() { return sSdkContainer; } public static void init(Application application) { if (sSdkContainer != null) { return; } SdkComponent sSdkComponent = DaggerSdkComponent.builder() .application(application) .build(); SdkInjector.sSdkContainer = new SdkContainer(sSdkComponent); sSdkComponent.inject(sSdkContainer); } } @Singleton @Component( modules = { AndroidInjectionModule.class,} ) public interface SdkComponent { void inject(SdkContainer sdkContainer); @Component.Builder interface Builder { @BindsInstance Builder application(Application application); SdkComponent build(); } } MVP æ¶æ„çš„æ³¨å…¥é—®é¢˜ MVP ä¸­çš„æ³¨å…¥é—®é¢˜ï¼Ÿ ä¸€ä¸ª Presenter çš„ä¸€èˆ¬æ„é€ æ–¹å¼å¦‚ä¸‹ï¼š\npublic class TestDiMvpActivityPresenter { public TestDiMvpActivityPresenter(TestDiView view) {} } public class TestDiMvpActivity extends Activity implements TestDiView { } å¯ä»¥çœ‹åˆ°Presenteræ„é€ æ—¶éœ€è¦ä¸€ä¸ªTestDiViewï¼Œè€Œè¿™ä¸ªTestDiViewå®é™…ä¸Šæ˜¯ TestDiMvpActivityï¼Œè€Œæˆ‘ä»¬æ— æ³•æ‰‹åŠ¨æ„é€  TestDiMvpActivity çš„å®ä¾‹ï¼Œåªèƒ½ç­‰ç³»ç»Ÿåˆ›å»ºä¹‹åæ‰èƒ½è·å–å®ä¾‹ï¼Œç„¶åè¿›è¡Œæ³¨å…¥ï¼Œæ‰€ä»¥ä¸€èˆ¬MVPçš„æ³¨å…¥å†™æ³•å¦‚ä¸‹ï¼š\nMVP æ³¨å…¥çš„ä¸€èˆ¬å†™æ³• å®šä¹‰å­ç»„ä»¶åŠæ¨¡å— // ä¿®æ”¹ç‚¹1âƒ£ï¸ @Module( subcomponents = TestDiMvpActivityModule.MvpComponent.class ) public interface TestDiMvpActivityModule { @Module class MvpModule { TestDiMvpActivityPresenter.TestDiView testDiView; public MvpModule(TestDiMvpActivityPresenter.TestDiView testDiView) { this.testDiView = testDiView; } @Provides public TestDiMvpActivityPresenter.TestDiView providerView() { return testDiView; } } @Subcomponent(modules = MvpModule.class) interface MvpComponent { void inject(TestDiMvpActivity activity); @Subcomponent.Builder interface Builder { MvpComponent build(); Builder module(MvpModule mvpModule); } } } åœ¨ RootComponent ä¸­æ³¨å†Œæ¨¡å—å¹¶æä¾›Builderè·å–å‡½æ•° @Singleton @Component( modules = { // ä¿®æ”¹ç‚¹2âƒ£ï¸ TestDiMvpActivityModule.class, } ) public interface SdkComponent { // ä¿®æ”¹ç‚¹3âƒ£ï¸ TestDiMvpActivityModule.MvpComponent.Builder testDiMvpActivityMComponentBuilder(); @Component.Builder interface Builder { } } ä½¿ç”¨æ—¶åœ¨ TestDiMvpActivity.onCreate ä¸­ public class TestDiMvpActivity extends Activity implements TestDiMvpActivityPresenter.TestDiView { @Override protected void onCreate(@Nullable Bundle savedInstanceState) { // ä¿®æ”¹ç‚¹4âƒ£ï¸ SdkInjector.getSdkComponent().testDiMvpActivityMComponentBuilder() .module(new TestDiMvpActivityModule.MvpModule(this)).build() .inject(this); super.onCreate(savedInstanceState); } } å…¶å®ç°åŸç†åœ¨äºï¼š\n1. åœ¨Activityè¢«ç³»ç»Ÿåˆå§‹åŒ–ä¹‹åï¼Œåœ¨å…¶onCreateä¸­è·å–å…¶å®ä¾‹Â 2. å°†Activityå®ä¾‹ä¼ å…¥åˆ°MvpModuleä¸­ï¼Œç„¶åç”±MvpModuleä¸­çš„ providers æ–¹æ³•æ¥æä¾› View å±‚å¯¹è±¡Â 3. å°† MvpModuleä½œä¸ºå‚æ•°æ„é€ MvpComponentï¼Œç„¶åä½¿ç”¨MvpComponent çš„inject æ–¹æ³•å¯¹TestDiMvpActivity æ‰§è¡Œæ³¨å…¥åŠ¨ä½œã€‚\nMVP æ³¨å…¥ä¸€èˆ¬å†™æ³•çš„é—®é¢˜ è¿™é‡Œçš„çš„é—®é¢˜åœ¨äºï¼š\n1. æ¯æ·»åŠ ä¸€ä¸ªMvpçš„ç»„ä»¶ï¼Œéƒ½ä¿®æ”¹å››ä¸ªåœ°æ–¹ï¼Œæ·»åŠ èµ·æ¥éå¸¸éº»çƒ¦ï¼Œå®¹æ˜“æ¼æ‰ï¼›Â 2. æ¯æ¬¡æ·»åŠ ç»„ä»¶éƒ½éƒ½éœ€è¦ä¿®æ”¹é¡¶å±‚çš„ Root Componentï¼ˆç¤ºä¾‹ä»£ç ä¸­çš„SdkComponentï¼‰ï¼› 3. éœ€è¦åœ¨æ¯ä¸ªå…·ä½“Mvpç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¦‚MvpActiviyçš„onCreateï¼‰ä¸­æ·»åŠ æ³¨å…¥ä»£ç ï¼Œå¯¼è‡´å…·ä½“çš„å®ç°çŸ¥é“äº†æ³¨å…¥ç»†èŠ‚ï¼› è§£å†³æ–¹æ¡ˆ ä¸Šé¢æåˆ°çš„é—®é¢˜å°±æ˜¯æ–°å¢ä¸€ä¸ªæ”¯æŒæ³¨å…¥çš„MVPç»„ä»¶å¤ªéº»çƒ¦ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ä¸€ç§ä¿®æ”¹ç‚¹å°‘çš„æ–¹æ¡ˆï¼Œè€Œä¸”å¯¹äºç»„ä»¶æ— æ„Ÿçš„æ–¹æ¡ˆã€‚å°±åƒ dagger-android ä¸€æ ·ã€‚\nç°åœ¨æˆ‘ä»¬å…ˆç»™å‡ºæ–¹æ¡ˆï¼Œä»¥ä¾¿èƒ½å¤Ÿå¿«é€Ÿçš„æŸ¥çœ‹è§£å†³æ–¹æ¡ˆçš„å…¨è²Œæ•ˆæœï¼Œç„¶åå†è¯´æ˜å…¶ä¸­çš„å…³é”®ç»†èŠ‚ã€‚\næ•´ä½“æ–¹æ¡ˆç”±å¦‚ä¸‹ä¸»è¦æµç¨‹ï¼š\næä¾›ç»Ÿä¸€çš„Mvpæ¨¡å—åŠç»„ä»¶å£°æ˜ æˆ‘ä»¬å¸Œæœ›æœ€ç»ˆå¢åŠ ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œåªä¿®æ”¹ä¸€ä¸ªåœ°æ–¹ï¼Œä¸ç”¨ä¿®æ”¹ Dagger çˆ¶ç»„ä»¶ï¼Œæ•…æˆ‘ä»¬ç”¨ä¸€ä¸ªç»Ÿä¸€çš„MvpModuleæ¥å®šä¹‰ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªéœ€è¦æ”¯æŒMvpçš„ç»„ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªä¸ºActivityï¼Œä¸€ä¸ªä¸ºFragmentã€‚å¢åŠ ä¸€ä¸ªMvp çš„Activityæˆ–è€…Fragmentæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨MvpProviderä¸­æ·»åŠ ä¸¤ä¸ªæ–¹æ³•å³å¯ï¼Œä¸€ä¸ª@Provideræ ‡è®°ï¼Œå¦å¤–ä¸€ä¸ª @ContributesAndroidInjector æ ‡è®°\næ³¨æ„å…¶ä¸­ç”¨åˆ°äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªAndroidProvider çš„ç±»ï¼Œåé¢æˆ‘ä»¬ä¼šè¯´æ˜æ­¤ç±»çš„ä½œç”¨ï¼š\n@Module(subcomponents = { MvpModule.MvpComponent.class, }) public interface MvpModule { @Module abstract class MvpProvider { @MvpScope @Provides static TestDiMvpActivityPresenter.TestDiView bindTestDiView(@Nullable AndroidProvider\u0026lt;Activity\u0026gt; activityProvider) { if (activityProvider != null) { return (TestDiMvpActivityPresenter.TestDiView) activityProvider.get(); } else { throw new NullPointerException(\u0026#34;Please provider activity provider when build component!\u0026#34;); } } @ContributesAndroidInjector abstract TestDiMvpActivity contributeTestDiMvpActivity(); @MvpScope @Provides static TestDiMvpFragmentPresenter.View bindTestTestDiMvpFragmentView(@Nullable AndroidProvider\u0026lt;Fragment\u0026gt; fragmentAndroidProvider) { // May delete null check to keep code clean since we provide Fragment correctly // if (fragmentAndroidProvider != null) { return (TestDiMvpFragmentPresenter.View) fragmentAndroidProvider.get(); // } else { // throw new NullPointerException(\u0026#34;Please provider Fragment provider when build component!\u0026#34;); // } } /** * æä¾› TestDiMvpFragment çš„æ³¨å…¥æ¥å£ * * @return TestDiMvpFragment */ @ContributesAndroidInjector abstract TestDiMvpFragment contributeTestDiMvpFragment(); } @MvpScope @Subcomponent(modules = { AndroidInjectionModule.class, MvpProvider.class, }) interface MvpComponent { MvpContainer inject(MvpContainer mvpContainer); @Subcomponent.Builder interface Builder { @BindsInstance Builder activityProvider(@Nullable AndroidProvider\u0026lt;Activity\u0026gt; activityProvider); @BindsInstance Builder fragmentProvider(@Nullable AndroidProvider\u0026lt;Fragment\u0026gt; fragmentProvider); MvpComponent build(); } } } /** * Android ç»„ä»¶æä¾›ç­‰ï¼Œä¸»è¦ç”¨äºå»¶è¿Ÿæä¾› * @param \u0026lt;T\u0026gt; ç»„ä»¶ç±»å‹ï¼ˆActivityï¼ŒFragmentï¼‰ç­‰ */ public class AndroidProvider\u0026lt;T\u0026gt; implements Provider\u0026lt;T\u0026gt; { private final T item; public AndroidProvider(T item) { this.item = item; } @Override public T get() { return item; } } æ³¨å†Œåˆ° Root Component æˆ‘ä»¬åªéœ€è¦è¿™ä¹ˆæ³¨å†Œä¸€æ¬¡å³å¯ï¼Œåç»­æ·»åŠ ç»„ä»¶æ—¶æ— éœ€å†ä¿®æ”¹ã€‚\n@Singleton @Component( modules = { // ... // MVP ç»„ä»¶ MvpModule.class } ) public interface SdkComponent { // ... MvpModule.MvpComponent.Builder mvpComponentBuilder(); @Component.Builder interface Builder { // ... } } æ³¨å…¥è¿‡ç¨‹å°è£…éšè— åœ¨ä¹‹å‰æè¿°çš„ä¸€èˆ¬çš„MVP Activity çš„æ³¨å…¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ˜¯åœ¨æ¯ä¸ªå…·ä½“çš„MvpActivityä¸­çš„onCreate æ–¹æ³•ä¸­è¿›è¡Œæ³¨å†Œçš„ï¼Œç°åœ¨æˆ‘ä»¬å°†æ³¨å…¥çš„æµç¨‹éšè—èµ·æ¥ï¼Œæ”¾ç½®åˆ° ActivityLifeCycleCallbacks ä¸­ã€‚\npublic class SdkInjector { private static final String TAG = \u0026#34;SdkInjector\u0026#34;; private static SdkContainer sSdkContainer; public static SdkComponent getSdkComponent() { return sSdkContainer.getSdkComponent(); } public static SdkContainer getSdkContainer() { return sSdkContainer; } /** * åˆå§‹åŒ– DI * * @param application Application */ public static void init(Application application) { if (sSdkContainer != null) { return; } SdkComponent sSdkComponent = DaggerSdkComponent.builder() .application(application) .build(); SdkInjector.sSdkContainer = new SdkContainer(sSdkComponent); sSdkComponent.inject(sSdkContainer); sSdkContainer.testInject(); application.registerActivityLifecycleCallbacks(new BasicActivityLifeCycleCallbacks() { @Override public void onActivityPreCreated(@NonNull Activity activity, @Nullable Bundle savedInstanceState) { injectActivity(activity, savedInstanceState); super.onActivityPreCreated(activity, savedInstanceState); } }); } private static void injectActivity(@NotNull Activity activity, @Nullable Bundle savedInstanceState) { if (activity instanceof MvpInjectable) { // MVP çš„ Activity æ³¨å…¥ MvpModule.MvpComponent mvpActivityComponent = SdkInjector.getSdkComponent() .mvpComponentBuilder().activityProvider(new AndroidProvider\u0026lt;\u0026gt;(activity)).build(); MvpContainer mvpContainer = new MvpContainer(mvpActivityComponent); mvpActivityComponent.inject(mvpContainer); SdkAndroidInjection.inject(activity, mvpContainer); } else if (activity instanceof Injectable) { SdkAndroidInjection.inject(activity); } else { Log.w(TAG, \u0026#34;Warning! You Activity \u0026#34; + activity.getClass().getSimpleName() + \u0026#34;is not injectable! \u0026#34;); } if (activity instanceof FragmentActivity) { final FragmentManager.FragmentLifecycleCallbacks lifecycleCallbacks = new FragmentManager.FragmentLifecycleCallbacks() { @Override public void onFragmentAttached(@NonNull @NotNull FragmentManager fm, @NonNull @NotNull Fragment f, @NonNull @NotNull Context context) { super.onFragmentAttached(fm, f, context); injectFragment(f, activity); } }; ((FragmentActivity) activity).getSupportFragmentManager() .registerFragmentLifecycleCallbacks(lifecycleCallbacks, true); } } private static void injectFragment(@NotNull Fragment f, @NotNull Activity activity) { if (f instanceof Injectable) { SdkAndroidInjection.inject(f); } else if (f instanceof MvpInjectable) { // MVP çš„ Fragment æ³¨å…¥ MvpModule.MvpComponent mvpComponent = SdkInjector.getSdkComponent() .mvpComponentBuilder() .activityProvider(new AndroidProvider\u0026lt;\u0026gt;(activity)) .fragmentProvider(new AndroidProvider\u0026lt;\u0026gt;(f)) .build(); MvpContainer mvpContainer = mvpComponent.inject(new MvpContainer(mvpComponent)); SdkAndroidInjection.inject(f, mvpContainer); } else { Log.w(TAG, \u0026#34;Warning! You fragment \u0026#34; + f.getClass().getSimpleName() + \u0026#34; is not injectable!\u0026#34;); } } } è§£å†³æ–¹æ¡ˆå…³é”®ç‚¹è¯´æ˜ æˆ‘ä»¬è€ƒè™‘ä¸‹æ™®é€šçš„MVPæ³¨å…¥è¿‡ç¨‹ä¸­ä¸ºä»€ä¹ˆéœ€è¦å¦‚æ­¤å¤šçš„æ¨¡æ¿ä»£ç ã€‚\nç”±äºPå±‚ä¾èµ–Vï¼Œè€Œ V å±‚æ˜¯Activityï¼Œæ˜¯ç³»ç»Ÿç”Ÿæˆçš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åªèƒ½åœ¨onCreate å›è°ƒä¸­è·å–åˆ°Activityï¼Œç„¶åå°†å…¶å¡åˆ°Daggerçš„ä¾èµ–å¯¹è±¡çš„å›¾è°±ä¸­ï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ä»£ç æ‰€åšçš„\nå³ï¼Œå¿…é¡»æä¾›ä¸€ä¸ªModuleæ¥æ¥æ”¶Activityå°†å…¶æ”¾å…¥åˆ°Daggerå¯¹è±¡Graphä¸­ï¼ŒåŒæ—¶ä¹Ÿå¿…é¡»åœ¨onCreateä¸­ä½ æ‰èƒ½è·å–åˆ°Activityã€‚\n@Module class MvpModule { TestDiMvpActivityPresenter.TestDiView testDiView; public MvpModule(TestDiMvpActivityPresenter.TestDiView testDiView) { this.testDiView = testDiView; } @Provides public TestDiMvpActivityPresenter.TestDiView providerView() { return testDiView; } } @Override protected void onCreate(@Nullable Bundle savedInstanceState) { SdkInjector.getSdkComponent().testDiMvpActivityMComponentBuilder() // å°†Activityå¡è¿›ä¾èµ–Graph .module(new TestDiMvpActivityModule.MvpModule(this)).build() .inject(this); } å¯¹äºæ— æ³•è‡ªåŠ¨æ³¨å…¥çš„å¯¹è±¡ï¼Œå¿…é¡»è¦é€šè¿‡ Component æä¾›ä¸€ä¸ª inject æ–¹æ³•ï¼Œç„¶åè°ƒç”¨injectæ–¹æ³•å®Œæˆå¯¹å…¶çš„æ‰‹åŠ¨æ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢onCreateæ–¹æ³•ä¸­æ‰€å†™çš„éƒ¨åˆ†ã€‚\næ³¨å…¥é€»è¾‘ç§»åŠ¨åˆ°ActivityLifecycleCallbackå›è°ƒåŠé‡åˆ°çš„é—®é¢˜ å®é™…ä¸Šï¼Œé€šè¿‡å‘Applicationæ³¨å†ŒActivityLifecycleCallbackå›è°ƒï¼Œæˆ‘ä»¬å¯ä»¥å°†å…·ä½“MvpActivityä¸­çš„onCreateé‡Œçš„æ³¨å…¥ä»£ç éšè—èµ·æ¥ï¼Œæˆ‘ä»¬åœ¨ä»”ç»†ç ”ç©¶ä¸‹onCreate ä¸­çš„æ³¨å…¥é€»è¾‘ï¼Œè€ƒè™‘å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜ï¼š\n@Override protected void onCreate(@Nullable Bundle savedInstanceState) { SdkInjector.getSdkComponent() .testDiMvpActivityMComponentBuilder() // å°†Activityå¡è¿›ä¾èµ–Graph // 1âƒ£ï¸ å¡å…¥ .module(new TestDiMvpActivityModule.MvpModule(this)).build() // 2âƒ£ï¸ æ³¨å…¥ .inject(this); } è€ƒè™‘å¦‚ä¸‹ä¸¤ä¸ªåœ°æ–¹ï¼š\nå¡å…¥ï¼šåœ¨æ„é€ TestDiMvpActivityModule.MvpModuleæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä¼ å…¥ä¸€ä¸ªå…·ä½“ç±»å‹ï¼ˆTestDiMvpActivityï¼‰ï¼Œè€Œå¦‚æœæˆ‘ä»¬ç§»åŠ¨åˆ°ActivityLifecycleCallbackä¸­ä¹‹åï¼Œè¿™ä¸ªå…·ä½“çš„ç±»å‹ä¿¡æ¯ä¼šä¸¢å¤±ï¼› æ³¨å…¥ï¼šåœ¨injectæ—¶ï¼Œæˆ‘ä»¬çš„Componentä¸­å®šä¹‰çš„æ–¹æ³•ä¹Ÿæ˜¯éœ€è¦å…·ä½“ç±»å‹ä¿¡æ¯ï¼ˆTestDiMvpActivityï¼‰çš„ï¼Œå› ä¸ºè¿™æ ·Daggeræ‰èƒ½æ ¹æ®å…·ä½“ç±»å‹è·å–å…¶ä¾èµ–å“ªäº›ä¿¡æ¯ï¼Œç”Ÿæˆæ­£ç¡®çš„æ³¨å…¥ä»£ç ï¼Œè€Œç§»åŠ¨åˆ° ActivityLifecycleCallback ä¸­ä¹‹åï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿä¼šä¸¢å¤±ï¼› ä¹Ÿå°±æ˜¯è¯´ï¼Œç§»åŠ¨åˆ° ActivityLifecycleCallbackä¸­ä¹‹åï¼Œå…·ä½“çš„ç±»å‹ä¿¡æ¯ä¸¢å¤±äº†ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•æ­£ç¡®çš„è°ƒç”¨å¡å…¥æ–¹æ³•å’Œæ³¨å…¥æ–¹æ³•ã€‚\nä½¿ç”¨ Dagger-Android ç”Ÿæˆ inject æ¨¡æ¿ä»£ç  å¯¹äºinjectæ–¹æ³•æ¥è¯´ï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥ä½¿ç”¨ Dagger-Android çš„ @ContributesAndroidInjector æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³ï¼›\nä½¿ç”¨åŒ…è£…ç±»å‹é¿å…Daggerç±»å‹æ£€æŸ¥ï¼Œä½¿ç”¨provideræ–¹æ³•è¿˜åŸç±»å‹ä¿¡æ¯ åœ¨å¡å…¥çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºä¸¢å¤±äº†Activityçš„å…·ä½“ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†æ— æ³•é€šè¿‡ç±»å‹æ£€æŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º AndroidProvider çš„åŒ…è£…ç±»å‹ï¼Œæˆ‘ä»¬åœ¨æ„é€ ç»„ä»¶æ—¶ï¼ŒåŸå…ˆéœ€è¦TestDiMvpActivityè¿™ä¸ªå…·ä½“ç±»å‹ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¼ å…¥æˆ‘ä»¬çš„åŒ…è£…ç±»å‹ï¼Œå¯ä»¥åšåˆ°ä»£ç ç»Ÿä¸€ã€‚\n// MVP çš„ Activity æ³¨å…¥ MvpModule.MvpComponent mvpActivityComponent = SdkInjector.getSdkComponent() // TestDiMvpActivity -\u0026gt; new AndroidProvider\u0026lt;Activity\u0026gt;(activity) .mvpComponentBuilder().activityProvider(new AndroidProvider\u0026lt;\u0026gt;(activity)).build(); MvpContainer mvpContainer = new MvpContainer(mvpActivityComponent); mvpActivityComponent.inject(mvpContainer); SdkAndroidInjection.inject(activity, mvpContainer); é‚£ä¹ˆæˆ‘ä»¬ä½•æ—¶å°†å…¶è¿˜åŸå‘¢ï¼Ÿ\nåœ¨æä¾›å¯¹åº”TestDiViewæ—¶ï¼Œæˆ‘ä»¬ç›´æ¥å¯¹å…¶è¿›è¡Œå¼ºåˆ¶è½¬æ¢ï¼Œç„¶åæä¾›ä¸º TestDiView ç±»å‹\n@Module abstract class MvpProvider { @Provides static TestDiMvpActivityPresenter.TestDiView bindTestDiView(@Nullable AndroidProvider\u0026lt;Activity\u0026gt; activityProvider) { if (activityProvider != null) { return (TestDiMvpActivityPresenter.TestDiView) activityProvider.get(); } else { throw new NullPointerException(\u0026#34;Please provider activity provider when build component!\u0026#34;); } } } ç¤ºä¾‹ä»£ç  å…·ä½“å®æ–½è¿‡ç¨‹ä¸­è¿˜æœ‰ä¸€äº›ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒGithubä¸­å¯¹åº”ç¤ºä¾‹æ¨¡å—çš„æºç ã€‚\nandroid-libraries/lib_di_sample at master Â· hanlyjiang/android-libraries (github.com) ","permalink":"https://hanlyjiang.github.io/posts/dagger-zai-android-ku-sdkmo-kuai-zhong-de-shi-yong-shi-jian/","summary":"\u003cp\u003eæœ¬æ–‡ä¸»è¦æè¿°å¦‚ä½•ä½¿ç”¨Daggerè§£å†³å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜æ˜¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå¦‚ä½•åœ¨åº“ï¼ˆSDKï¼‰æ¨¡å—ä¸­ä½¿ç”¨Daggerä¾èµ–æ³¨å…¥ï¼Ÿ\u003c/li\u003e\n\u003cli\u003eMVPä¸­çš„Daggerä¾èµ–æ³¨å…¥å¦‚ä½•å®ç°æ— æ„Ÿæ³¨å…¥ï¼Ÿ\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eæœ¬æ–‡ä¸ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨Daggerï¼Œåªä¸“æ³¨äºæè¿°å¦‚ä¸Šä¸¤ä¸ªé—®é¢˜çš„è§£å†³çš„å‰å› åæœåŠè§£å†³æ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"èƒŒæ™¯\"\u003eèƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæ¥æ‰‹å¼€å‘ä¸€ä¸ªSDKï¼Œå¤§è‡´æƒ…å†µå¦‚ä¸‹ï¼š\u003c/p\u003e","title":"Dagger åœ¨Androidåº“(SDK)æ¨¡å—ä¸­çš„ä½¿ç”¨å®è·µ"},{"content":"å°†gradle è„šæœ¬ä» groovy è¿ç§»åˆ° kotlin dslã€‚\næ¦‚è¿° IDE æ”¯æŒ Build import Syntax highlighting 1 Semantic editor 2 IntelliJ IDEA âœ“ âœ“ âœ“ Android Studio âœ“ âœ“ âœ“ Eclipse IDE âœ“ âœ“ âœ– CLion âœ“ âœ“ âœ– Apache NetBeans âœ“ âœ“ âœ– Visual Studio Code (LSP) âœ“ âœ“ âœ– Visual Studio âœ“ âœ– âœ– Gradle Kotlin DSL scripts ä¸­çš„Kotlinè¯­æ³•é«˜äº® Gradle Kotlin DSL scripts ä¸­æ”¯æŒä»£ç è¡¥å…¨ï¼Œå¯¼èˆªåˆ°æºç ï¼Œæ–‡æ¡£æŸ¥çœ‹ï¼Œé‡æ„ç­‰ç­‰ï¼› Kotlin DSL è„šæœ¬å‘½å å‘½å Groovy DSL script æ–‡ä»¶ä½¿ç”¨ .gradle æ‰©å±•æ–‡ä»¶å\nKotlin DSL script æ–‡ä»¶ä½¿ç”¨ .gradle.kts æ‰©å±•æ–‡ä»¶å\næ¿€æ´»å¹¶ä½¿ç”¨ kotlin dsl å°†è„šæœ¬æ–‡ä»¶å‘½åä¸º .gradle.kts å³å¯æ¿€æ´»ã€‚ä¹Ÿé€‚ç”¨äº settings fileï¼ˆ settings.gradle.kts)å’Œ initialization scripts. ä¸ºäº†å¾—åˆ°æ›´å¥½çš„IDEæ”¯æŒï¼Œå»ºè®®ä½¿ç”¨å¦‚ä¸‹å‘½åçº¦å®šï¼š Settingsè„šæœ¬å‘½åä¸º *.settings.gradle.ktsï¼ˆåŒ…æ‹¬æ‰€æœ‰ä»settingsè„šæœ¬ä¸­å¼•å…¥çš„è„šæœ¬ï¼‰ initialization scripts æŒ‰ *.init.gradle.ktsçš„å‘½åæ¨¡å¼å‘½åï¼Œæˆ–è€…ç®€å•çš„å–åä¸º init.gradle.ktsã€‚ kotlin DSL æ„å»ºè„šæœ¬éšå¼çš„å¯¼å…¥äº†å¦‚ä¸‹å†…å®¹ï¼š default Gradle API imports åœ¨org.gradle.kotlin.dsl å’Œ org.gradle.kotlin.dsl.plugins.dsl åŒ…ä¸­çš„Kotlin DSL API kotlinä¸­è¯»å–è¿è¡Œæ—¶å±æ€§ Gradle Kotlin DSL Primer\ngradle æ‹¥æœ‰ä¸¤ç§è¿è¡Œæ—¶å±æ€§:\nproject properties extra properties é¡¹ç›®å±æ€§ å¯ä»¥é€šè¿‡kotlinçš„ä»£ç†å±æ€§æ¥è®¿é—®:\nbuild.gradle.kts\n// å±æ€§å¿…é¡»å­˜åœ¨ val myProperty: String by project // å±æ€§å¯ä»¥ä¸å­˜åœ¨ val myNullableProperty: String? by project extra å±æ€§ extraå±æ€§åœ¨ä»»æ„å®ç°äº†ExtensionAware æ¥å£çš„å¯¹è±¡ä¸Šéƒ½å¯ä»¥è®¿é—®;\nbuild.gradle.kts\nval myNewProperty by extra(\u0026#34;initial value\u0026#34;) // â¶ val myOtherNewProperty by extra { \u0026#34;calculated initial value\u0026#34; } //â· val myProperty: String by extra // â¸ val myNullableProperty: String? by extra // â¹ â¶ åœ¨å½“å‰ä¸Šä¸‹æ–‡(å½“å‰ä¸ºprojectä¸­)åˆ›å»ºä¸€ä¸ªåä¸ºmyNewPropertyæ–°çš„extraå±æ€§,å¹¶ä¸”åˆå§‹åŒ–å…¶å€¼ä¸º \u0026ldquo;initial value\u0026rdquo;\nâ· åŒ â¶ ï¼Œä¸è¿‡å±æ€§çš„åˆå§‹å€¼æ˜¯é€šè¿‡lamdbaè¡¨è¾¾å¼æ¥è®¡ç®—çš„;\nâ¸ ç»‘å®šå½“å‰ä¸Šä¸‹æ–‡(å½“å‰ä¸ºproject)ä¸­çš„å±æ€§åˆ°myPropertyå±æ€§ä¸­;\nâ¹ åŒ â¸ ï¼Œä¸è¿‡å…è®¸å€¼ä¸ºnullï¼›\nåœ¨å­é¡¹ç›®ä¸­è®¿é—®rootProjectçš„å±æ€§ val myNewProperty: String by rootProject.extra byæ˜¯kotlinçš„å…³é”®å­—ï¼Œè¡¨ç¤º provided by ï¼Œå³å±æ€§ç”±æŸä¸ªå…¶ä»–çš„å¯¹è±¡ä»£ç†\nåœ¨ä»»åŠ¡ä¸­å®šä¹‰å’Œä½¿ç”¨å±æ€§ ä»»åŠ¡ä¹Ÿç»§æ‰¿äº†ExtensionAwareï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨extraå±æ€§\ntasks { test { val reportType by extra(\u0026#34;dev\u0026#34;) doLast { // Use \u0026#39;suffix\u0026#39; for post processing of reports } } register\u0026lt;Zip\u0026gt;(\u0026#34;archiveTestReports\u0026#34;) { val reportType: String by test.get().extra archiveAppendix.set(reportType) from(test.get().reports.html.destination) } } é€šè¿‡mapæ ¼å¼å®šä¹‰å’Œè®¿é—®extraå±æ€§ extra[\u0026#34;myNewProperty\u0026#34;] = \u0026#34;initial value\u0026#34; // â¶ tasks.create(\u0026#34;myTask\u0026#34;) { doLast { println(\u0026#34;Property: ${project.extra[\u0026#34;myNewProperty\u0026#34;]}\u0026#34;) // â· } } è¿ç§»gradleæ„å»ºé€»è¾‘åˆ°Kotlin å‚è€ƒæ–‡æ¡£ï¼š\nMigrating build logic from Groovy to Kotlin (gradle.org) Android Gradleè„šæœ¬ä»Groovyè¿ç§»åˆ°Kotlin DSL - åœ£éª‘å£«wind - åšå®¢å›­ (cnblogs.com) å‡†å¤‡groovyè„šæœ¬ å¼•å·ç»Ÿä¸€ä¸ºåŒå¼•å· æ–¹æ³•è°ƒç”¨åŠ ä¸Šæ‹¬å· èµ‹å€¼æ“ä½œåŠ ä¸Šç­‰å· å¼•å·ç»Ÿä¸€ é€šè¿‡==âŒ˜â‡§R==å¿«æ·é”®è°ƒå‡ºæŸ¥æ‰¾æ›¿æ¢å·¥å…·çª—ï¼Œå°†æ–‡ä»¶åŒ¹é…è®¾ç½®ä¸º .gradle ï¼Œç„¶åå°†æ‰€æœ‰å•å¼•å·æ›¿æ¢ä¸ºåŒå¼•å·ã€‚\nå®Œæˆä¹‹åé‡æ–°ä½¿ç”¨gradleæ–‡ä»¶åŒæ­¥é¡¹ç›®ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯\nèµ‹å€¼å’Œå±æ€§ä¿®æ”¹ å°†æ‰€æœ‰çš„èµ‹å€¼æ“ä½œæ·»åŠ ä¸Šç­‰å· æ‰€æœ‰çš„å‡½æ•°è°ƒç”¨æ“ä½œæ·»åŠ æ‹¬å· è¿™é‡Œå°±éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´äº†ã€‚\né‡å‘½åæ–‡ä»¶ å°† .gradleæ–‡ä»¶é‡å‘½åä¸º.gradle.ktsï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯ä»¥å®Œæˆé‡å‘½åæ“ä½œ\nfind . -name \u0026#34;*.gradle\u0026#34; -type f | xargs -I {} mv {} {}.kts å…¶ä»–å¸¸è§ä¿®æ”¹ åœ¨kotlin rootProjectè„šæœ¬ä¸­è®¿é—® gradle å±æ€§ allprojects { repositories { maven { name = \u0026#34;Sonatype-Snapshots\u0026#34; setUrl(\u0026#34;https://oss.sonatype.org/content/repositories/snapshots\u0026#34;) credentials(PasswordCredentials::class.java) { username = property(\u0026#34;ossrhUsername\u0026#34;).toString() password = property(\u0026#34;ossrhPassword\u0026#34;).toString() } } google() jcenter() mavenCentral() } } å®šä¹‰ä»»åŠ¡ tasks.register(\u0026#34;clean\u0026#34;, Delete::class.java) { group = \u0026#34;build\u0026#34; delete(rootProject.buildDir) } è¿ç§»é…ç½®å®ä¾‹ rootProject kotlin dsl buildè„šæœ¬æ¨¡æ¿ // Top-level build file where you can add configuration options common to all sub-projects/modules. buildscript { // å®šä¹‰extra å±æ€§ val kotlin_version by extra(\u0026#34;1.4.32\u0026#34;) val android_gradle_build_version by extra(\u0026#34;4.1.3\u0026#34;) repositories { maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/gradle-plugin\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/jcenter\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/google\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/public\u0026#34;) } google() jcenter() mavenCentral() } dependencies { classpath(\u0026#34;com.android.tools.build:gradle:$android_gradle_build_version\u0026#34;) classpath(\u0026#34;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version\u0026#34;) // NOTE: Do not place your application dependencies here; they belong // in the individual module build.gradle files } } allprojects { repositories { maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/jcenter\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/google\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/gradle-plugin\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/public\u0026#34;) } // åŠ å…¥é¡¹ç›®ä¸´æ—¶ä»“åº“ï¼Œæ–¹ä¾¿æµ‹è¯• maven { name = \u0026#34;ProjectLocal-Snapshots\u0026#34; setUrl(File(rootProject.rootDir, \u0026#34;local-maven-repo${File.separator}snapshots\u0026#34;)) } maven { name = \u0026#34;ProjectLocal-Release\u0026#34; setUrl(File(rootProject.rootDir, \u0026#34;local-maven-repo${File.separator}release\u0026#34;)) } // åŠ å…¥ maven snapshot ä»“åº“åŠ release ä»“åº“ maven { name = \u0026#34;Sonatype-Snapshots\u0026#34; setUrl(\u0026#34;https://oss.sonatype.org/content/repositories/snapshots\u0026#34;) } maven { name = \u0026#34;Sonatype-Staging\u0026#34; setUrl(\u0026#34;https://oss.sonatype.org/service/local/staging/deploy/maven2/\u0026#34;) credentials(PasswordCredentials::class.java) { username = property(\u0026#34;ossrhUsername\u0026#34;).toString() password = property(\u0026#34;ossrhPassword\u0026#34;).toString() } } google() mavenCentral() jcenter() } } tasks.register(\u0026#34;clean\u0026#34;, Delete::class.java) { group = \u0026#34;build\u0026#34; delete(rootProject.buildDir) } æ¨¡å— build.gradle æ¨¡å—buildè„šæœ¬æ¨¡æ¿ plugins { id(\u0026#34;com.android.library\u0026#34;) id(\u0026#34;signing\u0026#34;) // ç­‰åŒäº id(\u0026#34;\u0026#34;) `maven-publish` kotlin(\u0026#34;android\u0026#34;) kotlin(\u0026#34;android.extensions\u0026#34;) // å¼•å…¥ä¸‰æ–¹Gradleæ’ä»¶ id(\u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) version (\u0026#34;0.0.9\u0026#34;) apply (false) } android { compileSdkVersion(30) buildToolsVersion(\u0026#34;30.0.3\u0026#34;) defaultConfig { minSdkVersion(22) targetSdkVersion(30) versionCode(1) versionName(\u0026#34;1.0.0\u0026#34;) testInstrumentationRunner(\u0026#34;androidx.test.runner.AndroidJUnitRunner\u0026#34;) consumerProguardFiles(\u0026#34;consumer-rules.pro\u0026#34;) } buildTypes { getByName(\u0026#34;release\u0026#34;) { minifyEnabled(false) proguardFiles( getDefaultProguardFile(\u0026#34;proguard-android-optimize.txt\u0026#34;), \u0026#34;proguard-rules.pro\u0026#34; ) } } compileOptions { sourceCompatibility(JavaVersion.VERSION_1_8) targetCompatibility(JavaVersion.VERSION_1_8) } } dependencies { implementation(\u0026#34;org.jetbrains:annotations:21.0.1\u0026#34;) testImplementation(\u0026#34;junit:junit:4.13.2\u0026#34;) androidTestImplementation(\u0026#34;androidx.test.ext:junit:1.1.3\u0026#34;) androidTestImplementation(\u0026#34;androidx.test.espresso:espresso-core:3.4.0\u0026#34;) // StringRes æ³¨è§£ implementation(\u0026#34;androidx.appcompat:appcompat:1.3.1\u0026#34;) // æ³¨è§£åº“ https://developer.android.com/jetpack/androidx/releases/annotation#annotation-1.2.0 implementation(\u0026#34;androidx.annotation:annotation:1.2.0\u0026#34;) } // åˆ›å»ºè‡ªå®šä¹‰ä»»åŠ¡ tasks.create(\u0026#34;showGitRepoInfo\u0026#34;) { group = \u0026#34;help\u0026#34; doLast { println(\u0026#34;${getGitBranch()}/${getGitRevision()}\u0026#34;) } } // æ‰©å±•å‡½æ•° fun String.execute(): String { val process = Runtime.getRuntime().exec(this) return with(process.inputStream.bufferedReader()) { readText() } } /** * Get git revision with work tree status * * @return */ fun getGitRevision(): String { val rev = \u0026#34;git rev-parse --short HEAD\u0026#34;.execute().trim() val stat = \u0026#34;git diff --stat\u0026#34;.execute().trim() return if (stat.isEmpty()) { rev } else { \u0026#34;$rev-dirty\u0026#34; } } /** * Get git branch name * * @return */ fun getGitBranch(): String { return \u0026#34;git rev-parse --abbrev-ref HEAD\u0026#34;.execute().trim() } 7.0.2 ç‰ˆæœ¬AGPæ’ä»¶é…ç½®å®ä¾‹-æ¨¡å—buildè„šæœ¬ plugins { id(\u0026#34;com.android.application\u0026#34;) } android { compileSdk = 31 defaultConfig { applicationId = \u0026#34;com.github.hanlyjiang.sample\u0026#34; minSdk = 21 targetSdk = 31 versionCode = 1 versionName = \u0026#34;1.0\u0026#34; testInstrumentationRunner = \u0026#34;androidx.test.runner.AndroidJUnitRunner\u0026#34; } buildTypes { getByName(\u0026#34;release\u0026#34;) { isMinifyEnabled = false proguardFiles( getDefaultProguardFile(\u0026#34;proguard-android-optimize.txt\u0026#34;), \u0026#34;proguard-rules.pro\u0026#34; ) } } compileOptions { sourceCompatibility(JavaVersion.VERSION_1_8) targetCompatibility(JavaVersion.VERSION_1_8) } } dependencies { implementation(files(\u0026#34;../libs/lib-mod-release.aar\u0026#34;)) // https://mvnrepository.com/artifact/io.reactivex.rxjava3/rxjava implementation(\u0026#34;io.reactivex.rxjava3:rxjava:3.1.3\u0026#34;) implementation(\u0026#34;androidx.appcompat:appcompat:1.2.0\u0026#34;) implementation(\u0026#34;com.google.android.material:material:1.3.0\u0026#34;) implementation(\u0026#34;androidx.constraintlayout:constraintlayout:2.1.3\u0026#34;) testImplementation(\u0026#34;junit:junit:4.+\u0026#34;) androidTestImplementation(\u0026#34;androidx.test.ext:junit:1.1.2\u0026#34;) androidTestImplementation(\u0026#34;androidx.test.espresso:espresso-core:3.3.0\u0026#34;) } 7.0.2 root Build gradle è„šæœ¬é…ç½® dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS) repositories { google() mavenCentral() jcenter() // Warning: this repository is going to shut down soon flatDir { dir(\u0026#34;libs\u0026#34;) } } } rootProject.name = \u0026#34;NoSuchMethodError\u0026#34; include \u0026#39;:app\u0026#39; include \u0026#39;:lib-mod\u0026#39; é™åˆ¶/ä¸è¶³ åœ¨ kotlin dsl è„šæœ¬ä¸­å¼•å…¥å…¶ä»–ç‹¬ç«‹çš„ kotlin çš„dsl è„šæœ¬ä¸æ–¹ä¾¿ï¼Œä¼šå­˜åœ¨æ— æ³•è¯†åˆ«ç›¸å…³ä¾èµ–å¯¹è±¡çš„é—®é¢˜ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹è¿˜æ˜¯å¾—å¯¼å…¥ä½¿ç”¨ groovy ç¼–å†™çš„ gradle è„šæœ¬ã€‚\n","permalink":"https://hanlyjiang.github.io/posts/shi-yong-kotlin-bian-xie-gradle-jiao-ben/","summary":"\u003cp\u003eå°†gradle è„šæœ¬ä» groovy è¿ç§»åˆ° kotlin dslã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"æ¦‚è¿°\"\u003eæ¦‚è¿°\u003c/h2\u003e\n\u003ch3 id=\"ide-æ”¯æŒ\"\u003eIDE æ”¯æŒ\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth style=\"text-align: right\"\u003e\u003c/th\u003e\n          \u003cth style=\"text-align: center\"\u003eBuild import\u003c/th\u003e\n          \u003cth style=\"text-align: center\"\u003eSyntax highlighting \u003csub\u003e1\u003c/sub\u003e\u003c/th\u003e\n          \u003cth style=\"text-align: center\"\u003eSemantic editor \u003csub\u003e2\u003c/sub\u003e\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eIntelliJ IDEA\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eAndroid Studio\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eEclipse IDE\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003eâœ–\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eCLion\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003eâœ–\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eApache NetBeans\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003eâœ–\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eVisual Studio Code (LSP)\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003eâœ–\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: right\"\u003eVisual Studio\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003e\u003cstrong\u003eâœ“\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003eâœ–\u003c/td\u003e\n          \u003ctd style=\"text-align: center\"\u003eâœ–\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003col\u003e\n\u003cli\u003eGradle Kotlin DSL scripts ä¸­çš„Kotlinè¯­æ³•é«˜äº®\u003c/li\u003e\n\u003cli\u003eGradle Kotlin DSL scripts ä¸­æ”¯æŒä»£ç è¡¥å…¨ï¼Œå¯¼èˆªåˆ°æºç ï¼Œæ–‡æ¡£æŸ¥çœ‹ï¼Œé‡æ„ç­‰ç­‰ï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"kotlin-dsl-è„šæœ¬å‘½å\"\u003eKotlin DSL è„šæœ¬å‘½å\u003c/h3\u003e\n\u003ch4 id=\"å‘½å\"\u003eå‘½å\u003c/h4\u003e\n\u003cp\u003eGroovy DSL script æ–‡ä»¶ä½¿ç”¨ \u003ccode\u003e.gradle\u003c/code\u003e æ‰©å±•æ–‡ä»¶å\u003c/p\u003e","title":"ä½¿ç”¨Kotlinç¼–å†™gradleè„šæœ¬"},{"content":"è®°å½•ä¸‹ä½¿ç”¨Clioné…ç½®Arduinoå¼€å‘ç¯å¢ƒçš„è¿‡ç¨‹ã€‚\nArduino å¼€å‘çš„ç¯å¢ƒæœ‰ä¸‹é¢å‡ ç§ï¼š\nArduino IDEï¼šç›®å‰æœ‰1.8.x å’Œ 2.0.0 Betaç‰ˆæœ¬ï¼› VSCode + PlatformIOï¼› CLion + PlatformIOï¼› ç›®å‰å·²ç»è¯•è¿‡äº†å‰é¢ä¸¤ç§ï¼Œéƒ½æ„Ÿè§‰ä¸æ˜¯å¾ˆæ»¡æ„ã€‚\nArduino IDEå¯¹ä»£ç è·³è½¬çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œ2.0æ”¯æŒï¼Œ1.8ä¸æ”¯æŒï¼Œ2.0çš„é€‰æ‹©Arduinoçš„å¼€å‘æ¿è¿˜æ­£å¸¸ï¼Œä½†æ˜¯é€‰æ‹©esp32çš„æ¿å­ä¸€ç›´æ˜¾ç¤ºçº¢è‰²çš„è­¦å‘Šï¼Œæ— æ³•è·³è½¬ã€‚ VSCode åˆ™æ˜¯å®åœ¨ç”¨ä¸ä¹ æƒ¯ã€‚ï¼ˆä¸»è¦æ˜¯ä¸€ç›´ç”¨AndroidStudioï¼Œæ“ä½œç†Ÿç»œäº†ï¼Œä¸æ„¿æ„å­¦ğŸ˜«ï¼‰ æ‰€ä»¥å‡†å¤‡å°è¯•ä¸‹CLionã€‚æµ‹è¯•ä¹‹åï¼Œæ„Ÿè§‰åˆ°äº†ç†Ÿæ‚‰çš„å‘³é“ğŸ˜‹ã€‚\nç¯å¢ƒè¯´æ˜ macOS 12.0.1 CLion 2021.2.3 å®‰è£… PlatformIO å®‰è£…CLionæ’ä»¶ å®‰è£…æ’ä»¶ï¼Œå®‰è£…å®Œæˆä¹‹åï¼Œé‡å¯ä¸‹CLionã€‚ é‡å¯å®Œæˆä¹‹åï¼Œæ–°å»ºé¡¹ç›®æ—¶é€‰æ‹©ä¼šå‘ç°æç¤ºéœ€è¦å®‰è£…PlatformIO Core CLI\nå®‰è£…Platform Core CLI macOSä¸Šç›´æ¥ä½¿ç”¨ brew å®‰è£…å³å¯\nbrew install platformio # æµ‹è¯•ä¸€ä¸‹ pio home # æ‰“å¼€ä¸€ä¸ªç½‘é¡µ http://127.0.0.1:8008 è¿è¡Œç¤ºä¾‹ æ–°å»ºé¡¹ç›® åˆæ¬¡åˆå§‹åŒ–çš„æŸç§æ¿å­çš„æ—¶å€™éœ€è¦ä¸‹è½½ä¸€äº›å·¥å…·é“¾ï¼Œæ­¤æ—¶å¯èƒ½ä¼šå¤±è´¥ï¼Œä¿è¯ç½‘ç»œè‰¯å¥½çš„æƒ…å†µä¸‹å¤šè¯•å‡ æ¬¡-é€‰ä¸­ platformio.ini æ–‡ä»¶å³é”®ï¼Œç„¶åé€‰æ‹© PlatformIO-Re-Initã€‚\nè¿è¡Œ é€‰æ‹©PlatformIO Upload çš„è¿è¡Œé…ç½®ï¼Œç‚¹å‡»å°é”¤å­å³å¯ç¼–è¯‘ï¼Œç‚¹å‡»è¿è¡ŒæŒ‰é’®å³å¯ä¸Šä¼ åˆ°å¼€å‘æ¿è¿è¡Œï¼ˆä¼šè‡ªåŠ¨é€‰æ‹©ä¸²å£ï¼‰ã€‚\nä¸²å£è¿æ¥ æ‰¾åˆ°Serial Monitorå·¥å…·çª—å£ ç‚¹å‡»ğŸ”§è¿›è¡Œä¸²å£é…ç½®ç«¯å£åŠæ³¢ç‰¹ç‡ï¼Œç‚¹å‡»ğŸ”Œå›¾æ ‡è¿›è¡Œè¿æ¥ã€‚ ä¸‰æ–¹åº“å¯¼å…¥ ç›´æ¥åœ¨ platformio.iniæ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–çš„é…ç½®å³å¯ï¼Œå¦‚ï¼š\n[env:uno] platform = atmelavr board = uno framework = arduino lib_deps = Wire @ ^1.0 fmalpartida/LiquidCrystal @ ^1.5.0 å¯¼å…¥äº† LiquidCrystal çš„åº“ï¼ˆä¾èµ–Wireï¼‰ï¼Œé…ç½®æ·»åŠ å®Œæˆä¹‹å ReInit ä¸€ä¸‹å³å¯ã€‚\né‚£ä¹ˆå»å“ªé‡ŒæŸ¥æ‰¾è¿™äº›åº“çš„åç§°åŠç‰ˆæœ¬ä¿¡æ¯å‘¢ï¼Ÿæ‰“å¼€ pio home ,åœ¨ç½‘é¡µä¸­å³å¯æŸ¥è¯¢ï¼Œç„¶åç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ã€‚\nä½“éªŒ ç¼–å†™ä»£ç ç®€ç›´ä¸è¦å¤ªæµç•…ã€‚ å¾ˆæ–¹ä¾¿çš„åœ¨ç¬¦å·ä¹‹é—´è·³è½¬ã€‚ å‚è€ƒ CLion â€” PlatformIO latest documentation PlatformIO Core (CLI) â€” PlatformIO latest documentation PlatformIO ä¾èµ–åº“æŸ¥æ‰¾æ¡†æ¶ï¼šLibrary Dependency Finder (LDF) â€” PlatformIO latest documentation ESP-Prog â€” PlatformIO latest documentation ","permalink":"https://hanlyjiang.github.io/posts/clion-da-jian-arduino-kai-fa-huan-jing/","summary":"\u003cp\u003eè®°å½•ä¸‹ä½¿ç”¨Clioné…ç½®Arduinoå¼€å‘ç¯å¢ƒçš„è¿‡ç¨‹ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003cp\u003eArduino å¼€å‘çš„ç¯å¢ƒæœ‰ä¸‹é¢å‡ ç§ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eArduino IDEï¼šç›®å‰æœ‰1.8.x å’Œ 2.0.0 Betaç‰ˆæœ¬ï¼›\u003c/li\u003e\n\u003cli\u003eVSCode + PlatformIOï¼›\u003c/li\u003e\n\u003cli\u003eCLion + PlatformIOï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eç›®å‰å·²ç»è¯•è¿‡äº†å‰é¢ä¸¤ç§ï¼Œéƒ½æ„Ÿè§‰ä¸æ˜¯å¾ˆæ»¡æ„ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eArduino IDEå¯¹ä»£ç è·³è½¬çš„æ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œ2.0æ”¯æŒï¼Œ1.8ä¸æ”¯æŒï¼Œ2.0çš„é€‰æ‹©Arduinoçš„å¼€å‘æ¿è¿˜æ­£å¸¸ï¼Œä½†æ˜¯é€‰æ‹©esp32çš„æ¿å­ä¸€ç›´æ˜¾ç¤ºçº¢è‰²çš„è­¦å‘Šï¼Œæ— æ³•è·³è½¬ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cimg src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/image/202112021303012.png\" alt=\"image-20211202130350932\" style=\"zoom: 50%;\" /\u003e\n\u003cul\u003e\n\u003cli\u003eVSCode åˆ™æ˜¯å®åœ¨ç”¨ä¸ä¹ æƒ¯ã€‚ï¼ˆä¸»è¦æ˜¯ä¸€ç›´ç”¨AndroidStudioï¼Œæ“ä½œç†Ÿç»œäº†ï¼Œä¸æ„¿æ„å­¦ğŸ˜«ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ‰€ä»¥å‡†å¤‡å°è¯•ä¸‹CLionã€‚æµ‹è¯•ä¹‹åï¼Œæ„Ÿè§‰åˆ°äº†ç†Ÿæ‚‰çš„å‘³é“ğŸ˜‹ã€‚\u003c/p\u003e","title":"CLionæ­å»ºArduinoå¼€å‘ç¯å¢ƒ"},{"content":"åŸºäºå®˜æ–¹æ–‡æ¡£æ•´ç†çš„é¸¿è’™å¼€å‘çš„åŸºç¡€çŸ¥è¯†\nAbilityæ¡†æ¶ ç®€ä»‹ æ•´ä½“å†…å®¹ åŒAndroid å¯¹æ¯”å…³ç³»ï¼š\nFeatureAbility - Activity ServiceAbility - Service DataAbility - ContentProvider CES - å¹¿æ’­ ANS - é€šçŸ¥ çº¿ç¨‹é€šä¿¡ InnerEvent - Message EventHandler - Handler EventRunner - Looper EventQueue - MessageQueue Abilityè¯´æ˜ åŒAndroid å•ç‹¬æä¾› Activityï¼ŒServiceï¼ŒContentProvider çš„åŸºç±»ä¸ä¸€æ ·ï¼Œé¸¿è’™è¿™ä¸‰ä¸ªç»„ä»¶å…¨éƒ½æ˜¯ç»§æ‰¿è‡ª Abilityï¼Œé‚£ä¹ˆå¦‚ä½•åŒºåˆ†ä¸€ä¸ªAbilityåˆ°åº•æ˜¯å“ªç§ç»„ä»¶å‘¢ï¼Ÿ\nç»§æ‰¿åå®ç°æ—¶é€‰æ‹©æ€§å®ç°å¯¹åº”ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼›\nåœ¨ config.json ä¸­å®šä¹‰abilityæ—¶ï¼Œéœ€è¦å£°æ˜å¯¹åº”çš„ç±»å‹ï¼ˆpage-FAï¼›service - ServiceAbilityï¼› data - DataAbilityï¼‰\n{ \u0026#34;name\u0026#34;: \u0026#34;com.hanlyjiang.ohosdemo.MainJSAbility2\u0026#34;, \u0026#34;icon\u0026#34;: \u0026#34;$media:icon\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;$string:mainjsability2_description\u0026#34;, \u0026#34;label\u0026#34;: \u0026#34;$string:entry_MainJSAbility2\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;page\u0026#34;, \u0026#34;launchType\u0026#34;: \u0026#34;standard\u0026#34;, }, { \u0026#34;name\u0026#34;: \u0026#34;com.hanlyjiang.ohosdemo.ServiceAbility\u0026#34;, \u0026#34;icon\u0026#34;: \u0026#34;$media:icon\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;$string:serviceability_description\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;service\u0026#34; }, { \u0026#34;name\u0026#34;: \u0026#34;com.hanlyjiang.ohosdemo.DataAbility\u0026#34;, \u0026#34;icon\u0026#34;: \u0026#34;$media:icon\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;$string:dataability_description\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;data\u0026#34;, \u0026#34;uri\u0026#34;: \u0026#34;dataability://com.hanlyjiang.ohosdemo.DataAbility\u0026#34; } FAï¼ˆFeatureAbilityï¼‰ FA ç”Ÿå‘½å‘¨æœŸ ç”Ÿå‘½å‘¨æœŸå›è°ƒ è¯´æ˜ onStart é¦–æ¬¡åˆ›å»ºè§¦å‘ï¼Œä»…æ‰§è¡Œä¸€æ¬¡ éœ€è¦setMainRoute onActive è¿›å…¥å‰å°å¯äº¤äº’çŠ¶æ€åè°ƒç”¨ onInactive Pageå¤±å»ç„¦ç‚¹æ—¶è°ƒç”¨ onBackground Pageä¸å†å¯è§ èµ„æºé‡Šæ”¾åŠè€—æ—¶ä¿å­˜æ“ä½œ onForeground é‡æ–°å›åˆ°å‰å°ï¼ˆè·å¾—ç„¦ç‚¹ é‡æ–°ç”³è¯·èµ„æº onStop é”€æ¯é¡µé¢æ—¶è°ƒç”¨ é‡Šæ”¾ç³»ç»Ÿèµ„æº åŒAndroidå¯¹æ¯”ï¼Œå…³ç³»å¦‚ä¸‹ï¼š\né¸¿è’™ å®‰å“ onStart onCreate onActive onResume onInactive onPause onBackground onStop onForeground onRestart onStop onDestory Service Ability åŒ Android Serviceï¼Œæ²¡æœ‰ç•Œé¢ï¼Œå¯åå°è¿è¡Œï¼›\nä½†æ˜¯é¸¿è’™å¯ä»¥å¯åŠ¨/ç»‘å®šè¿œç¨‹è®¾å¤‡ä¸Šçš„æœåŠ¡ï¼ˆæŒ‡å®šè®¾å¤‡IDï¼‰ã€‚\nUIå¼€å‘æ¡†æ¶ ArkUI å®˜æ–¹æ–‡æ¡£ï¼š JS FAæ¦‚è¿°\nArkUI-JS UI äº†è§£æ›´å¤šï¼š\nHarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-å·¥å…·-HUAWEI DevEco Studioä½¿ç”¨æŒ‡å—-å·¥ç¨‹ç®¡ç†-HarmonyOSå·¥ç¨‹ä»‹ç» JS API å‚è€ƒï¼šHarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-æ–‡ä»¶ç»„ç»‡ æ•´ä½“ä¸Šç±»ä¼¼ VUE \u0026amp; å¾®ä¿¡å°ç¨‹åº\nå…³é”®è¯ AceAbilityï¼šåŠ è½½JSçš„Abilityçš„åŸºç±»å®ç° setInstanceNameï¼š æŒ‡å®šAceAbilityåŠ è½½çš„jsç›®å½•ï¼ˆåŠ è½½å¤šä¸ªé€šè¿‡æ­¤æ–¹æ³•æŒ‡å®šjsç›®å½•ï¼‰ é¡¹ç›®ç»“æ„ AceAbility å­ç±»ï¼ˆä¸Šé¢å¯¹åº”çš„æ˜¯MainJSAbilityï¼‰ default ç›®å½• app.js ï¼š å…¨å±€çš„JavaScripté€»è¾‘æ–‡ä»¶å’Œåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† pages/index.js : JS FA(JS ç•Œé¢) - ==å¯ä»¥æœ‰å¤šä¸ªpage== config.jsonï¼š js å£°æ˜ app.js åº”ç”¨ç”Ÿå‘½å‘¨æœŸå›è°ƒ\nexport default { onCreate() { console.info(\u0026#39;AceApplication onCreate\u0026#39;); }, onDestroy() { console.info(\u0026#39;AceApplication onDestroy\u0026#39;); } }; index.js(JS FA) é¡µé¢ç”Ÿå‘½ç”Ÿå‘½å‘¨æœŸå›è°ƒ é¡µé¢ä¸šåŠ¡é€»è¾‘(æ•°æ®ç»‘å®šï¼Œäº‹ä»¶å¤„ç†ç­‰) export default { data: { title: \u0026#34;\u0026#34; }, onInit() { console.log(\u0026#34;JS Page onInit\u0026#34;) }, onActive(){ console.log(\u0026#34;JS Page onActive\u0026#34;) }, onInactive(){ console.log(\u0026#34;JS Page onInactive\u0026#34;) }, onShow(){ console.log(\u0026#34;JS Page onShow\u0026#34;) }, onHide(){ console.log(\u0026#34;JS Page onHide\u0026#34;) }, onDestroy(){ console.log(\u0026#34;JS Page onDestroy\u0026#34;) } } ç”Ÿå‘½å‘¨æœŸ è¯¦ç»†å‚è€ƒï¼š HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-ç”Ÿå‘½å‘¨æœŸ\nOHSO_DEMO: Application initialized OHSO_DEMO: MainAbility onStart OHSO_DEMO: MainAbility onActive // æ‰“å¼€JS PAGE OHSO_DEMO: MainAbility onInactive OHSO_DEMO: MainJSAbility onStart JSApp: app Log: AceApplication onCreateï¼ˆapp.jsï¼‰ OHSO_DEMO: MainJSAbility onActive JSApp: app Log: JS Page onInit JSApp: app Log: JS Page onActive JSApp: app Log: JS Page onShow OHSO_DEMO: MainAbility onBackground // åˆ‡æ¢æœ€è¿‘ä»»åŠ¡ OHSO_DEMO: MainJSAbility onInactive JSApp: app Log: JS Page onInactive OHSO_DEMO: MainJSAbility onBackground JSApp: app Log: JS Page onHide // æ¢å¤ OHSO_DEMO: MainJSAbility onForeground JSApp: app Log: JS Page onShow OHSO_DEMO: MainJSAbility onActive JSApp: app Log: JS Page onActive // å›é€€ï¼ˆé€€å‡ºJS PAGEï¼‰ JSApp: app Log: JS Page onHide JSApp: app Log: JS Page onDestroy OHSO_DEMO: MainJSAbility onInactive OHSO_DEMO: MainAbility onInactive OHSO_DEMO: MainAbility onActive OHSO_DEMO: MainJSAbility onBackground OHSO_DEMO: MainJSAbility onStop JSApp: app Log: AceApplication onDestroy ï¼ˆapp.jsï¼‰ JS çš„ç”Ÿå‘½å‘¨æœŸåœ¨Java Abilityçš„å†…éƒ¨ã€‚ HML HMLï¼ˆHarmonyOS Markup Languageï¼‰æ˜¯ä¸€å¥—ç±»HTMLçš„æ ‡è®°è¯­è¨€ã€‚é€šè¿‡ç»„ä»¶ã€äº‹ä»¶æ„å»ºå‡ºé¡µé¢çš„å†…å®¹ã€‚é¡µé¢å…·å¤‡æ•°æ®ç»‘å®šã€äº‹ä»¶ç»‘å®šã€åˆ—è¡¨æ¸²æŸ“ã€æ¡ä»¶æ¸²æŸ“ç­‰é«˜çº§èƒ½åŠ›ã€‚\nå…·ä½“å¯å‚è€ƒï¼š HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-è¯­æ³•-HMLè¯­æ³•å‚è€ƒ\nindex.CSS å‚è€ƒï¼š HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-JS APIå‚è€ƒ-æ‰‹æœºã€å¹³æ¿ã€æ™ºæ…§å±å’Œæ™ºèƒ½ç©¿æˆ´å¼€å‘-åŸºäºJSæ‰©å±•çš„ç±»Webå¼€å‘èŒƒå¼-æ¡†æ¶è¯´æ˜-è¯­æ³•-CSSè¯­æ³•å‚è€ƒ\né¸¿è’™ç‰¹æ€§ é¸¿è’™ç‰¹æœ‰çš„åŠŸèƒ½å’Œç‰¹æ€§ï¼Œä¸»è¦åŒ…æ‹¬ï¼šæœåŠ¡å¡ç‰‡ï¼Œæµè½¬ï¼Œåä¸ºåˆ†äº«åŠå¹³è¡Œè§†ç•Œã€‚\næœåŠ¡å¡ç‰‡ æœåŠ¡å¡ç‰‡ï¼ˆä»¥ä¸‹ç®€ç§°â€œå¡ç‰‡â€ï¼‰æ˜¯FAçš„ä¸€ç§ç•Œé¢å±•ç¤ºå½¢å¼ï¼Œå°†FAçš„é‡è¦ä¿¡æ¯æˆ–æ“ä½œå‰ç½®åˆ°å¡ç‰‡ï¼Œä»¥è¾¾åˆ°æœåŠ¡ç›´è¾¾ï¼Œå‡å°‘ä½“éªŒå±‚çº§çš„ç›®çš„ã€‚æœåŠ¡å¡ç‰‡ä¹Ÿæ˜¯ä¸€ä¸ªFAï¼Œåªä¸è¿‡æ˜¯æ˜¾ç¤ºåœ¨å…¶ä»–åº”ç”¨ä¸­çš„ç•Œé¢ã€‚\nå¡ç‰‡å¸¸ç”¨äºåµŒå…¥åˆ°å…¶ä»–åº”ç”¨ï¼ˆå½“å‰åªæ”¯æŒç³»ç»Ÿåº”ç”¨ï¼‰ä¸­ä½œä¸ºå…¶ç•Œé¢çš„ä¸€éƒ¨åˆ†æ˜¾ç¤ºï¼Œå¹¶æ”¯æŒæ‹‰èµ·é¡µé¢ï¼Œå‘é€æ¶ˆæ¯ç­‰åŸºç¡€çš„äº¤äº’åŠŸèƒ½ã€‚å¡ç‰‡ä½¿ç”¨æ–¹è´Ÿè´£æ˜¾ç¤ºå¡ç‰‡ã€‚\nJava/JSå¡ç‰‡åœºæ™¯èƒ½åŠ›å·®å¼‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\nåœºæ™¯ Javaå¡ç‰‡ JSå¡ç‰‡ æ”¯æŒçš„ç‰ˆæœ¬ å®æ—¶åˆ·æ–°ï¼ˆç±»ä¼¼æ—¶é’Ÿï¼‰ Javaä½¿ç”¨ComponentProvideråšå®æ—¶åˆ·æ–°ä»£ä»·æ¯”è¾ƒå¤§ JSå¯ä»¥åšåˆ°ç«¯ä¾§åˆ·æ–°ï¼Œä½†æ˜¯éœ€è¦å®šåˆ¶åŒ–ç»„ä»¶ HarmonyOS 2.0åŠä»¥ä¸Š å¼€å‘æ–¹å¼ Java UIåœ¨å¡ç‰‡æä¾›æ–¹éœ€è¦åŒæ—¶å¯¹æ•°æ®å’Œç»„ä»¶è¿›è¡Œå¤„ç†ï¼Œç”ŸæˆComponentProviderè¿œç«¯æ¸²æŸ“ JSå¡ç‰‡åœ¨ä½¿ç”¨æ–¹åŠ è½½æ¸²æŸ“ï¼Œæä¾›æ–¹åªè¦å¤„ç†æ•°æ®ã€ç»„ä»¶å’Œé€»è¾‘åˆ†ç¦» HarmonyOS 2.0åŠä»¥ä¸Š ç»„ä»¶æ”¯æŒ Textã€Imageã€DirectionalLayoutã€PositionLayoutã€DependentLayout divã€listã€list-itemã€swiperã€stackã€imageã€textã€spanã€progressã€buttonï¼ˆå®šåˆ¶ï¼šchart ã€clockã€calendarï¼‰ HarmonyOS 2.0åŠä»¥ä¸Š å¡ç‰‡å†…åŠ¨æ•ˆ ä¸æ”¯æŒ æš‚ä¸å¼€æ”¾ HarmonyOS 2.0åŠä»¥ä¸Š é˜´å½±æ¨¡ç³Š ä¸æ”¯æŒ æ”¯æŒ HarmonyOS 2.0åŠä»¥ä¸Š åŠ¨æ€é€‚åº”å¸ƒå±€ ä¸æ”¯æŒ æ”¯æŒ HarmonyOS 2.0åŠä»¥ä¸Š è‡ªå®šä¹‰å¡ç‰‡è·³è½¬é¡µé¢ ä¸æ”¯æŒ æ”¯æŒ HarmonyOS 2.0åŠä»¥ä¸Š ç»¼ä¸Šæ‰€è¿°ï¼Œ==JSå¡ç‰‡æ¯”Javaå¡ç‰‡æ”¯æŒçš„æ§ä»¶å’Œèƒ½åŠ›éƒ½æ›´ä¸°å¯Œ==ï¼š\nJavaå¡ç‰‡ï¼šé€‚åˆä½œä¸ºä¸€ä¸ªç›´è¾¾å…¥å£ï¼Œæ²¡æœ‰å¤æ‚çš„é¡µé¢å’Œäº‹ä»¶ã€‚ JSå¡ç‰‡ï¼šé€‚åˆæœ‰å¤æ‚ç•Œé¢çš„å¡ç‰‡ã€‚ å¡ç‰‡å¼€å‘ï¼ˆlinkï¼‰ éœ€è¦é€šè¿‡ä¸€äº›å‚æ•°è¿›è¡Œé…ç½®ã€‚\né…ç½®ï¼› FAä¸­å®ç°ç‰¹å®šçš„å›è°ƒæ–¹æ³•ç”¨æ¥å¤„ç†å¡ç‰‡çš„ç•Œé¢ç›¸å…³äº‹ä»¶ å¾…è¡¥å……\næœåŠ¡æµè½¬ HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-ä¸“é¢˜-æµè½¬-æµè½¬æ¶æ„\nä¸¤ç§ç±»å‹ï¼š\nè·¨ç«¯è¿ç§» å¤šç«¯ååŒ åŸºæœ¬æ¦‚å¿µ æµè½¬ï¼šåœ¨HarmonyOSä¸­æ³›æŒ‡å¤šè®¾å¤‡åˆ†å¸ƒå¼æ“ä½œã€‚æµè½¬èƒ½åŠ›æ‰“ç ´è®¾å¤‡ç•Œé™ï¼Œå¤šè®¾å¤‡è”åŠ¨ï¼Œä½¿ç”¨æˆ·åº”ç”¨ç¨‹åºå¯åˆ†å¯åˆã€å¯æµè½¬ï¼Œå®ç°å¦‚é‚®ä»¶è·¨è®¾å¤‡ç¼–è¾‘ã€å¤šè®¾å¤‡ååŒå¥èº«ã€å¤šå±æ¸¸æˆç­‰åˆ†å¸ƒå¼ä¸šåŠ¡ã€‚æµè½¬ä¸ºå¼€å‘è€…æä¾›æ›´å¹¿çš„ä½¿ç”¨åœºæ™¯å’Œæ›´æ–°çš„äº§å“è§†è§’ï¼Œå¼ºåŒ–äº§å“ä¼˜åŠ¿ï¼Œå®ç°ä½“éªŒå‡çº§ã€‚æµè½¬æŒ‰ç…§ä½“éªŒå¯åˆ†ä¸ºè·¨ç«¯è¿ç§»å’Œå¤šç«¯ååŒã€‚ è·¨ç«¯è¿ç§»ï¼šä¸€ç§å®ç°ç”¨æˆ·åº”ç”¨ç¨‹åºæµè½¬çš„æŠ€æœ¯æ–¹æ¡ˆï¼ŒæŒ‡åœ¨Aç«¯è¿è¡Œçš„FAè¿ç§»åˆ°Bç«¯ä¸Šï¼Œå®Œæˆè¿ç§»åï¼Œ Bç«¯FAç»§ç»­ä»»åŠ¡ï¼Œè€ŒAç«¯åº”ç”¨é€€å‡ºã€‚åœ¨ç”¨æˆ·ä½¿ç”¨è®¾å¤‡çš„è¿‡ç¨‹ä¸­ï¼Œå½“ä½¿ç”¨æƒ…å¢ƒå‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ï¼šä»å®¤å†…èµ°åˆ°æˆ·å¤–æˆ–è€…å‘¨å›´æœ‰æ›´åˆé€‚çš„è®¾å¤‡ç­‰ï¼‰ï¼Œä¹‹å‰ä½¿ç”¨çš„è®¾å¤‡å¯èƒ½å·²ç»ä¸é€‚åˆç»§ç»­å½“å‰çš„ä»»åŠ¡ï¼Œæ­¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©æ–°çš„è®¾å¤‡æ¥ç»§ç»­å½“å‰çš„ä»»åŠ¡ã€‚å¸¸è§çš„è·¨ç«¯è¿ç§»åœºæ™¯å®ä¾‹ï¼š è§†é¢‘æ¥ç”µæ—¶ä»æ‰‹æœºè¿ç§»åˆ°æ™ºæ…§å±ï¼Œè§†é¢‘èŠå¤©ä½“éªŒæ›´ä½³ï¼Œæ‰‹æœºè§†é¢‘åº”ç”¨é€€å‡ºã€‚ æ‰‹æœºä¸Šé˜…è¯»åº”ç”¨æµè§ˆæ–‡ç« ï¼Œè¿ç§»åˆ°å¹³æ¿ä¸Šç»§ç»­æŸ¥çœ‹ï¼Œæ‰‹æœºé˜…è¯»åº”ç”¨é€€å‡ºã€‚ å¤šç«¯ååŒï¼šä¸€ç§å®ç°ç”¨æˆ·åº”ç”¨ç¨‹åºæµè½¬çš„æŠ€æœ¯æ–¹æ¡ˆï¼ŒæŒ‡å¤šç«¯ä¸Šçš„ä¸åŒFA/PAåŒæ—¶è¿è¡Œã€æˆ–è€…äº¤æ›¿è¿è¡Œå®ç°å®Œæ•´çš„ä¸šåŠ¡ï¼›æˆ–è€…ï¼Œå¤šç«¯ä¸Šçš„ç›¸åŒFA/PAåŒæ—¶è¿è¡Œå®ç°å®Œæ•´çš„ä¸šåŠ¡ã€‚å¤šä¸ªè®¾å¤‡ä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸ºç”¨æˆ·æä¾›æ¯”å•è®¾å¤‡æ›´åŠ é«˜æ•ˆã€æ²‰æµ¸çš„ä½“éªŒã€‚ä¾‹å¦‚ï¼šç”¨æˆ·é€šè¿‡æ™ºæ…§å±çš„åº”ç”¨Aæ‹ç…§åï¼ŒAå¯è°ƒç”¨æ‰‹æœºçš„åº”ç”¨Bè¿›è¡Œäººåƒç¾é¢œï¼Œæœ€ç»ˆå°†ç¾é¢œåçš„ç…§ç‰‡ä¿å­˜åœ¨æ™ºæ…§å±çš„åº”ç”¨Aã€‚å¸¸è§çš„å¤šç«¯ååŒåœºæ™¯å®ä¾‹è¿˜æœ‰ï¼š æ‰‹æœºä¾§åº”ç”¨Aåšæ¸¸æˆæ‰‹æŸ„ï¼Œæ™ºæ…§å±ä¾§åº”ç”¨Båšæ¸¸æˆæ˜¾ç¤ºï¼Œä¸ºç”¨æˆ·ç»„æˆä¸€ä¸ªå…¨æ–°çš„æ¸¸æˆä½“éªŒã€‚ å¹³æ¿ä¾§åº”ç”¨Aåšç­”é¢˜æ¿ï¼Œæ™ºæ…§å±ä¾§åº”ç”¨Båšç›´æ’­ï¼Œä¸ºç”¨æˆ·ç»„æˆä¸€ä¸ªå…¨æ–°çš„ä¸Šç½‘è¯¾ä½“éªŒã€‚ ä»»åŠ¡æµè½¬ç®¡ç†æœåŠ¡ åœ¨æµè½¬å‘èµ·ç«¯ï¼Œæ¥å—ç”¨æˆ·åº”ç”¨ç¨‹åºæ³¨å†Œï¼Œæä¾›æµè½¬å…¥å£ã€çŠ¶æ€æ˜¾ç¤ºã€é€€å‡ºæµè½¬ç­‰ç®¡ç†èƒ½åŠ›ã€‚æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æä¾›çš„æ³¨å†Œã€è§£æ³¨å†Œã€æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨ã€ä¸ŠæŠ¥ä¸šåŠ¡çŠ¶æ€æ˜¯å®ç°è·¨ç«¯è¿ç§»çš„å‰æã€‚\nä»»åŠ¡æµè½¬ç®¡ç†æœåŠ¡ç”±ä¸€ä¸ªå®ç°äº†æµè½¬ IContinuationRegisterManager æ¥å£çš„ç®¡ç†å™¨æä¾›ï¼ŒåŒ…æ‹¬å¦‚ä¸‹æ¥å£ï¼š\nregisterï¼šæ³¨å†Œå¹¶è¿æ¥åˆ°æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ã€‚ showDeviceListï¼šæ˜¾ç¤ºç»„ç½‘å†…å¯é€‰æ‹©è®¾å¤‡åˆ—è¡¨ä¿¡æ¯ã€‚ updateConnectStatusï¼šé€šçŸ¥æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æ›´æ–°å½“å‰ç”¨æˆ·ç¨‹åºçš„è¿æ¥çŠ¶æ€ï¼Œå¹¶åœ¨æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ç•Œé¢å±•ç¤ºç»™ç”¨æˆ·ã€‚ disconnectï¼šåœ¨åº”ç”¨é€€å‡ºæ—¶ï¼Œä¸»åŠ¨è°ƒç”¨æ–­å¼€å’Œæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡çš„è¿æ¥ã€‚ unregisterï¼šä»æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡è§£æ³¨å†Œã€‚ ä¸€èˆ¬æµç¨‹æ˜¯: FA startæ—¶æ³¨å†Œï¼Œç„¶åæ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨ï¼Œç”¨æˆ·é€‰æ‹©è®¾å¤‡åæ›´æ–°è¿æ¥çŠ¶æ€ã€‚é¡µé¢é”€æ¯æ—¶æ–­å¼€è¿æ¥å¹¶è§£é™¤æ³¨å†Œã€‚\néƒ¨åˆ†è®¾å¤‡ä¸Šæœ‰å†…ç½®çš„æµè½¬ç®¡ç†æœåŠ¡ï¼Œéƒ¨åˆ†è®¾å¤‡æ²¡æœ‰ã€‚\nå½“å‰ä»…æ‰‹æœºã€å¹³æ¿è®¾å¤‡æ”¯æŒæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ã€‚ å¦‚æœæ²¡æœ‰å†…ç½®çš„æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡ï¼Œåˆ™éœ€è¦å¼€å‘è€…è‡ªè¡Œé€šè¿‡ DeviceManager å®ç°æµè½¬ä»»åŠ¡ç®¡ç† è·¨ç«¯è¿ç§»æµç¨‹ï¼š è¯´æ˜\nè·¨ç«¯è¿ç§»åï¼Œè®¾å¤‡Aä¸Šçš„åº”ç”¨éœ€è¦è‡ªè¡Œé€€å‡ºã€‚\nå¤šç«¯ååŒæµç¨‹ è¯´æ˜\nè®¾å¤‡Aå’ŒBè¿›è¡Œå¤šç«¯ååŒåï¼Œè®¾å¤‡Aå’Œè®¾å¤‡Cé‡å¤å¦‚ä¸Šæµç¨‹ï¼Œå¯å®ç°è®¾å¤‡Aã€Bã€Cè¿›è¡Œå¤šç«¯ååŒï¼Œæ­¤æ—¶è®¾å¤‡Aæ˜¯ä¸­å¿ƒæ§åˆ¶ç‚¹ã€‚\nè·¨ç«¯è¿ç§»å¼€å‘æµç¨‹ æµç¨‹ æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š\né™åˆ¶ æ¯ä¸ªåº”ç”¨æ³¨å†Œæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡çš„Abilityæ•°é‡ä¸Šé™ä¸º5ä¸ªï¼Œåç»­æ–°å¢æ³¨å†Œçš„Abilityä¼šå°†æœ€å¼€å§‹æ³¨å†Œçš„è¦†ç›–ã€‚ ä¸€ä¸ªåº”ç”¨å¯èƒ½åŒ…å«å¤šä¸ªFAï¼Œä»…éœ€è¦åœ¨æ”¯æŒè·¨ç«¯è¿ç§»çš„FAåŠå…¶æ‰€åŒ…å«çš„AbilitySliceä¸­ï¼Œè°ƒç”¨æˆ–å®ç°ç›¸å…³æ¥å£ã€‚ è·¨ç«¯è¿ç§»ä¸æ”¯æŒä¸¤ä¸ªè®¾å¤‡ä¹‹é—´åˆ†åˆ«ç™»å½•ä¸åŒçš„å¸å·ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚å¤šä¸ªè®¾å¤‡æ˜¯åŒå¸å·ã€‚ è·¨ç«¯è¿ç§»ä¸æ”¯æŒå¯¹PAçš„è¿ç§»ï¼Œåªæ”¯æŒå¯¹FAçš„è¿ç§»ã€‚ è·¨ç«¯è¿ç§»å®Œæˆæ—¶ï¼Œç³»ç»Ÿä¸ä¼šä¸»åŠ¨å…³é—­å‘èµ·è¿ç§»çš„FAï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œä¸»åŠ¨è°ƒç”¨terminateAbilityæˆ–stopAbilityå…³é—­FAï¼Œå¹¶è°ƒç”¨updateConnectStatus()æ›´æ–°è®¾å¤‡çš„è¿æ¥çŠ¶æ€ã€‚ é€šè¿‡continueAbilityè¿›è¡Œè·¨ç«¯è¿ç§»è¿‡ç¨‹ä¸­ï¼Œè¿œç«¯FAé¦–å…ˆæ¥æ”¶åˆ°å‘èµ·ç«¯FAä¼ è¾“çš„æ•°æ®ï¼Œå†æ‰§è¡Œå¯åŠ¨ï¼Œå³onRestoreData()å‘ç”Ÿåœ¨onStart()ä¹‹å‰ã€‚ è·¨ç«¯è¿ç§»çš„æ•°æ®å¤§å°é™åˆ¶200KBä»¥å†…ï¼Œå³onSaveDataåªèƒ½ä¼ é€’200KBä»¥å†…çš„æ•°æ®ã€‚ è¿ç§»ä¼ è¾“çš„æ•°æ®ï¼Œå½“å‰ä»…æ”¯æŒåŸºç¡€ç±»å‹æ•°æ®ä¼ é€’å’Œç³»ç»ŸSequenceableå¯¹è±¡ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰å¯¹è±¡åŠæ–‡ä»¶æ•°æ®ä¼ é€’ã€‚ FAæµè½¬è¿‡ç¨‹ä¸­ï¼Œåœ¨æµè½¬æœªå®Œæˆæ—¶å†æ¬¡è°ƒç”¨continueAbilityå‘èµ·æµè½¬ï¼Œæ¥å£å°†ä¼šæŠ›å‡ºçŠ¶æ€å¼‚å¸¸ï¼Œåº”ç”¨éœ€è¦åŠ ä»¥é™åˆ¶å¤„ç†ã€‚ è·¨ç«¯è¿ç§»è¦æ±‚HarmonyOS 2.0ä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½æ”¯æŒï¼Œæ³¨å†Œåˆ°æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æ—¶jsonParamsä¸­éœ€è¦å¢åŠ {\u0026quot;harmonyVersion\u0026quot;:\u0026quot;2.0.0\u0026quot;}è¿‡æ»¤æ¡ä»¶ã€‚ å¤šç«¯ååŒå¼€å‘æµç¨‹ æµç¨‹ ç›¸å¯¹è·¨ç«¯è¿ç§»ï¼Œå¤šäº† DeviceManager çš„å‚ä¸ï¼Œç”¨äºåˆå§‹åŒ–å’Œå…³é—­åˆ†å¸ƒå¼ç¯å¢ƒã€‚å¦å¤–ï¼Œè·¨ç«¯è¿ç§»åªæ¶‰åŠFAï¼Œè€Œå¤šç«¯ååŒéœ€è¦PAå‚ä¸ã€‚\nååŒå®é™…ä¸Šçš„æµç¨‹å°±æ˜¯ï¼Œé€šè¿‡startAbility å¯åŠ¨FAï¼ŒåŠPAï¼Œé€šè¿‡connectAbilityè¿æ¥åˆ°PAï¼Œç„¶åé€šè¿‡è¿œç¨‹PAæ¥è¿›è¡Œåä½œã€‚\né™åˆ¶ æ¯ä¸ªåº”ç”¨æ³¨å†Œæµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡çš„Abilityæ•°é‡ä¸Šé™ä¸º5ä¸ªï¼Œåç»­æ–°å¢æ³¨å†Œçš„Abilityä¼šå°†æœ€å¼€å§‹æ³¨å†Œçš„è¦†ç›–ã€‚ startAbilityã€connectAbilityä¸­è·¨è®¾å¤‡ä¼ é€’çš„intentæ•°æ®å¤§å°é™åˆ¶200KBä»¥å†…ã€‚ ä¸æ”¯æŒä½¿ç”¨connectAbilityè§¦å‘è¿œç«¯PAçš„å…å®‰è£…ã€‚ connectAbilityä¸­è·¨è®¾å¤‡ä¼ é€’çš„remoteObjectæ•°æ®å¤§å°é™åˆ¶200KBä»¥å†…ã€‚ å¤šç«¯ååŒè¦æ±‚HarmonyOS 2.0ä»¥ä¸Šç‰ˆæœ¬æ‰èƒ½æ”¯æŒï¼Œæ³¨å†Œåˆ°æµè½¬ä»»åŠ¡ç®¡ç†æœåŠ¡æ—¶jsonParamsä¸­éœ€è¦å¢åŠ {\u0026ldquo;harmonyVersion\u0026rdquo;:\u0026ldquo;2.0.0\u0026rdquo;}è¿‡æ»¤æ¡ä»¶ã€‚ stopAbilityä¸æ”¯æŒä¸¤ä¸ªè®¾å¤‡ä¹‹é—´åˆ†åˆ«ç™»å½•ä¸åŒçš„å¸å·ï¼Œä¹Ÿå°±æ˜¯è¦æ±‚å¤šä¸ªè®¾å¤‡æ˜¯åŒå¸å·ã€‚ ç¤ºä¾‹ å‚è€ƒå®˜æ–¹ç¤ºä¾‹ï¼š\nability/DistributedScheduler Â· HarmonyOS/harmonyos_app_samples - ç äº‘ - å¼€æºä¸­å›½ (gitee.com) HarmonyOSåº”ç”¨å¼€å‘-æœåŠ¡å¼€å‘-ä¸“é¢˜-æµè½¬-HarmonyOSç«¯å‘èµ·å¤šç«¯ååŒ-å¤šç«¯ååŒå¼€å‘æŒ‡å¯¼ å…¶ä»– æ—¥å¿—è¾“å‡º HiLog static final HiLogLabel label = new HiLogLabel(HiLog.LOG_APP, MY_MODULE, \u0026#34;MY_TAG\u0026#34;); //MY_MODULE=0x00201 HiLog.warn(label, \u0026#34;Failed to visit %{private}s, reason:%{public}d.\u0026#34;, url, errno); è¾“å‡ºå¦‚ä¸‹ï¼š\nResult: 05-26 11:01:06.870 1051 1051 W 00201/test: Failed to visit \u0026lt;private\u0026gt;, reason:503. æ³¨æ„ï¼š éšè—äº†æœ¬è¯¥è¢«è¾“å‡ºçš„ url\nå¯¹åº”æ¦‚å¿µ/ç±» LayoutBoost -\u0026gt; LayoutInflater å¸¸è§é—®é¢˜ éšè— ActionBar å°†å¦‚ä¸‹é…ç½®æ®µæ·»åŠ åˆ° module ä¸­ï¼Œæˆ–è€…æ·»åŠ åˆ° ability ä¸­ã€‚\n\u0026#34;metaData\u0026#34;: { \u0026#34;customizeData\u0026#34;: [ { \u0026#34;name\u0026#34;: \u0026#34;hwc-theme\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;androidhwext:style/Theme.Emui.Light.NoTitleBar\u0026#34; } ] } æŒ‰ç†åº”è¯¥æä¾›ç›´æ¥å¯¹Abilityè®¾ç½®ä¸»é¢˜çš„é…ç½®æ–¹å¼ï¼Œä½†æ˜¯ä¸çŸ¥é“é…ç½®é¡¹ã€‚\nHDC ä½¿ç”¨ hdc è·¯å¾„ï¼š $USER_HOME/Library/Huawei/sdk/toolchains/\næŸ¥çœ‹å¸®åŠ©ï¼š hdc help\nä¸€èˆ¬ç”¨æ³•å¦‚ä¸‹ï¼š\nhdc [options] \u0026lt;command\u0026gt; [arguments] æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨ï¼š hdc list targets -v æŸ¥çœ‹æ—¥å¿—ï¼š hilog\nhdc hilog | grep com.hanlyjiang.ohosdemo æŸ¥çœ‹å¯è°ƒè¯•åº”ç”¨PIDåˆ—è¡¨ï¼š hdc listpid\nä½¿ç”¨æ‰‹æœºå†…çš„androidå‘½ä»¤ ä½¿ç”¨ hdc shell è¿›å…¥æ‰‹æœºshellç¯å¢ƒï¼Œç„¶åå¯æ‰§è¡Œå¯¹åº”çš„androidå‘½ä»¤\nå¦‚ä¸‹ï¼Œé€šè¿‡dumpsys activity services -p com.hanlyjiang.ohosdemoå¯ä»¥çœ‹åˆ°å®é™…ä¸Š é¸¿è’™ä¸ºæˆ‘ä»¬çš„ com.hanlyjiang.ohosdemo.pa.ServiceAbility ç”Ÿæˆäº†ä¸€ä¸ªå¯¹åº”çš„shellServiceï¼ˆcom.hanlyjiang.ohosdemo/.pa.ServiceAbilityShellServiceï¼‰\n$ dumpsys activity services -p com.hanlyjiang.ohosdemo ACTIVITY MANAGER SERVICES (dumpsys activity services) User 0 active services: * ServiceRecord{b2375c9 u0 com.hanlyjiang.ohosdemo/.pa.ServiceAbilityShellService} intent={pkg=com.hanlyjiang.ohosdemo cmp=com.hanlyjiang.ohosdemo/.pa.ServiceAbilityShellService} packageName=com.hanlyjiang.ohosdemo processName=com.hanlyjiang.ohosdemo baseDir=/data/app/com.hanlyjiang.ohosdemo-XmLCnshi-zSpv76TYXTvwA==/base.apk dataDir=/data/user/0/com.hanlyjiang.ohosdemo app=ProcessRecord{b340b59 7888:com.hanlyjiang.ohosdemo/u0a191} createTime=-10m43s889ms startingBgTimeout=-- lastActivity=-10m43s889ms restartTime=-10m43s889ms createdFromFg=true startRequested=true delayedStop=false stopIfKilled=true callStart=true lastStartId=1 ","permalink":"https://hanlyjiang.github.io/posts/hong-meng-kai-fa-ru-men/","summary":"\u003cp\u003eåŸºäºå®˜æ–¹æ–‡æ¡£æ•´ç†çš„é¸¿è’™å¼€å‘çš„åŸºç¡€çŸ¥è¯†\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch1 id=\"abilityæ¡†æ¶\"\u003eAbilityæ¡†æ¶\u003c/h1\u003e\n\u003ch2 id=\"ç®€ä»‹\"\u003eç®€ä»‹\u003c/h2\u003e\n\u003ch3 id=\"æ•´ä½“å†…å®¹\"\u003eæ•´ä½“å†…å®¹\u003c/h3\u003e\n\u003cimg src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/image/202111301012735.png\" alt=\"image-20211028145037926\" style=\"zoom: 50%;\" /\u003e\n\u003cp\u003eåŒ\u003ccode\u003eAndroid\u003c/code\u003e å¯¹æ¯”å…³ç³»ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eFeatureAbility\u003c/code\u003e - \u003ccode\u003eActivity\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eServiceAbility\u003c/code\u003e - \u003ccode\u003eService\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eDataAbility\u003c/code\u003e - \u003ccode\u003eContentProvider\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eCES\u003c/code\u003e - å¹¿æ’­\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eANS\u003c/code\u003e - é€šçŸ¥\u003c/li\u003e\n\u003cli\u003eçº¿ç¨‹é€šä¿¡\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eInnerEvent\u003c/code\u003e - \u003ccode\u003eMessage\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eEventHandler\u003c/code\u003e - \u003ccode\u003eHandler\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eEventRunner\u003c/code\u003e - \u003ccode\u003eLooper\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eEventQueue\u003c/code\u003e - \u003ccode\u003eMessageQueue\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"abilityè¯´æ˜\"\u003eAbilityè¯´æ˜\u003c/h3\u003e\n\u003cp\u003eåŒAndroid å•ç‹¬æä¾› Activityï¼ŒServiceï¼ŒContentProvider çš„åŸºç±»ä¸ä¸€æ ·ï¼Œé¸¿è’™è¿™ä¸‰ä¸ªç»„ä»¶å…¨éƒ½æ˜¯ç»§æ‰¿è‡ª Abilityï¼Œé‚£ä¹ˆå¦‚ä½•åŒºåˆ†ä¸€ä¸ªAbilityåˆ°åº•æ˜¯å“ªç§ç»„ä»¶å‘¢ï¼Ÿ\u003c/p\u003e","title":"é¸¿è’™å¼€å‘åŸºç¡€çŸ¥è¯†"},{"content":"ä»githubä¸‹è½½ LiquidCrystal çš„åº“ï¼Œå®‰è£…åˆ°Arduino IDEï¼Œå¹¶ç‚¹äº®1602 LCDã€‚\nå‡†å¤‡ä½¿ç”¨Arduino UNOç‚¹äº®ä¸€ä¸ªLCD1602ï¼Œå‘ç°ArduinoIDEï¼ˆæˆ‘ç”¨çš„2.0Betaç‰ˆæœ¬ï¼‰ä¸­é»˜è®¤æ²¡æœ‰å®‰è£… LiquidCrystal çš„åº“ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¿›è¡Œå®‰è£…ã€‚\nå®‰è£… ç¬¬ä¸€ç§å®‰è£…æ–¹å¼æ˜¯ä»Arduino IDEçš„ Library Managerä¸­æœç´¢ğŸ”å¹¶å®‰è£…ã€‚å¦å¤–å°±æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡å–æ‰‹åŠ¨å®‰è£…çš„æ–¹å¼ã€‚\nè®¿é—®å…¶githubä»“åº“ï¼ˆhttps://github.com/arduino-libraries/LiquidCrystalï¼‰ï¼Œä¸‹è½½ä¸ºzipåŒ…ï¼Œä¸‹è½½å®Œæ¯•åå°±æ˜¯ LiquidCrystal-master.zip\næŒ‰å¦‚ä¸‹è·¯å¾„æ‰¾åˆ°æ·»åŠ  ZIP åº“çš„èœå•\né€‰æ‹©æˆ‘ä»¬çš„ LiquidCrystal-master.zip æ–‡ä»¶ï¼Œå®‰è£…å®Œæ¯•åé‡å¯ä¸€ä¸‹ Arduino IDEã€‚\né‡æ–°æ‰“å¼€IDEï¼Œå³å¯çœ‹åˆ°ç¤ºä¾‹ä¸­å¤šäº†LiquidCrystal çš„ç¤ºä¾‹\nè¿è¡Œç¤ºä¾‹ å¼€ä¸€ä¸ª Blink çš„ç¤ºä¾‹ï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼æ¥çº¿ã€‚\nè¿è¡Œä¹‹åæ•ˆæœï¼š\nå¾…è¡¥å›¾ã€‚ å¯å‚è€ƒï¼š http://www.taichi-maker.com/homepage/reference-index/arduino-library-index/liquidcrystal-library/\n","permalink":"https://hanlyjiang.github.io/posts/arduino-lcd-ku-an-zhuang-yu-shi-yong/","summary":"\u003cp\u003eä»githubä¸‹è½½ LiquidCrystal çš„åº“ï¼Œå®‰è£…åˆ°Arduino IDEï¼Œå¹¶ç‚¹äº®1602 LCDã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003cp\u003eå‡†å¤‡ä½¿ç”¨Arduino UNOç‚¹äº®ä¸€ä¸ªLCD1602ï¼Œå‘ç°ArduinoIDEï¼ˆæˆ‘ç”¨çš„2.0Betaç‰ˆæœ¬ï¼‰ä¸­é»˜è®¤æ²¡æœ‰å®‰è£… LiquidCrystal çš„åº“ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¿›è¡Œå®‰è£…ã€‚\u003c/p\u003e\n\u003ch2 id=\"å®‰è£…\"\u003eå®‰è£…\u003c/h2\u003e\n\u003cp\u003eç¬¬ä¸€ç§å®‰è£…æ–¹å¼æ˜¯ä»Arduino IDEçš„ Library Managerä¸­æœç´¢ğŸ”å¹¶å®‰è£…ã€‚å¦å¤–å°±æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡å–æ‰‹åŠ¨å®‰è£…çš„æ–¹å¼ã€‚\u003c/p\u003e","title":"Arduino LCDåº“å®‰è£…ä¸ä½¿ç”¨"},{"content":" è¿™ä¸ªå¯¹äºå®‰å“å¼€å‘æ¥è¯´ï¼ŒGradleå¯ä»¥ä¸äº†è§£ï¼Œä½†æ˜¯åˆå¿…é¡»äº†è§£ã€‚\nè¯´ä¸éœ€è¦äº†è§£ï¼Œæ˜¯å› ä¸ºï¼š é€šè¿‡AndroidStudioå»ºç«‹å·¥ç¨‹çš„æ—¶å€™ï¼Œé»˜è®¤å°±åˆ›å»ºå¥½äº†Gradleçš„é¡¹ç›®ç»“æ„åŠå¯¹åº”çš„ä»»åŠ¡ï¼Œé€šè¿‡IDEæ¥æ·»åŠ æ¨¡å—çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨çš„æ·»åŠ Gradleçš„é…ç½®ã€‚\nè¯´éœ€è¦äº†è§£ï¼Œæ˜¯å› ä¸ºï¼šæœ‰æ—¶å€™ä¼šé‡åˆ°æ„å»ºé”™è¯¯ï¼Œè¿˜æœ‰æ—¶å€™éœ€è¦æ”¹ä¸€æ”¹æ„å»ºæµç¨‹çš„é»˜è®¤è¡Œä¸ºï¼Œå¦å¤–æœ‰äº›æ—¶å€™ï¼Œéœ€è¦è‡ªè¡Œæ‰©å±•ä¸€ä¸ªæ„å»ºä»»åŠ¡ã€‚\nGradleå­¦ä¹ çš„ä¸€ä¸ªéš¾ç‚¹åœ¨äºï¼Œå…¶å­¦ä¹ èµ„æ–™éå¸¸é›¶æ•£ï¼Œå°‘æœ‰æˆä½“ç³»çš„å­¦ä¹ èµ„æ–™ã€‚å½“ç„¶ï¼Œå®˜æ–¹æ–‡æ¡£æ˜¯å¾ˆæˆä½“ç³»çš„ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰ä¸å¥½çš„åœ°æ–¹ï¼š\nçº¯è‹±æ–‡ï¼› ç‰ˆæœ¬æ›´æ–°ä¹‹åï¼Œæ–‡æ¡£ç»“æ„æœ‰å˜åŒ–ã€‚ å®˜æ–¹æ–‡æ¡£å¯¹äºå®‰å“é¡¹ç›®çš„è¯´æ˜æ²¡æœ‰ï¼ˆå› ä¸ºandroidçš„æ’ä»¶æ˜¯googleè‡ªè¡Œæ‰©å±•çš„ï¼‰ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå‰æœŸgradleçš„è„šæœ¬éƒ½æ˜¯ä½¿ç”¨groovyæ¥ç¼–å†™ï¼Œæˆ‘ä»¬è¦å†™è„šæœ¬ï¼Œéœ€è¦å»å­¦ä¹ ä¸€é—¨æ–°çš„è¯­è¨€ï¼Œè™½ç„¶è¿™ä¸ªè¯­è¨€å’Œjavaæ¯”è¾ƒæ¥è¿‘ï¼Œä½†æ˜¯ç”±äºæ²¡ä»€ä¹ˆå…¶ä»–ç”¨é€”ï¼ŒåŠ ä¸Šéœ€è¦ç¼–å†™gradleè„šæœ¬çš„åœºæ™¯ä¹Ÿä¸æ˜¯é‚£ä¹ˆå¸¸è§ï¼Œå°±ä¼šè®©è§‰å¾—æœ‰ç‚¹ä¸å€¼å¾—æŠ•å…¥ï¼Œè¿™ä¸¤ä¸ªå› ç´ ç»“åˆèµ·æ¥ï¼Œä¼šåŠé€€å¾ˆå¤šå®‰å“å¼€å‘äººå‘˜ã€‚ç°åœ¨ï¼Œgradleå¯ä»¥ä½¿ç”¨kotlinæ¥ç¼–å†™å…¶dslè„šæœ¬ï¼Œå­¦ä¹ æˆæœ¬ä¼šé™ä½å¾ˆå¤šã€‚\nè§åˆ°å…¶wrapperçš„è®¾è®¡ä»¤æˆ‘å°è±¡æ·±åˆ»ï¼Œå¯¹æ¯”antåŠmavenéœ€è¦æ‰‹åŠ¨å»ä¸‹è½½ä¸€ä»½äºŒè¿›åˆ¶å‰¯æœ¬ï¼Œç„¶åé…ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œè€Œä½ è·å–åˆ°åˆ«äººçš„gradleé¡¹ç›®ä¹‹åï¼Œç›´æ¥ä½¿ç”¨wrapperè„šæœ¬ï¼Œå°±å¯ä»¥æ‰§è¡Œgradleä»»åŠ¡ï¼Œwrapperè„šæœ¬ä¼šè‡ªåŠ¨å¸®åŠ©ä½ å»è·å–ä¸€ä»½gradleçš„äºŒè¿›åˆ¶å‰¯æœ¬ï¼Œå°±å¥½åƒä½ ç›´æ¥æ‰§è¡Œgradleçš„äºŒè¿›åˆ¶å‘½ä»¤ä¸€æ ·ã€‚\nå¦å¤–gradleä¹Ÿæä¾›äº†æ–¹ä¾¿çš„æ‰©å±•æœºåˆ¶ï¼Œèƒ½å¯¹æ„å»ºæµç¨‹è¿›è¡Œå®šåˆ¶ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä»å®‰å“å¼€å‘çš„è§†è§’ï¼Œå¯¹Gradleçš„ä½¿ç”¨åšä¸€ä¸ªæ•´ä½“çš„ä»‹ç»ã€‚å†…å®¹ä¸Šä¼šåŒ…æ‹¬Gradleçš„ä¸€äº›åŸºç¡€æ¦‚å¿µï¼Œä¸€äº›å¸¸è§çš„Gradleä»»åŠ¡ä»‹ç»ï¼ŒAndroidçš„å¸¸è§Gradleé…ç½®ä»‹ç»ï¼ŒåŒæ—¶ä¹Ÿä¼šä»‹ç»è‡ªå®šä¹‰Gradleä»»åŠ¡åŠGradleæ’ä»¶ã€‚\n","permalink":"https://hanlyjiang.github.io/posts/gradle-xue-xi-zhi-nan-qian-yan/","summary":"\u003c!-- more --\u003e\n\u003cp\u003eè¿™ä¸ªå¯¹äºå®‰å“å¼€å‘æ¥è¯´ï¼ŒGradleå¯ä»¥ä¸äº†è§£ï¼Œä½†æ˜¯åˆå¿…é¡»äº†è§£ã€‚\u003c/p\u003e\n\u003cp\u003eè¯´ä¸éœ€è¦äº†è§£ï¼Œæ˜¯å› ä¸ºï¼š é€šè¿‡AndroidStudioå»ºç«‹å·¥ç¨‹çš„æ—¶å€™ï¼Œé»˜è®¤å°±åˆ›å»ºå¥½äº†Gradleçš„é¡¹ç›®ç»“æ„åŠå¯¹åº”çš„ä»»åŠ¡ï¼Œé€šè¿‡IDEæ¥æ·»åŠ æ¨¡å—çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨çš„æ·»åŠ Gradleçš„é…ç½®ã€‚\u003c/p\u003e\n\u003cp\u003eè¯´éœ€è¦äº†è§£ï¼Œæ˜¯å› ä¸ºï¼šæœ‰æ—¶å€™ä¼šé‡åˆ°æ„å»ºé”™è¯¯ï¼Œè¿˜æœ‰æ—¶å€™éœ€è¦æ”¹ä¸€æ”¹æ„å»ºæµç¨‹çš„é»˜è®¤è¡Œä¸ºï¼Œå¦å¤–æœ‰äº›æ—¶å€™ï¼Œéœ€è¦è‡ªè¡Œæ‰©å±•ä¸€ä¸ªæ„å»ºä»»åŠ¡ã€‚\u003c/p\u003e","title":"Gradleå­¦ä¹ æŒ‡å—-å‰è¨€"},{"content":"é…ç½® android ä¸Šä¼ åˆ° maven ä¸­å¿ƒä»“åº“ï¼Œå‘ç°é…ç½®çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè€Œä¸”å¦‚æœæœ‰å¤šä¸ªåº“æ¨¡å—éœ€è¦ä¸Šä¼ ï¼Œåˆ™éœ€è¦å¤åˆ¶ç²˜è´´ä¸å°‘é‡å¤çš„é…ç½®ä»£ç ï¼Œäºæ˜¯ç¼–å†™äº†ä¸€ä¸ª gradle æ’ä»¶ç”¨äºç®€åŒ–æå–è¿™ä¸ªé…ç½®è¿‡ç¨‹ï¼›\næ’ä»¶ç”¨é€”åŠæ•ˆæœ æœ¬æ’ä»¶ç”¨äºç®€åŒ–Androidåº“ä¸Šä¼ åˆ°Mavenä¸­å¿ƒä»“åº“çš„é…ç½®ï¼Œé¿å…æ¯ä¸ªprojectçš„gradleä¸­éƒ½æ”¾ç½®ä¸€ä»½é‡å¤è¾ƒå¤šçš„é…ç½®ï¼›\næ’ä»¶æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š\nç®€åŒ– maven-publish æ’ä»¶çš„é…ç½®æµç¨‹ï¼› æ·»åŠ ä¸Šä¼ åˆ°Mavenä¸­å¿ƒä»“åº“çš„ publish ä»»åŠ¡ï¼› æ”¯æŒé…ç½®ä¸Šä¼ æ—¶æ˜¯å¦åŒ…å« javadoc åŠæºç ï¼› ç›´æ¥ä½¿ç”¨maven-publishæ’ä»¶çš„é…ç½®ï¼š import org.gradle.api.publish.maven.MavenPom plugins { id(\u0026#34;com.android.library\u0026#34;) id(\u0026#34;signing\u0026#34;) `maven-publish` } android { defaultConfig { versionName(\u0026#34;1.0.0-SNAPSHOT\u0026#34;) } } dependencies { // } tasks.register(\u0026#34;javadoc\u0026#34;, Javadoc::class.java) { group = \u0026#34;publishing\u0026#34; dependsOn(\u0026#34;assemble\u0026#34;) source = android.sourceSets[\u0026#34;main\u0026#34;].java.getSourceFiles() classpath += project.files(android.bootClasspath + File.pathSeparator) if (JavaVersion.current().isJava9Compatible) { (options as StandardJavadocDocletOptions).addBooleanOption(\u0026#34;html5\u0026#34;, true) } android.libraryVariants.forEach { libraryVariant -\u0026gt; classpath += libraryVariant.javaCompileProvider.get().classpath } options.apply { encoding(\u0026#34;UTF-8\u0026#34;) charset(\u0026#34;UTF-8\u0026#34;) isFailOnError = false (this as StandardJavadocDocletOptions).apply { // addStringOption(\u0026#34;Xdoclint:none\u0026#34;) links?.add(\u0026#34;https://developer.android.google.cn/reference/\u0026#34;) links?.add(\u0026#34;http://docs.oracle.com/javase/8/docs/api/\u0026#34;) } } } tasks.register(\u0026#34;jarSource\u0026#34;, Jar::class.java) { group = \u0026#34;publishing\u0026#34; from(android.sourceSets[\u0026#34;main\u0026#34;].java.srcDirs) archiveClassifier.set(\u0026#34;sources\u0026#34;) } tasks.register(\u0026#34;jarJavadoc\u0026#34;, Jar::class.java) { group = \u0026#34;publishing\u0026#34; dependsOn(\u0026#34;javadoc\u0026#34;) val javadoc: Javadoc = tasks.getByName(\u0026#34;javadoc\u0026#34;) as Javadoc from(javadoc.destinationDir) archiveClassifier.set(\u0026#34;javadoc\u0026#34;) } fun getMyPom(): Action\u0026lt;in MavenPom\u0026gt; { return Action\u0026lt;MavenPom\u0026gt; { name.set(\u0026#34;Android Common Utils Lib\u0026#34;) description.set(\u0026#34;Android Common Utils Library For HJ\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/lib_common_utils\u0026#34;) licenses { license { name.set(\u0026#34;The Apache License, Version 2.0\u0026#34;) url.set(\u0026#34;http://www.apache.org/licenses/LICENSE-2.0.txt\u0026#34;) } } developers { developer { id.set(\u0026#34;hanlyjiang\u0026#34;) name.set(\u0026#34;Hanly Jiang\u0026#34;) email.set(\u0026#34;hanlyjiang@outlook.com\u0026#34;) } } scm { connection.set(\u0026#34;scm:git:git://github.com/hanlyjiang/lib_common_utils.git\u0026#34;) developerConnection.set(\u0026#34;scm:git:ssh://github.com/hanlyjiang/lib_common_utils.git\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/lib_common_utils\u0026#34;) } } } afterEvaluate { publishing { publications { create\u0026lt;MavenPublication\u0026gt;(\u0026#34;release\u0026#34;) { from(components.getByName(\u0026#34;release\u0026#34;)) groupId = \u0026#34;com.github.hanlyjiang\u0026#34; artifactId = \u0026#34;android_common_utils\u0026#34; version = android.defaultConfig.versionName pom(getMyPom()) // æ·»åŠ javadoc artifact(tasks.getByName(\u0026#34;jarJavadoc\u0026#34;) as Jar) // æ·»åŠ source artifact(tasks.getByName(\u0026#34;jarSource\u0026#34;) as Jar) } } repositories { val ossrhCredentials = Action\u0026lt;PasswordCredentials\u0026gt; { username = properties[\u0026#34;ossrhUsername\u0026#34;].toString() password = properties[\u0026#34;ossrhPassword\u0026#34;].toString() } // sonarçš„ä»“åº“ï¼Œåœ°å€æ ¹æ®é¡¹ç›®çš„ç‰ˆæœ¬å·æ¥ç¡®å®šæ˜¯snapshotè¿˜æ˜¯æ­£å¼ä»“åº“ maven { name = \u0026#34;Sonartype\u0026#34; val releasesRepoUrl = uri(\u0026#34;https://oss.sonatype.org/service/local/staging/deploy/maven2\u0026#34;) val snapshotsRepoUrl = uri(\u0026#34;https://oss.sonatype.org/content/repositories/snapshots/\u0026#34;) url = if (android.defaultConfig.versionName.toString().endsWith(\u0026#34;SNAPSHOT\u0026#34;)) snapshotsRepoUrl else releasesRepoUrl credentials(ossrhCredentials) // snapshotçš„åœ°å€ï¼š // https://oss.sonatype.org/content/repositories/snapshots/com/github/hanlyjiang/android_common_utils/ } // é¡¹ç›®æœ¬åœ°çš„ä»“åº“ maven { name = \u0026#34;ProjectLocal\u0026#34; val releasesRepoUrl = uri(layout.buildDirectory.dir(\u0026#34;repos/releases\u0026#34;)) val snapshotsRepoUrl = uri(layout.buildDirectory.dir(\u0026#34;repos/snapshots\u0026#34;)) url = if (android.defaultConfig.versionName.toString().endsWith(\u0026#34;SNAPSHOT\u0026#34;)) snapshotsRepoUrl else releasesRepoUrl } } } signing { sign(publishing.publications.getByName(\u0026#34;release\u0026#34;)) } } ä½¿ç”¨AndroidMavenPubPluginç®€åŒ–åçš„é…ç½®ï¼š import org.gradle.api.publish.maven.MavenPom plugins { id(\u0026#34;com.android.library\u0026#34;) id(\u0026#34;signing\u0026#34;) `maven-publish` // å¼•å…¥æˆ‘ä»¬æœ¬åœ°ä»“åº“ä¸­çš„gradleæ’ä»¶ id(\u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) version (\u0026#34;0.0.5\u0026#34;) apply (false) } android { defaultConfig { versionName(\u0026#34;1.0.1-SNAPSHOT\u0026#34;) } } dependencies { // } apply(plugin = \u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) configure\u0026lt;io.hanlyjiang.gradle.android.AndroidMavenPubPluginExtension\u0026gt; { groupId.set(\u0026#34;com.github.hanlyjiang\u0026#34;) artifactId.set(\u0026#34;android-common-utils\u0026#34;) projectLocalRepoPath.set(\u0026#34;local-maven-repo\u0026#34;) mavenPomAction.set(Action\u0026lt;MavenPom\u0026gt; { name.set(\u0026#34;Android Common Utils Lib\u0026#34;) description.set(\u0026#34;Android Common Utils Library For HJ\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/lib_common_utils\u0026#34;) properties.set( mapOf( \u0026#34;myProp\u0026#34; to \u0026#34;value\u0026#34;, \u0026#34;prop.with.dots\u0026#34; to \u0026#34;anotherValue\u0026#34; ) ) licenses { license { name.set(\u0026#34;The Apache License, Version 2.0\u0026#34;) url.set(\u0026#34;http://www.apache.org/licenses/LICENSE-2.0.txt\u0026#34;) } } developers { developer { id.set(\u0026#34;hanlyjiang\u0026#34;) name.set(\u0026#34;Hanly Jiang\u0026#34;) email.set(\u0026#34;hanlyjiang@outlook.com\u0026#34;) } } scm { connection.set(\u0026#34;scm:git:git://github.com/hanlyjiang/lib_common_utils.git\u0026#34;) developerConnection.set(\u0026#34;scm:git:ssh://github.com/hanlyjiang/lib_common_utils.git\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/lib_common_utils\u0026#34;) } }) } ä½¿ç”¨æ­¥éª¤ å¼•å…¥æ’ä»¶ åœ¨éœ€è¦ä½¿ç”¨çš„æ¨¡å—çš„buildè„šæœ¬ä¸­ï¼Œå¼•å…¥æˆ‘ä»¬çš„æ’ä»¶ï¼ŒåŒæ—¶å¼•å…¥ maven-publish æ’ä»¶å’Œ signing æ’ä»¶ã€‚\nkotlin.kts è„šæœ¬å†™æ³• plugins { id(\u0026#34;com.android.library\u0026#34;) // å¼•å…¥signingæ’ä»¶ id(\u0026#34;signing\u0026#34;) // å¼•å…¥maven-publishæ’ä»¶ `maven-publish` // å¼•å…¥ android_maven_pub æ’ä»¶ï¼Œæ³¨æ„è¿™é‡Œè®¾ç½® apply ä¸º falseï¼Œè¡¨ç¤ºå¼•å…¥ä½†æ˜¯ä¸åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ”¾åœ¨androidé…ç½®æ®µå®šä¹‰ä¹‹åå†åº”ç”¨ id(\u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) version (\u0026#34;0.0.5\u0026#34;) apply (false) } groovy çš„å†™æ³• plugins { id \u0026#39;com.android.library\u0026#39; id \u0026#39;signing\u0026#39; id \u0026#39;maven-publish\u0026#39; id(\u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) version(\u0026#34;0.0.5\u0026#34;) apply(false) } é…ç½® gradle åœ¨å¼•å…¥ AndroidMavenPubPlugin æ’ä»¶ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ’ä»¶è¿›è¡Œé…ç½®ã€‚ å»ºè®®å°†è„šæœ¬è½¬æ¢ä¸º kotlin dsl çš„å†™æ³•ï¼Œèƒ½æœ‰å¯¹åº”çš„è‡ªåŠ¨æç¤ºï¼›\nkotlin dsl å†™æ³• android { } // éœ€è¦å…ˆåº”ç”¨æ’ä»¶ï¼Œåœ¨androidé…ç½®å®Œæˆä¹‹åï¼Œå»ºè®®æ”¾åœ¨è„šæœ¬æœ€ä¸‹æ–¹ apply(plugin = \u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) configure\u0026lt;io.hanlyjiang.gradle.android.AndroidMavenPubPluginExtension\u0026gt; { groupId.set(\u0026#34;com.github.hanlyjiang\u0026#34;) artifactId.set(\u0026#34;android_common_utils\u0026#34;) mavenPomAction.set(Action\u0026lt;MavenPom\u0026gt; { name.set(\u0026#34;Android Common Utils Lib\u0026#34;) description.set(\u0026#34;Android Common Utils Library For HJ\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/lib_common_utils\u0026#34;) properties.set( mapOf( \u0026#34;myProp\u0026#34; to \u0026#34;value\u0026#34;, \u0026#34;prop.with.dots\u0026#34; to \u0026#34;anotherValue\u0026#34; ) ) licenses { license { name.set(\u0026#34;The Apache License, Version 2.0\u0026#34;) url.set(\u0026#34;http://www.apache.org/licenses/LICENSE-2.0.txt\u0026#34;) } } developers { developer { id.set(\u0026#34;hanlyjiang\u0026#34;) name.set(\u0026#34;Hanly Jiang\u0026#34;) email.set(\u0026#34;hanlyjiang@outlook.com\u0026#34;) } } scm { connection.set(\u0026#34;scm:git:git://github.com/hanlyjiang/lib_common_utils.git\u0026#34;) developerConnection.set(\u0026#34;scm:git:ssh://github.com/hanlyjiang/lib_common_utils.git\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/lib_common_utils\u0026#34;) } }) } groovy è„šæœ¬å†™æ³• apply plugin: \u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34; android_maven_pub { groupId.set(\u0026#34;com.github.hanlyjiang\u0026#34;) artifactId.set(\u0026#34;android-common-utils\u0026#34;) mavenPomAction.set({ pom -\u0026gt; pom.with { name.set(\u0026#39;HJ Android Plugin Framework\u0026#39;) description.set(\u0026#34;A Android Plugin Framework\u0026#34;) url.set(\u0026#34;https://github.com/hanlyjiang/apf-library\u0026#34;) licenses { license { name = \u0026#39;The Apache Software License, Version 2.0\u0026#39; url = \u0026#39;http://www.apache.org/licenses/LICENSE-2.0.txt\u0026#39; } } developers { developer { id = \u0026#39;hanlyjiang\u0026#39; name = \u0026#39;hanly jiang\u0026#39; email = \u0026#39;hanlyjiang@outlook.com\u0026#39; } } scm { connection = \u0026#39;https://github.com/hanlyjiang/apf-library\u0026#39; developerConnection = \u0026#39;https://github.com/hanlyjiang/apf-library.git\u0026#39; url = \u0026#39;https://github.com/hanlyjiang/apf-library\u0026#39; } } } as Action\u0026lt;MavenPom\u0026gt;) } âš ï¸æ³¨æ„ï¼š\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œå¹¶æ²¡æœ‰å®šä¹‰ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬å·ä» android.defaultConfig.versionName ä¸­å– ï¼›\nåŒæ—¶ï¼Œå¦‚æœç‰ˆæœ¬å·ç»“å°¾ä¸º -SNAPSHOTï¼Œåˆ™ä¼šå‘å¸ƒåˆ° snapshot ä»“åº“ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å‘å¸ƒåˆ° release ä»“åº“ï¼›\nmavenä»“åº“çš„å±æ€§æ–‡ä»¶é…ç½® ä¸Šä¼ åˆ°maven centerä¸­å¿ƒä»“åº“éœ€è¦è¿›è¡Œä¸€äº›è´¦å·ç”³è¯·å’Œkeyçš„ç”Ÿæˆæ“ä½œï¼Œå¯ä»¥å‚è€ƒJcenter åœæ­¢æœåŠ¡ï¼Œè¯´ä¸€è¯´æˆ‘ä»¬çš„è¿ç§»æ–¹æ¡ˆ - InfoQ å†™ä½œå¹³å° æ¥å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦å°†æœ€åè·å–åˆ°çš„è®¤è¯ä¿¡æ¯ï¼š\næŒ‰å¦‚ä¸‹é…ç½®ï¼Œå°†å¯¹åº”çš„ value çš„å€¼æ›´æ”¹ä¸ºè‡ªå·±çš„è´¦å·åŠ key çš„å¯¹åº”å€¼ï¼Œç„¶åå¡«å…¥åˆ° ~/.gradle/gradle.properties ä¸­å³å¯\n# é…ç½®mavenä¸­å¿ƒä»“åº“è®¿é—®è´¦å· ossrhUsername=sonatype jira è´¦å·çš„ç”¨æˆ·å ossrhPassword=sonatype jira è´¦å·çš„å¯†ç  # é…ç½®ç­¾åä¿¡æ¯ signing.keyId=å…¬é’¥ ID çš„å 8 ä½ signing.password=é’¥åŒ™ä¸²çš„å¯†ç  signing.secretKeyRingFile=å¯¼å‡ºçš„ gpg æ–‡ä»¶è·¯å¾„ å¦‚ï¼š /Users/hanlyjiang/.gnupg/secring.gpg âš ï¸æ³¨æ„ï¼š è¿™é‡Œçš„ key æ˜¯å›ºå®šçš„ï¼Œä¸è¦ä¿®æ”¹\næ‰§è¡Œä¸Šä¼ ä»»åŠ¡ ç»è¿‡ä¸Šé¢çš„é…ç½®ï¼Œæˆ‘ä»¬åŒæ­¥ä¸‹ gradle ï¼Œå¯¹åº”å¼•å…¥äº†æ’ä»¶çš„é¡¹ç›®ä¸­ä¼šç”Ÿæˆè‹¥å¹²ä»»åŠ¡ï¼š\nå…¶ä¸­ï¼š\njarJavadoc, jarSource,javadoc ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„è¾…åŠ©ä»»åŠ¡ publish åŠ generate å¼€å¤´çš„ä¸º mave-publish æ’ä»¶ç”Ÿæˆçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬æ‰§è¡Œ publish ç›¸å…³çš„ä»»åŠ¡å³å¯å‘å¸ƒ maven åº“ï¼› publish ç›¸å…³çš„ä»»åŠ¡æœ‰å¦‚ä¸‹å‡ ä¸ªï¼š\nTask Name Description publish ç­‰äºæ‰§è¡Œäº†ä¸‹é¢çš„æ‰€æœ‰ä»»åŠ¡ publishAllPublicationsToProjectLocalRepository å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„æ‰€æœ‰Mavenåº“å‘å¸ƒåˆ° ProjectLocal å­˜å‚¨åº“ã€‚ ProjectLocal å®šä¹‰ä¸ºå½“å‰é¡¹ç›®çš„ build ç›®å½•çš„ mavenRepos ç›®å½•ä¸­ï¼Œæœ‰ä¸¤ä¸ªå­ç›®å½• snapshotsåŠ releaseï¼Œ æ–¹ä¾¿æŸ¥çœ‹å°†è¦å‘å¸ƒçš„ç”Ÿæˆç‰©åŠè¿›è¡Œæœ¬åœ°æµ‹è¯•ï¼› publishAllPublicationsToSonartypeRepository å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„æ‰€æœ‰ Maven åº“å‘å¸ƒåˆ° Sonartype å­˜å‚¨åº“ã€‚ publishReleasePublicationToMavenLocal å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„åä¸ºreleaseçš„ Mavenåº“å‘å¸ƒåˆ°æœ¬æœº maven ç¼“å­˜åº“ã€‚ publishReleasePublicationToProjectLocalRepository å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„åä¸ºreleaseçš„ Mavenåº“å‘å¸ƒåˆ°æœ¬æœº ProjectLocal åº“ã€‚ publishReleasePublicationToSonartypeRepository å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„åä¸ºreleaseçš„ Mavenåº“å‘å¸ƒåˆ°æœ¬æœº Sonartype åº“ã€‚ publishToMavenLocal å°†ç”±æ­¤é¡¹ç›®äº§ç”Ÿçš„æ‰€æœ‰ Maven åº“å‘å¸ƒåˆ° æœ¬æœº maven ç¼“å­˜åº“ã€‚ è¯´æ˜ï¼š\nä¸Šé¢çš„ä»»åŠ¡ç”± maven-publish çš„æ’ä»¶ç”Ÿæˆï¼Œè¯¥æ’ä»¶ç”Ÿæˆä»»åŠ¡çš„è§„åˆ™ä½¿ç”¨ Publications å’Œ Repo æ¥ç»„åˆå®ç°ï¼Œå…¶ä¸­ï¼š\npublication æ˜¯æˆ‘ä»¬å®šä¹‰çš„å‘å¸ƒåº“ï¼›android_maven_pub æ’ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸ºrelease çš„é…ç½®ï¼› repo æ˜¯æˆ‘ä»¬å®šä¹‰çš„ maven ä»“åº“çš„ä½ç½®ï¼Œandroid_maven_pub å®šä¹‰äº†ä¸¤ä¸ªä»“åº“çš„ä½ç½®ï¼Œåˆ†åˆ«åä¸º ProjectLocal å’Œ Sonartype ï¼Œå¦å¤–maven-publishä¼šç»™æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ª MavenLocal çš„é…ç½®ï¼ˆæŒ‡å‘æœ¬æœº maven ä»“åº“ç¼“å­˜ç›®å½•ï¼‰ å…¶ä¸­ ProjectLocal æŒ‡å‘å¼•å…¥äº†è¯¥æ’ä»¶çš„é¡¹ç›®ï¼ˆæ¨¡å—ï¼‰çš„ build/repos ç›®å½• Sonartype åˆ™é»˜è®¤æŒ‡å‘ maven ä¸­å¿ƒä»“åº“çš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥æ›´æ”¹ï¼› å¯é…ç½®é¡¹ç›®è¯´æ˜ é…ç½®å­—æ®µ è¯´æ˜ é»˜è®¤å€¼ groupId maven çš„ group idï¼Œéœ€è¦è®¾ç½®ä¸ºè‡ªå·±ç”³è¯·çš„ æ— é»˜è®¤å€¼-å¿…éœ€å¡«å†™ artifactId library çš„ id æ— é»˜è®¤å€¼-å¿…éœ€å¡«å†™ mavenPomAction ç”¨äºé…ç½® pom ä¿¡æ¯çš„å­—æ®µ æ— é»˜è®¤å€¼-å¿…éœ€å¡«å†™ fromAndroidPubName è¡¨ç¤ºå‘å¸ƒçš„ android çš„ aar çš„ç±»å‹ï¼Œrelease æˆ– debug release releasesRepoUrl maven release ä»“åº“çš„ä¸Šä¼ åœ°å€ https://oss.sonatype.org/service/local/staging/deploy/maven2 snapshotsRepoUrl maven snapshots ä»“åº“çš„ä¸Šä¼ åœ°å€ https://oss.sonatype.org/content/repositories/snapshots/ includeSourceJar æ˜¯å¦ä¸Šä¼ æºç  true includeJavadocJar æ˜¯å¦ä¸Šä¼  javadoc true projectLocalRepoPath æœ¬åœ°ä»“åº“çš„ç›®å½•ï¼Œç›¸å¯¹äºrootProjectçš„ç›®å½•ï¼Œå¦‚ï¼šlocal-maven-repo é»˜è®¤ä½äºæ ¹é¡¹ç›®çš„ build/mavenRepos ç›®å½•ä¸­ å¸¸è§é—®é¢˜ å‘å¸ƒåˆ° snapshot æˆ‘ä»¬æ ¹æ®ç‰ˆæœ¬å·æ¥é€‰æ‹©å‘å¸ƒåˆ°çš„æ˜¯ snapshot è¿˜æ˜¯ release ä»“åº“ï¼Œç‰ˆæœ¬å·ä» android-\u0026gt;defaultConfig - versionName ä¸­è¯»å–ï¼Œå¦‚ï¼š\nandroid { compileSdkVersion(30) buildToolsVersion(\u0026#34;30.0.3\u0026#34;) defaultConfig { minSdkVersion(22) targetSdkVersion(30) versionCode(1) versionName(\u0026#34;1.0.0-SNAPSHOT\u0026#34;) } } å‘å¸ƒåˆ°æœ¬åœ°å¹¶è¿›è¡Œæµ‹è¯• é¦–å…ˆæˆ‘ä»¬é€šè¿‡ projectLocalRepoPath æ¥æ”¹å˜ ProjectLocal ä»“åº“çš„ç›®å½•ï¼Œä¸‹é¢çš„ç¤ºä¾‹ä¸­å°†å…¶è®¾ç½®ä¸º rootProject çš„ local-maven-repo ç›®å½•ä¸­\napply(plugin = \u0026#34;com.github.hanlyjiang.android_maven_pub\u0026#34;) configure\u0026lt;io.hanlyjiang.gradle.android.AndroidMavenPubPluginExtension\u0026gt; { groupId.set(\u0026#34;com.github.hanlyjiang\u0026#34;) artifactId.set(\u0026#34;android-common-utils\u0026#34;) projectLocalRepoPath.set(\u0026#34;local-maven-repo\u0026#34;) // ... } æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰æœ¬åœ°çš„ Repo ï¼Œè§ä¸‹æ–¹åä¸º ProjectLocal-Snapshots åŠ ProjectLocal-Release çš„ä»“åº“ã€‚\nallprojects { repositories { maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/jcenter\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/google\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/gradle-plugin\u0026#34;) } maven { setUrl(\u0026#34;https://maven.aliyun.com/repository/public\u0026#34;) } // å®šä¹‰æœ¬åœ°repoè·¯å¾„ maven { name = \u0026#34;ProjectLocal-Snapshots\u0026#34; setUrl(File(rootProject.rootDir, \u0026#34;local-maven-repo${File.separator}snapshots\u0026#34;)) } maven { name = \u0026#34;ProjectLocal-Release\u0026#34; setUrl(File(rootProject.rootDir, \u0026#34;local-maven-repo${File.separator}release\u0026#34;)) } maven { name = \u0026#34;Sonatype-Snapshots\u0026#34; setUrl(\u0026#34;https://oss.sonatype.org/content/repositories/snapshots\u0026#34;) // setUrl(\u0026#34;https://s01.oss.sonatype.org/content/repositories/snapshots\u0026#34;) // snapshotå¯ä»¥ä¸ç”¨ç”¨æˆ·åå¯†ç  // æŸ¥çœ‹è‡ªå·±çš„snapshotç‰ˆæœ¬ï¼š https://oss.sonatype.org/content/repositories/snapshots/com/github/hanlyjiang/ credentials(PasswordCredentials::class.java) { username = property(\u0026#34;ossrhUsername\u0026#34;).toString() password = property(\u0026#34;ossrhPassword\u0026#34;).toString() } } maven { name = \u0026#34;Sonatype-Staging\u0026#34; setUrl(\u0026#34;https://oss.sonatype.org/service/local/staging/deploy/maven2/\u0026#34;) // setUrl(\u0026#34;https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/\u0026#34;) credentials(PasswordCredentials::class.java) { username = property(\u0026#34;ossrhUsername\u0026#34;).toString() password = property(\u0026#34;ossrhPassword\u0026#34;).toString() } } } } ","permalink":"https://hanlyjiang.github.io/posts/jian-hua-android-ku-shang-chuan-dao-maven-cang-ku-de-gradle-pei-zhi/","summary":"\u003cp\u003eé…ç½® android ä¸Šä¼ åˆ° maven ä¸­å¿ƒä»“åº“ï¼Œå‘ç°é…ç½®çš„ä»£ç æœ‰ç‚¹å¤šï¼Œè€Œä¸”å¦‚æœæœ‰å¤šä¸ªåº“æ¨¡å—éœ€è¦ä¸Šä¼ ï¼Œåˆ™éœ€è¦å¤åˆ¶ç²˜è´´ä¸å°‘é‡å¤çš„é…ç½®ä»£ç ï¼Œäºæ˜¯ç¼–å†™äº†ä¸€ä¸ª gradle æ’ä»¶ç”¨äºç®€åŒ–æå–è¿™ä¸ªé…ç½®è¿‡ç¨‹ï¼›\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"æ’ä»¶ç”¨é€”åŠæ•ˆæœ\"\u003eæ’ä»¶ç”¨é€”åŠæ•ˆæœ\u003c/h2\u003e\n\u003cp\u003eæœ¬æ’ä»¶ç”¨äºç®€åŒ–Androidåº“ä¸Šä¼ åˆ°Mavenä¸­å¿ƒä»“åº“çš„é…ç½®ï¼Œé¿å…æ¯ä¸ªprojectçš„gradleä¸­éƒ½æ”¾ç½®ä¸€ä»½é‡å¤è¾ƒå¤šçš„é…ç½®ï¼›\u003c/p\u003e","title":"ç®€åŒ–Androidåº“ä¸Šä¼ åˆ°Mavenä»“åº“çš„gradleé…ç½®"},{"content":"æœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•åŸºäºGitlabæ¥é…ç½®ä¸€ä¸ªæœåŠ¡é›†ç¾¤çš„è‡ªåŠ¨æ„å»ºä¸éƒ¨ç½²æ›´æ–°ï¼Œå…¶ä¸­æœåŠ¡çš„æ›´æ–°åŸºäºdockeræ¥å®Œæˆï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨å¦‚ä½•å®Œæˆéƒ¨ç½²æ“ä½œï¼ŒåŠå¦‚ä½•å®Œæˆgitlabä¸Šciçš„é…ç½®ï¼›åœ¨å®Œæˆå•ä¸€çš„æœåŠ¡è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åï¼Œæˆ‘ä»¬é€šè¿‡gitlabçš„includeåŠtriggeræœºåˆ¶æ¥ç®€åŒ–ç»Ÿä¸€éƒ¨ç½²æµç¨‹ï¼›\nå‰è¨€ æˆ‘ä»¬éœ€è¦å®ç°æœåŠ¡çš„è‡ªåŠ¨æ„å»ºåçš„è‡ªåŠ¨æ›´æ–°éƒ¨ç½²ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬åªéœ€è¦èƒ½åšåˆ°æ›´æ–°éƒ¨ç½²çš„æœåŠ¡å³å¯ï¼ŒæœåŠ¡çš„åˆæ¬¡éƒ¨ç½²å±äºä½é¢‘æ“ä½œï¼Œä¸”å’ŒæœåŠ¡å™¨ç¯å¢ƒç›¸å…³ï¼Œéœ€è¦æ‰‹åŠ¨æ¥å®Œæˆï¼›æˆ‘ä»¬è¿™é‡Œå‡å®šæœºå™¨ä¸Šå·²ç»éƒ¨ç½²å¥½äº†æœåŠ¡ï¼›\nå•ä¸€é¡¹ç›®çš„è‡ªåŠ¨éƒ¨ç½²çš„ç¤ºä¾‹ è¿™é‡Œæˆ‘ä»¬é¦–å…ˆä»¥ä¸€ä¸ªspringbootçš„æœåŠ¡ä½œä¸ºç¤ºä¾‹ï¼Œå®ç°äº†æ•´ä¸ªè‡ªåŠ¨æ‰“åŒ…åŠéƒ¨ç½²æ›´æ–°çš„æµç¨‹ï¼›\næ•ˆæœ æäº¤ä¹‹åï¼Œè‡ªåŠ¨æ„å»ºjarï¼Œå¹¶æ‰“åŒ…dockeré•œåƒ\næ„å»ºå®Œæˆåï¼Œé€šè¿‡gitlabç•Œé¢ï¼Œå¯ä»¥è§¦å‘éƒ¨ç½²ï¼Œå®Œæˆåå¯ä»¥è®¿é—®å¯¹åº”çš„ç¯å¢ƒï¼ˆè¯¦è§ä¸‹æ–¹è¯´æ˜ï¼‰\nè§¦å‘éƒ¨ç½²æ­¥éª¤çš„æ–¹å¼ è§¦å‘éƒ¨ç½²æœ‰å¤šä¸ªå…¥å£ï¼š\næµæ°´çº¿åˆ—è¡¨å°¾éƒ¨çš„æ‰‹åŠ¨ä½œä¸šæŒ‰é’®\næµæ°´çº¿åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»å¯¹åº”çš„æ‰‹åŠ¨ä»»åŠ¡ï¼Œåœ¨å¼¹å‡ºæ¡†ä¸­ç‚¹å‡»è¿è¡Œ\næµæ°´çº¿è¯¦æƒ…ä¸­ï¼Œç‚¹å‡»è§¦å‘éƒ¨ç½²\nå¯¹åº”æ‰‹åŠ¨ä½œä¸šçš„è¯¦æƒ…ä¸­ï¼Œç‚¹å‡»â€œè§¦å‘æ­¤æ‰‹åŠ¨æ“ä½œâ€\nä½œä¸šåˆ—è¡¨ä¸­å¯¹åº”çš„éƒ¨ç½²ä½œä¸šçš„å°¾éƒ¨\nè®¿é—®éƒ¨ç½²ç¯å¢ƒçš„æ–¹å¼ éƒ¨ç½²ä¹‹åï¼Œä¼šåœ¨gitlabä¸­ç”Ÿæˆä¸€ä¸ªç¯å¢ƒï¼Œåœ¨ç¯å¢ƒçš„ç›¸å…³ç•Œé¢å³å¯è®¿é—®å¯¹åº”çš„æœåŠ¡åœ°å€\nåœ¨é¡¹ç›®çš„â€œè¿ç»´-ç¯å¢ƒâ€å…¥å£å¯ä»¥æŸ¥çœ‹æ‰€æœ‰çš„ç¯å¢ƒ ç‚¹å‡»å¯¹åº”ç¯å¢ƒå°¾éƒ¨çš„é“¾æ¥å›¾æ ‡å³å¯è®¿é—®\nä¹Ÿå¯ä»¥åœ¨å¯¹åº”çš„ç¯å¢ƒè¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»â€œæŸ¥çœ‹éƒ¨ç½²â€ ï¼ˆæ³¨æ„åœ¨éƒ¨ç½²ä½œä¸šçš„è¯¦æƒ…ä¸­ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”ç¯å¢ƒçš„å…¥å£å“¦-è§¦å‘éƒ¨ç½²æ­¥éª¤çš„æ–¹å¼çš„ç¬¬å››ä¸­æ–¹å¼çš„é™„å›¾ï¼‰\nå®ç°æ–¹å¼ æˆ‘ä»¬æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼š\næ„å»ºjar æ„å»ºdockeré•œåƒ éƒ¨ç½²æœåŠ¡ï¼ˆé€šè¿‡swarmï¼‰ å…¶ä¸­æ„å»ºjarå’Œæ„å»ºdockeré•œåƒæ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œéƒ¨ç½²æ­¥éª¤åˆ™éœ€è¦æ‰‹åŠ¨é€šè¿‡gitlabç•Œé¢è¿›è¡Œè§¦å‘ï¼›\ngitlab-ci.yml é…ç½® variables: # é…ç½®ä»“åº“ç¯å¢ƒ DOCKER_REGISTRY: zh-registry.colorless.com.cn DOCKER_NAMESPACE: colorless DEPLOY_PATH: /Wksp/colorlessWork/colorless-deploy/deploy/ # é…ç½®é•œåƒæœåŠ¡å SERVICE_NAME: graphql-token stages: - test - build - build_image - deploy # å¼•å…¥ä»£ç æ£€æŸ¥ä»»åŠ¡ #include: # local: ci/gitlab-ci-sonar.yml build:jar: # éƒ¨åˆ†æ¨¡å—è‹¥ä¸ä½¿ç”¨1.8ç¼–è¯‘ä¼šæŠ¥é”™ image: maven:3.6.3-jdk-8 stage: build script: - mvn package - mkdir _archiver - cp target/*.jar _archiver/ - ls -lh _archiver/ artifacts: name: \u0026#34;dist-$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA\u0026#34; paths: - _archiver/*.jar # ç”Ÿæˆçš„å½’æ¡£åŒ…æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬åªä¿ç•™çŸ­æ—¶é—´ expire_in: 1 hours tags: - common-build only: - master - web build:docker: stage: build_image script: # ç™»å½•å…¬å¸çš„Harborï¼Œæ³¨æ„å¿…é¡»åœ¨ç¯å¢ƒå˜é‡é…ç½® HARBOR_PWD - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin # å®šä¹‰é•œåƒTAG - IMAGE_NAME=$DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA - echo \u0026#34;Docker build options $DOCKER_OPTIONS, set DOCKER_OPTIONS to --no-cache force rebuild all stage\u0026#34; - cp _archiver/*.jar docker/ # buildé•œåƒ - JAR_FILE=`ls docker/ | grep -E *.jar` - echo $JAR_FILE - docker build $DOCKER_OPTIONS --build-arg JAR_FILE=$JAR_FILE -t $IMAGE_NAME ./docker/ # æ¨é€é•œåƒ - docker push $IMAGE_NAME - echo \u0026#34;é•œåƒæ„å»ºå®Œæˆï¼š$IMAGE_NAME\u0026#34; tags: - docker only: - master - web deploy: stage: deploy script: - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin - cd $DEPLOY_PATH - source deploy.sh - update_service $DOCKER_NAMESPACE $SERVICE_NAME $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA environment: name: test_env_deploy url: $APP_URL/ when: manual only: - branches - web tags: - deploy_graphql æ³¨æ„ deploy ä»»åŠ¡ä¸­å®šä¹‰çš„ç¯å¢ƒé…ç½®ï¼š\nenvironment: name: test_env_deploy url: $APP_URL/ when: manual é€šè¿‡environmenté…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨gitlabçš„ â€œè¿ç»´-ç¯å¢ƒâ€ ä¸­ç”Ÿæˆä¸€æ¡ç¯å¢ƒä¿¡æ¯ï¼Œä¸€ä¸ªç¯å¢ƒä¿¡æ¯å³å¯¹åº”ä¸€ä¸ªéƒ¨ç½²æœåŠ¡ï¼›\nå®šä¹‰ç¯å¢ƒä¿¡æ¯ï¼Œéœ€è¦é…ç½®nameå’Œurlä¸¤ä¸ªå­—æ®µï¼Œå…¶ä¸­nameæ˜¯ç¯å¢ƒåç§°ï¼Œurlåˆ™åº”æŒ‡å‘æœåŠ¡çš„åœ°å€ï¼Œè¯¥urlå³æ˜¯æˆ‘ä»¬åœ¨gitlabç¯å¢ƒä¸­æŸ¥çœ‹éƒ¨ç½²æ—¶è·³è½¬çš„é¡µé¢ï¼›\nè¿™é‡Œçš„urlæˆ‘ä»¬é€šè¿‡å˜é‡æ¥è¿›è¡Œé…ç½®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™æ­»ï¼›\næ³¨æ„è¿™é‡Œçš„nameä¸èƒ½è®¾ç½®ä¸ºä¸­æ–‡ï¼›\né€šè¿‡å°†when è®¾ç½®ä¸º manual ï¼Œå¯ä»¥å°†éƒ¨ç½²ä»»åŠ¡è®¾ç½®ä¸ºæ‰‹åŠ¨è§¦å‘çš„æ–¹å¼ï¼›\nä¼˜åŒ–æ”¹è¿›æ–¹æ¡ˆç ”ç©¶ æ”¹è¿›ç›®æ ‡ æˆ‘ä»¬çš„ä¸€ä¸ªé›†ç¾¤ä¹‹ä¸­æœ‰å¤šä¸ªæœåŠ¡å•å…ƒï¼Œæ¯ä¸ªæœåŠ¡å•å…ƒæäº¤ä»£ç æ›´æ–°ä¹‹åï¼Œéƒ½éœ€è¦è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åˆ°å¯¹åº”çš„ç¯å¢ƒä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†ä¸Šé¢å•ä¸ªé¡¹ç›®ä¸­çš„æµç¨‹åœ¨æ‰€æœ‰é¡¹ç›®ä¸­éƒ½å¤åˆ¶ä¸€éï¼Œä¸è¿‡ï¼š\né‡å¤å·¥ä½œè¾ƒå¤šï¼Œä¸€æ—¦éƒ¨ç½²è„šæœ¬å‘ç”Ÿå˜åŒ–ï¼Œæ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦å•ç‹¬å˜åŒ– æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦é…ç½®åˆ°éƒ¨ç½²æœåŠ¡å™¨çš„runner æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å°†è¿™ä¸ªé‡å¤çš„æ­¥éª¤é›†ä¸­èµ·æ¥ã€‚\nå®é™…ä¸Šï¼Œæ‰“åŒ…jarå’Œæ„å»ºé•œåƒçš„æµç¨‹æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘ä¼˜åŒ–å¤ç”¨ï¼Œä¸è¿‡æˆ‘ä»¬è¿™é‡Œä¸»è¦ä¸“æ³¨äºéƒ¨ç½²çš„æ”¹è¿›ã€‚å½“æœåŠ¡è¢«æ‰“åŒ…æˆé•œåƒä¹‹åï¼Œéƒ¨ç½²çš„æµç¨‹åªå…³æ³¨äºé•œåƒï¼Œæ— éœ€é’ˆå¯¹ä¸åŒçš„æœåŠ¡è¿›è¡ŒåŒºåˆ†å¯¹å¾…ï¼Œæ˜¯éå¸¸é€‚åˆæå–ç»Ÿä¸€çš„ï¼›\nç°çŠ¶ ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å®ç°ä¸Šä¼ ä»£ç åè‡ªåŠ¨ç¼–è¯‘ï¼Œæ„å»ºé•œåƒï¼Œé€šè¿‡gitlabç•Œé¢å®ç°éƒ¨ç½²äº†ã€‚ä¸è¿‡é¡¹ç›®æ¯”è¾ƒå¤šæ—¶ï¼Œæˆ‘ä»¬æ¯ä¸ªéƒ½å¦‚æ­¤é…ç½®ï¼Œä¸€æ—¦éœ€è¦æ”¹åŠ¨ï¼Œä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†è¿™äº›ä»»åŠ¡æå–æˆå…¬ç”¨çš„è„šæœ¬ï¼Œåœ¨é¡¹ç›®ä¸­è¿›è¡Œå¼•å…¥ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬å°è¯•å°†è¿™éƒ¨ç½²ä»»åŠ¡æå–æˆå…¬å…±çš„ã€‚\nå®é™…ä¸Šï¼Œä¸Šé¢çš„éƒ¨ç½²æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»éƒ¨ç½²æ›´æ–°çš„æµç¨‹åšäº†å°è£…ï¼Œå…·ä½“è„šæœ¬å¦‚ä¸‹ï¼Œåœ¨æ›´æ–°æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ update_service å‡½æ•°å³å¯å®ŒæˆæœåŠ¡çš„æ›´æ–°åŠæœ¬åœ°ymléƒ¨ç½²æ–‡ä»¶çš„ä¿®æ”¹ï¼›\n# æ›´æ–°æœåŠ¡ update_service colorless graphql-engine zh-registry.colorless.com.cn/colorless/graphql-engine:1aaa7ad9 deploy.sh è„šæœ¬å†…å®¹ï¼šï¼ˆåªå…³æ³¨update_service çš„æµç¨‹å³å¯ï¼‰\n#!/usr/bin/env bash #set -eo pipefail REGISTRY_ALIYUN=registry.cn-hangzhou.aliyuncs.com/hasura REGISTRY_HARBOR=zh-registry.colorless.com.cn/colorless # éƒ¨ç½²æœåŠ¡ STACK_NAME=colorless function getSedOption() { if [ \u0026#34;$(uname)\u0026#34; = \u0026#34;Darwin\u0026#34; ]; then echo \u0026#34;-i .bak\u0026#34; else echo \u0026#34;-i.bak\u0026#34; fi } function logInfo() { echo \u0026#34;--\u0026gt;: $*\u0026#34; } function logError() { echo \u0026#34;--\u0026gt;Error: $*\u0026#34; \u0026gt;\u0026amp;2 } # è®¾ç½®éƒ¨ç½²ç›®å½• if [ \u0026#34;$0\u0026#34; = \u0026#34;-bash\u0026#34; ]; then DEPLOY_DIR=$PWD else DEPLOY_DIR=$( cd $(dirname $0) pwd ) fi echo \u0026#34;DEPLOY_DIR:$DEPLOY_DIR\u0026#34; # ä½¿ç”¨é˜¿é‡Œäº‘çš„é•œåƒ function use_aliyun_images() { sed \u0026#34;$(getSedOption)\u0026#34; \u0026#34;s|$REGISTRY_HARBOR|$REGISTRY_ALIYUN|g\u0026#34; $DEPLOY_DIR/*/*.yml } # ä½¿ç”¨å†…ç½‘ harbor é•œåƒ function use_harbor_images() { sed \u0026#34;$(getSedOption)\u0026#34; \u0026#34;s|$REGISTRY_ALIYUN|$REGISTRY_HARBOR|g\u0026#34; $DEPLOY_DIR/*/*.yml } # éƒ¨ç½²å•ä¸ªè„šæœ¬æœåŠ¡ function deploy() { service=$1 stack_name=$2 if [ -z \u0026#34;$service\u0026#34; ]; then echo \u0026#34;ç”¨æ³•ï¼šdeploy {æœåŠ¡åç§°} [stackåç§°]\u0026#34; echo \u0026#34; {æœåŠ¡åç§°} - å¯ä¸º hasuraï¼Œkafkaï¼Œevent_track\u0026#34; return fi if [ -z \u0026#34;$stack_name\u0026#34; ]; then stack_name=$STACK_NAME fi printf \u0026#34;\\n%s\\n\u0026#34; \u0026#34;è·å–é•œåƒ: $service \u0026#34; grep \u0026#34;image:\u0026#34; \u0026#34;$DEPLOY_DIR/$service/docker-compose.yml\u0026#34; | sed \u0026#39;s/image://g\u0026#39; | xargs -I {} docker pull {} printf \u0026#34;\\n%s\\n\u0026#34; \u0026#34;å¯åŠ¨æœåŠ¡: $service \u0026#34; docker stack deploy -c \u0026#34;$DEPLOY_DIR/$service/docker-compose.yml\u0026#34; $stack_name printf \u0026#34;\\n\\n\u0026#34; } function deploy_offline() { service=$1 stack_name=$2 if [ -z \u0026#34;$service\u0026#34; ]; then echo \u0026#34;ç”¨æ³•ï¼šdeploy {æœåŠ¡åç§°} [stackåç§°]\u0026#34; echo \u0026#34; {æœåŠ¡åç§°} - å¯ä¸º hasuraï¼Œkafkaï¼Œevent_track\u0026#34; return fi if [ -z \u0026#34;$stack_name\u0026#34; ]; then stack_name=$STACK_NAME fi printf \u0026#34;\\n%s\\n\u0026#34; \u0026#34;å¯åŠ¨æœåŠ¡: $service \u0026#34; docker stack deploy -c \u0026#34;$DEPLOY_DIR/$service/docker-compose.yml\u0026#34; $STACK_NAME printf \u0026#34;\\n\\n\u0026#34; } # å¯¼å‡ºä¸€ä¸ªè„šæœ¬ä¸­çš„é•œåƒ function export_images() { service=$1 if [ -z \u0026#34;$service\u0026#34; ]; then echo \u0026#34;ç”¨æ³•ï¼šdeploy {æœåŠ¡åç§°}\u0026#34; echo \u0026#34; {æœåŠ¡åç§°} - å¯ä¸º hasuraï¼Œkafkaï¼Œevent_track\u0026#34; return fi printf \u0026#34;\\n%s\\n\u0026#34; \u0026#34;å¯¼å‡ºé•œåƒ: $service \u0026#34; image_list=$(grep \u0026#34;image:\u0026#34; \u0026#34;$DEPLOY_DIR/$service/docker-compose.yml\u0026#34; | sed \u0026#39;s/image://g\u0026#39; | awk \u0026#39;{print $1}\u0026#39; | tr \u0026#34;\\n\u0026#34; \u0026#34; \u0026#34;) echo \u0026#34;docker image save --output=$DEPLOY_DIR/$service.tar $image_list\u0026#34; docker image save --output=\u0026#34;$DEPLOY_DIR/$service\u0026#34;.tar \u0026#34;$image_list\u0026#34; printf \u0026#34;\\n\\n\u0026#34; } # éƒ¨ç½²æ‰€æœ‰æœåŠ¡ # deploy_all [stack_name] # - stack_name ï¼š stack åç§°ï¼Œä¸ä¼ åˆ™ä¸º colorless function deploy_all() { stack_name=$1 if [ -z \u0026#34;$stack_name\u0026#34; ]; then stack_name=$STACK_NAME fi deploy graphql $stack_name deploy kafka $stack_name deploy \u0026#34;gpl-datacollection\u0026#34; $stack_name } # ä¸pullé•œåƒï¼Œéƒ¨ç½²æ‰€æœ‰æœåŠ¡ # deploy_all_offline [stack_name] # - stack_name ï¼š stack åç§°ï¼Œä¸ä¼ åˆ™ä¸º colorless function deploy_all_offline() { stack_name=$1 if [ -z \u0026#34;$stack_name\u0026#34; ]; then stack_name=$STACK_NAME fi deploy_offline graphql $stack_name deploy_offline kafka $stack_name deploy_offline \u0026#34;gpl-datacollection\u0026#34; $stack_name } function pull_image() { image=$1 if [ -z $image ]; then logError \u0026#34;imageå‚æ•°æœªæŒ‡å®š\u0026#34; return fi docker pull $image } function _usage_update_service() { logInfo \u0026#34;ç”¨æ³•ï¼š update_service {stack} {service} {image}\u0026#34; } # æ›´æ–°æœåŠ¡ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š # update_service {stack} {service} {image} # update_service colorless graphql-engine zh-registry.colorless.com.cn/colorless/graphql-engine:1aaa7ad9 # æœ¬å‡½æ•°æŒ‰å¦‚ä¸‹æµç¨‹æ‰§è¡Œï¼š # 1. è·å–é•œåƒï¼› # 2. æ›´æ–°æœåŠ¡ï¼›å¦‚æ›´æ–°å¤±è´¥ï¼Œåˆ™å°è¯•å›æ»šæœåŠ¡ï¼› # 3. å¦‚æ›´æ–°æˆåŠŸï¼Œåˆ™ä¿®æ”¹æœ¬åœ°ymlæ–‡ä»¶ï¼› function update_service() { # è¦æ›´æ–°çš„stack stack=$1 # è¦æ›´æ–°çš„æœåŠ¡ service=$2 # æœåŠ¡çš„é•œåƒ image=$3 if [ -z \u0026#34;$stack\u0026#34; ]; then logError \u0026#34;stack å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34; _usage_update_service return 1 fi if [ -z \u0026#34;$service\u0026#34; ]; then logError \u0026#34;service å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34; _usage_update_service return 1 fi if [ -z \u0026#34;$image\u0026#34; ]; then logError \u0026#34;image å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34; _usage_update_service return 1 fi logInfo \u0026#34;è·å–é•œåƒï¼š$image\u0026#34; pull_image \u0026#34;$image\u0026#34; if [ $? -eq 1 ]; then logError \u0026#34;é•œåƒè·å–å¤±è´¥\u0026#34; return 1 fi service_name=\u0026#34;${stack}_${service}\u0026#34; logInfo \u0026#34;å¼€å§‹æ›´æ–°æœåŠ¡ï¼šdocker service update $service_name --image=$image\u0026#34; docker service update \u0026#34;$service_name\u0026#34; --image=\u0026#34;$image\u0026#34; update_result=$? logInfo \u0026#34;å½“å‰æœåŠ¡çŠ¶æ€: \u0026#34; docker stack services $stack # æ›´æ–°å¤±è´¥ if [ $update_result -eq 1 ]; then logError \u0026#34;æ›´æ–°å¤±è´¥ï¼Œç¡®å®šæ˜¯å¦éœ€è¦å›æ»šæœåŠ¡\u0026#34; docker service ls --format=\u0026#34;{{.Image}}\u0026#34; | grep -E \u0026#34;^$image$\u0026#34; find_image=$? if [ $find_image -eq 0 ]; then logInfo \u0026#34;å¼€å§‹å›æ»šæœåŠ¡ï¼š$service_name\u0026#34; docker service rollback \u0026#34;$service_name\u0026#34; logInfo \u0026#34;å›æ»šå®Œæˆï¼Œè¾“å‡ºæœåŠ¡çŠ¶æ€ï¼š(å¯æ‰‹åŠ¨ç¡®è®¤æœåŠ¡çŠ¶æ€)\u0026#34; docker service ls else logInfo \u0026#34;æ— éœ€å›æ»š\u0026#34; fi # ç›´æ¥é€€å‡º logError \u0026#34;æ›´æ–°å¤±è´¥ï¼Œå³å°†é€€å‡ºï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡é•œåƒæ˜¯å¦æ­£å¸¸\u0026#34; return 1 fi # æ›´æ–°æˆåŠŸï¼Œå¼€å§‹æ›´æ–°æœ¬åœ°ymléƒ¨ç½²è„šæœ¬ logInfo \u0026#34;å¼€å§‹æ›´æ–°æœ¬åœ°ymléƒ¨ç½²è„šæœ¬\u0026#34; update_service_yaml_config \u0026#34;$stack\u0026#34; \u0026#34;$service\u0026#34; \u0026#34;$image\u0026#34; } # æ›´æ–°æœ¬åœ°çš„ymlæ–‡ä»¶é…ç½® function update_service_yaml_config() { # è¦æ›´æ–°çš„stack stack=$1 # è¦æ›´æ–°çš„æœåŠ¡ service=$2 # æœåŠ¡çš„é•œåƒ image=$3 if [ -z \u0026#34;$stack\u0026#34; ]; then logError \u0026#34;stack å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34; return 1 fi if [ -z \u0026#34;$service\u0026#34; ]; then logError \u0026#34;service å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34; return 1 fi if [ -z \u0026#34;$image\u0026#34; ]; then logError \u0026#34;image å‚æ•°ä¸èƒ½ä¸ºç©º\u0026#34; return 1 fi service_name=\u0026#34;${stack}_${service}\u0026#34; # æŸ¥æ‰¾éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶(æ ¹æ®æœåŠ¡åæŸ¥æ‰¾ï¼Œæ’é™¤armï¼‰ # -H è¾“å‡ºåŒ¹é…çš„æ–‡ä»¶è·¯å¾„ # -v è¿‡æ»¤æ‰ arm # -print0 | xargs -0 ç”¨äºå¤„ç†æ–‡ä»¶åä¸­å¯èƒ½å­˜åœ¨çš„ç‰¹æ®Šå­—ç¬¦ # è¿™é‡Œ /b:/b çš„åŒ¹é…æ¨¡å¼ ç¡®ä¿æœ‰ç©ºæ ¼çš„æƒ…å†µä¸‹å°½å¯èƒ½çš„åŒ¹é…åˆ°service # å®Œæˆåè¾“å‡ºç±»ä¼¼å¦‚ä¸‹ï¼š # ./graphql/docker-compose-20210325.yml: graphql-engine: # ./graphql/docker-compose.yml: graphql-engine: # è·å–éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨ # IFS=\u0026#34; \u0026#34; read -r -a file_list \u0026lt;\u0026lt;\u0026lt; find . -type f -name \u0026#34;*.yml\u0026#34; -print0 | xargs -0 -I {} grep -H \u0026#34;$service *: *$\u0026#34; {} | grep -v \u0026#34;arm\u0026#34; | awk -F: \u0026#39;{print $1}\u0026#39; | tr \u0026#34;\\n\u0026#34; \u0026#34; \u0026#34; # file_list=($(find . -type f -name \u0026#34;*.yml\u0026#34; -print0 | xargs -0 -I {} grep -H \u0026#34;$service *: *$\u0026#34; {} | grep -v \u0026#34;arm\u0026#34; | awk -F: \u0026#39;{print $1}\u0026#39; | tr \u0026#34;\\n\u0026#34; \u0026#34; \u0026#34;)) # ä¸Šé¢å˜é‡çš„å†™æ³•åœ¨gitlab-runnerä¸Šæœ‰é—®é¢˜ # for file in \u0026#34;${file_list[@]}\u0026#34;; do for file in $(find . -type f -name \u0026#34;*.yml\u0026#34; -print0 | xargs -0 -I {} grep -H \u0026#34;$service *: *$\u0026#34; {} | grep -v \u0026#34;arm\u0026#34; | awk -F: \u0026#39;{print $1}\u0026#39; | tr \u0026#34;\\n\u0026#34; \u0026#34; \u0026#34;); do logInfo å¼€å§‹ä¿®æ”¹æ–‡ä»¶:\u0026#34;$file\u0026#34; # è·å–æ–‡ä»¶ä¸­çš„é•œåƒå…¨å \u0026#34; *\u0026#34; åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼ # æ³¨æ„ï¼šè¿™é‡Œé€šè¿‡æœåŠ¡åç§°æ¥æŸ¥æ‰¾é•œåƒåç§°ï¼Œé€šè¿‡ grep -A 4 å¤šè¾“å‡ºå››è¡Œï¼Œç„¶ååœ¨è¿™å››è¡Œä¸­å¯»æ‰¾imageæ®µï¼Œä»è€Œè·å–æ–‡ä»¶ä¸­å¯¹åº”serviceçš„imageçš„å…¨å raw_image=$(grep -A 4 \u0026#34;$service *: *$\u0026#34; \u0026#34;$file\u0026#34; | grep image | sed \u0026#39;s/.*image: *//g\u0026#39;) logInfo \u0026#34;å¤‡ä»½æ–‡ä»¶: $file.bak\u0026#34; # cp -f \u0026#34;$file\u0026#34; \u0026#34;$file.bak\u0026#34; # å¼€å§‹ä¿®æ”¹æ–‡ä»¶ sed \u0026#34;$(getSedOption)\u0026#34; \u0026#34;s|$raw_image|$image|g\u0026#34; \u0026#34;$file\u0026#34; if [ $? -eq 0 ]; then confirm_ed_result=$(grep \u0026#34;$image\u0026#34; \u0026#34;$file\u0026#34;) if [ -n \u0026#34;$confirm_ed_result\u0026#34; ]; then logInfo \u0026#34;ä¿®æ”¹æˆåŠŸ\u0026#34; logInfo \u0026#34;æœåŠ¡æ›´æ–°å®Œæˆ\u0026#34; else logError \u0026#34;æ–‡ä»¶ä¿®æ”¹å¤±è´¥\u0026#34; fi else logError \u0026#34;æ–‡ä»¶ä¿®æ”¹å¤±è´¥\u0026#34; fi done } # å¯¼å‡ºæ‰€æœ‰é•œåƒ function export_all_images() { export_images graphql export_images kafka export_images \u0026#34;gpl-datacollection\u0026#34; } echo \u0026#34;å¯¼å…¥éƒ¨ç½²è„šæœ¬æˆåŠŸ\u0026#34; è°ƒæŸ¥ è§‚å¯Ÿå¦‚ä¸‹ä¸€ä¸ªå…·ä½“çš„deployçš„jobï¼Œæˆ‘ä»¬å¯ä»¥æœ‰å¦‚ä¸‹æå–æ–¹å‘ï¼š\nå°†æ•´ä¸ªjobéƒ½æå–å‡ºå»ï¼› å°†scriptæ®µæå–å‡ºæ¥ï¼› å°†éƒ¨ç½²ä»»åŠ¡é›†ä¸­åˆ°ä¸€ä¸ªå•ç‹¬çš„éƒ¨ç½²é¡¹ç›®ï¼Œå„ä¸ªæœåŠ¡æ¨¡å—æ›´æ–°åè§¦å‘éƒ¨ç½²é¡¹ç›®è¿›è¡Œéƒ¨ç½²ï¼› deploy: stage: deploy script: - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin - cd $DEPLOY_PATH #- sudo chmod 777 -R $DEPLOY_PATH éœ€è¦è‡ªè¡Œä½¿ç”¨rootç”¨æˆ·æ·»åŠ æƒé™ - echo \u0026#34;$SERVICE_NAME\u0026#34; - echo \u0026#34;$DEPLOY_PATH\u0026#34; - echo \u0026#34;$DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA\u0026#34; - source deploy.sh - update_service $DOCKER_NAMESPACE $SERVICE_NAME $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA environment: name: test_env_deploy url: $APP_URL/ when: manual only: - branches - web tags: - deploy_graphql æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¸¦ç€ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜æ¥å¯»æ‰¾ç›¸å…³çš„æŠ€æœ¯æ”¯æŒ - å³ï¼šgitlabèƒ½å¸®åŠ©æˆ‘ä»¬åšåˆ°å“ªäº›åŠä»€ä¹ˆç¨‹åº¦ï¼Ÿ\nç»è¿‡ç®€å•çš„è°ƒæŸ¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œgitlabciçš„é…ç½®ä¸­ï¼Œæœ‰ä¸€ä¸ªinclude çš„é…ç½®å¯ä»¥å¼•å…¥å¤–éƒ¨çš„yamlï¼Œæˆ‘ä»¬è¯¦ç»†äº†è§£ä¸‹è¿™ä¸ªé…ç½®ï¼ˆKeyword reference for the .gitlab-ci.yml file | GitLabï¼‰\nè€Œæå–è„šæœ¬æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¡®å®šå¯ä»¥å®ç°çš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸äºˆè°ƒæŸ¥ï¼›\ninclude ç”¨é€”ï¼š\nåœ¨cié…ç½®ä¸­å¯¼å…¥å¤–éƒ¨çš„yamlé…ç½®ï¼› æ‹†åˆ†é•¿çš„é…ç½®ï¼Œæå‡å¯è¯»æ€§ï¼› æå–å…¬å…±çš„é…ç½®ï¼Œå‡å°‘é‡å¤é…ç½®ï¼› æ‹†åˆ†æ”¾ç½®åˆ°ä¸­å¿ƒä»“åº“ï¼Œåœ¨å…¶ä»–é¡¹ç›®ä¸­å¼•å…¥ï¼› æ”¯æŒçš„æºï¼š\nKeyword Method local æœ¬é¡¹ç›®ä¸­çš„æ–‡ä»¶ file å¼•å…¥å…¶ä»–é¡¹ç›®ä¸­çš„æ–‡ä»¶ remote å¼•å…¥è¿œç¨‹çš„URLä¸­çš„æ–‡ä»¶ï¼ˆå¿…é¡»èƒ½è¢«å…¬å¼€è®¿é—®åˆ°ï¼‰ template å¼•å…¥Gitlabæä¾›çš„æ¨¡æ¿æ–‡ä»¶ è¿™é‡Œæˆ‘ä»¬ä¸»è¦æŸ¥çœ‹file- å³å¦‚ä½•å¼•å…¥å…¶ä»–é¡¹ç›®ä¸­çš„æ–‡ä»¶ï¼›\nåŸºæœ¬ç”¨æ³•ï¼šï¼ˆéœ€è¦ä½¿ç”¨projectæŒ‡å®šé¡¹ç›®ï¼‰\né¡¹ç›®çš„åœ°å€æ˜¯ç›¸å¯¹äºæ ¹ç›®å½•ï¼ˆ/ï¼‰\ninclude: - project: \u0026#39;my-group/my-project\u0026#39; file: \u0026#39;/templates/.gitlab-ci-template.yml\u0026#39; æŒ‡å®šåˆ†æ”¯/Tag/æäº¤ï¼š(é€šè¿‡refæŒ‡å®š)\ninclude: - project: \u0026#39;my-group/my-project\u0026#39; ref: main file: \u0026#39;/templates/.gitlab-ci-template.yml\u0026#39; - project: \u0026#39;my-group/my-project\u0026#39; ref: v1.0.0 file: \u0026#39;/templates/.gitlab-ci-template.yml\u0026#39; - project: \u0026#39;my-group/my-project\u0026#39; ref: 787123b47f14b552955ca2786bc9542ae66fee5b # Git SHA file: \u0026#39;/templates/.gitlab-ci-template.yml\u0026#39; åŒæ—¶å¼•å…¥å¤šä¸ªæ–‡ä»¶ï¼šï¼ˆfileä¸­ä½¿ç”¨æ•°ç»„è¯­æ³•ï¼‰\ninclude: - project: \u0026#39;my-group/my-project\u0026#39; ref: main file: - \u0026#39;/templates/.builds.yml\u0026#39; - \u0026#39;/templates/.tests.yml\u0026#39; åµŒå¥—å¼•å…¥ï¼š\næ‰€æœ‰åµŒå¥—çš„includeséƒ½åœ¨å½“å‰ç›®æ ‡é¡¹ç›®çš„èŒƒå›´å†…æ‰§è¡Œï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨local (ç›¸å¯¹äºç›®æ ‡é¡¹ç›®), project, remote, æˆ–è€… template includesã€‚\nå¯ä»¥æœ€å¤šæœ‰ 100 ä¸ª includesï¼›\nä¸èƒ½æœ‰é‡å¤çš„include\nåœ¨GitLab 12.4 åŠåç»­ç‰ˆæœ¬ä¸­, è§£ææ‰€æœ‰æ–‡ä»¶çš„æ—¶é—´è¢«é™åˆ¶åœ¨30ç§’ä¹‹å†…ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è€ƒè™‘æ–‡ä»¶çš„å¤æ‚åº¦ï¼›\næƒé™ï¼š\næ‰§è¡Œäººéœ€è¦å…·æœ‰é¡¹ç›®çš„æƒé™ï¼›\nAll nested includes are executed only with the permission of the user, so itâ€™s possible to use project, remote or template includes.\ntrigger gitlabå¯ä»¥ä½¿ç”¨triggeræ¥è§¦å‘å¤šé¡¹ç›®æ„å»ºï¼Œåœ¨gitlab-cié…ç½®ä¸­ï¼Œå¯ä»¥ä½¿ç”¨triggeræ¥å®šä¹‰ä¸€ä¸ªä¸‹æ¸¸æµæ°´çº¿çš„è§¦å‘å™¨ï¼Œå½“Gitlabå¯åŠ¨è¿™ä¸ªtriggerçš„ä»»åŠ¡æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä¸‹æ¸¸æµæ°´çº¿ï¼›\nå¯¹æ¯”äºæ­£å¸¸çš„ä»»åŠ¡ï¼Œtriggerç±»å‹çš„ä»»åŠ¡åªæœ‰å°‘é‡å…³é”®å­—å¯ä»¥ä½¿ç”¨ï¼›\nGitlabä¸­å¯ä½¿ç”¨triggeråˆ›å»ºä¸¤ç§ç±»å‹çš„ä¸‹æ¸¸æµæ°´çº¿ï¼š\nå¤šé¡¹ç›®æµæ°´çº¿ï¼š è§¦å‘å…¶ä»–é¡¹ç›®çš„æµæ°´çº¿ï¼› å­æµæ°´çº¿ï¼š è§¦å‘å½“å‰é¡¹ç›®çš„æµæ°´çº¿ï¼› å¤šé¡¹ç›®æµæ°´çº¿çš„è§¦å‘ä»»åŠ¡åŸºæœ¬å†™æ³•ï¼š\nrspec: stage: test script: bundle exec rspec staging: stage: deploy trigger: my/deployment å¤šé¡¹ç›®æµæ°´çº¿çš„è§¦å‘ä»»åŠ¡å¤æ‚å†™æ³•ï¼š\né€šè¿‡branchæŒ‡å®šåˆ†æ”¯\nrspec: stage: test script: bundle exec rspec staging: stage: deploy trigger: project: my/deployment branch: stable é•œåƒä¸‹æµæµæ°´çº¿çš„çŠ¶æ€(é€šè¿‡è®¾ç½®strategy: depend,é»˜è®¤æƒ…å†µä¸‹ï¼Œè§¦å‘å™¨ä»»åŠ¡ä¼šè¢«æ ‡è®°ä¸ºæˆåŠŸï¼Œè®¾ç½®æ­¤æ ‡è®°åï¼Œåˆ™ä¼šç­‰å¾…ä¸‹æ¸¸æµæ°´çº¿æ‰§è¡Œå®Œæˆï¼Œç„¶åä½¿ç”¨ä¸‹æµæµæ°´çº¿çš„çŠ¶æ€æ¥æ ‡è®°è¯¥è§¦å‘å™¨ä»»åŠ¡çš„çŠ¶æ€)\ntrigger_job: trigger: project: my/project strategy: depend åœ¨ä¸‹æ¸¸æµæ°´çº¿ä¸­ï¼Œä¹Ÿå¯ä»¥è·å–ä¸Šæ¸¸æµæ°´çº¿çš„çŠ¶æ€\nupstream_bridge: stage: test needs: pipeline: other/project å­æµæ°´çº¿çš„å†™æ³•ï¼š\næŒ‡å®šé¡¹ç›®ä¸­çš„YAMLæ–‡ä»¶çš„è·¯å¾„å³å¯åˆ›å»ºå­æµæ°´çº¿\ntrigger_job: trigger: include: path/to/child-pipeline.yml åŒæ ·çš„ï¼Œä¹Ÿå¯ä»¥è®¾ç½®è·å–ä¸‹æ¸¸çŠ¶æ€\ntrigger_job: trigger: include: - local: path/to/child-pipeline.yml strategy: depend å¯ä»¥ä½¿ç”¨å…¶ä»–é¡¹ç›®ä¸­çš„YAMLæ–‡ä»¶æ¥å®šä¹‰å­æµæ°´çº¿\nchild-pipeline: trigger: include: - project: \u0026#39;my-group/my-pipeline-library\u0026#39; ref: \u0026#39;main\u0026#39; file: \u0026#39;/path/to/child-pipeline.yml\u0026#39; å¯ä»¥ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®æ¥ç”Ÿæˆå­æµæ°´çº¿(å‚è€ƒï¼šParent-child pipelines | GitLab)\ngenerate-config: stage: build script: generate-ci-config \u0026gt; generated-config.yml artifacts: paths: - generated-config.yml child-pipeline: stage: test trigger: include: - artifact: generated-config.yml job: generate-config æ•´ä½“æ–¹æ¡ˆ é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°\ngitlabæ”¯æŒé€šè¿‡includeæ¥å¼•å…¥å¤–éƒ¨çš„è„šæœ¬ï¼Œè„šæœ¬å¯ä»¥æ¥è‡ªäºæœ¬é¡¹ç›®ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªäºå…¶ä»–é¡¹ç›®ï¼› é€šè¿‡triggerå¯ä»¥è§¦å‘å…¶ä»–é¡¹ç›®çš„æµæ°´çº¿æˆ–è€…åœ¨æœ¬é¡¹ç›®ä¸­ç”Ÿæˆä¸€ä¸ªå­æµæ°´çº¿ï¼Œå¯ä»¥é€‰æ‹©è·Ÿè¸ªå­æµæ°´çº¿çš„æ‰§è¡ŒçŠ¶æ€ï¼› ç»è¿‡å¦‚ä¸Šåˆ†æï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨å¦‚ä¸‹æ–¹æ¡ˆå¯¹ç°æœ‰éƒ¨ç½²éœ€æ±‚è¿›è¡Œå®æ–½ï¼š\ncolorlesséƒ¨ç½²ä»“åº“ éƒ¨ç½²æœåŠ¡ TokenManager æ„å»ºJAR æ‰“åŒ…Dockeré•œåƒ RestAPI æ„å»ºJAR æ‰“åŒ…Dockeré•œåƒ GraphQLAPIå¼•æ“ æ„å»º æ‰“åŒ…Dockeré•œåƒ å…¶ä»–æœåŠ¡â€¦ æ„å»º æ‰“åŒ…Dockeré•œåƒ è§¦å‘ è§¦å‘ è§¦å‘ è§¦å‘ postgres redis graphql-engine graphql-token graphql-restapi â€¦ deploy éƒ¨ç½²æœºå™¨ æ¯ä¸ªé¡¹ç›®åˆ†åˆ«å®šä¹‰è‡ªå·±çš„æ„å»ºå’Œé•œåƒæ‰“åŒ…ä»»åŠ¡ï¼› é•œåƒæ‰“åŒ…å®Œæˆåé€šè¿‡triggeræ¥è§¦å‘colorlesséƒ¨ç½²ä»“åº“çš„éƒ¨ç½²ä»»åŠ¡ï¼Œéœ€è¦ä¼ é€’è‡ªå·±çš„ä¿¡æ¯ç»™éƒ¨ç½²ä»“åº“ç”Ÿæˆçš„æµæ°´çº¿ï¼› è§¦å‘ä»»åŠ¡çš„å®šä¹‰æ–‡ä»¶æ”¾ç½®åˆ°colorlesséƒ¨ç½²ä»“åº“ä¸­ï¼Œåœ¨å„ä¸ªæœåŠ¡é¡¹ç›®ä¸­é€šè¿‡includeæ¥å¼•å…¥ï¼› ä¼˜åŒ–æ–¹æ¡ˆå®ç° å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å°†éƒ¨ç½²æ“ä½œé›†ä¸­åˆ°ä¸€ä¸ªå•ç‹¬é¡¹ç›®ä¸­ï¼Œè€Œåˆå„ä¸ªæœåŠ¡é¡¹ç›®è§¦å‘å…¶éƒ¨ç½²æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°†è¿™ä¸ªå•ç‹¬çš„ç”¨äºéƒ¨ç½²çš„é¡¹ç›®ç§°ä¸ºç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ï¼Œå°†å…¶ä»–æœåŠ¡çš„é¡¹ç›®ç§°ä¹‹ä¸ºå­æœåŠ¡é¡¹ç›®ï¼›ä»¥ä¸‹åˆ†åˆ«è¯´æ˜ä¸Šè¿°æ–¹æ¡ˆä¸­ä¸¤ç§é¡¹ç›®ä¸­çš„é…ç½®æ–¹å¼ï¼›\nå„å­æœåŠ¡é¡¹ç›®çš„é…ç½® gitlab-ci.ymlé…ç½® æˆ‘ä»¬å°†éƒ¨ç½²ä»»åŠ¡æ›¿æ¢ä¸ºä¸€ä¸ªè§¦å‘ä»»åŠ¡ï¼Œå¹¶ä»ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ä¸­å¼•å…¥ä»»åŠ¡çš„é…ç½®\nstages: - test - build - build_image - auto-build-deploy # çœç•¥å…¶ä»–å®šä¹‰ # å¼•å…¥è§¦å‘è‡ªåŠ¨ç¼–è¯‘éƒ¨ç½²ä»»åŠ¡é…ç½® include: - project: \u0026#39;Deptproduct-project/colorless/colorless-deploy\u0026#39; # ref: master file: \u0026#39;/ci/gitlab-ci-base.yml\u0026#39; è¿™æ®µé…ç½®ä¼šä» Deptproduct-project/colorless/colorless-deploy é¡¹ç›®ä¸­å¯¼å…¥ /ci/gitlab-ci-base.yml çš„é…ç½®ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š\n# å­æ¨¡å—ç”¨çš„å…¬ç”¨è§¦å‘é¡¹ç›®ï¼Œå¯ä»¥åœ¨å­æ¨¡å—æºç ä¸­ include trigger:auto-build-deploy: stage: auto-build-deploy variables: TRIGGER_CI_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA # é…ç½®ä»“åº“ç¯å¢ƒ # è‡ªå®šä¹‰å˜é‡å¿…é¡»é…ç½®åœ¨ä¸Šæ¸¸UIç•Œé¢ DOCKER_REGISTRY: $DOCKER_REGISTRY DOCKER_NAMESPACE: $DOCKER_NAMESPACE HARBOR_PWD: $HARBOR_PWD HARBOR_USER: $HARBOR_USER SERVICE_NAME: $SERVICE_NAME trigger: project: Deptproduct-project/colorless/colorless-deploy åœ¨å­é¡¹ç›®ä¸­çš„cié…ç½®ä¸­includeè¯¥æ–‡ä»¶æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªè§¦å‘ä»»åŠ¡ï¼Œè¿™ä¸ªè§¦å‘ä»»åŠ¡ä¼šè§¦å‘Deptproduct-project/colorless/colorless-deployè¿™ä¸ªé¡¹ç›®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ï¼›\nä¹Ÿå°±æ˜¯è¯´ä¼šè§¦å‘æˆ‘ä»¬ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ç”Ÿæˆä¸€ä¸ªæµæ°´çº¿ï¼Œæ­¤æ—¶æµæ°´çº¿è¯»å–çš„å°±æ˜¯æˆ‘ä»¬ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®çš„.gitlab-ci.yml æ–‡ä»¶ï¼›\nweb UIä¸­CI/CDå˜é‡é…ç½® ä¸Šè¿°çš„è§¦å‘ä»»åŠ¡çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‡ ä¸ªå˜é‡ï¼Œç”¨äºå‘éƒ¨ç½²é¡¹ç›®çš„æµæ°´çº¿è¯´æ˜æˆ‘ä»¬è‡ªèº«çš„ä¸€äº›ä¿¡æ¯\nTRIGGER_CI_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA DOCKER_REGISTRY: $DOCKER_REGISTRY DOCKER_NAMESPACE: $DOCKER_NAMESPACE HARBOR_PWD: $HARBOR_PWD HARBOR_USER: $HARBOR_USER SERVICE_NAME: $SERVICE_NAME å…¶ä¸­ï¼Œç”±æˆ‘ä»¬è‡ªè¡Œå®šä¹‰çš„å˜é‡ï¼ˆ$DOCKER_REGISTRY,DOCKER_NAMESPACE,$HARBOR_PWD,$HARBOR_USER,$SERVICE_NAMEï¼‰éœ€è¦åœ¨é¡¹ç›®/ç¾¤ç»„çš„CIçš„å˜é‡ä¸­è¿›è¡Œé…ç½®ï¼Œåœ¨è§£ææ­¤è§¦å‘ä»»åŠ¡æ—¶æ‰å¯ä»¥è¯»å–åˆ°ï¼›\nç‹¬ç«‹éƒ¨ç½²é¡¹ç›®çš„é…ç½® gitlab-ci.yml é…ç½® variables: # UIç•Œé¢é…ç½® DEPLOY_PATH DEPLOY_PATH: /Wksp/colorlessWork/colorless-deploy/deploy/ # éƒ¨ç½²çš„stack DOCKER_STACK: colorless deploy: stage: deploy script: - echo $HARBOR_PWD | docker login --username=$HARBOR_USER $DOCKER_REGISTRY --password-stdin - cd $DEPLOY_PATH - source deploy.sh - update_service $DOCKER_STACK $SERVICE_NAME $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$SERVICE_NAME:$TRIGGER_CI_COMMIT_SHORT_SHA environment: name: test_env_deploy url: $APP_URL/ when: manual tags: - deploy_graphql web UIä¸­CI/CDå˜é‡é…ç½® ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰äº›éƒ¨ç½²ç›¸å…³çš„å˜é‡éœ€è¦ä»å­æœåŠ¡é¡¹ç›®ä¸­æå–åˆ°å½“å‰ç‹¬ç«‹éƒ¨ç½²é¡¹ç›®ä¸­æ¥å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼šDEPLOY_PATH,DOCKER_STACK,APP_URLï¼Œå…¶ä¸­DEPLOY_PATH,DOCKER_STACKæˆ‘ä»¬åœ¨ymlä¸­æœ‰å®šä¹‰é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸åœ¨UIç•Œé¢ä¸­è¿›è¡Œå®šä¹‰ï¼Œåªéœ€è¦åœ¨UIç•Œé¢ä¸­å®šä¹‰APP_URLå³å¯ï¼›\nè¿è¡Œæ•ˆæœè¯´æ˜ æ¯æ¬¡å­æœåŠ¡é¡¹ç›®ä¸­æäº¤ä»£ç ï¼Œä¸”æ»¡è¶³cié…ç½®ä¸­å®šä¹‰çš„æ¡ä»¶æ—¶ï¼Œå³ä¼šç”Ÿæˆä¸€ä¸ªè§¦å‘ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œå‰æœŸé˜¶æ®µçš„ä»»åŠ¡åï¼Œå½“æ‰§è¡Œè§¦å‘ä»»åŠ¡æ—¶ï¼Œå°±ä¼šè§¦å‘æˆ‘ä»¬çš„ç‹¬ç«‹ä»“åº“çš„éƒ¨ç½²ä»»åŠ¡ã€‚å…·ä½“ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼› ç‚¹å‡»ä¸‹æ¸¸ä»»åŠ¡å³å¯è·³è½¬åˆ°æˆ‘ä»¬çš„ç‹¬ç«‹éƒ¨ç½²ä»“åº“ä¸­å¯¹åº”çš„æµæ°´çº¿ä¸­ï¼› ç‚¹å‡»deployä»»åŠ¡çš„è¿è¡ŒæŒ‰é’®ï¼Œå³å¯è¿›è¡Œéƒ¨ç½²ï¼›\néƒ¨ç½²å®Œæˆåï¼Œå¯åœ¨ç‹¬ç«‹éƒ¨ç½²ä»“åº“ä¸­ç”Ÿæˆä¸€ä¸ªéƒ¨ç½²ç¯å¢ƒï¼Œç‚¹å‡»å³å¯å‰å¾€ï¼›\n","permalink":"https://hanlyjiang.github.io/posts/gitlab-chi-xu-ji-cheng-yu-chi-xu-bu-shu-shi-li/","summary":"\u003cp\u003eæœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•åŸºäºGitlabæ¥é…ç½®ä¸€ä¸ªæœåŠ¡é›†ç¾¤çš„è‡ªåŠ¨æ„å»ºä¸éƒ¨ç½²æ›´æ–°ï¼Œå…¶ä¸­æœåŠ¡çš„æ›´æ–°åŸºäºdockeræ¥å®Œæˆï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨å¦‚ä½•å®Œæˆéƒ¨ç½²æ“ä½œï¼ŒåŠå¦‚ä½•å®Œæˆgitlabä¸Šciçš„é…ç½®ï¼›åœ¨å®Œæˆå•ä¸€çš„æœåŠ¡è‡ªåŠ¨éƒ¨ç½²æ›´æ–°åï¼Œæˆ‘ä»¬é€šè¿‡gitlabçš„includeåŠtriggeræœºåˆ¶æ¥ç®€åŒ–ç»Ÿä¸€éƒ¨ç½²æµç¨‹ï¼›\u003c/p\u003e","title":"GitlabæŒç»­é›†æˆä¸æŒç»­éƒ¨ç½²-å®ä¾‹"},{"content":"æœ¬æ–‡ä»‹ç»å¦‚ä½•å®‰å…¨çš„è¿ç§»Dockerçš„æ•°æ®ç›®å½•/var/lib/docker\nä¸ºä»€ä¹ˆè¦è¿ç§» è™šæ‹Ÿæœºåˆ›å»ºæ—¶ï¼Œä¸€èˆ¬åˆ†é…ä¸€ä¸ªæ¯”è¾ƒå°çš„ç³»ç»Ÿç›˜ï¼Œç„¶åæŒ‚è½½ä¸€ä¸ªå¤§å®¹é‡çš„æ•°æ®ç›˜ï¼Œdockeré»˜è®¤æƒ…å†µä¸‹æ•°æ®å­˜å‚¨åœ¨ç³»ç»Ÿç›˜(/var/lib/docker)ç›®å½•ï¼Œæ—¶é—´ä¸€ä¹…ï¼Œä¼šå æ»¡ç³»ç»Ÿç›˜ã€‚ è¿ç§»æ­¥éª¤ é¦–å…ˆéœ€è¦åœæ­¢dockeræœåŠ¡ systemctl stop docker é€šè¿‡å‘½ä»¤df -h å…ˆå»çœ‹ä¸‹ç£ç›˜å¤§æ¦‚çš„æƒ…å†µï¼Œæ‰¾ä¸€ä¸ªå¤§çš„ç©ºé—´ åˆ›å»ºdockerçš„æ–°ç›®å½•ï¼Œæˆ‘è¿™è¾¹æ‰¾äº†data, æ‰€ä»¥æˆ‘è¿™è¾¹çš„æ–°ç›®å½•åœ°å€æ˜¯ /data/docker/lib/ mkdir -p /data/docker/lib æ³¨ï¼šå‚æ•°-p ç¡®ä¿ç›®å½•åç§°å­˜åœ¨ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨çš„å°±æ–°åˆ›å»ºä¸€ä¸ªã€‚\nå¼€å§‹è¿ç§» rsync -avzP /var/lib/docker /data/docker/lib/ å…ˆç¡®è®¤æ˜¯å¦å®‰è£…äº†rsync.\nå‚æ•°è§£é‡Šï¼š\n-aï¼Œå½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºé€’å½’ä¼ è¾“å¹¶ä¿æŒæ–‡ä»¶å±æ€§ã€‚ -vï¼Œæ˜¾ç¤ºrsyncè¿‡ç¨‹ä¸­è¯¦ç»†ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨\u0026quot;-vvvv\u0026quot;è·å–æ›´è¯¦ç»†ä¿¡æ¯ã€‚ -Pï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¼ è¾“çš„è¿›åº¦ä¿¡æ¯ã€‚(å®é™…ä¸Š\u0026quot;-P\u0026quot;=\u0026quot;\u0026ndash;partial \u0026ndash;progress\u0026quot;ï¼Œå…¶ä¸­çš„\u0026quot;\u0026ndash;progress\u0026quot;æ‰æ˜¯æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯çš„)ã€‚ -z,Â ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©æé«˜æ•ˆç‡ã€‚ æŒ‡å®šæ–°çš„dockerç›®å½• vim /lib/systemd/system/docker.service åœ¨ExecStartåŠ å…¥:\n--graph=/data/docker/lib/docker é‡å¯docker sudo systemctl daemon-reload sudoÂ systemctl restart docker sudoÂ systemctl enable docker # è¿è¡Œdockerè‡ªåŠ¨å¯åŠ¨ï¼Œè¿™é‡Œå¯ä»¥ä¸æ‰§è¡Œ å¯åŠ¨ä¹‹åç¡®è®¤docker æ²¡æœ‰é—®é¢˜ï¼Œç¡®è®¤ä¹‹å‰çš„å®¹å™¨å’Œé•œåƒéƒ½è¿˜åœ¨ï¼Œç„¶ååˆ é™¤æ—§çš„/var/lib/docker/ç›®å½• å‚è€ƒæ–‡ç« ï¼š https://www.cnblogs.com/insist-forever/p/11739207.html ","permalink":"https://hanlyjiang.github.io/posts/docker%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95%E8%BF%81%E7%A7%BB/","summary":"\u003cp\u003eæœ¬æ–‡ä»‹ç»å¦‚ä½•å®‰å…¨çš„è¿ç§»Dockerçš„æ•°æ®ç›®å½•/var/lib/docker\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"ä¸ºä»€ä¹ˆè¦è¿ç§»\"\u003eä¸ºä»€ä¹ˆè¦è¿ç§»\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eè™šæ‹Ÿæœºåˆ›å»ºæ—¶ï¼Œä¸€èˆ¬åˆ†é…ä¸€ä¸ªæ¯”è¾ƒå°çš„ç³»ç»Ÿç›˜ï¼Œç„¶åæŒ‚è½½ä¸€ä¸ªå¤§å®¹é‡çš„æ•°æ®ç›˜ï¼Œdockeré»˜è®¤æƒ…å†µä¸‹æ•°æ®å­˜å‚¨åœ¨ç³»ç»Ÿç›˜(/var/lib/docker)ç›®å½•ï¼Œæ—¶é—´ä¸€ä¹…ï¼Œä¼šå æ»¡ç³»ç»Ÿç›˜ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"è¿ç§»æ­¥éª¤\"\u003eè¿ç§»æ­¥éª¤\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé¦–å…ˆéœ€è¦åœæ­¢dockeræœåŠ¡\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003esystemctl stop docker\n\u003c/code\u003e\u003c/pre\u003e\u003col start=\"2\"\u003e\n\u003cli\u003e\u003cstrong\u003eé€šè¿‡å‘½ä»¤df -h å…ˆå»çœ‹ä¸‹ç£ç›˜å¤§æ¦‚çš„æƒ…å†µï¼Œæ‰¾ä¸€ä¸ªå¤§çš„ç©ºé—´\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåˆ›å»ºdockerçš„æ–°ç›®å½•ï¼Œæˆ‘è¿™è¾¹æ‰¾äº†data, æ‰€ä»¥æˆ‘è¿™è¾¹çš„æ–°ç›®å½•åœ°å€æ˜¯ /data/docker/lib/\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\n\nmkdir -p /data/docker/lib\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\n\u003cp\u003eæ³¨ï¼šå‚æ•°-p ç¡®ä¿ç›®å½•åç§°å­˜åœ¨ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨çš„å°±æ–°åˆ›å»ºä¸€ä¸ªã€‚\u003c/p\u003e","title":"Dockeræ•°æ®ç›®å½•(/var/lib/docker)è¿ç§»"},{"content":"ä»‹ç»IDEAåŠAndroidStudioä¸­çš„å¯¼èˆªæŠ€å·§ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¯¼èˆªï¼Œä»£ç å…ƒç´ ï¼ˆç±»ï¼Œæ–¹æ³•ï¼‰å¯¼èˆªï¼Œæ–‡æœ¬å¯¼èˆªç­‰ï¼Œè¿˜æœ‰ä¹¦ç­¾ç­‰çš„ä½¿ç”¨æ–¹æ³•ï¼›æé«˜ç¼–å†™ä»£ç åŠé˜…è¯»ä»£ç çš„æ•ˆç‡ï¼›\næ’å…¥ç¬¦å¯¼èˆª åé€€ï¼š==âŒ˜[== å‰è¿›ï¼š==âŒ˜]== æœ€åç¼–è¾‘ç‚¹ï¼š ==â‡§âŒ˜âŒ«== å®šä½åˆ°å½“å‰çš„ç»“æŸæ‹¬å·ï¼š ==Ctrl+M== æˆ–è€… ==â†‘== , ==â†“== æŸ¥çœ‹å…‰æ ‡æ‰€åœ¨ä½ç½®æ‰€å±çš„å…ƒç´ ï¼š==âŒƒâ‡§Q== ï¼ˆæ³¨æ„çœ‹ä¸‹å›¾çš„å·¦ä¸Šè§’æ˜¾ç¤ºäº†å½“å‰çš„ç±»ï¼‰ ç§»åŠ¨åˆ°å½“å‰å¼€å§‹æ‹¬å·å¯¹åº”çš„é—­åˆæ‹¬å·ï¼š ==Ctrl + M== åœ¨ä»£ç å—ä¹‹é—´å¯¼èˆªï¼š ==âŒ¥â‡§âŒ˜[== ==âŒ¥â‡§âŒ˜]== ç§»åŠ¨æ’å…¥ç¬¦ ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæˆ–è€…ä¸Šä¸€ä¸ªå•è¯ï¼š ==âŒ¥â†’==ï¼Œ==âŒ¥â†==\nç§»åŠ¨åˆ°ä¸‹ä¸ªæ®µè½ï¼šï¼ˆä¸‹ä¸ªæ–¹æ³•ï¼‰\nä½¿ç”¨ ==Shift+Command+A== è°ƒå‡ºActionæœç´¢å¼¹æ¡†ï¼› æœç´¢ Move Caret Forward a Paragraph æˆ– Move Caret Backward a Paragraph æŸ¥æ‰¾æœ€è¿‘çš„ä½ç½® ä½¿ç”¨ ==â‡§âŒ˜E== å¯ä»¥æ‰“å¼€æœ€è¿‘ä½ç½®çš„å¼¹çª—ï¼Œä½¿ç”¨ä¸Šä¸‹å¥è¿›è¡Œå¯¼èˆª\nåœ¨æ‰“å¼€æ­¤å¼¹çª—æ—¶ï¼Œå†æ¬¡ä½¿ç”¨ ==â‡§âŒ˜E== å¯ä»¥é€‰ä¸­ Show Changed Only\nå¯ç›´æ¥è¾“å…¥ä»¥æœç´¢ä»£ç ç‰‡æ®µ\nåˆ é™¤è®°å½•ï¼š æŒ‰ ==Delete== æˆ–è€… ==âŒ«==\nä½¿ç”¨ä¹¦ç­¾å¯¼èˆª åˆ›å»ºåŒ¿åä¹¦ç­¾ï¼šå°†å…‰æ ‡æ”¾ç½®åˆ°éœ€è¦çš„ä»£ç è¡Œä¸Šï¼Œç„¶åæŒ‰ ï¼š ==F3==\nåˆ›å»ºå¸¦åŠ©è®°ç¬¦çš„ä¹¦ç­¾ï¼š å°†å…‰æ ‡æ”¾ç½®åˆ°éœ€è¦çš„ä»£ç è¡Œä¸Šï¼Œç„¶åæŒ‰ ï¼š ==âŒ¥F3==ï¼Œä¹‹åå¯é€šè¿‡è¾“å…¥å­—æ¯æˆ–è€…æ•°å­—æ¥è®¾ç½®å¯¹åº”çš„åŠ©è®°ç¬¦å·ï¼›\næ˜¾ç¤ºä¸Šä¸ªæˆ–ä¸‹ä¸ªä¹¦ç­¾ï¼š åœ¨ä¸»èœå•ä¸­é€‰æ‹© Navigate | Bookmarks | Next Bookmark æˆ– Navigate | Bookmarks | Previous Bookmark\næ‰“å¼€ä¹¦ç­¾å¯¹è¯æ¡†ï¼š ==âŒ˜F3==\næ­¤å¯¹è¯æ¡†ä¹Ÿå¯ç”¨äºç®¡ç†ä¹¦ç­¾ï¼Œå¦‚åˆ é™¤ï¼Œæ’åºï¼Œé™„åŠ ç®€è¦æè¿° åœ¨å·²æœ‰çš„å­—æ¯åŠ©è®°ç¬¦ä¹¦ç­¾ä¹‹é—´å¯¼èˆªï¼ˆé€šè¿‡å­—æ¯ï¼‰ï¼š æŒ‰ ==âŒ˜F3==ï¼Œ ç„¶åè¾“å…¥ä¸€ä¸ªå­—æ¯ï¼›\nåœ¨å·²æœ‰çš„æ•°å­—åŠ©è®°ç¬¦ä¹¦ç­¾ä¹‹é—´å¯¼èˆªï¼ˆé€šè¿‡å­—æ¯ï¼‰ï¼š æŒ‰ ==^==ï¼Œ ç„¶åè¾“å…¥ä¸€ä¸ªæ•°å­—ï¼›\nåˆ›å»ºçš„æ¯ä¸ªä¹¦ç­¾éƒ½ä¼šåœ¨Favorites==âŒ˜2==ï¼ˆView | Tool Windows | Favouritesï¼‰çª—å£ä¸­åæ˜ å‡ºæ¥ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤çª—å£æ¥å¯¼èˆªã€‚\nåœ¨å˜æ›´ä¹‹é—´å¯¼èˆª å¦‚æœç¼–è¾‘å—ç‰ˆæœ¬æ§åˆ¶çš„æ–‡ä»¶ï¼Œåˆ™IntelliJ IDEAæä¾›äº†å‡ ç§æ¥å›ç§»åŠ¨æ›´æ–°çš„æ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨å¯¼èˆªå‘½ä»¤ï¼Œé”®ç›˜å¿«æ·é”®å’Œæ›´æ”¹æ ‡è®°ã€‚\nä½¿ç”¨ ==âŒƒâŒ¥â‡§â†“==/ ==âŒƒâŒ¥â‡§â†‘==\nåœ¨ä¸»èœå•ä¸­é€‰æ‹©ï¼š Navigate | Next / Previous Change\nç‚¹å‡»ä¸€ä¸ª==å˜æ›´æ ‡è®°ï¼ˆchange markerï¼‰==ï¼Œç„¶åç‚¹å‡» æˆ– å¯¼èˆªåˆ°æœ€åä¸€ä¸ªç¼–è¾‘çš„åœ°æ–¹ï¼š ==â‡§âŒ˜âŒ«== æˆ–ä»ä¸»èœå•é€‰æ‹© Navigate | Last Edit Location\næŸ¥çœ‹æœ€è¿‘ä¿®æ”¹ ä½¿ç”¨ Recent Changes å¼¹çª—æ¥æŸ¥çœ‹æœ€è¿‘å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¹Ÿå¯æ’¤é”€ç›¸å…³ä¿®æ”¹ã€‚\nåœ¨ä¸»èœå•ä¸­é€‰æ‹© View | Recent Changes ==âŒ¥â‡§C== åœ¨å¼¹å‡ºæ¡†ä¸­é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åæŒ‰ä¸‹ ==â== æ‰“å¼€ä¸€ä¸ªå•ç‹¬çš„å¯¹è¯æ¡†ç”¨äºæ£€æŸ¥å˜æ›´ï¼› å¯¼èˆªåˆ°å£°æ˜å’Œç±»å‹ å°†å…‰æ ‡æ”¾ç½®åœ¨è¦æŸ¥è¯¢çš„ç¬¦å·ä¸Šï¼ŒæŒ‰ï¼š ==âŒ˜B== (æŸ¥è¯¢ç”¨æ³•) æŸ¥è¯¢ç±»å‹å®šä¹‰ï¼š ==â‡§âŒ˜B== å¯¼èˆªåˆ°å®ç°ï¼ˆå®ç”¨ï¼‰ å¯ä»¥ä½¿ç”¨ç¼–è¾‘å™¨ä¸­çš„è£…è®¢çº¿å›¾æ ‡æˆ–æŒ‰ç›¸åº”çš„å¿«æ·æ–¹å¼æ¥è·Ÿè¸ªç±»çš„å®ç°å’Œé‡å†™æ–¹æ³•ã€‚\nç‚¹å‡» / , / ç¼–è¾‘å™¨è£…è®¢çº¿ä¸­çš„å›¾æ ‡å¯ä»¥é€‰æ‹©çˆ¶ç±»æˆ–å­ç±»ã€‚\nå¯¼èˆªåˆ°çˆ¶æ–¹æ³•ï¼š ==âŒ˜U==\nå¯¼èˆªåˆ°å®ç°ï¼š==âŒ¥âŒ˜B==\næ˜¾ç¤ºå…„å¼Ÿå§å¦¹ï¼ˆsiblings ==sÉªblÉªÅ‹z==ï¼‰ å¯åœ¨å•ç‹¬çš„å¼¹å‡ºæ¡†ä¸­æŸ¥çœ‹å®ç°æ–¹æ³•çš„é‚»å±…ç±»\nåœ¨ç¼–è¾‘å™¨ä¸­ï¼Œå°†å…‰æ ‡æ”¾ç½®åœ¨æ–¹æ³•åç§°ä¸Šï¼› åœ¨ä¸»èœå•ä¸­ï¼Œé€‰æ‹© View | Show Siblings IDEAä¼šæ‰“å¼€ä¸€ä¸ªå¼¹æ¡†ï¼Œå¯ä»¥åœ¨å…¶ä¸­æµè§ˆå®ç°ï¼Œå¯¼èˆªåˆ°æºç ï¼Œç¼–è¾‘æºç ï¼Œæˆ–è€…åœ¨Findå·¥å…·çª—å£åœ¨æ‰“å¼€åˆ—è¡¨ï¼› ä¹Ÿå¯ä»¥åœ¨ActionæŸ¥è¯¢çª—å£ä¸­æœç´¢è¿›å…¥ğŸ˜¯\nä½¿ç”¨Select In å¼¹æ¡† åœ¨Projectå·¥å…·çª—å£åœ¨è‡ªåŠ¨å®šä½ä¸€ä¸ªç±»ã€‚\nå¦‚æœåœ¨ç¼–è¾‘å™¨ä¸­è¢«æ‰“å¼€äº†ï¼ŒæŒ‰ ==âŒ¥F1== ä»¥æ‰“å¼€ Select In å¼¹çª—ï¼›\nåœ¨å¼¹å‡ºæ¡†ä¸­ï¼Œé€‰æ‹© Project Viewï¼Œç„¶åæŒ‰ ==â== å³å¯åœ¨Project å·¥å…·çª—å£ä¸­å®šä½ç±»ã€‚\nè¿˜æœ‰å…¶ä»–åŠŸèƒ½ï¼šå¯ä»¥åœ¨å¼¹å‡ºçª—å£ä¹‹åï¼ŒæŒ‰å¯¹åº”çš„æ•°å­—é”®è¿›è¡Œå¯¼èˆª æŸ¥çœ‹æ”¶è— æŸ¥çœ‹æ–‡ä»¶ç»“æ„ å¯¼èˆªæ¡ åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­æŸ¥çœ‹æ–‡ä»¶ é¡¹ç›®ç»“æ„ åœ¨Projectå·¥å…·çª—å£ä¸­å®šä½æ–‡ä»¶ å¯ä»¥ä½¿ç”¨â€œOpen Files with Single Clickâ€ï¼ˆä»¥å‰ç§°ä¸ºâ€œè‡ªåŠ¨æ»šåŠ¨åˆ°æºä»£ç â€ï¼‰å’Œâ€œå§‹ç»ˆé€‰æ‹©æ‰“å¼€çš„æ–‡ä»¶â€ï¼ˆä»¥å‰ç§°ä¸ºâ€œAlways Select Opened Files â€ï¼‰æ“ä½œæ¥åœ¨â€œProjectâ€å·¥å…·çª—å£ä¸­æ‰¾åˆ°æ–‡ä»¶ã€‚\nåœ¨â€œProjectâ€å·¥å…·çª—å£ä¸­ï¼Œå³é”®å•å‡»â€œProjectâ€å·¥å…·æ ï¼Œç„¶åä»ä¸Šä¸‹æ–‡èœå•ä¸­é€‰æ‹©â€œAlways Select Opened Filesâ€ã€‚ ä¹‹åIDEAå°†è·Ÿè¸ªå½“å‰åœ¨æ´»åŠ¨ç¼–è¾‘å™¨é€‰é¡¹å¡ä¸­æ‰“å¼€çš„æ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨åœ¨â€œProjectâ€å·¥å…·çª—å£ä¸­æ‰¾åˆ°å®ƒã€‚\næ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©â€œOpen Files with Single Clickâ€é€‰é¡¹ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“æ‚¨åœ¨â€œé¡¹ç›®â€è§†å›¾ä¸­å•å‡»æ–‡ä»¶æ—¶ï¼ŒIntelliJ IDEAå°†è‡ªåŠ¨åœ¨ç¼–è¾‘å™¨ä¸­å°†å…¶æ‰“å¼€ã€‚\nåœ¨é”™è¯¯å’Œè­¦å‘Šä¹‹é—´å¯¼èˆª è·³è½¬åˆ°ä¸‹ä¸€ä¸ªé—®é¢˜ï¼š==F2== ï¼ˆNavigate | Next Highlighted Errorï¼‰\nè·³è½¬åˆ°ä¸Šä¸€ä¸ªé—®é¢˜ï¼š==â‡§F2== ï¼ˆNavigate | Previous Highlighted Errorï¼‰\né…ç½®IntelliJ IDEAåœ¨ä»£ç é—®é¢˜ä¹‹é—´å¯¼èˆªçš„æ–¹å¼ï¼šå®ƒå¯ä»¥åœ¨æ‰€æœ‰ä»£ç é—®é¢˜ä¹‹é—´è·³è½¬ï¼Œä¹Ÿå¯ä»¥è·³è¿‡æ¬¡è¦é—®é¢˜ï¼Œå¹¶ä¸”ä»…åœ¨æ£€æµ‹åˆ°çš„é”™è¯¯ä¹‹é—´å¯¼èˆªã€‚ å³é”®å•å‡»æ»šåŠ¨æ¡åŒºåŸŸä¸­çš„ä»£ç åˆ†ææ ‡è®°ï¼Œç„¶åä»ä¸Šä¸‹æ–‡èœå•ä¸­é€‰æ‹©ä¸€ç§å¯ç”¨çš„å¯¼èˆªæ¨¡å¼ï¼š\nè¦ä½¿IntelliJ IDEAè·³è¿‡è­¦å‘Šï¼Œä¿¡æ¯å’Œå…¶ä»–æ¬¡è¦é—®é¢˜ï¼Œè¯·é€‰æ‹© Go to high priority problems onlyï¼ˆä»…è½¬åˆ°é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼‰ã€‚ è¦ä½¿IntelliJ IDEAåœ¨æ‰€æœ‰æ£€æµ‹åˆ°çš„ä»£ç é—®é¢˜ä¹‹é—´è·³è½¬ï¼Œè¯·é€‰æ‹©Go to next problemï¼ˆè½¬åˆ°ä¸‹ä¸€ä¸ªé—®é¢˜ï¼‰ã€‚ ä½¿ç”¨Structure View å¼¹çª—å®šä½ä»£ç å…ƒç´  å¯ä½¿ç”¨Structure View å¼¹çª—æ¥å®šä½å½“å‰æ–‡ä»¶ä¸­çš„å…ƒç´ ï¼›\næ‰“å¼€StructureViewå¼¹çª—ï¼š ==âŒ˜F12== ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡==âŒ¥F1== + ==3==æ¥æ‰“å¼€ï¼‰ åœ¨å¼¹çª—ä¸­å®šä½åˆ°ä½ éœ€è¦çš„æ¡ç›®ï¼Œç„¶åæŒ‰ ==â== æ¥è¿”å›åˆ°ç¼–è¾‘å™¨çš„ç›¸åº”ä½ç½®ï¼› åœ¨å¼¹çª—ä¸­å¯ä»¥æ’åºæ–‡ä»¶ä¸­çš„å…ƒç´ ï¼Œç­›é€‰ä»¥æŸ¥çœ‹åŒ¿åç±»å’Œç»§æ‰¿ç±»æˆå‘˜ï¼› é€šè¿‡æ–¹æ³•æµè§ˆ æŒ‰ï¼š ==âŒƒâ†“== or ==âŒƒâ†‘== ï¼ˆå’Œmacå¿«æ·é”®å†²çªäº†ï¼‰\nè¦åœ¨è§†è§‰ä¸Šåˆ†ç¦»ä»£ç ä¸­çš„æ–¹æ³•ï¼Œè¯·åœ¨â€œè®¾ç½®/é¦–é€‰é¡¹â€å¯¹è¯æ¡†âŒ˜ä¸­ï¼Œè½¬åˆ°â€œç¼–è¾‘å™¨â€ |â€œè®¾ç½®â€ã€‚ ä¸€èˆ¬| å¤–è§‚ï¼Œç„¶åé€‰æ‹©Show method separatorsï¼ˆæ˜¾ç¤ºæ–¹æ³•åˆ†éš”ç¬¦ï¼‰é€‰é¡¹ã€‚\næ‰“å¼€Structure å·¥å…·çª—å£ï¼š==âŒ˜7==\nä½¿ç”¨é•œå¤´æ¨¡å¼ é•œå¤´æ¨¡å¼ä½¿æ‚¨æ— éœ€å®é™…æ»šåŠ¨å³å¯é¢„è§ˆä»£ç ã€‚ å½“æ‚¨å°†é¼ æ ‡æ‚¬åœåœ¨æ»šåŠ¨æ¡ä¸Šæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹è¯¥æ¨¡å¼åœ¨ç¼–è¾‘å™¨ä¸­å¯ç”¨ã€‚ å°†é¼ æ ‡æ‚¬åœåœ¨è­¦å‘Šæˆ–é”™è¯¯æ¶ˆæ¯ä¸Šæ—¶ï¼Œæ­¤åŠŸèƒ½ç‰¹åˆ«æœ‰ç”¨ã€‚\nè¦ç¦ç”¨é•œå¤´æ¨¡å¼ï¼Œè¯·å³é”®å•å‡»ä½äºç¼–è¾‘å™¨å³ä¾§çš„ä»£ç åˆ†ææ ‡è®°ï¼Œç„¶ååœ¨ä¸Šä¸‹æ–‡èœå•ä¸­æ¸…é™¤â€œåœ¨æ»šåŠ¨æ¡æ‚¬åœæ—¶æ˜¾ç¤ºä»£ç é•œå¤´â€å¤é€‰æ¡†ã€‚ æˆ–è€…ï¼Œåœ¨Settings/Preferenceså¯¹è¯æ¡†==âŒ˜==ä¸­ï¼Œè½¬åˆ°Editor | General | Appearance å¹¶æ¸…é™¤ Show code lens on the scrollbar hover å¤é€‰æ¡†ã€‚ ä½¿ç”¨é¢åŒ…å±‘å¯¼èˆª æ‚¨å¯ä»¥ä½¿ç”¨é¢åŒ…å±‘æµè§ˆæºä»£ç ï¼Œè¿™äº›é¢åŒ…å±‘æ˜¾ç¤ºå½“å‰æ‰“å¼€çš„æ–‡ä»¶ä¸­çš„ç±»ï¼Œå˜é‡ï¼Œå‡½æ•°ï¼Œæ–¹æ³•å’Œæ ‡è®°çš„åç§°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ç”¨é¢åŒ…å±‘å¹¶å°†å…¶æ˜¾ç¤ºåœ¨ç¼–è¾‘å™¨çš„åº•éƒ¨ã€‚\nè¦æ›´æ”¹é¢åŒ…å±‘çš„ä½ç½®ï¼Œè¯·å³é”®å•å‡»ä¸€ä¸ªé¢åŒ…å±‘ï¼Œåœ¨ä¸Šä¸‹æ–‡èœå•ä¸­é€‰æ‹©Breadcrumbså’Œä½ç½®é¦–é€‰é¡¹ã€‚ è¦ç¼–è¾‘é¢åŒ…å±‘è®¾ç½®ï¼Œè¯·åœ¨Settings/Preferenceså¯¹è¯æ¡†==âŒ˜==ä¸­ï¼Œè½¬åˆ°Editor | General | Breadcrumbsã€‚ é€šè¿‡å¯¼èˆªæ¡å¯¼èˆªåˆ°æ–‡ä»¶ ä½¿ç”¨å¯¼èˆªæ ä½œä¸ºæ–¹ä¾¿çš„å·¥å…·æ¥æŸ¥æ‰¾æ•´ä¸ªé¡¹ç›®ã€‚\nä½¿ç”¨ ==âŒ˜â†‘==æ¥æ¿€æ´»å¯¼èˆªæ¡ï¼› ä½¿ç”¨æ–¹å‘é”®æˆ–è€…é¼ æ ‡æ¥å®šä½åˆ°æƒ³è¦çš„æ–‡ä»¶ï¼› åŒå‡»é€‰æ‹©çš„æ–‡ä»¶æˆ–è€…æŒ‰å›è½¦é”®æ¥åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€è¯¥æ–‡ä»¶ï¼› ä¹Ÿå¯ä»¥è¾“å…¥ä»¥ç­›é€‰/æœç´¢æ–‡ä»¶ï¼› ç‚¹å‡»å¯¼èˆªæ ä¸­çš„Javaç±»æˆ–è€…æ¥å£å¯ä»¥æŸ¥çœ‹å…¶æ–¹æ³•åˆ—è¡¨ï¼Œç‚¹å‡»å…¶ä¸­ä¸€ä¸ªæ–¹æ³•å¯åœ¨ç¼–è¾‘å™¨ä¸­å¿«é€Ÿè·³è½¬åˆ°å¯¹åº”çš„æ–¹æ³•ï¼› æŸ¥æ‰¾æ–‡ä»¶è·¯å¾„ åœ¨ç¼–è¾‘å™¨ä¸­ï¼ŒæŒ‰==âŒ¥âŒ˜F12== æˆ–è€…åœ¨ä¸Šä¸‹æ–‡èœå•ä¸­é€‰æ‹© Open in | Finder\nåœ¨ Reveal in Finder å¼¹çª—ä¸­ï¼Œé€‰æ‹©è¦æ‰“å¼€çš„æ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œç„¶åæŒ‰ ==â==ï¼›\nä¹Ÿå¯ä»¥é€šè¿‡ ==âŒ˜F1== ï¼Œç„¶åæŒ‰==7==æ¥åœ¨Finderä¸­æ‰“å¼€æ­£åœ¨ç¼–è¾‘çš„æ–‡ä»¶\næŸ¥æ‰¾æœ€è¿‘çš„æ–‡ä»¶ åœ¨Recent Fileså¼¹çª—ä¸­æŸ¥æ‰¾æœ€è¿‘æˆ–è€…æœ€è¿‘ç¼–è¾‘çš„æ–‡ä»¶ï¼›\næ‰“å¼€ Recent Fileså¼¹çª—ï¼š ==âŒ˜E==\nå†æ¬¡æŒ‰ ==âŒ˜E==æ¥æ¿€æ´» Show changed onlyå•é€‰æ¡†ï¼›\nå¯ä»¥è¾“å…¥æ–‡å­—ä»¥æœç´¢ï¼›\nå·¦è¾¹å¯ä»¥å¯¼èˆªåˆ°å„ä¸ªå·¥å…·çª—å£ğŸ˜¯\næ–‡æœ¬åŒ¹é…å¯¼èˆªï¼ˆè‡ªè¡Œè¡¥å……ï¼‰ï¼ˆå®ç”¨ï¼‰ å…‰æ ‡åœç•™åœ¨ä¸€ä¸ªæ–‡æœ¬ä¸Šæ—¶ï¼Œå¯ä»¥å¿«é€Ÿåœ¨æ‰€æœ‰å‡ºç°è¯¥æ–‡æœ¬çš„ä»£ç è¡Œä¹‹é—´å¯¼èˆªï¼š\nå‘ä¸ŠæŸ¥æ‰¾ ==âŒƒâŒ¥â†‘== å‘ä¸‹æŸ¥æ‰¾ ==âŒƒâŒ¥â†“== å‚è€ƒï¼š jetbrains-Source code navigation\n","permalink":"https://hanlyjiang.github.io/posts/idea-shi-yong-ji-qiao-zhi-dao-hang/","summary":"\u003cp\u003eä»‹ç»IDEAåŠAndroidStudioä¸­çš„å¯¼èˆªæŠ€å·§ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¯¼èˆªï¼Œä»£ç å…ƒç´ ï¼ˆç±»ï¼Œæ–¹æ³•ï¼‰å¯¼èˆªï¼Œæ–‡æœ¬å¯¼èˆªç­‰ï¼Œè¿˜æœ‰ä¹¦ç­¾ç­‰çš„ä½¿ç”¨æ–¹æ³•ï¼›æé«˜ç¼–å†™ä»£ç åŠé˜…è¯»ä»£ç çš„æ•ˆç‡ï¼›\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"æ’å…¥ç¬¦å¯¼èˆª\"\u003eæ’å…¥ç¬¦å¯¼èˆª\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eåé€€ï¼š==âŒ˜[==\u003c/li\u003e\n\u003cli\u003eå‰è¿›ï¼š==âŒ˜]==\u003c/li\u003e\n\u003cli\u003eæœ€åç¼–è¾‘ç‚¹ï¼š ==â‡§âŒ˜âŒ«==\u003c/li\u003e\n\u003cli\u003eå®šä½åˆ°å½“å‰çš„ç»“æŸæ‹¬å·ï¼š ==Ctrl+M== æˆ–è€… ==â†‘== , ==â†“==\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹å…‰æ ‡æ‰€åœ¨ä½ç½®æ‰€å±çš„å…ƒç´ ï¼š==âŒƒâ‡§Q== ï¼ˆæ³¨æ„çœ‹ä¸‹å›¾çš„å·¦ä¸Šè§’æ˜¾ç¤ºäº†å½“å‰çš„ç±»ï¼‰\n\u003cul\u003e\n\u003cli\u003e\n\u003cimg src=\"https://gitee.com/hanlyjiang/image-repo/raw/master/imgs/20210410141823.png\" alt=\"image-20210410141822945\" style=\"zoom:50%;\" /\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eç§»åŠ¨åˆ°å½“å‰å¼€å§‹æ‹¬å·å¯¹åº”çš„é—­åˆæ‹¬å·ï¼š ==Ctrl + M==\u003c/li\u003e\n\u003cli\u003eåœ¨ä»£ç å—ä¹‹é—´å¯¼èˆªï¼š ==âŒ¥â‡§âŒ˜[== ==âŒ¥â‡§âŒ˜]==\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ç§»åŠ¨æ’å…¥ç¬¦\"\u003eç§»åŠ¨æ’å…¥ç¬¦\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæˆ–è€…ä¸Šä¸€ä¸ªå•è¯ï¼š ==âŒ¥â†’==ï¼Œ==âŒ¥â†==\u003c/p\u003e","title":"IDEAä½¿ç”¨æŠ€å·§ä¹‹å¯¼èˆª"},{"content":"æœ¬æ–‡åˆ†æbindServiceçš„æµç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡é˜…è¯»æºç è·å–ä¸€ä¸ªä¸»çº¿çš„è°ƒç”¨åœ°å›¾ï¼Œç„¶åæå‡ºè‹¥å¹²é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼šAPPè¿›ç¨‹ä¸­å¦‚ä½•è·å–AMSï¼ŒAMSå¦‚ä½•å¯åŠ¨APP-serviceçš„è¿›ç¨‹ï¼ŒAMSä¸­å¦‚ä½•è·å–ApplicationThreadå¹¶ä¸ä¹‹é€šè®¯ï¼ŒServiceçš„å¯åŠ¨åŠç»‘å®šæµç¨‹ï¼›ç„¶åå†é€šè¿‡æºç ä¸€ä¸€è§£ç­”ã€‚æœ€åå†æ•´ä½“æ€»ç»“æ¢³ç†ä¸€ä¸‹æ•´ä½“æµç¨‹ï¼›\né¢„å…ˆçŸ¥è¯†ï¼š\nBinderé€šä¿¡æœºåˆ¶ æ•´ä½“åˆ†æä¸æ€»ç»“ ä¸»çº¿åœ°å›¾ä¸é—®é¢˜æå‡º æˆ‘ä»¬ä»bindServiceä¸€è·¯è·Ÿè¸ªï¼Œåˆæ­¥ç»˜åˆ¶äº†å¦‚ä¸‹çš„è°ƒç”¨åºåˆ—å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥ä¸‹é¢çš„å›¾ä½œä¸ºä¸€ä¸ªä¸»çº¿åœ°å›¾ï¼Œé¿å…èµ°å¤±ï¼Œç„¶åæ ¹æ®å…·ä½“é—®é¢˜è¿›è¡Œç»†èŠ‚åˆ†æã€‚\nContext.bindService frameworks/base/core/java/android/content/Context.java ContextImpl.bindService frameworks/base/core/java/android/app/ContextImpl.java ContextImpl.bindServiceCommon frameworks/base/core/java/android/app/ContextImpl.java IActivityManager.bindIsolatedService android/app/IActivityManager.java ActivityManagerService.bindIsolatedService com/android/server/am/ActivityManagerService.java ActiveServices.bindServiceLocked com/android/server/am/ActiveServices.java IApplicationThread.scheduleBindService android/app/IApplicationThread.java Binder.transact binder Binder. transact binder Binder. transact binder ApplicationThread.scheduleBindService frameworks/base/core/java/android/app/ActivityThread.java ActivityThread#handleBindService frameworks/base/core/java/android/app/ActivityThread.java IBinder = Service.onBinder() è‡ªå®šä¹‰çš„Serviceå®ç°ç±» IActivityManager#publishService android/app/IActivityManager.java ActivityManagerService#publishService android/app/IActivityManager.java ActiveServices#publishServiceLocked com/android/server/am/ActiveServices.java IServiceConnection#connected - ActiveServices.requestServiceBindingLocked com/android/server/am/ActiveServices.java APP-client APPè¿›ç¨‹ AMS-server system_process AMS-server system_process APP:server APP Serviceè¿›ç¨‹ 1 2 ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬æå‡ºå¦‚ä¸‹é—®é¢˜ï¼š\nbindServiceCommonåˆ°IActivityManagerçš„è°ƒç”¨ä¸­ï¼Œæ˜¯å¦‚ä½•è·å–åˆ°ActivityManagerServiceçš„ï¼Ÿ AMSä¸­å¦‚ä½•è·å–ApplicationThreadå¹¶ä¸ä¹‹é€šè®¯ï¼Ÿ ApplicatoinThreadçš„ç”¨é€”ï¼ŸApplicationThreadè¿è¡Œçš„è¿›ç¨‹æ˜¯å“ªä¸ªï¼Ÿ è¿›ç¨‹å¦‚ä½•å¯åŠ¨-å³AMSå¦‚ä½•åˆ›å»ºAPP:serverè¿›ç¨‹ï¼Ÿ Serviceå¦‚ä½•å¯åŠ¨ï¼Ÿ Serviceå¦‚ä½•ç»‘å®šï¼Ÿ ServiceConnection çš„å›è°ƒæ–¹æ³•ä½•æ—¶ä½¿ç”¨ï¼Ÿ é—®é¢˜è§£ç­”æ±‡æ€» æˆ‘ä»¬å°†ç›¸å…³é—®é¢˜çš„ç»“è®ºæå‰åˆ°æ­¤å°èŠ‚ï¼Œä¾¿äºåç»­ä»æ¯”è¾ƒæŠ½è±¡çš„å±‚æ¬¡ä¸Šæ¥è¿›è¡Œå¤ä¹ åŠé¢„è§ˆï¼›\nAPPè¿›ç¨‹å¦‚ä½•è·å–AMSï¼Ÿ APPè¿›ç¨‹ä¸­é€šè¿‡ ServiceManager.getService(Context.ACTIVITY_SERVICE) è·å–çš„ActivityManagerServiceçš„å®¢æˆ·ç«¯æ“ä½œä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ã€‚\nè¯¥å¯¹è±¡ä½äºAPPè¿›ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å¯¹è±¡ï¼ˆé€šè¿‡Binderè¿›ç¨‹é—´é€šä¿¡ï¼‰æ¥è¦æ±‚ï¼ˆä½äºsystem_processä¸­ï¼‰çš„ActivityManagerServiceè¿›è¡Œå¯¹åº”çš„æœåŠ¡æ“ä½œï¼›\nAMSå¦‚ä½•è·å–ApplicationThreadï¼Ÿ APPè¿›ç¨‹åœ¨binderSericeæ—¶ï¼Œå°†è‡ªå·±è¿›ç¨‹ä¸­çš„ApplicationThreadå–å‡ºï¼Œé€šè¿‡Binderæœºåˆ¶ä¼ é€’ç»™AMSè¿›ç¨‹ï¼Œä¼ é€’è¿‡ç¨‹ä¸­ä¼šè½¬æ¢æˆä¸€ä¸ªProxyå¯¹è±¡ï¼›\nActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); æœåŠ¡å¦‚ä½•ç»‘å®šï¼ŸæœåŠ¡å¦‚ä½•å¯åŠ¨ï¼Ÿè¿›ç¨‹å¦‚ä½•å¯åŠ¨ï¼Ÿ è¿›ç¨‹å¯åŠ¨ï¼š åœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­è¿è¡Œçš„æœåŠ¡éœ€è¦å…ˆå°†è¿›ç¨‹å¯åŠ¨ï¼Œè¿›ç¨‹çš„å¯åŠ¨æ˜¯é€šè¿‡APPè¿›ç¨‹ï¼Œè¯·æ±‚ç³»ç»Ÿè¿›ç¨‹ä¸­çš„AMSæ¥æ‰§è¡Œï¼Œé€šè¿‡AMSçš„startProcessLockedæ–¹æ³•å¯åŠ¨è¿›ç¨‹ï¼Œæœ€ç»ˆä¼šé€šè¿‡socketæ¥å£è¯·æ±‚zygoteè¿›ç¨‹æ¥å¯åŠ¨è¿›ç¨‹ã€‚ åœ¨å¯åŠ¨æ—¶ä¼šæŒ‡å®šjavaçš„å…¥å£ç‚¹ä¸ºActivityThreadï¼Œå³è¿›ç¨‹å¯åŠ¨åä¼šè¿è¡ŒActivityThreadçš„mainæ–¹æ³•ï¼› AMSä¸­ä¼šè®°å½•å¯åŠ¨çš„è¿›ç¨‹è®°å½•ï¼ˆProcessRecordï¼‰ï¼Œå¯¹åº”çš„ProcessRecordä¸­ä¼šè®°å½•è¿›ç¨‹å¯¹åº”çš„ApplicationThreadï¼› æœåŠ¡å¯åŠ¨ï¼š æœåŠ¡çš„å¯åŠ¨éœ€è¦è¯·æ±‚AMSæ¥å®Œæˆ å¯åŠ¨æ—¶éœ€è¦å…ˆé€šè¿‡PIDè·å–è¦å¯åŠ¨åˆ°çš„ProcessRecordï¼Œé€šè¿‡ProcessRecordä¸­è®°å½•çš„ApplicationThreadæ¥ä¸å¯¹åº”çš„è¿›ç¨‹é€šä¿¡ã€‚ AMSé€šè¿‡ApplicationThreadæ¥é€šçŸ¥å¯¹åº”çš„è¿›ç¨‹åˆ›å»ºæœåŠ¡ï¼ŒApplicationThreadä½œä¸ºé€šä¿¡çš„æ¥å£ï¼Œå®é™…ä¸Šæœ€ç»ˆä¼šé€šè¿‡ActivityThreadçš„handleCreateServiceæ¥åˆ›å»ºæœåŠ¡çš„å®ä¾‹ï¼› æœåŠ¡åˆ›å»ºæ—¶ï¼Œæ˜¯åœ¨APPè¿›ç¨‹ï¼ˆå¯èƒ½æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼‰ä¸­è¿›è¡Œçš„ï¼Œéœ€è¦é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½å¯¹åº”çš„Serviceçš„ç±»ï¼ŒåŒæ—¶æ„é€ ç›¸åº”çš„ä¸Šä¸‹æ–‡åŠèµ„æºå¯¹è±¡ç­‰ï¼Œç„¶åæ„é€ å¯¹åº”çš„å®ä¾‹ï¼› æœåŠ¡åˆ›å»ºæˆåŠŸåï¼Œä¼šè®°å½•åˆ°ActivityThreadçš„ä¸€ä¸ªServiceåˆ—è¡¨ä¸­ï¼Œä»¥ä¾¿åç»­ç®¡ç†ï¼› æœåŠ¡ç»‘å®šï¼š æœåŠ¡ç»‘å®šå…ˆåœ¨APPè¿›ç¨‹ä¸­ï¼Œé€šè¿‡AMSä»£ç†å¯¹è±¡å‘èµ·è¯·æ±‚ï¼Œç”±AMSæ¥å®‰æ’bindï¼ˆActivityManagerService.bindIsolatedServiceï¼‰; ç„¶åå…·ä½“çš„ç»‘å®šåŠ¨ä½œè¿˜æ˜¯é€šè¿‡IApplicationThreadå®‰æ’åˆ°APPçš„Serviceè¿›ç¨‹ä¸­ï¼Œæœ€ç»ˆæ‰§è¡Œçš„ActivityThread#handleBindService; åœ¨APPè¿›ç¨‹ä¸­ï¼Œä¼šå°†Serviceå–å‡ºï¼Œç„¶åè°ƒç”¨å…¶onBindæ–¹æ³•æ¥è·å–IBinderè¿œç¨‹æ“ä½œå¯¹è±¡ï¼› ä¹‹åå†é€šè¿‡AMSè°ƒç”¨ ActivityManagerService#publishService æ¥é€šçŸ¥ç»‘å®šæˆåŠŸçš„é€šçŸ¥åˆ°å¯¹åº”çš„éœ€è¦ç»‘å®šæœåŠ¡çš„APPè¿›ç¨‹ï¼› publishServiceä¸­ä¼šè°ƒç”¨ServiceConnectionçš„onServiceConnectedæ–¹æ³•é€šçŸ¥æœåŠ¡è¿æ¥äº†ï¼› æ•´ä½“æµç¨‹æ€»ç»“ å¾…è¡¥å……\nè¯¦ç»†åˆ†æè§£ç­”é—®é¢˜ APPè¿›ç¨‹ä¸­å¦‚ä½•è·å–AMSï¼Ÿ è¯´æ˜ï¼š\nç¬¬ä¸€æ¬¡å…ˆé€é¡¹æŸ¥çœ‹å„ä¸ªå°èŠ‚ï¼Œæœ€åå†çœ‹æ­¤å¤„çš„æ€»ç»“ï¼›\nåç»­ç›´æ¥æŸ¥çœ‹æ€»ç»“æ¥å¿«é€Ÿè·å–ç»“è®ºï¼›\n==æ€»ç»“ï¼š==\nAPPè¿›ç¨‹ä¸­é€šè¿‡ ServiceManager.getService(Context.ACTIVITY_SERVICE) è·å–çš„ActivityManagerServiceçš„å®¢æˆ·ç«¯æ“ä½œä»£ç†å¯¹è±¡ï¼ˆProxyï¼‰ã€‚ è¯¥å¯¹è±¡ä½äºAPPè¿›ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å¯¹è±¡ï¼ˆé€šè¿‡Binderè¿›ç¨‹é—´é€šä¿¡ï¼‰æ¥è¦æ±‚ï¼ˆä½äºsystem_processä¸­ï¼‰çš„ActivityManagerServiceè¿›è¡Œå¯¹åº”çš„æœåŠ¡æ“ä½œï¼› å…·ä½“æŸ¥çœ‹å¦‚ä¸‹ä»£ç ï¼š\nContextImpl.bindServiceCommon æˆ‘ä»¬çœ‹ ContextImpl.bindServiceCommon æ–¹æ³•çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯è°ƒç”¨äº† ActivityManager.getService() è·å–çš„ï¼›\nframeworks/base/core/java/android/app/ContextImpl.java:\nprivate boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. IServiceConnection sd; if (executor != null) { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags); } else { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags); } // int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); } ActivityManager.getService() å¦‚ä¸‹ä»£ç ï¼ŒgetServiceå®é™…ä¸Šæ˜¯ä»ServiceManagerè·å–ä¸€ä¸ªActivityServiceçš„Binderè¿œç¨‹æœåŠ¡æ¥å£å¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªä¼šè¢«è®¾ç½®ä¸ºå•ä¾‹æ¨¡å¼ï¼›\nframeworks/base/core/java/android/app/ActivityManager.java:\nprivate static final Singleton\u0026lt;IActivityManager\u0026gt; IActivityManagerSingleton = new Singleton\u0026lt;IActivityManager\u0026gt;() { @Override protected IActivityManager create() { // ç›´æ¥é€šè¿‡ ServiceManager.getService è·å–ä¸€ä¸ªIBinderå¯¹è±¡ final IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE); final IActivityManager am = IActivityManager.Stub.asInterface(b); return am; } }; public static IActivityManager getService() { // ç›´æ¥ä»IActivityManagerSingletonè·å–å®ä¾‹ return IActivityManagerSingleton.get(); } AMSå¦‚ä½•è·å–åˆ° ApplicatoinThreadï¼Ÿ é¦–å…ˆï¼ŒAMSå®é™…ä¸Šä½äºç³»ç»Ÿè¿›ç¨‹ï¼ˆsystem_process)ï¼Œè€ŒApplicationThreadåˆ™ä½äºæˆ‘ä»¬çš„APPè¿›ç¨‹ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè·¨è¿›ç¨‹çš„æ“ä½œå‘¢ï¼Ÿ\nServiceçš„åˆ›å»ºéœ€è¦ç»è¿‡ç³»ç»Ÿçš„ç®¡ç†ï¼Œæ¯”æ–¹è¯´é‰´æƒåŠå…¶ä»–ç®¡ç†éœ€è¦ï¼› è€Œå¼€å‘è€…å®šä¹‰çš„Serviceçš„å®ä¾‹çš„åˆ›å»ºé€»è¾‘ä¹Ÿè¿˜æ˜¯éœ€è¦å¼€å‘è€…æ¥å®ç°ï¼ŒServiceå¯¹åº”çš„ç±»ä¹Ÿåº”è¯¥åªåŠ è½½åœ¨å¼€å‘è€…è‡ªå·±çš„è¿›ç¨‹ä¹‹ä¸­ï¼ŒServiceä½¿ç”¨æ–¹å®é™…ä¸Šè¿˜æ˜¯å¼€å‘è€…è‡ªå·±ï¼Œæ‰€ä»¥æœåŠ¡çš„çœŸå®å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹è¦åœ¨åº”ç”¨çš„è¿›ç¨‹ä¸­ï¼› é‚£ä¹ˆï¼Œç³»ç»Ÿè¿›ç¨‹ï¼ˆä¸­çš„AMSï¼‰å¦‚ä½•è·å–ApplicationThreadå‘¢ï¼Ÿ\nApplicationThreadçš„æ¥æºï¼Ÿ æŸ¥çœ‹ ContextImpl.bindServiceCommon çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨è°ƒç”¨AMSçš„bindServiceæ–¹æ³•æ—¶ï¼Œå°†è‡ªå·±è¿›ç¨‹ä¸­çš„ApplicationThreadåŠActivityTokenå–å‡ºä¼ é€’ç»™äº†AMSæœåŠ¡ï¼›\n// frameworks/base/core/java/android/app/ContextImpl.java final @NonNull ActivityThread mMainThread; private final @Nullable IBinder mToken; public IBinder getActivityToken() { return mToken; } private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. IServiceConnection sd; try { service.prepareToLeaveProcess(this); // è°ƒç”¨æ—¶ä¼ é€’äº†ApplicationThreadå’ŒIBinder int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); if (res \u0026lt; 0) { throw new SecurityException( \u0026#34;Not allowed to bind to service \u0026#34; + service); } return res != 0; } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } å®é™…ä¸Šï¼Œä¸Šé¢çš„mMainThread.getApplicationThread()å–å‡ºçš„æ˜¯æˆ‘ä»¬çš„APPè¿›ç¨‹ä¸­çš„ApplicationThreadçš„æœåŠ¡ç«¯å¯¹è±¡ï¼Œç„¶åç»è¿‡IActivityManagerè¿›è¡Œbinderä¼ è¾“ï¼ˆtransactï¼‰å‰ï¼Œä¼šå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªProxyä»£ç†å¯¹è±¡ï¼Œç”¨äºåœ¨AMSä¸­è¯·æ±‚æˆ‘ä»¬è¿›ç¨‹çš„ApplicationThreadæ¥æä¾›æœåŠ¡ï¼›\n// android.app.IActivityManager.Stub#TRANSACTION_bindIsolatedService case TRANSACTION_bindIsolatedService: { data.enforceInterface(descriptor); android.app.IApplicationThread _arg0; // è¿™é‡Œå°†IApplicationThreadçš„æœåŠ¡å¯¹è±¡è½¬æ¢æˆä¸€ä¸ªProxyä»£ç†å¯¹è±¡ _arg0 = android.app.IApplicationThread.Stub.asInterface(data.readStrongBinder()); android.os.IBinder _arg1; _arg1 = data.readStrongBinder(); android.content.Intent _arg2; if ((0!=data.readInt())) { _arg2 = android.content.Intent.CREATOR.createFromParcel(data); } else { _arg2 = null; } java.lang.String _arg3; _arg3 = data.readString(); android.app.IServiceConnection _arg4; // åŒç†ï¼Œè¿™é‡Œå°†IServiceConnectionçš„æœåŠ¡å¯¹è±¡ä¹Ÿè½¬æ¢æˆä¸€ä¸ªProxyä»£ç†å¯¹è±¡ _arg4 = android.app.IServiceConnection.Stub.asInterface(data.readStrongBinder()); int _arg5; _arg5 = data.readInt(); java.lang.String _arg6; _arg6 = data.readString(); java.lang.String _arg7; _arg7 = data.readString(); int _arg8; _arg8 = data.readInt(); int _result = this.bindIsolatedService(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7, _arg8); reply.writeNoException(); reply.writeInt(_result); return true; } // android.app.IApplicationThread.Stub /** Local-side IPC implementation stub class. */ public static abstract class Stub extends android.os.Binder implements android.app.IApplicationThread { private static final java.lang.String DESCRIPTOR = \u0026#34;android.app.IApplicationThread\u0026#34;; /** Construct the stub at attach it to the interface. */ public Stub() { this.attachInterface(this, DESCRIPTOR); } /** * Cast an IBinder object into an android.app.IApplicationThread interface, * generating a proxy if needed. */ public static android.app.IApplicationThread asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026amp;\u0026amp;(iin instanceof android.app.IApplicationThread))) { return ((android.app.IApplicationThread)iin); } // è¿™é‡Œæ„é€ æˆäº†Proxy return new android.app.IApplicationThread.Stub.Proxy(obj); } } è¿™é‡Œæˆ‘ä»¬æš‚ä¸è€ƒè™‘ApplicationThreadç”±ä½•å¤„è€Œæ¥ï¼Œæ¯ä¸ªè¿›ç¨‹ä¸­éƒ½å¯¹åº”ä¸€ä¸ªActivityThreadï¼ŒActivityThreadä¸­æœ‰ä¸€ä¸ªApplicationThreadå¯¹è±¡ã€‚\nApplicationThreadåœ¨bindæµç¨‹ä¸­çš„ä½¿ç”¨ æˆ‘ä»¬å‘ç°ï¼Œæœ€ç»ˆæ˜¯ä½¿ç”¨ ApplicationThreadçš„ requestServiceBindingLocked æ–¹æ³•æ¥ç»‘å®šæœåŠ¡çš„ï¼ˆr.app.thread.scheduleBindServiceï¼‰ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹ServiceRecordç±»åŒApplicationThreadçš„å…³ç³»ï¼›\n// frameworks/base/services/core/java/com/android/server/am/ActiveServices.java // com.android.server.am.ActiveServices#requestServiceBindingLocked private final boolean requestServiceBindingLocked(ServiceRecord r, IntentBindRecord i, boolean execInFg, boolean rebind) throws TransactionTooLargeException { if (r.app == null || r.app.thread == null) { // If service is not currently running, can\u0026#39;t yet bind. return false; } // è°ƒç”¨ApplicationThreadçš„ç»‘å®šæ–¹æ³•æ¥è¿›è¡Œç»‘å®š r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind, r.app.getReportedProcState()); return true; } // frameworks/base/services/core/java/com/android/server/am/ServiceRecord.java ProcessRecord app; // where this service is running or null. // frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java IApplicationThread thread; // the actual proc... may be null only if // \u0026#39;persistent\u0026#39; is true (in which case we // are in the process of launching the app) å…¶ä¸­ ServiceRecord.app çš„ç±»å‹ä¸º ProcessRecord ï¼ŒServiceRecord.app.thread çš„ç±»å‹ä¸º IApplicationThreadï¼Œæˆ‘ä»¬æ¢³ç†ä¸‹å¯¹åº”çš„å‡ ä¸ªç±»çš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼š\nServiceRecord app:ProcessRecord isolatedProc: ProcessRecord + setProcess(ProcessRecord) IApplicationThread + scheduleBindService(IBinder, Intent, boolean rebind, int processState) + scheduleCreateService(IBinder, ServiceInfo info,â€¦ ) + bindApplication(â€¦) IApplicationThread.Stub ApplicationThread ProcessRecord thread:IApplicationThread pid: int ActivityThread mAppThread:ApplicationThread ç°åœ¨æˆ‘ä»¬çœ‹ä¸‹ ServiceRecord æ˜¯ä½•æ—¶æ„é€ çš„ï¼Œé¦–å…ˆï¼Œæ ¹æ®æ–¹æ³•çš„è°ƒç”¨å±‚æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š\nActiveServices.bindServiceLocked æ–¹æ³•ä¸­ï¼Œå‚æ•°ä¸­æ²¡æœ‰ServiceRecordï¼Œæœ‰çš„æ˜¯IApplicationThreadåŠä¸€ä¸ªIBinderã€‚ ActiveServices.requestServiceBindingLocked æ–¹æ³•ä¸­ï¼Œåˆ™å˜æˆäº†ServiceRecordç±»å‹ã€‚ æç¤ºï¼šä¸Šè¿°è°ƒç”¨å±‚æ¬¡å¯ä»¥åœ¨IDEAä¸­é€‰ä¸­ActiveServices.requestServiceBindingLockedæ–¹æ³•ï¼Œç„¶åé€šè¿‡â€œNavigateï½œCall Hierarchyâ€ï¼ˆå¿«æ·é”®ä¸º==ctrl+opt+H==ï¼‰å¼¹å‡ºã€‚\næ‰€ä»¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ ActiveServices.bindServiceLocked æ–¹æ³•å¦‚ä½•å°†ApplicationThreadå­˜å…¥åˆ°ServiceRecordå¯¹è±¡ä¸­ã€‚\nActiveServices.bindServiceLocked int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { final int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); // è¿™é‡Œè·å–äº† ProcessRecord final ProcessRecord callerApp = mAm.getRecordForAppLocked(caller); final boolean callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND; final boolean isBindExternal = (flags \u0026amp; Context.BIND_EXTERNAL_SERVICE) != 0; final boolean allowInstant = (flags \u0026amp; Context.BIND_ALLOW_INSTANT) != 0; // å°†IApplicationThreadåŠIBinderæ”¾å…¥åˆ°ServiceRecordä¸­çš„è¿‡ç¨‹åœ¨retrieveServiceLockedä¸­ ServiceLookupResult res = retrieveServiceLocked(service, instanceName, resolvedType, callingPackage, callingPid, callingUid, userId, true, callerFg, isBindExternal, allowInstant); // æ­¤å¤„è·å–ServiceRecordï¼Œæ•…åœ¨ä¸Šé¢ ServiceRecord s = res.record; if (s.app != null \u0026amp;\u0026amp; b.intent.received) { requestServiceBindingLocked(s, b.intent, callerFg, true); } else if (!b.intent.requested) { requestServiceBindingLocked(s, b.intent, callerFg, false); } return 1; } åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ServiceRecordæ˜¯é€šè¿‡retrieveServiceLockedæ–¹æ³•è·å–åˆ°çš„ServiceLookupResultè·å–åˆ°çš„ã€‚\n==ç²—ç•¥çœ‹äº†ä¸‹è¿™ä¸ªretrieveServiceLockedæ–¹æ³•ï¼Œå…¶ä¸­é€»è¾‘æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬è¿™é‡Œè½¬æ¢ä¸‹æ€è·¯ï¼Œç›´æ¥æŸ¥æ‰¾ ServiceRecord.app çš„èµ‹å€¼æ“ä½œ==ã€‚\nServiceRecord.app çš„èµ‹å€¼ æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ServiceRecord.appï¼ˆProcessRecordï¼‰çš„èµ‹å€¼æ“ä½œçš„è°ƒç”¨æ–¹æ³•ä¸ºï¼šcom.android.server.am.ActiveServices#realStartServiceLocked\nprivate final void realStartServiceLocked(ServiceRecord r, ProcessRecord app, boolean execInFg) throws RemoteException { if (app.thread == null) { throw new RemoteException(); } // åœ¨æ­¤å¤„èµ‹å€¼ r.setProcess(app); // ... } æŸ¥çœ‹ realStartServiceLocked çš„è°ƒç”¨åºåˆ—ï¼š\nä¹Ÿå°±æ˜¯åˆå›åˆ°äº†æˆ‘ä»¬çš„ bindServiceLocked æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ä¸€æ®µé€»è¾‘æ˜¯ï¼Œå¦‚æœéœ€è¦åˆ›å»ºæœåŠ¡ï¼Œå°±æ‰§è¡Œ bringUpServiceLocked æ–¹æ³•ã€‚\n// com.android.server.am.ActiveServices#bindServiceLocked int bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { // ... if ((flags\u0026amp;Context.BIND_AUTO_CREATE) != 0) { s.lastActivity = SystemClock.uptimeMillis(); if (bringUpServiceLocked(s, service.getFlags(), callerFg, false, permissionsReviewRequired) != null) { return 0; } } // ... } ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç»‘å®šæœåŠ¡çš„æ—¶å€™ï¼Œå¦‚æœæœåŠ¡æ²¡æœ‰åˆ›å»ºï¼Œå°±å…ˆä½¿ç”¨bringUpServiceLocked-realStartServiceLocked è¿›è¡Œåˆ›å»ºï¼Œåˆ›å»ºè¿‡ç¨‹ä¸­ä¼šå°†ServiceRecordä¸­çš„appèµ‹å€¼ï¼Œç„¶åå­˜å‚¨èµ·æ¥ï¼›\næç¤ºï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹IDEAæ“ä½œæ¥æŸ¥æ‰¾èµ‹å€¼æ“ä½œ\né€‰ä¸­æˆå‘˜ï¼ˆè¿™é‡Œæ˜¯ appï¼‰ï¼›\n==Ctrl+B== æˆ–è€… ==Command+é¼ æ ‡å•å‡»==ï¼Œå¼¹å‡ºä½¿ç”¨åˆ—è¡¨å¼¹çª—ï¼›\nç„¶ååœ¨å¼¹çª—ä¸­è®¾ç½®ä»…æŸ¥çœ‹writeè®¿é—®æ“ä½œçš„ï¼›ç„¶åæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„èµ‹å€¼ä»£ç è¡Œï¼›\né€šè¿‡å‹¾é€‰å…¶ä¸­çš„æ–¹æ³•å›¾æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºèµ‹å€¼çš„ä»£ç è¡Œæ‰€åœ¨çš„æ–¹æ³•ï¼ˆè¿™é‡Œæ˜¯setProcessï¼‰ï¼›\nç„¶åæˆ‘ä»¬ç»§ç»­åœ¨æ–¹æ³•ä¸Šæ‰§è¡Œä¸Šè¿°æ“ä½œï¼Œå¯ä»¥è·å–åˆ°æ›´åŠ ä¸Šä¸€æ­¥çš„èµ‹å€¼è°ƒç”¨åœ¨å“ªï¼›\næœåŠ¡å¦‚ä½•ç»‘å®šï¼ŸæœåŠ¡å¦‚ä½•å¯åŠ¨ï¼Ÿè¿›ç¨‹å¦‚ä½•å¯åŠ¨ï¼Ÿ bringUpServiceLocked(ServiceRecord r,\u0026hellip;) ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºServiceRecordï¼Œå…¶ä¸­çš„appå±æ€§å¯å­˜å‚¨ä¸€ä¸ªè¿›ç¨‹è®°å½•ï¼› å¦‚ä¼ å…¥çš„ServiceRecordå‚æ•°ä¸­è¡¨æ˜æœåŠ¡å·²ç»å¯åŠ¨è¿‡ï¼Œr.app(ProcessRecord) ä¸ä¸ºnullï¼Œä¸”r.app.thread(IApplicationThread)ä¹Ÿä¸ä¸ºnullï¼Œåˆ™ä¸åˆ›å»ºï¼Œç›´æ¥æ›´æ–°å‚æ•°ï¼› ç»“ä¸‹æ¥ï¼Œåˆ™åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œ1ï¼‰æœåŠ¡ä¸ºå£°æ˜å•ç‹¬çš„è¿›ç¨‹ï¼Œåˆ™å¯ç›´æ¥åœ¨å½“å‰è¿›ç¨‹ä¸­å¯åŠ¨ï¼›2ï¼‰æœåŠ¡å£°æ˜äº†å•ç‹¬çš„è¿›ç¨‹ï¼Œåˆ™éœ€è¦å…ˆå¯åŠ¨è¿›ç¨‹ï¼Œç„¶åå†å¯åŠ¨æœåŠ¡ï¼› éå•ç‹¬è¿›ç¨‹ï¼š è¿›ç¨‹è®°å½•è·å–ï¼šé€šè¿‡AMSç›´æ¥æŸ¥è¯¢ï¼Œå¹¶æœªåˆ›å»ºï¼Œå› ä¸ºè¿›ç¨‹å·²ç»å­˜åœ¨äº†ï¼Œå…·ä½“ä»£ç ä¸º app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false) æœåŠ¡å¯åŠ¨ï¼šä½¿ç”¨ realStartServiceLocked(r, app, execInFg); æ–¹æ³•å¯åŠ¨ å•ç‹¬è¿›ç¨‹ï¼š è¿›ç¨‹è®°å½•è·å–ï¼š é€šè¿‡AMS.mAm.startProcessLocked æ–¹æ³•å¯åŠ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼› app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags, hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false) æœåŠ¡å¯åŠ¨ï¼šæœªåœ¨æ­¤æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨ realStartServiceLocked è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å•ç‹¬è¿›ç¨‹çš„æœåŠ¡å¯åŠ¨æµç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰å³æ—¶è°ƒç”¨realStartServiceLockedæ¥å¯åŠ¨æœåŠ¡ï¼Œé‚£ä¹ˆè¿™é‡Œå°±åˆä¸ªé—®é¢˜ï¼Œç‹¬ç«‹è¿›ç¨‹æƒ…å†µä¸‹æœåŠ¡ä½•æ—¶å¯åŠ¨ï¼Ÿ\nå•ç‹¬è¿›ç¨‹æœåŠ¡å¯åŠ¨ï¼š å°†å¾…å¯åŠ¨çš„æœåŠ¡åŠ å…¥åˆ°mPendingServices(ArrayList\u0026lt;ServiceRecord\u0026gt;)ï¼Œåœ¨å¯åŠ¨è¿›ç¨‹åå†ä»æ­¤åˆ—è¡¨ä¸­è¯»å–éœ€è¦å¯åŠ¨çš„æœåŠ¡ï¼Œç„¶åå¯åŠ¨ï¼› æ€»ç»“ï¼š\nè¿›ç¨‹è®°å½•å¦‚ä½•è·å–ï¼Ÿ\né€šè¿‡AMSçš„ startProcessLocked æ–¹æ³•åˆ›å»ºï¼ˆéç‹¬ç«‹è¿›ç¨‹çš„ä¹Ÿåº”è¯¥æ˜¯é€šè¿‡æ­¤æ–¹æ³•åˆ›å»ºï¼Œåªæ˜¯åˆ›å»ºæ—¶æœºä¸æ˜¯è¿™é‡Œï¼‰ æœåŠ¡å¦‚ä½•å¯åŠ¨ï¼Ÿ\né€šè¿‡ realStartServiceLocked æ–¹æ³•å¯åŠ¨ï¼ˆç‹¬ç«‹è¿›ç¨‹çš„åº”è¯¥ä¹Ÿæ˜¯æ­¤æ–¹æ³•å¯åŠ¨ï¼Œä¼šç­‰åˆ°è¿›ç¨‹å¯åŠ¨ä¹‹åå†å¯åŠ¨ï¼‰\nrealStartServiceLocked ä¸­é€šè¿‡ IApplicationThread æ‰§è¡Œ scheduleCreateService æ¥å¯åŠ¨æœåŠ¡ï¼Œæœ€ç»ˆè°ƒç”¨ android.app.ActivityThread.ApplicationThread#scheduleCreateServiceæ¥å¯åŠ¨ï¼›\nè¿›ç¨‹åˆ›å»º é—®é¢˜ï¼š\nè¿›ç¨‹ä½•æ—¶åˆ›å»ºï¼Ÿ- å·²è§£å†³ ApplicationThreadï¼ˆä»£ç†ï¼‰å¯¹è±¡ä½•æ—¶è®¾ç½®åˆ°ProcessRecordä¸­? - å·²è§£å†³ ActivityThread#mainçš„å…¥å£ç‚¹ä¸­ï¼Œå¦‚ä½•è·å–ä¹‹å‰çš„ç»“æœï¼Ÿ - å·²è§£å†³ ä¸‹é¢ä¸ºåˆ›å»ºè¿›ç¨‹çš„è°ƒç”¨åºåˆ—ï¼Œæ³¨æ„å¦‚ä¸‹åºåˆ—ä¸­åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªProcessRecordçš„å¯¹è±¡ï¼Œå¯¹åº”äºLinuxä¸Šçš„è¿›ç¨‹åˆ›å»ºæˆ‘ä»¬å†èµ·æ–‡ç« è¿›è¡Œåˆ†æï¼Œå¯¹äºæˆ‘ä»¬çš„Serviceæ¥è¯´ï¼Œæ‹¿åˆ°ProcessRecordå¯¹è±¡å³å¯ä¾›æˆ‘ä»¬æ¥åˆ›å»ºæœåŠ¡ï¼›\nActivityManagerService#startProcessLocked com/android/server/am/ActivityManagerService.java ActivityManagerService#startProcessLocked startProcessLocked(hostingRecord, entryPoint) å¸¦å…¥å£ç‚¹ ProcessList#startProcess å¸¦å…¥å£ç±» android.app.ActivityThread handleProcessStartedLocked è®°å½•ProcessRecordï¼ˆé€šè¿‡PIDï¼‰ android.os.ZygoteProcess#startViaZygote å¸¦å…¥å£ç±» android.app.ActivityThread ZygoteProcess#zygoteSendArgsAndGetResult å¸¦å…¥å£ç±» android.app.ActivityThread zygote zygoteåˆ›å»ºæ–°çš„è¿›ç¨‹ ActivityThread#main() è¿›ç¨‹åˆ›å»ºåæ‰§è¡Œå…¥å£å‡½æ•° ActivityThread#attach module ProcessList#startProcessLocked() com/android/server/am/ProcessList.java ProcessList#newProcessRecordLocked com/android/server/am/ProcessList.java ProcessList#newProcessRecordLocked new ProcessRecord(ams, info, proc, uid) ActiveServices#bringUpServiceLocked com/android/server/am/ActiveServices.java åˆ›å»ºè¿›ç¨‹ socket IActivityManager#attachApplication module ActivityManagerService#attachApplication module ActivityManagerService#attachApplicationLocked è·å–ä¹‹å‰ç¼“å­˜çš„ProcessRecord(app) ProcessRecord#makeActive app.makeActive(thread, mProcessStats) ; thread = _thread; transact binder è¿›ç¨‹åˆ›å»ºçš„æ‰§è¡Œä½äºAMSæ‰€åœ¨çš„ç³»ç»Ÿè¿›ç¨‹ä¹‹ä¸­ï¼› ï¼ˆAMSè¿›ç¨‹ï¼‰é¦–å…ˆï¼Œæ„å»ºä¸€ä¸ªProcessRecordè®°å½•ï¼Œå¹¶å°†å…¶è®°å½•åˆ°AMSä¸­ï¼› ï¼ˆAMSè¿›ç¨‹ï¼‰AMSé€šè¿‡socketé€šä¿¡ï¼Œé€šçŸ¥zygoteæ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼ŒåŒæ—¶æŒ‡å®šå…¥å£ç‚¹ä¸º android.app.ActivityThread ; ï¼ˆAPPè¿›ç¨‹ï¼‰æ–°çš„è¿›ç¨‹å¯åŠ¨åï¼Œæ‰§è¡ŒActivityThreadä¸­çš„æ–¹æ³•ï¼Œé€šçŸ¥AMSæ¥æ‰§è¡ŒattachApplicationï¼› ï¼ˆAMSè¿›ç¨‹ï¼‰AMSä¸­ï¼Œé€šè¿‡PIDè·å–ä¹‹å‰å­˜å‚¨çš„ProcessRecordï¼Œç„¶åå°†ApplicationThreadï¼ˆä»£ç†å¯¹è±¡ï¼‰èµ‹å€¼ç»™ProcessRecordçš„æˆå‘˜å˜é‡threadï¼› æ”¯æŒå®Œæˆäº†å…³è”ï¼› æ„é€ ProcessRecordå®ä¾‹ com.android.server.am.ProcessList#startProcessLockedï¼Œç®€åŒ–ä¸‹æ¥å°±ä¸¤å¥ï¼š\næ„é€ ProcessRecordå¯¹è±¡ï¼š app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord) å¯åŠ¨è¿›ç¨‹ï¼šstartProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride) // com.android.server.am.ProcessList#newProcessRecordLocked // frameworks/base/services/core/java/com/android/server/am/ProcessList.java final ProcessRecord startProcessLocked(String processName, ApplicationInfo info, boolean knownToBeDead, int intentFlags, HostingRecord hostingRecord, int zygotePolicyFlags, boolean allowWhileBooting, boolean isolated, int isolatedUid, boolean keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler) { long startTime = SystemClock.uptimeMillis(); ProcessRecord app; if (app == null) { // æ„é€ ProcessRecordå¯¹è±¡ app = newProcessRecordLocked(info, processName, isolated, isolatedUid, hostingRecord); app.crashHandler = crashHandler; app.isolatedEntryPoint = entryPoint; app.isolatedEntryPointArgs = entryPointArgs; } else { // If this is a new package in the process, add the package to the list app.addPackage(info.packageName, info.longVersionCode, mService.mProcessStats); } // å¯åŠ¨è¿›ç¨‹ final boolean success = startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride); checkSlow(startTime, \u0026#34;startProcess: done starting proc!\u0026#34;); return success ? app : null; } å¯åŠ¨è¿›ç¨‹ startProcessLocked: å¯åŠ¨äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶æŒ‡å®šäº†å…¥å£ç‚¹ä¸º ==android.app.ActivityThread==ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹å¯åŠ¨åå°†ä¼šæ‰§è¡Œ ==android.app.ActivityThread==çš„mainæ–¹æ³•ã€‚\n// frameworks/base/services/core/java/com/android/server/am/ProcessList.java // com.android.server.am.ProcessList#startProcessLocked(com.android.server.am.ProcessRecord, com.android.server.am.HostingRecord, int, boolean, boolean, boolean, java.lang.String) boolean startProcessLocked(ProcessRecord app, HostingRecord hostingRecord, int zygotePolicyFlags, boolean disableHiddenApiChecks, boolean disableTestApiChecks, boolean mountExtStorageFull, String abiOverride) { if (app.pendingStart) { return true; } long startTime = SystemClock.uptimeMillis(); try { try { final int userId = UserHandle.getUserId(app.uid); AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId); } catch (RemoteException e) { throw e.rethrowAsRuntimeException(); } int uid = app.uid; int[] gids = null; // ... app.mountMode = mountExternal; app.gids = gids; app.setRequiredAbi(requiredAbi); app.instructionSet = instructionSet; final String seInfo = app.info.seInfo + (TextUtils.isEmpty(app.info.seInfoUser) ? \u0026#34;\u0026#34; : app.info.seInfoUser); // Start the process. It will either succeed and return a result containing // the PID of the new process, or else throw a RuntimeException. // æŒ‡å®šå…¥å£ç‚¹ä¸ºActivityThreadï¼Œå¯åŠ¨è¿›ç¨‹ final String entryPoint = \u0026#34;android.app.ActivityThread\u0026#34;; return startProcessLocked(hostingRecord, entryPoint, app, uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith, startTime); } catch (RuntimeException e) { return false; } } boolean startProcessLocked(HostingRecord hostingRecord, String entryPoint, ProcessRecord app, int uid, int[] gids, int runtimeFlags, int zygotePolicyFlags, int mountExternal, String seInfo, String requiredAbi, String instructionSet, String invokeWith, long startTime) { app.pendingStart = true; app.killedByAm = false; app.removed = false; app.killed = false; final long startSeq = app.startSeq = ++mProcStartSeqCounter; app.setStartParams(uid, hostingRecord, seInfo, startTime); app.setUsingWrapper(invokeWith != null || Zygote.getWrapProperty(app.processName) != null); mPendingStarts.put(startSeq, app); if (mService.mConstants.FLAG_PROCESS_START_ASYNC) { return true; } else { try { // å¯åŠ¨è¿›ç¨‹ï¼Œå¹¶ä¼ å…¥entrypoint final Process.ProcessStartResult startResult = startProcess(hostingRecord, entryPoint, app, uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith, startTime); // åšå¯åŠ¨åçš„æ“ä½œ handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper, startSeq, false); } catch (RuntimeException e) { } return app.pid \u0026gt; 0; } } è¿™é‡Œæˆ‘ä»¬çœç•¥å…¶ä»–æ›´åŠ åº•å±‚çš„æ­¥éª¤çš„åˆ†æï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“åˆ°äº†è¿™é‡Œä¹‹åï¼Œä¼šå¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹å¯åŠ¨åä¼šæ‰§è¡Œ ==android.app.ActivityThread#main== æ–¹æ³•ï¼›\nè®°å½•è¿›ç¨‹è®°å½•åˆ°AMS ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean)\n==è¿™ä¸ªåœ°æ–¹æœ‰ä¸ªå…³é”®çš„ä»£ç å°†ä¹‹å‰åˆ›å»ºçš„è¿›ç¨‹è®°å½•å­˜å‚¨åˆ°äº†AMSçš„è¿›ç¨‹è®°å½•è¡¨ä¸­ã€‚==\n// com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean) // frameworks/base/services/core/java/com/android/server/am/ProcessList.java ActivityManagerService mService = null; boolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper, long expectedStartSeq, boolean procAttached) { // å°†ProcessRecord å­˜å‚¨åˆ°AMSä¸­ mService.addPidLocked(app); } // frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java void addPidLocked(ProcessRecord app) { synchronized (mPidsSelfLocked) { // å°†è¿›ç¨‹è®°å½•æ·»åŠ åˆ°ä¸€ä¸ªè®°å½•è¡¨ä¸­ mPidsSelfLocked.doAddInternal(app); } synchronized (sActiveProcessInfoSelfLocked) { if (app.processInfo != null) { sActiveProcessInfoSelfLocked.put(app.pid, app.processInfo); } else { sActiveProcessInfoSelfLocked.remove(app.pid); } } mAtmInternal.onProcessMapped(app.pid, app.getWindowProcessController()); } // å®Œæ•´ä»£ç  // com.android.server.am.ProcessList#handleProcessStartedLocked(com.android.server.am.ProcessRecord, int, boolean, long, boolean) // frameworks/base/services/core/java/com/android/server/am/ProcessList.java boolean handleProcessStartedLocked(ProcessRecord app, int pid, boolean usingWrapper, long expectedStartSeq, boolean procAttached) { mPendingStarts.remove(expectedStartSeq); final String reason = isProcStartValidLocked(app, expectedStartSeq); if (reason != null) { Slog.w(TAG_PROCESSES, app + \u0026#34; start not valid, killing pid=\u0026#34; + pid + \u0026#34;, \u0026#34; + reason); app.pendingStart = false; killProcessQuiet(pid); Process.killProcessGroup(app.uid, app.pid); noteAppKill(app, ApplicationExitInfo.REASON_OTHER, ApplicationExitInfo.SUBREASON_INVALID_START, reason); return false; } mService.mBatteryStatsService.noteProcessStart(app.processName, app.info.uid); checkSlow(app.startTime, \u0026#34;startProcess: done updating battery stats\u0026#34;); EventLog.writeEvent(EventLogTags.AM_PROC_START, UserHandle.getUserId(app.startUid), pid, app.startUid, app.processName, app.hostingRecord.getType(), app.hostingRecord.getName() != null ? app.hostingRecord.getName() : \u0026#34;\u0026#34;); try { AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid, app.seInfo, app.info.sourceDir, pid); } catch (RemoteException ex) { // Ignore } Watchdog.getInstance().processStarted(app.processName, pid); checkSlow(app.startTime, \u0026#34;startProcess: building log message\u0026#34;); StringBuilder buf = mStringBuilder; buf.setLength(0); buf.append(\u0026#34;Start proc \u0026#34;); buf.append(pid); buf.append(\u0026#39;:\u0026#39;); buf.append(app.processName); buf.append(\u0026#39;/\u0026#39;); UserHandle.formatUid(buf, app.startUid); if (app.isolatedEntryPoint != null) { buf.append(\u0026#34; [\u0026#34;); buf.append(app.isolatedEntryPoint); buf.append(\u0026#34;]\u0026#34;); } buf.append(\u0026#34; for \u0026#34;); buf.append(app.hostingRecord.getType()); if (app.hostingRecord.getName() != null) { buf.append(\u0026#34; \u0026#34;); buf.append(app.hostingRecord.getName()); } mService.reportUidInfoMessageLocked(TAG, buf.toString(), app.startUid); app.setPid(pid); app.setUsingWrapper(usingWrapper); app.pendingStart = false; checkSlow(app.startTime, \u0026#34;startProcess: starting to update pids map\u0026#34;); ProcessRecord oldApp; synchronized (mService.mPidsSelfLocked) { oldApp = mService.mPidsSelfLocked.get(pid); } // If there is already an app occupying that pid that hasn\u0026#39;t been cleaned up if (oldApp != null \u0026amp;\u0026amp; !app.isolated) { // Clean up anything relating to this pid first Slog.wtf(TAG, \u0026#34;handleProcessStartedLocked process:\u0026#34; + app.processName + \u0026#34; startSeq:\u0026#34; + app.startSeq + \u0026#34; pid:\u0026#34; + pid + \u0026#34; belongs to another existing app:\u0026#34; + oldApp.processName + \u0026#34; startSeq:\u0026#34; + oldApp.startSeq); mService.cleanUpApplicationRecordLocked(oldApp, false, false, -1, true /*replacingPid*/); } // æ³¨æ„è¿™é‡Œ mService.addPidLocked(app); synchronized (mService.mPidsSelfLocked) { if (!procAttached) { Message msg = mService.mHandler.obtainMessage(PROC_START_TIMEOUT_MSG); msg.obj = app; mService.mHandler.sendMessageDelayed(msg, usingWrapper ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT); } } checkSlow(app.startTime, \u0026#34;startProcess: done updating pids map\u0026#34;); return true; } å†™å…¥threadå€¼åˆ°ProcessRecord ä»ä¸Šé¢çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°æ„é€ å‡ºæ¥çš„ProcessRecordçš„threadï¼ˆApplicationThreadï¼‰æˆå‘˜å˜é‡è¿˜æ˜¯æ²¡æœ‰è¢«èµ‹å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªthreadä½•æ—¶è¢«èµ‹å€¼å‘¢ï¼Ÿ\næŸ¥æ‰¾ProcessRecordä¸­threadèµ‹å€¼çš„å…¥å£ï¼š\né€šè¿‡æŸ¥æ‰¾threadæˆå‘˜çš„èµ‹å€¼å†™å…¥æ–¹æ³•ï¼Œå¯ä»¥ç¡®å®šèµ·å§‹ç‚¹æ˜¯ï¼Œcom.android.server.am.ProcessRecord#makeActive ï¼Œæ¥ä¸‹æ¥æŸ¥çœ‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„åˆ—è¡¨ï¼š\nè¿™é‡Œæˆ‘ä»¬æ˜¾ç„¶é€‰æ‹© com.android.server.am.ActivityManagerService#attachApplicationLocked\nandroid.app.ActivityThread#attach\nè¿™é‡Œæˆ‘ä»¬é‡åˆ°ä¸¤ä¸ªé€‰æ‹©ï¼š\næ˜¾ç„¶ï¼Œåº”è¯¥é€‰æ‹©ç¬¬äºŒä¸ªï¼šandroid.app.ActivityThread#main\nè¿™é‡Œæˆ‘ä»¬å´æ— æ³•ç›´æ¥é€šè¿‡IDEAçš„è°ƒç”¨å±‚æ¬¡åŠŸèƒ½æ‰¾åˆ°ä»»ä½•è°ƒç”¨æ–¹æ³•ï¼Œè¯´æ˜å¯èƒ½æ˜¯é€šè¿‡åå°„æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡å…¨å±€å­—ç¬¦ä¸²æœç´¢==android.app.ActivityThread==ï¼Œå¯ä»¥æ‰¾åˆ°åœ¨ ProcessList.startProcessLocked ä¸­è°ƒç”¨çš„ã€‚\né€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œè¿™é‡Œæˆ‘ä»¬ä»ActivityThreadçš„mainå‡½æ•°å¼€å§‹ã€‚\nActivityThread#main public static void main(String[] args) { Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, \u0026#34;ActivityThreadMain\u0026#34;); // Install selective syscall interception AndroidOs.install(); // CloseGuard defaults to true and can be quite spammy. We // disable it here, but selectively enable it later (via // StrictMode) on debug builds, but using DropBox, not logs. CloseGuard.setEnabled(false); Environment.initForCurrentUser(); // Make sure TrustedCertificateStore looks in the right place for CA certificates final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId()); TrustedCertificateStore.setDefaultUserDirectory(configDir); // Call per-process mainline module initialization. initializeMainlineModules(); Process.setArgV0(\u0026#34;\u0026lt;pre-initialized\u0026gt;\u0026#34;); Looper.prepareMainLooper(); // Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line. // It will be in the format \u0026#34;seq=114\u0026#34; long startSeq = 0; if (args != null) { for (int i = args.length - 1; i \u0026gt;= 0; --i) { if (args[i] != null \u0026amp;\u0026amp; args[i].startsWith(PROC_START_SEQ_IDENT)) { startSeq = Long.parseLong( args[i].substring(PROC_START_SEQ_IDENT.length())); } } } // ç›´æ¥æ„é€ ä¸€ä¸ªActivityThreadå¯¹è±¡ ActivityThread thread = new ActivityThread(); // æ‰§è¡Œattachæ–¹æ³• thread.attach(false, startSeq); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } if (false) { Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, \u0026#34;ActivityThread\u0026#34;)); } // End of event ActivityThreadMain. Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); Looper.loop(); throw new RuntimeException(\u0026#34;Main thread loop unexpectedly exited\u0026#34;); } ActivityThread#attach private void attach(boolean system, long startSeq) { sCurrentActivityThread = this; mSystemThread = system; if (!system) { android.ddm.DdmHandleAppName.setAppName(\u0026#34;\u0026lt;pre-initialized\u0026gt;\u0026#34;, UserHandle.myUserId()); // å°†å½“å‰ApplicationThreadçš„Binderå¯¹è±¡ä¿å­˜ä¸ºä¸€ä¸ªé™æ€æˆå‘˜ RuntimeInit.setApplicationObject(mAppThread.asBinder()); // è·å–AMS final IActivityManager mgr = ActivityManager.getService(); try { // é€šçŸ¥AMSæ¥ attachApplication mgr.attachApplication(mAppThread, startSeq); } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } else { } } ActivityManagerService#attachApplication \u0026amp; attachApplicationLocked @Override public final void attachApplication(IApplicationThread thread, long startSeq) { if (thread == null) { throw new SecurityException(\u0026#34;Invalid application interface\u0026#34;); } synchronized (this) { int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid, callingUid, startSeq); Binder.restoreCallingIdentity(origId); } } ä¸Šé¢çš„æ–¹æ³•åªæ˜¯è°ƒç”¨äº† attachApplicationLockedï¼š\n==æœ‰ä¸ªå…³é”®çš„æ­¥éª¤æ˜¯ï¼Œä» AMSçš„è¿›ç¨‹è®°å½•è¡¨ä¸­æ ¹æ®PIDå–å‡ºä¸€ä¸ª ProcessRecord: app = mPidsSelfLocked.get(pid)==\nprivate boolean attachApplicationLocked(@NonNull IApplicationThread thread, int pid, int callingUid, long startSeq) { // Find the application record that is being attached... either via // the pid if we are running in multiple processes, or just pull the // next app record if we are emulating process with anonymous threads. ProcessRecord app; long startTime = SystemClock.uptimeMillis(); long bindApplicationTimeMillis; if (pid != MY_PID \u0026amp;\u0026amp; pid \u0026gt;= 0) { synchronized (mPidsSelfLocked) { // ä»è¿›ç¨‹è®°å½•ä¸­è·å– app = mPidsSelfLocked.get(pid); } } // Make app active after binding application or client may be running requests (e.g // starting activities) before it is ready. // å…³è”threadåˆ°appï¼ˆProcessRecordï¼‰ app.makeActive(thread, mProcessStats); return true; } ç»è¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œå³å®Œæˆäº†ProcessRecordåˆ°è¿›ç¨‹çš„ApplicationThreadçš„å…³è”ã€‚\nå¯åŠ¨æœåŠ¡ ä»AMSä¸­è°ƒç”¨ApplicationThreadçš„æ–¹æ³•æ¥åœ¨Serviceè‡ªå·±åº”è¯¥æ‰€å±çš„è¿›ç¨‹ä¸­åˆ›å»ºServiceå¯¹è±¡çš„å®ä¾‹ã€‚\nActivityThread#main() è¿›ç¨‹åˆ›å»ºåæ‰§è¡Œå…¥å£å‡½æ•° ç‹¬ç«‹è¿›ç¨‹çš„Service å¯åŠ¨è¿›ç¨‹ ActivityThread#attach - IApplicationThread#scheduleCreateService android/app/IApplicationThread.java transact binder transact binder ApplicationThread#scheduleCreateService android/app/ActivityThread.java ActivityThread#handleCreateService android/app/ActivityThread.java IActivityManager#serviceDoneExecuting android/app/ActivityThread.java ActivityManagerService#serviceDoneExecuting android/app/ActivityThread.java ActiveServices#bringUpServiceLocked com/android/server/am/ActiveServices.java ActiveServices#realStartServiceLocked com/android/server/am/ActiveServices.java å¯åŠ¨æœåŠ¡ IActivityManager#attachApplication - ActivityManagerService#attachApplication - ActivityManagerService#attachApplicationLocked è·å–ä¹‹å‰å­˜å‚¨çš„ mPendingServices - å¾…å¯åŠ¨çš„æœåŠ¡åˆ—è¡¨ transact binder ActiveServices#bringUpServiceLocked // com.android.server.am.ActiveServices#bringUpServiceLocked // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java private String bringUpServiceLocked(ServiceRecord r, int intentFlags, boolean execInFg, boolean whileRestarting, boolean permissionsReviewRequired) throws TransactionTooLargeException { // å·²ç»å­˜åœ¨è¿›ç¨‹è®°å½•ï¼Œå¹¶ä¸”è¿›ç¨‹è®°å½•ä¸­çš„IApplicationThreadå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸åˆ›å»ºæœåŠ¡ï¼Œä»…å‘é€å‚æ•° if (r.app != null \u0026amp;\u0026amp; r.app.thread != null) { sendServiceArgsLocked(r, execInFg, false); return null; } final boolean isolated = (r.serviceInfo.flags\u0026amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != 0; final String procName = r.processName; HostingRecord hostingRecord = new HostingRecord(\u0026#34;service\u0026#34;, r.instanceName); ProcessRecord app; // éç‹¬ç«‹çš„è¿›ç¨‹ï¼Œåˆ™ç›´æ¥è·å–å½“å‰å¯åŠ¨è¿›ç¨‹çš„è¿›ç¨‹ä¿¡æ¯ if (!isolated) { app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, false); if (app != null \u0026amp;\u0026amp; app.thread != null) { try { app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats); // éç‹¬ç«‹è¿›ç¨‹ä¸­ï¼Œç›´æ¥å¯åŠ¨æœåŠ¡ realStartServiceLocked(r, app, execInFg); // è°ƒç”¨å¯åŠ¨æ–¹æ³•åç›´æ¥è¿”å› return null; } catch (TransactionTooLargeException e) { throw e; } catch (RemoteException e) { Slog.w(TAG, \u0026#34;Exception when starting service \u0026#34; + r.shortInstanceName, e); } // If a dead object exception was thrown -- fall through to // restart the application. } } else { // ç‹¬ç«‹è¿›ç¨‹åˆ™å…ˆå°è¯•ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„ app = r.isolatedProc; } // ä¹‹å‰æ²¡æœ‰å¯åŠ¨å¯¹åº”çš„è¿›ç¨‹ï¼Œåˆ™å¼€å§‹åˆ›å»ºï¼Œå¯åŠ¨äº†ï¼Œåˆ™æ— éœ€è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œå› ä¸ºServiceRecordä¸­å·²ç»æœ‰äº† if (app == null \u0026amp;\u0026amp; !permissionsReviewRequired) { if ((app=mAm.startProcessLocked(procName, r.appInfo, true, intentFlags, hostingRecord, ZYGOTE_POLICY_FLAG_EMPTY, false, isolated, false)) == null) { String msg = \u0026#34;Unable to launch app \u0026#34; + r.appInfo.packageName + \u0026#34;/\u0026#34; + r.appInfo.uid + \u0026#34; for service \u0026#34; + r.intent.getIntent() + \u0026#34;: process is bad\u0026#34;; Slog.w(TAG, msg); bringDownServiceLocked(r); // è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯ return msg; } if (isolated) { // ç‹¬ç«‹è¿›ç¨‹ï¼Œç¼“å­˜è¿›ç¨‹ä¿¡æ¯åˆ°ä¼ å…¥çš„ServiceRecordå‚æ•°ä¸­ï¼Œä»¥ä¾¿åç»­ç›´æ¥ä½¿ç”¨ r.isolatedProc = app; } } // å°†æœåŠ¡è®°å½•åŠ å…¥çš„mPendingServicesä¸­ï¼Œç”±äºéç‹¬ç«‹è¿›ç¨‹åˆ›å»ºåå·²ç»ç›´æ¥è¿”å›ï¼Œæ‰€ä»¥è¿™é‡Œé€‚ç”¨äºç‹¬ç«‹è¿›ç¨‹çš„ if (!mPendingServices.contains(r)) { mPendingServices.add(r); } // åˆ›å»ºæˆåŠŸæˆ–è€…ä¹‹å‰å·²ç»åˆäº†ç¼“å­˜ï¼Œåˆ™è¿”å›null return null; } ç‹¬ç«‹è¿›ç¨‹ä½•æ—¶å¯åŠ¨æœåŠ¡ï¼Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œå°è£…è¾ƒå¥½çš„ä»£ç ä¼šä¿è¯å…¥å£ç»Ÿä¸€ï¼Œå¦‚æœéç‹¬ç«‹è¿›ç¨‹æƒ…å†µä¸‹æœåŠ¡çš„å¯åŠ¨ä½¿ç”¨çš„æ˜¯ realStartServiceLocked æ–¹æ³•æ¥å¯åŠ¨æœåŠ¡ï¼Œé‚£ä¹ˆç‹¬ç«‹è¿›ç¨‹æƒ…å†µä¸‹ï¼ŒæœåŠ¡çš„å¯åŠ¨ä¹Ÿåº”è¯¥ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æŸ¥çœ‹ realStartServiceLocked æ–¹æ³•çš„è°ƒç”¨å±‚æ¬¡ï¼Œå¦‚ä¸‹ï¼š\nå›¾ç‰‡ç‰ˆæœ¬:\nè¯¦ç»†è°ƒç”¨åºåˆ—:\nActiveServices.attachApplicationLocked(ProcessRecord, String) (com.android.server.am) ActivityManagerService.attachApplicationLocked(IApplicationThread, int, int, long) (com.android.server.am) ActivityManagerService.attachApplication(IApplicationThread, long) (com.android.server.am) ActiveServices.bringUpServiceLocked(ServiceRecord, int, boolean, boolean, boolean) (com.android.server.am) ActiveServices.startServiceInnerLocked(ServiceMap, Intent, ServiceRecord, boolean, boolean) (com.android.server.am) ActiveServices.bindServiceLocked(IApplicationThread, IBinder, Intent, String, IServiceConnection, int, String, \u0026hellip;) (com.android.server.am) ActiveServices.performServiceRestartLocked(ServiceRecord) (com.android.server.am) ä¹Ÿå°±æ˜¯è°ƒç”¨äº† ActiveServices.attachApplicationLocked ,æœ€ç»ˆæ˜¯é€šè¿‡AMSçš„ActivityManagerService.attachApplicationæ¥è§¦å‘çš„;ä¹Ÿå°±æ˜¯åªè¦æ‰¾åˆ°mAm.startProcessLockedåˆ°ActivityManagerService.attachApplicationçš„è°ƒç”¨åºåˆ—å³å¯è¯æ˜æ­¤çŒœæƒ³;\næˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹è°ƒç”¨åºåˆ—ï¼Œå³æœ€ç»ˆå®é™…ä¸Šæ˜¯ä»ActivityThreadçš„mainå‡½æ•°è¿›å…¥çš„ï¼Œæ‰€ä»¥åšå‡ºä»¥ä¸‹çŒœæƒ³ï¼šè¿›ç¨‹å¯åŠ¨åï¼Œåˆ›å»ºActivityThreadæ—¶ï¼Œå¦‚æœæœ‰éœ€è¦åˆ›å»ºçš„æœåŠ¡ï¼Œå°±å¯åŠ¨æœåŠ¡ï¼›\næˆ‘ä»¬å†çœ‹attachApplicationLocked çš„é€»è¾‘ï¼Œå¯ä»¥å‘ç°ï¼Œä¼šæ£€æŸ¥mPendingServicesä¸­æ˜¯å¦æœ‰å¾…å¯åŠ¨çš„æœåŠ¡ï¼Œç„¶åé€ä¸€å¤„ç†ï¼Œå¦‚æœæœ‰éœ€è¦å¯åŠ¨çš„æœåŠ¡ï¼Œåˆ™ä¼šè°ƒç”¨realStartServiceLocked(sr, proc, sr.createdFromFg)æ¥å¯åŠ¨æœåŠ¡ã€‚\n// com.android.server.am.ActiveServices#attachApplicationLocked // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java boolean attachApplicationLocked(ProcessRecord proc, String processName) throws RemoteException { boolean didSomething = false; // Collect any services that are waiting for this process to come up. if (mPendingServices.size() \u0026gt; 0) { ServiceRecord sr = null; try { for (int i=0; i\u0026lt;mPendingServices.size(); i++) { sr = mPendingServices.get(i); // æ’é™¤éç‹¬ç«‹Service if (proc != sr.isolatedProc \u0026amp;\u0026amp; (proc.uid != sr.appInfo.uid || !processName.equals(sr.processName))) { continue; } mPendingServices.remove(i); i--; proc.addPackage(sr.appInfo.packageName, sr.appInfo.longVersionCode, mAm.mProcessStats); // å¯åŠ¨æœåŠ¡ realStartServiceLocked(sr, proc, sr.createdFromFg); } } catch (RemoteException e) { Slog.w(TAG, \u0026#34;Exception in new application when starting service \u0026#34; + sr.shortInstanceName, e); throw e; } } } ActivityThread#handleCreateService è¿™é‡Œæˆ‘ä»¬çœç•¥bringUpServiceLockedæ–¹æ³•åŠä¸‹æ–¹çš„å‡ ä¸ªä¸­é—´æ­¥éª¤ï¼Œç›´æ¥æŸ¥çœ‹android.app.ActivityThread#handleCreateServiceæ–¹æ³•ï¼š\né€šè¿‡ClassLoaderåŠ è½½å¹¶å®ä¾‹åŒ–äº†å¯¹åº”çš„Serviceå¯¹è±¡ï¼› å°†Serviceå­˜å‚¨åˆ°ActivityThreadä¸­çš„ä¸€ä¸ªArrayMapä¸­ï¼› // android/app/ActivityThread.java // android.app.ActivityThread#handleCreateService final ArrayMap\u0026lt;IBinder, Service\u0026gt; mServices = new ArrayMap\u0026lt;\u0026gt;(); private void handleCreateService(CreateServiceData data) { // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); LoadedApk packageInfo = getPackageInfoNoCheck( data.info.applicationInfo, data.compatInfo); Service service = null; try { if (localLOGV) Slog.v(TAG, \u0026#34;Creating service \u0026#34; + data.info.name); ContextImpl context = ContextImpl.createAppContext(this, packageInfo); Application app = packageInfo.makeApplication(false, mInstrumentation); java.lang.ClassLoader cl = packageInfo.getClassLoader(); // åˆ›å»ºå¯¹åº”çš„Serviceå®ä¾‹ service = packageInfo.getAppFactory() .instantiateService(cl, data.info.name, data.intent); // Service resources must be initialized with the same loaders as the application // context. context.getResources().addLoaders( app.getResources().getLoaders().toArray(new ResourcesLoader[0])); context.setOuterContext(service); service.attach(context, this, data.info.name, data.token, app, ActivityManager.getService()); service.onCreate(); mServices.put(data.token, service); try { ActivityManager.getService().serviceDoneExecuting( data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } catch (Exception e) { if (!mInstrumentation.onException(service, e)) { throw new RuntimeException( \u0026#34;Unable to create service \u0026#34; + data.info.name + \u0026#34;: \u0026#34; + e.toString(), e); } } } ç»‘å®šæœåŠ¡ ActivityManagerService.bindIsolatedService com/android/server/am/ActivityManagerService.java ActiveServices.bindServiceLocked com/android/server/am/ActiveServices.java IApplicationThread.scheduleBindService android/app/IApplicationThread.java Binder.transact binder Binder. transact binder ApplicationThread.scheduleBindService frameworks/base/core/java/android/app/ActivityThread.java ActivityThread#handleBindService frameworks/base/core/java/android/app/ActivityThread.java IBinder = Service.onBinder() è‡ªå®šä¹‰çš„Serviceå®ç°ç±» IActivityManager#publishService android/app/IActivityManager.java ActivityManagerService#publishService android/app/IActivityManager.java ActiveServices#publishServiceLocked com/android/server/am/ActiveServices.java IServiceConnection#connected - ActiveServices.requestServiceBindingLocked com/android/server/am/ActiveServices.java æˆ‘ä»¬çš„é—®é¢˜æ˜¯ï¼š\nç»‘å®šæœåŠ¡æ—¶ï¼Œä¼ å…¥çš„ServiceConnectionå¯¹è±¡ï¼Œå¦‚ä½•è¢«è°ƒç”¨æ¥é€šçŸ¥ï¼Ÿ è¿˜åšäº†äº›ä»€ä¹ˆï¼Ÿ è¿æ¥å¯¹è±¡å»å“ªé‡Œäº†ï¼Ÿ æŸ¥çœ‹ContextImpl.bindServiceCommonæ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥äº†å‚æ•° ServiceConnection connï¼Œç„¶åæ–¹æ³•ä¸­è¿™ä¸ªconnæ”¾å…¥åˆ°äº†ä¸€ä¸ª ServiceDispatcher ä¸­.\nIServiceConnection åŒ…å«ä¸¤ä¸ªæ¥å£ï¼š connected(): è¿æ¥åˆ°æœåŠ¡ asBinder()ï¼š æœåŠ¡è½¬Binder è¿™é‡Œä¼šå°†æˆ‘ä»¬è‡ªè¡Œç¼–å†™çš„ServiceConnectionå¯¹è±¡æ„é€ å‡ºä¸€ä¸ªServiceDispatcherå¯¹è±¡ï¼Œç„¶åå°†ServiceDispatcheræä¾›ä¸€ä¸ªIServiceconnectionæ¥å£ï¼ˆServiceDispatcher$InnerConnectionç±»ï¼‰ï¼Œç”¨äºæä¾›æœåŠ¡ï¼› è¿™ä¸ªServiceDispatcher$InnerConnectionç±»çš„connectæ–¹æ³•ä¼šè°ƒç”¨sdçš„connectæ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨æˆ‘ä»¬æä¾›çš„ServiceConnectionçš„å›è°ƒæ–¹æ³•ï¼šmConnection.onServiceConnected(name, service) ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨sd.connect()å°±å¯ä»¥è§¦å‘æˆ‘ä»¬çš„è¿æ¥å¯¹è±¡çš„onServiceConnectedå›è°ƒæ–¹æ³•ï¼›\nfinal @NonNull LoadedApk mPackageInfo; private boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. // è¿™ä¸ªIServiceConnection å®é™…ä¸Šå°±æ˜¯æŒæœ‰ServiceDispatcherçš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œç„¶åå°†ServiceDispatcherçš„å°‘é‡æ–¹æ³•æš´éœ²å‡ºå» IServiceConnection sd; if (mPackageInfo != null) { if (executor != null) { // mPackageInfo æ˜¯ä¸€ä¸ª LoadedApk å¯¹è±¡ sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags); } else { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags); } } else { } int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), // è°ƒç”¨AMSçš„æœåŠ¡å¼è¿™é‡Œä¼ å…¥äº†sd sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); //... } // com.android.server.am.ActiveServices#bindServiceLocked AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp); ConnectionRecord c = new ConnectionRecord(b, activity, connection, flags, clientLabel, clientIntent, callerApp.uid, callerApp.processName, callingPackage); // æä¾› IBinder IBinder binder = connection.asBinder(); s.addConnection(binder, c); b.connections.add(c); ServiceDispatcherç±»ä½äº android.app.LoadedApk.ServiceDispatcherï¼š\n// frameworks/base/core/java/android/app/LoadedApk.java public final IServiceConnection getServiceDispatcher(ServiceConnection c, Context context, Executor executor, int flags) { return getServiceDispatcherCommon(c, context, null, executor, flags); } private IServiceConnection getServiceDispatcherCommon(ServiceConnection c, Context context, Handler handler, Executor executor, int flags) { synchronized (mServices) { LoadedApk.ServiceDispatcher sd = null; ArrayMap\u0026lt;ServiceConnection, LoadedApk.ServiceDispatcher\u0026gt; map = mServices.get(context); if (map != null) { if (DEBUG) Slog.d(TAG, \u0026#34;Returning existing dispatcher \u0026#34; + sd + \u0026#34; for conn \u0026#34; + c); sd = map.get(c); } if (sd == null) { if (executor != null) { sd = new ServiceDispatcher(c, context, executor, flags); } else { sd = new ServiceDispatcher(c, context, handler, flags); } if (DEBUG) Slog.d(TAG, \u0026#34;Creating new dispatcher \u0026#34; + sd + \u0026#34; for conn \u0026#34; + c); if (map == null) { map = new ArrayMap\u0026lt;\u0026gt;(); mServices.put(context, map); } map.put(c, sd); } else { sd.validate(context, handler, executor); } return sd.getIServiceConnection(); } } static final class ServiceDispatcher { private final ServiceDispatcher.InnerConnection mIServiceConnection; @UnsupportedAppUsage private final ServiceConnection mConnection; @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023) private final Context mContext; private final Handler mActivityThread; private final Executor mActivityExecutor; private final ServiceConnectionLeaked mLocation; private final int mFlags; private static class InnerConnection extends IServiceConnection.Stub { @UnsupportedAppUsage final WeakReference\u0026lt;LoadedApk.ServiceDispatcher\u0026gt; mDispatcher; InnerConnection(LoadedApk.ServiceDispatcher sd) { mDispatcher = new WeakReference\u0026lt;LoadedApk.ServiceDispatcher\u0026gt;(sd); } public void connected(ComponentName name, IBinder service, boolean dead) throws RemoteException { LoadedApk.ServiceDispatcher sd = mDispatcher.get(); if (sd != null) { sd.connected(name, service, dead); } } } @UnsupportedAppUsage ServiceDispatcher(ServiceConnection conn, Context context, Handler activityThread, int flags) { mIServiceConnection = new InnerConnection(this); mConnection = conn; mContext = context; mActivityThread = activityThread; mActivityExecutor = null; mLocation = new ServiceConnectionLeaked(null); mLocation.fillInStackTrace(); mFlags = flags; } ServiceConnection getServiceConnection() { return mConnection; } // SDä¸­æä¾›äº†connectedæ–¹æ³• public void connected(ComponentName name, IBinder service, boolean dead) { if (mActivityExecutor != null) { mActivityExecutor.execute(new RunConnection(name, service, 0, dead)); } else if (mActivityThread != null) { mActivityThread.post(new RunConnection(name, service, 0, dead)); } else { doConnected(name, service, dead); } } public void doConnected(ComponentName name, IBinder service, boolean dead) { ServiceDispatcher.ConnectionInfo old; ServiceDispatcher.ConnectionInfo info; synchronized (this) { if (mForgotten) { // We unbound before receiving the connection; ignore // any connection received. return; } old = mActiveConnections.get(name); if (old != null \u0026amp;\u0026amp; old.binder == service) { // Huh, already have this one. Oh well! return; } if (service != null) { // A new service is being connected... set it all up. info = new ConnectionInfo(); info.binder = service; info.deathMonitor = new DeathMonitor(name, service); try { service.linkToDeath(info.deathMonitor, 0); mActiveConnections.put(name, info); } catch (RemoteException e) { // This service was dead before we got it... just // don\u0026#39;t do anything with it. mActiveConnections.remove(name); return; } } else { // The named service is being disconnected... clean up. mActiveConnections.remove(name); } if (old != null) { old.binder.unlinkToDeath(old.deathMonitor, 0); } } // If there was an old service, it is now disconnected. if (old != null) { mConnection.onServiceDisconnected(name); } if (dead) { mConnection.onBindingDied(name); } // If there is a new viable service, it is now connected. if (service != null) { mConnection.onServiceConnected(name, service); } else { // The binding machinery worked, but the remote returned null from onBind(). mConnection.onNullBinding(name); } } } IServiceConnectionè¯´æ˜ æœåŠ¡ç»‘å®šæ—¶ï¼ŒIServiceConnectionçš„ç”¨é€”ï¼Ÿå¦‚ä½•å®ç°åœ¨APPçš„Activityè¿›ç¨‹ä¸­è°ƒç”¨ServiceConnectionçš„onServiceConnectedæ–¹æ³•ï¼Ÿ\nIServiceConnectçš„æœåŠ¡ç«¯ä½äºAPPè¿›ç¨‹ä¸­ï¼Œåœ¨ContextImplçš„binderServiceCommonæ–¹æ³•ä¸­åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯LoadApkç±»ä¸­çš„ServiceDispatcherç±»ã€‚ ä¼ é€’ç»™AMSçš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªBinderçš„è¿œç¨‹ä»£ç†å¯¹è±¡ï¼› // android.app.IActivityManager.Stub#TRANSACTION_bindService // android/app/IActivityManager.java case TRANSACTION_bindService: { data.enforceInterface(descriptor); android.app.IApplicationThread _arg0; _arg0 = android.app.IApplicationThread.Stub.asInterface(data.readStrongBinder()); android.os.IBinder _arg1; _arg1 = data.readStrongBinder(); android.content.Intent _arg2; if ((0!=data.readInt())) { _arg2 = android.content.Intent.CREATOR.createFromParcel(data); } else { _arg2 = null; } java.lang.String _arg3; _arg3 = data.readString(); android.app.IServiceConnection _arg4; // è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨è¿™ä¸ªåœ°æ–¹è§IServiceConnectionçš„æœåŠ¡ç«¯å¯¹è±¡è½¬æ¢æˆå®¢æˆ·ç«¯ä»£ç†å¯¹è±¡çš„ _arg4 = android.app.IServiceConnection.Stub.asInterface(data.readStrongBinder()); int _arg5; _arg5 = data.readInt(); java.lang.String _arg6; _arg6 = data.readString(); int _arg7; _arg7 = data.readInt(); int _result = this.bindService(_arg0, _arg1, _arg2, _arg3, _arg4, _arg5, _arg6, _arg7); reply.writeNoException(); reply.writeInt(_result); return true; } asInterface ä¸­ï¼š new android.app.IServiceConnection.Stub.Proxy(obj) å³æ˜¯å°†Stubè½¬æ¢ä¸ºProxyå¯¹è±¡ï¼›\n/** Local-side IPC implementation stub class. */ public static abstract class Stub extends android.os.Binder implements android.app.IServiceConnection { private static final java.lang.String DESCRIPTOR = \u0026#34;android.app.IServiceConnection\u0026#34;; /** Construct the stub at attach it to the interface. */ public Stub() { this.attachInterface(this, DESCRIPTOR); } /** * Cast an IBinder object into an android.app.IServiceConnection interface, * generating a proxy if needed. */ public static android.app.IServiceConnection asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026amp;\u0026amp;(iin instanceof android.app.IServiceConnection))) { return ((android.app.IServiceConnection)iin); } return new android.app.IServiceConnection.Stub.Proxy(obj); } } ä¹Ÿå°±æ˜¯è¯´ï¼ŒActivityManagerService.bindServiceæ–¹æ³•ä¸­çš„IServiceConnectionå‚æ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªProxyå¯¹è±¡ï¼›\n// è¿™é‡Œçš„Connectionæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ public int bindService(IApplicationThread caller, IBinder token, Intent service, String resolvedType, IServiceConnection connection, int flags, String callingPackage, int userId) throws TransactionTooLargeException { return bindIsolatedService(caller, token, service, resolvedType, connection, flags, null, callingPackage, userId); } ActivityThread#handleBindService å®é™…ä¸Šå°±åšäº†ä¸¤ä»¶äº‹æƒ…\n// android.app.ActivityThread#handleBindService // frameworks/base/core/java/android/app/ActivityThread.java private void handleBindService(BindServiceData data) { // è·å–ä¹‹å‰åˆ›å»ºçš„æœåŠ¡ Service s = mServices.get(data.token); if (s != null) { // æ‰¾ä¸åˆ°ä¹‹å‰åˆ›å»ºçš„æœåŠ¡ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš try { data.intent.setExtrasClassLoader(s.getClassLoader()); data.intent.prepareToEnterProcess(); try { if (!data.rebind) { // è°ƒç”¨Serviceçš„onBindæ¥å£è·å–IBinderå¯¹è±¡ IBinder binder = s.onBind(data.intent); // é€šçŸ¥AMSæ¥publicService ActivityManager.getService().publishService( data.token, data.intent, binder); } else { s.onRebind(data.intent); ActivityManager.getService().serviceDoneExecuting( data.token, SERVICE_DONE_EXECUTING_ANON, 0, 0); } } catch (RemoteException ex) { throw ex.rethrowFromSystemServer(); } } catch (Exception e) { } } } ActivityManagerService#publishService // com.android.server.am.ActivityManagerService#publishService // frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java public void publishService(IBinder token, Intent intent, IBinder service) { // Refuse possible leaked file descriptors if (intent != null \u0026amp;\u0026amp; intent.hasFileDescriptors() == true) { throw new IllegalArgumentException(\u0026#34;File descriptors passed in Intent\u0026#34;); } synchronized(this) { if (!(token instanceof ServiceRecord)) { throw new IllegalArgumentException(\u0026#34;Invalid service token\u0026#34;); } // com.android.server.am.ActiveServices#publishServiceLocked mServices.publishServiceLocked((ServiceRecord)token, intent, service); } } ActiveServices#publishServiceLocked ä¸‹é¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨publishServiceLockedæ–¹æ³•ä¸­ï¼Œå–å‡ºäº†ä¸€ä¸ªè¿æ¥è®°å½•åˆ—è¡¨ï¼Œç„¶åå¾ªç¯çš„è°ƒç”¨äº†å…¶ä¸­çš„IServiceConnectionçš„connectedæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨åˆ°æˆ‘ä»¬è‡ªè¡Œå®šä¹‰çš„ServiceConnnectionå¯¹è±¡çš„connectedæ–¹æ³•ã€‚\nä¸è¿‡æˆ‘ä»¬æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™ä¸ªConnectionRecordå¯¹è±¡æ˜¯ä½•æ—¶æ„é€ çš„ï¼Ÿ\n// com.android.server.am.ConnectionRecord // frameworks/base/services/core/java/com/android/server/am/ConnectionRecord.java final class ConnectionRecord { final AppBindRecord binding; // The application/service binding. final ActivityServiceConnectionsHolder\u0026lt;ConnectionRecord\u0026gt; activity; // If non-null, the owning activity. final IServiceConnection conn; // The client connection. } // com.android.server.am.ActiveServices#publishServiceLocked // frameworks/base/services/core/java/com/android/server/am/ActiveServices.java void publishServiceLocked(ServiceRecord r, Intent intent, IBinder service) { final long origId = Binder.clearCallingIdentity(); try { // å¦‚æœæœåŠ¡è®°å½•ä¸ºnullï¼Œå°±ä»€ä¹ˆéƒ½ä¸åš if (r != null) { Intent.FilterComparison filter = new Intent.FilterComparison(intent); IntentBindRecord b = r.bindings.get(filter); if (b != null \u0026amp;\u0026amp; !b.received) { b.binder = service; b.requested = true; b.received = true; // å–å‡ºè¿æ¥è®°å½•ConnectionRecord ArrayMap\u0026lt;IBinder, ArrayList\u0026lt;ConnectionRecord\u0026gt;\u0026gt; connections = r.getConnections(); for (int conni = connections.size() - 1; conni \u0026gt;= 0; conni--) { ArrayList\u0026lt;ConnectionRecord\u0026gt; clist = connections.valueAt(conni); for (int i = 0; i \u0026lt; clist.size(); i++) { ConnectionRecord c = clist.get(i); try { // è°ƒç”¨IServiceConnectionçš„connectedæ–¹æ³• c.conn.connected(r.name, service, false); } catch (Exception e) { } } } } serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), false); } } finally { } } æ„é€  ConnectionRecord - bindServiceLocked å®é™…ä¸Šè¿™ä¸ªæ„å»ºConnectRecordçš„è¿‡ç¨‹ä½äºbindServiceLockedæ–¹æ³•ä¸­ã€‚\nint bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { final int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); ActivityServiceConnectionsHolder\u0026lt;ConnectionRecord\u0026gt; activity = null; if (token != null) { activity = mAm.mAtmInternal.getServiceConnectionsHolder(token); if (activity == null) { Slog.w(TAG, \u0026#34;Binding with unknown activity: \u0026#34; + token); return 0; } } ServiceLookupResult res = retrieveServiceLocked(service, instanceName, resolvedType, callingPackage, callingPid, callingUid, userId, true, callerFg, isBindExternal, allowInstant); ServiceRecord s = res.record; try { AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp); // æ„é€ è¿æ¥è®°å½•å¯¹è±¡ ConnectionRecord c = new ConnectionRecord(b, activity, connection, flags, clientLabel, clientIntent, callerApp.uid, callerApp.processName, callingPackage); IBinder binder = connection.asBinder(); // æ·»åŠ åˆ°ServiceRecordå¯¹è±¡ä¸­ s.addConnection(binder, c); b.connections.add(c); if (activity != null) { activity.addConnection(c); } b.client.connections.add(c); c.startAssociationIfNeeded(); } finally { } return 1; } éƒ¨åˆ†æ–¹æ³•çš„æºç  ContextImpl.bindService bindService : (frameworks/base/core/java/android/app/ContextImpl.java)\n@Override public boolean bindService(Intent service, ServiceConnection conn, int flags) { warnIfCallingFromSystemProcess(); return bindServiceCommon(service, conn, flags, null, mMainThread.getHandler(), null, getUser()); } @Override public boolean bindService( Intent service, int flags, Executor executor, ServiceConnection conn) { warnIfCallingFromSystemProcess(); return bindServiceCommon(service, conn, flags, null, null, executor, getUser()); } ContextImpl.bindServiceCommon bindServiceCommon: (frameworks/base/core/java/android/app/ContextImpl.java)\nprivate boolean bindServiceCommon(Intent service, ServiceConnection conn, int flags, String instanceName, Handler handler, Executor executor, UserHandle user) { // Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser. IServiceConnection sd; if (conn == null) { throw new IllegalArgumentException(\u0026#34;connection is null\u0026#34;); } if (handler != null \u0026amp;\u0026amp; executor != null) { throw new IllegalArgumentException(\u0026#34;Handler and Executor both supplied\u0026#34;); } if (mPackageInfo != null) { if (executor != null) { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags); } else { sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags); } } else { throw new RuntimeException(\u0026#34;Not supported in system context\u0026#34;); } validateServiceIntent(service); try { // WindowContextæ„é€ å‡½æ•°ä¸­çš„ WindowTokenClient IBinder token = getActivityToken(); if (token == null \u0026amp;\u0026amp; (flags\u0026amp;BIND_AUTO_CREATE) == 0 \u0026amp;\u0026amp; mPackageInfo != null \u0026amp;\u0026amp; mPackageInfo.getApplicationInfo().targetSdkVersion \u0026lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) { flags |= BIND_WAIVE_PRIORITY; } service.prepareToLeaveProcess(this); int res = ActivityManager.getService().bindIsolatedService( mMainThread.getApplicationThread(), getActivityToken(), service, service.resolveTypeIfNeeded(getContentResolver()), sd, flags, instanceName, getOpPackageName(), user.getIdentifier()); if (res \u0026lt; 0) { throw new SecurityException( \u0026#34;Not allowed to bind to service \u0026#34; + service); } return res != 0; } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } ActivityManagerService.bindIsolatedService ä»è¿™é‡Œå¼€å§‹ï¼Œå®é™…ä¸Šä½äºAMSçš„Serverç«¯äº†ï¼Œå³æˆ‘ä»¬çš„Activityæ‰€åœ¨çš„è¿›ç¨‹å‘é€äº†ä¸€ä¸ªå¯åŠ¨æœåŠ¡çš„IPCè¯·æ±‚ç»™AMSï¼ˆsysmte_serverè¿›ç¨‹ä¸­ï¼‰ã€‚\nActivityManagerService.java : (frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java)\npublic int bindIsolatedService(IApplicationThread caller, IBinder token, Intent service, String resolvedType, IServiceConnection connection, int flags, String instanceName, String callingPackage, int userId) throws TransactionTooLargeException { // .... synchronized(this) { // è°ƒç”¨Binderæ¥å£ return mServices.bindServiceLocked(caller, token, service, resolvedType, connection, flags, instanceName, callingPackage, userId); } } ActiveServices.bindServiceLocked ActiveServices.bindServiceLocked: (frameworks/base/services/core/java/com/android/server/am/ActiveServices.java)\nè¿™ä¸ªæ–¹æ³•æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬æˆªå–é‡è¦éƒ¨åˆ†\nint bindServiceLocked(IApplicationThread caller, IBinder token, Intent service, String resolvedType, final IServiceConnection connection, int flags, String instanceName, String callingPackage, final int userId) throws TransactionTooLargeException { // è·å–è°ƒç”¨æ–¹çš„æƒé™ final int callingPid = Binder.getCallingPid(); final int callingUid = Binder.getCallingUid(); final ProcessRecord callerApp = mAm.getRecordForAppLocked(caller); if (callerApp == null) { throw new SecurityException( \u0026#34;Unable to find app for caller \u0026#34; + caller + \u0026#34; (pid=\u0026#34; + callingPid + \u0026#34;) when binding service \u0026#34; + service); } ActivityServiceConnectionsHolder\u0026lt;ConnectionRecord\u0026gt; activity = null; if (token != null) { activity = mAm.mAtmInternal.getServiceConnectionsHolder(token); if (activity == null) { Slog.w(TAG, \u0026#34;Binding with unknown activity: \u0026#34; + token); return 0; } } int clientLabel = 0; PendingIntent clientIntent = null; final boolean isCallerSystem = callerApp.info.uid == Process.SYSTEM_UID; final boolean callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND; final boolean isBindExternal = (flags \u0026amp; Context.BIND_EXTERNAL_SERVICE) != 0; final boolean allowInstant = (flags \u0026amp; Context.BIND_ALLOW_INSTANT) != 0; ServiceLookupResult res = retrieveServiceLocked(service, instanceName, resolvedType, callingPackage, callingPid, callingUid, userId, true, callerFg, isBindExternal, allowInstant); if (res == null) { return 0; } if (res.record == null) { return -1; } ServiceRecord s = res.record; try { if (unscheduleServiceRestartLocked(s, callerApp.info.uid, false)) { if (DEBUG_SERVICE) Slog.v(TAG_SERVICE, \u0026#34;BIND SERVICE WHILE RESTART PENDING: \u0026#34; + s); } if ((flags\u0026amp;Context.BIND_AUTO_CREATE) != 0) { s.lastActivity = SystemClock.uptimeMillis(); if (!s.hasAutoCreateConnections()) { // This is the first binding, let the tracker know. ServiceState stracker = s.getTracker(); if (stracker != null) { stracker.setBound(true, mAm.mProcessStats.getMemFactorLocked(), s.lastActivity); } } } if ((flags \u0026amp; Context.BIND_RESTRICT_ASSOCIATIONS) != 0) { mAm.requireAllowedAssociationsLocked(s.appInfo.packageName); } mAm.startAssociationLocked(callerApp.uid, callerApp.processName, callerApp.getCurProcState(), s.appInfo.uid, s.appInfo.longVersionCode, s.instanceName, s.processName); // Once the apps have become associated, if one of them is caller is ephemeral // the target app should now be able to see the calling app mAm.grantImplicitAccess(callerApp.userId, service, callerApp.uid, UserHandle.getAppId(s.appInfo.uid)); AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp); ConnectionRecord c = new ConnectionRecord(b, activity, connection, flags, clientLabel, clientIntent, callerApp.uid, callerApp.processName, callingPackage); IBinder binder = connection.asBinder(); s.addConnection(binder, c); b.connections.add(c); if (activity != null) { activity.addConnection(c); } b.client.connections.add(c); if (s.app != null) { updateServiceClientActivitiesLocked(s.app, c, true); } ArrayList\u0026lt;ConnectionRecord\u0026gt; clist = mServiceConnections.get(binder); if (clist == null) { clist = new ArrayList\u0026lt;\u0026gt;(); mServiceConnections.put(binder, clist); } clist.add(c); if ((flags\u0026amp;Context.BIND_AUTO_CREATE) != 0) { s.lastActivity = SystemClock.uptimeMillis(); if (bringUpServiceLocked(s, service.getFlags(), callerFg, false, permissionsReviewRequired) != null) { return 0; } } if (s.app != null \u0026amp;\u0026amp; b.intent.received) { // Service is already running, so we can immediately // publish the connection. try { c.conn.connected(s.name, b.intent.binder, false); } catch (Exception e) { Slog.w(TAG, \u0026#34;Failure sending service \u0026#34; + s.shortInstanceName + \u0026#34; to connection \u0026#34; + c.conn.asBinder() + \u0026#34; (in \u0026#34; + c.binding.client.processName + \u0026#34;)\u0026#34;, e); } } else if (!b.intent.requested) { requestServiceBindingLocked(s, b.intent, callerFg, false); } } finally { } return 1; } ActiveServices.realStartServiceLocked /** * Note the name of this method should not be confused with the started services concept. * The \u0026#34;start\u0026#34; here means bring up the instance in the client, and this method is called * from bindService() as well. */ private final void realStartServiceLocked(ServiceRecord r, ProcessRecord app, boolean execInFg) throws RemoteException { if (app.thread == null) { throw new RemoteException(); } r.setProcess(app); r.restartTime = r.lastActivity = SystemClock.uptimeMillis(); // åˆ›å»ºæœåŠ¡ final boolean newService = app.startService(r); bumpServiceExecutingLocked(r, execInFg, \u0026#34;create\u0026#34;); mAm.updateLruProcessLocked(app, false, null); updateServiceForegroundLocked(r.app, /* oomAdj= */ false); mAm.updateOomAdjLocked(app, OomAdjuster.OOM_ADJ_REASON_START_SERVICE); boolean created = false; try { app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE); // åˆ›å»ºæœåŠ¡ app.thread.scheduleCreateService(r, r.serviceInfo, mAm.compatibilityInfoForPackage(r.serviceInfo.applicationInfo), app.getReportedProcState()); r.postNotification(); created = true; } catch (DeadObjectException e) { Slog.w(TAG, \u0026#34;Application dead when creating service \u0026#34; + r); mAm.appDiedLocked(app, \u0026#34;Died when creating service\u0026#34;); throw e; } finally { // } // ç»‘å®šæœåŠ¡ requestServiceBindingsLocked(r, execInFg); updateServiceClientActivitiesLocked(app, null, true); if (newService \u0026amp;\u0026amp; created) { app.addBoundClientUidsOfNewService(r); } // If the service is in the started state, and there are no // pending arguments, then fake up one so its onStartCommand() will // be called. if (r.startRequested \u0026amp;\u0026amp; r.callStart \u0026amp;\u0026amp; r.pendingStarts.size() == 0) { r.pendingStarts.add(new ServiceRecord.StartItem(r, false, r.makeNextStartId(), null, null, 0)); } sendServiceArgsLocked(r, execInFg, true); } ","permalink":"https://hanlyjiang.github.io/posts/androidbindservice-liu-cheng-fen-xi/","summary":"\u003cp\u003eæœ¬æ–‡åˆ†æbindServiceçš„æµç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡é˜…è¯»æºç è·å–ä¸€ä¸ªä¸»çº¿çš„è°ƒç”¨åœ°å›¾ï¼Œç„¶åæå‡ºè‹¥å¹²é—®é¢˜ï¼ŒåŒ…æ‹¬ï¼šAPPè¿›ç¨‹ä¸­å¦‚ä½•è·å–AMSï¼ŒAMSå¦‚ä½•å¯åŠ¨APP-serviceçš„è¿›ç¨‹ï¼ŒAMSä¸­å¦‚ä½•è·å–ApplicationThreadå¹¶ä¸ä¹‹é€šè®¯ï¼ŒServiceçš„å¯åŠ¨åŠç»‘å®šæµç¨‹ï¼›ç„¶åå†é€šè¿‡æºç ä¸€ä¸€è§£ç­”ã€‚æœ€åå†æ•´ä½“æ€»ç»“æ¢³ç†ä¸€ä¸‹æ•´ä½“æµç¨‹ï¼›\u003c/p\u003e","title":"Android bindServiceæµç¨‹"},{"content":" ç®€å•ä»‹ç»ç³»ç»Ÿæ¶æ„ã€ç¼–è¯‘ç¯å¢ƒçš„æ­å»º ç®€å•ä»‹ç»åˆ©ç”¨ AndroidStudio è°ƒè¯• system_process è¿›ç¨‹çš„æ–¹æ³•åŠç¼–è¯‘æ›´æ–°éƒ¨åˆ†ç³»ç»Ÿæ¨¡å—çš„æ–¹å¼ Androidç³»ç»Ÿæ¶æ„ Android ç³»ç»Ÿæ¶æ„å¦‚ä¸‹ä¸¤å›¾æ‰€ç¤ºï¼š\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e åº”ç”¨æ¡†æ¶ã€‚åº”ç”¨æ¡†æ¶æœ€å¸¸è¢«åº”ç”¨å¼€å‘è€…ä½¿ç”¨ã€‚å¾ˆå¤šæ­¤ç±» API éƒ½å¯ä»¥ç›´æ¥æ˜ å°„åˆ°åº•å±‚ HAL æ¥å£ï¼Œå¹¶å¯æä¾›ä¸å®ç°é©±åŠ¨ç¨‹åºç›¸å…³çš„å®ç”¨ä¿¡æ¯ã€‚ Binder IPCã€‚Binder è¿›ç¨‹é—´é€šä¿¡ (IPC) æœºåˆ¶å…è®¸åº”ç”¨æ¡†æ¶è·¨è¶Šè¿›ç¨‹è¾¹ç•Œå¹¶è°ƒç”¨ Android ç³»ç»ŸæœåŠ¡ä»£ç ï¼Œè¿™ä½¿å¾—é«˜çº§æ¡†æ¶ API èƒ½ä¸ Android ç³»ç»ŸæœåŠ¡è¿›è¡Œäº¤äº’ã€‚åœ¨åº”ç”¨æ¡†æ¶çº§åˆ«ï¼Œå¼€å‘è€…æ— æ³•çœ‹åˆ°æ­¤ç±»é€šä¿¡çš„è¿‡ç¨‹ï¼Œä½†ä¸€åˆ‡ä¼¼ä¹éƒ½åœ¨â€œæŒ‰éƒ¨å°±ç­åœ°è¿è¡Œâ€ã€‚ ç³»ç»ŸæœåŠ¡ã€‚ç³»ç»ŸæœåŠ¡æ˜¯ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½çš„æ¨¡å—åŒ–ç»„ä»¶ï¼Œä¾‹å¦‚çª—å£ç®¡ç†å™¨ã€æœç´¢æœåŠ¡æˆ–é€šçŸ¥ç®¡ç†å™¨ã€‚åº”ç”¨æ¡†æ¶ API æ‰€æä¾›çš„åŠŸèƒ½å¯ä¸ç³»ç»ŸæœåŠ¡é€šä¿¡ï¼Œä»¥è®¿é—®åº•å±‚ç¡¬ä»¶ã€‚Android åŒ…å«ä¸¤ç»„æœåŠ¡ï¼šâ€œç³»ç»Ÿâ€ï¼ˆè¯¸å¦‚çª—å£ç®¡ç†å™¨å’Œé€šçŸ¥ç®¡ç†å™¨ä¹‹ç±»çš„æœåŠ¡ï¼‰å’Œâ€œåª’ä½“â€ï¼ˆä¸æ’­æ”¾å’Œå½•åˆ¶åª’ä½“ç›¸å…³çš„æœåŠ¡ï¼‰ã€‚ ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)ã€‚HAL å¯å®šä¹‰ä¸€ä¸ªæ ‡å‡†æ¥å£ä»¥ä¾›ç¡¬ä»¶ä¾›åº”å•†å®ç°ï¼Œè¿™å¯è®© Android å¿½ç•¥è¾ƒä½çº§åˆ«çš„é©±åŠ¨ç¨‹åºå®ç°ã€‚å€ŸåŠ© HALï¼Œç¡¬ä»¶å¼€å‘è€…å¯ä»¥é¡ºåˆ©å®ç°ç›¸å…³åŠŸèƒ½ï¼Œè€Œä¸ä¼šå½±å“æˆ–æ›´æ”¹æ›´é«˜çº§åˆ«çš„ç³»ç»Ÿã€‚HAL å®ç°ä¼šè¢«å°è£…æˆæ¨¡å—ï¼Œå¹¶ä¼šç”± Android ç³»ç»Ÿé€‚æ—¶åœ°åŠ è½½ã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)ã€‚ Linux å†…æ ¸ã€‚å¼€å‘è®¾å¤‡é©±åŠ¨ç¨‹åºä¸å¼€å‘å…¸å‹çš„ Linux è®¾å¤‡é©±åŠ¨ç¨‹åºç±»ä¼¼ã€‚Android ä½¿ç”¨çš„ Linux å†…æ ¸ç‰ˆæœ¬åŒ…å«ä¸€äº›ç‰¹æ®Šçš„è¡¥å……åŠŸèƒ½ï¼Œä¾‹å¦‚ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹ï¼ˆä¸€ä¸ªå†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œå¯æ›´ä¸»åŠ¨åœ°ä¿ç•™å†…å­˜ï¼‰ã€å”¤é†’é”å®šï¼ˆä¸€ç§ PowerManager ç³»ç»ŸæœåŠ¡ï¼‰ã€Binder IPC é©±åŠ¨ç¨‹åºï¼Œä»¥åŠå¯¹ç§»åŠ¨åµŒå…¥å¼å¹³å°æ¥è¯´éå¸¸é‡è¦çš„å…¶ä»–åŠŸèƒ½ã€‚è¿™äº›è¡¥å……åŠŸèƒ½ä¸»è¦ç”¨äºå¢å¼ºç³»ç»ŸåŠŸèƒ½ï¼Œä¸ä¼šå½±å“é©±åŠ¨ç¨‹åºå¼€å‘ã€‚å¯ä»¥ä½¿ç”¨ä»»æ„ç‰ˆæœ¬çš„å†…æ ¸ï¼Œåªè¦å®ƒæ”¯æŒæ‰€éœ€åŠŸèƒ½ï¼ˆå¦‚ Binder é©±åŠ¨ç¨‹åºï¼‰å³å¯ã€‚ä¸è¿‡å»ºè®®ä½¿ç”¨ Android å†…æ ¸çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…æ„å»ºå†…æ ¸ä¸€æ–‡ã€‚ ä»¥ä¸Šéƒ¨åˆ†å†…å®¹æ¥æºï¼š https://source.android.google.cn/devices/architecture?hl=zh-cn\næ­å»ºå¼€å‘ç¯å¢ƒå¹¶ç¼–è¯‘æºç  æœ¬èŠ‚å°†è®¨è®º Android 11 æºç ä¸‹è½½å’Œç¼–è¯‘çš„æ–¹æ³•ã€AndroidStudioå¼€å‘ç¯å¢ƒçš„æ­å»ºæ–¹æ³•ï¼ŒåŠ system_process è¿›ç¨‹çš„è°ƒè¯•æ–¹æ³•ç­‰ç›¸å…³çŸ¥è¯†ã€‚\né€‰æ‹©åˆ†æ”¯ å¯å‚è€ƒ source.android.google.cn çš„æ–‡æ¡£ ä»£å·ã€æ ‡è®°å’Œ Build å· ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰æœ€æ–°çš„ç‰ˆæœ¬åŠæ ‡è®°å¦‚ä¸‹ï¼š\nBuild æ ‡è®° ç‰ˆæœ¬ æ”¯æŒçš„è®¾å¤‡ å®‰å…¨è¡¥ä¸ç¨‹åºçº§åˆ« RQ2A.210305.007 android-11.0.0_r33 Android11 \u0026ndash; \u0026ndash; RQ1D.210105.003 android-11.0.0_r28 Android11 Pixel 3ã€Pixel 3 XLã€Pixel 4a (5G)ã€Pixel 5 2021-01-05 RQ1A.210105.003 android-11.0.0_r27 Android11 Pixel 3ã€Pixel 3 XLã€Pixel 4ã€Pixel 4a (5G)ã€Pixel 4 XLã€Pixel 5 2021-01-05 RQ1A.210105.002 android-11.0.0_r26 Android11 Pixel 3aã€Pixel 3a XLã€Pixel 4a 2021-01-05 å‚è€ƒä»£ç ä»“åº“ä¸­çš„æœ€æ–°Tagï¼Œæˆ‘ä»¬é€‰æ‹© android-11.0.0_r33\næ­å»ºAndroidæ„å»ºç¯å¢ƒ æ„å»ºç¯å¢ƒçš„æ­å»ºå¯å‚è€ƒå®˜æ–¹çš„ æ­å»ºæ„å»ºç¯å¢ƒ æ–‡æ¡£ï¼Œä»¥ä¸‹ç»“åˆå®é™…æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ç®€è¦è¿›è¡Œä»‹ç»ã€‚\næ„å»ºç¯å¢ƒè¦æ±‚ é¦–å…ˆéœ€è¦æœºå™¨æ»¡è¶³ä¸€äº›è¦æ±‚ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œéœ€è¦ï¼š\næ“ä½œç³»ç»Ÿï¼š Linux æˆ–è€… macOS å†…å­˜ï¼š 16GBçš„å¯ç”¨RAM/äº¤æ¢ç©ºé—´ ç¡¬ç›˜ï¼š æ£€å‡ºä»£ç è‡³å°‘250GBå¯ç”¨ç£ç›˜ç©ºé—´ï¼Œå¦‚æœéœ€è¦æ„å»ºï¼Œåˆ™è¿˜éœ€è¦150GB ä»Android8.0 å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨æºç ä¸­å¸¦çš„Dockerfileæ¥æ„å»ºä¸€ä¸ªé•œåƒç”¨äºç¼–è¯‘aospæºç ï¼›ä¸‹é¢æˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç»å¦‚ä½•æ„å»ºç¼–è¯‘ç”¨çš„Dockeré•œåƒåŠç›´æ¥åœ¨macOS11.2ä¸Šæ­å»ºæ„å»ºç¯å¢ƒï¼Œæ„å»ºæ—¶æ ¹æ®æƒ…å†µä»»é€‰ä¸€ç§å³å¯ã€‚\næç¤ºï¼š\næœ€æ–°çš„æ„å»ºè¦æ±‚å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ aospæºç æ„å»ºè¦æ±‚\næ­å»ºæ„å»ºç¯å¢ƒ-Docker dockeré•œåƒåŸºäºubuntu:18.04ï¼Œæ‰€ä»¥ubuntuä¸Šä¹Ÿå¯ä»¥æŒ‰ç…§dockerfileä¸­çš„å‘½ä»¤é…ç½®ç¯å¢ƒ\nè¿™é‡Œå‡è®¾å®‰è£…äº†Dockerï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œå¯ä»¥å‚è€ƒDockerå®˜æ–¹å®‰è£…æ–‡æ¡£è¿›è¡Œå®‰è£…ã€‚\nmkdir docker cd docker å°†å¦‚ä¸‹å†…å®¹ä¿å­˜ä¸ºDockerfileï¼Œå¹¶å­˜å‚¨åˆ°ä¹‹å‰å»ºç«‹çš„dockerç›®å½•\nFROM ubuntu:18.04 ARG userid ARG groupid ARG username RUN apt-get update \\ \u0026amp;\u0026amp; apt-get install -y git-core gnupg flex bison build-essential zip \\ curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \\ x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \\ python3 \\ \u0026amp;\u0026amp; rm -rf /var/lib/apt/lists/* # æœ€æ–°çš„AOSPæºç ä¸­å·²ç»å¸¦äº†JDKï¼Œæ‰€ä»¥æ— éœ€å®‰è£… # RUN curl -o jdk8.tgz https://android.googlesource.com/platform/prebuilts/jdk/jdk8/+archive/master.tar.gz \\ # \u0026amp;\u0026amp; tar -zxf jdk8.tgz linux-x86 \\ # \u0026amp;\u0026amp; mv linux-x86 /usr/lib/jvm/java-8-openjdk-amd64 \\ # \u0026amp;\u0026amp; rm -rf jdk8.tgz RUN curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo \\ \u0026amp;\u0026amp; chmod a+x /usr/local/bin/repo \\ \u0026amp;\u0026amp; ln -s /usr/bin/python3 /usr/bin/python RUN groupadd -f -g $groupid $username || true \\ \u0026amp;\u0026amp; useradd -m -u $userid -g $groupid $username \\ \u0026amp;\u0026amp; echo $username \u0026gt;/root/username \\ \u0026amp;\u0026amp; echo \u0026#34;export USER=\u0026#34;$username \u0026gt;\u0026gt;/home/$username/.gitconfig COPY gitconfig /home/$username/.gitconfig RUN chown $userid:$groupid /home/$username/.gitconfig ENV HOME=/home/$username ENV USER=$username ENTRYPOINT chroot --userspec=$(cat /root/username):$(cat /root/username) / /bin/bash -i ä»¥ä¸ŠdockerfileåŸºäºæºç ä¸­ build/make/tools/docker/Dockerfile ä¿®æ”¹\næ„å»ºé•œåƒï¼š\n# Copy your host gitconfig, or create a stripped down version $ cp ~/.gitconfig gitconfig $ docker build --build-arg userid=$(id -u) --build-arg groupid=$(id -g) --build-arg username=$(id -un) -t android-build-bionic . ä½¿ç”¨é•œåƒï¼š\nå¯ä»¥ç›´æ¥ä½¿ç”¨æˆ‘å·²ç»æ„å»ºå¥½çš„é•œåƒï¼š hanlyjiang/android-build-bionicï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‹‰å–å¹¶ä¿®æ”¹tagï¼š\ndocker pull hanlyjiang/android-build-bionic\ndocker tag hanlyjiang/android-build-bionic android-build-bionic:latest\nå‡è®¾aospçš„æºç ç›®å½•ä½äº ï½/aosp\n# è®¾ç½®å˜é‡æŒ‡å‘æºç é¡¶å±‚ç›®å½• ANDROID_BUILD_TOP=~/aosp # å¦‚è‡ªè¡Œæ„å»ºé•œåƒï¼Œæ­¤å¤„ BUILD_IMAGE=android-build-bionic cd $ANDROID_BUILD_TOP # è¿è¡Œå®¹å™¨ï¼Œå¹¶å°†aospæºç ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨çš„/srcç›®å½• docker run -it --rm --name aosp-builder -v $PWD:/src $BUILD_IMAGE å¯åŠ¨æˆåŠŸåå°±ä¼šè¿›å…¥å®¹å™¨çš„shellä¸­ï¼Œä¹‹ååœ¨å®¹å™¨ä¸­è¿›è¡Œæ‰§è¡Œå¯¹åº”çš„ç¼–è¯‘å‘½ä»¤å³å¯ã€‚\ndockerä½¿ç”¨æç¤ºï¼š\nä¸Šé¢çš„docker run å‘½ä»¤ä¸­æ·»åŠ äº† --rm é€‰é¡¹ï¼Œåœ¨å¯åŠ¨çš„äº¤äº’å¼bashç»“æŸåå°±ä¼šè‡ªåŠ¨ç§»é™¤å®¹å™¨ã€‚ä¹‹åéœ€è¦å†æ¬¡è¾“å…¥docker runå‘½ä»¤å¯åŠ¨å®¹å™¨ï¼›ä¸ºäº†é¿å…æ¯æ¬¡éƒ½è¾“å…¥å¦‚ä¸Šå‘½ä»¤å¯åŠ¨å®¹å™¨ï¼Œå¯ä»¥ç§»é™¤--rm é€‰é¡¹ æˆ‘ä»¬æ‰§è¡Œæ„å»ºä¸€èˆ¬éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ŒæœŸé—´å¦‚æœæˆ‘ä»¬é€€å‡ºå®¹å™¨çš„bashï¼Œåˆ™æ„å»ºä»»åŠ¡ä¼šç»ˆæ­¢ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ctrl+P ctrl+Q å‘½ä»¤å‘Šè¯‰dockeræˆ‘ä»¬éœ€è¦å…³é—­å®¹å™¨åˆ°æœ¬æœºçš„è¾“å…¥è¾“å‡ºé‡å®šå‘ï¼Œä½†æ˜¯å¹¶ä¸æš‚åœä»»ä½•æ‰§è¡Œçš„ä»»åŠ¡ã€‚ä¹‹åå†ä½¿ç”¨ docker attach aosp-builderï¼ˆaosp-builderæ˜¯æˆ‘ä»¬å¯åŠ¨æ—¶æŒ‡å®šçš„å®¹å™¨åç§°ï¼‰ å³å¯é‡æ–°å°†å®¹å™¨è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æœ¬æœºç»ˆç«¯ï¼Œç»§ç»­ä¸å®¹å™¨å†…çš„shelläº¤äº’ã€‚ æ­å»ºæ„å»ºç¯å¢ƒ-macOS11.2 è¿™é‡Œä»‹ç»ä¸‹macOSï¼ˆx86ï¼‰ç¼–è¯‘çš„ç¯å¢ƒé…ç½®\nå‡†å¤‡æºç ç›®å½•\nç”±äºmacOSé»˜è®¤çš„åˆ†åŒºæ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ï¼Œä½†æ˜¯aospç¼–è¯‘éœ€è¦åŒºåˆ†å¤§å°å†™ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªåŒºåˆ†å¤§å°å†™çš„åˆ†åŒºï¼Œè¿™é‡Œå¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š\n1ï¼‰ä½¿ç”¨å¦å¤–ä¸€ä¸ªç£ç›˜ï¼ˆå¦‚å¤–ç½®çš„ç§»åŠ¨ç¡¬ç›˜ï¼‰ï¼Œç„¶åä½¿ç”¨ç£ç›˜å·¥å…·å°†å…¶æŠ¹æ‰ä¸ºåŒºåˆ†å¤§å°å†™çš„åˆ†åŒºï¼›\n2ï¼‰åˆ›å»ºä¸€ä¸ªåŒºåˆ†å¤§å°å†™çš„ç£ç›˜æ˜ åƒï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ‰§è¡Œ\nhdiutil create -type SPARSE -fs \u0026#39;Case-sensitive Journaled HFS+\u0026#39; -size 250g ~/android.dmg.sparseimage # å®šä¹‰è£…è½½å¸è½½å‡½æ•° mountAndroid() { hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android; } umountAndroid() { hdiutil detach /Volumes/android; } # è£…è½½åˆšåˆšåˆ›å»ºçš„ç£ç›˜æ˜ åƒåˆ° /Volumes/android ç›®å½•ï¼Œä¹‹åcd åˆ°æ­¤ç›®å½•æ‰§è¡Œå³å¯ mountAndroid å®‰è£… xcode å‘½ä»¤è¡Œå·¥å…·\nxcode-select --install è®¾ç½®bash\n# å¯åŠ å…¥åˆ°ï½/.bash_profile æ–‡ä»¶ä¸­ ulimit -S -n 2048 ä¸‹è½½ 10.15 SDK\nä»æ­¤å¤„ä¸‹è½½ï¼š https://github.com/phracker/MacOSX-SDKs/releases\nä¸‹è½½å®Œæˆåæ”¾å…¥åˆ°æ­¤ç›®å½•ï¼š/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/\nä¿®å¤ä»£ç ï¼ˆåœ¨ä¸‹è½½å®Œæˆæºç ä¹‹åæ‰§è¡Œï¼‰\nç¼–è¾‘æ–‡ä»¶ system/core/base/cmsg.cpp\næ·»åŠ ä¸€è¡Œï¼šsize_t psize = getpagesize();\nnamespace base { size_t psize = getpagesize(); ssize_t SendFileDescriptorVector(borrowed_fd sockfd, const void* data, size_t len, å°†æ–‡ä»¶ä¸­æ‰€æœ‰ PAGE_SIZE æ›¿æ¢ä¸º psize\nå‚è€ƒï¼š\nBuilding Android 11 for PH-1 on Apple Silicon Could not find a supported mac sdk: â€œ10.10â€ â€œ10.11â€ â€œ10.12â€ â€œ10.13â€ åˆ›å»ºåŒºåˆ†å¤§å°å†™çš„ç£ç›˜æ˜ åƒ-source.android.google.cn ä¸‹è½½æºç  å®‰è£…Repo æç¤ºï¼š å…ˆå‰æ„å»ºçš„dockeré•œåƒä¸­å·²ç»å®‰è£…äº†repoï¼Œå¦‚ä½¿ç”¨é•œåƒï¼Œå¯è·³è¿‡æ­¤æ­¥éª¤\nmkdir ~/.bin PATH=~/.bin:$PATH # è¿™é‡Œå¯èƒ½éœ€è¦å¼€å¯ä»£ç† curl https://storage.googleapis.com/git-repo-downloads/repo \u0026gt; ~/bin/repo chmod a+x ~/bin/repo # éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ repo help è¾“å‡ºå¦‚ä¸‹åˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸï¼š\nusage: repo COMMAND [ARGS] repo is not yet installed. Use \u0026#34;repo init\u0026#34; to install it here. The most commonly used repo commands are: init Install repo in the current working directory help Display detailed help on a command For access to the full online help, install repo (\u0026#34;repo init\u0026#34;). è·å–aospæºç åº•åŒ… wget https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar # è§£å‹ tar xf aosp-latest.tar æˆ–è€…ç›´æ¥ä¸‹è½½ï¼š\nmkdir aosp ; cd aosp repo init -u https://android.googlesource.com/platform/manifest -b android-11.0.0_r33 ç„¶åæ‰§è¡Œä»£ç åŒæ­¥å‘½ä»¤ï¼š\nrepo sync -c -j16 repo sync å‘½ä»¤è¯´æ˜ï¼š\né€šè¿‡ -c æŒ‡å®šåªè·å–å½“å‰åˆ†æ”¯ é€šè¿‡ -j16 æŒ‡å®šå¹¶è¡Œè·å–çš„çº¿ç¨‹æ•°é‡ï¼Œè¿™é‡Œæˆ‘ç”µè„‘ä¸º8æ ¸ï¼Œæ‰€ä»¥æŒ‡å®šäº†16ä¸ªçº¿ç¨‹ æç¤ºï¼š\nä»£ç ä¸‹è½½å®Œæˆåï¼Œæˆ‘ä»¬å¤åˆ¶ä¸€ä»½åˆ°å¦å¤–ä¸€ä¸ªç›®å½•åªç”¨äºæµè§ˆä»£ç  rsync -a -H --progress aosp aosp-ro\nç¼–è¯‘æºç  é¦–å…ˆï¼Œ æˆ‘ä»¬ä½¿ç”¨ repo å¯åŠ¨ä¸€ä¸ªå·¥ä½œåˆ†æ”¯\nrepo start dev_android11_r33 --all åˆå§‹åŒ–ç¯å¢ƒï¼š\nsource build/envsetup.sh envsetup.sh è„šæœ¬ä¼šå¯¼å…¥è‹¥å¹²å‘½ä»¤ï¼Œå¯ä½¿ç”¨ hmm æŸ¥çœ‹å®Œæ•´çš„å¯ç”¨å‘½ä»¤åˆ—è¡¨ã€‚\né€‰æ‹©ç›®æ ‡ï¼š\nlunch aosp_x86_64-eng è¾“å‡ºå¦‚ä¸‹ï¼š\n$ lunch aosp_x86_64-eng ============================================ PLATFORM_VERSION_CODENAME=REL PLATFORM_VERSION=11 TARGET_PRODUCT=aosp_x86_64 TARGET_BUILD_VARIANT=eng TARGET_BUILD_TYPE=release TARGET_ARCH=x86_64 TARGET_ARCH_VARIANT=x86_64 TARGET_2ND_ARCH=x86 TARGET_2ND_ARCH_VARIANT=x86_64 HOST_ARCH=x86_64 HOST_OS=darwin HOST_OS_EXTRA=Darwin-20.3.0-x86_64-11.2.3 HOST_BUILD_TYPE=release BUILD_ID=RQ2A.210305.007 OUT_DIR=out PRODUCT_SOONG_NAMESPACES=device/generic/goldfish device/generic/goldfish-opengl hardware/google/camera hardware/google/camera/devices/EmulatedCamera device/generic/goldfish device/generic/goldfish-opengl æ„å»ºï¼š\nmake -j16 æç¤ºï¼šæ„å»ºå‘½ä»¤å¯å‚è€ƒ å®˜æ–¹æ–‡æ¡£-ç¼–è¯‘ Android\næ„å»ºæˆåŠŸåè¾“å‡ºå¦‚ä¸‹ï¼š\n[100% 119047/119047] Create system-qemu.img now removing out/target/product/generic_x86_64/system-qemu.img.qcow2 out/host/darwin-x86/bin/sgdisk --clear out/target/product/generic_x86_64/system-qemu.img #### build completed successfully (14:34:15 (hh:mm:ss)) #### æˆ‘ä»¬è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿå™¨è¿›è¡Œè¿è¡Œ\nemulator è¿è¡Œèµ·æ¥ä¹‹åï¼ŒæŸ¥çœ‹å…¶ä¸­çš„ç³»ç»Ÿç‰ˆæœ¬å·å¦‚ä¸‹ï¼š\nä½¿ç”¨AndroidStudioè°ƒè¯• system_process æœ¬å°èŠ‚ä»‹ç»å¦‚ä½•ä½¿ç”¨ASæ¥è°ƒè¯•Android Java Frameworkçš„æ ¸å¿ƒè¿›ç¨‹ system_processã€‚\nä¸‹è½½å®‰è£…AndroidStudio ä»AndroidStudioå®˜æ–¹é¡µé¢ä¸‹è½½å®‰è£…è¿è¡Œå³å¯\nç”ŸæˆASé¡¹ç›®é…ç½® æ€»çš„æµç¨‹å¦‚ä¸‹ï¼š\nå…¨é‡ç¼–è¯‘ä¸€æ¬¡aospæºç  ç¼–è¯‘development/tools/idegen ç”Ÿæˆ idegen.jar æ–‡ä»¶ï¼› ä½¿ç”¨development/tools/idegen/idegen.sh ç”ŸæˆASé¡¹ç›®é…ç½® ä½¿ç”¨AndroidStudioæ‰“å¼€ç”Ÿæˆçš„é…ç½®ï¼Œå¯¼å…¥æºç é¡¹ç›® å…¶ä¸­ idegen.sh ä»…æ˜¯ç®€å•çš„ä½¿ç”¨javaæ‰§è¡Œidegen.jarï¼Œidegen.jar ä¼šåœ¨æºç æ ¹ç›®å½•ç”Ÿæˆandroidstudioä½¿ç”¨çš„ä¸¤ä¸ªæ–‡ä»¶ï¼Œå³android.imlå’Œandroid.iprï¼Œç”Ÿæˆè¿‡ç¨‹ä¸­ä¼šè¯»å– excluded-paths æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰è¿‡æ»¤è§„åˆ™ï¼Œè¯¥æ–‡ä»¶ä¼šä»ä¸‰ä¸ªè·¯å¾„å»è¯»å–ï¼š\ndevelopment/tools/idegen/excluded-paths vendor/google/excluded-paths æºç æ ¹ç›®å½•çš„ excluded-paths æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†è‡ªå·±çš„è¿‡æ»¤è§„åˆ™å®šä¹‰åˆ°æºç æ ¹ç›®å½•çš„ excluded-pathsæ–‡ä»¶ä¸­å³å¯ã€‚\nandroid.iml ä¸­æœ‰ä¸‰ç§xmlé…ç½®:\n1ï¼‰sourceFolder;\nexcludeFolder;\norderEntry;\nidegen.jar åœ¨æ‰§è¡Œæ—¶ä¼šæ ¹æ®é…ç½®çš„è§„åˆ™è‡ªåŠ¨å†™å…¥è¿™ä¸‰ç§è§„åˆ™ï¼Œå…¶ä¸­sourceFolderç”¨äºæŒ‡å®šæºç ç›®å½•-å³asä¼šå°†å…¶ä½œä¸ºæºç å¯¼å…¥ï¼ŒexcludeFolderç”¨äºæŒ‡å®šæ’é™¤ç›®å½•-å³aså‹æ ¹ä¸ä¼šå»æœç´¢ä»»ä½•æ–‡ä»¶ï¼Œä¹Ÿä¸ä¼šå¯¹å…¶ä¸­çš„æ–‡ä»¶å»ºç«‹ç´¢å¼•ï¼ŒorderEntry åˆ™ä¸€èˆ¬ç”¨äºæŒ‡å®šä¾èµ–çš„jaræ–‡ä»¶ï¼›\nåœ¨idegen.jarçš„é€»è¾‘ä¸­ï¼š\næ²¡æœ‰è¢«è¿‡æ»¤è§„åˆ™åŒ¹é…åˆ°çš„ç›®å½•éƒ½ä¼šå°è¯•å»å…¶ä¸­æœå¯»javaåŠjaræ–‡ä»¶ï¼Œåªæœ‰åœ¨å…¶ä¸­æ‰¾åˆ°äº†æºç æ–‡ä»¶ï¼Œæ‰ä¼šè¢«åŠ å…¥åˆ°sourceFolderä¸­ã€‚ è¿‡æ»¤è§„åˆ™ä¸­é…ç½®çš„ç›®å½•ï¼Œåªæœ‰å…¶ä¸­æœ‰javaåŠjaræ–‡ä»¶æ—¶ï¼Œæ‰ä¼šè¢«åŠ å…¥åˆ°excludeFolderé…ç½®ä¸­ã€‚ å¦‚æœç›®å½•ä¸­æ‰¾åˆ°äº†javaæ–‡ä»¶ï¼Œä¼šå»è¯»å–javaæ–‡ä»¶ï¼Œè‡ªåŠ¨ç¡®è®¤sourceFolderçš„å¼€å§‹è·¯å¾„ï¼Œä»¥ä¿è¯è·¯å¾„èƒ½æ­£ç¡®åŒ¹é…åŒ…åï¼Œå¦‚ï¼šæœ‰ä¸ªç›®å½•de vice/test/src/java/android/Test.javaï¼Œå…¶ä¸­Test.javaçš„åŒ…ä¸ºandroidï¼Œé‚£ä¹ˆsourceFolderçš„è·¯å¾„ä¼šè‡ªåŠ¨è®¾ç½®ä¸ºde vice/test/src/java/ã€‚ ä¿®æ”¹idegenä»£ç å¹¶ç¼–è¯‘idegen.jar ä¿®æ”¹ development/tools/idegen æ¨¡å—ä»£ç åŠé…ç½®\nsrc/Log.java ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œæ‰“å¼€debugæ—¥å¿—å¼€å…³\nclass Log { static final boolean DEBUG = true; // ... } src/IntelliJ.java , è¿™é‡Œç”±äºä»£ç ä¸­ä¹¦å†™é”™è¯¯ï¼Œprebuilt å®é™…ä¸Šåœ¨æºç ä¸­å¹¶ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å°†å…¶ä¿®æ”¹ä¸º prebuilts\nsourceRootsXml.append(\u0026#34;\u0026lt;excludeFolder url=\\\u0026#34;file://$MODULE_DIR$/out/target/product\\\u0026#34;/\u0026gt;\\n\u0026#34;); // ä¿®æ”¹è¿™ä¸€è¡Œ prebuilt --\u0026gt; prebuilts sourceRootsXml.append(\u0026#34;\u0026lt;excludeFolder url=\\\u0026#34;file://$MODULE_DIR$/prebuilts\\\u0026#34;/\u0026gt;\\n\u0026#34;); ç¼–è¯‘ç”Ÿæˆ idegen.jar\n# åœ¨æºç æ ¹ç›®å½•æ‰§è¡Œ source build/envsetup.sh cd development/tools/idegen mm -j16 æˆåŠŸç”Ÿæˆåè¾“å‡ºå¦‚ä¸‹ï¼š\n[100% 228/228] Install: out/host/darwin-x86/framework/idegen.jar #### build completed successfully (05:30 (mm:ss)) #### æ‰‹åŠ¨è·å–javaæ–‡ä»¶ æ‰‹åŠ¨è·å–AIDLç”Ÿæˆçš„javaæ–‡ä»¶ æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹å‘½ä»¤å°†aidlç”Ÿæˆçš„javaæ–‡ä»¶æ‹·è´åˆ° æºç æ ¹ç›®å½•çš„idea/aidl/srcç›®å½•ä¸‹\ncroot mkdir -p idea/aidl/src find out/soong/.intermediates/frameworks/base/api-stubs-docs-non-updatable/android_common/gen/aidl -name \u0026#34;*.srcjar\u0026#34; | xargs -I {} unzip {} -d idea/aidl/src è·å–ç”Ÿæˆçš„èµ„æº cp -R out/soong/.intermediates/frameworks/base/core/res/framework-res/android_common/gen/aapt2/R idea/framework-res_R ç¼–è¾‘æ’é™¤è§„åˆ™å¹¶ç”Ÿæˆé…ç½® åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ª excluded-paths æ–‡ä»¶ï¼Œè¾“å…¥å¦‚ä¸‹å†…å®¹ï¼ˆä¸€è¡Œä½œä¸ºä¸€ä¸ªåŒ¹é…è§„åˆ™ï¼Œè§„åˆ™çš„æ ¼å¼æŒ‰Javaä¸­Patternç±»çš„è§„åˆ™ç¼–å†™ï¼‰\n# å‡ ä¸ªæ ¹ç›®å½•çš„è§„åˆ™ ^art/.* ^packages/.* ^bootable/.* ^build/.* ^cts/.* ^dalvik/.* ^developers/.* ^external/.* ^platform_testing/.* ^pdk/.* ^sdk/.* ^system/.* ^test/.* # platform-compatä¸­æœ‰æ³¨è§£çš„ç±» ^tools/(?!(platform-compat)) ^development/.* ^device/.* ^prebuilts/* # è¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹è¿™ä¸¤ä¸ªæ¨¡å—ï¼Œæ‰€ä»¥æ³¨é‡Šæ‰ #^libcore/.* #^frameworks/.* # å…³äºoutå…¶ä»–çš„ä¸€äº›è§„åˆ™ ^out/soong/.intermediates/(?!((frameworks)|(libcore))) # ./out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_x86_64_shared/gen/aidl/android/os/BnServiceManager.h # ^out/soong/.intermediates/.* ^out/target/.* # æ ¹æ®å®é™…è¿è¡Œæƒ…å†µè¡¥å……çš„è§„åˆ™ # ç§»é™¤å¯èƒ½çš„jar # å¦‚ ./frameworks/base/tools/aapt2/integration-tests/CommandTests/android-28.jar ^frameworks/base/tools/aapt2/.*\\.jar ^frameworks/base/tests ^libcore/support/src/test ^libcore/luni/src/test gradle-wrapper.jar # å¯¹äºsdkæºç çš„éšè—ï¼Œæˆ‘ä»¬excludeæ‰ï¼Œä»¥ä½¿å¯ä»¥æ‰¾åˆ°çœŸæ­£çš„æºç  ^libcore/ojluni/annotations ç”Ÿæˆimlæ–‡ä»¶ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ç”Ÿæˆ\ndevelopment/tools/idegen/idegen.sh å®Œæˆåæ ¹ç›®å½•ä¸‹å³ç”Ÿæˆäº†android.iml,android.ipr\nå¯¼å…¥åˆ°AndroidStudio androidstudio é…ç½® é…ç½®jvmé€‰é¡¹ï¼Œæ ¹æ®æœºå™¨å®é™…æƒ…å†µè®¾ç½®vmåˆ†é…çš„å†…å­˜ç­–ç•¥\n-Xmx16g -Xms2g é…ç½® idea å±æ€§\n# å¤§å°å†™æ•æ„Ÿï¼ˆmacOSï¼‰ idea.case.sensitive.fs=true idea.max.intellisense.filesize=100000 å¯¼å…¥é¡¹ç›®åˆ°ASå¹¶é…ç½® é…ç½®sdkä¸»è¦æ˜¯ä¸ºäº†é¿å…æŸ¥çœ‹æˆ–è°ƒè¯•ä»£ç æ—¶ï¼ŒASä»ç„¶å»ä½¿ç”¨SDKä¸­é…ç½®çš„classï¼Œè€Œä¸æ˜¯æˆ‘ä»¬çš„aospä¸­çš„javaæºç ã€‚\nä½¿ç”¨AndroidStudio æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•ä¸‹ android.ipr æ–‡ä»¶å³å¯å¯¼å…¥é¡¹ç›®ï¼›\né…ç½®é¡¹ç›®SDKï¼Œè¿›å…¥é¡¹ç›®è®¾ç½®ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„JDKï¼Œå¹¶åˆ é™¤æ‰€æœ‰ä¾èµ–jaråº“ï¼Œæˆ‘ä»¬è¿™é‡Œå–åä¸ºï¼š1.8 (No Libraries)\né…ç½®é¡¹ç›®SDKï¼Œè¿›å…¥é¡¹ç›®è®¾ç½®ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„SDKï¼Œå¹¶åˆ é™¤æ‰€æœ‰jaråº“ï¼Œå¯¹åº”çš„JDKé€‰æ‹©ä¹‹å‰åˆ›å»ºçš„1.8 (No Libraries)ï¼Œè¿™é‡Œæˆ‘ä»¬å°†SDKå‘½åä¸º Android API 30 Platform-NoLib\nåœ¨Projectè®¾ç½®ä¸­ï¼Œé€‰æ‹©é¡¹ç›®SDKä¸ºä¹‹å‰è®¾ç½®çš„ Android API 30 Platform-NoLib\nè¿›å…¥é¡¹ç›®è®¾ç½®-æ¨¡å—è®¾ç½®ï¼Œå°†æ¨¡å—çš„SDKè®¾ç½®ä¸ºä¹‹å‰è®¾ç½®çš„ Android API 30 Platform-NoLib\né™„åŠ è°ƒè¯•å™¨åˆ° system_process é™„åŠ è°ƒè¯•å™¨åˆ° system_process è¿›ç¨‹ æˆåŠŸåçš„Debuggerç•Œé¢å¦‚ä¸‹æ‰€ç¤º\næ‰“æ–­ç‚¹æµ‹è¯•ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©åœ¨ Binder.java æ–‡ä»¶ä¸­æ·»åŠ æ–­ç‚¹ï¼Œç„¶ååœ¨æ¨¡æ‹Ÿå™¨ä¸­æ‰“å¼€ç›¸æœºAPPä»¥è§¦å‘æ–­ç‚¹é€»è¾‘ã€‚ä¸‹å›¾å°±è¡¨ç¤ºæˆ‘ä»¬åˆ°è¾¾äº†æ–­ç‚¹ï¼Œè¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡ASæ¥è°ƒè¯•è¯¥è¿›ç¨‹äº†ã€‚\næç¤ºï¼šé™„åŠ è°ƒè¯•å™¨æ—¶ï¼Œå¦‚æ‰¾ä¸åˆ°è®¾å¤‡ï¼Œå¯å‚è€ƒç¬¬5å°èŠ‚ä¸­çš„ é”™è¯¯è§£å†³ï¼šDebugä¸­ä¸æ˜¾ç¤ºè®¾å¤‡\nä¿®æ”¹å¹¶æ›´æ–°ç³»ç»Ÿæ¨¡å— åœ¨è°ƒè¯•åˆ†æè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹å…¶ä¸­å†…å®¹ä»¥ååŠ©åˆ†æï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œã€‚\nFramework æ„å»º framework åˆ†ä¸¤å—ï¼š\nJAR éƒ¨åˆ†ä½¿ç”¨å‘½ä»¤ mmm frameworks/base/ èµ„æºéƒ¨åˆ†ï¼š mmm frameworks/base/core/res/ å®‰è£…ï¼š\n# è·å–rootæƒé™ adb root adb disable-verity adb reboot adb remount # ç§»é™¤æ—§çš„framework adb shell cd /system/framework/ rm framework-res.apk exit # æ¨å…¥æ–°çš„framework adb push out/target/product/\u0026lt;device_targeted\u0026gt;/system/framework/framework-res.apk /system/framework/ # é‡å¯æœåŠ¡ adb reboot packagesä¸­app æ„å»º cd ~/aosp source build/envsetup.sh lunch aosp_x86_64-eng # é‡æ–°æ„å»ºå•ä¸ªæ¨¡å— (å¦‚ Dialer) mmm packages/apps/dialer/ # ç”Ÿæˆçš„æ–‡ä»¶ä¼šåœ¨æ§åˆ¶å°ä¸­è¾“å‡ºæ¥ æ›´æ–°åˆ°ç³»ç»Ÿ adb install -r out/target/product/\u0026lt;device_targeted\u0026gt;/system/priv-app/\u0026lt;app_name\u0026gt;/\u0026lt;app_name\u0026gt;.apk adb reboot SystemUI ç¼–è¯‘ cd WORKING_DIRECTORY source build/envsetup.sh # é€‰æ‹©è®¾å¤‡ lunch 31 # é‡æ–°æ„å»ºSystemUI mmm frameworks/base/packages/SystemUI/ å®‰è£…åˆ°ç³»ç»Ÿ adb install -r out/target/product/\u0026lt;device_targeted\u0026gt;/system/priv-app/SystemUI/SystemUI.apk adb reboot ä½¿ç”¨æç¤ºåŠå¸¸è§é”™è¯¯ ä½¿ç”¨æç¤ºï¼šé¡¹ç›®æºç æµè§ˆé…ç½® ç­›é€‰Projectä»£ç èŒƒå›´ ç‚¹å‡»projectçª—å£çš„è®¾ç½®æŒ‰é’®ï¼Œé€‰æ‹© â€œEdit Scopesâ€\næ–°å»ºä¸€ä¸ªè§„åˆ™ï¼Œè¾“å…¥åç§°ï¼Œå¹¶åœ¨Patternä¸­è¾“å…¥è¿‡æ»¤è§„åˆ™ï¼š file[android]:frameworks//*||file[android]:libcore//*\nè¿‡æ»¤VCSé…ç½®ä¸­ä¸å¿…è¦çš„æ¨¡å— æ‰“å¼€VCSé…ç½®ï¼Œç§»é™¤frameworkså’Œlibcoreä¹‹å¤–çš„æ‰€æœ‰å…¶ä»–æ¨¡å—\nä½¿ç”¨æç¤ºï¼šå¯¼å…¥å…¶ä»–æ¨¡å—çš„æºç åˆ°AS ä¸å»ºè®®ç›´æ¥ä¿®æ”¹ android.iml æ–‡ä»¶ï¼Œåº”å½“é€šè¿‡ä¿®æ”¹æºç æ ¹ç›®å½•è‡ªå®šä¹‰çš„ excluded-paths æ–‡ä»¶ä¸­å®šä¹‰çš„è§„åˆ™æ¥åŒ…å«å…¶ä»–æ¨¡å—çš„æºç ã€‚\nä¿®æ”¹æ­¤æ–‡ä»¶åï¼Œé‡æ–°æ‰§è¡Œ development/tools/idegen/idegen.sh æ¥ç”Ÿæˆæœ€æ–°çš„asé¡¹ç›®é…ç½®ã€‚ç”Ÿæˆå®Œæˆåä¸€èˆ¬aså¦‚æœæ˜¯æ‰“å¼€çŠ¶æ€ï¼Œä¼šè‡ªåŠ¨æ›´æ–°ç´¢å¼•ï¼Œå¦‚æœç´¢å¼•æ›´æ–°æœ‰é—®é¢˜ï¼Œå¯å…³é—­é¡¹ç›®ï¼Œç„¶åé‡æ–°æ‰“å¼€ã€‚\né”™è¯¯è§£å†³ï¼šmacOS .DS_Store å¯¼è‡´æ‰“åŒ…é•œåƒå¤±è´¥ ç¼–è¯‘åŸºæœ¬å®Œæˆï¼Œä½†æ˜¯æœ€åæ‰“åŒ…system.imgæ–‡ä»¶æ—¶æŠ¥é”™ï¼ŒæŠ¥é”™å†…å®¹å¦‚ä¸‹ï¼š\nset_selinux_xattr: No such file or directory searching for label \u0026#34;/.DS_Store\u0026#34; e2fsdroid: No such file or directory while configuring the file system 10:00:38 ninja failed with: exit status 1 è§£å†³æ–¹å¼ï¼šåˆ é™¤æºç ç›®å½•ä¸­çš„æ‰€æœ‰ .DS_Storeï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç»Ÿä¸€æ¸…ç†\nfind . -name \u0026#34;.DS_Store\u0026#34; | xargs -I {} rm {} è¯´æ˜ï¼š .DS_Store æ–‡ä»¶ä¸ºmacOSä¸­å­˜å‚¨æ–‡ä»¶å¤¹ç•Œé¢å±•ç¤ºç›¸å…³çš„ä¸€äº›ä¿¡æ¯ï¼Œåœ¨Finderä¸­æŸ¥çœ‹å¯¹åº”ç›®å½•åå¯èƒ½ä¼šç”Ÿæˆ\né”™è¯¯è§£å†³ï¼šé™„åŠ è°ƒè¯•å™¨æ—¶ä¸æ˜¾ç¤ºè®¾å¤‡ åœ¨é™„åŠ è°ƒè¯•å™¨æ—¶ï¼Œå¯èƒ½ä¼šå¦‚ä¸‹å›¾ä¸€æ ·ï¼Œæ¨¡æ‹Ÿå™¨å·²ç»å¯åŠ¨äº†ï¼Œä½†æ˜¯é™„åŠ è°ƒè¯•å™¨çš„çª—å£ä¸­è®¾å¤‡åˆ—è¡¨ä¸­æ²¡æœ‰è®¾å¤‡\næ­¤æ—¶æ£€æŸ¥è‡ªå·±çš„é¡¹ç›®é…ç½®ä¸­çš„SDKæ˜¯å¦é€‰æ‹©äº†AndroidSDKï¼Œè®¾ç½®æˆ Android SDK å³å¯\né”™è¯¯è§£å†³ï¼šæ¨¡æ‹Ÿå™¨æ— æ³•å¯åŠ¨-æŠ¥æ‰¾ä¸åˆ°å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ å½“ä½¿ç”¨ android-11.0.0_r28 ç‰ˆæœ¬æ—¶ï¼Œç¼–è¯‘é€šè¿‡åï¼Œä½¿ç”¨emulatorå¯åŠ¨æ—¶ï¼ŒæŠ¥å‡ºå¦‚ä¸‹é”™è¯¯\nemulator: ERROR: Can\u0026#39;t find \u0026#39;Linux version \u0026#39; string in kernel image file: /Volumes/HIKVISION/google-aosp/out/target/product/generic_x86_64/kernel-ranchu åŸå› æ˜¯emulatorç‰ˆæœ¬è¿‡æ—§ï¼Œéœ€è¦ä½¿ç”¨æ–°çš„emulatorï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è·å–æ–°çš„ç‰ˆæœ¬ï¼š\ncd prebuilts/android-emulator # æŸ¥è¯¢å¯ç”¨åˆ†æ”¯ï¼Œhttps://android.googlesource.com/platform/prebuilts/android-emulator/+refs git fetch aosp android-11.0.0_r33:refs/remotes/m/android-11.0.0_r33 # æ£€å‡ºåˆ†æ”¯ git co -b android-11.0.0_r33 refs/remotes/m/ android-11.0.0_r33 è·å–å®Œæˆåå†æ¬¡æ‰§è¡Œ emulator å‘½ä»¤\nemulator -version # Android emulator version 30.3.0.0 (build_id 6946397) (CL:N/A) emulator # å¯åŠ¨æ¨¡æ‹Ÿå™¨ å‚è€ƒæ–‡ç«  å‚è€ƒï¼š\nä½¿ç”¨ Android Studio é˜…è¯» AOSP æºç  AOSP Source Code in Android Studio (Explore only) Stackoverflow aosp-and-intellij-idea Building Android O with a Mac - Christopher Ney Building Android 11 for PH-1 on Apple Silicon Could not find a supported mac sdk: â€œ10.10â€ â€œ10.11â€ â€œ10.12â€ â€œ10.13â€ åˆ›å»ºåŒºåˆ†å¤§å°å†™çš„ç£ç›˜æ˜ åƒ-source.android.google.cn ","permalink":"https://hanlyjiang.github.io/posts/%E6%90%AD%E5%BB%BAandroid%E6%BA%90%E7%A0%81%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/","summary":"\u003cul\u003e\n\u003cli\u003eç®€å•ä»‹ç»ç³»ç»Ÿæ¶æ„ã€ç¼–è¯‘ç¯å¢ƒçš„æ­å»º\u003c/li\u003e\n\u003cli\u003eç®€å•ä»‹ç»åˆ©ç”¨ AndroidStudio è°ƒè¯• system_process è¿›ç¨‹çš„æ–¹æ³•åŠç¼–è¯‘æ›´æ–°éƒ¨åˆ†ç³»ç»Ÿæ¨¡å—çš„æ–¹å¼\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"androidç³»ç»Ÿæ¶æ„\"\u003eAndroidç³»ç»Ÿæ¶æ„\u003c/h2\u003e\n\u003cp\u003eAndroid ç³»ç»Ÿæ¶æ„å¦‚ä¸‹ä¸¤å›¾æ‰€ç¤ºï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"20210401092831\" loading=\"lazy\" src=\"https://s2.loli.net/2022/05/26/iVWSvDPlA9I4afd.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"20210401092925\" loading=\"lazy\" src=\"https://s2.loli.net/2022/05/26/3KYlCuj5zXc9EUs.png\"\u003e\u003c/p\u003e\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eåº”ç”¨æ¡†æ¶\u003c/strong\u003eã€‚åº”ç”¨æ¡†æ¶æœ€å¸¸è¢«åº”ç”¨å¼€å‘è€…ä½¿ç”¨ã€‚å¾ˆå¤šæ­¤ç±» API éƒ½å¯ä»¥ç›´æ¥æ˜ å°„åˆ°åº•å±‚ HAL æ¥å£ï¼Œå¹¶å¯æä¾›ä¸å®ç°é©±åŠ¨ç¨‹åºç›¸å…³çš„å®ç”¨ä¿¡æ¯ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eBinder IPC\u003c/strong\u003eã€‚Binder è¿›ç¨‹é—´é€šä¿¡ (IPC) æœºåˆ¶å…è®¸åº”ç”¨æ¡†æ¶è·¨è¶Šè¿›ç¨‹è¾¹ç•Œå¹¶è°ƒç”¨ Android ç³»ç»ŸæœåŠ¡ä»£ç ï¼Œè¿™ä½¿å¾—é«˜çº§æ¡†æ¶ API èƒ½ä¸ Android ç³»ç»ŸæœåŠ¡è¿›è¡Œäº¤äº’ã€‚åœ¨åº”ç”¨æ¡†æ¶çº§åˆ«ï¼Œå¼€å‘è€…æ— æ³•çœ‹åˆ°æ­¤ç±»é€šä¿¡çš„è¿‡ç¨‹ï¼Œä½†ä¸€åˆ‡ä¼¼ä¹éƒ½åœ¨â€œæŒ‰éƒ¨å°±ç­åœ°è¿è¡Œâ€ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç³»ç»ŸæœåŠ¡\u003c/strong\u003eã€‚ç³»ç»ŸæœåŠ¡æ˜¯ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½çš„æ¨¡å—åŒ–ç»„ä»¶ï¼Œä¾‹å¦‚çª—å£ç®¡ç†å™¨ã€æœç´¢æœåŠ¡æˆ–é€šçŸ¥ç®¡ç†å™¨ã€‚åº”ç”¨æ¡†æ¶ API æ‰€æä¾›çš„åŠŸèƒ½å¯ä¸ç³»ç»ŸæœåŠ¡é€šä¿¡ï¼Œä»¥è®¿é—®åº•å±‚ç¡¬ä»¶ã€‚Android åŒ…å«ä¸¤ç»„æœåŠ¡ï¼šâ€œç³»ç»Ÿâ€ï¼ˆè¯¸å¦‚çª—å£ç®¡ç†å™¨å’Œé€šçŸ¥ç®¡ç†å™¨ä¹‹ç±»çš„æœåŠ¡ï¼‰å’Œâ€œåª’ä½“â€ï¼ˆä¸æ’­æ”¾å’Œå½•åˆ¶åª’ä½“ç›¸å…³çš„æœåŠ¡ï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç¡¬ä»¶æŠ½è±¡å±‚ (HAL)\u003c/strong\u003eã€‚HAL å¯å®šä¹‰ä¸€ä¸ªæ ‡å‡†æ¥å£ä»¥ä¾›ç¡¬ä»¶ä¾›åº”å•†å®ç°ï¼Œè¿™å¯è®© Android å¿½ç•¥è¾ƒä½çº§åˆ«çš„é©±åŠ¨ç¨‹åºå®ç°ã€‚å€ŸåŠ© HALï¼Œç¡¬ä»¶å¼€å‘è€…å¯ä»¥é¡ºåˆ©å®ç°ç›¸å…³åŠŸèƒ½ï¼Œè€Œä¸ä¼šå½±å“æˆ–æ›´æ”¹æ›´é«˜çº§åˆ«çš„ç³»ç»Ÿã€‚HAL å®ç°ä¼šè¢«å°è£…æˆæ¨¡å—ï¼Œå¹¶ä¼šç”± Android ç³»ç»Ÿé€‚æ—¶åœ°åŠ è½½ã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…\u003ca href=\"https://source.android.google.cn/devices/architecture/hal?hl=zh-cn\"\u003eç¡¬ä»¶æŠ½è±¡å±‚ (HAL)\u003c/a\u003eã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eLinux å†…æ ¸\u003c/strong\u003eã€‚å¼€å‘è®¾å¤‡é©±åŠ¨ç¨‹åºä¸å¼€å‘å…¸å‹çš„ Linux è®¾å¤‡é©±åŠ¨ç¨‹åºç±»ä¼¼ã€‚Android ä½¿ç”¨çš„ Linux å†…æ ¸ç‰ˆæœ¬åŒ…å«ä¸€äº›ç‰¹æ®Šçš„è¡¥å……åŠŸèƒ½ï¼Œä¾‹å¦‚ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹ï¼ˆä¸€ä¸ªå†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œå¯æ›´ä¸»åŠ¨åœ°ä¿ç•™å†…å­˜ï¼‰ã€å”¤é†’é”å®šï¼ˆä¸€ç§ \u003ca href=\"https://developer.android.google.cn/reference/android/os/PowerManager.html?hl=zh-cn\"\u003e\u003ccode\u003ePowerManager\u003c/code\u003e\u003c/a\u003e ç³»ç»ŸæœåŠ¡ï¼‰ã€Binder IPC é©±åŠ¨ç¨‹åºï¼Œä»¥åŠå¯¹ç§»åŠ¨åµŒå…¥å¼å¹³å°æ¥è¯´éå¸¸é‡è¦çš„å…¶ä»–åŠŸèƒ½ã€‚è¿™äº›è¡¥å……åŠŸèƒ½ä¸»è¦ç”¨äºå¢å¼ºç³»ç»ŸåŠŸèƒ½ï¼Œä¸ä¼šå½±å“é©±åŠ¨ç¨‹åºå¼€å‘ã€‚å¯ä»¥ä½¿ç”¨ä»»æ„ç‰ˆæœ¬çš„å†…æ ¸ï¼Œåªè¦å®ƒæ”¯æŒæ‰€éœ€åŠŸèƒ½ï¼ˆå¦‚ Binder é©±åŠ¨ç¨‹åºï¼‰å³å¯ã€‚ä¸è¿‡å»ºè®®ä½¿ç”¨ Android å†…æ ¸çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…\u003ca href=\"https://source.android.google.cn/setup/building-kernels?hl=zh-cn\"\u003eæ„å»ºå†…æ ¸\u003c/a\u003eä¸€æ–‡ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003eä»¥ä¸Šéƒ¨åˆ†å†…å®¹æ¥æºï¼š \u003ca href=\"https://source.android.google.cn/devices/architecture?hl=zh-cn\"\u003ehttps://source.android.google.cn/devices/architecture?hl=zh-cn\u003c/a\u003e\u003c/p\u003e","title":"æ­å»ºAndroidæºç å·¥ä½œç¯å¢ƒ"},{"content":"ä»…è®°å½•ä½¿ç”¨Grideaè¿‡ç¨‹ä¸­è§£å†³çš„é—®é¢˜åŠè§£å†³æ–¹å¼\nä¸‹è½½å®‰è£…å¹¶ä½¿ç”¨ è®¿é—®è¿™é‡Œï¼ˆhttps://gridea.dev/ï¼‰ä¸‹è½½å®‰è£…å¹¶ä½¿ç”¨ï¼Œä¸èµ˜è¿°ã€‚\nè¿œç¨‹åŒæ­¥githubé…ç½® å…³äºå»ºç«‹ä»“åº“ï¼Œè·å–tokenï¼Œé…ç½®pagesèµ˜è¿°ï¼Œä»…è®°å½•é¢å¤–çš„é…ç½®ã€‚\nåœ¨Grideaçš„å·¥ä½œç›®å½•çš„æ ¹ç›®å½•ä¸­æ–°å»ºä¸€ä¸ª .gitignore æ–‡ä»¶ï¼Œè¾“å…¥å¦‚ä¸‹å†…å®¹ï¼š\n.DS_Store */.DS_Store # è‡ªå·±çš„æœ¬åœ°è‰ç¨¿ typora è¿œç¨‹åŒæ­¥æ—¶ï¼Œä¼šå°†æ­¤æ–‡ä»¶æ”¾å…¥åˆ°outputç›®å½•ä¸‹ï¼Œç„¶åå°†outputç›®å½•æ¨é€åˆ°githubä¸Šï¼Œä¸ºäº†é¿å…å°†å…¶ä¸­çš„æŸäº›æ–‡ä»¶æ¨å…¥åˆ°è¿œç¨‹ä»“åº“ï¼Œæ•…å¯ä»¥é€šè¿‡æ­¤æ–¹å¼å®šä¹‰gitignore\n","permalink":"https://hanlyjiang.github.io/posts/gridea%E4%BD%BF%E7%94%A8%E5%B0%8F%E8%AE%B0/","summary":"\u003cp\u003eä»…è®°å½•ä½¿ç”¨Grideaè¿‡ç¨‹ä¸­è§£å†³çš„é—®é¢˜åŠè§£å†³æ–¹å¼\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"ä¸‹è½½å®‰è£…å¹¶ä½¿ç”¨\"\u003eä¸‹è½½å®‰è£…å¹¶ä½¿ç”¨\u003c/h2\u003e\n\u003cp\u003eè®¿é—®è¿™é‡Œï¼ˆhttps://gridea.dev/ï¼‰ä¸‹è½½å®‰è£…å¹¶ä½¿ç”¨ï¼Œä¸èµ˜è¿°ã€‚\u003c/p\u003e\n\u003ch2 id=\"è¿œç¨‹åŒæ­¥githubé…ç½®\"\u003eè¿œç¨‹åŒæ­¥githubé…ç½®\u003c/h2\u003e\n\u003cp\u003eå…³äºå»ºç«‹ä»“åº“ï¼Œè·å–tokenï¼Œé…ç½®pagesèµ˜è¿°ï¼Œä»…è®°å½•é¢å¤–çš„é…ç½®ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨Grideaçš„å·¥ä½œç›®å½•çš„æ ¹ç›®å½•ä¸­æ–°å»ºä¸€ä¸ª \u003ccode\u003e.gitignore\u003c/code\u003e æ–‡ä»¶ï¼Œè¾“å…¥å¦‚ä¸‹å†…å®¹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-txt\" data-lang=\"txt\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e.DS_Store\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e*/.DS_Store\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e# è‡ªå·±çš„æœ¬åœ°è‰ç¨¿\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etypora\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003eè¿œç¨‹åŒæ­¥æ—¶ï¼Œä¼šå°†æ­¤æ–‡ä»¶æ”¾å…¥åˆ°outputç›®å½•ä¸‹ï¼Œç„¶åå°†outputç›®å½•æ¨é€åˆ°githubä¸Šï¼Œä¸ºäº†é¿å…å°†å…¶ä¸­çš„æŸäº›æ–‡ä»¶æ¨å…¥åˆ°è¿œç¨‹ä»“åº“ï¼Œæ•…å¯ä»¥é€šè¿‡æ­¤æ–¹å¼å®šä¹‰gitignore\u003c/p\u003e","title":"Grideaä½¿ç”¨å°è®°"},{"content":"ç¿»è¯‘å›½å¤–æ–‡ç« ï¼Œè¯¥æ–‡ç« ä»‹ç»äº†Androidå¼€å‘ä¸­çŸ©é˜µç›¸å…³çš„æ•°å­¦çŸ¥è¯†ï¼ŒåŒ…æ‹¬çŸ©é˜µæ˜¯ä»€ä¹ˆï¼ŸçŸ©é˜µåŠ æ³•åŠä¹˜æ³•è¿ç®—ï¼Œ2x2çŸ©é˜µçš„å˜æ¢ï¼Œæœ€åæ¼”è¿›ä¸ºAndroidä¸­ä½¿ç”¨çš„3x3çŸ©é˜µã€‚æ–‡ä¸­å›¾ç‰‡åŠåŠ¨å›¾æ¯”è¾ƒå¤šï¼Œç›¸å¯¹å¥½æ‡‚ã€‚\nåŸæ–‡é“¾æ¥ï¼šhttps://i-rant.arnaudbos.com/matrices-for-developers/#technical-challenge\nå‡ å‘¨å‰ï¼Œæˆ‘åœ¨ä¸€ä¸ªandroid-user-groupé¢‘é“ä¸Šï¼Œæœ‰äººé—®ä¸€ä¸ªå…³äºAndroidçš„Matrix.postScaleï¼ˆsxï¼Œsyï¼Œpxï¼Œpyï¼‰æ–¹æ³•åŠå…¶å·¥ä½œåŸç†çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒâ€œéš¾ä»¥æŒæ¡â€ã€‚\nåœ¨2016å¹´åˆï¼Œæˆ‘åœ¨ä¸€ä¸ªAndroidåº”ç”¨ç¨‹åºä¸Šå®Œæˆäº†ä¸€ä¸ªè‡ªç”±é¡¹ç›®ï¼Œåœ¨å…¶ä¸­æˆ‘å¿…é¡»å®ç°ä¸€ä¸ªä»¤äººå…´å¥‹çš„åŠŸèƒ½ï¼š\nç”¨æˆ·åœ¨è´­ä¹°å¹¶ä¸‹è½½äº†å²©å£çš„æ•°å­—åœ°å½¢åï¼Œå¿…é¡»èƒ½å¤ŸæŸ¥çœ‹ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆçš„å²©å£ï¼š\næ‚¬å´–çš„ç…§ç‰‡ï¼Œ åŒ…å«çˆ¬å¡è·¯çº¿å åŠ å±‚çš„SVGæ–‡ä»¶ã€‚ ç”¨æˆ·å¿…é¡»å…·æœ‰éšæ„å¹³ç§»å’Œç¼©æ”¾çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å¿…é¡»å…·æœ‰â€œè·Ÿéšâ€å›¾ç‰‡çš„è·¯çº¿å±‚ã€‚\nAPPæˆªå›¾1 APPæˆªå›¾2 APPæˆªå›¾3 æŠ€æœ¯æŒ‘æˆ˜ ä¸ºäº†è®©æ”€çˆ¬è·¯çº¿çš„å›¾å±‚èƒ½å¤Ÿè·Ÿéšç”¨æˆ·çš„æ‰‹åŠ¿æ“ä½œï¼Œæˆ‘å‘ç°æˆ‘ä¸å¾—ä¸é‡è½½Android ImageViewï¼Œåœ¨Canvasä¸Šç»˜åˆ¶å¹¶å¤„ç†æ‰‹æŒ‡æ‰‹åŠ¿ã€‚ ä½œä¸ºä¸€åä¼˜ç§€çš„å·¥ç¨‹å¸ˆï¼šæˆ‘æœç´¢äº†Stack OverflowğŸ˜… æˆ‘å‘ç°éœ€è¦android.graphics.Matrixç±»è¿›è¡Œ2Dè½¬æ¢ã€‚\nè¿™ä¸ªç±»çš„é—®é¢˜åœ¨äºï¼Œä»æ–¹æ³•åç§°æ¥è¯´ï¼Œä½ èƒ½å¾ˆæ¸…æ¥šçš„äº†è§£å®ƒçš„ä½œç”¨ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æ²¡æœ‰ä¸€å®šçš„æ•°å­¦èƒŒæ™¯çŸ¥è¯†ï¼Œä½ å¾ˆéš¾äº†è§£å®ƒèƒŒåæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæ¯”æ–¹è¯´ä¸‹é¢æ˜¯matrixçš„æŸä¸ªæ–¹æ³•çš„APIæ–‡æ¡£è¯´æ˜ï¼š\nboolean postScale (float sx, float sy, float px, float py)\nPostconcats the matrix with the specified scale. Mâ€™ = S(sx, sy, px, py) * M\nä»æ–‡æ¡£çœ‹èµ·å®ƒå¯ä»¥é€šè¿‡æŸäº›å‚æ•°ç¼©æ”¾æŸäº›ä¸œè¥¿ï¼Œå¹¶é€šè¿‡æŸç§ä¹˜æ³•æ¥å®Œæˆå®ƒã€‚ä¸è¿‡æˆ‘è¿˜æ˜¯æœ‰å¾ˆå¤šç–‘é—®ï¼š\nå®ƒåˆ°åº•æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ ç¼©æ”¾çŸ©é˜µï¼Ÿ é‚£æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæˆ‘æƒ³ç¼©æ”¾ç”»å¸ƒâ€¦ æˆ‘åº”è¯¥ä½¿ç”¨preScaleè¿˜æ˜¯postScaleï¼Ÿ å½“æˆ‘ä»ä»æ‰‹åŠ¿æ£€æµ‹ä»£ç è·å–è¾“å…¥å‚æ•°ï¼Œç„¶åè¿›å…¥å°è¯•å’Œé”™è¯¯çš„æ— é™å¾ªç¯æ—¶ï¼Œæ˜¯å¦éœ€è¦å°è¯•åŒæ—¶ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Ÿ å› æ­¤ï¼Œåœ¨å¼€å‘è¿‡ç¨‹çš„è¿™ä¸€åˆ»ï¼Œæˆ‘æ„è¯†åˆ°åœ¨å®Œæˆå¤§å­¦çš„å¤´ä¸¤å¹´åï¼Œæˆ‘éœ€è¦é‡æ–°å­¦ä¹ å¾ˆå¤šå¹´å‰å…³äºçŸ©é˜µçš„åŸºæœ¬æ•°å­¦æŠ€èƒ½ã€‚\nåœ¨æœå¯»ç½‘ç»œèµ„æ–™æ—¶ï¼Œæˆ‘å‘ç°äº†å¾ˆå¤šä¸é”™çš„èµ„æºï¼Œå¹¶ä¸”èƒ½å¤Ÿå†æ¬¡å­¦ä¹ ä¸€äº›æ•°å­¦çŸ¥è¯†ã€‚ é€šè¿‡å°†æˆ‘çš„ç†è§£åº”ç”¨åˆ°Javaå’ŒAndroidä¸­çš„ä»£ç ï¼Œå®ƒè¿˜å¸®åŠ©æˆ‘è§£å†³äº†2Dè½¬æ¢é—®é¢˜ã€‚ å› æ­¤ï¼Œè€ƒè™‘åˆ°æˆ‘åœ¨ä¸Šé¢æåˆ°çš„é¢‘é“ä¸Šè¿›è¡Œçš„è®¨è®ºï¼Œä¼¼ä¹æˆ‘ä¸æ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨çŸ©é˜µä¸­è‹¦è‹¦æŒ£æ‰çš„äººï¼Œè¯•å›¾å¼„æ˜ç™½è¿™ä¸€ç‚¹ï¼Œå¹¶åœ¨Androidçš„Matrixç±»å’Œæ–¹æ³•ä¸­ä½¿ç”¨è¿™äº›æŠ€èƒ½ï¼Œæ‰€ä»¥æˆ‘æƒ³æˆ‘ä¼šå†™ä¸€ç¯‡æ–‡ç« ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯å…³äºçŸ©é˜µçš„ï¼Œç¬¬äºŒéƒ¨åˆ†â€œä½¿ç”¨Androidå’ŒJavaè¿›è¡Œ2Dè½¬æ¢â€æ˜¯å…³äºå¦‚ä½•åœ¨Javaå’ŒAndroidä¸Šå°†å…³äºçŸ©é˜µçš„çŸ¥è¯†åº”ç”¨åˆ°ä»£ç ä¸­ã€‚\nMatrixæ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘åœ¨å¯æ±—å­¦é™¢ï¼ˆKhan Academyï¼‰ä¸Šå‘ç°ä¸€é—¨å…³äºçŸ©é˜µçš„å¾ˆå¥½çš„ä»£æ•°è¯¾ç¨‹ã€‚\nå¦‚æœä½ ä¹Ÿé‡åˆ°æ­¤ç±»é—®é¢˜ï¼Œæˆ‘è§‰å¾—ä½ ä¹Ÿå¯ä»¥èŠ±æ—¶é—´æ¥å­¦ä¹ è¿™ä¸ªè¯¾ç¨‹ï¼Œç­‰åˆ°ä½ è§‰å¾—â€œåŸæ¥å°±æ˜¯è¿™æ ·â€ï¼Œå°±å·®ä¸å¤šäº†ã€‚å®é™…ä¸Šå­¦ä¹ è¿™äº›è¯¾ç¨‹åªéœ€å‡ ä¸ªå°æ—¶çš„æŠ•èµ„ï¼Œè€Œä¸”è¯¾ç¨‹æ˜¯å…è´¹çš„ï¼Œä½ ä¸€å®šä¸ä¼šåæ‚”ã€‚\nçŸ©é˜µæ“…é•¿è¡¨ç¤ºæ•°æ®ï¼Œæ‰€ä»¥å¯¹çŸ©é˜µçš„æ“ä½œå¯ä»¥å¸®åŠ©æ‚¨è§£å†³æ­¤æ•°æ®ä¸Šçš„é—®é¢˜ã€‚è¿˜è®°å¾—åœ¨å­¦æ ¡å¿…é¡»è§£çº¿æ€§æ–¹ç¨‹ç»„å—ï¼Ÿ\nè§£çº¿æ€§æ–¹ç¨‹ç»„æœ€å¸¸è§æ–¹æ³•ï¼ˆè‡³å°‘æ˜¯æˆ‘ç ”ç©¶è¿‡çš„ä¸¤ç§æ–¹æ³•ï¼‰æ˜¯æ¶ˆå…ƒæ³•æˆ–è¡Œå‡å°‘æ–¹æ³•ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨çŸ©é˜µæ¥è¿›è¡Œçº¿æ€§æ–¹ç¨‹ç»„çš„æ±‚è§£ã€‚\nçŸ©é˜µåœ¨æ¯ä¸ªç§‘å­¦åˆ†æ”¯ä¸­éƒ½å¤§é‡ä½¿ç”¨ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥ç”¨äºçº¿æ€§å˜æ¢æ¥æè¿°ç‚¹åœ¨ç©ºé—´ä¸­çš„ä½ç½®ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­ç®€è¦ç ”ç©¶çš„ã€‚\nè§£åˆ¨ ç®€å•æ¥è¯´ï¼ŒçŸ©é˜µæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œå®é™…ä¸Šï¼Œä¸€ä¸ª $m\\ \\times n$ çš„çŸ©é˜µå¯ä»¥å¯¹åº”äºä¸€ä¸ªé•¿åº¦ä¸º $m$ çš„æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸ªitemæ˜¯å¦å¤–ä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„æ•°ç»„ã€‚ é€šå¸¸æ¥è¯´ $m$ ä»£è¡¨äº†è¡Œæ•°ï¼Œ$n$ ä»£è¡¨åˆ—æ•°ï¼Œmatrixä¸­çš„æ¯ä¸ªå…ƒç´ ç§°ä¹‹ä¸º æ¡ç›®-$entry$ .\nçŸ©é˜µä½¿ç”¨ä¸€ä¸ªç²—ä½“å¤§å†™å­—æ¯è¡¨ç¤ºï¼Œæ¯ä¸ª $entry$ ä½¿ç”¨å¯¹åº”çš„å°å†™å­—æ¯è¡¨ç¤ºï¼ŒåŒæ—¶ä½¿ç”¨è¡Œå·å’Œåˆ—å·ç»„åˆæˆä¸ºä¸‹æ ‡ï¼Œä¸€ä¸ªçŸ©é˜µçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š $$ \\textbf{A} = \\begin{pmatrix} a_{11} \u0026amp; a_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n} \\ a_{21} \u0026amp; a_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n} \\ â‹® \u0026amp; â‹® \u0026amp; â‹± \u0026amp; â‹® \\ a_{m1} \u0026amp; a_{m2} \u0026amp; \u0026hellip; \u0026amp; a_{mn} \\ \\end{pmatrix} $$\næ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ çŸ©é˜µçš„ä¸€äº›è¿ç®—ï¼šåŠ æ³•å’Œå‡æ³•å’Œä¹˜æ³•ï¼ˆmultiplicationï¼‰ã€‚\nåŠ æ³•å’Œå‡æ³• çŸ©é˜µçš„åŠ æ³•å’Œå‡æ³•æ˜¯é€šè¿‡çŸ©é˜µçš„ç›¸åº”çš„entryç›¸åŠ æˆ–ç›¸å‡æ¥å®Œæˆçš„ï¼Œè®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š $$ \\textbf{A} + \\textbf{B} = \\begin{pmatrix} a_{11} \u0026amp; a_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n} \\ a_{21} \u0026amp; a_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n} \\ â‹® \u0026amp; â‹® \u0026amp; â‹± \u0026amp; â‹® \\ a_{m1} \u0026amp; a_{m2} \u0026amp; \u0026hellip; \u0026amp; a_{mn} \\ \\end{pmatrix} + \\begin{pmatrix} b_{11} \u0026amp; b_{12} \u0026amp; \u0026hellip; \u0026amp; b_{1n} \\ b_{21} \u0026amp; b_{12} \u0026amp; \u0026hellip; \u0026amp; b_{1n} \\ â‹® \u0026amp; â‹® \u0026amp; â‹± \u0026amp; â‹® \\ b_{m1} \u0026amp; b_{m2} \u0026amp; \u0026hellip; \u0026amp; b_{mn} \\ \\end{pmatrix}= \\begin{pmatrix} a_{11} + b_{11} \u0026amp; a_{12}+b_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n}+b_{1n} \\ a_{21}+b_{21} \u0026amp; a_{12}+b_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n}+b_{1n} \\ â‹® \u0026amp;\tâ‹® \u0026amp; â‹± \u0026amp; â‹® \\ a_{m1}+b_{m1} \u0026amp; a_{m2}+b_{m2} \u0026amp; \u0026hellip; \u0026amp; a_{mn}+b_{mn} \\ \\end{pmatrix} $$ ä»ä¸Šé¢çš„è®¡ç®—æ–¹å¼å¯ä»¥ç¡®å®šï¼ŒçŸ©é˜µçš„åŠ æ³•å’Œå‡æ³•åªèƒ½æ˜¯ä¸¤ä¸ªå…·æœ‰ç›¸åŒç»´åº¦ï¼ˆ$m \\times n$ï¼‰çš„çŸ©é˜µä¹‹é—´è¿›è¡Œï¼›\nåŠ æ³•ç¤ºä¾‹ï¼š $$ \\textbf{A} + \\textbf{B} = \\begin{pmatrix} 4 \u0026amp; -8 \u0026amp; 7 \\ 0 \u0026amp; 2 \u0026amp; 3 \\ 15 \u0026amp; 4 \u0026amp; 9 \\ \\end{pmatrix} + \\begin{pmatrix} -5 \u0026amp; 2 \u0026amp; 3 \\ 4 \u0026amp; -1 \u0026amp; 6 \\ 0 \u0026amp; 12 \u0026amp; 3 \\ \\end{pmatrix}= \\begin{pmatrix} 4+(-5) \u0026amp; (-8)+2 \u0026amp; 7+3 \\ 0+4 \u0026amp; 2+(-1) \u0026amp; (-1)+6 \\ 15+0 \u0026amp; 4+12 \u0026amp; 9+3 \\ \\end{pmatrix}= \\begin{pmatrix} -1 \u0026amp; -6 \u0026amp; 10 \\ 4 \u0026amp; 1 \u0026amp; -5 \\ 15 \u0026amp; 16 \u0026amp; 12 \\ \\end{pmatrix} $$\nå‡æ³•ç¤ºä¾‹ï¼š $$ \\textbf{A} + \\textbf{B} = \\begin{pmatrix} 4 \u0026amp; -8 \u0026amp; 7 \\ 0 \u0026amp; 2 \u0026amp; 3 \\ 15 \u0026amp; 4 \u0026amp; 9 \\ \\end{pmatrix}+ \\begin{pmatrix} -5 \u0026amp; 2 \u0026amp; 3 \\ 4 \u0026amp; -1 \u0026amp; 6 \\ 0 \u0026amp; 12 \u0026amp; 3 \\ \\end{pmatrix}= \\begin{pmatrix} 4-(-5) \u0026amp; (-8)-2 \u0026amp; 7-3 \\ 0-4 \u0026amp; 2-(-1) \u0026amp; (-1)-6 \\ 15-0 \u0026amp; 4-12 \u0026amp; 9-3 \\ \\end{pmatrix}= \\begin{pmatrix} 9 \u0026amp; -10 \u0026amp; 4 \\ -4 \u0026amp; 3 \u0026amp; -7 \\ 15 \u0026amp; -8 \u0026amp; 6 \\ \\end{pmatrix} $$\nçŸ©é˜µä¹˜æ³• ä¸Šæ•°å­¦è¯¾çš„æ—¶å€™ï¼Œè€å¸ˆè¯´è¿‡ï¼šâ€œä½ ä¸èƒ½åœ¨æ©˜å­é‡ŒåŠ è‹¹æœï¼Œè¿™æ˜¯æ²¡æœ‰é“ç†çš„â€ï¼Œç„¶åå‘Šè¯‰æˆ‘ä»¬å•ä½åœ¨è¿ç®—ä¸­çš„é‡è¦æ€§ï¼Œä¹Ÿå°±æ˜¯ä¸åŒå•ä½çš„æ“ä½œæ•°ä¸èƒ½è¿›è¡Œè¿ç®—ã€‚\nä½†æ˜¯ï¼Œå¯¹äºçŸ©é˜µæ¥è¯´ï¼Œè‹¹æœå’Œæ©™å­ç›¸ä¹˜æ˜¯åˆæ³•çš„ï¼Œæˆ‘ä»¬åªèƒ½å°†çŸ©é˜µåŠ åˆ°ç›¸åŒç»´åº¦çš„çŸ©é˜µä¸Šï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†çŸ©é˜µä¸æ•°å­—å’Œå…¶ä»–ç»´åº¦ä¸åŒçš„çŸ©é˜µç›¸ä¹˜ã€‚\næ ‡é‡ $\\times$ çŸ©é˜µ åœ¨çŸ©é˜µçš„ä¹˜æ³•ä¸­ï¼Œå•ä¸€çš„æ•°å­—å®é™…ä¸Šåº”è¯¥ç§°ä¹‹ä¸ºæ ‡é‡ï¼ˆ$\\textbf{scalar}$ï¼‰ï¼Œä¸‹é¢çš„è¿ç®—ä¸­ï¼Œå®é™…ä¸Šä¸æ˜¯å°†çŸ©é˜µä¹˜ä»¥æ•°å­—ï¼Œè€Œæ˜¯å°†çŸ©é˜µä¹˜ä»¥æ ‡é‡ã€‚çŸ©é˜µä¹˜ä»¥æ ‡é‡çš„è®¡ç®—æ–¹å¼æ˜¯ï¼šå°†çŸ©é˜µä¸­çš„æ¯ä¸ªæ¡ç›®ä¹˜ä»¥æ ‡é‡ï¼Œç„¶åå¾—åˆ°å¦å¤–ä¸€ä¸ªçŸ©é˜µã€‚ $$ \\textit{k} . \\textbf{A} =\n\\textit{k} . \\begin{pmatrix} a_{11} \u0026amp; a_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n} \\ a_{21} \u0026amp; a_{12} \u0026amp; \u0026hellip; \u0026amp; a_{1n} \\ â‹® \u0026amp; â‹® \u0026amp; â‹± \u0026amp; â‹® \\ a_{m1} \u0026amp; a_{m2} \u0026amp; \u0026hellip; \u0026amp; a_{mn} \\ \\end{pmatrix}= \\begin{pmatrix} \\textit{k} . a_{11} \u0026amp; \\textit{k} . a_{12} \u0026amp; \u0026hellip; \u0026amp; \\textit{k} . a_{1n} \\ \\textit{k} .a_{21} \u0026amp; \\textit{k} . a_{12} \u0026amp; \u0026hellip; \u0026amp; \\textit{k} . a_{1n} \\ â‹® \u0026amp;\tâ‹® \u0026amp; â‹± \u0026amp; â‹® \\ \\textit{k} .a_{m1} \u0026amp; \\textit{k} . a_{m2} \u0026amp; \u0026hellip; \u0026amp; \\textit{k} . a_{mn} \\ \\end{pmatrix} $$ ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š $$ 4 . \\begin{pmatrix} 0 \u0026amp; 3 \u0026amp; 12 \\ 7 \u0026amp; -5 \u0026amp; 1 \\ -8 \u0026amp; 2 \u0026amp; 0 \\ \\end{pmatrix} =\n\\begin{pmatrix} 0 \u0026amp; 12 \u0026amp; 48 \\ 28 \u0026amp; -20 \u0026amp; 4 \\ -32 \u0026amp; 8 \u0026amp; 0 \\ \\end{pmatrix} $$\nçŸ©é˜µ $\\times$ çŸ©é˜µ å¦å¤–ä¸€ç§çŸ©é˜µä¹˜æ³•å°±æ˜¯ çŸ©é˜µä¹˜ä»¥çŸ©é˜µ ï¼ŒçŸ©é˜µä¹˜æ³•è¿ç®—èµ·æ¥ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶ä¸èƒ½ç®€å•çš„å¯¹åº”çš„entryè¿›è¡Œä¹˜æ³•è¿ç®—ï¼Œå…·ä½“è®¡ç®—è§„åˆ™æˆ‘ä»¬ç›´æ¥çœ‹ç»´åŸºç™¾ç§‘çš„è¯´æ˜ï¼š\nå¦‚æœ $\\mathbf{A}$ æ˜¯ä¸€ä¸ª $m \\times n$ çš„ çŸ©é˜µï¼Œ$\\mathbf{B}$ æ˜¯ä¸€ä¸ª $n \\times p$ çš„matrix, é‚£ä¹ˆå®ƒä»¬çš„çŸ©é˜µä¹˜ç§¯ $\\mathbf{AB}$ æ˜¯ä¸€ä¸ª $m \\times p $çš„çŸ©é˜µ,\nå…¶ä¸­çŸ©é˜µ $\\mathbf{A}$ è¡Œä¸­çš„ $n$ ä¸ªæ¡ç›®ä¸çŸ©é˜µ $\\mathbf{B}$ åˆ—ä¸­çš„ $n$ ä¸ªæ¡ç›® ç›¸ä¹˜å¹¶æ±‚å’Œ å¾—å‡ºçŸ©é˜µ $\\mathbf{AB}$ çš„æ¡ç›®ã€‚\nçœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œè®©æˆ‘ä»¬é€æ®µåˆ†è§£çš„æ¥çœ‹ï¼š\nå¦‚æœ $\\mathbf{A}$ æ˜¯ä¸€ä¸ª $m \\times n$ çš„ çŸ©é˜µï¼Œ$\\mathbf{B}$ æ˜¯ä¸€ä¸ª $n \\times p$ çš„matrix, é‚£ä¹ˆå®ƒä»¬çš„çŸ©é˜µä¹˜ç§¯ $\\mathbf{AB}$ æ˜¯ä¸€ä¸ª $m \\times p$ çš„çŸ©é˜µ\nä¸Šé¢çš„è§„åˆ™æˆ‘ä»¬å¯ä»¥å†™æˆï¼š $\\mathbf{A}{m \\times n} \\times \\mathbf{B}{n \\times p} = \\mathbf{AB}_{m \\times p}$\nçœ‹ä¸€ä¸ªç®€å•çš„çŸ©é˜µ $\\mathbf{A}{2 \\times 3} = \\begin{pmatrix} a{11} \u0026amp; a_{12} \u0026amp; a_{13} \\ a_{21}\u0026amp;a_{22}\u0026amp;a_{23} \\end{pmatrix}$ å’Œå¦å¤–ä¸€ä¸ªçŸ©é˜µ $\\mathbf{B}{3 \\times 1} = \\begin{pmatrix} b{11} \\ b_{21} \\ b_{31} \\end{pmatrix}$ ï¼Œè¿™é‡Œ$m = 2, n=3, p=1$ï¼Œæ‰€ä»¥çŸ©é˜µä¹˜ç§¯ä¸ºä¸€ä¸ª$2\\times1$çš„çŸ©é˜µï¼š $\\mathbf{AB}=\\begin{pmatrix} ab_{11} \\ ab_{12} \\end{pmatrix}$ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬åˆ†è§£ç¬¬äºŒéƒ¨åˆ†ï¼š\n==çŸ©é˜µ $\\mathbf{A}$ è¡Œä¸­çš„ $n$ ä¸ªæ¡ç›®== æŒ‡çš„æ˜¯ï¼šçŸ©é˜µ $\\mathbf{A}$ çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ª $n=3$ çš„æ•°ç»„ï¼Œç¬¬ä¸€è¡Œæˆ‘ä»¬å¯ä»¥è®°ä¸º $a_{11}, a_{12} , a_{13}$ ==çŸ©é˜µ $\\mathbf{B}$ åˆ—ä¸­çš„ $n$ ä¸ªæ¡ç›®== æŒ‡çš„æ˜¯ï¼šçŸ©é˜µ $\\mathbf{B}$ ä¸­çš„æ¯ä¸€åˆ—ä¹Ÿæ˜¯ä¸€ä¸ª $n=3$ çš„æ•°ç»„ï¼Œç¬¬ä¸€åˆ—å¯ä»¥è®°ä¸ºï¼š $b_{11}, b_{12} , b_{13}$ ==ç›¸ä¹˜== æŒ‡ï¼š $\\mathbf{A}$ çš„è¡Œä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½ä¸ $\\mathbf{B}$ çš„åˆ—ä¸­çš„æ¯ä¸ªå¯¹åº”æ¡ç›®ä¸€ä¸€ç›¸ä¹˜ï¼ˆç¬¬ä¸€ä¸ªæ¡ç›®å¯¹åº”ç¬¬ä¸€ä¸ªï¼Œç¬¬äºŒå¯¹ç¬¬äºŒï¼Œä¾æ¬¡ï¼‰ï¼Œç»“æœå°±æ˜¯ï¼š$a_{11} \\times b_{11}, a_{12} \\times b_{12} \\ å’Œ \\ a_{13} \\times b_{13}$ ==æ±‚å’Œ== æŒ‡ï¼šç´¯åŠ è¿™äº›å¯¹åº”çš„è¡Œå’Œåˆ—æ¡ç›®çš„ä¹˜ç§¯ï¼Œå¾—åˆ°æ–°çš„çŸ©é˜µåœ¨è¯¥è¡Œå·å’Œåˆ—å·å¤„çš„æ–°çš„æ¡ç›®ï¼Œæ–°çš„æ¡ç›®çš„å€¼ä¸ºï¼š$a_ {11} \\times b_ {11} + a_ {12} \\times b_ {21} + a_{13} \\times b_ {31}$ $$ \\mathbf{A} = \\begin{pmatrix} a_{11} \u0026amp; a_{12} \u0026amp; \\cdots \u0026amp; a_{1n}\\ a_{21} \u0026amp; a_{22} \u0026amp; \\vdots \u0026amp; a_{2n}\\ \\vdots \u0026amp; \\vdots \u0026amp; \\ddots \u0026amp; \\vdots\\ a_{m1} \u0026amp; a_{m2} \u0026amp; \\cdots \u0026amp; a_{mn} \\end{pmatrix} \\text{, } \\mathbf{B} = \\begin{pmatrix} b_{11} \u0026amp; b_{12} \u0026amp; \\cdots \u0026amp; b_{1p}\\ b_{21} \u0026amp; b_{22} \u0026amp; \\vdots \u0026amp; b_{2p}\\ \\vdots \u0026amp; \\vdots \u0026amp; \\ddots \u0026amp; \\vdots\\ b_{n1} \u0026amp; b_{n2} \u0026amp; \\cdots \u0026amp; b_{np} \\end{pmatrix} \\ \\ \\mathbf{AB} = \\begin{pmatrix} ab_{11} \u0026amp; ab_{12} \u0026amp; \\cdots \u0026amp; ab_{1p}\\ ab_{21} \u0026amp; ab_{22} \u0026amp; \\vdots \u0026amp; ab_{2p}\\ \\vdots \u0026amp; \\vdots \u0026amp; \\ddots \u0026amp; \\vdots\\ ab_{m1} \u0026amp; ab_{m2} \u0026amp; \\cdots \u0026amp; ab_{mp} \\end{pmatrix} \\text{å…¶ä¸­ } ab_{ij}=\\sum_{k=1}^{m}a_{ik}b_{kj} $$\næˆ‘ä»¬ç”¨ä¸€ä¸ªå¯è§†åŒ–çš„æ–¹å¼æ¥è¡¨ç¤ºè¿™ä¸ªè¿‡ç¨‹ï¼š\n$$ \\mathbf{A} = \\begin{pmatrix} 4 \u0026amp; 3\\ 0 \u0026amp; -5\\ 2 \u0026amp; 1\\ -6 \u0026amp; 8 \\end{pmatrix} \\text{, } \\mathbf{B} = \\begin{pmatrix} 7 \u0026amp; 1 \u0026amp; 3\\ -2 \u0026amp; 4 \u0026amp; 1 \\end{pmatrix} \\ \\begin{aligned} \\mathbf{AB} \u0026amp;= \\begin{pmatrix} 4\\times7+3\\times\\left(-2\\right) \u0026amp; 4\\times1+3\\times4 \u0026amp; 4\\times3+3\\times1\\ 0\\times7+\\left(-5\\right)\\times\\left(-2\\right) \u0026amp; 0\\times1+\\left(-5\\right)\\times4 \u0026amp; 0\\times3+\\left(-5\\right)\\times1\\ 2\\times7+1\\times\\left(-2\\right) \u0026amp; 2\\times1+1\\times4 \u0026amp; 2\\times3+1\\times1\\ \\left(-6\\right)\\times7+8\\times\\left(-2\\right) \u0026amp; \\left(-6\\right)\\times1+8\\times4 \u0026amp; \\left(-6\\right)\\times3+8\\times1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 28-6 \u0026amp; 4+12 \u0026amp; 12+3\\ 0+10 \u0026amp; 0-20 \u0026amp; 0-5\\ 14-2 \u0026amp; 2+4 \u0026amp; 6+1\\ -42-16 \u0026amp; -6+32 \u0026amp; -18+8 \\end{pmatrix}\\\\ \\mathbf{AB} \u0026amp;= \\begin{pmatrix} 22 \u0026amp; 16 \u0026amp; 15\\ 10 \u0026amp; -20 \u0026amp; -5\\ 12 \u0026amp; 6 \u0026amp; 7\\ -58 \u0026amp; 26 \u0026amp; -10 \\end{pmatrix} \\end{aligned} $$\næ³¨æ„ï¼š\nä¸ºäº†å®šä¹‰çŸ©é˜µä¹˜æ³•ï¼Œ==ç¬¬ä¸€ä¸ªçŸ©é˜µä¸­çš„åˆ—æ•°==å¿…é¡»ç­‰äº==ç¬¬äºŒä¸ªçŸ©é˜µä¸­çš„è¡Œæ•°==ã€‚\näº†è§£æ›´å¤šï¼š\näº†è§£æ›´å¤š äº†è§£æ›´å¤š å˜æ¢çŸ©é˜µ ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†çŸ©é˜µæ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”çŸ¥é“çŸ©é˜µå¦‚ä½•ç›¸ä¹˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹çŸ©é˜µå¦‚ä½•åº”ç”¨äºäºŒç»´å˜æ¢ï¼›\nè½¬æ¢ç‚¹ æ­£å¦‚ä¹‹å‰æ‰€è¯´ï¼ŒçŸ©é˜µå¯ä»¥è¢«ç”¨äºè¡¨ç¤ºçº¿æ€§æ–¹ç¨‹ç»„ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹æ–¹ç¨‹ç»„ï¼š $$ 2x + y = 5 \\ -x + 2y = 0 $$ å¦‚æœä½ å¯¹çŸ©é˜µä¹˜æ³•å¾ˆç†Ÿæ‚‰ï¼Œä½ å¯èƒ½çœ‹åˆ°ä¸Šè¿°æ–¹ç¨‹ä¸­éšè—çš„çŸ©é˜µä¹˜æ³•ï¼š $$ \\begin{pmatrix} 2 \u0026amp; 1 \\ -1 \u0026amp; 2 \\ \\end{pmatrix} . \\begin{pmatrix} x \\ y \\end{pmatrix}= \\begin{pmatrix} 5 \\ 0 \\end{pmatrix} $$ å¦‚æœä½ çœ‹çš„æ›´æ·±ä¸€ç‚¹ï¼Œä½ å¯èƒ½ä¼šå‘ç°åŸºäºçŸ©é˜µ$\\begin{pmatrix} x \\ y \\end{pmatrix}$ å’Œ $\\begin{pmatrix} 5 \\ 0 \\end{pmatrix}$çš„ä¸€äº›è§„å¾‹ã€‚\né‚£å°±æ˜¯ï¼šè¿™ä¸¤ä¸ªçŸ©é˜µéƒ½å¯ä»¥è¢«ç”¨æ¥ä»£è¡¨ç¬›å¡å°”å¹³é¢ä¸­çš„ç‚¹ï¼Œä¸€ä¸ªç‚¹å¯ä»¥ç”¨æºè‡ªåŸç‚¹çš„å‘é‡è¡¨ç¤ºï¼Œè¿™ä¸ªå‘é‡æ˜¯ä¸€ä¸ª $2Ã—1$ çš„çŸ©é˜µã€‚\næˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ä¸€ä¸ªçŸ©é˜µä¹˜æ³•å°±ä»£è¡¨äº†ä¸€ä¸ªç‚¹åˆ°å¦å¤–ä¸€ä¸ªç‚¹çš„è½¬æ¢ï¼Œå°½ç®¡æˆ‘ä»¬ç›®å‰è¿˜ä¸çŸ¥é“ç¬¬ä¸€ä¸ªç‚¹çš„åæ ‡æ˜¯ä»€ä¹ˆï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œç»™å®šä¸€ä¸ªä½ç½®çŸ¢é‡ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡çŸ©é˜µä¹˜æ³•è¿ç®—å°†å…¶è½¬æ¢ä¸ºå¦å¤–ä¸€ä¸ªçŸ¢é‡ã€‚\nå¦‚æœä¸€ä¸ªç‚¹ $\\mathbf{P}$ æ˜¯ä¸€ä¸ªå€¼ä¸º$\\begin{pmatrix} x\\y \\end{pmatrix}$ çš„ä½ç½®çŸ¢é‡ï¼Œæˆ‘ä»¬å¯ä»¥ä¹˜ä¸€ä¸ªçŸ©é˜µæ¥å¾—åˆ°ä¸€ä¸ªæ–°çš„ç‚¹ $\\mathbf{P}^{\u0026rsquo;}$\nå®ƒå¯ä»¥é€šè¿‡ä½ç½®çŸ¢é‡ $\\begin{pmatrix} x^{\u0026rsquo;} \\ y^{\u0026rsquo;} \\end{pmatrix}$ æ¥è¡¨ç¤ºï¼›\nä¸€ä¸ªé‡è¦çš„ç‚¹åœ¨äºï¼Œä¸ºäº†æ»¡è¶³çŸ©é˜µä¹˜æ³•çš„è¦æ±‚ï¼ŒçŸ©é˜µå˜æ¢å¿…é¡»æ‹¥æœ‰ç‰¹å®šçš„ç»´åº¦ï¼Œå› ä¸ºæºä½ç½®çŸ¢é‡ $\\begin{pmatrix} x\\y \\end{pmatrix}$ æ˜¯ä¸€ä¸ª $2\\times 1$ çš„çŸ©é˜µï¼Œè€Œç›®æ ‡ä½ç½®çŸ¢é‡ $\\begin{pmatrix} x^{\u0026rsquo;} \\ y^{\u0026rsquo;} \\end{pmatrix}$ ä¹Ÿæ˜¯ä¸€ä¸ª $2 \\times 1$ çš„çŸ©é˜µï¼Œæ‰€ä»¥å˜æ¢çŸ©é˜µå¿…é¡»æ˜¯ä¸€ä¸ª $2 \\times 2$ çš„çŸ©é˜µï¼Œè¿™æ ·æ‰èƒ½æ»¡è¶³çŸ©é˜µä¹˜æ³•çš„è¦æ±‚ï¼š $$ \\mathbf{A} . \\begin{pmatrix} x\\y \\end{pmatrix} = \\begin{pmatrix} a_{11} \u0026amp; a_{12}\\ a_{21} \u0026amp; a_{22} \\end{pmatrix} . \\begin{pmatrix} x\\y \\end{pmatrix} = \\begin{pmatrix} x^{\\prime}\\y^{\\prime} \\end{pmatrix} $$\nç¬¬ä¸€ä¸ªçŸ©é˜µçš„åˆ—æ•°å¿…é¡»ç­‰äºç¬¬äºŒä¸ªçŸ©é˜µçš„è¡Œæ•°ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªçŸ©é˜µçš„åˆ—æ•°éœ€è¦ä¸º 2 çŸ©é˜µç›¸ä¹˜å¾—åˆ°çš„çŸ©é˜µçš„å°ºå¯¸ä¸º $ç¬¬ä¸€ä¸ªçŸ©é˜µçš„è¡Œæ•° \\times ç¬¬äºŒä¸ªçŸ©é˜µçš„åˆ—æ•°$ï¼Œä¸ºäº†å¾—åˆ°ä¸€ä¸ª $2 \\times 1$ çš„ç»“æœçŸ©é˜µï¼Œåˆ™==ç¬¬ä¸€ä¸ªçŸ©é˜µçš„è¡Œæ•°== ä¸º 2 æ•…å˜æ¢çŸ©é˜µçš„è¡Œåˆ—æ•°ä¸ºï¼š$2 \\times 2$ æç¤ºï¼šåé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒçŸ©é˜µä¹˜æ³•ä¸­çš„é¡ºåºå¾ˆé‡è¦ã€‚æ¯”æ–¹è¯´ä¸Šé¢çš„çŸ©é˜µä¹˜æ³•ï¼Œå¦‚æœè°ƒæ¢ $\\mathbf{A}$ å’Œ $\\begin{pmatrix} x\\y \\end{pmatrix}$ çš„é¡ºåºï¼Œåˆ™æ— æ³•è·å¾—ä¸€ä¸ªæ–°çš„ç‚¹ï¼š $P_{2\\times1} . A_{1\\times n}=P^{\u0026rsquo;}_{2 \\times n}$ï¼ˆä¸æˆç«‹ï¼‰ è½¬æ¢çŸ©é˜µçš„å¦å¤–ä¸€ä¸ªéå¸¸å¥½ç”¨çš„åœ°æ–¹åœ¨äºï¼Œå®ƒå¯ä»¥åŒæ—¶æ‰¹é‡çš„è½¬æ¢ä¸€æ‰¹ç‚¹ï¼›\n$$ \\mathbf{A} . \\begin{pmatrix} x\\y \\end{pmatrix} = \\begin{pmatrix} a_{11} \u0026amp; a_{12}\\ a_{21} \u0026amp; a_{22} \\end{pmatrix} . \\begin{pmatrix} x\\y \\end{pmatrix} = \\begin{pmatrix} x^{\\prime}\\y^{\\prime} \\end{pmatrix} $$\nå‡è®¾ä½ çŸ¥é“æ‰€éœ€è¦çš„åº”ç”¨çš„æ‰€æœ‰è½¬æ¢ç±»å‹ï¼ˆrotation,scale,translationï¼‰åŠå…¶ä»–å‚æ•°ã€‚\né‚£ä¹ˆï¼Œå¦‚ä½•è·å¾—ç¼©æ”¾2å€å¹¶æ²¿ç€é¡ºæ—¶é’ˆæ–¹å‘æ—‹è½¬90åº¦çš„è½¬æ¢çŸ©é˜µå‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯ï¼šæˆ‘ä»¬éœ€è¦æ›´å¤šæ•°å­¦çŸ¥è¯†ã€‚\næ›´å¤šæ•°å­¦çŸ¥è¯† å»ºè®®å¤§å®¶é˜…è¯»æ­¤è¯¾ç¨‹ä¸­æœ‰å…³å˜æ¢çš„çŸ©é˜µè¯¾ç¨‹ï¼ˆå…¶ä¸­æœ‰å¤§é‡ç²¾ç¾çš„å›¾ç¤ºå’ŒåŠ¨ç”»ï¼‰ï¼Œç‰¹åˆ«æ˜¯å®ƒçš„æœ€åä¸€éƒ¨åˆ†ï¼šç”¨çŸ©é˜µè¡¨ç¤ºäºŒç»´çº¿æ€§å˜æ¢ï¼Œè®²çš„éå¸¸ä¸é”™ï¼›\nå›åˆ°æˆ‘ä»¬åˆšæ‰è®¨è®ºçš„é—®é¢˜ï¼Œç°åœ¨è®©æˆ‘ä»¬äº†è§£æ›´å¤šæ•°å­¦çŸ¥è¯†å§ã€‚\nç°åœ¨æˆ‘å‡è®¾ä½ å­¦ä¹ äº†ä¸Šé¢çš„è¯¾ç¨‹ï¼Œä¸‹é¢çš„éƒ¨åˆ†æ˜¯å¯¹è¯¥è¯¾ç¨‹çš„ç®€å•å›é¡¾ï¼š\nä¸€ä¸ªä½ç½®çŸ¢é‡ $\\begin{pmatrix}x \\ y \\end{pmatrix}$ å¯ä»¥è¢«è¡¨ç¤ºä¸º ï¼š $\\begin{pmatrix}x \\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$\nè§£é‡Šï¼š\n$\\begin{pmatrix}x \\ y \\end{pmatrix}$ å¯ä»¥è¢«åˆ†è§£ä¸ºä¸€ä¸ªçŸ©é˜µåŠ æ³•è¿ç®—ï¼š $\\begin{pmatrix}x \\ y \\end{pmatrix} = \\begin{pmatrix}x \\ 0 \\end{pmatrix} + \\begin{pmatrix}0 \\ y \\end{pmatrix}$\nå…¶ä¸­çš„æ¯ä¸ªåŠ æ³•çš„è¿ç®—çŸ©é˜µéƒ½å¯ä»¥è¢«ç»§ç»­æ‹†åˆ†ä¸ºä¸€ä¸ªæ ‡é‡åŒçŸ©é˜µçš„ä¹˜æ³•ï¼š\n$\\begin{pmatrix} x \\ 0 \\end{pmatrix} = x . \\begin{pmatrix} 1 \\ 0 \\end{pmatrix}$ $\\begin{pmatrix} 0 \\ y \\end{pmatrix} = y . \\begin{pmatrix} 0 \\ 1 \\end{pmatrix}$ ç°åœ¨ï¼Œæˆ‘ä»¬çœ‹å…¶ä¸­çš„çŸ©é˜µ $\\begin{pmatrix} 1\\0 \\end{pmatrix}$ å’Œ $\\begin{pmatrix} 0 \\1 \\end{pmatrix}$ï¼Œå…¶å®å®ƒä»¬æ˜¯ç¬›å¡å°”åæ ‡å¹³é¢çš„å•ä½çŸ¢é‡ï¼›\nå› æ­¤ï¼Œ $\\begin{pmatrix}x \\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$ å°±æ˜¯ä½ç½®çŸ¢é‡ $\\begin{pmatrix}x \\ y \\end{pmatrix}$ çš„å¦å¤–ä¸€ç§å†™æ³•ï¼Œå®ƒä»£è¡¨äº†ç”±æˆ‘ä»¬çš„ç¬›å¡å°”å¹³é¢çš„å•ä½å‘é‡çš„å˜æ¢ç»™å‡ºçš„ç‚¹ã€‚\nåœ¨åº”ç”¨äº†å˜æ¢çŸ©é˜µ$\\mathbf{A} = \\begin{pmatrix} \\color{Green} a \u0026amp; \\color{Red} b\\ \\color{Green} c \u0026amp; \\color{Red} d \\end{pmatrix}$ ä¹‹åï¼Œ $\\begin{pmatrix} \\color{Green}a\\\\color{Green}c \\end{pmatrix}$ å’Œ $\\begin{pmatrix}\\color{Red} b\\ \\color{Red} d\\end{pmatrix}$ å°†è¢«åˆ†åˆ«æ”¾ç½®äº $\\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix}$ å’Œ $\\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$ çš„ä½ç½®ï¼›\nè§£é‡Šï¼š\næˆ‘ä»¬ä¾ç„¶ä»å•ä½çŸ¢é‡ $\\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix}$å’Œ $\\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$ å¼€å§‹\næˆ‘ä»¬çŸ¥é“ $\\begin{pmatrix}x \\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$ï¼Œç°åœ¨æˆ‘ä»¬æƒ³åƒä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬åº”ç”¨ä¸€ä¸ªå˜æ¢åˆ°æˆ‘ä»¬çš„å¹³é¢ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„å•ä½çŸ¢é‡ä¹Ÿä¼šéšä¹‹å˜æ¢å§ï¼Ÿ\næˆ‘ä»¬å‡è®¾å˜æ¢å $\\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix}$ ä¼šåè½åœ¨ $\\begin{pmatrix} \\color{Green}a \\ \\color{Green}c \\end{pmatrix}$ ä¸Šï¼Œè€Œ$\\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$ ä¼šè½åœ¨ $\\begin{pmatrix} \\color{Red}b \\ \\color{Red}d \\end{pmatrix}$ ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä½ç½®çŸ¢é‡ $\\begin{pmatrix}x \\ y \\end{pmatrix}$ å°†ä¼šè½åœ¨ $x.\\begin{pmatrix}\\color{Green} a \\ c \\end{pmatrix} + y.\\begin{pmatrix} \\color{Red} b\\d \\end{pmatrix} = \\begin{pmatrix}\\color{Green}a.x + \\color{Red}b.y \\ {\\color{Green}c.x + \\color{Red}d.y} \\end{pmatrix}$\nç»è¿‡ä¸Šé¢çš„çŸ©é˜µå˜æ¢ï¼Œ$\\begin{pmatrix} x \\ y \\end{pmatrix}$ å°†ä¼šåè½äº $\\begin{pmatrix} \\color{Green}a.x + \\color{Red}b.y \\ \\color{Green}c.x + \\color{Red}d.y \\ \\end{pmatrix}$\nå¦‚æœä½ æ— æ³•ç†è§£ä¸Šé¢çš„å˜æ¢è¿‡ç¨‹ï¼Œè¯·å­¦ä¹ ä¸Šé¢çš„è¯¾ç¨‹å¹¶åå¤é˜…è¯»ã€‚\nç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®æˆ‘ä»¬çš„ç›®æ ‡ï¼Œå°±æ˜¯ï¼šæˆ‘ä»¬éœ€è¦æ‰¾å‡ºæˆ‘ä»¬çš„å˜æ¢çŸ©é˜µ $\\mathbf{A}$ ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“äº†æˆ‘ä»¬æƒ³è¦åº”ç”¨çš„è½¬æ¢ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ‰¾åˆ°é‚£ä¸ªèƒ½å¤Ÿåº”ç”¨åˆ°æˆ‘ä»¬çš„ä½ç½®çŸ¢é‡ä¸Šæ¥è½¬æ¢æˆ‘ä»¬å›¾å½¢çš„çŸ©é˜µï¼›\nè®©æˆ‘ä»¬ä»¥ä¸€ç³»åˆ—ç‚¹çš„è½¬æ¢ä¸ºä¾‹ï¼šæˆ‘ä»¬çŸ¥é“ä½ç½®çŸ¢é‡å°†åˆ°è¾¾çš„ä½ç½®ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ±‚å‡ºçŸ©é˜µ $\\mathbf{A}$ ã€‚\næˆ‘ä»¬çš„ç¬›å¡å°”å¹³é¢ä¸Šæœ‰ä¸€ä¸ªç”±ä¸‰ä¸ªç‚¹ $\\mathbf{P}{(2,1)},\\mathbf{Q}{(2,0)} \\mathbf{R}{(0,2)}$ Pç»„æˆçš„ä¸‰è§’å½¢ï¼Œ ä»¥åŠå¦ä¸€ä¸ªä»£è¡¨ç¬¬ä¸€ä¸ªä¸‰è§’å½¢çš„å˜æ¢ç‰ˆæœ¬çš„ä¸‰è§’å½¢ï¼š$\\mathbf{P}^{\u0026rsquo;}{(5,0)},\\mathbf{Q}^{\u0026rsquo;}{(-4,2)} \\mathbf{R}^{\u0026rsquo;}{(2,4)}$\nä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬åªéœ€è¦ä¸¤ä¸ªç‚¹å°±å¯ä»¥æ±‚è§£å‡ºçŸ©é˜µ$\\mathbf{A}$ï¼Œæˆ‘ä»¬ä½¿ç”¨ $\\mathbf{P}$ å’Œ $\\mathbf{Q}$ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå˜æ¢ä¹‹åï¼š $$ \\begin{pmatrix} 2\\ 1 \\end{pmatrix} \\text{ ä½äº } \\begin{pmatrix} 5\\ 0 \\end{pmatrix} \\ \\ \\begin{pmatrix} -2\\ 0 \\end{pmatrix} \\text{ ä½äº } \\begin{pmatrix} -4\\ 2 \\end{pmatrix} $$ ä¹Ÿå°±æ˜¯è¯´ï¼š $$ \\begin{pmatrix} x\\ y \\end{pmatrix} = \\begin{pmatrix} 2\\ 1 \\end{pmatrix} \\text{ ä½äº } \\begin{pmatrix} a.x+b.y\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} 5\\ 0 \\end{pmatrix} \\ \\ \\begin{pmatrix} x\\ y \\end{pmatrix} = \\begin{pmatrix} -2\\ 0 \\end{pmatrix} \\text{ ä½äº } \\begin{pmatrix} a.x+b.y\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} -4\\ 2 \\end{pmatrix} $$ ç®€åŒ–ä¹‹åå°±æ˜¯ï¼š $$ \\begin{pmatrix} 2.a+1.b\\ 2.c+1.d \\end{pmatrix} = \\begin{pmatrix} 5\\ 0 \\end{pmatrix} \\ \\begin{pmatrix} -2.a+0.b\\ -2.c+0.d \\end{pmatrix} = \\begin{pmatrix} -4\\ 2 \\end{pmatrix} $$ é€šè¿‡ç¬¬2ä¸ªç­‰å¼å¯ä»¥ç®—å‡ºï¼Œ $a=2$ ï¼Œ$c=-1$ï¼Œä»£å…¥åˆ°ç¬¬ä¸€ä¸ªç­‰å¼ä¸­å¯ä»¥å¾—å‡ºï¼š $b=1$, $d =2$ï¼Œç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†æˆ‘ä»¬çš„å˜æ¢çŸ©é˜µï¼š $$ \\mathbf{A} = \\begin{pmatrix} \\color{Green} 2 \u0026amp; \\color{Red} 1\\ \\color{Green} -\\color{Green} 1 \u0026amp; \\color{Red} 2 \\end{pmatrix} $$\nå•ä½çŸ©é˜µ ç°åœ¨æˆ‘ä»¬è¿˜ä¸çŸ¥é“å¦‚ä½•å®šä¹‰ä¸€ä¸ªè½¬æ¢çŸ©é˜µï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“å®ƒçš„è¡¨ç¤ºå½¢å¼ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšä»€ä¹ˆå‘¢ï¼Ÿè¿˜è®°å¾—åœ¨ä¸Šä¸€ä¸ªå°èŠ‚ä¸­ï¼Œæˆ‘ä»¬è¯´è¿‡ï¼Œä¸€ä¸ªä½ç½®$\\begin{pmatrix}x \\ y \\end{pmatrix}$ å¯ä»¥è¢«è¡¨ç¤ºä¸º $\\begin{pmatrix}x \\ y \\end{pmatrix} = x . \\begin{pmatrix} \\color{Green}1 \\ \\color{Green}0 \\end{pmatrix} + y . \\begin{pmatrix} \\color{Red}0 \\ \\color{Red}1 \\end{pmatrix}$ ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ï¼Œæˆ‘ä»¬åˆšåˆšåˆ—å‡ºäº†æˆ‘ä»¬çš„==åŸºæœ¬==çŸ©é˜µï¼š\n$$ \\begin{pmatrix} \\color{Green}1 \u0026amp; \\color{Red}0 \\ \\color{Green} 0 \u0026amp; \\color{Red} 1 \\end{pmatrix} $$\nè¿™ä¸ªçŸ©é˜µä»£è¡¨äº†ä½ çš„å¹³é¢çš„åŸºç¡€çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯åˆšåŠ è½½å›¾åƒæ—¶åº”ç”¨äºå¹³é¢çš„çŸ©é˜µï¼ˆå›¾åƒä¸å…¶å˜æ¢åçš„å®¹å™¨è§†å›¾çš„å¤§å°ç›¸åŒï¼‰ï¼Œæ¢ä¸€ç§è¯´æ³•å°±æ˜¯ï¼Œåº”ç”¨äº†è¿™ä¸ªçŸ©é˜µçš„ä½ç½®çŸ¢é‡å°†ä¼šè¿”å›ä¸€æ ·çš„ä½ç½®çŸ¢é‡ã€‚è¿™æ ·çš„çŸ©é˜µå°±ç§°ä¹‹ä¸º ==å•ä½çŸ©é˜µ==(identity matrix)\nç»“åˆå¤šç§å˜æ¢ åœ¨æˆ‘ä»¬äº†è§£æ›´å¤šç»†èŠ‚ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä»¶äº‹ï¼Œå°±æ˜¯ï¼šæˆ‘ä»¬å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿç»„åˆ/é“¾æ¥å¤šç§å˜æ¢ï¼ˆä¾‹å¦‚ï¼ŒåŒæ—¶ç¼©æ”¾å’Œå¹³ç§»ï¼‰ã€‚\nä¸ºäº†èƒ½é“¾æ¥å¤šä¸ªè½¬æ¢ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£çŸ©é˜µä¹˜æ³•çš„æ€§è´¨ ã€‚æ›´å…·ä½“çš„è¯´æ˜¯æˆ‘ä»¬éœ€è¦äº†è§£çŸ©é˜µä¹˜æ³•çš„==éäº¤æ¢æ€§(non-commutative)==å’Œ==ç»“åˆæ€§==(associative)\nçŸ©é˜µä¹˜æ³•æ˜¯å¯ç»“åˆçš„ï¼š $\\left(\\mathbf{A}.\\mathbf{B}\\right).\\mathbf{C} = \\mathbf{A}.\\left(\\mathbf{B}.\\mathbf{C}\\right)$ çŸ©é˜µä¹˜æ³•æ˜¯ä¸å¯äº¤æ¢çš„ï¼š$\\mathbf{A}.\\mathbf{B} \\neq \\mathbf{B}.\\mathbf{A}$ å›åˆ°æˆ‘ä»¬çš„å˜æ¢ï¼Œæƒ³è±¡æˆ‘ä»¬æƒ³è¦åº”ç”¨å˜æ¢ $\\mathbf{B}$ ,ç„¶ååº”ç”¨å˜æ¢ $\\mathbf{A}$ åˆ°æˆ‘ä»¬çš„ä½ç½®çŸ¢é‡ $\\vec{v}$ ,ä¸¤æ¬¡å˜æ¢å¯ä»¥åˆ†åˆ«è¡¨ç¤ºä¸ºï¼š$\\vec{v^{\\prime}} = \\mathbf{B} . \\vec{v}$ åŠ $\\vec{v^{\\prime\\prime}} = \\mathbf{A} . \\vec{v^{\\prime}}$ ,ç»“åˆä¸‹æ¥ï¼š\n$$ \\vec{v^{\\prime\\prime}} = \\mathbf{A} . \\left( \\mathbf{B} . \\vec{v} \\right) $$ å› ä¸ºçŸ©é˜µä¹˜æ³•æ˜¯å¯ä»¥ç»“åˆçš„ï¼Œæ‰€ä»¥ï¼š $$ \\vec{v^{\\prime\\prime}} = \\mathbf{A} . \\left( \\mathbf{B} . \\vec{v} \\right) \\Leftrightarrow \\vec{v^{\\prime\\prime}} = \\left( \\mathbf{A} . \\mathbf{B} \\right) . \\vec{v} $$ å› ä¸ºçŸ©é˜µä¹˜æ³•æ˜¯ä¸å¯äº¤æ¢çš„ï¼Œæ‰€ä»¥ä¸¤ä¸ªå˜æ¢çŸ©é˜µçš„åº”ç”¨é¡ºåºä¸å¯æ”¹å˜ï¼Œå³ $\\mathbf{A}.\\mathbf{B}$ ä¸èƒ½å˜æ¢æˆ $\\mathbf{B}.\\mathbf{A}$ï¼Œå¦åˆ™å°†ä¼šäº§ç”Ÿä¸åŒçš„å˜æ¢æ•ˆæœï¼›\næ³¨æ„è¿™é‡ŒçŸ©é˜µå˜æ¢åº”ç”¨çš„é¡ºåºå’Œè½¬æ¢æˆä¹˜æ³•ä¹‹åçš„çŸ©é˜µé¡ºåºï¼Œæˆ‘ä»¬å…ˆåº”ç”¨$\\mathbf{B}$ï¼Œç„¶åå†åº”ç”¨ $\\mathbf{A}$ï¼Œç»“åˆä¹‹åçš„é¡ºåºæ˜¯ ï¼š$\\mathbf{A.B}$\nå˜æ¢ç±»å‹ ä½¿ç”¨ $2\\times2$ çš„çŸ©é˜µæˆ‘ä»¬å¯ä»¥å®šä¹‰å¤šç§ä¸åŒç±»å‹çš„äºŒç»´å˜æ¢ç±»å‹ï¼Œä½ å¯èƒ½å·²ç»åœ¨è¯¾ç¨‹ matrices as transformations ä¸­äº†è§£äº†å…¶ä¸­çš„å¤§éƒ¨åˆ†å˜æ¢ï¼Œè¿™äº›å˜æ¢åŒ…æ‹¬ï¼š\nç¼©æ”¾ Reflexion-åå°„ Shearing Rotation-æ—‹è½¬ æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç‚¹ $\\mathbf{P}{(x,y)}$ï¼Œè¿™ä¸ªç‚¹ä»£è¡¨äº†å¹³é¢ä¸­çš„ä»»ä¸€ä¸ªç‚¹ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªçŸ©é˜µèƒ½å°†ç‚¹è½¬æ¢åˆ° $\\mathbf{P^{\u0026rsquo;}}{(x^{\u0026rsquo;},y^{\u0026rsquo;})}$ï¼Œä¹Ÿå°±æ˜¯ï¼š $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime} \\end{pmatrix} = \\mathbf{A} . \\begin{pmatrix} x\\y \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} . \\begin{pmatrix} x\\y \\end{pmatrix} $$\nScaling ç¼©æ”¾çœ‹èµ·æ¥å¾ˆå¥½è¡¨ç¤ºï¼Œæ¯”æ–¹è¯´æ”¾å¤§2å€ï¼Œåªéœ€å°†åæ ‡ä¹˜ä»¥æ¯”ä¾‹å› å­å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯èƒ½å¸Œæœ›å¯¹è½¬æ¢ä½¿ç”¨ä¸åŒçš„æ°´å¹³å’Œå‚ç›´ç¼©æ”¾æ¯”ä¾‹ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ\nä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„æ–¹å‘ä½¿ç”¨ä¸åŒçš„ç¼©æ”¾æ¯”ä¾‹ï¼Œæˆ‘ä»¬å¿…é¡»åŒºåˆ†æ°´å¹³å’Œå‚ç›´æ–¹å‘çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œå®ƒä»¬åˆ†åˆ«ä½¿ç”¨$S_{x}$ å’Œ$S_{y}$è¡¨ç¤ºï¼›\næˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¸¤ä¸ªç­‰å¼ï¼š $$ \\begin{aligned} x\u0026rsquo; \u0026amp;= S_{x} . x \\ y\u0026rsquo; \u0026amp;= S_{y} . y \\end{aligned} $$ ç»“åˆä¹‹å‰çš„çŸ©é˜µï¼š $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime} \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} . \\begin{pmatrix} x\\y \\end{pmatrix} $$ æˆ‘ä»¬å¯ä»¥å¾—åˆ° $a,b,c,d$ å¦‚ä¸‹ï¼š $$ \\left. \\begin{aligned} S_{x} . x \u0026amp;= a . x + b . y\\\\ \\Rightarrow a \u0026amp;= S_{x} \\text{ ä¸” }\\ b \u0026amp;= 0 \\end{aligned} \\middle | \\begin{aligned} S_{y} . y \u0026amp;= c . x + d . y\\\\ \\Rightarrow c \u0026amp;= S_{y} \\text{ ä¸” }\\ d \u0026amp;= 0 \\end{aligned} \\right. $$\nç¼©æ”¾æ¯”ä¾‹$(S_x,S_y)$ å¯¹åº”çš„ $2\\times2$ ç¼©æ”¾çŸ©é˜µå°±æ˜¯ï¼š $$ \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} = \\begin{pmatrix} S_x \u0026amp; 0\\0 \u0026amp; S_y \\end{pmatrix} $$ å½“ç¼©æ”¾æ¯”ä¾‹ä¸º $1$ æ—¶ï¼Œåº”ç”¨è¿™ä¸ªç¼©æ”¾çŸ©é˜µæ˜¯ï¼š $$ \\begin{pmatrix} S_{x} \u0026amp; 0\\0 \u0026amp; S_{y} \\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; 0\\0 \u0026amp; 1 \\end{pmatrix} $$ ä¹Ÿå°±æ˜¯å•ä½çŸ©é˜µï¼Œåº”ç”¨ä¹‹å $x$ï¼Œ$y$ å‡ä¸ä¼šæ”¹å˜ï¼Œè¿™ä¸å•ä½çŸ©é˜µçš„æ„ä¹‰ç¬¦åˆã€‚\nReflexion-ä»¿å°„ ä»¿å°„ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸¤ç§å‰æ–¹çš„ä»¿å°„ç±»å‹ï¼šå›´ç»•è½´æˆ–å›´ç»•ç‚¹çš„ä»¿å°„ã€‚\nä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†é‡ç‚¹æ”¾åœ¨$x$å’Œ$y$è½´å‘¨å›´çš„ä»¿å°„ï¼ˆåŸç‚¹å‘¨å›´çš„åå°„ç­‰åŒäºåœ¨$x$å’Œ$y$è½´ä¸Šè¿ç»­æ–½åŠ ä»¿å°„ï¼‰ã€‚\nå›´ç»• $x$ è½´çš„åå°„ï¼š $$ \\left.\\begin{aligned} x^{\\prime} \u0026amp;= x\\ x \u0026amp;= a . x + b . y\\\\ \\Rightarrow a \u0026amp;= 1 \\text{ and }\\ b \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= -y\\ -y \u0026amp;= c . x + d . y\\\\ \\Rightarrow c \u0026amp;= 0 \\text{ and }\\ d \u0026amp;= -1 \\end{aligned} \\right. $$ æœ‰è¶£çš„æ˜¯ï¼Œå›´ç»• $x$ è½´çš„ä»¿å°„å’Œä½¿ç”¨ -1 ä½œä¸ºç¼©æ”¾å› å­å¯¹$x$ è¿›è¡Œç¼©æ”¾çš„è½¬æ¢çŸ©é˜µä¸€è‡´ï¼› $$ \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; 0\\ 0 \u0026amp; -1 \\end{pmatrix} $$ å›´ç»• $y$ è½´æ–¹å‘çš„ä»¿å°„ï¼š $$ \\left. \\begin{aligned} x^{\\prime} \u0026amp;= -x\\ -x \u0026amp;= a . x + b . y\\\\ \\Rightarrow a \u0026amp;= -1 \\text{ and }\\ b \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= y\\ y \u0026amp;= c . x + d . y\\\\ \\Rightarrow c \u0026amp;= 0 \\text{ and }\\ d \u0026amp;= 1 \\end{aligned} \\right. $$ è½¬æ¢çŸ©é˜µï¼š $$ \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} = \\begin{pmatrix} -1 \u0026amp; 0\\ 0 \u0026amp; 1 \\end{pmatrix} $$\nShearing-å‰ªåˆ‡ è¿™ä¸ªShearingå˜æ¢æœ‰äº›å¤æ‚ã€‚\nåœ¨æˆ‘å‘ç°çš„å¤§å¤šæ•°ç¤ºä¾‹ä¸­ï¼Œå‰ªåˆ‡éƒ½æ˜¯é€šè¿‡æ·»åŠ ä¸€ä¸ªå¯ä»¥ä»£è¡¨shearingè§’åº¦çš„å¸¸é‡æ¥æ›´æ”¹åæ ‡æ¥è§£é‡Šçš„ã€‚\næ¯”æ–¹è¯´ï¼Œä¸€ä¸ªæ²¿ç€$x$ è½´æ–¹å‘çš„ shear é€šå¸¸ä½¿ç”¨ä¸€ä¸ªé¡¶ç‚¹ä½äº$(0,1)$ çš„çŸ©å½¢å˜æ¢æˆä¸€ä¸ªé¡¶ç‚¹ä½äº $(1,1)$ çš„å¹³è¡Œå››è¾¹å½¢æ¥è§£é‡Šï¼›\nShearing along x axis by a constant kx=1 ä¸è¿‡åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³ç”¨å‰ªåˆ‡è§’ï¼ˆè½´è¢«å‰ªåˆ‡çš„è§’åº¦ï¼‰æ¥è§£é‡Šå®ƒã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º $\\alpha$ ï¼ˆalphaï¼‰ã€‚\n![D-angle-shearing](Matrices for developers_files/2D-angle-shearing.gif)\nShearing along x axis by an angle Î± å¦‚æœçœ‹ä¸Šé¢çš„å¹³é¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ–°çš„æ¨ªåæ ‡ $x^{\\prime}$ ç­‰äº$x$åŠ /å‡å»$y$è½´ï¼Œ$y$è½´çš„å‰ªåˆ‡å½¢å¼ä»¥åŠçŸ©å½¢å·¦ä¸Šè§’é¡¶ç‚¹ä¸å¹³è¡Œå››è¾¹å½¢å·¦ä¸Šè§’é¡¶ç‚¹ä¹‹é—´çš„çº¿æ®µæ‰€å½¢æˆçš„ä¸‰è§’å½¢çš„ç›¸å¯¹è¾¹ã€‚ æ¢å¥è¯è¯´ï¼Œ$x ^{\\prime}$ ç­‰äº $x$â€‹ åŠ /å‡ç»¿è‰²ä¸‰è§’å½¢çš„å¦ä¸€ä¾§\nåœ¨ç›´è§’ä¸‰è§’å½¢ä¸­ï¼š\næ–œè¾¹(==hypotenuse==)æ˜¯æœ€é•¿çš„ä¸€é¢ å¯¹è¾¹ï¼ˆ==opposite==ï¼‰æ˜¯ä¸ç»™å®šè§’åº¦ç›¸åçš„é‚£ä¸€ä¾§ ç›¸é‚»è¾¹ï¼ˆ==adjacent==ï¼‰æ˜¯ç»™å®šè§’åº¦çš„ä¸‹ä¸€ä¸ª $\\mathbf{PP^{\u0026rsquo;}}$ æ˜¯å¯¹è¾¹ï¼Œä¸ºäº†è®¡ç®—$x^{\u0026rsquo;}$ åˆ° $x$ çš„è·ç¦»ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å‡ºå¯¹è¾¹çš„é•¿åº¦ ($k$)ï¼› é‚»è¾¹å°±æ˜¯ $P^{\u0026rsquo;}$ çš„åæ ‡ï¼š $y$ ; æˆ‘ä»¬ä¸çŸ¥é“æ–œè¾¹çš„é•¿åº¦ åœ¨ä¸‰è§’å‡½æ•°ï¼ˆtrigonometryï¼‰ä¸­ï¼š $$ \\begin{aligned} \\cos \\left( \\alpha \\right) \u0026amp;= \\frac{é‚»è¾¹}{æ–œè¾¹}\\\\ \\sin \\left( \\alpha \\right) \u0026amp;= \\frac{å¯¹è¾¹}{æ–œè¾¹}\\\\ \\tan \\left( \\alpha \\right) \u0026amp;= \\frac{å¯¹è¾¹}{é‚»è¾¹} \\end{aligned} $$ ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº† $\\alpha$ ,ä½†æˆ‘ä»¬ä¸çŸ¥é“æ–œè¾¹çš„é•¿åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ cosine å‡½æ•°ã€‚\nå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬çŸ¥é“é‚»è¾¹çš„é•¿åº¦ï¼ˆä¹Ÿå°±æ˜¯$y$),æˆ‘ä¸€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tangent å‡½æ•°æ¥æ±‚å‡ºå¯¹è¾¹çš„é•¿åº¦ï¼š $$ \\begin{aligned}\\tan \\left( \\alpha \\right) \u0026amp;= \\frac{å¯¹è¾¹}{é‚»è¾¹}\\\\å¯¹è¾¹ \u0026amp;= é‚»è¾¹ \\times \\tan \\left( \\alpha \\right)\\end{aligned} $$ æˆ‘ä»¬å¯ä»¥å¼€å§‹æ±‚è§£æˆ‘ä»¬çš„çº¿æ€§æ–¹ç¨‹ç»„æ¥å¾—å‡ºæˆ‘ä»¬éœ€è¦çš„çŸ©é˜µï¼š $$ x^{\\prime} = x + k = x + y . \\tan \\left( \\alpha \\right) \\ y^{\\prime} = y $$ å½“ $\\alpha \u0026gt; 0$ æ—¶ï¼Œ$tan(\\alpha) \u0026lt; 0$ï¼Œå½“ $Î±\u0026lt;0, \\tan \\left( \\alpha \\right) \u0026gt; 0$ ,ä¸¤ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ $xâ€²= x+k=x+y.tan(Î±)$ æ±‚è§£å‡ºæ¥çš„å¯èƒ½ä¸ºæ­£ä¹Ÿå¯èƒ½ä¸ºè´Ÿï¼›$\\alpha \u0026gt; 0$ ä¸ºé€†æ—¶é’ˆçš„æ—‹è½¬/æ–œåˆ‡è§’ï¼Œå½“ $Î±\u0026lt;0$ æ—¶ï¼Œä¸ºé¡ºæ—¶é’ˆæ–¹å‘çš„æ—‹è½¬/æ–œåˆ‡è§’ã€‚ $$ \\left. \\begin{aligned} x^{\\prime} \u0026amp;= x + y . \\tan \\left( \\alpha \\right) \\ x + y . \\tan \\left( \\alpha \\right) \u0026amp;= a . x + b . y\\\\ \\Rightarrow a \u0026amp;= 1 \\text{ and }\\ b \u0026amp;= \\tan \\left( \\alpha \\right) \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= y\\ y \u0026amp;= c . x + d . y\\\\ \\Rightarrow c \u0026amp;= 0 \\text{ and }\\ d \u0026amp;= 1 \\end{aligned} \\right. $$\næ²¿$x$æ–¹å‘å‰ªåˆ‡çš„å˜æ¢çŸ©é˜µä¸º: $$ \\begin{aligned} \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; \\tan \\alpha \\ 0 \u0026amp; 1 \\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; k_{x}\\ 0 \u0026amp; 1 \\end{pmatrix}\\\\ {\\text{å…¶ä¸­ } k_{x} \\text{ æ˜¯ shearing å¸¸é‡}} \\end{aligned} $$ ç±»ä¼¼çš„ï¼Œæ²¿ $y$ æ–¹å‘å‰ªåˆ‡çš„å˜æ¢çŸ©é˜µä¸ºï¼š $$ \\begin{aligned} \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; 0\\ \\tan \\beta \u0026amp; 1 \\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; 0\\ k_{y} \u0026amp; 1 \\end{pmatrix}\\\\ \\text{å…¶ä¸­ } k_{y} \\text{ æ˜¯ shearing å¸¸é‡} \\end{aligned} $$\nRotation æ—‹è½¬å°±æ›´åŠ å¤æ‚äº†ã€‚\næˆ‘ä»¬ä»”ç»†çœ‹ä¸‹ä¸‹é¢ å›´ç»•åŸç‚¹æ—‹è½¬ $\\theta$ (theta)è§’åº¦ çš„ä¾‹å­:\n![D-angle-shearing](Matrices for developers_files/2D-rotation.gif)\næ³¨æ„ï¼Œä¸¤ä¸ªç‚¹ $\\mathbf{P}$ å’Œ $\\mathbf{P}^{\u0026rsquo;}$ åœ¨å®ƒä»¬è‡ªå·±çš„åæ ‡å¹³é¢ä¸­éƒ½æœ‰ç›¸åŒçš„åæ ‡$(x,y)$ï¼Œä½†æ˜¯ $\\mathbf{P}^{\u0026rsquo;}$ åœ¨ç¬¬ä¸€ä¸ªæ²¡æœ‰è¢«æ—‹è½¬çš„åæ ‡ç³»ä¸­æœ‰æ–°çš„åæ ‡ï¼š $\\left({x^{\u0026rsquo;},y^{\u0026rsquo;}}\\right)$ ã€‚\né‚£ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å®šä¹‰åŸå§‹åæ ‡ç‚¹$(x,y)$ åˆ°æ–°çš„åæ ‡ç‚¹ $\\left({x^{\u0026rsquo;},y^{\u0026rsquo;}}\\right)$ ä¹‹é—´çš„å…³ç³»äº†å—ï¼Ÿ\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‰è§’å‡½æ•°æ¥å¸®åŠ©æˆ‘ä»¬è®¡ç®—ï¼Œåœ¨å¯»æ‰¾å¯¹åº”çš„è§£æ³•æ—¶ï¼Œæˆ‘å‘ç°äº†å°¼å…‹Â·è´é‡Œï¼ˆNick Berryï¼‰çš„åŸºäºå‡ ä½•çš„è§£é‡Šå’Œæ­¤è§†é¢‘ã€‚\nè€å®è¯´ï¼Œæˆ‘å¯¹è¿™ç§è§£å†³æ–¹æ¡ˆä¸æ˜¯100ï¼…æ»¡æ„ï¼Œå› ä¸ºæˆ‘ä¸å®Œå…¨ç†è§£äº†å®ƒã€‚ åœ¨é‡æ–°é˜…è¯»æˆ‘å†™çš„å†…å®¹ä¹‹åï¼ŒHadrienï¼ˆå®¡é˜…è€…ä¹‹ä¸€ï¼‰å’Œæˆ‘å‘ç°æˆ‘çš„è§£é‡Šæœ‰äº›ä¸æ˜¯é‚£ä¹ˆå®Œç¾ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œæˆ‘ä¼šæŠŠå®ƒç•™åœ¨è¿™é‡Œï¼Œä½†æˆ‘å»ºè®®æ‚¨ä¸è¦æ‰“æ‰°ï¼Œé™¤éæ‚¨éå¸¸å¥½å¥‡å¹¶ä¸”ä¸è¦ä»‹æ„ä¸€äº›æ··ä¹±ã€‚\nç°åœ¨ï¼Œä¸ºäº†è¿›è¡Œç®€å•çš„è§£é‡Šæ¸…æ¥šæ—‹è½¬çš„æ¦‚å¿µï¼Œæˆ‘å°†é‡‡ç”¨ æ­¤ä½ç½®å‘é‡è½åœ¨æ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªä½ç½®å‘é‡ä¸Š çš„è·¯çº¿ã€‚\nå‡è®¾ä½ åƒä¸‹å›¾ä¸€æ ·åœ¨å•ä½çŸ¢é‡ä¸Šè¿›è¡Œç¼©æ”¾ï¼š\nåŸºäºä¸‰è§’å‡½æ•°çš„è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å¾—åˆ°ï¼š $$ \\left. \\begin{pmatrix} 0\\ 1 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} \\cos \\theta \\ \\sin \\theta \\end{pmatrix} \\middle| \\begin{pmatrix} 1\\ 0 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} - \\sin \\theta \\ \\cos \\theta \\end{pmatrix} \\right. $$ ä¹Ÿå°±æ˜¯ï¼š $$ \\begin{pmatrix} x\\ y \\end{pmatrix} = \\begin{pmatrix} 1\\ 0 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} a.x+b.y\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} \\cos \\theta \\ \\sin \\theta \\end{pmatrix} $$\n$$ \\begin{pmatrix} x\\ y \\end{pmatrix} = \\begin{pmatrix} 0\\ 1 \\end{pmatrix} \\text{ lands on } \\begin{pmatrix} a.x+b.y\\ c.x+d.y \\end{pmatrix} = \\begin{pmatrix} - \\sin \\theta \\ \\cos \\theta \\end{pmatrix} $$\næˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºï¼š $$ \\left. \\begin{pmatrix} 1.a+0.b\\ 1.c+0.d \\end{pmatrix} = \\begin{pmatrix} \\cos \\theta \\ \\sin \\theta \\end{pmatrix} \\middle| \\begin{pmatrix} 0.a+1.b\\ 0.c+1.d \\end{pmatrix} = \\begin{pmatrix} - \\sin \\theta \\ \\cos \\theta \\end{pmatrix} \\right. $$ å¾ˆæ˜æ˜¾å¯ä»¥å¾—å‡ºï¼š $a = \\cos\\left(\\theta \\right), b = - \\sin \\left( \\theta \\right), c = \\sin \\left( \\theta \\right) ï¼Œè€Œ\\ d = \\cos \\left( \\theta \\right)$ ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°æˆ‘ä»¬çš„æ—‹è½¬çŸ©é˜µï¼š $$ \\begin{pmatrix} a \u0026amp; b\\c \u0026amp; d \\end{pmatrix} = \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta\\ \\sin \\theta \u0026amp; \\cos \\theta \\end{pmatrix} $$ æ­å–œä½ ï¼ç°åœ¨ä½ å·²ç»çŸ¥é“äº†å¦‚ä½•å®šä¹‰ç¼©æ”¾ï¼Œä»¿å°„ï¼Œå‰ªåˆ‡å’Œæ—‹è½¬çš„å˜æ¢çŸ©é˜µã€‚ é‚£ä¹ˆï¼Œè¿˜å·®ä»€ä¹ˆå‘¢ï¼Ÿ\n3x3 å˜æ¢çŸ©é˜µ å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œï¼Œç»è¿‡ä¸Šé¢çš„è§£é‡Šï¼Œä½ å¯èƒ½çŸ¥é“äº†ä¸Šè¿°çš„å•ä¸ªå˜æ¢ä¸ºä»€ä¹ˆä¼šèµ·ä½œç”¨ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å…¶å®æ˜¯ç†è§£è¿™äº›ä»¿å°„å˜æ¢ï¼Œç„¶ååœ¨ä»£ç ä¸­åº”ç”¨å®ƒä»¬ã€‚\nä»…ä»…çŸ¥é“å•ä¸ªå˜æ¢çš„ç”¨æ³•ä¹Ÿæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å˜æ¢çŸ©é˜µé•¿ä»€ä¹ˆæ ·ï¼Œå¹¶ä¸”çŸ¥é“å¦‚ä½•åœ¨ç»™å®šçš„å‡ ä¸ªä½ç½®çŸ¢é‡çš„æƒ…å†µä¸‹è®¡ç®—ä¸€ä¸ªå˜æ¢çŸ©é˜µï¼Œäº†è§£è¿™äº›å°±å·²ç»éå¸¸äº†ä¸èµ·äº†ã€‚\nä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼šæˆ‘ä»¬èƒ½é€šè¿‡ $2\\times2$ çš„çŸ©é˜µæ‰€åšçš„æ“ä½œå¤ªå°‘äº†ï¼Œä½ åªèƒ½åšä¸€äº›æˆ‘ä»¬ä¹‹é—´è§åˆ°è¿‡çš„å˜æ¢ï¼š\nScaling - ç¼©æ”¾ Reflexion - ä»¿å°„ Shearing - å‰ªåˆ‡ Rotation - æ—‹è½¬ é‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ä»€ä¹ˆï¼Ÿ ç­”æ¡ˆæ˜¯ï¼š å¹³ç§»-translations\nå¹³ç§»éå¸¸æœ‰ç”¨ï¼Œæ¯”æ–¹è¯´å½“ç”¨æˆ·è§¦æ‘¸å›¾åƒå¹¶ç§»åŠ¨æ‰‹æŒ‡æ—¶ï¼Œå›¾ç‰‡éœ€è¦èƒ½è·Ÿéšç”¨æˆ·çš„æ‰‹åŠ¿ä¸€èµ·ç§»åŠ¨ï¼›å¹³ç§»å¯ä»¥è¢«å®šä¹‰ä¸ºä¸¤ä¸ªçŸ©é˜µçš„åŠ æ³•ï¼š $$ \\begin{pmatrix} x^{\u0026rsquo;} \\ y^{\u0026rsquo;} \\end{pmatrix} = \\begin{pmatrix} x \\ y \\end{pmatrix} + \\begin{pmatrix} t_x \\ t_y \\end{pmatrix} $$ ä¸è¿‡ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿè”åˆæ‰§è¡Œå¤šç§å˜æ¢ï¼ˆå¦‚ä»¥ä¸€ä¸ªä¸æ˜¯åŸç‚¹çš„ç‚¹ä¸ºä¸­å¿ƒè¿›è¡Œç¼©æ”¾ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å°†å¹³ç§»è¡¨ç¤ºä¸ºçŸ©é˜µä¹˜æ³•çš„æ–¹å¼ã€‚\nè¿™é‡Œå¯èƒ½æ¶‰åŠåˆ° [Homogeneous coordinates](https://en.wikipedia.org/wiki/Homogeneous_coordinates çš„ä¸–ç•Œï¼Œä¸è¿‡ä½ å¯ä»¥ä¸ç”¨äº†è§£è¿™äº›ã€‚\nè¿™é‡Œå…³è”æ¦‚å¿µå°±æ˜¯ï¼š\næˆ‘ä»¬ä½¿ç”¨çš„å¹³é¢ç¬›å¡å°”åæ ‡å¹³é¢å®é™…ä¸Šåªæ˜¯ä¸‰ç»´åæ ‡ç©ºé—´ä¸­ä¼—å¤šå¹³é¢ä¸­çš„ä¸€ä¸ªï¼Œå…¶ $z$ åæ ‡ ä¸º 1 å¯¹äºä¸‰ç»´ç©ºé—´çš„ä»»æ„ç‚¹ $(x,y,z)$ æ¥è¯´ï¼ŒæŠ•å½±ç©ºé—´ä¸­ç©¿è¿‡è¿™ä¸ªç‚¹å’ŒåŸç‚¹çš„çº¿ï¼ŒåŒæ—¶ä¹Ÿä¼šç©¿è¿‡ä½¿ç”¨ç›¸åŒçš„ç¼©æ”¾æ¯”ä¾‹å¯¹ $x,y,z$ è¿›è¡Œç¼©æ”¾åçš„ç‚¹ï¼› è¿™æ¡çº¿ä¸Šçš„ä»»æ„ç‚¹çš„åæ ‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š$\\left(\\frac{x}{z}, \\frac{y}{z}, z\\right)$ æˆ‘åœ¨æœ¬æ–‡çš„æœ«å°¾é™„ä¸Šäº†æˆ‘æ”¶é›†çš„ç›¸å…³æ–‡ç« åŠåšå®¢çš„é“¾æ¥ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç»§ç»­æ·±å…¥é˜…è¯»ã€‚\næˆ‘ä»¬ç°åœ¨ä¸ä»…å¯ä»¥å°†ç¬›å¡å°”åæ ‡ç³»ï¼ˆ$z=1$ï¼‰ä¸­çš„ç‚¹è¡¨ç¤ºä¸ºä¸€ä¸ª $2\\times1$ çš„çŸ©é˜µï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ª $3\\times1$çš„çŸ©é˜µï¼š $$ \\begin{pmatrix} x\\ y \\end{pmatrix} \\Leftrightarrow \\begin{pmatrix} x\\ y\\ 1 \\end{pmatrix} $$ ä¸è¿‡è¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬éœ€è¦é‡æ–°å®šä¹‰æˆ‘ä»¬ä¹‹å‰å¾—åˆ°çš„å˜æ¢çŸ©é˜µï¼Œå› ä¸ºä¸€ä¸ª $3\\times1$ çš„ä½ç½®çŸ¢é‡ä¹˜ä»¥ä¸€ä¸ª $2\\times2$ çš„å˜æ¢çŸ©é˜µæ˜¯æœªå®šä¹‰çš„ã€‚\næˆ‘ä»¬å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªå˜æ¢çŸ©é˜µ $\\mathbf{A} = \\begin{pmatrix} a \u0026amp; b \u0026amp; c \\ d \u0026amp; e \u0026amp;f \\ g\u0026amp;h \u0026amp;i \\end{pmatrix}$\nåŒå‰é¢çš„ç« èŠ‚ä¸€æ ·ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç‚¹ $\\mathbf{P}{(x,y,z)}$ ï¼Œè¿™ä¸ªç‚¹ä»£è¡¨äº†ç¬›å¡å°”å¹³é¢ä¸­çš„ä»»æ„ç‚¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªå˜æ¢çŸ©é˜µçŸ©é˜µèƒ½å¤Ÿå°†åæ ‡ç‚¹è½¬æ¢æˆ $\\mathbf{P}^{\u0026rsquo;}{(x^{\u0026rsquo;},y^{\u0026rsquo;},z^{\u0026rsquo;})}$ ï¼Œå…¶ä¸­å˜æ¢åçš„ç‚¹çš„ $z^{\u0026rsquo;} = z$ : $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime}\\z^{\\prime} \\end{pmatrix} = \\mathbf{A} . \\begin{pmatrix} x\\y\\z \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} . \\begin{pmatrix} x\\y\\z \\end{pmatrix} $$\nç¼©æ”¾ ç¼©æ”¾çš„çŸ©é˜µå½¢å¼å¦‚ä¸‹ï¼š $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime}\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} s_{x}.x\\s_{y}.y\\z \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} . \\begin{pmatrix} x\\y\\z \\end{pmatrix} $$ ä¸ºäº†æ‰¾åˆ°çŸ©é˜µ $A$ ï¼Œæˆ‘ä»¬è¿›è¡Œçº¿æ€§æ–¹ç¨‹æ±‚è§£ï¼š $$ \\left. \\begin{aligned} x^{\\prime} \u0026amp;= s_{x} . x\\ s_{x} . x \u0026amp;= a . x + b . y + c . z\\\\ \\Rightarrow a \u0026amp;= s_{x} \\text{ ä¸” }\\ b \u0026amp;= 0 \\text{ ä¸” }\\ c \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= s_{y} . y\\ s_{y} . y \u0026amp;= d . x + e . y + f + z\\\\ \\Rightarrow e \u0026amp;= s_{y} \\text{ ä¸” }\\ d \u0026amp;= 0 \\text{ ä¸” }\\ f \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} z^{\\prime} \u0026amp;= z\\ \\Rightarrow z \u0026amp;= g . x + h . y + i + z\\ \\Rightarrow g \u0026amp;= 0 \\text{ ä¸” }\\ h \u0026amp;= 0 \\text{ ä¸” }\\ i \u0026amp;= 1 \\end{aligned} \\right. $$ ç¼©æ”¾æ¯”ä¾‹ $\\left( S_x, S_y \\right)$ çš„ $3 \\times 3$ çš„çŸ©é˜µä¸ºï¼š $$ \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} = \\begin{pmatrix} s_{x} \u0026amp; 0 \u0026amp;0\\0 \u0026amp; s_{y} \u0026amp; 0\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix} $$\nReflexion å¯¹å›´ç»• $x$ è½´çš„ä»¿å°„çš„çŸ©é˜µ $\\mathbf{A}$ å¦‚ä¸‹ï¼š $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime}\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} x\\-y\\z \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} . \\begin{pmatrix} x\\y\\z \\end{pmatrix} $$ åŒç†ï¼Œæ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„ï¼Œå¾—åˆ°å˜æ¢çŸ©é˜µå„ä¸ªæ¡ç›®çš„å€¼ï¼š $$ \\left. \\begin{aligned} x^{\\prime} \u0026amp;= x\\ x \u0026amp;= a . x + b . y + c . z\\\\ \\Rightarrow a \u0026amp;= 1 \\text{ ä¸” }\\ b \u0026amp;= 0 \\text{ ä¸” }\\ c \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= -y\\ -y \u0026amp;= d . x + e . y + f . z\\\\ \\Rightarrow d \u0026amp;= 0 \\text{ ä¸” }\\ e \u0026amp;= -1 \\text{ ä¸” }\\ f \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} z^{\\prime} \u0026amp;= z\\ z \u0026amp;= g . x + h . y + i . z\\\\ \\Rightarrow g \u0026amp;= 0 \\text{ ä¸” }\\ h \u0026amp;= 0 \\text{ ä¸” }\\ i \u0026amp;= 1 \\end{aligned} \\right. $$ æ ¹æ®æ±‚è§£ç»“æœï¼Œå¾—åˆ°å›´ç»• $x$ è½´çš„å˜æ¢çŸ©é˜µä¸ºï¼š $$ \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; 0\\ 0 \u0026amp; -1 \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} $$ å¯¹å›´ç»• $y$ è½´çš„ä»¿å°„çš„çŸ©é˜µ $\\mathbf{A}$ çœ‹å¦‚ä¸‹ï¼š $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime}\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} x\\-y\\z \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} . \\begin{pmatrix} x\\y\\z \\end{pmatrix} $$ æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„ï¼š $$ \\left. \\begin{aligned} x^{\\prime} \u0026amp;= -x\\ -x \u0026amp;= a . x + b . y + c . z\\\\ \\Rightarrow a \u0026amp;= -1 \\text{ and }\\ b \u0026amp;= 0 \\text{ and }\\ c \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= y\\ y \u0026amp;= d . x + e . y + f . z\\\\ \\Rightarrow d \u0026amp;= 0 \\text{ and }\\ e \u0026amp;= 1 \\text{ and }\\ f \u0026amp;= 0 \\end{aligned} \\middle| \\begin{aligned} z^{\\prime} \u0026amp;= z\\ z \u0026amp;= g . x + h . y + i . z\\\\ \\Rightarrow g \u0026amp;= 0 \\text{ and }\\ h \u0026amp;= 0 \\text{ and }\\ i \u0026amp;= 1 \\end{aligned} \\right. $$\né‚£ä¹ˆï¼Œå›´ç»• $y$ è½´çš„å˜æ¢çŸ©é˜µä¸ºï¼š $$ \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} = \\begin{pmatrix} -1 \u0026amp; 0 \u0026amp; 0\\ 0 \u0026amp; 1 \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} $$\nShearing æ²¿ç€ $x$ æ–¹å‘å‰ªåˆ‡çš„è½¬æ¢çŸ©é˜µï¼š $$ \\begin{aligned} \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} \u0026amp;= \\begin{pmatrix} 1 \u0026amp; \\tan \\alpha \u0026amp; 0\\ 0 \u0026amp; 1 \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 1 \u0026amp; k_{x} \u0026amp; 0\\ 0 \u0026amp; 1 \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp; \\text{å…¶ä¸­ } k \\text{ æ˜¯ shearing å¸¸é‡} \\end{aligned} $$ åŒæ ·çš„ï¼Œæ²¿ç€ y æ–¹å‘å‰ªåˆ‡çš„è½¬æ¢çŸ©é˜µï¼š $$ \\begin{aligned} \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; 0\\ \\tan \\beta \u0026amp; 1 \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; 0\\ k_{y} \u0026amp; 1 \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp; \\text{å…¶ä¸­ } k \\text{ æ˜¯ shearing å¸¸é‡} \\end{aligned} $$\næ—‹è½¬ ä½¿ç”¨ç›¸åŒçš„è®¡ç®—æ”¾å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºæ–°çš„æ—‹è½¬çŸ©é˜µæ˜¯åŸºäºæˆ‘ä»¬ä¹‹å‰çš„ $2\\times2$ çš„æ—‹è½¬çŸ©é˜µï¼Œæ·»åŠ äº†ä¸€åˆ—ï¼Œè¯¥åˆ—çš„æ¡ç›®æ˜¯ï¼š$0,0$ å’Œ $1$ã€‚ $$ \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} = \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; 0\\ \\sin \\theta \u0026amp; \\cos \\theta \u0026amp; 0\\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} $$\nå¹³ç§» å¹³ç§»æ˜¯æœ€æœ‰æ„æ€çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª $3\\times3$ çš„å¹³ç§»çŸ©é˜µï¼Œæˆ‘ä»¬éœ€è¦çš„çŸ©é˜µ $\\mathbf{A}$ éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š $$ \\begin{pmatrix} x^{\\prime}\\y^{\\prime}\\z^{\\prime} \\end{pmatrix} = \\begin{pmatrix} x+t_{x}\\y+t_{y}\\z \\end{pmatrix} = \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} . \\begin{pmatrix} x\\y\\z \\end{pmatrix} $$ æ±‚è§£çº¿æ€§æ–¹ç¨‹ç»„ï¼š $$ \\left. \\begin{aligned} x^{\\prime} \u0026amp;= x + t_{x} \\ x + t_{x} \u0026amp;= a . x + b . y + c . z\\\\ \\Rightarrow a \u0026amp;= 1 \\text{ ä¸” }\\ b \u0026amp;= 0 \\text{ ä¸” }\\ c \u0026amp;= t_{x} \\end{aligned} \\middle| \\begin{aligned} y^{\\prime} \u0026amp;= y + t_{y}\\ y + t_{y} \u0026amp;= d . x + e . y + f . z\\\\ \\Rightarrow d \u0026amp;= 0 \\text{ ä¸” }\\ e \u0026amp;= 1 \\text{ ä¸” }\\ f \u0026amp;= t_{y} \\end{aligned} \\middle| \\begin{aligned} z^{\\prime} \u0026amp;= z\\ z \u0026amp;= g . x + h . y + i . z\\\\ \\Rightarrow g \u0026amp;= 0 \\text{ ä¸” }\\ h \u0026amp;= 0 \\text{ ä¸” }\\ i \u0026amp;= 1 \\end{aligned} \\right. $$ å¾—åˆ°çŸ©é˜µ $\\mathbf{A}$: $$ \\begin{pmatrix} a \u0026amp; b \u0026amp; c\\d \u0026amp; e \u0026amp; f\\g \u0026amp; h \u0026amp; i\\end{pmatrix} = \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x}\\0 \u0026amp; 1 \u0026amp; t_{y}\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix} $$\nçŸ©é˜µæ€»ç»“(Matrices wrap-up) å®é™…ä¸Šï¼Œä½ ä¸å¿…æ¯æ¬¡éƒ½åšè¿™äº›çº¿æ€§ä»£æ•°çš„è®¡ç®—ï¼Œä½ åªéœ€è¦ä½¿ç”¨å®ƒä»¬å°±å¯ä»¥äº†ã€‚\næ€»ç»“ï¼š\nå¹³ç§»çŸ©é˜µï¼š$\\begin{pmatrix}1 \u0026amp; 0 \u0026amp; t_{x}\\0 \u0026amp; 1 \u0026amp; t_{y}\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix}$ ç¼©æ”¾çŸ©é˜µï¼š$\\begin{pmatrix}s_{x} \u0026amp; 0 \u0026amp; 0\\0 \u0026amp; s_{y} \u0026amp; 0\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix}$ å‰ªåˆ‡çŸ©é˜µï¼š$\\begin{pmatrix}1 \u0026amp; \\tan \\alpha \u0026amp; 0\\\\tan \\beta \u0026amp; 1 \u0026amp; 0\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix} = \\begin{pmatrix}1 \u0026amp; k_{x} \u0026amp; 0\\k_{y} \u0026amp; 1 \u0026amp; 0\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix}$ æ—‹è½¬çŸ©é˜µï¼š $\\begin{pmatrix}\\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; 0\\\\sin \\theta \u0026amp; \\cos \\theta \u0026amp; 0\\0 \u0026amp; 0 \u0026amp; 1\\end{pmatrix}$ ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“çš„å®šä¹‰æˆ‘ä»¬è‡ªå·±éœ€è¦çš„çŸ©é˜µï¼Œè€Œä¸”ä½ ä¹ŸçŸ¥é“äº†å®ƒå¦‚ä½•å·¥ä½œã€‚\næœ€åä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„å˜æ¢éƒ½æ˜¯ä»¥åŸç‚¹ä¸ºä¸­å¿ƒã€‚å¦‚æœæˆ‘ä»¬éœ€è¦ä¸ä»¥åŸç‚¹ä¸ºä¸­å¿ƒäº†ï¼Ÿæ¯”æ–¹è¯´ä»¥æŒ‡å®šç‚¹è¿›è¡Œç¼©æ”¾ï¼Œä»¥æŸä¸ªç‚¹å¯¹å›¾åƒè¿›è¡Œæ—‹è½¬ï¼Œè¿™è¦æ€ä¹ˆåšäº†ï¼Ÿ\nè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯ï¼š ç»„åˆï¼ˆcompositionï¼‰ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨å‡ ä¸ªå˜æ¢æ¥ç»„åˆæˆæˆ‘ä»¬éœ€è¦çš„å˜æ¢ï¼›\nç»„åˆå®ä¾‹ï¼š pinch-zoom æƒ³è±¡ä½ æœ‰ä¸€ä¸ªå½¢çŠ¶ï¼ˆæ¯”æ–¹è¯´æ­£æ–¹å½¢ï¼‰ï¼Œä½ æƒ³è¦ä»¥æ­£æ–¹å½¢çš„ä¸­å¿ƒè¿›è¡Œç¼©æ”¾ï¼Œç”¨äºæ¨¡æ‹Ÿæåˆç¼©æ”¾è¡Œä¸ºã€‚\nå˜æ¢å¯ä»¥æŒ‰å¦‚ä¸‹åºåˆ—è¿›è¡Œç»„åˆï¼š\nç§»åŠ¨é”šç‚¹åˆ°åŸç‚¹: $\\left( -t_{x}, -t_{y} \\right)$ ä½¿ç”¨ $\\left( s_{x}, s_{y} \\right)$ è¿›è¡Œç¼©æ”¾ å°†é”šç‚¹ç§»åŠ¨å›æ¥ï¼š$\\left( t_{x}, t_{y} \\right)$ å…¶ä¸­ $t$ æ˜¯æˆ‘ä»¬ç¼©æ”¾å˜æ¢çš„é”šç‚¹ï¼ˆè¿™é‡Œæ˜¯æ­£æ–¹å½¢çš„ä¸­å¿ƒç‚¹ï¼‰ã€‚\næˆ‘ä»¬çš„å˜æ¢åºåˆ—åŒ…æ‹¬ä¸‹é¢çš„ç¬¬ä¸€ä¸ªå¹³ç§»çŸ©é˜µ $\\mathbf{C}$ ï¼Œç¼©æ”¾çŸ©é˜µ $\\mathbf{B}$ ï¼Œè¿˜æœ‰åé¢çš„ä¸€ä¸ªå¹³ç§»çŸ©é˜µ $\\mathbf{A}$ $$ \\mathbf{C} = \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; -t_{x} \\ 0 \u0026amp; 1 \u0026amp; -t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} \\text{ , } \\mathbf{B} = \\begin{pmatrix} s_{x} \u0026amp; 0 \u0026amp; 0 \\ 0 \u0026amp; s_{y} \u0026amp; 0 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} \\text{ è¿˜æœ‰ } \\mathbf{A} = \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x} \\ 0 \u0026amp; 1 \u0026amp; t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} $$ å› ä¸ºçŸ©é˜µä¹˜æ³•è¿ç®—æ˜¯ä¸å¯äº¤æ¢çš„ï¼Œé¡ºåºå¾ˆé‡è¦ï¼Œå› æ­¤æˆ‘ä»¬å°†åè¿‡æ¥åº”ç”¨è¿™äº›çŸ©é˜µã€‚\næˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ç»„åˆç»“æœï¼š $$ \\begin{aligned} \\mathbf{A} . \\mathbf{B} . \\mathbf{C} \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x} \\ 0 \u0026amp; 1 \u0026amp; t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} s_{x} \u0026amp; 0 \u0026amp; 0 \\ 0 \u0026amp; s_{y} \u0026amp; 0 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; -t_{x} \\ 0 \u0026amp; 1 \u0026amp; -t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x} \\ 0 \u0026amp; 1 \u0026amp; t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} s_{x} \u0026amp; 0 \u0026amp; -s_{x}.t_{x} \\ 0 \u0026amp; s_{y} \u0026amp; -s_{y}.t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \\mathbf{A} . \\mathbf{B} . \\mathbf{C} \u0026amp;= \\begin{pmatrix} s_{x} \u0026amp; 0 \u0026amp; -s_{x}.t_{x} + t_{x} \\ 0 \u0026amp; s_{y} \u0026amp; -s_{y}.t_{y} + t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} \\end{aligned} $$ å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹æ­£æ–¹å½¢ï¼Œå…¶å„ç‚¹åæ ‡å¦‚ä¸‹ï¼š $$ \\begin{pmatrix}x_{1} \u0026amp; x_{2} \u0026amp; x_{3} \u0026amp; x_{4}\\y_{1} \u0026amp; y_{2} \u0026amp; y_{3} \u0026amp; y_{4}\\1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1\\end{pmatrix} = \\begin{pmatrix}2 \u0026amp; 4 \u0026amp; 4 \u0026amp; 2\\1 \u0026amp; 1 \u0026amp; 3 \u0026amp; 3\\1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1\\end{pmatrix} $$ æˆ‘ä»¬æƒ³è¦ä»¥å®ƒçš„ä¸­å¿ƒç‚¹åº”ç”¨ä¸¤å€çš„ç¼©æ”¾ï¼š\næ–°çš„åæ ‡å°†ä¼šæ˜¯ä¸‹é¢è¿™æ ·ï¼š $$ \\begin{aligned} \\begin{pmatrix} x_{1}^{\\prime} \u0026amp; x_{2}^{\\prime} \u0026amp; x_{3}^{\\prime} \u0026amp; x_{4}^{\\prime}\\ y_{1}^{\\prime} \u0026amp; y_{2}^{\\prime} \u0026amp; y_{3}^{\\prime} \u0026amp; y_{4}^{\\prime}\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix} \u0026amp;= \\begin{pmatrix} s_{x} \u0026amp; 0 \u0026amp; -s_{x}.t_{x} + t_{x} \\ 0 \u0026amp; s_{y} \u0026amp; -s_{y}.t_{y} + t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} x_{1} \u0026amp; x_{2} \u0026amp; x_{3} \u0026amp; x_{4}\\ y_{1} \u0026amp; y_{2} \u0026amp; y_{3} \u0026amp; y_{4}\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 2 \u0026amp; 0 \u0026amp; -2.3 + 3 \\ 0 \u0026amp; 2 \u0026amp; -2.2 + 2 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} 2 \u0026amp; 4 \u0026amp; 4 \u0026amp; 2\\ 1 \u0026amp; 1 \u0026amp; 3 \u0026amp; 3\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 2 \u0026amp; 0 \u0026amp; -3 \\ 0 \u0026amp; 2 \u0026amp; -2 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} 2 \u0026amp; 4 \u0026amp; 4 \u0026amp; 2\\ 1 \u0026amp; 1 \u0026amp; 3 \u0026amp; 3\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix}\\\\ \\begin{pmatrix} x_{1}^{\\prime} \u0026amp; x_{2}^{\\prime} \u0026amp; x_{3}^{\\prime} \u0026amp; x_{4}^{\\prime}\\ y_{1}^{\\prime} \u0026amp; y_{2}^{\\prime} \u0026amp; y_{3}^{\\prime} \u0026amp; y_{4}^{\\prime}\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix} \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 5 \u0026amp; 5 \u0026amp; 1\\ 0 \u0026amp; 0 \u0026amp; 4 \u0026amp; 4\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix} \\end{aligned} $$ ç»„åˆç¤ºä¾‹ï¼š æ—‹è½¬å›¾åƒ å‡è®¾ä½ æœ‰ä¸€ä¸ªå›¾åƒè®¾ç½®åœ¨viewä¸­ï¼Œä½†æ˜¯åŸç‚¹å¹¶ä¸æ˜¯viewçš„ä¸­å¿ƒç‚¹ï¼Œé€šå¸¸åŸç‚¹å¯èƒ½åœ¨å·¦ä¸Šè§’ï¼Œä½†æ˜¯ä½ å¸Œæœ›èƒ½å¤Ÿå›´ç»•viewçš„ä¸­ç‚¹æ¥æ—‹è½¬å›¾åƒï¼›\nè¿™ä¸ªå˜æ¢çš„ç»„åˆåŒ…æ‹¬å¦‚ä¸‹åºåˆ—ï¼š\nç§»åŠ¨é”šç‚¹åˆ°åŸç‚¹ï¼š $\\left( -t_{x}, -t_{y} \\right)$ æ—‹è½¬ $\\theta$ è§’åº¦ ç§»åŠ¨å›é”šç‚¹: $\\left( t_{x}, t_{y} \\right)$ å…¶ä¸­ $t$ æ˜¯æˆ‘ä»¬æ—‹è½¬å˜æ¢çš„é”šç‚¹ã€‚\nåŒæ ·çš„ï¼Œå˜æ¢è¿‡ç¨‹æœ‰å¦‚ä¸‹ä¸‰ä¸ªçŸ©é˜µï¼Œç¬¬ä¸€ä¸ªå¹³ç§»çŸ©é˜µ $\\mathbf{C}$ ï¼Œæ—‹è½¬çŸ©é˜µ $\\mathbf{B}$ ,è¿˜æœ‰åé¢çš„ä¸€ä¸ªå¹³ç§»çŸ©é˜µ$\\mathbf{A}$ ï¼š $$ \\mathbf{C} = \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; -t_{x} \\ 0 \u0026amp; 1 \u0026amp; -t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} \\text{ , } \\mathbf{B} = \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; 0 \\ \\sin \\theta \u0026amp; \\cos \\theta \u0026amp; 0 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} \\text{ è¿˜æœ‰ } \\mathbf{A} = \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x} \\ 0 \u0026amp; 1 \u0026amp; t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} $$ æˆ‘ä»¬å¯ä»¥ç»„åˆå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š $$ \\begin{aligned} \\mathbf{A} . \\mathbf{B} . \\mathbf{C} \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x} \\ 0 \u0026amp; 1 \u0026amp; t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; 0 \\ \\sin \\theta \u0026amp; \\cos \\theta \u0026amp; 0 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; -t_{x} \\ 0 \u0026amp; 1 \u0026amp; -t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 1 \u0026amp; 0 \u0026amp; t_{x} \\ 0 \u0026amp; 1 \u0026amp; t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; -\\cos \\theta.t_{x} +\\sin \\theta.t_{y} \\ \\sin \\theta \u0026amp; \\cos \\theta \u0026amp; -\\sin \\theta.t_{x} -\\cos \\theta.t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix}\\\\ \\mathbf{A} . \\mathbf{B} . \\mathbf{C} \u0026amp;= \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; -\\cos \\theta.t_{x} +\\sin \\theta.t_{y} + t_{x} \\ \\sin \\theta \u0026amp; \\cos \\theta \u0026amp; -\\sin \\theta.t_{x} -\\cos \\theta.t_{y} + t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} \\end{aligned} $$ å‡è®¾æˆ‘ä»¬çš„viewçš„èŒƒå›´æ˜¯ä¸€ä¸ªæ­£æ–¹å½¢ï¼Œé¡¶ç‚¹åæ ‡å¦‚ä¸‹ï¼š $$ \\begin{pmatrix}x_{1} \u0026amp; x_{2} \u0026amp; x_{3} \u0026amp; x_{4}\\y_{1} \u0026amp; y_{2} \u0026amp; y_{3} \u0026amp; y_{4}\\1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1\\end{pmatrix} = \\begin{pmatrix}2 \u0026amp; 4 \u0026amp; 4 \u0026amp; 2\\1 \u0026amp; 1 \u0026amp; 3 \u0026amp; 3\\1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1\\end{pmatrix} $$ æˆ‘ä»¬å¸Œæœ›å›´ç»•å…¶ä¸­å¿ƒæ—‹è½¬ $\\theta = 90^{\\circ}$ ï¼Œé‚£ä¹ˆæ–°çš„åæ ‡æ˜¯ï¼š $$ \\begin{aligned} \\begin{pmatrix} x_{1}^{\\prime} \u0026amp; x_{2}^{\\prime} \u0026amp; x_{3}^{\\prime} \u0026amp; x_{4}^{\\prime}\\ y_{1}^{\\prime} \u0026amp; y_{2}^{\\prime} \u0026amp; y_{3}^{\\prime} \u0026amp; y_{4}^{\\prime}\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix} \u0026amp;= \\begin{pmatrix} \\cos \\theta \u0026amp; -\\sin \\theta \u0026amp; -\\cos \\theta.t_{x} +\\sin \\theta.t_{y} + t_{x} \\ \\sin \\theta \u0026amp; \\cos \\theta \u0026amp; -\\sin \\theta.t_{x} -\\cos \\theta.t_{y} + t_{y} \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} x_{1} \u0026amp; x_{2} \u0026amp; x_{3} \u0026amp; x_{4}\\ y_{1} \u0026amp; y_{2} \u0026amp; y_{3} \u0026amp; y_{4}\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 0 \u0026amp; -1 \u0026amp; -0.3+1.2+3 \\ 1 \u0026amp; 0 \u0026amp; -1.3-0.2+2 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} 2 \u0026amp; 4 \u0026amp; 4 \u0026amp; 2\\ 1 \u0026amp; 1 \u0026amp; 3 \u0026amp; 3\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix}\\\\ \u0026amp;= \\begin{pmatrix} 0 \u0026amp; -1 \u0026amp; 5 \\ 1 \u0026amp; 0 \u0026amp; -1 \\ 0 \u0026amp; 0 \u0026amp; 1 \\end{pmatrix} . \\begin{pmatrix} 2 \u0026amp; 4 \u0026amp; 4 \u0026amp; 2\\ 1 \u0026amp; 1 \u0026amp; 3 \u0026amp; 3\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix}\\\\ \\begin{pmatrix} x_{1}^{\\prime} \u0026amp; x_{2}^{\\prime} \u0026amp; x_{3}^{\\prime} \u0026amp; x_{4}^{\\prime}\\ y_{1}^{\\prime} \u0026amp; y_{2}^{\\prime} \u0026amp; y_{3}^{\\prime} \u0026amp; y_{4}^{\\prime}\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix} \u0026amp;= \\begin{pmatrix} 4 \u0026amp; 4 \u0026amp; 2 \u0026amp; 2\\ 1 \u0026amp; 3 \u0026amp; 3 \u0026amp; 1\\ 1 \u0026amp; 1 \u0026amp; 1 \u0026amp; 1 \\end{pmatrix} \\end{aligned} $$ èµ„æºåŠé“¾æ¥ All the Geogebra files Iâ€™ve used to generate the graphics and gifs Khan Academy algebra course on matrices A course on â€œAffine Transformationâ€ at The University of Texas at Austin A course on â€œComposing Transformationsâ€ at The Ohio State University A blogpost on â€œRotating imagesâ€ by Nick Berry A Youtube video course on â€œThe Rotation Matrixâ€ by Michael J. Ruiz Wikipedia on Homogeneous coordinates A blogpost on â€œExplaining Homogeneous Coordinates \u0026amp; Projective Geometryâ€ by Tom Dalling A blogpost on â€œHomogeneous Coordinatesâ€ by Song Ho Ahn A Youtube video course on â€œ2D transformations and homogeneous coordinatesâ€ by Tarun Gehlot 2D Transformations with Android and Java --- è¯‘è€…è¡¥å…… android çŸ©é˜µï¼š $$ \\begin{bmatrix} MSCALE_X \u0026amp; MSKEW_X \u0026amp; MTRANS_X \\ MSKEW_Y \u0026amp; MSCALE_Y \u0026amp; MTRANS_Y \\ MPERSP_0 \u0026amp; MPERSP_1 \u0026amp; MPERSP_2 \\ \\end{bmatrix} $$\nå­—æ®µ ç”¨é€” MSCALE_Xï¼ŒMSCALE_Y æ§åˆ¶Xè½´å’ŒYè½´æ–¹å‘çš„ç¼©æ”¾ MSKEW_Xï¼ŒMSKEW_Y æ§åˆ¶Xåæ ‡å’ŒYåæ ‡çš„æ‰­æ›²ç³»æ•°(æ—‹è½¬) MTRANS_Xï¼ŒMTRANS_Y æ§åˆ¶Xæ–¹å‘å’ŒYæ–¹å‘çš„çº¿æ€§å¹³ç§» MPERSP_0 , MPERSP_1 , MPERSP_2 MPERSP_0ã€MPERSP_1å’ŒMPERSP_2æ˜¯å…³äºé€è§†çš„æ§åˆ¶ matlab çŸ©é˜µè¿ç®— \u0026gt;\u0026gt;A = [4 3 ; 0 -5; 2 1 ; -6 8]\nA =\n4 3 0 -5 2 1 -6 8\n\u0026gt;\u0026gt;B = [7 1 3 ; -2 4 1]\nB =\n7 1 3 -2 4 1\n\u0026gt;\u0026gt;A*B\nans =\n22 16 15 10 -20 -5 12 6 7 -58 26 -10\n\u0026gt;\u0026gt;B*A\né”™è¯¯ä½¿ç”¨ * ç”¨äºçŸ©é˜µä¹˜æ³•çš„ç»´åº¦ä¸æ­£ç¡®ã€‚è¯·æ£€æŸ¥å¹¶ç¡®ä¿ç¬¬ä¸€ä¸ªçŸ©é˜µä¸­çš„åˆ—æ•°ä¸ç¬¬äºŒä¸ªçŸ©é˜µä¸­ çš„è¡Œæ•°åŒ¹é…ã€‚è¦æ‰§è¡ŒæŒ‰å…ƒç´ ç›¸ä¹˜ï¼Œè¯·ä½¿ç”¨ '.*'ã€‚\n\u0026gt;\u0026gt;A+B\nçŸ©é˜µç»´åº¦å¿…é¡»ä¸€è‡´ã€‚\n","permalink":"https://hanlyjiang.github.io/posts/android%E5%BC%80%E5%8F%91%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84%E7%9F%A9%E9%98%B5%E7%9F%A5%E8%AF%86/","summary":"\u003cp\u003eç¿»è¯‘å›½å¤–æ–‡ç« ï¼Œè¯¥æ–‡ç« ä»‹ç»äº†Androidå¼€å‘ä¸­çŸ©é˜µç›¸å…³çš„æ•°å­¦çŸ¥è¯†ï¼ŒåŒ…æ‹¬çŸ©é˜µæ˜¯ä»€ä¹ˆï¼ŸçŸ©é˜µåŠ æ³•åŠä¹˜æ³•è¿ç®—ï¼Œ2x2çŸ©é˜µçš„å˜æ¢ï¼Œæœ€åæ¼”è¿›ä¸ºAndroidä¸­ä½¿ç”¨çš„3x3çŸ©é˜µã€‚æ–‡ä¸­å›¾ç‰‡åŠåŠ¨å›¾æ¯”è¾ƒå¤šï¼Œç›¸å¯¹å¥½æ‡‚ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003cblockquote\u003e\n\u003cp\u003eåŸæ–‡é“¾æ¥ï¼šhttps://i-rant.arnaudbos.com/matrices-for-developers/#technical-challenge\u003c/p\u003e","title":"[è¯‘]Androidå¼€å‘æ‰€éœ€è¦çš„çŸ©é˜µçŸ¥è¯†"},{"content":"gradleæœ‰ä¸‰ç§ç¼–å†™æ’ä»¶çš„æ–¹å¼ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨åœ¨é¡¹ç›®ä¸­çš„buildSrcæ¨¡å—ä¸­ç¼–å†™æ’ä»¶çš„æ–¹å¼ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªåº”ç”¨äºAndroidé¡¹ç›®çš„æ ¹æ®flavorè¿‡æ»¤soåº“çš„gradleæ’ä»¶ï¼›\næ¦‚è¿° è‡ªå®šä¹‰gradleæ’ä»¶æœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼ï¼ˆğŸ”—é“¾æ¥ï¼‰ï¼š\nåœ¨buildscriptä¸­ç›´æ¥ç¼–å†™ï¼› åœ¨buildSrcé¡¹ç›®ä¸­ç¼–å†™æ’ä»¶ä»£ç ï¼› åœ¨ç‹¬ç«‹çš„é¡¹ç›®ä¸­ç¼–å†™æ’ä»¶ä»£ç ï¼› è¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨buildSrcæ–¹å¼å®ç°ä¸€ä¸ªgradleæ’ä»¶ã€‚\næ–°å»º buildSrc module gradleä¼šåœ¨é¡¹ç›®ä¸­å¯»æ‰¾åç§°ä¸ºbuildSrcæ¨¡å—ï¼Œå°†å…¶åŠ è½½ä¸ºgradleçš„æ’ä»¶ä»£ç ç›®å½•ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥é€šè¿‡èœå•æ–°å»ºä¸€ä¸ªåä¸º buildSrc çš„java/kotlinæ¨¡å—ã€‚\nç„¶ååœ¨build.gradleä¸­æ·»åŠ ç›¸å…³çš„plugin(java-gradle-plugin)åŠä¾èµ–ï¼š\nplugins { id \u0026#39;java\u0026#39; id \u0026#39;java-gradle-plugin\u0026#39; id \u0026#34;org.jetbrains.kotlin.jvm\u0026#34; version \u0026#39;1.3.61\u0026#39; } group = \u0026#34;io.github.hanlyjiang.gradle\u0026#34; version = \u0026#34;0.0.2\u0026#34; dependencies { testCompile group: \u0026#39;junit\u0026#39;, name: \u0026#39;junit\u0026#39;, version: \u0026#39;4.12\u0026#39; // æ·»åŠ androidç›¸å…³build toolsä¾èµ–ï¼Œä»¥ä¾¿ä½¿ç”¨ android gradle ç›¸å…³çš„API compile \u0026#39;com.android.tools.build:gradle:3.2.0\u0026#39; } ç¼–å†™æ’ä»¶ éœ€æ±‚ç®€ä»‹ **åº”ç”¨åœºæ™¯ï¼š**æˆ‘ä»¬çš„äº§å“ä¸­é›†æˆäº†ä¸¤ç§VPN SDKï¼Œä½†æ˜¯å…·ä½“åˆ°æ¯ä¸ªé¡¹ç›®ä¸Šé¢ï¼Œéƒ½åªä¼šè½åœ°åˆ°å…·ä½“çš„ä¸€ç§ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ’é™¤å¯¹åº”çš„SDKçš„SOåº“ä»¥å‡å°APPåŒ…å¤§å°ï¼Œä¸åŒçš„åœ°åŒºçš„æ‰“åŒ…é…ç½®é€šè¿‡flavoræ¥è¿›è¡ŒåŒºåˆ†é…ç½®ï¼Œå³æ¯ä¸ªåœ°åŒºä¼šå¯¹åº”ä¸åŒçš„flavorï¼›\néœ€æ±‚æå–ï¼š è¿™é‡Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦çš„æ˜¯èƒ½å¤Ÿæ ¹æ®flavorï¼Œåœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­ç§»é™¤æŒ‡å®šçš„soæ–‡ä»¶ï¼›\nå®ç°æ€è·¯ï¼š\nflavoré…ç½®æ–¹å¼ï¼šåœ¨flavorä¸­é…ç½®ä¸€ä¸ªbuildConfigFieldå­—æ®µï¼Œç”¨äºæŒ‡å®šæˆ‘ä»¬çš„flavoréœ€è¦çš„é…ç½®\n// é…ç½®VPNç±»å‹ buildConfigField \u0026#34;String\u0026#34;, \u0026#34;VPN_TYPE\u0026#34;, \u0026#34;\\\u0026#34;$VpnType.SANG_FOR\\\u0026#34;\u0026#34; æ’ä»¶é…ç½®ï¼šæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªso_excludeé…ç½®æ¥æŒ‡å®šå…·ä½“çš„excludeè§„åˆ™ï¼ŒåŒ…å«ä¸¤ä¸ªå­—æ®µã€‚\nbuildConfigFieldKey ç”¨äºæŒ‡å®šä¹‹å‰åœ¨flavorä¸­å®šä¹‰çš„é…ç½®ï¼› configMap ä¸ºä¸€ä¸ªé…ç½®è¡¨ï¼ŒæŒ‡å®šä¸Šé¢çš„å­—æ®µå¯å–çš„å€¼ï¼Œå³å¯¹åº”å€¼åº”è¯¥excludeçš„soæ–‡ä»¶åˆ—è¡¨ï¼› so_exclude { /** * ä½¿ç”¨VPN_TYPE æ¥è®¾ç½®soè¿‡æ»¤çš„è§„åˆ™ */ buildConfigFieldKey = \u0026#34;VPN_TYPE\u0026#34; configMap = [ (VpnType.H3C_iNode.name()): [ // æ–°åä¸‰è¿‡æ»¤æ·±ä¿¡æœçš„ \u0026#34;lib/armeabi-v7a/libauth_forward.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libhttps.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libpkcs12cert.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libsvpnservice.so\u0026#34; ], (VpnType.SANG_FOR.name()) : [ // æ·±ä¿¡æœè¿‡æ»¤æ–°åä¸‰çš„ \u0026#34;lib/armeabi-v7a/libies.so\u0026#34;, ], (VpnType.NONE.name()) : [ // å¦‚é…ç½®æˆ NONEï¼Œåˆ™è¿‡æ»¤æ‰æ‰€æœ‰çš„VPNçš„ // æ·±ä¿¡æœçš„so \u0026#34;lib/armeabi-v7a/libauth_forward.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libhttps.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libpkcs12cert.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libsvpnservice.so\u0026#34;, // inodeçš„so \u0026#34;lib/armeabi-v7a/libies.so\u0026#34;, ] ] } å®šä¹‰æ’ä»¶åŠä½¿ç”¨æ’ä»¶ç®€ä»‹ æ’ä»¶éœ€è¦ç»§æ‰¿ org.gradle.api.Pluginï¼Œå¯åœ¨Pluginå¯¹æ„å»ºæµç¨‹è¿›è¡Œè‡ªå®šä¹‰ï¼ˆå¦‚ï¼šåˆ›å»ºä»»åŠ¡ï¼Œå®šä¹‰ä»»åŠ¡å…³ç³»ï¼Œä¿®æ”¹å·²æœ‰ä»»åŠ¡åŠ¨ä½œç­‰ï¼‰ æ’ä»¶å¦‚æœéœ€è¦èƒ½å¤Ÿè¯»å–ä¸€äº›é…ç½®ï¼Œå¯é€šè¿‡ project.extensions.create æ¥ä»build.gradleä¸­æå– å¦‚éœ€åœ¨è‡ªå·±çš„ androidä»£ç æ¨¡å—ä¸­ä½¿ç”¨æ’ä»¶ï¼Œé€šè¿‡ apply plugin: æ’ä»¶ç±»å¼•ç”¨å³å¯ æ’ä»¶å®ç° æ’ä»¶çš„å®ç°å¦‚ä¸‹ï¼š è¯»å– so_exclude é…ç½®ï¼Œå­˜å‚¨åˆ° extensionï¼ˆç±»å‹ä¸º FlavorSoExcludePluginExtension ï¼‰ä¸­ è¯»å– android çš„é…ç½®ï¼Œæ‰¾åˆ° AppExtensionç±»å‹çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨äº† apply application çš„æ¨¡å—çš„é…ç½®ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­åªæœ‰ä¸€ä¸ªappæ¨¡å—åº”ç”¨æ­¤é…ç½®-å³æˆ‘ä»¬çš„apkæ¨¡å—ï¼› éå†æ‰€æœ‰å˜ä½“ï¼Œè·å–å¯¹åº”å˜ä½“çš„ so_exclude å¯¹åº”çš„é…ç½®å­—æ®µçš„å€¼ï¼Œå»ºç«‹flavoråˆ°é…ç½®å€¼çš„æ˜ å°„è¡¨ï¼› ä¿®æ”¹ packageApplication ä»»åŠ¡ï¼Œè®©å…¶åœ¨æ‰§è¡Œä¹‹å‰å³åˆ é™¤å¾…æ‰“åŒ…ä¸´æ—¶ç›®å½•ä¸­çš„å¯¹åº”soæ–‡ä»¶ï¼› package io.github.hanlyjiang.gradle.plugin.soexclude import com.android.build.gradle.AppExtension import com.android.build.gradle.api.ApkVariantOutput import org.gradle.api.Plugin import org.gradle.api.Project import org.gradle.api.logging.LogLevel import org.gradle.api.logging.Logger import org.gradle.api.logging.Logging import java.io.File /** * so æ’ä»¶çš„ gradle é…ç½®å®ä½“ */ open class FlavorSoExcludePluginExtension { /** * so è¿‡æ»¤é…ç½®è¡¨ */ var configMap: Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt;? = null /** * é…ç½®å­—æ®µçš„åç§° */ var buildConfigFieldKey: String = FlavorSoExcludePlugin.DEFAULT_CONFIG_KEY } /** * flavor so æ‰“åŒ…è¿‡æ»¤é…ç½® * * ## ç”¨æ³•è¯´æ˜ï¼š * * 1. åœ¨build.gradle ä¸­å¼•å…¥æ’ä»¶ \u0026lt;code\u0026gt;apply plugin: FlavorSoExcludePlugin\u0026lt;/code\u0026gt;; * 2. æ·»åŠ  so_exclude é…ç½®æ®µï¼š * * ```groovy * so_exclude { * buildConfigFieldKey = \u0026#34;VPN_TYPE\u0026#34; * configMap = [ * (VpnType.H3C_iNode.name()): [ * \u0026#34;lib/armeabi-v7a/libauth_forward.so\u0026#34;, * \u0026#34;lib/armeabi-v7a/libhttps.so\u0026#34;, * \u0026#34;lib/armeabi-v7a/libpkcs12cert.so\u0026#34;, * \u0026#34;lib/armeabi-v7a/libsvpnservice.so\u0026#34; * ], * (VpnType.SANG_FOR.name()) : [ * \u0026#34;lib/armeabi-v7a/libies.so\u0026#34;, * ], * (VpnType.NONE.name()) : [ * // æ·±ä¿¡æœçš„so * \u0026#34;lib/armeabi-v7a/libauth_forward.so\u0026#34;, * \u0026#34;lib/armeabi-v7a/libhttps.so\u0026#34;, * \u0026#34;lib/armeabi-v7a/libpkcs12cert.so\u0026#34;, * \u0026#34;lib/armeabi-v7a/libsvpnservice.so\u0026#34;, * // inodeçš„so * \u0026#34;lib/armeabi-v7a/libies.so\u0026#34;, * ] * ] *} *``` * 3. åœ¨flavorçš„é…ç½®ä¸­æ·»åŠ  buildConfigField é…ç½®ï¼Œå¦‚ï¼š * ``` * buildConfigField \u0026#34;String\u0026#34;, \u0026#34;VPN_TYPE\u0026#34;, \u0026#34;\\\u0026#34;$VpnType.H3C_iNode\\\u0026#34;\u0026#34; * ``` * å…¶ä¸­å­—æ®µçš„åç§°ä¸º ä¹‹å‰ so_exclude ä¸­é…ç½®çš„ `buildConfigFieldKey` å­—æ®µï¼Œå¯¹åº”çš„å€¼ä¸º configMap ä¸­çš„ key ï¼Œå¦‚æ­¤é…ç½®åï¼Œæ‰“åŒ…æ—¶å°±ä¼šå°†configMapå¯¹åº”keyä¸­çš„soåˆ—è¡¨è¿‡æ»¤æ‰ * @author hanlyjiang 09/20/20 2:42 PM * @version 1.0 */ class FlavorSoExcludePlugin : Plugin\u0026lt;Project\u0026gt; { companion object { const val PLUGIN_NAME = \u0026#34;FlavorSoExcludePlugin\u0026#34; const val DEFAULT_CONFIG_KEY = \u0026#34;SO_EXCLUDE\u0026#34; const val DEBUG = false private val logger: Logger = Logging.getLogger(FlavorSoExcludePlugin::class.java) fun logInfo(msg: String) { logger.log(LogLevel.LIFECYCLE, \u0026#34;\u0026lt;- $PLUGIN_NAME: $msg -\u0026gt;\u0026#34;) } fun logDebug(msg: String) { if (DEBUG) { logInfo(msg) } } } lateinit var extension: FlavorSoExcludePluginExtension override fun apply(project: Project) { // æ·»åŠ è‡ªå·±çš„é…ç½® extension = project.extensions.create(\u0026#34;so_exclude\u0026#34;, FlavorSoExcludePluginExtension::class.java) // åˆ›å»ºä¸€ä¸ªæ‰“å°é…ç½®çš„ä»»åŠ¡ï¼Œç”¨äºå®šä¹‰ val task = project.tasks.create(\u0026#34;printConfig\u0026#34;) task.group = \u0026#34;soExclude-plugin\u0026#34; task.doLast { logInfo(\u0026#34;-- é…ç½®å­—æ®µï¼šbuildConfigFieldKey= \u0026#34; + extension.buildConfigFieldKey) logInfo(\u0026#34;-- å½“å‰é…ç½®ï¼š\u0026#34;) extension.configMap?.run { this.keys.forEach { key -\u0026gt; logInfo(\u0026#34;-- config: $key -- \u0026#34;) get(key)?.forEach { logInfo(\u0026#34;values: $it\u0026#34;) } logInfo(\u0026#34;------------------ \u0026#34;) } } } // è·å–androidçš„é…ç½® val androidExtensions = project.extensions.getByName(\u0026#34;android\u0026#34;) logInfo(\u0026#34;\u0026#34; + androidExtensions.javaClass) if (androidExtensions is AppExtension) { // applicatoinç±»å‹çš„å°±è¿›è¡Œä»»åŠ¡å¤„ç† initPackageOptions(project, androidExtensions) } } /** * vpn é…ç½® */ private var configMap: MutableMap\u0026lt;String, String\u0026gt; = HashMap() private fun initPackageOptions(project: Project, android: AppExtension) { project.afterEvaluate { android.productFlavors.all { val flavorName = it.name logDebug(\u0026#34;--productFlavors : ${it.name}\u0026#34;) var soExcludeConfig = \u0026#34;\u0026#34; it.buildConfigFields[extension.buildConfigFieldKey]?.run { soExcludeConfig = value.replace(\u0026#34;\\\u0026#34;\u0026#34;, \u0026#34;\u0026#34;) } logDebug(\u0026#34;--productFlavors : $flavorName, soExcludeConfig: $soExcludeConfig\u0026#34;) configMap[flavorName] = soExcludeConfig } android.applicationVariants.all { variant -\u0026gt; logDebug(\u0026#34;app variant flavorName: ${variant.flavorName}\u0026#34;) val flavorName = variant.flavorName val configKey = configMap[flavorName] variant.outputs.forEach { output -\u0026gt; if (output is ApkVariantOutput) { //æ ¸å¿ƒé€»è¾‘ï¼šä¿®æ”¹packageApplicationä»»åŠ¡ï¼Œåœ¨ç”ŸæˆapkåŒ…ä¹‹å‰ï¼Œåˆ é™¤æ‰“åŒ…ä¸´æ—¶ç›®å½•ä¸­çš„soæ–‡ä»¶å³å¯é¿å…æ‰“åŒ…soåˆ°apkä¸­ output.packageApplication.doFirst { output.packageApplication.jniFolders.all { // jniFolder ç›®å½•ä¸ºæœ€åæ‰“åŒ…apkæ—¶ï¼Œç”¨äºå­˜æ”¾soæ–‡ä»¶çš„ä¸´æ—¶ç›®å½• logInfo(\u0026#34;å˜ä½“åç§°: ${variant.flavorName} , configKey: ${configKey}, jniFolders: \u0026#34; + it.absoluteFile) handleExclude(it, configKey); true } } } } } } } private fun handleExclude(jniFolder: File?, configKey: String?) { extension.configMap?.run { val soExcludeList: List\u0026lt;String\u0026gt;? = get(configKey) soExcludeList?.run { deleteJniSoFiles(jniFolder, *(soExcludeList.toTypedArray())) } } } private fun deleteJniSoFiles(jniFolder: File?, vararg files: String) { for (item in files) { val file = File(jniFolder, item) if (file.exists()) { val deleteResult = file.delete() logInfo(\u0026#34;åˆ é™¤soæ–‡ä»¶ $item : ${if (deleteResult) \u0026#34;æˆåŠŸ\u0026#34; else \u0026#34;å¤±è´¥\u0026#34;}\u0026#34;) } } } } ä½¿ç”¨æšä¸¾è¿›è¡Œé…ç½® æˆ‘ä»¬åœ¨buildSrcä¸­å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»ï¼Œç”¨äºçº¦å®šå¯ä»¥é…ç½®çš„å€¼ï¼Œå³å¯ä»¥æ¸…æ™°å®šä¹‰é…ç½®å€¼é¿å…é…ç½®æ—¶ç›´æ¥å†™å­—ç¬¦ä¸²å®¹æ˜“å‡ºé”™ï¼Œåˆå¯ä»¥æ”¯æŒä»£ç è‡ªåŠ¨è¡¥å…¨æ–¹ä¾¿é…ç½®ã€‚\npackage io.github.hanlyjiang.gradle.plugin.vpn /** * VPN ç±»å‹ */ enum class VpnType { /** * æ·±ä¿¡æœ */ SANG_FOR, /** * æ–°åä¸‰ */ H3C_iNode, /** * ä¸ä½¿ç”¨VPN */ NONE, } /** * VPN ç±»å‹ */ enum class VpnType { /** * æ·±ä¿¡æœ */ SANG_FOR, /** * æ–°åä¸‰ */ H3C_iNode, /** * ä¸ä½¿ç”¨VPN */ NONE, } ä½¿ç”¨æ’ä»¶ é€šè¿‡ apply plugin å¼•å…¥æ’ä»¶ï¼Œç›´æ¥ä½¿ç”¨æ’ä»¶ç±»åç§°å³å¯ï¼› æšä¸¾é…ç½®ä½¿ç”¨ï¼Œåœ¨gradleé…ç½®ä¸­å¯¼å…¥å¯¹åº”çš„æšä¸¾ç±»ï¼Œç„¶åç›´æ¥ä½¿ç”¨å³å¯ï¼š å…·ä½“é…ç½®å¦‚ä¸‹ï¼š\n// app/build.gradle import io.github.hanlyjiang.gradle.plugin.soexclude.FlavorSoExcludePlugin import io.github.hanlyjiang.gradle.plugin.vpn.VpnType apply plugin: \u0026#39;com.android.application\u0026#39; // åº”ç”¨æ’ä»¶ apply plugin: FlavorSoExcludePlugin so_exclude { /** * ä½¿ç”¨VPN_TYPE æ¥è®¾ç½®soè¿‡æ»¤çš„è§„åˆ™ */ buildConfigFieldKey = \u0026#34;VPN_TYPE\u0026#34; configMap = [ (VpnType.H3C_iNode.name()): [ // æ–°åä¸‰è¿‡æ»¤æ·±ä¿¡æœçš„ \u0026#34;lib/armeabi-v7a/libauth_forward.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libhttps.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libpkcs12cert.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libsvpnservice.so\u0026#34; ], (VpnType.SANG_FOR.name()) : [ // æ·±ä¿¡æœè¿‡æ»¤æ–°åä¸‰çš„ \u0026#34;lib/armeabi-v7a/libies.so\u0026#34;, ], (VpnType.NONE.name()) : [ // å¦‚é…ç½®æˆ NONEï¼Œåˆ™è¿‡æ»¤æ‰æ‰€æœ‰çš„VPNçš„ // æ·±ä¿¡æœçš„so \u0026#34;lib/armeabi-v7a/libauth_forward.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libhttps.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libpkcs12cert.so\u0026#34;, \u0026#34;lib/armeabi-v7a/libsvpnservice.so\u0026#34;, // inodeçš„so \u0026#34;lib/armeabi-v7a/libies.so\u0026#34;, ] ] } android { defaultConfig { // é…ç½®VPNç±»å‹ buildConfigField \u0026#34;String\u0026#34;, \u0026#34;VPN_TYPE\u0026#34;, \u0026#34;\\\u0026#34;$VpnType.SANG_FOR\\\u0026#34;\u0026#34; } productFlavors { // ... } } å‚è€ƒæ–‡æ¡£ è‡ªå®šä¹‰æ’ä»¶-å®˜æ–¹æ–‡æ¡£ å†è§å§ buildSrc, æ‹¥æŠ± Composing builds æå‡Android ç¼–è¯‘é€Ÿåº¦ å¦‚ä½•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦UP-TO-DATE å¦‚ä½•è®©ä»»åŠ¡æ”¯æŒUP_TO_DATE-Gradleå®˜æ–¹æ–‡æ¡£ åˆ›å»ºä»»åŠ¡-https://docs.gradle.org/current/dsl/org.gradle.api.Project.html#org.gradle.api.Project:task(java.util.Map,java.lang.String) å¢é‡ä»»åŠ¡-Gradleå®˜æ–¹æ–‡æ¡£ å¢é‡æ„å»ºå¦‚ä½•å®ç°ï¼Ÿ-gradleå®˜æ–¹æ–‡æ¡£ ","permalink":"https://hanlyjiang.github.io/posts/%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AAandroid-gradle%E6%8F%92%E4%BB%B6/","summary":"\u003cp\u003egradleæœ‰ä¸‰ç§ç¼–å†™æ’ä»¶çš„æ–¹å¼ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨åœ¨é¡¹ç›®ä¸­çš„buildSrcæ¨¡å—ä¸­ç¼–å†™æ’ä»¶çš„æ–¹å¼ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ªåº”ç”¨äºAndroidé¡¹ç›®çš„æ ¹æ®flavorè¿‡æ»¤soåº“çš„gradleæ’ä»¶ï¼›\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"æ¦‚è¿°\"\u003eæ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eè‡ªå®šä¹‰gradleæ’ä»¶æœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼ï¼ˆ\u003ca href=\"https://docs.gradle.org/current/userguide/custom_plugins.html#sec:packaging_a_plugin\"\u003eğŸ”—é“¾æ¥\u003c/a\u003eï¼‰ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåœ¨buildscriptä¸­ç›´æ¥ç¼–å†™ï¼›\u003c/li\u003e\n\u003cli\u003eåœ¨buildSrcé¡¹ç›®ä¸­ç¼–å†™æ’ä»¶ä»£ç ï¼›\u003c/li\u003e\n\u003cli\u003eåœ¨ç‹¬ç«‹çš„é¡¹ç›®ä¸­ç¼–å†™æ’ä»¶ä»£ç ï¼›\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eè¿™é‡Œæˆ‘ä»¬å°†ä½¿ç”¨buildSrcæ–¹å¼å®ç°ä¸€ä¸ªgradleæ’ä»¶ã€‚\u003c/p\u003e","title":"ç¼–å†™ä¸€ä¸ªAndroid Gradleæ’ä»¶"},{"content":"ä»‹ç»ARMç‰ˆæœ¬çš„Dockeré•œåƒçš„æ„å»ºï¼ŒåŒ…æ‹¬ARMæœºå™¨ä¸ŠDockerçš„å®‰è£…ï¼Œåœ¨ARMæœºå™¨ä¸Šæ„å»ºé•œåƒï¼ŒåŠåœ¨amd64æœºå™¨ä¸Šä½¿ç”¨buildxäº¤å‰æ„å»ºarmç‰ˆæœ¬é•œåƒã€‚\nå‰è¨€ ç°åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å¯¹æœåŠ¡çš„å›½äº§åŒ–é€‚é…æœ‰æ‰€è¦æ±‚ï¼Œä¸€èˆ¬çš„å›½äº§åŒ–å¹³å°éƒ½æä¾›armç‰ˆæœ¬çš„linuxäº‘ç¯å¢ƒä¾›æˆ‘ä»¬è¿›è¡ŒæœåŠ¡éƒ¨ç½²ï¼Œå› æ­¤éœ€è¦æ„å»ºarmç‰ˆæœ¬çš„é•œåƒã€‚\næµ‹è¯•æœºä¿¡æ¯ CPU FT-1500A 4æ ¸ arm64 å†…å­˜ 8G OS éº’éºŸV10 åŒ…ç®¡ç†å™¨ apt ARMæœºå™¨ä¸Šå®‰è£…Docker Dockerå®˜æ–¹æ–‡æ¡£\nDockeræ”¯æŒå¦‚ä¸‹ç³»ç»ŸåŠæ¶æ„\nå›½äº§ç³»ç»Ÿä¾æ®å®‰è£…åŒ…çš„æ ¼å¼é€‰æ‹©å¯¹åº”çš„å‚è€ƒç³»ç»Ÿå³å¯ï¼Œå¦‚éº’éºŸv10åŸºäºubuntuï¼Œå¯ä»¥æŒ‰å®˜æ–¹æ–‡æ¡£- Install Docker Engine on Ubuntuè¿›è¡Œå®‰è£…ã€‚\næŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯ geostar@geostar-ft1500a:~$ cat /proc/version Linux version 4.4.131-20200515.kylin.desktop-generic (YHKYLIN-OS@Kylin) (gcc version 5.5.0 20171010 (Ubuntu/Linaro 5.5.0-12ubuntu1~16.04) ) #kylin SMP Fri May 15 11:29:10 CST 2020 è¿™é‡Œå¯ä»¥çœ‹åˆ°ç³»ç»Ÿæ˜¯åŸºäºubuntu16.04 çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ·»åŠ ubuntu16.04ï¼ˆxenialï¼‰çš„è½¯ä»¶æº\næ·»åŠ è½¯ä»¶æº å‚è€ƒï¼š https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/ https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/\næ·»åŠ æ¸…åé•œåƒè½¯ä»¶æºï¼ˆarmæ¶æ„ï¼‰\n# é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse # deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse æ›´æ–°ï¼š\nsudo apt-get install apt-transport-https sudo apt-get clean sudo apt-get update å®‰è£…Docker # å¸è½½æ—§ç‰ˆæœ¬docker sudo apt-get remove docker docker-engine docker.io containerd runc sudo apt-get update sudo apt-get install \\ apt-transport-https \\ ca-certificates \\ curl \\ gnupg-agent \\ software-properties-common curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # ç¡®è®¤keyæ·»åŠ æˆåŠŸ(æŸ¥æ‰¾ï¼š9DC8 5822 9FC7 DD38 854AÂ E2D8 8D81 803C 0EBF CD88) sudo apt-key fingerprint 0EBFCD88 ç¼–è¾‘ /etc/apt/source.listï¼Œæ·»åŠ dockerè½¯ä»¶æºï¼ˆarm64 xenialï¼‰ï¼Œå¹¶ä¿å­˜\n# https://docs.docker.com/engine/install/ubuntu/ deb [arch=arm64] https://download.docker.com/linux/ubuntu xenial stable å®‰è£… docker\nsudo apt-get update # å®‰è£…Docker sudo apt-get install docker-ce docker-ce-cli containerd.io # å®‰è£…æˆåŠŸï¼ŒæŸ¥çœ‹ç‰ˆæœ¬ docker --version Docker version 19.03.12, build 48a6621 åœ¨Dockerhubä¸ŠæŸ¥æ‰¾å·²æœ‰çš„armé•œåƒ å®é™…ä¸Šå¾ˆå¤šé•œåƒéƒ½æœ‰æ„å»ºarmç‰ˆæœ¬ï¼Œå¯¹äºç›´æ¥ä½¿ç”¨çš„é•œåƒï¼Œæˆ–è€…ä½œä¸ºDockerfileä¸­FROMçš„é•œåƒï¼Œå¦‚æœæœ‰å¯¹åº”çš„armç‰ˆæœ¬ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œçœç•¥æ„å»ºè¿‡ç¨‹ã€‚ä»¥postgresä¸ºä¾‹ï¼Œåœ¨dockerhubä¸Šå¯ä»¥çœ‹åˆ°\nåœ¨å…·ä½“çš„tagä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬çš„é•œåƒæ˜¯å¦æ”¯æŒarmæ¶æ„\nä½†éœ€è¦ä½¿ç”¨çš„é•œåƒä¸æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥ç¡®è®¤è¯¥é•œåƒæ˜¯å¦æœ‰å¯¹åº”çš„armç‰ˆæœ¬ã€‚\nARMç‰ˆæœ¬é•œåƒæ„å»ºï¼ˆéARMæœºå™¨ä¸Šæ‰§è¡Œï¼‰ å‚è€ƒï¼š -https://github.com/docker/cli/blob/master/experimental/README.md -è·¨å¹³å°æ„å»º Docker é•œåƒæ–°å§¿åŠ¿ï¼Œx86ã€arm ä¸€æŠŠæ¢­\næ„å»ºARMé•œåƒçš„ä¸¤ç§æ–¹å¼ å¯¹äºæ„å»ºé•œåƒçš„ARMç‰ˆæœ¬ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š\nåœ¨ARMæœºå™¨ä¸Šä½¿ç”¨ docker build è¿›è¡Œæ„å»ºï¼› åœ¨X86/AMD64 çš„æœºå™¨ä¸Šä½¿ç”¨ docker buildx è¿›è¡Œäº¤å‰æ„å»ºï¼› å®é™…æµ‹è¯•ä¸­å‘ç°ç¬¬ä¸€ç§æ–¹å¼åœ¨æŸäº›æƒ…å†µä¸‹ä¼šæœ‰é—®é¢˜ï¼Œå»ºè®®é‡‡ç”¨ç»“åˆé‡‡ç”¨è¿™äºŒç§æ–¹å¼ï¼›\nå…³äºç¬¬äºŒç§æ„å»ºæ–¹å¼ï¼Œå¯å…ˆé˜…è¯»è·¨å¹³å°æ„å»º Docker é•œåƒæ–°å§¿åŠ¿ï¼Œx86ã€arm ä¸€æŠŠæ¢­è¿›è¡Œäº†è§£ï¼Œä»¥ä¸‹ç®€è¦ä»‹ç»ä½¿ç”¨buildxäº¤å‰æ„å»ºçš„æ–¹å¼ï¼›\nâš ï¸æ³¨æ„ï¼š\näº¤å‰æ„å»ºå’Œäº¤å‰è¿è¡Œçš„æ–¹å¼ä¼šæœ‰ä¸€äº›æ— æ³•é¢„çŸ¥çš„é—®é¢˜ï¼Œå»ºè®®ç®€å•çš„æ„å»ºæ­¥éª¤ï¼ˆå¦‚åªæ˜¯ä¸‹è½½è§£å‹å¯¹åº”æ¶æ„çš„æ–‡ä»¶ï¼‰å¯è€ƒè™‘åœ¨x86ä¸‹äº¤å‰æ„å»ºï¼Œå¤æ‚çš„ï¼ˆå¦‚éœ€è¦ç¼–è¯‘çš„ï¼‰åˆ™ç›´æ¥åœ¨armæœºå™¨ä¸Šè¿›è¡Œæ„å»ºï¼›\nå®é™…æµ‹è¯•å‘ç°ï¼Œä½¿ç”¨qemuæ–¹å¼åœ¨x86å¹³å°ä¸‹è¿è¡Œarmç‰ˆæœ¬çš„é•œåƒæ—¶ï¼Œæ‰§è¡Œç®€å•çš„å‘½ä»¤å¯ä»¥æˆåŠŸï¼ˆå¦‚archï¼‰ï¼Œæ‰§è¡ŒæŸäº›å¤æ‚çš„ç¨‹åºæ—¶ï¼ˆå¦‚å¯åŠ¨javaè™šæ‹Ÿæœºï¼‰ï¼Œä¼šæ— å“åº”ï¼Œæ‰€ä»¥é•œåƒçš„éªŒè¯å·¥ä½œåº”å°½é‡æ”¾ç½®åˆ°armæœºå™¨ä¸Šè¿›è¡Œï¼›\nä¸Šé¢ç¬¬äºŒç‚¹æŒ‰å¦‚ä¸‹æ–¹å¼æµ‹è¯•ï¼š\ndocker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch å¯æ­£å¸¸è¾“å‡ºï¼› docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version åˆ™ä¼šå¡ä½ï¼Œä¸”éœ€è¦ä½¿ç”¨docker stopåœæ­¢å®¹å™¨æ‰å¯ä»¥é€€å‡ºå®¹å™¨ï¼› å¯ç”¨è¯•éªŒæ€§åŠŸèƒ½ å‚è€ƒï¼šhttps://docs.docker.com/engine/reference/commandline/cli/#experimental-features æ³¨æ„ï¼šbuildx ä»…æ”¯æŒ docker19.03 åŠä»¥ä¸Šdockerç‰ˆæœ¬\nå¦‚éœ€ä½¿ç”¨ buildxï¼Œéœ€è¦å¼€å¯dockerçš„å®éªŒåŠŸèƒ½åï¼Œæ‰å¯ä»¥ä½¿ç”¨ï¼Œå¼€å¯æ–¹å¼ï¼š\nç¼–è¾‘ /etc/docker/daemon.json æ·»åŠ ï¼š { \u0026#34;experimental\u0026#34;: true } ç¼–è¾‘ ï½/.docker/config.json æ·»åŠ ï¼š \u0026#34;experimental\u0026#34; : \u0026#34;enabled\u0026#34; é‡å¯Dockerä½¿ç”Ÿæ•ˆï¼š sudo systemctl daemon-reload sudo systemctl restart docker ç¡®è®¤æ˜¯å¦å¼€å¯ï¼š docker version -f\u0026rsquo;{{.Server.Experimental}}' å¦‚æœè¾“å‡ºtrueï¼Œåˆ™è¡¨ç¤ºå¼€å¯æˆåŠŸ ä½¿ç”¨buildxæ„å»º buildx çš„è¯¦ç»†ä½¿ç”¨å¯å‚è€ƒï¼šDockerå®˜æ–¹æ–‡æ¡£-Reference-buildx åˆ›å»º buildx æ„å»ºå™¨ ä½¿ç”¨ docker buildx ls å‘½ä»¤æŸ¥çœ‹ç°æœ‰çš„æ„å»ºå™¨\ndocker buildx ls åˆ›å»ºå¹¶æ„å»ºå™¨ï¼š\n# ä¸‹é¢çš„åˆ›å»ºå‘½ä»¤ä»»é€‰ä¸€æ¡ç¬¦åˆæƒ…å†µçš„å³å¯ # 1. ä¸æŒ‡å®šä»»ä½•å‚æ•°åˆ›å»º docker buildx create --use --name multiarch-builder # 2. å¦‚åˆ›å»ºåä½¿ç”¨docker buildx ls å‘ç°æ„å»ºèµ·æ²¡æœ‰armæ¶æ„æ”¯æŒï¼Œå¯ä½¿ç”¨--platformæ˜ç¡®æŒ‡å®šè¦æ”¯æŒçš„æ„å»ºç±»å‹ï¼Œå¦‚ä»¥ä¸‹å‘½ä»¤ docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder # 3. å¦‚éœ€åœ¨buildxè®¿é—®ç§æœ‰registryï¼Œå¯ä½¿ç”¨hostæ¨¡å¼ï¼Œå¹¶æ‰‹åŠ¨æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œé¿å…buildxæ—¶æ— æ³•è®¿é—®æœ¬åœ°çš„registryä¸»æœº docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder buildx-config.toml é…ç½®æ–‡ä»¶å†™æ³•ç±»ä¼¼ï¼š\n# https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md # registry configures a new Docker register used for cache import or output. [registry.\u0026#34;zh-registry.geostar.com.cn\u0026#34;] mirrors = [\u0026#34;zh-registry.geostar.com.cn\u0026#34;] http = true insecure = true å¯ç”¨æ„å»ºå™¨\n# åˆå§‹åŒ–å¹¶æ¿€æ´» docker buildx inspect multiarch-builder --bootstrap ç¡®è®¤æˆåŠŸ\n# ä½¿ç”¨ docker buildx ls æŸ¥çœ‹ docker buildx ls ä¿®æ”¹Dockerfile å¯¹ Dockerfile çš„ä¿®æ”¹ï¼Œå¤§è‡´éœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š\nç¡®è®¤åŸºç¡€é•œåƒï¼ˆFROMï¼‰æ˜¯å¦æœ‰armç‰ˆæœ¬ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯ä»¥ä¸ç”¨æ”¹åŠ¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦å¯»æ‰¾æ›¿ä»£é•œåƒï¼Œå¦‚æ²¡æœ‰æ›¿ä»£é•œåƒï¼Œåˆ™å¯èƒ½éœ€è¦è‡ªè¡Œç¼–è¯‘ï¼› ç¡®è®¤dockerfileçš„å„ä¸ªæ­¥éª¤ä¸­æ˜¯å¦æœ‰ä¾èµ–CPUæ¶æ„çš„ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éœ€è¦æ›¿æ¢æˆarmæ¶æ„çš„ï¼Œå¦‚åœ¨æ„å»ºjitisçš„é•œåƒæ—¶ï¼ŒDockerfileä¸­æœ‰æ·»åŠ ä¸€ä¸ªamd64æ¶æ„çš„è½¯ä»¶ ADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz /tmp/s6-overlay.tar.gz\næ­¤æ—¶éœ€è¦æ›¿æ¢ä¸ºä¸‹é¢çš„åœ°å€(æ³¨æ„amd64æ›¿æ¢æˆäº†aarch64ï¼Œå½“ç„¶ï¼Œéœ€è¦å…ˆç¡®è®¤ä¸‹è½½åœ°å€ä¸­æœ‰æ— å¯¹åº”æ¶æ„çš„gzåŒ…ï¼Œä¸èƒ½ç®€å•åšå­—ç¬¦æ›¿æ¢)ï¼š\nADD https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz /tmp/s6-overlay.tar.gz\nå½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤è¯¥è½¯ä»¶æœ‰æ­¤æ¶æ„çš„å½’æ¡£åŒ…ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦è€ƒè™‘ä»æºç æ„å»ºï¼›\næç¤ºï¼š\næ€ä¹ˆç¡®å®šä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶/soåº“çš„å¯¹åº”çš„æ‰§è¡Œæ¶æ„ï¼Ÿ å¯ä»¥é€šè¿‡ file {å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„} æ¥æŸ¥çœ‹ï¼Œ\nå¦‚ä¸‹é¢æ—¶macOSä¸Šæ‰§è¡Œfileå‘½ä»¤çš„è¾“å…¥ï¼Œå¯ä»¥å‘ç°macOSä¸Šçš„gitç¨‹åºå¯ä»¥å…¼å®¹ä¸¤ç§æ¶æ„-x86_64\u0026amp;arm64eï¼š\nfile $(which git) /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e] /usr/bin/git (for architecture x86_64):\tMach-O 64-bit executable x86_64 /usr/bin/git (for architecture arm64e):\tMach-O 64-bit executable arm64e ä¸‹é¢çš„å‘½ä»¤åˆ™å¯¹ä¸€ä¸ªsoæ–‡ä»¶æ‰§è¡Œäº†fileï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­çš„æ¶æ„ä¿¡æ¯ ARM aarch64ï¼š\nfile /lib/aarch64-linux-gnu/libpthread-2.23.so /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped docker buildx æ„å»ºarm64é•œåƒçš„å‘½ä»¤ ä½¿ç”¨ \u0026ndash;platformæ¥æŒ‡å®šæ¶æ„ï¼Œä½¿ç”¨ --push æˆ– --load æ¥æŒ‡å®šæ„å»ºå®Œæ¯•åçš„åŠ¨ä½œã€‚\ndocker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push æç¤ºï¼šå½“æŒ‡å®šå¤šä¸ªæ¶æ„æ—¶ï¼Œåªèƒ½ä½¿ç”¨ \u0026ndash;push æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œæ— æ³• \u0026ndash;loadï¼Œæ¨é€æˆåŠŸåå†é€šè¿‡ docker pull \u0026ndash;platform æ¥æ‹‰å–æŒ‡å®šæ¶æ„çš„é•œåƒ\næ£€æŸ¥æ„å»ºæˆæœ é€šè¿‡ docker buildx imagetools inspect å‘½ä»¤æŸ¥çœ‹é•œåƒä¿¡æ¯ï¼Œçœ‹æ˜¯å¦æœ‰å¯¹åº”çš„armæ¶æ„ä¿¡æ¯ï¼› å®é™…è¿è¡Œé•œåƒï¼Œç¡®è®¤è¿è¡Œæ­£å¸¸ï¼›ï¼ˆåœ¨armæœºå™¨ä¸Šæ‰§è¡Œï¼‰ æç¤ºï¼šå¦‚è¿è¡Œæ—¶è¾“å‡º exec format error ç±»ä¼¼é”™è¯¯ï¼Œåˆ™è¡¨ç¤ºé•œåƒä¸­éƒ¨åˆ†å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ä¸åŒ¹é…ã€‚\nåœ¨x86ä¸Šè¿è¡Œarmé•œåƒ å¯å‚è€ƒ github/qemu-user-static ,ç®€è¦æè¿°å¦‚ä¸‹ï¼š\næ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š\ndocker run --rm --privileged multiarch/qemu-user-static --reset -p yes\nä¹‹åå³å¯è¿è¡Œarmç‰ˆæœ¬çš„é•œåƒï¼Œå¦‚ï¼š\ndocker run --rm -t arm64v8/fedora uname -m ","permalink":"https://hanlyjiang.github.io/posts/docker-arm%E6%9E%B6%E6%9E%84%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA-%E9%80%9A%E7%94%A8%E6%AD%A5%E9%AA%A4/","summary":"\u003cp\u003eä»‹ç»ARMç‰ˆæœ¬çš„Dockeré•œåƒçš„æ„å»ºï¼ŒåŒ…æ‹¬ARMæœºå™¨ä¸ŠDockerçš„å®‰è£…ï¼Œåœ¨ARMæœºå™¨ä¸Šæ„å»ºé•œåƒï¼ŒåŠåœ¨amd64æœºå™¨ä¸Šä½¿ç”¨buildxäº¤å‰æ„å»ºarmç‰ˆæœ¬é•œåƒã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h2\u003e\n\u003cp\u003eç°åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å¯¹æœåŠ¡çš„å›½äº§åŒ–é€‚é…æœ‰æ‰€è¦æ±‚ï¼Œä¸€èˆ¬çš„å›½äº§åŒ–å¹³å°éƒ½æä¾›armç‰ˆæœ¬çš„linuxäº‘ç¯å¢ƒä¾›æˆ‘ä»¬è¿›è¡ŒæœåŠ¡éƒ¨ç½²ï¼Œå› æ­¤éœ€è¦æ„å»ºarmç‰ˆæœ¬çš„é•œåƒã€‚\u003c/p\u003e","title":"Dockeræ„å»ºArmæ¶æ„é•œåƒ-é€šç”¨æ­¥éª¤"},{"content":"æœ¬æ–‡ä»‹ç»Gitlab-Runnerçš„å®‰è£…è¿è¡Œï¼ˆåŒ…æ‹¬dockeræ–¹å¼å®‰è£…è¿è¡ŒåŠäºŒè¿›åˆ¶ç›´æ¥è¿è¡Œï¼‰ï¼Œå¹¶ä»‹ç»å¦‚ä½•å°†Gitlabæ³¨å†Œåˆ°Gitlabã€‚åŒæ—¶è¿˜ä»‹ç»äº†gitlab-runnerçš„ä¸€äº›å¸¸ç”¨æ“ä½œå‘½ä»¤ã€‚\nå®‰è£…Gitlab-Runner gitlab-runnerå¯ä»¥ä½¿ç”¨dockeræ–¹å¼è¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸»æœºä¸Šè¿è¡Œå…¶äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œé€‰æ‹©ï¼š\næ‰§è¡Œé€šç”¨çš„æ„å»ºæµ‹è¯•ä»»åŠ¡åŠä¸ä¸éœ€è¦ç›´æ¥è®¿é—®ä¸»æœºç›®å½•çš„ï¼Œä»¥dockeræ–¹å¼å®‰è£…ï¼› æ‰§è¡Œéƒ¨ç½²ç±»ä»»åŠ¡æˆ–éœ€è¦ç›´æ¥è®¿é—®ä¸»æœºç›®å½•çš„ï¼Œä»¥äºŒè¿›åˆ¶æ–¹å¼å®‰è£…ï¼› ä»¥ä¸‹åˆ†åˆ«ä»‹ç»ä¸Šè¿°ä¸¤ç§å®‰è£…æ–¹å¼ã€‚\nä½¿ç”¨dockerå®‰è£…gitlab-runner ä½¿ç”¨dockeræ–¹å¼å®‰è£…çš„ï¼Œéœ€å…ˆåœ¨ä¸»æœºä¸Šå®‰è£…dockerç¯å¢ƒï¼Œå¯å‚è€ƒ Docker å®˜æ–¹å®‰è£…æ–‡æ¡£ã€‚ä»¥ä¸‹æ“ä½œå‡è®¾ä¸»æœºä¸Šå·²æ­£ç¡®å®‰è£…å¹¶é…ç½®äº†dockerè¿è¡Œç¯å¢ƒï¼›\næç¤ºï¼šå¯ä»¥ä½¿ç”¨åŸºäºalpineçš„é•œåƒæ¥å‡å°å¤§å°\n# å»ºç«‹é…ç½®æŒ‚è½½ç›®å½• mkdir -p /data/gitlab-runner/config # å»ºç«‹æ„å»ºç›®å½•æŒ‚è½½ç›®å½• mkdir -p /data/gitlab-runner/home # æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†åŸºäºalpineçš„é•œåƒæ¥å‡å°å¤§å°ï¼›ä½¿ç”¨ --restart æ ‡è¯†æ¥è‡ªåŠ¨é‡å¯ docker run -d --name gitlab-runner --restart always \\ -v /data/gitlab-runner/config:/etc/gitlab-runner \\ -v /data/gitlab-runner/home:/home/gitlab-runner \\ -v /var/run/docker.sock:/var/run/docker.sock \\ gitlab/gitlab-runner:alpine # é€šè¿‡ä»¥ä¸‹å‘½ä»¤è®¾ç½®dockerå¼€æœºè‡ªå¯ sudoÂ systemctl enable docker dockerå®‰è£…çš„gitlab-runnerå¸¸ç”¨æ“ä½œ è¿è¡Œå‘½ä»¤ ä½¿ç”¨å·²æœ‰å®¹å™¨\n# å®¹å™¨å·²ç»è¿è¡Œçš„æƒ…å†µä¸‹ # 1. äº¤äº’å¼æ‰§è¡Œï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç„¶åè¾“å…¥å‘½ä»¤ docker exec -it gitlab-runner /bin/bash # ç„¶åæ‰§è¡Œå‘½ä»¤ gitlab-runer --help # 2. å•æ¬¡æ‰§è¡Œ docker exec gitlab-runner gitlab-runner --help ä½¿ç”¨ä¸´æ—¶çš„ï¼š\ndocker run --rm -t -i gitlab/gitlab-runner:alpine --help # -it ä½¿ç”¨äº¤äº’å¼ç»ˆç«¯ # --rm è‡ªåŠ¨åˆ é™¤ é‡å¯gitlab-runner docker restart gitlab-runner å‡çº§ç‰ˆæœ¬ # è·å–æœ€æ–° docker pull gitlab/gitlab-runner:alpine docker stop gitlab-runner \u0026amp;\u0026amp; docker rm gitlab-runner docker run -d --name gitlab-runner --restart always \\ -v /var/run/docker.sock:/var/run/docker.sock \\ -v /data/gitlab-runner/config:/etc/gitlab-runner \\ -v /data/gitlab-runner/home:/home/gitlab-runner \\ gitlab/gitlab-runner:alpine æŸ¥çœ‹æ—¥å¿— docker logs gitlab-runner é…ç½® gitlab-runner åˆ«å åœ¨ ~/.bash_profile æˆ– ~/.bashrc æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹å‡½æ•°é…ç½®ï¼Œåç»­è¿è¡Œ gitlab-runner å‘½ä»¤æ—¶å³å¯çœå»docker exec å‘½ä»¤\n# æ·»åŠ  gitlab-runner ç›´æ¥æ‰§è¡Œåˆ°å®¹å™¨ function gitlab-runner(){ docker exec -it gitlab-runner gitlab-runner $@ } ä½¿ç”¨äºŒè¿›åˆ¶åŒ…å®‰è£…è¿è¡Œgitlab-runner è·å–å®‰è£…åŒ…å®‰è£…å¹¶è¿è¡Œ Centos or RedHat ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š\nARCH=$(arch) curl -LJO \u0026#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner$ARCH.rpm\u0026#34; rpm -i gitlab-runner_$ARCH.rpm Debian or Ubuntu ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…\nARCH=$(arch) curl -LJO \u0026#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_$ARCH.deb\u0026#34; dpkg -i gitlab-runner_$ARCH.deb Windows å®‰è£…\nè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š https://docs.gitlab.com/runner/install/windows.html#installation\næµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸï¼Œå¦‚èƒ½æˆåŠŸè¾“å‡ºgitlab-runnerçš„ç”¨æ³•ä¿¡æ¯ï¼Œåˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸ\ngitlab-runner --help æµ‹è¯•æ˜¯å¦æˆåŠŸå¯åŠ¨\ngitlab-runner status # å¦‚è¾“å‡º Service is runningï¼Œåˆ™è¡¨ç¤ºæˆåŠŸå¯åŠ¨äº† é€šè¿‡dockeræ–¹å¼è¿è¡Œçš„runneråœ¨è¿è¡Œ gitlab-runner statusæ—¶ä¼šè¾“å‡º not runningï¼Œè¿™å¯¹äºdockeræ–¹å¼è¿è¡Œçš„runneræ˜¯æ­£å¸¸çš„ï¼Œåªæœ‰ç›´æ¥è¿è¡Œäºä¸»æœºä¸Šçš„runneréœ€è¦å¯åŠ¨å¯¹åº”çš„æœåŠ¡ï¼›\nå®‰è£…å¹¶æ›´æ–°Gitç‰ˆæœ¬ Gitlab-CI ä»»åŠ¡åœ¨ runner æœºå™¨ä¸Šæ‰§è¡Œï¼Œä¼šå…ˆé€šè¿‡gitè·å–å¯¹åº”ä»“åº“çš„æœ€æ–°ä»£ç ï¼Œè¿™ä¸ªè·å–ä»£ç çš„æ“ä½œæ˜¯é€šè¿‡gitæ¥å®Œæˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£…gitå·¥å…·ï¼›\nå®‰è£…Git\nsudo yum install -y git # æŸ¥çœ‹ç‰ˆæœ¬ git --version # centos7 ä¸Šä¸º 1.8.xï¼Œæ— æ³•æ»¡è¶³gitlabè¦æ±‚ å‡çº§Gitç‰ˆæœ¬\næŸäº›linuxå‘å‹ç‰ˆä¸Šgitç‰ˆæœ¬è¿‡ä½ï¼Œåœ¨æ‰§è¡Œæµæ°´çº¿æ—¶ä¼šå¤±è´¥ï¼Œéœ€è¦å‡çº§gitç‰ˆæœ¬ï¼Œå¯æŒ‰å¦‚ä¸‹æ–¹å¼ä»æºç å®‰è£…æœ€æ–°gitç‰ˆæœ¬ï¼›\nä¸‹è½½git v2.27.0æºç \n## ä»¥ä¸‹ä¸‹è½½æ–¹å¼ä»»é€‰å…¶ä¸€ # å¯é€‰ä¸‹è½½æ–¹å¼1 - ä»gitee å…‹éš† git clone -b v2.27.0 https://gitee.com/hanlyjiang/git.git git-2.27.0 cd git-2.27.0 \u0026amp;\u0026amp; git checkout -b tag-v2.27.0 v2.27.0 # å¯é€‰ä¸‹è½½æ–¹å¼2 - ä»githubç›´æ¥ä¸‹è½½åŒ… curl -LJO https://github.com/git/git/archive/v2.27.0.tar.gz tar -xvf git-2.27.0.tar.gz cd git-2.27.0 ç¼–è¯‘å®‰è£…\n# å®‰è£…ç¼–è¯‘ä¾èµ–åº“ sudo yum install -y autoconf gcc openssh zlib-devel # ç¼–è¯‘å¹¶å®‰è£… make configure ;# as yourself ./configure --prefix=/usr ;# as yourself make -j8 all ;# as yourself sudo make install ;# as root # ç¡®è®¤ç‰ˆæœ¬ï¼š git --version # git version 2.27.0 å°†gitlab-runnerç”¨æˆ·æ·»åŠ åˆ°dockerç”¨æˆ·ç»„ï¼ˆå¯é€‰ï¼‰ å¦‚éœ€è¦åœ¨è¯¥gitlab-runnerçš„CIè„šæœ¬ä¸­è¿è¡Œdockerå‘½ä»¤ï¼Œè¿™éœ€è¦å°† gitlab-runnerç”¨æˆ·æ·»åŠ åˆ°dockerçš„ç”¨æˆ·ç»„ï¼Œå¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\nsudo usermod -a -G docker gitlab-runner # éªŒè¯æƒé™ sudo -u gitlab-runner -H docker info ä¿®æ”¹ gitlab-runner æ„å»ºç›®å½• å¦‚åœ¨æ‰§è¡Œciä»»åŠ¡æ—¶ï¼Œæ‹‰å–ä»£ç æ—¶æŠ¥buildç›®å½•æƒé™é—®é¢˜ï¼Œå¯å°è¯•æŒ‰å¦‚ä¸‹æ–¹å¼ä¿®æ”¹æŒ‡å®šrunnerçš„æ„å»ºç›®å½•\næŸ¥æ‰¾é…ç½®æ–‡ä»¶è·¯å¾„\ngitlab-runner list # å…¶ä¸­ConfigFileçš„å€¼å°±æ˜¯å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚ï¼š # ConfigFile=/etc/gitlab-runner/config.toml ä¿®æ”¹ builds_dir æŒ‡å‘\næ‰¾å¯¹è¯¥ä»»åŠ¡å¯¹åº”çš„[[runner]] é…ç½®æ®µï¼Œå¹¶åœ¨è¯¥é…ç½®ä¸­æ·»åŠ  builds_dir æŒ‡å‘æ–°çš„å…·æœ‰æƒé™çš„ç›®å½•ï¼Œç„¶åé‡å¯å¯åŠ¨gitlab-runnerå³å¯ï¼›\n[[runners]] name = \u0026#34;blockdataapi-engine\u0026#34; url = \u0026#34;http://172.18.0.208/\u0026#34; token = \u0026#34;Y-6zdV9zzi8xsY1rygbn\u0026#34; executor = \u0026#34;shell\u0026#34; builds_dir = \u0026#34;/data/gitlab-runner/builds\u0026#34; [runners.custom_build_dir] [runners.cache] [runners.cache.s3] [runners.cache.gcs] æ³¨å†Œ Runner åˆ° Gitlab è¿™é‡Œæˆ‘ä»¬å°†runneræ³¨å†Œä¸ºç¾¤ç»„çš„Runnerï¼Œç¾¤ç»„runnerå¯ä»¥åœ¨ç¾¤ç»„ä¸­å…±äº«ï¼Œæ‰€æœ‰å­ç¾¤ç»„å’Œé¡¹ç›®éƒ½å¯ä»¥ä½¿ç”¨è¯¥Runnerã€‚ä¹Ÿå¯ä»¥å°†Runneræ³¨å†Œåˆ°æŒ‡å®šé¡¹ç›®ä»“åº“ä¸Šï¼Œæ“ä½œä¸Šåªæœ‰è·å–gitlab-runneræ³¨å†Œä¿¡æ¯æ—¶ä¸ä¸€æ ·ï¼›\nè·å–gitlab-runneræ³¨å†Œä¿¡æ¯ å¦‚éœ€æ³¨å†Œåˆ°å…·ä½“é¡¹ç›®ï¼Œåœ¨é¡¹ç›®çš„è®¾ç½®åœ¨è¿›å…¥å¯¹åº”çš„CI/CDè®¾ç½®å³å¯ï¼Œåç»­æ“ä½œæµç¨‹ä¸€è‡´ï¼›\nåœ¨ç¾¤ç»„çš„è®¾ç½®ä¸­æ‰“å¼€ CI/CD è®¾ç½®\nå±•å¼€ Runner æ ä½\nè¿™é‡Œæˆ‘ä»¬é€‰æ‹©é€šè¿‡æ‰‹åŠ¨è®¾ç½®group runnerçš„æ–¹å¼æ¥æ³¨å†Œï¼Œå¯ä»¥è·å–åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š\næ³¨å†Œrunner ä»¥dockeræ–¹å¼è¿è¡Œçš„gitlab-runnerå¯æŒ‰å¦‚ä¸‹æ–¹å¼è¿›å…¥äº¤äº’ç¯å¢ƒï¼Œç›´æ¥äºŒè¿›åˆ¶è¿è¡Œçš„æ— éœ€æ­¤æ“ä½œï¼›\nåœ¨gitlab-runner çš„æœºå™¨ä¸Šæ‰§è¡Œæ³¨å†Œå‘½ä»¤ï¼Œå°†runneræ³¨å†Œåˆ°gitlabï¼Œä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›å…¥gitlab-runnerå®¹å™¨shellç¯å¢ƒï¼š\ndocker exec -it gitlab-runner /bin/bash æ‰§è¡Œå®Œæˆåå‡ºç°å¦‚ä¸‹äº¤äº’çª—å£\nbash-4.4# dockeræ–¹å¼è¿è¡Œçš„runneréœ€åœ¨æ­¤bashä¸­æ‰§è¡Œå‘½ä»¤ï¼Œä¸»æœºä¹‹é—´è¿è¡Œçš„runnerç›´æ¥åœ¨shellä¸­æ‰§è¡Œå³å¯ã€‚\næ‰§è¡Œregisterå‘½ä»¤è¿›è¡Œæ³¨å†Œ gitlab-runner register # urlï¼š http://172.18.0.208/ # token cEJ611JDeCWSMyu7WXwx # description - ç”¨äºè¾¨è¯†è¯¥æ³¨å†Œæ‰€å±çš„ç¾¤ç»„æˆ–é¡¹ç›®ï¼Œå¯ä»¥è®¾ç½®ä¸ºæ–¹ä¾¿åŒºåˆ†çš„å­—ç¬¦ä¸² sonarqube-runner # ci-tag - æ ‡ç­¾ç”¨äºåç»­CIé…ç½®ä¸­é€‰æ‹©æ­¤æ‰§è¡Œå™¨ï¼ŒåæœŸå¯ä»¥é€šè¿‡gitlabç•Œé¢æ›´æ”¹ sonarqube,common-build # executor - åç»­CIä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ï¼Œdockeræ–¹å¼è¿è¡Œçš„è¯·é€‰æ‹©docker docker # default image - CIé…ç½®ä¸­æœªæŒ‡å®šé•œåƒæ—¶é»˜è®¤ä½¿ç”¨çš„é•œåƒ busybox:1.31.1 ä»¥ä¸‹ä¸ºä¸€ä¸ªæ³¨å†Œè¿‡ç¨‹çš„äº¤äº’ç¤ºä¾‹ï¼š\nbash-4.4# gitlab-runner registerÂ Runtime platformÂ arch=amd64 os=linux pid=205 revision=05161b14 version=12.4.1 Running in system-mode.Â Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/): http://172.18.0.208/ Please enter the gitlab-ci token for this runner: cEJ611JDeCWSMyu7WXWi Please enter the gitlab-ci description for this runner: [e0311b0ce34b]: sonarqube-runner Please enter the gitlab-ci tags for this runner (comma separated): sonarqube,common-build Registering runner... succeededÂ runner=cEJ611JD Please enter the executor: virtualbox, docker+machine, docker-ssh+machine, custom, docker-ssh, parallels, kubernetes, docker, shell, ssh: docker Please enter the default Docker image (e.g. ruby:2.6): busybox:1.31.1 Runner registered successfully. Feel free to start it, but if it\u0026#39;s running already the config should be automatically reloaded! æ³¨å†Œåç¡®è®¤ å®Œæˆååœ¨åˆšæ‰çš„é¡µé¢å¯ä»¥çœ‹åˆ°ï¼› å–æ¶ˆæ³¨å†Œ ä½¿ç”¨ list å‘½ä»¤æŸ¥çœ‹å½“å‰æ³¨å†Œçš„tokenåŠurl\ngitlab-runner list # è¾“å‡ºç±»ä¼¼ Runtime platform arch=amd64 os=linux pid=23 revision=05161b14 version=12.4.1 Listing configured runners ConfigFile=/etc/gitlab-runner/config.toml sonarqube-runner Executor=docker Token=wNwxjEztRpKxYDyK1zVd URL=http://172.18.0.208/ ä½¿ç”¨listå‘½ä»¤è¾“å‡ºçš„tokenæœºurlä½œä¸ºå‚æ•° ä½¿ç”¨unregisterå‘½ä»¤å–æ¶ˆæ³¨å†Œ\ngitlab-runner unregister -t 7KM7ftthLAYeJdsB3Tbk -u http://172.18.0.208/ äº†è§£æ›´å¤š DOCKER æ–¹å¼å®‰è£…gitlab-runner Linuxå®‰è£…gitlab-runner-Gitlabå®˜æ–¹æ–‡æ¡£ ä½¿ç”¨Dockerè¿è¡ŒGitlab-Runner-Gitlabå®˜æ–¹æ–‡æ¡£ æ³¨å†ŒRunner-Gitlabå®˜æ–¹æ–‡æ¡£ Gitlab-Runner alpine Dockerfile Windowsä¸Šæ³¨å†ŒRunner å¦‚ä½•åœ¨dockeræ‰§è¡Œå™¨ä¸­æ„å»ºDockeré•œåƒï¼Ÿ ","permalink":"https://hanlyjiang.github.io/posts/gitlab-%E5%AE%89%E8%A3%85%E5%B9%B6%E6%B3%A8%E5%86%8Cgitlab-runner/","summary":"\u003cp\u003eæœ¬æ–‡ä»‹ç»Gitlab-Runnerçš„å®‰è£…è¿è¡Œï¼ˆåŒ…æ‹¬dockeræ–¹å¼å®‰è£…è¿è¡ŒåŠäºŒè¿›åˆ¶ç›´æ¥è¿è¡Œï¼‰ï¼Œå¹¶ä»‹ç»å¦‚ä½•å°†Gitlabæ³¨å†Œåˆ°Gitlabã€‚åŒæ—¶è¿˜ä»‹ç»äº†gitlab-runnerçš„ä¸€äº›å¸¸ç”¨æ“ä½œå‘½ä»¤ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"å®‰è£…gitlab-runner\"\u003eå®‰è£…Gitlab-Runner\u003c/h2\u003e\n\u003cp\u003egitlab-runnerå¯ä»¥ä½¿ç”¨dockeræ–¹å¼è¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨ä¸»æœºä¸Šè¿è¡Œå…¶äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œé€‰æ‹©ï¼š\u003c/p\u003e","title":"Gitlab-Runnerå®‰è£…å¹¶æ³¨å†Œ "},{"content":"å°†gitlabï¼ˆDockeræ–¹å¼è¿è¡Œï¼‰ä»12.10.0å‡çº§åˆ°13.0.6 çš„è¿‡ç¨‹è®°å½•ã€‚\nå‡çº§å‡†å¤‡å·¥ä½œ ç¡®å®šå‡çº§è·¯çº¿ ç°æœ‰ç‰ˆæœ¬ï¼š12.10.0 å½“ä¸‹ç›®æ ‡ç‰ˆæœ¬ï¼š13.0.6 ç»“åˆ Gitlabå‡çº§è·¯çº¿å»ºè®® ç¡®å®šå¦‚ä¸‹å‡çº§è·¯çº¿ï¼š 12.10.0 -\u0026gt; 13.0.0 -\u0026gt; 13.0.6 ç”±äºæˆ‘ä»¬è·¨å¤§ç‰ˆæœ¬å‡çº§äº†ï¼ˆ12-13ï¼‰ï¼Œæ‰€ä»¥å¼•å…¥äº† 13.0.0 çš„ä¸­é—´å‡çº§è·¯å¾„ è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ æŸ¥çœ‹ gitlab releaseé¡µé¢ ä¿¡æ¯ æŸ¥çœ‹ gitlab docker hub è·å–gitlab-ce dockeré•œåƒç‰ˆæœ¬TAGï¼š 13.0.0: gitlab/gitlab-ce:13.0.0-ce.0 13.0.6: gitlab/gitlab-ce:13.0.6-ce.0 æŸ¥çœ‹å‡çº§æ³¨æ„äº‹é¡¹ å‡çº§æµç¨‹ï¼š https://docs.gitlab.com/omnibus/docker/README.html#update ç‰ˆæœ¬å‡çº§å»ºè®®è·¯çº¿ï¼šhttps://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations å¤‡ä»½ å¤‡ä»½æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¤‡ä»½çš„æ•°æ®é‡ä¸ç›¸åŒï¼š\nå¯¹dockeræŒ‚è½½çš„gitlabæ•°æ®ç›®å½•æ•´ä½“å¤‡ä»½ ä½¿ç”¨ gitlabçš„ gitlab-backup create å‘½ä»¤åˆ›å»ºå¤‡ä»½ï¼Œå¯åŒ…å«æ‰€æœ‰gitä»“åº“ï¼ŒåŒ…æ‹¬wikiåŠæƒé™ä¿¡æ¯ã€‚ å»ºè®®å¯¹æŒ‚è½½çš„gitlabæ•°æ®ç›®å½•è¿›è¡Œä¸€æ¬¡æ•´ä½“å¤‡ä»½ï¼Œç›®å‰æš‚ä¸æ¸…æ¥šgitlab-backup createå‘½ä»¤åˆ›å»ºçš„å¤‡ä»½æ˜¯å¦åŒ…å«ciç›¸å…³å†…å®¹ã€‚\nä»¥ä¸‹å¯¹gitalb-backup å‘½ä»¤æ‰§è¡Œå¤‡ä»½è¿›è¡Œç®€è¦ä»‹ç»ã€‚æ•°æ®ç›®å½•çš„å¤‡ä»½æ–¹å¼ç›´æ¥å¯¹ç›®å½•è¿›è¡Œæ“ä½œå³å¯ã€‚\nè¿›å…¥åˆ°gitlabéƒ¨ç½²æœºå™¨ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š\ndocker exec -t \u0026lt;container name\u0026gt; gitlab-backup create # å¦‚æœdockerå®¹å™¨çš„åç§°æ˜¯gitlabï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¤‡ä»½å®Œæˆåä½äºgitlabçš„æ•°æ®ç›®å½•ï¼Œå¦‚ï¼š/data/gitlab/data/backups/ docker exec -t $(docker ps | grep gitlab | awk \u0026#39;{print $1}\u0026#39;) gitlab-backup create # å¤‡ä»½é…ç½®ç›®å½• sudo tar -cvf /data/gitlab/data/backups/1592710400_2020_06_21_12.10.0_gitlab_config_backup.tar /data/gitlab/config æ‰§è¡Œå‡çº§ï¼š è¿›å…¥åˆ°gitlabéƒ¨ç½²æœºå™¨ ssh -p 10022 geostar@172.18.0.208 è·å–Gitlabä¸­é—´ç‰ˆæœ¬é•œåƒåŠæœ€ç»ˆç‰ˆæœ¬é•œåƒ docker pull gitlab/gitlab-ce:13.0.0-ce.0 docker pull gitlab/gitlab-ce:13.0.6-ce.0 åœæ­¢å¹¶ç§»é™¤ç°æœ‰æœåŠ¡ sudo docker stop gitlab sudo docker rm gitlab è¿›è¡Œå‡çº§ï¼Œä½¿ç”¨ 13.0.0 çš„é•œåƒè¿è¡Œgitlabï¼Œgitlabä¼šè‡ªåŠ¨å¤„ç†æ•°æ®å‡çº§æµç¨‹ sudo docker run --detach \\ --hostname 172.18.0.208 \\ --publish 443:443 --publish 80:80 --publish 22:22 \\ --name gitlab \\ --restart always \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.0.0-ce.0 å¾… 13.0.0 å‡çº§å®Œæ¯•ä¹‹åï¼Œå‡çº§åˆ° 13.0.6ï¼Œä½¿ç”¨ 13.0.6 çš„é•œåƒè¿è¡Œgitlab sudo docker stop gitlab sudo docker rm gitlab sudo docker run --detach \\ --hostname 172.18.0.208 \\ --publish 443:443 --publish 80:80 --publish 22:22 \\ --name gitlab \\ --restart always \\ --volume /data/gitlab/config:/etc/gitlab \\ --volume /data/gitlab/logs:/var/log/gitlab \\ --volume /data/gitlab/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.0.6-ce.0 ç¡®è®¤å‡çº§æˆåŠŸ ç™»å½•ç®¡ç†å‘˜è´¦å·ï¼Œè¿›å…¥ç®¡ç†ä¸­å¿ƒ-ä»ªè¡¨ç›˜ï¼ŒæŸ¥çœ‹gitlabç‰ˆæœ¬ï¼š\n","permalink":"https://hanlyjiang.github.io/posts/gitlab-sheng-ji-ji-lu-12100-1306/","summary":"\u003cp\u003eå°†gitlabï¼ˆDockeræ–¹å¼è¿è¡Œï¼‰ä»12.10.0å‡çº§åˆ°13.0.6 çš„è¿‡ç¨‹è®°å½•ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"å‡çº§å‡†å¤‡å·¥ä½œ\"\u003eå‡çº§å‡†å¤‡å·¥ä½œ\u003c/h2\u003e\n\u003ch3 id=\"ç¡®å®šå‡çº§è·¯çº¿\"\u003e\u003cstrong\u003eç¡®å®šå‡çº§è·¯çº¿\u003c/strong\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eç°æœ‰ç‰ˆæœ¬ï¼š12.10.0\u003c/li\u003e\n\u003cli\u003eå½“ä¸‹ç›®æ ‡ç‰ˆæœ¬ï¼š13.0.6\u003c/li\u003e\n\u003cli\u003eç»“åˆ \u003ca href=\"https://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations\"\u003eGitlabå‡çº§è·¯çº¿å»ºè®®\u003c/a\u003e ç¡®å®šå¦‚ä¸‹å‡çº§è·¯çº¿ï¼š\n\u003cul\u003e\n\u003cli\u003e12.10.0 -\u0026gt; 13.0.0 -\u0026gt; 13.0.6\u003c/li\u003e\n\u003cli\u003eç”±äºæˆ‘ä»¬è·¨å¤§ç‰ˆæœ¬å‡çº§äº†ï¼ˆ12-13ï¼‰ï¼Œæ‰€ä»¥å¼•å…¥äº† 13.0.0 çš„ä¸­é—´å‡çº§è·¯å¾„\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯\"\u003e\u003cstrong\u003eè·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯\u003c/strong\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eæŸ¥çœ‹ gitlab releaseé¡µé¢ ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹ gitlab docker hub è·å–gitlab-ce dockeré•œåƒç‰ˆæœ¬TAGï¼š\u003c/li\u003e\n\u003cli\u003e13.0.0: \u003ccode\u003egitlab/gitlab-ce:13.0.0-ce.0\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e13.0.6: \u003ccode\u003egitlab/gitlab-ce:13.0.6-ce.0\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eæŸ¥çœ‹å‡çº§æ³¨æ„äº‹é¡¹\u003c/li\u003e\n\u003cli\u003eå‡çº§æµç¨‹ï¼š \u003ca href=\"https://docs.gitlab.com/omnibus/docker/README.html#update\"\u003ehttps://docs.gitlab.com/omnibus/docker/README.html#update\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eç‰ˆæœ¬å‡çº§å»ºè®®è·¯çº¿ï¼šhttps://docs.gitlab.com/ee/policy/maintenance.html#upgrade-recommendations\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"å¤‡ä»½\"\u003eå¤‡ä»½\u003c/h2\u003e\n\u003cp\u003eå¤‡ä»½æœ‰ä¸¤ç§æ–¹å¼ï¼Œå¤‡ä»½çš„æ•°æ®é‡ä¸ç›¸åŒï¼š\u003c/p\u003e","title":"Gitlabå‡çº§è®°å½•ï¼ˆ12.10.0-13.0.6ï¼‰"},{"content":"ä¸»è¦å†…å®¹ï¼š\nä½¿ç”¨dockerè¿è¡Œ gitlabï¼› é…ç½®LDAPåŠé‚®ç®±ï¼› é…ç½®ç®¡ç†å‘˜è´¦å·ï¼› é…ç½®é‚®ç®±é€šçŸ¥ï¼› å…³é—­ç”¨æˆ·æ³¨å†Œï¼› å®‰è£… æˆ‘ä»¬ä½¿ç”¨dockeræ¥å®‰è£…Gitlabï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯å®‰è£…è¿è¡Œï¼Œå®Œæˆåä½¿ç”¨\nexport GITLAB_DATA=/data/gitlab # è®¾ç½®ä¸»æœºçš„ipåŸŸå export HOST_IP=192.168.43.62 mkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data docker run --detach \\ --hostname $HOST_IP \\ --publish 443:443 --publish 80:80 --publish 22:22 \\ --name gitlab \\ --restart always \\ --volume $GITLAB_DATA/config:/etc/gitlab \\ --volume $GITLAB_DATA/logs:/var/log/gitlab \\ --volume $GITLAB_DATA/data:/var/opt/gitlab \\ gitlab/gitlab-ce:13.9.1-ce.0 æ•°æ®å…¨éƒ¨æŒ‚è½½åœ¨å¤–éƒ¨ç›®å½• GITLAB_DATA ä¸­ --hostname 192.168.43.62 : æŒ‡å®šå½“å‰æœåŠ¡çš„IPæˆ–è€…åŸŸåï¼Œåç»­å°†ä¼šæ˜¾ç¤ºä¸ºgitlabä»£ç ä»“åº“çš„å…‹éš†åœ°å€ --restart always : è®¾ç½®æœåŠ¡è‡ªåŠ¨é‡å¯ æŸ¥çœ‹gitlabçš„å¯ç”¨ç‰ˆæœ¬ï¼š\ndockerhub/gitlab-ce gitlab release page æŸ¥çœ‹å¯åŠ¨çŠ¶æ€ å¯åŠ¨æœŸé—´å¯ä»¥ä½¿ç”¨ docker ps æŸ¥çœ‹çŠ¶æ€ï¼Œå¦‚STATUSä¸­æ˜¾ç¤ºä¸ºstartingåˆ™è¡¨ç¤ºæœåŠ¡è¿˜åœ¨å¯åŠ¨ä¸­ï¼Œå¦‚æ˜¾ç¤ºä¸ºhealthyåˆ™è¡¨ç¤ºæœåŠ¡å·²æ­£å¸¸å¯åŠ¨ï¼Œå³å¯è®¿é—® http://192.168.43.62 è®¿é—®Gitlabçš„webåœ°å€ã€‚\nCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 79b432f0f601 gitlab/gitlab-ce:13.0.6-ce.0 \u0026#34;/assets/wrapper\u0026#34; 2 months ago Up 2 weeks (healthy) 0.0.0.0:22-\u0026gt;22/tcp, 0.0.0.0:80-\u0026gt;80/tcp, 0.0.0.0:443-\u0026gt;443/tcp gitlab ä¹Ÿå¯ä½¿ç”¨ docker logs -f gitlab æ¥æŸ¥çœ‹gitlabçš„æœåŠ¡å¯åŠ¨æ—¥å¿—\nè®¾ç½®rootç®¡ç†å‘˜ç”¨æˆ·å¯†ç  é¦–æ¬¡æ‰“å¼€é¡µé¢åä¼šæç¤ºè®¾ç½®rootç”¨æˆ·çš„å¯†ç ï¼Œè®¾ç½®ååŠ¡å¿…è®°å½•å¥½ç”¨æˆ·å¯†ç ï¼Œåç»­å°†ä½¿ç”¨æ­¤ç”¨æˆ·å¯¹Gitlabè¿›è¡Œç®¡ç†\né…ç½®LDAP æœåŠ¡å¯åŠ¨æ­£å¸¸åï¼Œ$GITLAB_DATA/config æ–‡ä»¶å¤¹ä¸­å³ç”Ÿæˆäº†gitlabçš„é…ç½®æ–‡ä»¶ï¼Œå¯ç¼–è¾‘$GITLAB_DATA/config/gitlab.rb ï¼ˆå¯¹åº”å®¹å™¨å†…éƒ¨ /etc/gitlab/gitlab.rb ï¼‰æ–‡ä»¶æ¥ä¿®æ”¹gitlabé…ç½®ä»¥ä½¿ç”¨LDAP\nvim /etc/gitlab/gitlab.rb é€šè¿‡? æœç´¢LDAPï¼Œæ‰¾åˆ°å¦‚ä¸‹é…ç½®ç«¯ï¼ŒæŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œä¿®æ”¹ï¼š\n### LDAP Settings ###! Docs: https://docs.gitlab.com/omnibus/settings/ldap.html ###! **Be careful not to break the indentation in the ldap_servers block. It is ###! in yaml format and the spaces must be retained. Using tabs will not work.** gitlab_rails[\u0026#39;ldap_enabled\u0026#39;] = true gitlab_rails[\u0026#39;ldap_servers\u0026#39;] = YAML.load \u0026lt;\u0026lt;-\u0026#39;EOS\u0026#39; main: label: \u0026#39;åŸŸè´¦å·\u0026#39; host: \u0026#39;172.17.0.3\u0026#39; port: 389 uid: \u0026#39;sAMAccountName\u0026#39; bind_dn: \u0026#39;CN=åŸŸè´¦å·è¯»å–ç”¨æˆ·,OU=colorless-åŸŸç”¨æˆ·,DC=colorless,DC=com,DC=cn\u0026#39; password: \u0026#39;åŸŸè´¦å·è¯»å–ç”¨æˆ·çš„ç™»å½•å¯†ç \u0026#39; encryption: \u0026#39;plain\u0026#39; # \u0026#34;start_tls\u0026#34; or \u0026#34;simple_tls\u0026#34; or \u0026#34;plain\u0026#34; verify_certificates: false smartcard_auth: false active_directory: true allow_username_or_email_login: false # æ˜¯å¦å…è®¸ä»¥ç”¨æˆ·åç™»å½•ï¼ˆé‚®ç®±ä¹Ÿä¼šå–ç”¨æˆ·åæ¥ä¸¥é‡ï¼‰ lowercase_usernames: false block_auto_created_users: false base: \u0026#39;OU=colorless-åŸŸç”¨æˆ·,DC=colorless,DC=com,DC=cn\u0026#39; user_filter: \u0026#39;\u0026#39; EOS é…ç½®ä¿®æ”¹è¯´æ˜ï¼š\nldap_enabled éœ€è¦è®¾ç½®ä¸ºtrue ldap_servers é…ç½®ADåŸŸç›¸å…³ä¿¡æ¯ labelï¼š éšä¾¿å–ï¼Œä¼šæ˜¾ç¤ºåœ¨gitlabçš„ç™»å½•é¡µé¢ hostï¼š åŸŸæ§åˆ¶æœåŠ¡å™¨ä¸»æœºåœ°å€ portï¼š åŸŸæ§åˆ¶å™¨æœåŠ¡ç«¯å£ uidï¼š å°†åŸŸç”¨æˆ·ä¿¡æ¯ä¸­çš„å“ªä¸ªå­—æ®µä½œä¸ºgitlabä¸Šçš„ç™»å½•æ ‡è¯†ï¼ˆä¸€èˆ¬éƒ½æ˜¯sAMAccountNameï¼‰ bind_dnï¼š ç”¨äºè®¿é—®åŸŸæ§åˆ¶æœåŠ¡å™¨çš„ç”¨æˆ·è´¦å·ï¼Œç”¨æˆ·è´¦å·çš„æ ¼å¼éœ€è¦ä½¿ç”¨CN=xxx,OU=XXX,DC=XXXX ç±»ä¼¼çš„æ ¼å¼ passwordï¼š å¯¹åº”çš„base_dnè´¦å·çš„å¯†ç  baseï¼š ç”¨äºç™»å½•æ—¶ï¼Œä¼šå»baseæ‰€å®šä¹‰çš„ç»„é‡Œé¢å»æ£€ç´¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚ç”¨æˆ·åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œæ‰å¯ä»¥ç™»å½•ï¼›å¦‚åŠç”¨äºå…¬å¸ä¸€ä¸ªéƒ¨é—¨çš„ç™»å½•ï¼Œå¯å°†baseå€¼é…ç½®åˆ°éƒ¨é—¨çº§åˆ«ï¼Œåˆ™å…¶ä»–éƒ¨åˆ†æ— æ³•ä»¥åŸŸè´¦å·è¿›è¡Œç™»å½•ï¼› æç¤ºï¼š å¦‚æ— æ³•ç¡®è®¤ uidï¼Œbind_dnï¼Œbase ç­‰çš„å€¼ï¼Œå¯ä»¥å’¨è¯¢ä¿¡æ¯ä¸­å¿ƒæˆ–è€…ä½¿ç”¨ADåŸŸè®¿é—®æŸ¥çœ‹è½¯ä»¶ï¼ˆå¦‚ï¼šApache Directoryï¼‰è¿æ¥åˆ°åŸŸè´¦å·æ§åˆ¶å™¨æœåŠ¡åï¼Œé€šè¿‡å›¾å½¢ç•Œé¢æŸ¥çœ‹å¯¹åº”ä¿¡æ¯ï¼›\nä¿®æ”¹å®Œæ¯•åéœ€è¦ä¿å­˜æ–‡ä»¶åé‡å¯gitlabæœåŠ¡ï¼Œå¯¹äºdockerå¯åŠ¨çš„gitlabæ¥è¯´ï¼Œå¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤é‡å¯æœåŠ¡ï¼š\n# å…¶ä¸­gitlabä¸ºæˆ‘ä»¬ä½¿ç”¨docker run å‘½ä»¤æ—¶é€šè¿‡--nameé€‰é¡¹æŒ‡å®šçš„å®¹å™¨åç§° docker restart gitlab å¾…gitlabé‡å¯å®Œæ¯•åï¼Œç™»å½•ç•Œé¢å³å‡ºç°åŸŸè´¦å·ç™»å½•çš„tabå…¥å£ï¼Œç‚¹å‡»åŸŸè´¦å·tabå³å¯ä½¿ç”¨åŸŸè´¦å·è¿›è¡Œç™»å½•\né…ç½®é‚®ç®±é€šçŸ¥ å…¬å¸é‚®ç®±æœåŠ¡å™¨é…ç½®ï¼š\ngitlab_rails[\u0026#39;smtp_enable\u0026#39;] = true gitlab_rails[\u0026#39;smtp_address\u0026#39;] = \u0026#34;mail.colorless.com.cn\u0026#34; gitlab_rails[\u0026#39;smtp_port\u0026#39;] = 25 gitlab_rails[\u0026#39;smtp_user_name\u0026#39;] = \u0026#34;gitlab@colorless.com.cn\u0026#34; gitlab_rails[\u0026#39;smtp_password\u0026#39;] = \u0026#34;xxxxx\u0026#34; gitlab_rails[\u0026#39;smtp_domain\u0026#39;] = \u0026#34;colorless.com.cn\u0026#34; gitlab_rails[\u0026#39;smtp_authentication\u0026#39;] = \u0026#34;login\u0026#34; gitlab_rails[\u0026#39;smtp_enable_starttls_auto\u0026#39;] = true gitlab_rails[\u0026#39;smtp_tls\u0026#39;] = false 163é‚®ç®±é…ç½®ç¤ºä¾‹ï¼šï¼ˆéœ€åœ¨163é‚®ç®±ä¸­å¼€å¯SMTPæœåŠ¡ï¼Œå¯å‚è€ƒï¼š CSDN-å¦‚ä½•ä½¿ç”¨163çš„SMTPæœåŠ¡å‘é‚®ä»¶ï¼Ÿï¼‰\ngitlab_rails[\u0026#39;smtp_enable\u0026#39;] = true gitlab_rails[\u0026#39;smtp_address\u0026#39;] = \u0026#34;smtp.163.com\u0026#34; gitlab_rails[\u0026#39;smtp_port\u0026#39;] = 25 gitlab_rails[\u0026#39;smtp_user_name\u0026#39;] = \u0026#34;colorless@163.com\u0026#34; gitlab_rails[\u0026#39;smtp_password\u0026#39;] = \u0026#34;å¯†ç \u0026#34; gitlab_rails[\u0026#39;smtp_domain\u0026#39;] = \u0026#34;163.com\u0026#34; gitlab_rails[\u0026#39;smtp_authentication\u0026#39;] = \u0026#34;login\u0026#34; gitlab_rails[\u0026#39;smtp_enable_starttls_auto\u0026#39;] = true gitlab_rails[\u0026#39;smtp_tls\u0026#39;] = false å…³é—­åŠç®¡ç†å‘˜é…ç½® èµ‹äºˆæŒ‡å®šåŸŸè´¦å·ç®¡ç†å‘˜æƒé™ åœ¨é…ç½®äº†åŸŸè´¦å·ç™»å½•ä¹‹åï¼Œå…ˆè®©éœ€è¦è®¾ç½®ä¸ºç®¡ç†å‘˜çš„è´¦å·ä½¿ç”¨åŸŸè´¦å·ç™»å½•ä¸€æ¬¡gitlabï¼Œç™»å½•ågitlabå³ä¼šä¸ºè¯¥ç”¨æˆ·åˆ›å»ºå…³è”çš„gitlabè´¦å·ã€‚\nç„¶åä½¿ç”¨rootç”¨æˆ·ç™»å½•ï¼Œè¿›å…¥\nå°†ç”¨æˆ·çš„è®¿é—®ç±»å‹åˆ‡æ¢ä¸ºç®¡ç†å‘˜ï¼š\nå…³é—­ç”¨æˆ·æ³¨å†Œ åœ¨é…ç½®äº†åŸŸè´¦å·ç™»å½•ä¹‹åï¼Œå¯ä»¥å…³é—­ç”¨æˆ·æ³¨å†Œï¼Œå³åªå…è®¸æ‹¥æœ‰åŸŸè´¦å·çš„äººå‘˜è¿›è¡Œç™»å½•ï¼›\n","permalink":"https://hanlyjiang.github.io/posts/gitlab-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEgitlab/","summary":"\u003cp\u003eä¸»è¦å†…å®¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä½¿ç”¨dockerè¿è¡Œ gitlabï¼›\u003c/li\u003e\n\u003cli\u003eé…ç½®LDAPåŠé‚®ç®±ï¼›\u003c/li\u003e\n\u003cli\u003eé…ç½®ç®¡ç†å‘˜è´¦å·ï¼›\u003c/li\u003e\n\u003cli\u003eé…ç½®é‚®ç®±é€šçŸ¥ï¼›\u003c/li\u003e\n\u003cli\u003eå…³é—­ç”¨æˆ·æ³¨å†Œï¼›\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"å®‰è£…\"\u003eå®‰è£…\u003c/h2\u003e\n\u003cp\u003eæˆ‘ä»¬ä½¿ç”¨dockeræ¥å®‰è£…Gitlabï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯å®‰è£…è¿è¡Œï¼Œå®Œæˆåä½¿ç”¨\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-shell\" data-lang=\"shell\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eexport GITLAB_DATA\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e/data/gitlab\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# è®¾ç½®ä¸»æœºçš„ipåŸŸå\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eexport HOST_IP\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e192.168.43.62\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emkdir $GITLAB_DATA/config $GITLAB_DATA/logs $GITLAB_DATA/data\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker run --detach \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --hostname $HOST_IP \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --publish 443:443 --publish 80:80 --publish 22:22 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --name gitlab \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --restart always \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --volume $GITLAB_DATA/config:/etc/gitlab \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --volume $GITLAB_DATA/logs:/var/log/gitlab \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        --volume $GITLAB_DATA/data:/var/opt/gitlab \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e        gitlab/gitlab-ce:13.9.1-ce.0\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eæ•°æ®å…¨éƒ¨æŒ‚è½½åœ¨å¤–éƒ¨ç›®å½• GITLAB_DATA ä¸­\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--hostname 192.168.43.62\u003c/code\u003e : æŒ‡å®šå½“å‰æœåŠ¡çš„IPæˆ–è€…åŸŸåï¼Œåç»­å°†ä¼šæ˜¾ç¤ºä¸ºgitlabä»£ç ä»“åº“çš„å…‹éš†åœ°å€\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--restart always\u003c/code\u003e : è®¾ç½®æœåŠ¡è‡ªåŠ¨é‡å¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæŸ¥çœ‹gitlabçš„å¯ç”¨ç‰ˆæœ¬ï¼š\u003c/p\u003e","title":"Gitlabå®‰è£…é…ç½®"},{"content":"Androidæä¾›çš„å‡ ç§JSåŒJavaäº¤äº’çš„æ–¹å¼ä»‹ç»ï¼Œé€šè¿‡ä¸€ä¸ªå®ä¾‹ä»‹ç»é€šè¿‡evaluateJavascriptè°ƒç”¨JSæ–¹æ³•ã€‚\nAndroidæä¾›çš„jsåŸç”Ÿäº¤äº’API Androidè°ƒç”¨ JS ä»£ç ï¼š é€šè¿‡WebViewçš„ loadUrl() é€šè¿‡WebViewçš„ evaluateJavascript() æ–¹æ³• Androidè°ƒç”¨ JS ä»£ç ä¸»è¦ä½¿ç”¨ ç¬¬äºŒç§æ–¹æ³•ã€‚\nJS è°ƒç”¨ Android ä»£ç ï¼š é€šè¿‡ WebView çš„ addJavascriptInterface() è¿›è¡Œå¯¹è±¡æ˜ å°„ é€šè¿‡WebChromeClientçš„ onJsAlert() ã€onJsConfirm()ã€onJsPrompt() æ–¹æ³•å›è°ƒæ‹¦æˆªJSå¯¹è¯æ¡†alert()ã€confirm()ã€prompt() æ¶ˆæ¯ é€šè¿‡WebViewClientçš„shouldOverrideUrlLoading() æ–¹æ³•å›è°ƒæ‹¦æˆª url ç¬¬2å’Œç¬¬3ä¸­æ–¹å¼èƒ½åŠ›æœ‰é™ï¼Œæ‰€ä»¥ä¸»è¦æ˜¯ç¬¬ä¸€ç§ã€‚\nå®˜æ–¹ç¤ºä¾‹ä»£ç ï¼š\naddJavaScriptInterface æ³¨å…¥åŸç”Ÿå¯¹è±¡åˆ°JS + åŸç”Ÿé€šè¿‡loadUrl è°ƒç”¨JSä»£ç \nclass JsObject { @JavascriptInterface public String toString() { return \u0026#34;injectedObject\u0026#34;; } } webview.getSettings().setJavaScriptEnabled(true); // æ³¨å…¥Javaå¯¹è±¡åˆ° JavaScript ï¼ŒJSä¸­å¯ä»¥é€šè¿‡ injectedObject æ¥è°ƒç”¨åŸç”Ÿä»£ç  webView.addJavascriptInterface(new JsObject(), \u0026#34;injectedObject\u0026#34;); webView.loadData(\u0026#34;\u0026#34;, \u0026#34;text/html\u0026#34;, null); webView.loadUrl(\u0026#34;javascript:alert(injectedObject.toString())\u0026#34;); æ³¨æ„ï¼š\nAndroid 4.2ï¼ˆJELLY BEANï¼‰åŠæ›´é«˜ç‰ˆæœ¬ä¸­åªæœ‰è¢«JavascriptInterfaceæ³¨è§£çš„publicæ–¹æ³•æ‰å¯ä»¥åœ¨jsä¸­è°ƒç”¨ï¼› Android4.2ä»¥ä¸‹è®¾å¤‡ä¸Šï¼Œæ‰€æœ‰publicæ–¹æ³•éƒ½å¯ä»¥è¢«jsè®¿é—®ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰ é€šè¿‡addJavaScriptInterfaceåŠ å…¥å¯¹è±¡ ï¼š å¿…é¡»åœ¨æ³¨å…¥å¯¹è±¡ä¹‹å‰å¯ç”¨JavaScriptï¼Œå¹¶ä¸”æ³¨å…¥çš„å¯¹è±¡ç›´åˆ°ä¸‹æ¬¡é¡µé¢é‡æ–°åŠ è½½æ‰ä¼šå‡ºç°åœ¨JavaScriptä¸­ã€‚ åº”ç”¨å®ä¾‹ï¼šJavaåŒVueäº¤äº’ æˆ‘ä»¬éœ€è¦åœ¨é¡µé¢åŠ è½½å®Œæ¯•ä¹‹åæ›´æ–°æ•°æ®ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡Javaä¾§è°ƒç”¨JSçš„æ–¹æ³•æ¥å°†æ•°æ®ä¼ é€’ç»™JSé€šçŸ¥å…¶æ›´æ–°ï¼› é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨JSä¾§å®šä¹‰ä¸€ä¸ªæ¥æ”¶æ•°æ®çš„æ–¹æ³•ï¼Œä¸ºäº†èƒ½è®©Javaä¾§èƒ½æ–¹ä¾¿æ‰¾åˆ°ï¼Œæˆ‘ä»¬å°†æ–¹æ³•å®šä¹‰åˆ°windowå¯¹è±¡ä¸Šã€‚ ç„¶ååœ¨WebViewä¸­é¡µé¢åŠ è½½å®Œæ¯•ï¼ˆonPageFinishedï¼‰åï¼Œè°ƒç”¨ webView.evaluateJavascript æ¥è°ƒç”¨æ­¤JSæ–¹æ³•ï¼›\nJSä¾§æ–¹æ³•æ³¨å†Œ æ³¨æ„ï¼š\néœ€è¦æ·»åŠ åˆ°å…¨å±€å¯¹è±¡ï¼Œè¿™æ ·æ‰èƒ½Androidä¾§æ‰èƒ½è°ƒç”¨ï¼› ç”±äºç¤ºä¾‹ä¸­åªæœ‰ä¸€ä¸ªappç»„ä»¶ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ vm.$children[0] è·å–vueç»„ä»¶ component.$data è·å–ç»„ä»¶çš„æ•°æ®ï¼Œå¹¶èµ‹å€¼ï¼Œèµ‹å€¼åviewä¼šè‡ªåŠ¨å˜åŒ–ï¼› // main.js /* eslint-disable no-new */ let vm = new Vue({ el: \u0026#39;#app\u0026#39;, components: {App}, template: \u0026#39;\u0026lt;App/\u0026gt;\u0026#39;, }); // å®šä¹‰hnUpdateDataæ–¹æ³•åˆ°windowå…¨å±€å¯¹è±¡ window.hnApp = {}; window.hnApp.hnUpdateData = function (data) { if (!data) { Android.alert(\u0026#34;æ•°æ®æ ¼å¼ä¸æ­£ç¡®\u0026#34;); return; } console.log(data); const jsonData = JSON.parse(data); const component = vm.$children[0]; component.$data.header = jsonData.header ? jsonData.header : {}; component.$data.jjb = jsonData.jjb ? jsonData.jjb : {}; component.$data.events = jsonData.events ? jsonData.events : []; }; åŸç”Ÿä¾§è°ƒç”¨JS å®šä¹‰æ–¹æ³•-è°ƒç”¨JSæ–¹æ³•æ›´æ–°æ•°æ® private void tryUpdateWebData(JSdata jSdata) { if (isPageLoaded \u0026amp;\u0026amp; isDataReady) { String methodName = \u0026#34;window.hnApp.hnUpdateData\u0026#34;; String params = new Gson().toJson(jSdata); String js = \u0026#34;javascript:\u0026#34; + methodName + \u0026#34;(\u0026#34; + JSONObject.quote(params) + \u0026#34;)\u0026#34;; webView.evaluateJavascript(js, new ValueCallback\u0026lt;String\u0026gt;() { @Override public void onReceiveValue(String value) { } }); } } æ³¨æ„ï¼š\njsæ‰§è¡Œä»£ç ï¼šjavascript:methodName(å‚æ•°) å‚æ•°å¤„ç†ï¼šJSONObject.quote(params) å¯¹è±¡è½¬jsonå­—ç¬¦ä¸² WebViewåˆå§‹åŒ–å¹¶è°ƒç”¨JSæ–¹æ³• public void initView() { webView = (WebView) findViewById(R.id.web_view); webView.setWebViewClient(webViewClient); webView.setWebChromeClient(webChromeClient); webView.setDownloadListener(downloadListener); webView.requestFocusFromTouch(); WebSettings settings = webView.getSettings(); // Copy From Cordova SystemWebViewEngine.java settings.setJavaScriptEnabled(true); settings.setJavaScriptCanOpenWindowsAutomatically(true); settings.setJavaScriptEnabled(true); } private WebViewClient webViewClient = new WebViewClient() { @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP) @Override public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) { view.loadUrl(request.getUrl().toString()); super.shouldOverrideUrlLoading(view, request); return true; } @Override public void onPageFinished(WebView view, String url) { super.onPageFinished(view, url); isPageLoaded = true; // è°ƒç”¨jsæ›´æ–°æ•°æ® tryUpdateWebData(mData); } }; private WebChromeClient webChromeClient = new WebChromeClient() { // ... } ","permalink":"https://hanlyjiang.github.io/posts/android-webview%E4%B8%ADjava%E5%90%8Cjs%E7%9A%84%E4%BA%A4%E4%BA%92/","summary":"\u003cp\u003eAndroidæä¾›çš„å‡ ç§JSåŒJavaäº¤äº’çš„æ–¹å¼ä»‹ç»ï¼Œé€šè¿‡ä¸€ä¸ªå®ä¾‹ä»‹ç»é€šè¿‡\u003ccode\u003eevaluateJavascript\u003c/code\u003eè°ƒç”¨JSæ–¹æ³•ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"androidæä¾›çš„jsåŸç”Ÿäº¤äº’api\"\u003eAndroidæä¾›çš„jsåŸç”Ÿäº¤äº’API\u003c/h2\u003e\n\u003ch3 id=\"androidè°ƒç”¨-js-ä»£ç \"\u003eAndroidè°ƒç”¨ JS ä»£ç ï¼š\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eé€šè¿‡WebViewçš„ \u003cstrong\u003eloadUrl()\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eé€šè¿‡WebViewçš„ \u003cstrong\u003eevaluateJavascript()\u003c/strong\u003e æ–¹æ³•\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAndroidè°ƒç”¨ JS ä»£ç ä¸»è¦ä½¿ç”¨ ç¬¬äºŒç§æ–¹æ³•ã€‚\u003c/p\u003e\n\u003ch3 id=\"js-è°ƒç”¨-android-ä»£ç \"\u003eJS è°ƒç”¨ Android ä»£ç ï¼š\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé€šè¿‡ WebView çš„ addJavascriptInterface() è¿›è¡Œå¯¹è±¡æ˜ å°„\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eé€šè¿‡\u003cstrong\u003eWebChromeClient\u003c/strong\u003eçš„ \u003cstrong\u003eonJsAlert\u003c/strong\u003e() ã€\u003cstrong\u003eonJsConfirm\u003c/strong\u003e()ã€\u003cstrong\u003eonJsPrompt\u003c/strong\u003e() æ–¹æ³•å›è°ƒæ‹¦æˆªJSå¯¹è¯æ¡†\u003cstrong\u003ealert\u003c/strong\u003e()ã€\u003cstrong\u003econfirm\u003c/strong\u003e()ã€\u003cstrong\u003eprompt\u003c/strong\u003e() æ¶ˆæ¯\u003c/li\u003e\n\u003cli\u003eé€šè¿‡\u003cstrong\u003eWebViewClient\u003c/strong\u003eçš„\u003cstrong\u003eshouldOverrideUrlLoading()\u003c/strong\u003e æ–¹æ³•å›è°ƒæ‹¦æˆª url\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eç¬¬2å’Œç¬¬3ä¸­æ–¹å¼èƒ½åŠ›æœ‰é™ï¼Œæ‰€ä»¥ä¸»è¦æ˜¯ç¬¬ä¸€ç§ã€‚\u003c/p\u003e","title":"Android-WebViewä¸­JavaåŒJSçš„äº¤äº’"},{"content":" æ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤\nğŸ  å…³äºæœ¬ç«™ ğŸ’¾ æˆ‘é‡åˆ°çš„é—®é¢˜å¤§æ¦‚ç‡å…¶ä»–äººä¹Ÿé‡åˆ°è¿‡ï¼Œä»å…¶ä»–äººé‚£é‡Œè·å–è¿‡è§£å†³æ–¹æ¡ˆ/çµæ„Ÿ/å¯å‘ï¼Œæ‰€ä»¥å¸Œæœ›åŒæ ·èƒ½å¤Ÿç»™äºˆå…¶ä»–äººå¸®åŠ©ä¸å¯å‘ã€‚ âŒšï¸ æ—¶é—´æ€»éš¾å¤Ÿç”¨ï¼Œä½†æ„¿æˆ‘çš„åˆ†äº«èƒ½èŠ‚çœæŸäººçš„æ—¶é—´ã€‚ ğŸ‘¨â€ğŸ’» åšä¸»æ˜¯è° ğŸ¤– ç¨‹åºå‘˜ï¼Œä¸»è¦æ˜¯ Androidï¼Œä¹Ÿæäº›åˆ«çš„ â›¹ å…´è¶£çˆ±å¥½ ğŸ“Ÿ ä»¥å‰ç©æ‰‹æœºï¼ŒMP3ï¼ŒMP4ï¼Œå¹³æ¿ï¼Œåæ¥ç©ç”µè„‘ ğŸ“¬ è”ç³»æˆ‘å‘€ ğŸ“® hanlyjiang@outlook.com ğŸ‘‡à­  ä¸‹æ–¹è¯„è®º à­  ğŸ‘‡ ","permalink":"https://hanlyjiang.github.io/posts/about/","summary":"\u003cblockquote\u003e\n\u003cp\u003eæ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™å‘€ï¼Œå¾ˆé«˜å…´é‡è§ä½ ï¼ğŸ¤\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"-å…³äºæœ¬ç«™\"\u003eğŸ  å…³äºæœ¬ç«™\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ’¾ æˆ‘é‡åˆ°çš„é—®é¢˜å¤§æ¦‚ç‡å…¶ä»–äººä¹Ÿé‡åˆ°è¿‡ï¼Œä»å…¶ä»–äººé‚£é‡Œè·å–è¿‡è§£å†³æ–¹æ¡ˆ/çµæ„Ÿ/å¯å‘ï¼Œæ‰€ä»¥å¸Œæœ›åŒæ ·èƒ½å¤Ÿç»™äºˆå…¶ä»–äººå¸®åŠ©ä¸å¯å‘ã€‚\u003c/li\u003e\n\u003cli\u003eâŒšï¸ æ—¶é—´æ€»éš¾å¤Ÿç”¨ï¼Œä½†æ„¿æˆ‘çš„åˆ†äº«èƒ½èŠ‚çœæŸäººçš„æ—¶é—´ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"-åšä¸»æ˜¯è°\"\u003eğŸ‘¨â€ğŸ’» åšä¸»æ˜¯è°\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ¤– ç¨‹åºå‘˜ï¼Œä¸»è¦æ˜¯ Androidï¼Œä¹Ÿæäº›åˆ«çš„\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"-å…´è¶£çˆ±å¥½\"\u003eâ›¹ å…´è¶£çˆ±å¥½\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ“Ÿ ä»¥å‰ç©æ‰‹æœºï¼ŒMP3ï¼ŒMP4ï¼Œå¹³æ¿ï¼Œåæ¥ç©ç”µè„‘\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"-è”ç³»æˆ‘å‘€\"\u003eğŸ“¬ è”ç³»æˆ‘å‘€\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ“® \u003ca href=\"mailto:hanlyjiang@outlook.com\"\u003ehanlyjiang@outlook.com\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eğŸ‘‡à­  ä¸‹æ–¹è¯„è®º à­  ğŸ‘‡\u003c/li\u003e\n\u003c/ul\u003e","title":"å…³äº"},{"content":"androidäº‹ä»¶åŸºç¡€åŠæ‰‹åŠ¿ï¼Œä¸»è¦å…³æ³¨å„ç§æ‰‹åŠ¿çš„ä½¿ç”¨åŠå…¶è®¡ç®—åŸç† ã€‚\nAndroidäº‹ä»¶åŸºç¡€ è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨æ¦‚å¿µ\näº‹ä»¶ç›‘å¬å™¨åŠäº‹ä»¶å¤„ç†ç¨‹åº å¯ç›´æ¥æŸ¥çœ‹ å®˜æ–¹æ–‡æ¡£ï¼Œæ­¤å¤„ä»…åšç®€è¦æè¿°ï¼›\näº‹ä»¶ç›‘å¬å™¨ Viewç±»çš„åŒ…å«ä¸€ä¸ªå›è°ƒæ–¹æ³•çš„æ¥å£ï¼Œé€šè¿‡setXXXListeneræ¥å®šä¹‰äº‹ä»¶å¤„ç†ç¨‹åºï¼›\näº‹ä»¶ç›‘å¬å™¨æ˜¯ View ç±»ä¸­åŒ…å«ä¸€ä¸ªå›è°ƒæ–¹æ³•çš„æ¥å£ã€‚å½“ç”¨æˆ·ä¸ç•Œé¢é¡¹ç›®ä¹‹é—´çš„äº’åŠ¨è§¦å‘å·²æ³¨å†Œç›‘å¬å™¨çš„ View å¯¹è±¡æ—¶ï¼ŒAndroid æ¡†æ¶å°†è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚\näº‹ä»¶ç›‘å¬å™¨æ¥å£ä¸­åŒ…å«ä»¥ä¸‹å›è°ƒæ–¹æ³•ï¼šonClick()ï¼ŒonLongClick()ï¼ŒonFocusChange()ï¼ŒonKey()ï¼ŒonTouch()ï¼ŒonCreateContextMenu()\næˆ‘ä»¬é‡ç‚¹å…³æ³¨onTouchï¼š\nonTouch()ï¼š åœ¨ View.OnTouchListener ä¸­ã€‚å½“ç”¨æˆ·æ‰§è¡Œå¯è§†ä¸ºè§¦æ‘¸äº‹ä»¶çš„æ“ä½œæ—¶ï¼ŒåŒ…æ‹¬æŒ‰ä¸‹ã€é‡Šæ”¾æˆ–å±å¹•ä¸Šçš„ä»»ä½•ç§»åŠ¨æ‰‹åŠ¿ï¼ˆåœ¨é¡¹ç›®è¾¹ç•Œå†…ï¼‰ï¼Œç³»ç»Ÿä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚\næ­¤æ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºç›‘å¬å™¨æ˜¯å¦å¤„ç†å®Œæ­¤äº‹ä»¶ã€‚é‡è¦çš„æ˜¯ï¼Œæ­¤äº‹ä»¶å¯ä»¥æ‹¥æœ‰å¤šä¸ªåˆ†å…ˆåé¡ºåºçš„æ“ä½œã€‚å› æ­¤ï¼Œå¦‚æœåœ¨æ”¶åˆ° down æ“ä½œäº‹ä»¶æ—¶è¿”å› falseï¼Œåˆ™è¡¨ç¤ºæ‚¨å¹¶æœªå¤„ç†å®Œæ­¤äº‹ä»¶ï¼Œè€Œä¸”å¯¹å…¶åç»­æ“ä½œä¹Ÿä¸æ„Ÿå…´è¶£ã€‚å› æ­¤ï¼Œæ‚¨æ— éœ€æ‰§è¡Œäº‹ä»¶å†…çš„ä»»ä½•å…¶ä»–æ“ä½œï¼Œå¦‚æ‰‹åŠ¿æˆ–æœ€ç»ˆçš„ up æ“ä½œäº‹ä»¶ã€‚\näº‹ä»¶å¤„ç†ç¨‹åº ç›´æ¥å¼•ç”¨å®˜æ–¹æ–‡æ¡£æè¿°ï¼š\nå¦‚æœæ‚¨ä» View æ„å»ºè‡ªå®šä¹‰ç»„ä»¶ï¼Œåˆ™å¯å®šä¹‰å‡ ç§å›è°ƒæ–¹æ³•ï¼Œç”¨ä½œé»˜è®¤äº‹ä»¶å¤„ç†ç¨‹åºã€‚åœ¨æœ‰å…³è‡ªå®šä¹‰ View ç»„ä»¶çš„æ–‡æ¡£ä¸­ï¼Œæ‚¨å°†äº†è§£ä¸€äº›ç”¨äºäº‹ä»¶å¤„ç†çš„å¸¸è§å›è°ƒï¼ŒåŒ…æ‹¬ï¼š\nonKeyDown(int, KeyEvent)ï¼šåœ¨å‘ç”Ÿæ–°çš„æŒ‰é”®äº‹ä»¶æ—¶è°ƒç”¨ã€‚ onKeyUp(int, KeyEvent)ï¼šåœ¨å‘ç”Ÿ key up äº‹ä»¶æ—¶è°ƒç”¨ã€‚ onTrackballEvent(MotionEvent)ï¼šåœ¨å‘ç”Ÿè½¨è¿¹çƒåŠ¨ä½œäº‹ä»¶æ—¶è°ƒç”¨ã€‚ onTouchEvent(MotionEvent)ï¼šåœ¨å‘ç”Ÿè§¦å±åŠ¨ä½œäº‹ä»¶æ—¶è°ƒç”¨ã€‚ onFocusChanged(boolean, int, Rect)ï¼šåœ¨ View å¯¹è±¡è·å¾—æˆ–å¤±å»ç„¦ç‚¹æ—¶è°ƒç”¨ã€‚ è¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•å€¼å¾—æ‚¨æ³¨æ„ï¼Œå°½ç®¡å®ƒä»¬å¹¶é View ç±»çš„ä¸€éƒ¨åˆ†ï¼Œä½†å¯èƒ½ä¼šç›´æ¥å½±å“æ‰€èƒ½é‡‡å–çš„äº‹ä»¶å¤„ç†æ–¹å¼ã€‚å› æ­¤ï¼Œåœ¨ç®¡ç†å¸ƒå±€å†…æ›´å¤æ‚çš„äº‹ä»¶æ—¶ï¼Œä¸å¦¨è€ƒè™‘ä½¿ç”¨ä»¥ä¸‹å…¶ä»–æ–¹æ³•ï¼š\nActivity.dispatchTouchEvent(MotionEvent)ï¼šæ­¤æ–¹æ³•å…è®¸ Activity åœ¨æ‰€æœ‰è§¦æ‘¸äº‹ä»¶åˆ†æ´¾ç»™çª—å£ä¹‹å‰æˆªè·å®ƒä»¬ã€‚ ViewGroup.onInterceptTouchEvent(MotionEvent)ï¼šæ­¤æ–¹æ³•å…è®¸ ViewGroup ç›‘è§†åˆ†æ´¾ç»™å­çº§ View çš„äº‹ä»¶ã€‚ ViewParent.requestDisallowInterceptTouchEvent(boolean)ï¼šå¯¹çˆ¶çº§ View è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¯æŒ‡ç¤ºä¸åº”ä½¿ç”¨ onInterceptTouchEvent(MotionEvent) æˆªè·è§¦æ‘¸äº‹ä»¶ã€‚ è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ onTouchEvent(MotionEvent) å³åœ¨å‘ç”Ÿè§¦å±åŠ¨ä½œäº‹ä»¶æ—¶è°ƒç”¨çš„å›è°ƒæ–¹æ³•ï¼›\nè§¦æ‘¸æ‰‹åŠ¿ æ‰‹åŠ¿å¯ä»¥è®©ç”¨æˆ·é€šè¿‡è§¦æ‘¸æ¥ä¸å±å¹•å…ƒç´ è¿›è¡Œäº¤äº’ï¼›\nç”¨æˆ·äº¤æˆ·è§’åº¦çš„æ‰‹åŠ¿åˆ’åˆ†ï¼š\næ‰‹åŠ¿ç±»å‹ å…·ä½“æ‰‹åŠ¿-ä¸åŒç±»å‹ä¹‹é—´æœ‰é‡å¤ è§£é‡Š å¯¼èˆªæ‰‹åŠ¿ å®ç°å¯¼èˆªä½œç”¨ ç‚¹å‡» - Tap å¦‚ï¼šç‚¹å‡»æŒ‰é’®è·³è½¬åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢ æ»šåŠ¨å’Œæ‹–ç§» - Scroll\u0026amp;Pan å¦‚ï¼šæ»‘åŠ¨å›¾ç‰‡åˆ—è¡¨æˆ–æ‹–åŠ¨ä»¥æµè§ˆåœ°å›¾Scroll - å¿«é€Ÿæ‹–åŠ¨å¹¶æŠ¬èµ·æ‰‹æŒ‡æ—¶å‘ç”Ÿçš„ä¸€ç§æ»šåŠ¨ Pan-æ‹–ç§»ï¼Œæ…¢é€Ÿç§»åŠ¨ æ‹–åŠ¨/æ‹–æ‹½ - Drag ç”¨æˆ·åœ¨è§¦æ‘¸å±ä¸Šæ‹–åŠ¨æ‰‹æŒ‡æ—¶å‘ç”Ÿçš„ä¸€ç§æ»šåŠ¨å¦‚ï¼šæŒ‰ä½åº•éƒ¨sheetå¹¶å‘å±å¹•é¡¶éƒ¨æ‹–åŠ¨ è½»æ‰« - Swipe å•ä¸ªæ‰‹æŒ‡è§¦æ‘¸å±å¹•å¹¶å¿«é€Ÿåœ°æœä»»æ„ä¸€ä¸ªæ–¹å‘æ»‘åŠ¨å¦‚ï¼šå·¦å³æ»‘åŠ¨ä»¥åœ¨ä¸åŒçš„Tabé¡µä¸­åˆ‡æ¢ æåˆ/ç¼©æ”¾ - Pinch åŒæŒ‡æˆ–å¤šæŒ‡æåˆå¦‚ï¼šåœ¨ä¸€ä¸ªå›¾ç‰‡åˆ—è¡¨ä¸­ç¼©æ”¾ä¸€ä¸ªitemè¿›å…¥å¤§å›¾æŸ¥çœ‹ç•Œé¢ åŠ¨ä½œæ‰‹åŠ¿ æ‰§è¡ŒæŸç§åŠ¨ä½œ ç‚¹å‡» - Tap é•¿æŒ‰ - Long press å¦‚ï¼šé•¿æŒ‰é€‰ä¸­ è½»æ‰« - Swipe å¦‚ï¼šè½»æ‰«itemå±•ç°åˆ é™¤/æ”¶è—æŒ‰é’® å˜æ¢æ‰‹åŠ¿ ç”¨äºæ”¹å˜å…ƒç´ å¤§å°ï¼Œä½ç½®ï¼Œæ—‹è½¬è§’åº¦ï¼Œå®ç°å˜æ¢æ•ˆæœ åŒå‡» - Double tap å¦‚ï¼šåŒå‡»ç¼©æ”¾å›¾ç‰‡ æåˆ/ç¼©æ”¾ - Pinch å¦‚ï¼šç¼©æ”¾æŸ¥çœ‹å›¾ç‰‡ç»†èŠ‚ ç»„åˆæ‰‹åŠ¿ å¦‚ï¼šåœ°å›¾ä¸­çš„æ”¾å¤§ç¼©å°\u0026amp;æ—‹è½¬ é€‰å–å¹¶æ‹–åŠ¨ - Pick up\u0026amp;Move é•¿æŒ‰é€‰æ‹©å…ƒç´  + æ‹–åŠ¨å…ƒç´  æ¥æºåŠæ‰‹åŠ¿çš„åŠ¨ç”»æ•ˆæœå¯ä»¥çœ‹è¿™é‡Œï¼š material.io\nAndroidä¸­ç”¨äºæ£€æµ‹æˆ–å¤„ç†æ‰‹åŠ¿çš„ç±»/æ–¹æ³•ï¼š\nGestureDetectorï¼šæ”¯æŒæ£€æµ‹æŒ‰ä¸‹ã€æ»‘åŠ¨ã€é•¿æŒ‰ç­‰æ‰‹åŠ¿ï¼›äº‹ä»¶å›è°ƒæ–¹æ³•åŒ…æ‹¬ onDown()ã€onLongPress()ã€onFling()ã€[onScroll()](https://developer.android.google.cn/reference/android/view/GestureDetector.OnGestureListener#onScroll(android.view.MotionEvent, android.view.MotionEvent, float, float)) ç­‰ã€‚å¯ä»¥å°† GestureDetector ä¸ onTouchEvent() æ–¹æ³•ç»“åˆä½¿ç”¨ï¼› ScaleGestureDetectorï¼šç”¨äºæ£€æµ‹ç¼©æ”¾æ‰‹åŠ¿ï¼› onTouchEvent()ï¼š ç›´æ¥å¤„ç†onTouchEvent()æ–¹æ³•ï¼Œç„¶åè‡ªè¡Œæ ¹æ®äº‹ä»¶åºåˆ—æ¥åˆ¤æ–­æ‰‹åŠ¿ï¼› VelocityTrackerï¼šç”¨äºè·Ÿè¸ªè§¦æ‘¸äº‹ä»¶çš„é€Ÿåº¦ï¼Œå¦‚æ»‘åŠ¨äº‹ä»¶ä¸­ä¸€èˆ¬éœ€è¦ç»“åˆé€Ÿåº¦æ¥ä½¿ç”¨ï¼› Scroller \u0026amp; OverScrollerï¼š ç”¨äºæ”¶é›†è§¦æ‘¸äº‹ä»¶æ¥ç”Ÿæˆæ»šåŠ¨åŠ¨ç”»æ‰€éœ€çš„æ•°æ®ï¼ŒOverScrollerå¯ä»¥æŒ‡ç¤ºæ»‘åŠ¨åæ˜¯å¦åˆ°è¾¾äº†å†…å®¹è¾¹ç¼˜ï¼› ä¸¤ç§ä¸åŒçš„æ»šåŠ¨: æ‹–åŠ¨å’Œæ»‘åŠ¨\næ‹–åŠ¨æ˜¯æŒ‡ç”¨æˆ·åœ¨è§¦æ‘¸å±ä¸Šæ‹–åŠ¨æ‰‹æŒ‡æ—¶å‘ç”Ÿçš„ä¸€ç§æ»šåŠ¨ã€‚ç®€å•çš„æ‹–åŠ¨é€šå¸¸æ˜¯é€šè¿‡æ›¿æ¢ GestureDetector.OnGestureListener ä¸­çš„ onScroll() å®ç°çš„ã€‚æœ‰å…³æ‹–åŠ¨çš„è¯¦ç»†è®¨è®ºï¼Œå¯å‚é˜…æ‹–åŠ¨å’Œç¼©æ”¾ã€‚ æ»‘åŠ¨æ˜¯ç”¨æˆ·å¿«é€Ÿæ‹–åŠ¨å¹¶æŠ¬èµ·æ‰‹æŒ‡æ—¶å‘ç”Ÿçš„ä¸€ç§æ»šåŠ¨ã€‚åœ¨ç”¨æˆ·æŠ¬èµ·æ‰‹æŒ‡åï¼Œæ‚¨é€šå¸¸éœ€è¦ç»§ç»­æ»šåŠ¨ï¼ˆç§»åŠ¨è§†å£ï¼‰ï¼Œä½†è¦å‡é€Ÿï¼Œç›´åˆ°è§†å£åœæ­¢ç§»åŠ¨ä¸ºæ­¢ã€‚æ»‘åŠ¨å¯ä»¥é€šè¿‡æ›¿æ¢ GestureDetector.OnGestureListener ä¸­çš„ onFling() ä»¥åŠä½¿ç”¨æ»šåŠ¨æ¡å¯¹è±¡æ¥å®ç°ã€‚ ç³»ç»Ÿä¼šåœ¨ç”¨æˆ·æ‹–åŠ¨æ‰‹æŒ‡ä»¥å¹³ç§»å†…å®¹æ—¶è°ƒç”¨ onScroll()ï¼Œç³»ç»Ÿä»…åœ¨æ‰‹æŒ‡è¿˜åœ¨å±å¹•ä¸Šæ—¶æ‰ä¼šè°ƒç”¨ onScroll()ï¼›å½“æ‰‹æŒ‡ä»å±å¹•ä¸ŠæŠ¬èµ·æ—¶ï¼Œæ‰‹åŠ¿ä¾¿ä¼šç»“æŸï¼Œæˆ–å¼€å§‹æ‰§è¡Œæ»‘åŠ¨æ‰‹åŠ¿ï¼ˆå¦‚æœæ‰‹æŒ‡åœ¨æŠ¬èµ·ä¹‹å‰æ­£åœ¨ä»¥ä¸€å®šçš„é€Ÿåº¦ç§»åŠ¨ï¼‰ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†äº†è§£è§¦æ‘¸æ‰‹åŠ¿ä¸­å„ä¸ªitemçš„ç”¨æ³•ï¼›\nè§¦æ‘¸äº‹ä»¶ç±»é€ä¸ªäº†è§£ æˆ‘ä»¬å…ˆå¯¹æ¶‰åŠçš„å…ƒç´ ç±»è¿›è¡Œå•ç‹¬å­¦ä¹ ï¼Œç”±äºæ™®é€šçš„äº‹ä»¶ç›‘å¬å™¨æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ä¸»è¦å…³æ³¨è§¦æ‘¸æ‰‹åŠ¿éƒ¨åˆ†ï¼Œè¿™å—å…ˆä»GestureDetectorå¼€å§‹ï¼›\nGestureDetector è¯¦è§£ èƒ½å¤Ÿè¯†åˆ«çš„æ‰‹åŠ¿ï¼Œæ˜¯ GestureDetector.OnGestureListeneråŠ ï¼ŒGestureDetector.SimpleOnGestureListener ,å…¶ä¸­ åŒ…æ‹¬å¦‚ä¸‹å‡ ç§ï¼š\nå›è°ƒæ–¹æ³• å¯¹åº”äº‹ä»¶è§¦å‘æ—¶æœºåŠè¯´æ˜ onDown(downEvent):Boolean ç‚¹æŒ‰æŒ‰ä¸‹æ‰‹æŒ‡æ—¶ eventä¸ºdownäº‹ä»¶æ—¶è§¦å‘. onFling(downEvent,upEvent,velocityX,velocityY):Boolean æ»‘åŠ¨(æŠ•æ·)äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘ onLongPress(downEvent) å‘ç”Ÿé•¿æŒ‰äº‹ä»¶æ—¶è§¦å‘ onScroll(downEvent,moveEvent,distanceX,distanceY):Boolean æ‹–åŠ¨äº‹ä»¶å‘ç”Ÿæ—¶ onShowPress(downEvent) æŒ‰åœ¨å±å¹•ä¸Šä½†æ˜¯æ²¡æœ‰ç§»åŠ¨æˆ–æŠ¬èµ·æ‰‹æŒ‡ onSingleTapUp(upEvent):Boolean ç‚¹æŒ‰æŠ¬èµ·æ‰‹æŒ‡æ—¶è§¦å‘ GestureDetector.SimpleOnGestureListener onContextClick(event) ä¸Šä¸‹æ–‡èœå•ç‚¹å‡»äº‹ä»¶å‘ç”Ÿæ—¶ onDoubleTap(event) åŒå‡»äº‹ä»¶ onDoubleTapEvent(event) åŒå‡»äº‹ä»¶è¿‡ç¨‹ä¸­çš„äº‹ä»¶ï¼ŒåŒ…æ‹¬downï¼Œmoveï¼Œupäº‹ä»¶ onSingleTapConfirmed(event) å•æ¬¡ç‚¹å‡»å‘ç”Ÿæ—¶ é—®é¢˜ï¼š ä»¥ä¸‹é€šè¿‡é˜…è¯»APIæ–‡æ¡£å¹¶ç¼–å†™ç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œé€šè¿‡æ“ä½œè§¦å‘å¯¹åº”çš„æ‰‹åŠ¿æ¥è§‚å¯Ÿä»¥ç¡®å®šä»¥ä¸‹é—®é¢˜çš„ç­”æ¡ˆã€‚\nGestureDetector å„ä¸ªäº‹ä»¶å‘ç”Ÿçš„å…³ç³»ï¼Œæœ‰æ— äº¤å‰ï¼Ÿ æŒ‰ä¸‹-é‡Šæ”¾å¯èƒ½çš„äº‹ä»¶åºåˆ—ï¼š onDown - onSingleTapUpï¼š æŒ‰ä¸‹ï¼Œè¿…é€ŸæŠ¬èµ·ï¼ˆå¹²å‡€åˆ©è½çš„ï¼‰ onDown - onShowPress - onSingleTapUpï¼šæŒ‰ä¸‹ï¼Œç¼“æ…¢æŠ¬èµ· onDown - onShowPress - onLongPressï¼šæŒ‰ä¸‹ï¼Œç¨æœ‰å»¶è¿Ÿçš„æŠ¬èµ· onScrollè§¦å‘çš„å¯èƒ½äº‹ä»¶åºåˆ—ï¼š longPress è¢«è§¦å‘ä¹‹åï¼Œæ— æ³•å†è§¦å‘onScroll onDown - onScroll onDown - onShowPress - onScroll onFlingçš„è§¦å‘åºåˆ— è§¦å‘onScroll - å¤šä¸ª onScroll - onFling GestureDetector.SimpleOnGestureDetector å•æ¬¡ç‚¹å‡»äº‹ä»¶åºåˆ—ï¼š onDown - onSingleTapUp - onSingleTapConfirmed onDown - onShowPress - onSingleTapUp - onSingleTapConfirmed ï¼ˆæŒ‰ä¸‹åç¨æœ‰åœé¡¿ï¼‰ åŒå‡»å¯èƒ½çš„äº‹ä»¶åºåˆ—ï¼š onDown - onShowPress - onSingleTapUp - onDoubleTap_down - onDoubleTapEvent_down - onDown - onShowPress - onDoubleTapEvent_up æ»‘åŠ¨onFlingå’Œæ‹–åŠ¨onScrollçš„åŒºåˆ«æ—¶æœºï¼Ÿ onScrollä¸€å®šå…ˆå‘ç”Ÿï¼Œå¦‚æœæŠ¬èµ·æ—¶æœ‰ä¸€å®šé€Ÿåº¦ï¼Œå°±ä¼šè§¦å‘onFling onSingleTapUp(upEvent) åŠ onSingleTapConfirmed(event)çš„åŒºåˆ«ï¼Ÿ onSingleTapConfirmed åªä¼šåœ¨ç¡®è®¤å½“å‰tapä¹‹åä¸ä¼šæœ‰å¦å¤–ä¸€æ¬¡tapæ„æˆdouble-tapæ‰‹åŠ¿çš„æƒ…å†µä¸‹æ‰ä¼šè¢«è§¦å‘ï¼Œä¹Ÿå°±æ˜¯è¯´onSingleTapUpå®é™…ä¸Šæœ‰å¯èƒ½æ—¶doubleTapçš„ä¸€æ¬¡äº‹ä»¶ï¼Œå¦‚æœç¡®å®šåªèƒ½åˆæ˜ç¡®çš„å•æ¬¡ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼Œå°±éœ€è¦åŒºåˆ† onDoubleTab å’Œ onDoubleTapEvent ä¹‹å‰çš„åŒºåˆ«ï¼Ÿ onDoubleTab åªåŒ…å«downäº‹ä»¶ï¼Œè€ŒonDoubleTapEventåˆ™è¿˜åŒ…å«å…¶ä»–äº‹ä»¶ï¼ˆmoveï¼Œupï¼‰ Scroller è¯¦è§£ scroller æœ¬èº«å¹¶ä¸ä¸Viewå…³è”ï¼Œä»…ç”¨äºåšè¾…åŠ©çš„åŠ¨ç”»è®¡ç®—ï¼Œä½¿ç”¨èµ·æ¥æœ‰ä»¥ä¸‹æ­¥éª¤ï¼š\nåˆå§‹åŒ– é€šè¿‡startScrollæˆ–flingæ–¹æ³•è®¾å®šè®¡ç®—æ¨¡å‹åŠè®¡ç®—æ‰€éœ€è¦çš„å‚æ•° å®šæœŸè°ƒç”¨ computeScrollOffset è¿›è¡Œè¿ç®—ï¼Œç„¶åå–å‡ºè¿ç®—åçš„å€¼ ä½¿ç”¨è¿ç®—åçš„å€¼åŠ¨æ€çš„æ”¹å˜Viewçš„å±æ€§å®ç°æ»šåŠ¨æ•ˆæœ è®¡ç®—æ¨¡å‹ï¼š æ¨¡å‹/æ–¹æ³• å‚æ•° å«ä¹‰ startScroll startX èµ·å§‹æ°´å¹³æ»šåŠ¨åç§»é‡ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ï¼Œæ­£æ•°ä¼šå°†å†…å®¹å‘å·¦æ»šåŠ¨ã€‚ startY å¼€å§‹çš„å‚ç›´æ»šåŠ¨åç§»é‡ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ã€‚ æ­£æ•°å°†ä½¿å†…å®¹å‘ä¸Šæ»šåŠ¨ã€‚ dx æ»‘åŠ¨çš„æ°´å¹³è·ç¦»ã€‚ æ­£æ•°ä¼šå°†å†…å®¹å‘å·¦æ»šåŠ¨ã€‚ dy å‚ç›´æ»‘åŠ¨è·ç¦»ã€‚ æ­£æ•°å°†ä½¿å†…å®¹å‘ä¸Šæ»šåŠ¨ã€‚ duration æ»šåŠ¨æŒç»­æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ fling startX æ»šåŠ¨çš„èµ·ç‚¹ï¼ˆXï¼‰ startY æ»šåŠ¨çš„èµ·ç‚¹ï¼ˆYï¼‰ velocityX æ»šåŠ¨çš„åˆå§‹é€Ÿåº¦ï¼ˆXæ–¹å‘ï¼‰ï¼Œä»¥åƒç´ /ç§’ä¸ºå•ä½ã€‚ velocityY æ»šåŠ¨çš„åˆå§‹é€Ÿåº¦ï¼ˆYæ–¹å‘ï¼‰ï¼Œä»¥åƒç´ /ç§’ä¸ºå•ä½ã€‚ minX æœ€å°Xå€¼ã€‚ æ»šåŠ¨æ¡å°†ä¸ä¼šæ»šåŠ¨åˆ°è¯¥ç‚¹ã€‚ maxX æœ€å¤§Xå€¼ã€‚ æ»šåŠ¨æ¡å°†ä¸ä¼šæ»šåŠ¨åˆ°è¯¥ç‚¹ã€‚ minY æœ€å°Yå€¼ã€‚ æ»šåŠ¨æ¡å°†ä¸ä¼šæ»šåŠ¨åˆ°è¯¥ç‚¹ã€‚ maxY æœ€å¤§Yå€¼ã€‚ æ»šåŠ¨æ¡å°†ä¸ä¼šæ»šåŠ¨åˆ°è¯¥ç‚¹ã€‚ è®¡ç®—ç»“æœå€¼ æ–¹æ³•/å€¼ è¯´æ˜ getCurrX æ–°çš„Xåç§»é‡æ˜¯è·åŸç‚¹çš„ç»å¯¹è·ç¦»ã€‚ getCurrY æ–°çš„Yåç§»é‡æ˜¯è·åŸç‚¹çš„ç»å¯¹è·ç¦»ã€‚ ScaleGestureDetector è¯¦è§£ ä½¿ç”¨æä¾›çš„ MotionEvent äº‹ä»¶åºåˆ—æ¥æ£€æµ‹ç¼©æ”¾æ‰‹åŠ¿ï¼Œå½“æ£€æµ‹åˆ°å¯¹åº”çš„ç¼©æ”¾äº‹ä»¶æ—¶ï¼Œä¼šé€šè¿‡ OnScaleGestureListener æ¥é€šçŸ¥ç”¨æˆ·ï¼›\nä½¿ç”¨æµç¨‹ï¼š\nä¸º View åˆ›å»º ScaleGestureDetector å®ä¾‹ï¼› åœ¨ View.onTouchEvent(MotionEvent) æ–¹æ³•ä¸­è°ƒç”¨ ScaleGestureDetector å®ä¾‹çš„ onTouchEvent æ–¹æ³•ï¼› åŸºæœ¬ç”¨æ³• æ„é€ å‡½æ•° ä»“åº“ å«ä¹‰/ä½œç”¨ context ä¸Šä¸‹æ–‡ ScaleGestureListener ç¼©æ”¾ç›‘å¬ Handlerï¼ˆå¯é€‰ï¼‰ ç”¨äºè¿è¡Œå»¶è¿Ÿä¾¦å¬äº‹ä»¶çš„å¤„ç†ç¨‹åº æ–¹æ³•åŠå±æ€§ å±æ€§/æ–¹æ³• å«ä¹‰è¯´æ˜ å¤‡æ³¨ getCurrentSpan ä¸¤ä¸ªæ‰‹æŒ‡ä¹‹é—´çš„é€šè¿‡æ‰‹åŠ¿ç„¦ç‚¹çš„å¹³å‡è·ç¦» ï¼ˆä½•ä¸ºå¹³å‡è·ç¦»ï¼Ÿï¼‰ getCurrentSpanX å½¢æˆæ‰‹åŠ¿çš„è¿‡ç¨‹ä¸­ä¸¤ä¸ªæ‰‹æŒ‡ä¹‹é—´é€šè¿‡æ‰‹åŠ¿ç„¦ç‚¹çš„Xæ–¹å‘çš„å¹³å‡è·ç¦» ä¸¤ä¸ªæ‰‹æŒ‡çš„æ»‘åŠ¨Xè·ç¦»ç›¸åŠ å–å¹³å‡ getCurrentSpanY å½¢æˆæ‰‹åŠ¿çš„è¿‡ç¨‹ä¸­ä¸¤ä¸ªæ‰‹æŒ‡ä¹‹é—´é€šè¿‡æ‰‹åŠ¿ç„¦ç‚¹çš„Yæ–¹å‘çš„å¹³å‡è·ç¦» ä¸¤ä¸ªæ‰‹æŒ‡çš„æ»‘åŠ¨Yè·ç¦»ç›¸åŠ å–å¹³å‡ getEventTime è¿”å›æ­£åœ¨å¤„ç†çš„å½“å‰äº‹ä»¶çš„äº‹ä»¶æ—¶é—´ getFocusX å½“å‰æ‰‹åŠ¿ç„¦ç‚¹ï¼ˆgesture\u0026rsquo;s focal pointï¼‰çš„Xåæ ‡ æ‰‹åŠ¿ç„¦ç‚¹=ä¸¤ä¸ªæ‰‹åŠ¿ç‚¹çš„ä¸­ç‚¹ï¼›åŒå‡»è§¦å‘æ—¶åˆ™æ˜¯è§¦æ‘¸ç‚¹ getFocusY å½“å‰æ‰‹åŠ¿ç„¦ç‚¹ï¼ˆgesture\u0026rsquo;s focal pointï¼‰çš„Yåæ ‡ ä¸¤ä¸ªæ‰‹åŠ¿ç‚¹çš„ä¸­ç‚¹ getPreviousSpan ä¹‹å‰çš„ ä¸¤ä¸ªæ‰‹æŒ‡ä¹‹é—´çš„é€šè¿‡æ‰‹åŠ¿ç„¦ç‚¹çš„å¹³å‡è·ç¦» ä¸Šæ¬¡å›è°ƒï¼ˆscaleBegin/scaleï¼‰çš„spanå‚æ•° getPreviousSpanX ä¹‹å‰çš„ å½¢æˆæ‰‹åŠ¿çš„è¿‡ç¨‹ä¸­ä¸¤ä¸ªæ‰‹æŒ‡ä¹‹é—´é€šè¿‡æ‰‹åŠ¿ç„¦ç‚¹çš„Xæ–¹å‘çš„å¹³å‡è·ç¦» getPreviousSpanY ä¹‹å‰çš„ å½¢æˆæ‰‹åŠ¿çš„è¿‡ç¨‹ä¸­ä¸¤ä¸ªæ‰‹æŒ‡ä¹‹é—´é€šè¿‡æ‰‹åŠ¿ç„¦ç‚¹çš„Yæ–¹å‘çš„å¹³å‡è·ç¦» getScaleFactor ä»ä¹‹å‰çš„ç¼©æ”¾äº‹ä»¶åˆ°å½“å‰ç¼©æ”¾äº‹ä»¶çš„ ç¼©æ”¾æ¯”ä¾‹ ä¸¤æ¬¡å›è°ƒä¹‹é—´çš„ç¼©æ”¾æ¯”ä¾‹ getTimeDelta ä¸Šä¸€ä¸ªè¢«æ¥å—çš„ç¼©æ”¾äº‹ä»¶åˆ°å½“å‰ç¼©æ”¾äº‹ä»¶ä¹‹å‰çš„æ—¶é—´å·® ä¸¤æ¬¡å›è°ƒä¹‹é—´çš„ isInProgress ç¼©æ”¾æ‰‹åŠ¿æ˜¯å¦æ­£åœ¨è¿›è¡Œä¸­ ScaleBegin ä¸­ä¸ºfalseï¼Œå¦å¤–ä¸¤ä¸ªä¸ºtrue isQuickScaleEnabled æ˜¯å¦å¯ç”¨äº†å¿«é€Ÿç¼©æ”¾-ç”¨æˆ·é€šè¿‡åŒå‡»+ä¸€ä¸ªSwipeæ“ä½œæ¥è§¦å‘ç¼©æ”¾ isStylusScaleEnabled è¿”å›ç”¨æˆ·ä½¿ç”¨è§¦ç¬”å¹¶æŒ‰ä¸‹æŒ‰é’®çš„è§¦ç¬”ç¼©æ”¾æ‰‹åŠ¿æ˜¯å¦åº”è¯¥æ‰§è¡Œç¼©æ”¾ã€‚ setQuickScaleEnabled å½“ç”¨æˆ·æ‰§è¡ŒåŒå‡»+SwipeåŠ¨ä½œæ—¶æ˜¯å¦è§¦å‘ç¼©æ”¾ç›‘å¬ setStylusScaleEnabled å½“ç”¨æˆ·æ‰§è¡Œè§¦ç¬”ç¼©æ”¾åŠ¨ä½œæ—¶æ˜¯å¦è§¦å‘ç¼©æ”¾ç›‘å¬ onTouchEvent æ¥å—MotionEventså¹¶åœ¨é€‚å½“çš„æ—¶æœºåˆ†å‘äº‹ä»¶åˆ° OnScaleGestureListener å¦‚ä½•ä½¿ç”¨ï¼Ÿ\næ„é€ ä¾¦å¬å™¨å¯¹è±¡ï¼› åœ¨ onTouchEvent å›è°ƒä¸­è°ƒç”¨ä¾¦å¬å™¨å¯¹è±¡çš„ onTouchEventæ–¹æ³•å¹¶ä¼ å…¥MotionEventï¼› var mScaleGestureDetector = ScaleGestureDetector(this,this) override fun onTouchEvent(event: MotionEvent?): Boolean { return mScaleGestureDetector.onTouchEvent(event) || super.onTouchEvent(event) } æ·±å…¥æ¢ç©¶ å¦‚ä½•è§¦å‘æ‰‹åŠ¿ï¼Ÿ ä¸¤ä¸ªæ‰‹æŒ‡å¼ å¼€é—­åˆå°±å¯ä»¥ å¦‚ä½•æ¶ˆè´¹æ‰‹åŠ¿ï¼Ÿ å¦‚ä½•åˆ©ç”¨æ‰‹åŠ¿çš„å‚æ•°å®ç°ç¼©æ”¾çš„åŠ¨ç”»/åŠ¨ä½œï¼Ÿ å¦‚ä½•æ¶ˆè´¹æ‰‹åŠ¿ï¼Ÿ äº‹ä»¶ç±»å‹ CurrentSpan currentSpanX currentSpanY EventTime FocusX FocusY Previouspan PreviouspanX PreviouspanY ScaleFactor TimeDelta isInProgress isQuickScaleEnabled isStylusScaleEnabled onScaleBegin 448.18158 338.30157 293.9707 120680064 405.82724 765.9927 448.18158 338.30157 293.9707 1.0 0 FALSE TRUE TRUE onScale 448.18158 338.30157 293.9707 120680064 405.82724 765.9927 448.18158 338.30157 293.9707 1.0 0 TRUE TRUE true onScale 473.83823 355.72217 313.0246 120680081 408.95367 770.60486 448.18158 338.30157 293.9707 1.0572461 17 TRUE TRUE true onScale 492.1729 367.65485 327.20648 120680098 410.2758 772.77576 473.83823 355.72217 313.0246 1.038694 17 TRUE TRUE true onScale 509.8993 380.36285 339.59003 120680114 411.72714 775.3407 492.1729 367.65485 327.20648 1.0360166 16 TRUE TRUE true onScale 526.8072 391.90063 352.05072 120680131 413.6501 777.7251 509.8993 380.36285 339.59003 1.0331593 17 TRUE TRUE true onScale 541.9916 402.3568 363.13068 120680147 415.72614 780.33923 526.8072 391.90063 352.05072 1.0288234 16 TRUE TRUE true onScale 552.3365 408.6225 371.62244 120680164 418.1556 782.6556 541.9916 402.3568 363.13068 1.0190868 17 TRUE TRUE true onScale 560.9881 413.25342 379.38013 120680181 418.5 783.56335 552.3365 408.6225 371.62244 1.0156636 17 TRUE TRUE true onScale 567.2112 417.16174 384.32355 120680197 419.58087 785.08093 560.9881 413.25342 379.38013 1.011093 16 TRUE TRUE true onScale 575.6995 423.24652 390.24646 120680214 420.5411 786.0411 567.2112 417.16174 384.32355 1.014965 17 TRUE TRUE true onScale 584.7019 428.15033 398.2005 120680230 422.02505 788.0502 575.6995 423.24652 390.24646 1.0156373 16 TRUE TRUE true onScale 592.25555 432.04736 405.09473 120680247 423.02368 789.5237 584.7019 428.15033 398.2005 1.0129188 17 TRUE TRUE true onScale 601.86597 436.95844 413.89606 120680263 424.47922 791.9689 592.25555 432.04736 405.09473 1.0162268 16 TRUE TRUE true onScale 611.9895 442.71814 422.5302 120680280 425.453 793.453 601.86597 436.95844 413.89606 1.0168202 17 TRUE TRUE true onScale 621.78754 447.69666 431.49445 120680297 426.94946 794.94946 611.9895 442.71814 422.5302 1.0160102 17 TRUE TRUE true onScale 629.77124 451.88318 438.64954 120680313 427.9416 795.4416 621.78754 447.69666 431.49445 1.0128399 16 TRUE TRUE true onScale 636.78015 454.8739 445.6217 120680330 428.43695 795.93695 629.77124 451.88318 438.64954 1.0111293 17 TRUE TRUE true onScaleEnd 644.16754 458.65613 452.31226 120680346 428.5 795.5 636.78015 454.8739 445.6217 1.0 16 TRUE TRUE true ä»¥ä¸‹æ˜¯æµ‹è¯•è¿‡ç¨‹ä¸­çš„detectorçš„å±æ€§å˜åŒ–æ•°æ®ï¼Œå¯ä»¥å‘ç°å¦‚ä¸‹è§„å¾‹ï¼š\nonScaleBegin æ—¶ inProgressä¸ºfalse\ncurrentSpan^2 = currentSpanX^2 * currentSpanY^2 ï¼Œå³currentSpanä¸ºä¸¤ä¸ªæ‰‹æŒ‡æ€»å…±ç§»åŠ¨çš„è·ç¦»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\næ‰‹æŒ‡1ç§»åŠ¨çš„è½¨è¿¹ä¸ºè“è‰²çŸ©å½¢ä¸­çš„å¯¹è§’çº¿ï¼Œæ‰‹æŒ‡2ç§»åŠ¨çš„è½¨è¿¹ä¸ºçº¢è‰²çŸ©å½¢çš„å¯¹è§’çº¿ currentSpan å°±æ˜¯ä¸¤ä¸ªæ‰‹æŒ‡ç§»åŠ¨çš„å¯¹è§’çº¿ç›¸åŠ ï¼ŒcurrentSpanXå’ŒcurrentSpanYåˆ†åˆ«ä¸ºè“è‰²çŸ©å½¢å’Œçº¢è‰²çŸ©å½¢æŒ‰å¦‚ä¸‹æ–¹å¼æ‹¼æ¥æˆä¸€ä¸ªå¤§çš„çŸ©å½¢ä¹‹åçš„ä¸¤æ¡è¾¹ï¼› æ¯æ¬¡äº‹ä»¶çš„previouSpançš„å€¼éƒ½ç­‰äºä¸Šæ¬¡äº‹ä»¶çš„currentSpançš„å€¼ï¼› FocusXå’ŒFocusYå³ä¸ºäº‹ä»¶å›è°ƒè§¦å‘æ—¶ä¸¤ä¸ªæ‰‹æŒ‡è¿çº¿çš„ä¸­ç‚¹åæ ‡ï¼Œéšç€æ‰‹æŒ‡çš„ä¸æ–­ç§»åŠ¨ï¼Œç„¦ç‚¹ä¹Ÿæ˜¯ä¸æ–­çš„å˜åŒ–çš„ï¼› å¤§éƒ¨åˆ†timeDeltaéƒ½åœ¨16-17mså·¦å³ï¼Œæ‰€ä»¥ä¸åº”åœ¨å›è°ƒæ–¹æ³•ä¸­æ‰§è¡Œè€—æ—¶äº‹ä»¶ï¼Œå¯¹åº”é€»è¾‘åº”æ”¾ç½®åˆ°Runnableä¸­å»æ‰§è¡Œï¼› scaleBeginå’Œç¬¬ä¸€æ¬¡onScaleå›è°ƒçš„å„é¡¹å€¼éƒ½ä¸€è‡´ï¼Œé™¤äº†scaleBeginçš„isInProgressä¸ºFALSEï¼› ç¼©æ”¾æ¯”ä¾‹ï¼ˆscaleFactorï¼‰ä¸º1.0æ—¶ï¼Œæ²¡æœ‰ç¼©æ”¾ï¼› å¦‚ä½•åˆ©ç”¨æ‰‹åŠ¿çš„å‚æ•°å®ç°ç¼©æ”¾çš„åŠ¨ç”»/åŠ¨ä½œï¼Ÿ å‡è®¾æˆ‘ç°åœ¨éœ€è¦åœ¨æ£€æµ‹åˆ°ç¼©æ”¾æ‰‹åŠ¿æ—¶åŒæ­¥çš„å¯¹ImageViewæ‰§è¡Œç¼©æ”¾åŠ¨ä½œï¼Œæ­¤æ—¶åº”è¯¥æ€ä¹ˆåšï¼Ÿ\nå¦‚ä½•å¯¹ImageViewçš„å›¾ç‰‡è¿›è¡Œç¼©æ”¾ï¼Ÿ æ ¹æ®ç¼©æ”¾æ¯”ä¾‹ä¸æ–­çš„é‡æ–°è®¾ç½®Viewçš„scaleXåŠscaleYçš„å€¼ï¼› æ¯æ¬¡äº‹ä»¶è§¦å‘éƒ½è¿›è¡Œç¼©æ”¾æ“ä½œï¼Ÿè¿˜æ˜¯ç§¯ç´¯ä¸€å®šç¨‹åº¦ä¹‹åè¿›è¡Œï¼Ÿ ç”±äºæ¯æ¬¡å˜åŒ–çš„æ—¶é—´éå¸¸çŸ­ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åœ¨æ¯æ¬¡onScaleæ–¹æ³•è§¦å‘æ—¶æ‰§è¡Œå˜æ¢ï¼› å¦‚ä½•è®©Viewæ ¹æ®æ‰‹åŠ¿æ•ˆæœè¿›è¡Œå˜æ¢ï¼Ÿ é€šè¿‡ä¹‹å‰å¯¹æ‰‹åŠ¿ä¾¦å¬å™¨ï¼Œç¼©æ”¾æ‰‹åŠ¿ä¾¦å¬å™¨åŠæ»šåŠ¨æ¡ç±»çš„å­¦ä¹ åŠåˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†å„ä¸ªç±»çš„åŸºæœ¬ç”¨é€”ï¼š\nGeostureDetectorï¼š è¾…åŠ©ä¾¦å¬åˆ¤æ–­downï¼Œtagï¼Œdoubletapï¼Œscrollï¼Œflingç­‰æ‰‹åŠ¿å¹¶åœ¨æ£€æµ‹åˆ°æ‰‹åŠ¿åå›è°ƒå¯¹åº”çš„æ–¹æ³•ï¼Œç»™å‡ºäº‹ä»¶ç›¸å…³çš„å‚æ•°æ•°æ®ï¼› ScaleGeostureDetectorï¼š è¾…åŠ©ä¾¦å¬åˆ¤æ–­ç¼©æ”¾æ‰‹åŠ¿ï¼Œå¹¶åœ¨ç¼©æ”¾æ‰‹åŠ¿å‘ç”Ÿæ—¶é€šè¿‡å›è°ƒå¯¹åº”æ–¹æ³•æ¥é€šçŸ¥æˆ‘ä»¬å¯¹åº”äº‹ä»¶çš„å‘ç”Ÿï¼Œå¹¶ç»™å‡ºäº‹ä»¶ç›¸å…³çš„å‚æ•°æ•°æ®ï¼› Scrollerï¼š ç”¨äºè¾…åŠ©è®¡ç®—ç”Ÿæˆæ»šåŠ¨è¿‡ç¨‹ä¸­çš„ä¸€ç³»åˆ—å€¼çš„åºåˆ—ï¼› å¯ä»¥æ–¹å‘ï¼Œä¸Šè¿°ç±»åªæ˜¯å‘Šè¯‰ä½ äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¿˜æœ‰å‘Šè¯‰ä½ äº‹ä»¶çš„ç›¸å…³å‚æ•°ï¼Œå¦‚æ»šåŠ¨äº‹ä»¶çš„æ»šåŠ¨è·ç¦»ï¼Œflingäº‹ä»¶çš„æ»‘åŠ¨é€Ÿåº¦ï¼Œç­‰ç­‰ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰æ¶‰åŠåˆ°å¦‚ä½•å˜æ¢å°†è¿™äº›äº‹ä»¶åæ˜ åˆ°ç•Œé¢çš„å˜åŒ–ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å°†ä¸Šè¿°çš„äº‹ä»¶å˜åŒ–åæ˜ åˆ°ç•Œé¢ä¸Šå‘¢ï¼Ÿ\nViewåŸºç¡€å±æ€§ éƒ¨åˆ†å˜åŒ–æ•ˆæœéƒ½æ˜¯é’ˆå¯¹View/ViewGroupæ¥è¯´çš„ï¼Œè¦æƒ³æ”¹å˜Viewï¼Œå°±å¾—æ”¹å˜å…¶å±æ€§ï¼Œå¦‚ï¼š\næ»‘åŠ¨æ—¶æ”¹å˜TransitionXï¼ŒTransitionY ç¼©æ”¾æ—¶æ”¹å˜Viewçš„scaleX/scaleY æˆ‘ä»¬éœ€è¦ç ”ç©¶Viewä¸­æœ‰å“ªäº›å±æ€§ï¼Œå±æ€§å¦‚ä½•å½±å“Viewçš„å±•ç¤ºæ•ˆæœï¼Œä»¥ä¸‹é€šè¿‡APIæ–‡æ¡£çš„setXXXå±æ€§åˆ—å‡ºViewçš„éƒ¨åˆ†å±æ€§ï¼š\nå±æ€§ è¯´æ˜ alpha é€æ˜åº¦ background/backgroundColor èƒŒæ™¯ bottomleftrighttopelevation è§†å›¾ç›¸å¯¹äºparentçš„ä½ç½®elevationä¸ºviewçš„æ·±åº¦ clipBounds çŸ©å½¢è£å‰ªåŒºåŸŸï¼Œviewçš„å†…å®¹ä¼šåœ¨è¯¥åŒºåŸŸç»˜åˆ¶ clipToOutline:Boolean fadingEdgeLength ç”¨äºæŒ‡ç¤ºæ­¤è§†å›¾ä¸­æ›´å¤šå†…å®¹å¯ç”¨çš„è¤ªè‰²è¾¹ç¼˜çš„å¤§å° foreground å‰æ™¯drawable layoutParams å¸ƒå±€å‚æ•° minHeightminWidth æœ€å°å®½é«˜ padding å†…è¾¹è· relativePadding å‡å»å¯èƒ½çš„æ»šåŠ¨æ¡å°ºå¯¸ pivotXpivotY view æ—‹è½¬ç¼©æ”¾æ‰€å›´ç»•çš„ç‚¹ã€‚é»˜è®¤ä¸ºviewä¸­ç‚¹åæ ‡ rotation ç»•pivotç‚¹çš„æ—‹è½¬è§’åº¦ rotationXrotationY ç»•é€šè¿‡pivotç‚¹çš„æ°´å¹³çº¿/å‚ç›´çº¿çš„æ—‹è½¬è§’åº¦ scaleXscaleY X/Yæ–¹å‘ä¸Šç»•pivotç‚¹çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œ1.0è¡¨ç¤ºæ— ç¼©æ”¾ scrollXscrollY æ°´å¹³/å‚ç›´æ»šåŠ¨ä½ç½®çš„position translationXtranslationYtranslationZ ç›¸å¯¹äºè§†å›¾å·¦è¾¹ä½ç½®çš„æ°´å¹³/å‚ç›´/æ·±åº¦ä½ç½®ï¼Œå¯ä»¥æ”¹å˜å¸ƒå±€ x/y/z x: xä½ç½®ï¼› ç­‰æ•ˆtranslationX=x-lefty: yä½ç½®ï¼› ç­‰æ•ˆtranslationY=y-topz: zä½ç½®ï¼› ç­‰æ•ˆtranslationZ=z-elevation ä¸è§†å›¾å˜åŒ–ç›¸å…³çš„æœ€åŸºæœ¬çš„å°±æ˜¯åŠ ç²—éƒ¨åˆ†çš„å±æ€§ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ä½ç½®ï¼Œå¤§å°ï¼Œé€æ˜åº¦ï¼Œæ—‹è½¬ï¼Œç¼©æ”¾ï¼Œå¹³ç§»ã€‚å…¶ä»–å…·ä½“çš„å­Viewåˆ™å¯èƒ½å¼•å…¥è‡ªå·±çš„å±æ€§ï¼›\né‚£ä¹ˆæ—‹è½¬/å¹³ç§»/ç¼©æ”¾ç©¶ç«Ÿæ”¹å˜çš„æ˜¯å•¥ï¼Ÿ æ»šåŠ¨åŠå¹³ç§»ï¼ˆscroll/flingï¼‰ï¼šæ”¹å˜xå’Œyï¼ˆäº¦å¯ä»¥é€šè¿‡translationX/Yï¼Œæœ€ç»ˆéƒ½æ˜¯æ”¹å˜äº†xå’Œyï¼‰ ç¼©æ”¾ï¼š æ”¹å˜scaleX/scaleY/pivotX/pivotY Matrixè§£æ ç”¨é€”ï¼š matrixå­˜å‚¨ä¸€ä¸ª3x3çš„çŸ©é˜µï¼Œç”¨äºå¯¹åæ ‡è¿›è¡Œå˜æ¢ï¼› $$ \\begin{bmatrix} MSCALE_X \u0026amp; MSKEW_X \u0026amp; MTRANS_X \\ MSKEW_Y \u0026amp; MSCALE_Y \u0026amp; MTRANS_Y \\ MPERSP_0 \u0026amp; MPERSP_1 \u0026amp; MPERSP_2 \\ \\end{bmatrix} $$ çŸ©é˜µå„ä¸ªå…ƒç´ çš„ç”¨é€”ï¼š\nå­—æ®µ ç”¨é€” MSCALE_Xï¼ŒMSCALE_Y æ§åˆ¶Xè½´å’ŒYè½´æ–¹å‘çš„ç¼©æ”¾ MSKEW_Xï¼ŒMSKEW_Y æ§åˆ¶Xåæ ‡å’ŒYåæ ‡çš„æ‰­æ›²ç³»æ•°(æ—‹è½¬) MTRANS_Xï¼ŒMTRANS_Y æ§åˆ¶Xæ–¹å‘å’ŒYæ–¹å‘çš„çº¿æ€§å¹³ç§» MPERSP_0 , MPERSP_1 , MPERSP_2 MPERSP_0ã€MPERSP_1å’ŒMPERSP_2æ˜¯å…³äºé€è§†çš„æ§åˆ¶ Matrixæä¾›ä¸€ç³»åˆ—çš„è¾…åŠ©å˜æ¢å‡½æ•°ï¼Œæ¯ç§ç±»å‹æœ‰ pre,post,setä¸‰ç§æ“ä½œæ–¹å¼ï¼ŒçŸ©é˜µçš„ä¹˜æ³•è¿ç®—é¡ºåºä¸ä¸€è‡´ç»“æœä¸åŒï¼Œpreè¡¨ç¤ºå‰ï¼ˆpreconcatsï¼‰ï¼Œpostè¡¨ç¤ºåï¼ˆpostconcatsï¼‰ï¼Œsetä¸ºç›´æ¥è®¾ç½®ï¼›\npostScaleæ–¹æ³•æ¥å¯¹åæ ‡åæ¥è§¦ç¼©æ”¾å˜æ¢ï¼Œæœ‰ä¸¤ç§å˜ä½“ï¼š\næ–¹æ³• è¯´æ˜ postScale (float sx, float sy, float px, float py) ä½¿ç”¨æŒ‡å®šçš„scaleæ‰§è¡ŒçŸ©é˜µpostconcatsï¼šM' = S(sx, sy, px, py) * M å…¶ä¸­sxï¼Œsyåˆ†åˆ«ä¸ºxè½´å’Œyè½´çš„ç¼©æ”¾å¤§å°ï¼Œpxï¼Œpyä¸ºç¼©æ”¾ä¸­å¿ƒç‚¹çš„åæ ‡ boolean postScale (float sx, float sy) ä½¿ç”¨æŒ‡å®šçš„scaleæ‰§è¡ŒçŸ©é˜µpostconcatsï¼š M' = S(sx, sy) * M postå’ŒsetåŠpreçš„åŒºåˆ« scale currentScale preScale å’ŒpostScaleå¯¹å€¼äº§ç”Ÿä¸€æ ·çš„æ•ˆæœï¼Œä½†æ˜¯å¦‚æœæœ‰å…¶ä»–å˜æ¢ä¸€èµ·ä½¿ç”¨ï¼Œä»–ä¼šå…ˆäºsetè¢«åº”ç”¨ setScale ç›´æ¥è¦†ç›–ï¼Œå¦‚æœmatrixä¸­åŸå…ˆæœ‰scaleçš„å€¼ï¼Œé‚£ä¹ˆåŸå…ˆçš„å€¼ä¼šè¢«è¦†ç›– postScale åªéœ€è¦è®¾ç½®å¢é‡å³å¯ï¼Œå¦‚åŸå…ˆçš„scaleä¸º0.5425669ï¼ŒpostScale(1.3947428)åscaleçš„å€¼ä¸º $$0.5425669*1.3947428 = 0.7567413$$ Matrixå¦‚ä½•ä¸ImageViewç»“åˆ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ‰èƒ½å°†MatrixåŒImageViewæˆ–è€…Canvasæˆ–è€…Bitmapç»“åˆèµ·æ¥å‘¢ï¼Ÿ\næŸ¥æ‰¾Canvasçš„ç›¸å…³æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°setMatrixæ–¹æ³•ï¼Œ\npublic void setMatrix (Matrix matrix) Completely replace the current matrix with the specified matrix. If the matrix parameter is null, then the current matrix is reset to identity. Note: it is recommended to use concat(android.graphics.Matrix), scale(float, float), translate(float, float) and rotate(float) instead of this method.\nåŒæ—¶ä¸‹é¢æ¸©é¦¨æç¤ºï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼Œå…¶ä¸­æ¶‰åŠåˆ°çŸ©é˜µçš„å°±æœ‰contactï¼Œæ‰€ä»¥æˆ‘ä»¬ç ”ç©¶ä¸‹contactæ–¹æ³•ï¼š\ncontactæ–¹æ³•æ¥å—ä¸€ä¸ªMatrixå¯¹è±¡ï¼Œå¯ä»¥å°†å‚æ•°ä¸­çš„çŸ©é˜µé¢„è¿æ¥åˆ°canvasæœ¬èº«çš„çŸ©é˜µä¸Šï¼ˆPreconcat the current matrix with the specified matrix.ï¼‰ï¼›å‡è®¾å½“å‰çŸ©é˜µä¸ºCï¼Œè¦è¿æ¥çš„çŸ©é˜µä¸ºSï¼Œè¿™é‡Œçš„é¢„è¿æ¥ï¼ˆpreconcatï¼‰æŒ‡çš„æ˜¯ï¼šC = S x C\nå•ä¸€æ•ˆæœå®ç° æ‹–åŠ¨æ•ˆæœå®ç° åˆå§‹åŒ–GestureDetector\nprivate lateinit var mDetector: GestureDetector override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) mDetector = GestureDetector(this, simpleDetectorListener) } ä½¿ç”¨ GestureDetector ä¾¦å¬ onScroll æ‰‹åŠ¿\noverride fun dispatchTouchEvent(ev: MotionEvent?): Boolean { return mDetector.onTouchEvent(ev) } GestureDetector çš„ onScroll å›è°ƒæ–¹æ³•ä¸­å¤„ç†æ»šåŠ¨äº‹ä»¶\noverride fun onScroll(e1: MotionEvent?, e2: MotionEvent?, distanceX: Float, distanceY: Float): Boolean { // æ”¹å˜ImageView çš„xå’Œy imageView.x -= distanceX imageView.y -= distanceY return true } Fling-æŠ•æ·æ•ˆæœå®ç° åˆå§‹åŒ–GestureDetectoråŠ Scroller\nprivate lateinit var mDetector: GestureDetector private lateinit var mScroller: Scroller override fun onCreate(savedInstanceState: Bundle?) { super.onCreate(savedInstanceState) mDetector = GestureDetector(this, simpleDetectorListener) mScroller = Scroller(this) } åœ¨onTouchEventæˆ–dispatchTouchEventä¸­ä½¿ç”¨GestureDetector ä¾¦å¬ onFling æ‰‹åŠ¿\noverride fun dispatchTouchEvent(ev: MotionEvent?): Boolean { return mDetector.onTouchEvent(ev) } onFlingå›è°ƒä¸­ä½¿ç”¨Scroller å®Œæˆæ»šåŠ¨è¾…åŠ©è®¡ç®—å¹¶ä»Scrollerä¸­è·å–å‚æ•°æ¥æ›´æ–°è§†å›¾çš„x,yç›¸å…³å±æ€§\noverride fun onFling(e1: MotionEvent?, e2: MotionEvent?, velocityX: Float, velocityY: Float): Boolean { return handleFling(e1, e2, velocityX, velocityY) } private fun handleFling(down: MotionEvent?, move: MotionEvent?, velocityX: Float, velocityY: Float): Boolean { // åœæ­¢ mScroller.forceFinished(true) val minX: Int = (imageView.pivotX * (1 - imageView.scaleX)).roundToInt() val minY: Int = (imageView.pivotY * (1 - imageView.scaleY)).roundToInt() val maxX: Int = ((imageView.width - imageView.pivotX) * (imageView.scaleX - 1)).roundToInt() val maxY: Int = ((imageView.height - imageView.pivotY) * (imageView.scaleY - 1)).roundToInt() mScroller.fling(imageView.x.toInt(), imageView.y.toInt(), velocityX.toInt(), velocityY.toInt(), minX, maxX, minY, maxY) // Invalidate to request a redraw isFling = true postFling() return true } private fun postFling() { imageView.postDelayed(flingRunnable, 16L) } private val flingRunnable = Runnable { if (!mScroller.isFinished ) { // è®¡ç®—æ»šåŠ¨åçš„å‚æ•° mScroller.computeScrollOffset() // ä»æ»šåŠ¨å™¨ä¸­è·å–è®¡ç®—å‡ºçš„å€¼å¹¶æ›´æ–°å›¾ç‰‡çš„x,yå±æ€§ imageView.x = mScroller.currX.toFloat() imageView.y = mScroller.currY.toFloat() // å®šæœŸåˆ·æ–° postFling() } } Viewç¼©æ”¾åflingè¾¹ç•Œè®¡ç®—\nè¯´æ˜ï¼š\nç¼©æ”¾å‰å®½ï¼šwidth\nç¼©æ”¾å‰é«˜ï¼šheight\nç¼©æ”¾æ¯”ä¾‹ï¼šscale\nç¼©æ”¾ç„¦ç‚¹åæ ‡ï¼šfocusXï¼ŒfocusY\nminX = - focusX * ï¼ˆscale-1ï¼‰\nminY = - focusY * ï¼ˆscale-1ï¼‰\nmaxX = ï¼ˆwidth-focusXï¼‰*ï¼ˆscale-1ï¼‰\nmaxY = ï¼ˆheight-focusYï¼‰*ï¼ˆscale-1ï¼‰\nScaleGestureDetector å®ç°åŒæŒ‡ç¼©æ”¾æ•ˆæœ åˆå§‹åŒ– ScaleGestureDetector ï¼›\nprivate lateinit var mScaleDetector: ScaleGestureDetector private val scaleDetectorListener: ScaleGestureDetector.OnScaleGestureListener = object : ScaleGestureDetector.OnScaleGestureListener { override fun onScaleBegin(detector: ScaleGestureDetector?): Boolean { isScaling = true scaleStartX = detector!!.focusX scaleStartY = detector.focusY return true } override fun onScale(detector: ScaleGestureDetector?): Boolean { Timber.tag(\u0026#34;GestureDetector\u0026#34;).d(\u0026#34;handleScale onScale\u0026#34;) detector?.run { handleScale(detector) } return true } override fun onScaleEnd(detector: ScaleGestureDetector?) { Timber.tag(\u0026#34;GestureDetector\u0026#34;).d(\u0026#34;handleScale onScaleEnd\u0026#34;) isScaling = false } } äº‹ä»¶åˆ†å‘æ—¶è°ƒç”¨ ScaleGestureDetector çš„ onTouchEvent æ–¹æ³•ä¼ é€’äº‹ä»¶åºåˆ—ï¼›\nåœ¨scaleäº‹ä»¶å›è°ƒæ–¹æ³•ä¸­å¤„ç†scaleäº‹ä»¶-æ ¹æ®äº‹ä»¶å‚æ•°æ›´æ–°Viewçš„ç¼©æ”¾ï¼ˆscaleXï¼ŒscaleYï¼‰å±æ€§å®Œæˆè§†å›¾æ›´æ–°ï¼›\nå‚è€ƒæ–‡ç«  matrixå‚è€ƒ Android matrix.postScaleçš„ç”¨æ³• Android Matrix Matrixå­¦ä¹ 1ã€åŸºç¡€çš„çŸ¥è¯† MathJaxåŸºæœ¬çš„ä½¿ç”¨æ–¹å¼ Typora Math Block What does it mean to â€œpreconcatâ€ a matrix in Android? Android Matrixçš„preã€postç†è§£ androidæ‰‹åŠ¿ æ‰‹åŠ¿ç±»å‹- Material.io ","permalink":"https://hanlyjiang.github.io/posts/android-shi-jian-ji-shou-shi/","summary":"\u003cp\u003eandroidäº‹ä»¶åŸºç¡€åŠæ‰‹åŠ¿ï¼Œä¸»è¦å…³æ³¨å„ç§æ‰‹åŠ¿çš„ä½¿ç”¨åŠå…¶è®¡ç®—åŸç† ã€‚\u003c/p\u003e\n\u003c!-- more --\u003e\n\u003ch2 id=\"androidäº‹ä»¶åŸºç¡€\"\u003eAndroidäº‹ä»¶åŸºç¡€\u003c/h2\u003e\n\u003cp\u003eè¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨æ¦‚å¿µ\u003c/p\u003e\n\u003ch3 id=\"äº‹ä»¶ç›‘å¬å™¨åŠäº‹ä»¶å¤„ç†ç¨‹åº\"\u003eäº‹ä»¶ç›‘å¬å™¨åŠäº‹ä»¶å¤„ç†ç¨‹åº\u003c/h3\u003e\n\u003cp\u003eå¯ç›´æ¥æŸ¥çœ‹ \u003ca href=\"https://developer.android.google.cn/guide/topics/ui/ui-events\"\u003eå®˜æ–¹æ–‡æ¡£\u003c/a\u003eï¼Œæ­¤å¤„ä»…åšç®€è¦æè¿°ï¼›\u003c/p\u003e\n\u003ch4 id=\"äº‹ä»¶ç›‘å¬å™¨\"\u003eäº‹ä»¶ç›‘å¬å™¨\u003c/h4\u003e\n\u003cp\u003eViewç±»çš„åŒ…å«ä¸€ä¸ªå›è°ƒæ–¹æ³•çš„æ¥å£ï¼Œé€šè¿‡setXXXListeneræ¥å®šä¹‰äº‹ä»¶å¤„ç†ç¨‹åºï¼›\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eäº‹ä»¶ç›‘å¬å™¨æ˜¯ \u003ccode\u003eView\u003c/code\u003e ç±»ä¸­åŒ…å«ä¸€ä¸ªå›è°ƒæ–¹æ³•çš„æ¥å£ã€‚å½“ç”¨æˆ·ä¸ç•Œé¢é¡¹ç›®ä¹‹é—´çš„äº’åŠ¨è§¦å‘å·²æ³¨å†Œç›‘å¬å™¨çš„ View å¯¹è±¡æ—¶ï¼ŒAndroid æ¡†æ¶å°†è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚\u003c/p\u003e","title":"Androidäº‹ä»¶åŠæ‰‹åŠ¿"}]